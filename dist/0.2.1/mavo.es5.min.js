!function() {
"use strict";function t(e, n, i) {
return n=void 0===n?1:n, i=i||n+1, i-n<=1?function() {
if (arguments.length<=n||"string"===r.type(arguments[n])) {
return e.apply(this, arguments);
} var t, i=arguments[n];for (var o in i) {
var s=Array.prototype.slice.call(arguments);s.splice(n, 1, o, i[o]), t=e.apply(this, s);
} return t;
}:t(t(e, n+1, i), n, i-1);
} function e(t, r, i) {
var o=n(i);if ("string"===o) {
var s=Object.getOwnPropertyDescriptor(r, i);!s||s.writable&&s.configurable&&s.enumerable&&!s.get&&!s.set?t[i]=r[i]:(delete t[i], Object.defineProperty(t, i, s));
}
else if ("array"===o) {
i.forEach(function(n) {
n in r&&e(t, r, n);
});
}
else {
for (var a in r) {
i&&("regexp"===o&&!i.test(a)||"function"===o&&!i.call(r, a))||e(t, r, a);
}
} return t;
} function n(t) {
if (null===t) {
return "null";
} if (void 0===t) {
return "undefined";
} var e=(Object.prototype.toString.call(t).match(/^\[object\s+(.*?)\]$/)[1]||"").toLowerCase();return "number"==e&&isNaN(t)?"nan":e;
} var r=self.Bliss=e(function(t, e) {
return 2==arguments.length&&!e||!t?null:"string"===r.type(t)?(e||document).querySelector(t):t||null;
}, self.Bliss);e(r, {extend:e, overload:t, type:n, property:r.property||"_", listeners:self.WeakMap?new WeakMap:new Map, original:{addEventListener:(self.EventTarget||Node).prototype.addEventListener, removeEventListener:(self.EventTarget||Node).prototype.removeEventListener}, sources:{}, noop:function() {}, $:function(t, e) {
return t instanceof Node||t instanceof Window?[t]:2!=arguments.length||e?Array.prototype.slice.call("string"==typeof t?(e||document).querySelectorAll(t):t||[]):[];
}, defined:function() {
for (var t=0;t<arguments.length;t++) {
if (void 0!==arguments[t]) {
return arguments[t];
}
}
}, create:function(t, e) {
return t instanceof Node?r.set(t, e):(1===arguments.length&&("string"===r.type(t)?e={}:(e=t, t=e.tag, e=r.extend({}, e, function(t) {
return "tag"!==t;
}))), r.set(document.createElement(t||"div"), e));
}, each:function(t, e, n) {
n=n||{};for (var r in t) {
n[r]=e.call(t, r, t[r]);
} return n;
}, ready:function(t, e, n) {
if ("function"!=typeof t||e||(e=t, t=void 0), t=t||document, e&&("loading"!==t.readyState?e():r.once(t, "DOMContentLoaded", function() {
e();
})), !n) {
return new Promise(function(e) {
r.ready(t, e, !0);
});
}
}, Class:function(t) {
var e, n=["constructor", "extends", "abstract", "static"].concat(Object.keys(r.classProps)), i=t.hasOwnProperty("constructor")?t.constructor:r.noop;2==arguments.length?(e=arguments[0], t=arguments[1]):(e=function() {
if (this.constructor.__abstract&&this.constructor===e) {
throw new Error("Abstract classes cannot be directly instantiated.");
}e["super"]&&e["super"].apply(this, arguments), i.apply(this, arguments);
}, e["super"]=t["extends"]||null, e.prototype=r.extend(Object.create(e["super"]?e["super"].prototype:Object), {constructor:e}), e.prototype["super"]=e["super"]?e["super"].prototype:null, e.__abstract=!!t["abstract"]);var o=function(t) {
return this.hasOwnProperty(t)&&n.indexOf(t)===-1;
};if (t["static"]) {
r.extend(e, t["static"], o);for (var s in r.classProps) {
s in t["static"]&&r.classProps[s](e, t["static"][s]);
}
}r.extend(e.prototype, t, o);for (var s in r.classProps) {
s in t&&r.classProps[s](e.prototype, t[s]);
} return e;
}, classProps:{lazy:t(function(t, e, n) {
return Object.defineProperty(t, e, {get:function() {
var t=n.call(this);return Object.defineProperty(this, e, {value:t, configurable:!0, enumerable:!0, writable:!0}), t;
}, set:function(t) {
Object.defineProperty(this, e, {value:t, configurable:!0, enumerable:!0, writable:!0});
}, configurable:!0, enumerable:!0}), t;
}), live:t(function(t, e, n) {
return "function"===r.type(n)&&(n={set:n}), Object.defineProperty(t, e, {get:function() {
var t=this["_"+e], r=n.get&&n.get.call(this, t);return void 0!==r?r:t;
}, set:function(t) {
var r=this["_"+e], i=n.set&&n.set.call(this, t, r);this["_"+e]=void 0!==i?i:t;
}, configurable:n.configurable, enumerable:n.enumerable}), t;
})}, include:function() {
var t=arguments[arguments.length-1], e=2===arguments.length&&arguments[0], n=document.createElement("script");return e?Promise.resolve():new Promise(function(e, i) {
r.set(n, {async:!0, onload:function() {
e(n), n.parentNode&&n.parentNode.removeChild(n);
}, onerror:function() {
i(n);
}, src:t, inside:document.head});
});
}, load:function o(t, e) {
e=e?new URL(e, location.href):location.href, t=new URL(t, e);var n=o.loading=o.loading||{};return n[t+""]?n[t+""]:/\.css$/.test(t.pathname)?n[t+""]=new Promise(function(e, n) {
var i=r.create("link", {href:t, rel:"stylesheet", inside:document.head, onload:function() {
e(i);
}, onerror:function() {
n(i);
}});
}):n[t+""]=r.include(t);
}, fetch:function(t, n) {
if (!t) {
throw new TypeError("URL parameter is mandatory and cannot be "+t);
} var i=e({url:new URL(t, location), data:"", method:"GET", headers:{}, xhr:new XMLHttpRequest}, n);i.method=i.method.toUpperCase(), r.hooks.run("fetch-args", i), "GET"===i.method&&i.data&&(i.url.search+=i.data), document.body.setAttribute("data-loading", i.url), i.xhr.open(i.method, i.url.href, i.async!==!1, i.user, i.password);for (var o in n) {
if ("upload"===o) {
i.xhr.upload&&"object"==typeof n[o]&&r.extend(i.xhr.upload, n[o]);
}
else if (o in i.xhr) {
try {
i.xhr[o]=n[o];
}
catch (s) {
self.console&&console.error(s);
}
}
} var a=Object.keys(i.headers).map(function(t) {
return t.toLowerCase();
});"GET"!==i.method&&a.indexOf("content-type")===-1&&i.xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");for (var c in i.headers) {
void 0!==i.headers[c]&&i.xhr.setRequestHeader(c, i.headers[c]);
} var u=new Promise(function(t, e) {
i.xhr.onload=function() {
document.body.removeAttribute("data-loading"), 0===i.xhr.status||i.xhr.status>=200&&i.xhr.status<300||304===i.xhr.status?t(i.xhr):e(r.extend(Error(i.xhr.statusText), {xhr:i.xhr, get status() {
return this.xhr.status;
}}));
}, i.xhr.onerror=function() {
document.body.removeAttribute("data-loading"), e(r.extend(Error("Network Error"), {xhr:i.xhr}));
}, i.xhr.ontimeout=function() {
document.body.removeAttribute("data-loading"), e(r.extend(Error("Network Timeout"), {xhr:i.xhr}));
}, i.xhr.send("GET"===i.method?null:i.data);
});return u.xhr=i.xhr, u;
}, value:function(t) {
var e="string"!=typeof t;return r.$(arguments).slice(+e).reduce(function(t, e) {
return t&&t[e];
}, e?t:self);
}}), r.Hooks=new r.Class({add:function(t, e, n) {
if ("string"==typeof arguments[0]) {
(Array.isArray(t)?t:[t]).forEach(function(t) {
this[t]=this[t]||[], e&&this[t][n?"unshift":"push"](e);
}, this);
}
else {
for (var t in arguments[0]) {
this.add(t, arguments[0][t], arguments[1]);
}
}
}, run:function(t, e) {
this[t]=this[t]||[], this[t].forEach(function(t) {
t.call(e&&e.context?e.context:e, e);
});
}}), r.hooks=new r.Hooks;r.property;r.Element=function(t) {
this.subject=t, this.data={}, this.bliss={};
}, r.Element.prototype={set:t(function(t, e) {
t in r.setProps?r.setProps[t].call(this, e):t in this?this[t]=e:this.setAttribute(t, e);
}, 0), transition:function(t, e) {
return new Promise(function(n, i) {
if ("transition"in this.style&&0!==e) {
var o=r.extend({}, this.style, /^transition(Duration|Property)$/);r.style(this, {transitionDuration:(e||400)+"ms", transitionProperty:Object.keys(t).join(", ")}), r.once(this, "transitionend", function() {
clearTimeout(s), r.style(this, o), n(this);
});var s=setTimeout(n, e+50, this);r.style(this, t);
}
else {
r.style(this, t), n(this);
}
}.bind(this));
}, fire:function(t, e) {
var n=document.createEvent("HTMLEvents");return n.initEvent(t, !0, !0), this.dispatchEvent(r.extend(n, e));
}, bind:t(function(t, e) {
if (arguments.length>1&&("function"===r.type(e)||e.handleEvent)) {
var n=e;e="object"===r.type(arguments[2])?arguments[2]:{capture:!!arguments[2]}, e.callback=n;
} var i=r.listeners.get(this)||{};t.trim().split(/\s+/).forEach(function(t) {
if (t.indexOf(".")>-1) {
t=t.split(".");var n=t[1];t=t[0];
}i[t]=i[t]||[], 0===i[t].filter(function(t) {
return t.callback===e.callback&&t.capture==e.capture;
}).length&&i[t].push(r.extend({className:n}, e)), r.original.addEventListener.call(this, t, e.callback, e);
}, this), r.listeners.set(this, i);
}, 0), unbind:t(function(t, e) {
if (e&&("function"===r.type(e)||e.handleEvent)) {
var n=e;e=arguments[2];
}"boolean"==r.type(e)&&(e={capture:e}), e=e||{}, e.callback=e.callback||n;var i=r.listeners.get(this);(t||"").trim().split(/\s+/).forEach(function(t) {
if (t.indexOf(".")>-1) {
t=t.split(".");var n=t[1];t=t[0];
} if (i) {
for (var o in i) {
if (!t||o===t) {
for (var s, a=0;s=i[o][a];a++) {
n&&n!==s.className||e.callback&&e.callback!==s.callback||!!e.capture!=!!s.capture&&(t||e.callback||void 0!==e.capture)||(i[o].splice(a, 1), r.original.removeEventListener.call(this, o, s.callback, s.capture), a--);
}
}
}
}
else if (t&&e.callback) {
return r.original.removeEventListener.call(this, t, e.callback, e.capture);
}
}, this);
}, 0), when:function(t, e) {
var n=this;return new Promise(function(r) {
n.addEventListener(t, function i(n) {
e&&!e.call(this, n)||(this.removeEventListener(t, i), r(n));
});
});
}, toggleAttribute:function(t, e, n) {
arguments.length<3&&(n=null!==e), n?this.setAttribute(t, e):this.removeAttribute(t);
}}, r.setProps={style:function(t) {
for (var e in t) {
e in this.style?this.style[e]=t[e]:this.style.setProperty(e, t[e]);
}
}, attributes:function(t) {
for (var e in t) {
this.setAttribute(e, t[e]);
}
}, properties:function(t) {
r.extend(this, t);
}, events:function(t) {
if (1!=arguments.length||!t||!t.addEventListener) {
return r.bind.apply(this, [this].concat(r.$(arguments)));
} var e=this;if (r.listeners) {
var n=r.listeners.get(t);for (var i in n) {
n[i].forEach(function(t) {
r.bind(e, i, t.callback, t.capture);
});
}
} for (var o in t) {
0===o.indexOf("on")&&(this[o]=t[o]);
}
}, once:t(function(t, e) {
var n=this, i=function() {
return r.unbind(n, t, i), e.apply(n, arguments);
};r.bind(this, t, i, {once:!0});
}, 0), delegate:t(function(t, e, n) {
r.bind(this, t, function(t) {
t.target.closest(e)&&n.call(this, t);
});
}, 0, 2), contents:function(t) {
(t||0===t)&&(Array.isArray(t)?t:[t]).forEach(function(t) {
var e=r.type(t);/^(string|number)$/.test(e)?t=document.createTextNode(t+""):"object"===e&&(t=r.create(t)), t instanceof Node&&this.appendChild(t);
}, this);
}, inside:function(t) {
t&&t.appendChild(this);
}, before:function(t) {
t&&t.parentNode.insertBefore(this, t);
}, after:function(t) {
t&&t.parentNode.insertBefore(this, t.nextSibling);
}, start:function(t) {
t&&t.insertBefore(this, t.firstChild);
}, around:function(t) {
t&&t.parentNode&&r.before(this, t), this.appendChild(t);
}}, r.Array=function(t) {
this.subject=t;
}, r.Array.prototype={all:function(t) {
var e=r.$(arguments).slice(1);return this[t].apply(this, e);
}}, r.add=t(function(t, e, n, i) {
n=r.extend({$:!0, element:!0, array:!0}, n), "function"==r.type(e)&&(!n.element||t in r.Element.prototype&&i||(r.Element.prototype[t]=function() {
return this.subject&&r.defined(e.apply(this.subject, arguments), this.subject);
}), !n.array||t in r.Array.prototype&&i||(r.Array.prototype[t]=function() {
var t=arguments;return this.subject.map(function(n) {
return n&&r.defined(e.apply(n, t), n);
});
}), n.$&&(r.sources[t]=r[t]=e, (n.array||n.element)&&(r[t]=function() {
var e=[].slice.apply(arguments), i=e.shift(), o=n.array&&Array.isArray(i)?"Array":"Element";return r[o].prototype[t].apply({subject:i}, e);
})));
}, 0), r.add(r.Array.prototype, {element:!1}), r.add(r.Element.prototype), r.add(r.setProps), r.add(r.classProps, {element:!1, array:!1});var i=document.createElement("_");r.add(r.extend({}, HTMLElement.prototype, function(t) {
return "function"===r.type(i[t]);
}), null, !0);
}();
/* jsep v0.3.2 (http://jsep.from.so/) */
!function(e) {
"use strict";var r=function(e, r) {
var t=new Error(e+" at character "+r);throw t.index=r, t.description=e, t;
}, t={"-":!0, "!":!0, "~":!0, "+":!0}, n={"||":1, "&&":2, "|":3, "^":4, "&":5, "==":6, "!=":6, "===":6, "!==":6, "<":7, ">":7, "<=":7, ">=":7, "<<":8, ">>":8, ">>>":8, "+":9, "-":9, "*":10, "/":10, "%":10}, o=function(e) {
var r, t=0;for (var n in e) {
(r=n.length)>t&&e.hasOwnProperty(n)&&(t=r);
} return t;
}, i=o(t), a=o(n), u={true:!0, false:!1, null:null}, s=function(e) {
return n[e]||0;
}, p=function(e, r, t) {
return {type:"||"===e||"&&"===e?"LogicalExpression":"BinaryExpression", operator:e, left:r, right:t};
}, f=function(e) {
return e>=48&&e<=57;
}, c=function(e) {
return 36===e||95===e||e>=65&&e<=90||e>=97&&e<=122||e>=128&&!n[String.fromCharCode(e)];
}, l=function(e) {
return 36===e||95===e||e>=65&&e<=90||e>=97&&e<=122||e>=48&&e<=57||e>=128&&!n[String.fromCharCode(e)];
}, d=function(e) {
for (var o, d, h=0, v=e.charAt, x=e.charCodeAt, y=function(r) {
return v.call(e, r);
}, m=function(r) {
return x.call(e, r);
}, b=e.length, E=function() {
for (var e=m(h);32===e||9===e||10===e||13===e;) {
e=m(++h);
}
}, g=function() {
var e, t, n=w();return E(), 63!==m(h)?n:(h++, (e=g())||r("Expected expression", h), E(), 58===m(h)?(h++, (t=g())||r("Expected expression", h), {type:"ConditionalExpression", test:n, consequent:e, alternate:t}):void r("Expected :", h));
}, C=function() {
E();for (var r=e.substr(h, a), t=r.length;t>0;) {
if (n.hasOwnProperty(r)) {
return h+=t, r;
}r=r.substr(0, --t);
} return !1;
}, w=function() {
var e, t, n, o, i, a, u, f;if (a=O(), !(t=C())) {
return a;
} for (i={value:t, prec:s(t)}, (u=O())||r("Expected expression after "+t, h), o=[a, i, u];(t=C())&&0!==(n=s(t));) {
for (i={value:t, prec:n};o.length>2&&n<=o[o.length-2].prec;) {
u=o.pop(), t=o.pop().value, a=o.pop(), e=p(t, a, u), o.push(e);
}(e=O())||r("Expected expression after "+t, h), o.push(i, e);
} for (e=o[f=o.length-1];f>1;) {
e=p(o[f-1].value, o[f-2], e), f-=2;
} return e;
}, O=function() {
var r, n, o;if (E(), r=m(h), f(r)||46===r) {
return U();
} if (39===r||34===r) {
return k();
} if (91===r) {
return S();
} for (o=(n=e.substr(h, i)).length;o>0;) {
if (t.hasOwnProperty(n)) {
return h+=o, {type:"UnaryExpression", operator:n, argument:O(), prefix:!0};
}n=n.substr(0, --o);
} return !(!c(r)&&40!==r)&&A();
}, U=function() {
for (var e, t, n="";f(m(h));) {
n+=y(h++);
} if (46===m(h)) {
for (n+=y(h++);f(m(h));) {
n+=y(h++);
}
} if ("e"===(e=y(h))||"E"===e) {
for (n+=y(h++), "+"!==(e=y(h))&&"-"!==e||(n+=y(h++));f(m(h));) {
n+=y(h++);
}f(m(h-1))||r("Expected exponent ("+n+y(h)+")", h);
} return t=m(h), c(t)?r("Variable names cannot start with a number ("+n+y(h)+")", h):46===t&&r("Unexpected period", h), {type:"Literal", value:parseFloat(n), raw:n};
}, k=function() {
for (var e, t="", n=y(h++), o=!1;h<b;) {
if ((e=y(h++))===n) {
o=!0;break;
} if ("\\"===e) {
switch (e=y(h++)) {
case "n":t+="\n";break;case "r":t+="\r";break;case "t":t+="\t";break;case "b":t+="\b";break;case "f":t+="\f";break;case "v":t+="\v";break;default:t+=e;
}
}
 else {
t+=e;
}
} return o||r('Unclosed quote after "'+t+'"', h), {type:"Literal", value:t, raw:n+t+n};
}, L=function() {
var t, n=m(h), o=h;for (c(n)?h++:r("Unexpected "+y(h), h);h<b&&(n=m(h), l(n));) {
h++;
} return t=e.slice(o, h), u.hasOwnProperty(t)?{type:"Literal", value:u[t], raw:t}:"this"===t?{type:"ThisExpression"}:{type:"Identifier", name:t};
}, j=function(e) {
for (var t, n, o=[], i=!1;h<b;) {
if (E(), (t=m(h))===e) {
i=!0, h++;break;
}44===t?h++:((n=g())&&"Compound"!==n.type||r("Expected comma", h), o.push(n));
} return i||r("Expected "+String.fromCharCode(e), h), o;
}, A=function() {
var e, t;for (t=40===(e=m(h))?P():L(), E(), e=m(h);46===e||91===e||40===e;) {
h++, 46===e?(E(), t={type:"MemberExpression", computed:!1, object:t, property:L()}):91===e?(t={type:"MemberExpression", computed:!0, object:t, property:g()}, E(), 93!==(e=m(h))&&r("Unclosed [", h), h++):40===e&&(t={type:"CallExpression", arguments:j(41), callee:t}), E(), e=m(h);
} return t;
}, P=function() {
h++;var e=g();if (E(), 41===m(h)) {
return h++, e;
}r("Unclosed (", h);
}, S=function() {
return h++, {type:"ArrayExpression", elements:j(93)};
}, B=[];h<b;) {
59===(o=m(h))||44===o?h++:(d=g())?B.push(d):h<b&&r('Unexpected "'+y(h)+'"', h);
} return 1===B.length?B[0]:{type:"Compound", body:B};
};if (d.version="0.3.2", d.toString=function() {
return "JavaScript Expression Parser (JSEP) v"+d.version;
}, d.addUnaryOp=function(e) {
return i=Math.max(e.length, i), t[e]=!0, this;
}, d.addBinaryOp=function(e, r) {
return a=Math.max(e.length, a), n[e]=r, this;
}, d.addLiteral=function(e, r) {
return u[e]=r, this;
}, d.removeUnaryOp=function(e) {
return delete t[e], e.length===i&&(i=o(t)), this;
}, d.removeAllUnaryOps=function() {
return t={}, i=0, this;
}, d.removeBinaryOp=function(e) {
return delete n[e], e.length===a&&(a=o(n)), this;
}, d.removeAllBinaryOps=function() {
return n={}, a=0, this;
}, d.removeLiteral=function(e) {
return delete u[e], this;
}, d.removeAllLiterals=function() {
return u={}, this;
}, "undefined"==typeof exports) {
var h=e.jsep;e.jsep=d, d.noConflict=function() {
return e.jsep===d&&(e.jsep=h), d;
};
}
else {
"undefined"!=typeof module&&module.exports?exports=module.exports=d:exports.parse=d;
}
}(this);
// # sourceMappingURL=jsep.min.js.map
!function() {
if (self.Element&&(Element.prototype.matches||(Element.prototype.matches=Element.prototype.webkitMatchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||null), Element.prototype.matches)) {
var p=self.Stretchy={selectors:{base:'textarea, select:not([size]), input:not([type]), input[type="'+"text number url email tel".split(" ").join('"], input[type="')+'"]', filter:"*"}, script:document.currentScript||t("script").pop(), resize:function(e) {
if (p.resizes(e)) {
var t, i=getComputedStyle(e), n=0;!e.value&&e.placeholder&&(t=!0, e.value=e.placeholder);var o=e.nodeName.toLowerCase();if ("textarea"==o) {
e.style.height="0", "border-box"==i.boxSizing?n=e.offsetHeight:"content-box"==i.boxSizing&&(n=-e.clientHeight+parseFloat(i.minHeight)), e.style.height=e.scrollHeight+n+"px";
}
else if ("input"==o) {
if (e.style.width="1000px", e.offsetWidth) {
e.style.width="0",
"border-box"==i.boxSizing?n=e.offsetWidth:"padding-box"==i.boxSizing?n=e.clientWidth:"content-box"==i.boxSizing&&(n=parseFloat(i.minWidth));var r=Math.max(n, e.scrollWidth-e.clientWidth);e.style.width=r+"px";for (var l=0;l<10&&(e.scrollLeft=1e10, 0!=e.scrollLeft);l++) {
r+=e.scrollLeft, e.style.width=r+"px";
}
}
else {
e.style.width=e.value.length+1+"ch";
}
}
else if ("select"==o) {
var s, c=0<e.selectedIndex?e.selectedIndex:0, a=document.createElement("_");for (var d in a.textContent=e.options[c].textContent, e.parentNode.insertBefore(a, e.nextSibling), i) {
var h=i[d];/^(width|webkitLogicalWidth|length)$/.test(d)||"string"!=typeof h||(a.style[d]=h, /appearance$/i.test(d)&&(s=d));
}a.style.width="", 0<a.offsetWidth&&(e.style.width=a.offsetWidth+"px", i[s]&&"none"===i[s]||(e.style.width="calc("+e.style.width+" + 2em)")), a.parentNode.removeChild(a), a=null;
}t&&(e.value="");
}
}, resizeAll:function(e) {
t(e||p.selectors.base).forEach(function(e) {
p.resize(e);
});
}, active:!0, resizes:function(e) {
return e&&e.parentNode&&e.matches&&e.matches(p.selectors.base)&&e.matches(p.selectors.filter);
}, init:function() {
p.selectors.filter=p.script.getAttribute("data-filter")||(t("[data-stretchy-filter]").pop()||document.body).getAttribute("data-stretchy-filter")||p.selectors.filter, p.resizeAll(), self.MutationObserver&&!p.observer&&(p.observer=new MutationObserver(function(e) {
p.active&&e.forEach(function(e) {
"childList"==e.type&&p.resizeAll(e.addedNodes);
});
}), p.observer.observe(document.documentElement, {childList:!0, subtree:!0}));
}, $$:t};"loading"!==document.readyState?requestAnimationFrame(p.init):document.addEventListener("DOMContentLoaded", p.init), window.addEventListener("load", function() {
p.resizeAll();
});var e=function(e) {
p.active&&p.resize(e.target);
};document.documentElement.addEventListener("input", e), document.documentElement.addEventListener("change", e);
} function t(e, t) {
return e instanceof Node||e instanceof Window?[e]:[].slice.call("string"==typeof e?(t||document).querySelectorAll(e):e||[]);
}
}();
// # sourceMappingURL=stretchy.min.js.map

"use strict";function _slicedToArray(arr, i) {
return _arrayWithHoles(arr)||_iterableToArrayLimit(arr, i)||_unsupportedIterableToArray(arr, i)||_nonIterableRest();
} function _nonIterableRest() {
throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.");
} function _iterableToArrayLimit(arr, i) {
if ("undefined"!=typeof Symbol&&Symbol.iterator in Object(arr)) {
var _arr=[], _n=!0, _d=!1, _e=void 0;try {
for (var _i=arr[Symbol.iterator](), _s;!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value), !(i&&_arr.length===i));_n=!0) {
;
}
}
catch (err) {
_d=!0, _e=err;
}
finally {
try {
_n||null==_i["return"]||_i["return"]();
}
finally {
if (_d) {
throw _e;
}
}
} return _arr;
}
} function _arrayWithHoles(arr) {
if (Array.isArray(arr)) {
return arr;
}
} function _createForOfIteratorHelper(o) {
if ("undefined"==typeof Symbol||null==o[Symbol.iterator]) {
if (Array.isArray(o)||(o=_unsupportedIterableToArray(o))) {
var i=0, F=function() {};return {s:F, n:function() {
return i>=o.length?{done:!0}:{done:!1, value:o[i++]};
}, e:function(_e2) {
throw _e2;
}, f:F};
} throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.");
} var normalCompletion=!0, didErr=!1, it, err;return {s:function() {
it=o[Symbol.iterator]();
}, n:function() {
var step=it.next();return normalCompletion=step.done, step;
}, e:function(_e3) {
didErr=!0, err=_e3;
}, f:function() {
try {
normalCompletion||null==it["return"]||it["return"]();
}
finally {
if (didErr) {
throw err;
}
}
}};
} function ownKeys(object, enumerableOnly) {
var keys=Object.keys(object);if (Object.getOwnPropertySymbols) {
var symbols=Object.getOwnPropertySymbols(object);enumerableOnly&&(symbols=symbols.filter(function(sym) {
return Object.getOwnPropertyDescriptor(object, sym).enumerable;
})), keys.push.apply(keys, symbols);
} return keys;
} function _objectSpread(target) {
for (var i=1, source;i<arguments.length;i++) {
source=null==arguments[i]?{}:arguments[i], i%2?ownKeys(Object(source), !0).forEach(function(key) {
_defineProperty(target, key, source[key]);
}):Object.getOwnPropertyDescriptors?Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)):ownKeys(Object(source)).forEach(function(key) {
Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));
});
} return target;
} function _construct() {
return _construct=_isNativeReflectConstruct()?Reflect.construct:function(Parent, args, Class) {
var a=[null];a.push.apply(a, args);var Constructor=Function.bind.apply(Parent, a), instance=new Constructor;return Class&&_setPrototypeOf(instance, Class.prototype), instance;
}, _construct.apply(null, arguments);
} function _get(target, property, receiver) {
return _get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(target, property, receiver) {
var base=_superPropBase(target, property);if (base) {
var desc=Object.getOwnPropertyDescriptor(base, property);return desc.get?desc.get.call(receiver):desc.value;
}
}, _get(target, property, receiver||target);
} function _superPropBase(object, property) {
for (;!Object.prototype.hasOwnProperty.call(object, property)&&(object=_getPrototypeOf(object), null!==object);) {
;
} return object;
} function _inherits(subClass, superClass) {
if ("function"!=typeof superClass&&null!==superClass) {
throw new TypeError("Super expression must either be null or a function");
}subClass.prototype=Object.create(superClass&&superClass.prototype, {constructor:{value:subClass, writable:!0, configurable:!0}}), superClass&&_setPrototypeOf(subClass, superClass);
} function _setPrototypeOf(o, p) {
return _setPrototypeOf=Object.setPrototypeOf||function(o, p) {
return o.__proto__=p, o;
}, _setPrototypeOf(o, p);
} function _createSuper(Derived) {
return function() {
var Super=_getPrototypeOf(Derived), result;if (_isNativeReflectConstruct()) {
var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super, arguments, NewTarget);
}
else {
result=Super.apply(this, arguments);
} return _possibleConstructorReturn(this, result);
};
} function _possibleConstructorReturn(self, call) {
return call&&("object"===_typeof(call)||"function"==typeof call)?call:_assertThisInitialized(self);
} function _assertThisInitialized(self) {
if (void 0===self) {
throw new ReferenceError("this hasn't been initialised - super() hasn't been called");
} return self;
} function _isNativeReflectConstruct() {
if ("undefined"==typeof Reflect||!Reflect.construct) {
return !1;
} if (Reflect.construct.sham) {
return !1;
} if ("function"==typeof Proxy) {
return !0;
} try {
return Date.prototype.toString.call(Reflect.construct(Date, [], function() {})), !0;
}
catch (e) {
return !1;
}
} function _getPrototypeOf(o) {
return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(o) {
return o.__proto__||Object.getPrototypeOf(o);
}, _getPrototypeOf(o);
} function _classCallCheck(instance, Constructor) {
if (!(instance instanceof Constructor)) {
throw new TypeError("Cannot call a class as a function");
}
} function _defineProperties(target, props) {
for (var i=0, descriptor;i<props.length;i++) {
descriptor=props[i], descriptor.enumerable=descriptor.enumerable||!1, descriptor.configurable=!0, "value"in descriptor&&(descriptor.writable=!0), Object.defineProperty(target, descriptor.key, descriptor);
}
} function _createClass(Constructor, protoProps, staticProps) {
return protoProps&&_defineProperties(Constructor.prototype, protoProps), staticProps&&_defineProperties(Constructor, staticProps), Constructor;
} function _toConsumableArray(arr) {
return _arrayWithoutHoles(arr)||_iterableToArray(arr)||_unsupportedIterableToArray(arr)||_nonIterableSpread();
} function _nonIterableSpread() {
throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.");
} function _unsupportedIterableToArray(o, minLen) {
if (o) {
if ("string"==typeof o) {
return _arrayLikeToArray(o, minLen);
} var n=Object.prototype.toString.call(o).slice(8, -1);return "Object"===n&&o.constructor&&(n=o.constructor.name), "Map"===n||"Set"===n?Array.from(n):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(o, minLen):void 0;
}
} function _iterableToArray(iter) {
if ("undefined"!=typeof Symbol&&Symbol.iterator in Object(iter)) {
return Array.from(iter);
}
} function _arrayWithoutHoles(arr) {
if (Array.isArray(arr)) {
return _arrayLikeToArray(arr);
}
} function _arrayLikeToArray(arr, len) {
(null==len||len>arr.length)&&(len=arr.length);for (var i=0, arr2=Array(len);i<len;i++) {
arr2[i]=arr[i];
} return arr2;
} function _defineProperty(obj, key, value) {
return key in obj?Object.defineProperty(obj, key, {value:value, enumerable:!0, configurable:!0, writable:!0}):obj[key]=value, obj;
} function _typeof(obj) {
"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj) {
return typeof obj;
}:function(obj) {
return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;
}, _typeof(obj);
}(function($, $$) {
var _=self.Mavo=$.Class({constructor:function(element) {
var _this=this;if (this.treeBuilt=Mavo.promise(), this.dataLoaded=Mavo.promise(), this.deleted=[], this.element=element, this.inProgress=!1, this.index=Object.keys(_.all).length+1, Object.defineProperty(_.all, this.index-1, {value:this, configurable:!0}), Mavo.attributeStartsWith("data-mv-", this.element).forEach(function(attribute) {
var element=attribute.ownerElement, name=attribute.name.replace("data-", "");element.attributes[name]||element.setAttribute(name, attribute.value);
}), this.id=Mavo.getAttribute(this.element, "mv-app", "id")||"mavo".concat(this.index), this.id in _.all) {
for (var i=2;(this.id+i in _.all);i++) {
;
} this.id+=i;
}_.all[this.id]=this, this.element.setAttribute("mv-app", this.id);var lang=Mavo.getClosestAttribute(this.element, "lang")||Mavo.locale;this.locale=Mavo.Locale.get(lang), this.autoEdit=this.element.classList.contains("mv-autoedit"), this.autoSave=this.element.hasAttribute("mv-autosave"), this.autoSaveDelay=1e3*(this.element.getAttribute("mv-autosave")||0), Mavo.setAttributeShy(this.element, "typeof", ""), Mavo.hooks.run("init-start", this), $$(_.selectors.multiple, this.element).forEach(function(element) {
_.setAttributeShy(element, "property", "");
}), $$(_.selectors.primitive, this.element).forEach(function(element) {
if ($(_.selectors.property, element)) {
var config=Mavo.Primitive.getConfig(element);(config.attribute||config.hasChildren)&&!Mavo.is("multiple", element)||Mavo.setAttributeShy(element, "typeof", "");
}
}), this.expressions=new Mavo.Expressions(this), Mavo.hooks.run("init-tree-before", this), this.root=new Mavo.Group(this.element, this), this.treeBuilt.resolve(), Mavo.hooks.run("init-tree-after", this), this.permissions=new Mavo.Permissions;var backendTypes=["source", "storage", "init", "uploads"];backendTypes.forEach(function(role) {
return _this.updateBackend(role);
}), this.backendObserver=new Mavo.Observer(this.element, backendTypes.map(function(role) {
return "mv-"+role;
}), function(records) {
var changed={}, roles=records.map(function(record) {
var role=record.attributeName.replace(/^mv-/, "");return changed[role]=_this.updateBackend(role), role;
});changed.source?_this.load():!_this.source&&(changed.storage||changed.init&&!_this.root.data)&&_this.load();
}), this.permissions.can("login", function() {
(null!==Mavo.Functions.url("login")&&1==_this.index||null!==Mavo.Functions.url(_this.id+"-login"))&&_this.primaryBackend.login();
}), $.bind(this.element, "mv-login.mavo", function(evt) {
evt.backend!=(_this.source||_this.storage)||_this.root.data||_this.unsavedChanges||_this.load();
}), this.bar=new Mavo.UI.Bar(this), $("summary [property]:not([typeof])")&&this.element.addEventListener("click", function(evt) {
evt.target!=document.activeElement&&evt.preventDefault();
}), this.needsEdit=this.calculateNeedsEdit(), this.setUnsavedChanges(!1), this.permissions.onchange(function(_ref) {
var action=_ref.action, value=_ref.value, permissions=_this.element.getAttribute("mv-permissions")||"";permissions=permissions.trim().split(/\s+/).filter(function(a) {
return a!=action;
}), value&&permissions.push(action), _this.element.setAttribute("mv-permissions", permissions.join(" "));
}), this.permissions.can(["edit", "add", "delete"], function() {
_this.modeObserver=new Mavo.Observer(_this.element, "mv-mode", function(records) {
records.forEach(function(record) {
var element=record.target, nodes=_.Node.children(element);nodeloop:for (var _i=0;_i<nodes.length;_i++) {
var node=nodes[_i], previousMode=node.mode, mode=void 0;if (node.element==element) {
mode=node.element.getAttribute("mv-mode"), node.modes=mode;
}
else {
if (node.modes) {
continue nodeloop;
}mode=_.getStyle(node.element.parentNode, "--mv-mode");
}node.mode=mode, previousMode!=node.mode&&node["edit"==node.mode?"edit":"done"]();
}
});
}, {subtree:!0}), _this.autoEdit&&_this.edit();
}, function() {
_this.modeObserver&&_this.modeObserver.destroy();
}), this.storage||this.source?this.permissions.can("read", function() {
return _this.load();
}):requestAnimationFrame(function() {
_this.dataLoaded.resolve(), _this.expressions.update(), $.fire(_this.element, "mv-load");
}), $.bind(this.element, "mv-load.mavo", function() {
if (location.hash) {
var callback=function() {
var target=document.getElementById(location.hash.slice(1));return (target||!location.hash)&&(_this.element.contains(target)&&requestAnimationFrame(function() {
Mavo.scrollIntoViewIfNeeded(target);
}), _this.idObserver&&(_this.idObserver.destroy(), _this.idObserver=null)), target;
};callback()||(_this.idObserver=new Mavo.Observer(_this.element, "id", callback, {subtree:!0}));
}requestAnimationFrame(function() {
return Stretchy.resizeAll();
});
}), this.autoSave&&this.dataLoaded.then(function() {
var debouncedSave=_.debounce(function() {
_this.save();
}, _this.autoSaveDelay), callback=function(evt) {
evt.node.saved&&debouncedSave();
};requestAnimationFrame(function() {
_this.permissions.can("save", function() {
$.bind(_this.element, "mv-change.mavo:autosave", callback);
}, function() {
$.unbind(_this.element, "mv-change.mavo:autosave", callback);
});
});
}), this.element.addEventListener("keydown", function(evt) {
if (_this.permissions.save&&83==evt.keyCode&&evt[_.superKey]&&!evt.altKey) {
evt.preventDefault(), _this.save();
}
else if (38==evt.keyCode||40==evt.keyCode) {
var element=evt.target;if (element.matches("textarea, input[type=range], input[type=number]")) {
return;
} if (element.matches(".mv-editor")) {
var editor=!0;element=element.parentNode;
} var node=Mavo.Node.get(element);if (node&&node.closestCollection) {
var nextNode=node.getCousin(38==evt.keyCode?-1:1, {wrap:!0});nextNode&&(editor&&nextNode.editing?nextNode.edit({immediately:!0}).then(function() {
return nextNode.editor.focus();
}):nextNode.element.focus(), evt.preventDefault());
}
}
}), $.bind(this.element, "click submit", _.Actions.listener), Mavo.hooks.run("init-end", this);
}, get editing() {
return this.root.editing;
}, getData:function(o) {
return this.root.getData(o);
}, toJSON:function() {
return _.toJSON(this.getData());
}, message:function(_message) {
var options=1<arguments.length&&arguments[1]!==void 0?arguments[1]:{};return new _.UI.Message(this, _message, options);
}, error:function(message) {
this.message(message, {type:"error", dismiss:["button", "timeout"]});for (var _len=arguments.length, log=Array(1<_len?_len-1:0), _key=1;_key<_len;_key++) {
log[_key-1]=arguments[_key];
} if (0<log.length) {
var _console;(_console=console).log.apply(_console, ["%c".concat(this.id, ": ").concat(message), "color: red; font-weight: bold"].concat(log));
}
}, render:function(data) {
var env={context:this, data:data};_.hooks.run("render-start", env), env.data&&this.root.render(env.data), this.unsavedChanges=!1, _.hooks.run("render-end", env);
}, edit:function() {
this.root.edit(), $.bind(this.element, "mouseenter.mavo:edit mouseleave.mavo:edit", function(evt) {
if (evt.target.matches(_.selectors.multiple)) {
evt.target.classList.remove("mv-has-hovered-item");var parent=evt.target.parentNode.closest(_.selectors.multiple);parent&&parent.classList.toggle("mv-has-hovered-item", "mouseenter"==evt.type);
}
}, !0), this.setUnsavedChanges();
}, done:function() {
this.root.done(), $.unbind(this.element, ".mavo:edit"), this.unsavedChanges=!1;
}, setUnsavedChanges:function(value) {
var unsavedChanges=!!value;return value||this.walk(function(obj) {
if (obj.unsavedChanges) {
return unsavedChanges=!0, !1===value&&(obj.unsavedChanges=!1), !1;
}
}), this.unsavedChanges=unsavedChanges;
}, updateBackend:function(role) {
var previous=this[role], backend, changed;if (1==this.index&&(backend=_.Functions.url(role)), backend||(backend=_.Functions.url("".concat(this.id, "-").concat(role))||this.element.getAttribute("mv-"+role)||null), backend&&(backend=backend.trim(), "none"==backend&&(backend=null)), !backend||previous&&previous.equals(backend)?!backend&&(this[role]=null):(this[role]=backend=_.Backend.create(backend, {mavo:this, format:this.element.getAttribute("mv-".concat(role, "-format"))||this.element.getAttribute("mv-format")}, this.element.getAttribute("mv-".concat(role, "-type")), this[role]), changed=!0), changed=changed||(backend?!backend.equals(previous):!!previous), changed) {
this.storage||this.source||!this.init||(this.source=this.init, this.init=null);var permissions=this.storage?this.storage.permissions:new Mavo.Permissions({edit:!0, save:!1});permissions.parent=this.source&&this.source.permissions, this.permissions.parent=permissions, this.primaryBackend=this.storage||this.source;
} return changed;
}, load:function() {
var _this2=this, backend=this.source||this.storage;return backend?(this.inProgress="Loading", backend.ready.then(function() {
return backend.load();
})["catch"](function(err) {
return _this2.init&&_this2.init!=backend?(backend=_this2.init, _this2.init.ready.then(function() {
return _this2.init.load();
})):Promise.reject(err);
})["catch"](function(err) {
if (err) {
var xhr=err instanceof XMLHttpRequest?err:err.xhr;if (xhr&&404==xhr.status) {
_this2.render(null);
}
else {
var message=_this2._("problem-loading");xhr&&(message+=xhr.status?_this2._("http-error", err):": "+_this2._("cant-connect")), _this2.error(message, err);
}
} return null;
}).then(function(data) {
return _this2.render(data);
}).then(function() {
_this2.inProgress=!1, requestAnimationFrame(function() {
_this2.dataLoaded.resolve(), $.fire(_this2.element, "mv-load");
});
})):Promise.resolve();
}, store:function() {
var _this3=this;return this.storage?(this.inProgress="Saving", this.storage.store(this.getData())["catch"](function(err) {
if (err) {
var message=_this3._("problem-saving");err instanceof XMLHttpRequest&&(message+=": "+(err.status?_this3._("http-error", err):_this3._("cant-connect"))), _this3.error(message, err);
} return null;
}).then(function(saved) {
return _this3.inProgress=!1, saved;
})):Promise.resolve();
}, upload:function(file) {
var _this4=this, path=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"images/"+file.name;return this.uploadBackend?(this.inProgress=this._("uploading"), this.uploadBackend.upload(file, path).then(function(url) {
return _this4.inProgress=!1, url;
})["catch"](function(err) {
return _this4.error(_this4._("error-uploading"), err), _this4.inProgress=!1, null;
})):Promise.reject();
}, save:function() {
var _this5=this;return this.store().then(function(saved) {
saved&&($.fire(_this5.element, "mv-save", saved), _this5.lastSaved=Date.now(), _this5.root.save(), _this5.unsavedChanges=!1);
});
}, walk:function() {
var _this$root;return (_this$root=this.root).walk.apply(_this$root, arguments);
}, calculateNeedsEdit:function() {
var needsEdit=!1;return this.walk(function(obj) {
return !needsEdit&&(needsEdit=!obj.modes&&!(obj instanceof Mavo.Group), !obj.modes);
}, void 0, {descentReturn:!0}), needsEdit;
}, changed:function(change) {
!this.root||this.expressions.active&&this.expressions.updateThrottled(change);
}, setDeleted:function() {
var _this6=this, _this$deleted;this.deleted.forEach(function(node) {
return node.destroy();
}), this.deleted.length=[], this.deletionNotice&&this.deletionNotice.close();for (var _len2=arguments.length, nodes=Array(_len2), _key2=0;_key2<_len2;_key2++) {
nodes[_key2]=arguments[_key2];
} if (nodes.length) {
if ((_this$deleted=this.deleted).push.apply(_this$deleted, nodes), 1==nodes.length) {
var phrase=nodes[0].name;
}
else {
var counts={}, ret=[];for (var name in nodes.forEach(function(n) {
counts[n.name]=(counts[n.name]||0)+1;
}), counts) {
ret.push(this._("n-items", {name:name, n:counts[name]}));
} var phrase=ret.join(", ");
} var notice=this.deletionNotice=this.message([this._("item-deleted", {name:phrase}), {tag:"button", type:"button", textContent:this._("undo"), events:{click:function() {
_this6.undoDelete(), _this6.deletionNotice.close(!0);
}}}], {classes:"mv-deleted", dismiss:{button:!0, timeout:2e4}});notice.closed.then(function(undone) {
!undone&&_this6.deleted.length&&(_this6.deleted.forEach(function(node) {
return node.destroy();
}), _this6.deleted.length=0), _this6.deletionNotice==notice&&(_this6.deletionNotice=null);
});
}
}, undoDelete:function() {
this.deleted.forEach(function(node) {
return node.collection.add(node, node.index);
}), this.deleted.length=0;
}, live:{inProgress:function(value) {
$.toggleAttribute(this.element, "mv-progress", value, value), $.toggleAttribute(this.element, "aria-busy", !!value, !!value), this.element.style.setProperty("--mv-progress-text", value?"\"".concat(this._(value), "\""):"");
}, unsavedChanges:function(value) {
this.element.classList.toggle("mv-unsaved-changes", value);
}, needsEdit:function(value) {
this.bar&&this.bar.toggle("edit", value&&this.permissions.edit);
}, storage:function(value) {
if (value!==this._storage&&!value) {
var permissions=new Mavo.Permissions({edit:!0, save:!1});permissions.parent=this.permissions.parent, this.permissions.parent=permissions;
}
}, primaryBackend:function(value) {
if (value=value||null, value!=this._primaryBackend) {
return value;
}
}, uploadBackend:{get:function() {
var backend=this.uploads;return backend&&backend.upload?(backend.permissions.login&&backend.login(), this.uploads):this.storage&&this.storage.upload?this.storage:void 0;
}}}, static:{version:"v0.2.1", all:{}, get:function(id) {
if (id instanceof Element) {
for (var name in _.all) {
if (_.all[name].element==id) {
return _.all[name];
}
} return null;
} var name="number"==typeof id?Object.keys(_.all)[id]:id;return _.all[name]||null;
}, superKey:0===navigator.platform.indexOf("Mac")?"metaKey":"ctrlKey", base:"about:"==location.protocol?document.currentScript?document.currentScript.src:"http://mavo.io":location, dependencies:[$.ready().then(function() {
return _.Plugins.load();
})], polyfills:[], init:function() {
var container=0<arguments.length&&void 0!==arguments[0]?arguments[0]:document, mavos=Array.isArray(arguments[0])?arguments[0]:$$(_.selectors.init, container), ret=mavos.filter(function(element) {
return !_.get(element);
}).map(function(element) {
return new _(element);
});return ret;
}, warn:function warn(message) {
var o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};warn.history=warn.history||new Set, _.warn.history.has(message)||console.warn(message), !1!==o.once&&warn.history.add(message);
}, thenAll:function(iterable) {
return $$(iterable).forEach(function(promise) {
"promise"==$.type(promise)&&(promise=promise["catch"](function(err) {
return err;
}));
}), Promise.all(iterable).then(function(resolved) {
return iterable.length==resolved.length?resolved:_.thenAll(iterable);
});
}, promise:function promise(constructor) {
var promise=new Promise(function(resolve, reject) {
constructor&&constructor(resolve, reject), res=resolve, rej=reject;
}), res, rej;return promise.resolve=function(a) {
return res(a), promise;
}, promise.reject=function(a) {
return rej(a), promise;
}, promise;
}, defer:function(delay) {
return new Promise(function(resolve) {
return void 0===delay?requestAnimationFrame(resolve):setTimeout(resolve, delay);
});
}, UI:{}, hooks:new $.Hooks, properties:new Set, attributes:["mv-app", "mv-storage", "mv-source", "mv-init", "mv-path", "mv-multiple-path", "mv-format", "mv-attribute", "mv-default", "mv-mode", "mv-edit", "mv-permisssions", "mv-rel", "mv-value"], lazy:{locale:function() {
return document.documentElement.lang||"en-GB";
}}}});["toNode", "isProxy", "route", "parent", "property", "mavo", "groupedBy", "as"].forEach(function(symbol) {
$.lazy(_, symbol, function() {
return Symbol(symbol);
});
}), Object.defineProperty(_.all, "length", {get:function() {
return Object.keys(this).length;
}}); {var s=_.selectors={init:"[mv-app], [data-mv-app]", property:"[property]", specificProperty:function(name) {
return "[property=".concat(name, "]");
}, group:"[typeof], [mv-group]", primitive:"[property]:not([typeof]):not([mv-group])", childGroup:"[typeof][property], [mv-group][property]", multiple:"[mv-multiple]", formControl:"input, select, option, textarea", textInput:["text", "email", "url", "tel", "search", "number"].map(function(t) {
return "input[type=".concat(t, "]");
}).join(", ")+", input:not([type]), textarea", ui:".mv-ui", container:{tr:"table", option:"select"}};$.extend(_.selectors, {item:s.multiple+", "+s.group, output:s.specificProperty("output")+", .mv-output"});}$.each({blissfuljs:Array.from&&document.documentElement.closest&&self.URL&&"searchParams"in URL.prototype, "Intl.~locale.en":self.Intl, IntersectionObserver:self.IntersectionObserver, Symbol:self.Symbol, "Element.prototype.remove":Element.prototype.remove, "Element.prototype.before":Element.prototype.before, "Element.prototype.after":Element.prototype.after, "Element.prototype.prepend":Element.prototype.prepend}, function(id, supported) {
supported||_.polyfills.push(id);
}), _.dependencies.push(_.defer().then(function() {
var polyfillURL="https://cdn.polyfill.io/v2/polyfill.min.js?unknown=polyfill&features="+_.polyfills.map(function(a) {
return a+"|gated";
}).join(",");_.dependencies.push($.include(!_.polyfills.length, polyfillURL)), $.ready().then(function() {
return $$(_.selectors.init).forEach(function(elem) {
_.get(elem)||elem.setAttribute("mv-progress", "Loading");
}), _.ready;
})["catch"](console.error).then(function() {
_.init(), _.inited.resolve();
});
})), _.ready=_.thenAll(_.dependencies), _.inited=_.promise(), Stretchy.selectors.filter=".mv-editor:not([property]), .mv-autosize", self.$=self.$||$, self.$$=self.$$||$$;
})(Bliss, Bliss.$), function($, $$) {
function updateTargetWithin() {
var element=_.getTarget(), cl="mv-target-within";for ($$("."+cl).forEach(function(el) {
return el.classList.remove(cl);
});element&&element.classList;) {
element.classList.add(cl), element=element.parentNode;
}
} var _=$.extend(Mavo, {load:function(url) {
var base=1<arguments.length&&arguments[1]!==void 0?arguments[1]:document.currentScript?document.currentScript.src:location;return $.load(url, base);
}, readFile:function(file) {
var format=1<arguments.length&&arguments[1]!==void 0?arguments[1]:"DataURL", reader=new FileReader;return new Promise(function(resolve, reject) {
reader.onload=function() {
return resolve(reader.result);
}, reader.onerror=reader.onabort=reject, reader["readAs"+format](file);
});
}, toJSON:function(data) {
if (null===data) {
return "";
} if ("string"==typeof data) {
return data;
} try {
return JSON.stringify(data, null, "\t");
}
catch (e) {
return e;
}
}, safeToJSON:function(o) {
var cache=self.WeakSet?new WeakSet:new Set;return JSON.stringify(o, function(key, value) {
if ("object"===_typeof(value)&&null!==value) {
if (cache.has(value)) {
return;
}cache.add(value);
} return value;
});
}, isPlainObject:function(o) {
if ("object"!==$.type(o)) {
return !1;
} var proto=Object.getPrototypeOf(o);return proto.constructor&&"Object"===proto.constructor.name;
}, primitivify:function(object, primitive) {
return object&&(primitive&&"object"===_typeof(primitive)&&(Object.assign(object, primitive), primitive=Mavo.value(primitive)), object.valueOf=object.toJSON=object[Symbol.toPrimitive]=function() {
return primitive;
}), object;
}, objectify:function(value, properties) {
var primitive=Mavo.value(value);if ("object"!==_typeof(value)||null===value) {
if (null===value) {
var _value;value=(_value={}, _defineProperty(_value, Symbol.toStringTag, "Null"), _defineProperty(_value, "toJSON", function() {
return null;
}), _value);
}
else {
var constructor=value.constructor;value=new constructor(primitive), value[Symbol.toStringTag]=constructor.name;
}_.primitivify(value, primitive);
} return $.extend(value, properties);
}, value:function(_value2) {
return _value2&&_value2.valueOf?_value2.valueOf():_value2;
}, toArray:function(arr) {
return arr===void 0?[]:Array.isArray(arr)?arr:[arr];
}, delete:function(arr, element, all) {
do {
var index=arr&&arr.indexOf(element);-1<index&&arr.splice(index, 1);
} while (-1<index&&all);
}, flatten:function(arr) {
return Array.isArray(arr)?arr.reduce(function(prev, c) {
return _.toArray(prev).concat(_.flatten(c));
}, []):[arr];
}, pushUnique:function(arr, item) {
-1===arr.indexOf(item)&&arr.push(item);
}, union:function(set1, set2) {
return set1 instanceof Set&&set2?(set2.forEach(function(x) {
return set1.add(x);
}), set1):new Set([].concat(_toConsumableArray(set1||[]), _toConsumableArray(set2||[])));
}, filter:function(arr, callback) {
for (var i=0;i<arr.length;i++) {
callback(arr[i])||(arr.splice(i, 1), i--);
}
}, is:function(thing) {
for (var i=0, element;i<(1>=arguments.length?0:arguments.length-1);i++) {
if (element=1>i+1||arguments.length<=i+1?void 0:arguments[i+1], element&&element.matches&&element.matches(_.selectors[thing])) {
return !0;
}
} return !1;
}, getStyle:function(element, property) {
if (element) {
var value=getComputedStyle(element).getPropertyValue(property);if (value) {
return value.trim();
}
}
}, data:function data(element, name, value) {
if (!element) {
return null;
} var data=_.elementData.get(element)||{}, ret;return 2==arguments.length?ret=data[name]:void 0===value?delete data[name]:ret=data[name]=value, _.elementData.set(element, data), ret;
}, elementData:new WeakMap, elementPath:function(ancestor, element) {
if (Array.isArray(element)) {
var path=element, ret=path.reduce(function(acc, cur) {
return acc.children[cur>>0]||acc;
}, ancestor), last=path[path.length-1];if (last!=last>>0) {
var offset=+(last+"").split(".")[1];0>last>>0&&(ret=ret.firstChild, offset--);for (var i=0;i<offset;i++) {
ret=ret.nextSibling;
}
} return ret;
} for (var path=[], parent=element;parent&&parent!=ancestor;parent=parent.parentNode) {
for (var index=0, countNonElementSiblings=parent===element&&1!==element.nodeType, offset=countNonElementSiblings?1:0, sibling=parent;sibling=sibling["previous".concat(countNonElementSiblings?"":"Element", "Sibling")];) {
countNonElementSiblings?(offset++, 1==sibling.nodeType&&(countNonElementSiblings=!1)):index++;
}0<offset&&(index=index-1+"."+offset), path.unshift(index);
} return parent?path:null;
}, revocably:{add:function(element, insert) {
var comment=_.revocably.isRemoved(element);return comment&&comment.parentNode?comment.parentNode.replaceChild(element, comment):element&&insert&&!element.parentNode&&("function"==typeof insert?insert(element):insert.appendChild(element)), comment;
}, remove:function(element, commentText) {
if (element) {
var comment=_.data(element, "commentstub");return comment||(commentText=commentText||element.id||element.className||element.nodeName, comment=_.data(element, "commentstub", document.createComment(commentText))), element.parentNode&&element.parentNode.replaceChild(comment, element), comment;
}
}, isRemoved:function(element) {
if (!element||element.parentNode) {
return !1;
} var comment=_.data(element, "commentstub");return !!(comment&&comment.parentNode)&&comment;
}, setAttribute:function(element, attribute, value) {
var previousValue=_.data(element, "attribute-"+attribute);previousValue===void 0&&_.data(element, "attribute-"+attribute, element.getAttribute(attribute)), element.setAttribute(attribute, value);
}, restoreAttribute:function(element, attribute) {
var previousValue=_.data(element, "attribute-"+attribute);previousValue!==void 0&&($.toggleAttribute(element, attribute, previousValue), _.data(element, "attribute-"+attribute, void 0));
}}, inView:{is:function(element) {
var r=element.getBoundingClientRect();return (0<=r.bottom&&r.bottom<=innerHeight||0<=r.top&&r.top<=innerHeight)&&(0<=r.right&&r.right<=innerWidth||0<=r.left&&r.left<=innerWidth);
}, when:function(element) {
var observer=_.inView.observer=_.inView.observer||new IntersectionObserver(function(entries, observer) {
entries.forEach(function(entry) {
observer.unobserve(entry.target), $.fire(entry.target, "mv-inview", {entry:entry});
});
});return new Promise(function(resolve) {
_.is(element)&&resolve(), observer.observe(element);element.addEventListener("mv-inview", function callback(evt) {
element.removeEventListener("mv-inview", callback), evt.stopPropagation(), resolve();
});
});
}}, scrollIntoViewIfNeeded:function(element) {
element&&!Mavo.inView.is(element)&&element.scrollIntoView({behavior:"smooth"});
}, setAttributeShy:function(element, attribute, value) {
element.hasAttribute(attribute)||element.setAttribute(attribute, value);
}, getAttribute:function(element) {
for (var i=0, attribute, value;attribute=1>i+1||arguments.length<=i+1?void 0:arguments[i+1];i++) {
if (value=element.getAttribute(attribute), value) {
return value;
}
} return null;
}, getClosestAttribute:function(element, attribute) {
return element=element.closest("[".concat(attribute, "]")), element?element.getAttribute(attribute):null;
}, getTarget:function() {
var id=location.hash.substr(1);return document.getElementById(id);
}, XPath:function(query) {
var context=1<arguments.length&&arguments[1]!==void 0?arguments[1]:document, doc=context.ownerDocument||context, ret=[], node;if (doc.evaluate) {
for (var result=doc.evaluate(query, context, null, XPathResult.ANY_TYPE, null);node=result.iterateNext();) {
ret.push(node);
}
} return ret;
}, attributeStartsWith:function(str, context) {
return _.XPath(".//@*[starts-with(name(), \"".concat(str, "\")]"), context);
}, in:function(property, obj) {
if (obj) {
return "object"===_typeof(obj)&&property in obj||void 0!==obj[property];
}
}, getCanonicalProperty:function(obj, property) {
if (obj&&(property||0===property)) {
if (_["in"](property, obj)) {
return property;
} if (property.toLowerCase) {
var propertyL=property.toLowerCase();if (_["in"](propertyL, obj)) {
return propertyL;
} var properties=Object.keys(obj), i=properties.map(function(p) {
return p.toLowerCase();
}).indexOf(propertyL);if (-1<i) {
return properties[i];
}
}
}
}, subset:function(obj, path, value) {
if (3==arguments.length) {
if (path.length) {
var last=path[path.length-1], parent=$.value.apply($, [obj].concat(_toConsumableArray(path.slice(0, -1))));return Array.isArray(parent)&&Array.isArray(value)?parent.splice.apply(parent, [last, 1].concat(_toConsumableArray(value))):parent&&(parent[path[path.length-1]]=value), obj;
} return value;
} return "object"==_typeof(obj)&&path&&path.length?path.reduce(function(obj, property, i) {
var meta={}, ret=Mavo.Functions.get(obj, property, meta);return path[i]=Array.isArray(meta.property)?meta.property[0]:meta.property, void 0===ret&&meta.query&&(ret=_defineProperty({}, meta.query.property, meta.query.value)), ret;
}, obj):obj;
}, clone:function(o) {
return o&&"object"===_typeof(o)?JSON.parse(_.safeToJSON(o)):o;
}, shallowClone:function(o) {
return o&&"object"===_typeof(o)?Array.isArray(o)?_toConsumableArray(o):$.extend({}, o):o;
}, debounce:function(fn, delay) {
if (!delay) {
return fn;
} var timer=null, _code;return function() {
var context=this, args=arguments;_code=function() {
fn.apply(context, args), removeEventListener("beforeunload", _code);
}, clearTimeout(timer), timer=setTimeout(_code, delay), addEventListener("beforeunload", _code);
};
}, escapeRegExp:function(s) {
return s.replace(/[-\/\\^$*+?.()|[\]{}]/g, "\\$&");
}, matches:function(str, regex) {
var ret=(str+"").match(regex);return ret?ret:[];
}, match:function(str, regex) {
var i=2<arguments.length&&arguments[2]!==void 0?arguments[2]:0;return _.matches(str, regex)[i]||"";
}, observeResize:function(element, callbackOrObserver) {
if (self.ResizeObserver) {
var previousRect=null, ro=callbackOrObserver instanceof ResizeObserver?callbackOrObserver:new ResizeObserver(function(entries) {
var contentRect=entries[entries.length-1].contentRect;previousRect&&previousRect.width==contentRect.width&&previousRect.height==contentRect.height||(callbackOrObserver(entries), previousRect=contentRect);
});return ro.observe(element), ro;
}
}, Observer:$.Class({constructor:function(element, attribute, callback) {
var o=3<arguments.length&&arguments[3]!==void 0?arguments[3]:{};callback instanceof MutationObserver&&(this.observer=callback), this.observer=this.observer||new MutationObserver(callback), this.callback=callback, this.update(element, attribute, o), this.run();
}, update:function(element, attribute, options) {
this.element=element, this.attribute=attribute, this.options=$.extend({}, options), this.attribute&&$.extend(this.options, {attributes:!0, attributeFilter:"all"==this.attribute?void 0:Mavo.toArray(this.attribute), attributeOldValue:!!options.oldValue}), this.attribute&&"all"!=this.attribute||$.extend(this.options, {characterData:!0, childList:!0, subtree:!0, characterDataOldValue:!!options.oldValue}), this.observer&&this.observer.running&&(this.stop(), this.run());
}, stop:function() {
return this.observer&&this.observer.disconnect(), this.running=!1, this;
}, run:function() {
return this.observer&&(this.observer.observe(this.element, this.options), this.running=!0), this;
}, sneak:function(callback) {
if (this.running) {
this.stop();var ret=callback();this.run();
}
else {
var ret=callback();
} return ret;
}, destroy:function() {
this.stop(), this.observer=this.element=null;
}, static:{sneak:function(observer, callback) {
return observer?observer.sneak(callback):callback();
}}}), rr:function(f) {
return f(), f;
}, wrap:function(index, length) {
return 0>index?length-1:index>=length?0:index;
}, options:function(str) {
var ret={};return (str.trim().match(/(?:\\[,;]|[^,;])+/g)||[]).forEach(function(option) {
if (option) {
option=option.trim().replace(/\\([,;])/g, "$1");var pair=option.match(/^\s*((?:\\:|[^:])+?)\s*:\s*(.+)$/);pair?ret[pair[1].replace(/\\:/g, ":")]=pair[2]:ret[option]=!0;
}
}), ret;
}, BucketMap:function() {
function BucketMap() {
var _ref2=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}, _ref2$arrays=_ref2.arrays;_classCallCheck(this, BucketMap), this.map=new Map, this[Symbol.iterator]=this.map[Symbol.iterator], this.arrays=void 0!==_ref2$arrays&&_ref2$arrays;
} return _createClass(BucketMap, [{key:"set", value:function(key, value) {
if (this.arrays) {
var values=this.map.get(key)||[];values.push(value);
}
else {
var values=this.map.get(key)||new Set;values.add(value);
} this.map.set(key, values);
}}, {key:"delete", value:function(key, value) {
if (2==arguments.length) {
var values=this.map.get(key);values&&(this.arrays?_["delete"](values, value):values["delete"](value));
}
else {
this.map["delete"](key);
}
}}, {key:"forEach", value:function() {
var _this$map;return (_this$map=this.map).forEach.apply(_this$map, arguments);
}}]), BucketMap;
}()});$.proxy=$.classProps.proxy=$.overload(function(obj, property, proxy) {
return Object.defineProperty(obj, property, {get:function() {
return this[proxy][property];
}, set:function(value) {
this[proxy][property]=value;
}, configurable:!0, enumerable:!0}), obj;
});document.addEventListener("mv-load", updateTargetWithin), addEventListener("hashchange", updateTargetWithin);new Mavo.Observer(document.documentElement, "id", updateTargetWithin, {subtree:!0});
}(Bliss, Bliss.$), function($, $$) {
var _=Mavo.Locale=$.Class({constructor:function(lang, phrases) {
this.lang=lang, this.phrases={}, this.extend(phrases);
}, get fallback() {
return _.all[this.baseLang]?_.all[this.baseLang]:this===_["default"]?void 0:_["default"];
}, extend:function(phrases) {
$.extend(this.phrases, phrases);
}, phrase:function phrase(id, vars) {
var key=id.toLowerCase(), phrase=this.phrases[key];if (void 0===phrase&&this.fallback&&(phrase=this.fallback.phrase(key)), void 0===phrase) {
phrase=key.replace(/\b-\b/g, " ");
}
else if (vars) {
var keys=Mavo.matches(phrase, /\{\w+(?=\})/g).map(function(v) {
return v.slice(1);
});Mavo.Functions.unique(keys).forEach(function(name) {
name in vars&&(phrase=phrase.replace(RegExp("{".concat(name, "}"), "gi"), vars[name]));
});
} return phrase;
}, live:{lang:function(_lang) {
this.baseLang=_.getBaseLang(_lang), _lang==this.baseLang&&(this.baseLang=null);
}}, static:{all:{}, register:function(lang, phrases) {
_.all[lang]?_.all[lang].extend(phrases):_.all[lang]=new _(lang, phrases);
}, match:function() {
var lang=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"";return _.all[lang]||_.all[_.getBaseLang(lang)];
}, get:function(lang) {
return _.match(lang)||_["default"];
}, getBaseLang:function(lang) {
return lang.split("-")[0];
}, lazy:{default:function() {
return _.match(Mavo.locale)||_.all.en;
}}}});Mavo.prototype._=function(id, vars) {
return this.locale&&id?this.locale.phrase(id, vars):id;
}, Mavo.ready.then(function() {
$$("datalist.mv-phrases[lang]").forEach(function(datalist) {
var phrases=$$("option", datalist).reduce(function(o, option) {
return o[option.value]=option.textContent.trim(), o;
}, {});Mavo.Locale.register(datalist.lang, phrases);
});
});
}(Bliss, Bliss.$), Mavo.Locale.register("en", {second:"second", seconds:"seconds", minute:"minute", minutes:"minutes", hour:"hour", hours:"hours", day:"day", days:"days", week:"week", weeks:"weeks", month:"month", months:"months", year:"year", years:"years", edit:"Edit", editing:"Editing", save:"Save", import:"Import", export:"Export", logout:"Logout", login:"Login", loading:"Loading", uploading:"Uploading", saving:"Saving", dismiss:"Dismiss", "logged-in-as":"Logged in to {id} as ", "login-to":"Login to {id}", "error-uploading":"Error uploading file", "cannot-load-uploaded-file":"Cannot load uploaded file", filename:"Filename?", "problem-saving":"Problem saving data", "problem-loading":"Problem loading data", "cannot-parse":"Can\u2019t understand this file", "http-error":"HTTP error {status}: {statusText}", "cant-connect":"Can\u2019t connect to the Internet", "add-item":"Add {name}", "add-item-before":"Add new {name} before", "add-item-after":"Add new {name} after", "drag-to-reorder":"Drag to reorder {name}", "delete-item":"Delete this {name}", "item-deleted":"{name} deleted", "n-items":"{n} {name} items", undo:"Undo", "gh-updated-file":"Updated {name}", "gh-edit-suggestion-saved-in-profile":"Your edits are saved to <a href=\"{previewURL}\" target=\"_blank\">your own profile</a>, because you are not allowed to edit this page.", "gh-edit-suggestion-instructions":"Write a short description of your edits below to suggest them to the page admins:", "gh-edit-suggestion-notreviewed":"You have selected to suggest your edits to the page admins. Your suggestions have not been reviewed yet.", "gh-edit-suggestion-send":"Send edit suggestion", "gh-edit-suggestion-revoke":"Revoke edit suggestion", "gh-edit-suggestion-reason-placeholder":"I added / corrected / deleted ...", "gh-edit-suggestion-cancelled":"Edit suggestion cancelled successfully!", "gh-edit-suggestion-title":"Suggested edits to data", "gh-edit-suggestion-body":"Hello there! I used Mavo to suggest the following edits:\n{description}\nPreview my changes here: {previewURL}", "gh-edit-suggestion-sent":"Edit suggestion sent successfully!", "gh-login-fork-options":"You have your own copy of this page, would you like to use it?", "gh-use-my-fork":"Yes, show me my data."}), function($, $$) {
Mavo.attributes.push("mv-plugins");var _=Mavo.Plugins={loaded:{}, load:function() {
return _.plugins=new Set, $$("[mv-plugins]").forEach(function(element) {
element.getAttribute("mv-plugins").trim().split(/\s+/).forEach(function(plugin) {
return _.plugins.add(plugin);
});
}), _.plugins.size?$.fetch(_.url+"/plugins.json", {responseType:"json"}).then(function(xhr) {
return Mavo.thenAll(xhr.response.plugin.filter(function(plugin) {
return _.plugins.has(plugin.id);
}).map(function(plugin) {
var filename="mavo-".concat(plugin.id, ".js");if (plugin.repo) {
var url="https://raw.githubusercontent.com/".concat(plugin.repo, "/master/").concat(filename);return _.loaded[plugin.id]?Promise.resolve():$.fetch(url).then(function(xhr) {
$.create("script", {textContent:xhr.responseText, inside:document.head});
});
} var url="".concat(_.url, "/").concat(plugin.id, "/").concat(filename);return $.include(_.loaded[plugin.id], url);
}));
}):Promise.resolve();
}, register:function(name) {
var o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if (!_.loaded[name]) {
for (var Class in Mavo.hooks.add(o.hooks), o.extend) {
var existing="Mavo"==Class?Mavo:Mavo[Class];"function"===$.type(existing)?$.Class(existing, o.extend[Class]):$.extend(existing, o.extend[Class]);
} var ready=[];if (o.ready&&ready.push(o.ready), o.dependencies) {
var base=document.currentScript?document.currentScript.src:location, dependencies=o.dependencies.map(function(url) {
return Mavo.load(url, base);
});ready.push.apply(ready, _toConsumableArray(dependencies));
} if (ready.length) {
var _Mavo$dependencies;(_Mavo$dependencies=Mavo.dependencies).push.apply(_Mavo$dependencies, ready);
}_.loaded[name]=o, o.init&&Promise.all(ready).then(function() {
return o.init();
});
}
}, url:"https://plugins.mavo.io"};
}(Bliss, Bliss.$), function($, $$) {
var _Mathmax=Math.max;Mavo.attributes.push("mv-bar");var _=Mavo.UI.Bar=$.Class({constructor:function(mavo) {
var _this7=this;if (this.mavo=mavo, this.element=$(".mv-bar", this.mavo.element), this.template=this.mavo.element.getAttribute("mv-bar")||"", this.element) {
for (var id in this.custom=!0, this.template+=" "+(this.element.getAttribute("mv-bar")||""), this.template=this.template.trim(), _.controls) {
this[id]=$(".mv-".concat(id), this.element), this[id]&&(this.template=this.template||"with", this.template+=" ".concat(id));
}
}
else {
this.element=$.create({className:"mv-bar mv-ui", start:this.mavo.element, innerHTML:"<button>&nbsp;</button>"});
} this.element.classList.contains("mv-compact")&&(this.noResize=!0), this.controls=_.getControls(this.template), this.controls.length&&(this.targetHeight=this.element.offsetHeight), this.custom||(this.element.innerHTML=""), this.controls.forEach(function(id) {
var o=_.controls[id];for (var events in _this7[id]&&_this7[id].remove(), o.create?_this7[id]=o.create.call(_this7.mavo, _this7[id]):!_this7[id]&&(_this7[id]=$.create("button", {type:"button", className:"mv-".concat(id), textContent:_this7.mavo._(id)})), _this7.add(id), o.permission?_this7.permissions.can(o.permission, function() {
_this7.toggle(id, !o.condition||o.condition.call(_this7.mavo));
}, function() {
_this7.remove(id);
}):o.condition&&!o.condition.call(_this7.mavo)&&_this7.remove(id), o.events) {
$.bind(_this7[id], events, o.events[events].bind(_this7.mavo));
}
});var _loop=function(_id) {
var o=_.controls[_id];o.action&&$.delegate(_this7.mavo.element, "click", ".mv-"+_id, function(evt) {
(!o.permission||_this7.permissions.is(o.permission))&&(o.action.call(_this7.mavo), evt.preventDefault());
});
};for (var _id in _.controls) {
_loop(_id);
} this.controls.length&&!this.noResize&&(this.resize(), self.ResizeObserver&&(this.resizeObserver=Mavo.observeResize(this.element, function() {
_this7.resize();
})));
}, resize:function() {
return this.targetHeight?void(this.resizeObserver&&this.resizeObserver.disconnect(), this.element.classList.remove("mv-compact", "mv-tiny"), $$("button, .mv-button", this.element).forEach(function(button) {
button.title===button.textContent&&(button.title="");
}), this.element.offsetHeight>1.6*this.targetHeight&&(this.element.classList.add("mv-compact"), this.element.offsetHeight>1.2*this.targetHeight&&(this.element.classList.add("mv-tiny"), $$("button, .mv-button", this.element).forEach(function(button) {
button.title||(button.title=button.textContent);
}))), this.resizeObserver&&this.resizeObserver.observe(this.element)):void(this.targetHeight=this.element.offsetHeight);
}, add:function(id) {
var _this8=this, o=_.controls[id];o.prepare&&o.prepare.call(this.mavo), Mavo.revocably.add(this[id], this.element), this.resizeObserver||this.noResize||requestAnimationFrame(function() {
return _this8.resize();
});
}, remove:function(id) {
var _this9=this, o=_.controls[id];Mavo.revocably.remove(this[id], "mv-"+id), o.cleanup&&o.cleanup.call(this.mavo), this.resizeObserver||this.noResize||requestAnimationFrame(function() {
return _this9.resize();
});
}, toggle:function(id, add) {
return this[add?"add":"remove"](id);
}, proxy:{permissions:"mavo"}, static:{getControls:function(template) {
var all=Object.keys(_.controls);if (template&&(template=template.trim())) {
if ("none"==template) {
return [];
} var relative=/^with\s|\b(yes|no)-\w+\b/.test(template);template=template.replace(/\byes-|^with\s+/g, "");var ids=template.split(/\s+/);return ids=Mavo.Functions.unique(ids.reverse()).reverse(), relative?all.filter(function(id) {
var positive=ids.lastIndexOf(id), negative=ids.lastIndexOf("no-"+id), keep=positive>_Mathmax(-1, negative), drop=negative>_Mathmax(-1, positive);return keep||!_.controls[id].optional&&!drop;
}):ids;
} return all.filter(function(id) {
return !_.controls[id].optional;
});
}, controls:{status:{create:function(custom) {
return custom||$.create({className:"mv-status"});
}, prepare:function() {
var backend=this.primaryBackend;if (backend&&backend.user) {
var user=backend.user, html=[user.name||""];user.avatar&&html.unshift($.create("img", {className:"mv-avatar", src:user.avatar}), " "), user.url&&(html=[$.create("a", {href:user.url, target:"_blank", contents:html})]), this.bar.status.textContent="", $.contents(this.bar.status, [{tag:"span", innerHTML:this._("logged-in-as", backend)}, " "].concat(_toConsumableArray(html)));
}
}, permission:"logout"}, edit:{action:function() {
this.editing?(this.done(), this.bar.edit.textContent=this._("edit")):(this.edit(), this.bar.edit.textContent=this._("editing"));
}, permission:["edit", "add", "delete"], cleanup:function() {
this.editing&&(this.done(), this.bar&&this.bar.edit&&(this.bar.edit.textContent=this._("edit")));
}, condition:function() {
return this.needsEdit;
}}, save:{action:function() {
this.save();
}, events:{"mouseenter focus":function() {
this.element.classList.add("mv-highlight-unsaved");
}, "mouseleave blur":function() {
this.element.classList.remove("mv-highlight-unsaved");
}}, permission:"save", condition:function() {
return !this.autoSave||0<this.autoSaveDelay;
}}, export:{create:function(custom) {
var a;return a=custom?custom.matches("a")?custom:$.create("a", {className:"mv-button", around:custom}):$.create("a", {className:"mv-export mv-button", textContent:this._("export")}), a.setAttribute("download", this.id+".json"), a;
}, events:{mousedown:function() {
this.bar["export"].href="data:application/json;charset=UTF-8,"+encodeURIComponent(this.toJSON());
}}, permission:"edit", optional:!0}, import:{create:function(custom) {
var _this10=this, button=custom||$.create("span", {role:"button", tabIndex:"0", className:"mv-import mv-button", textContent:this._("import"), events:{focus:function() {
input.focus();
}}}), input=$.create("input", {type:"file", inside:button, events:{change:function(evt) {
var file=evt.target.files[0];if (file) {
var reader=$.extend(new FileReader, {onload:function() {
_this10.inProgress=!1;try {
var json=JSON.parse(reader.result);_this10.render(json);
}
catch (e) {
_this10.error(_this10._("cannot-parse"));
}
}, onerror:function() {
_this10.error(_this10._("problem-loading"));
}});_this10.inProgress=_this10._("uploading"), reader.readAsText(file);
}
}}});return button;
}, optional:!0}, login:{action:function() {
this.primaryBackend.login();
}, permission:"login"}, logout:{action:function() {
this.primaryBackend.logout();
}, permission:"logout"}}}});
}(Bliss, Bliss.$), function($) {
Mavo.UI.Message=$.Class({constructor:function(mavo, message) {
var _this11=this, o=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{}, _$$create;if (this.mavo=mavo, this.message=message, this.closed=Mavo.promise(), this.options=o, this.element=$.create((_$$create={className:"mv-ui mv-message"+(o.type?" mv-"+o.type:"")}, _defineProperty(_$$create, "string"==$.type(this.message)?"innerHTML":"contents", this.message), _defineProperty(_$$create, "events", {click:function() {
return Mavo.scrollIntoViewIfNeeded(_this11.mavo.element);
}}), _defineProperty(_$$create, this.mavo.bar?"after":"start", (this.mavo.bar||this.mavo).element), _$$create)), o.style&&$.style(this.element, o.style), o.classes) {
var _this$element$classLi;(_this$element$classLi=this.element.classList).add.apply(_this$element$classLi, _toConsumableArray(o.classes.split(/\s+/)));
} if ("error"==o.type?this.element.setAttribute("role", "alert"):this.element.setAttribute("aria-live", "polite"), o.dismiss=o.dismiss||{}, "string"==typeof o.dismiss||Array.isArray(o.dismiss)) {
var dismiss={};Mavo.toArray(o.dismiss).forEach(function(prop) {
dismiss[prop]=!0;
}), o.dismiss=dismiss;
} if (o.dismiss.button&&$.create("button", {type:"button", className:"mv-close mv-ui", textContent:"\xD7", events:{click:function() {
return _this11.close();
}}, start:this.element, title:this.mavo._("dismiss")}), o.dismiss.timeout) {
var timeout="number"==typeof o.dismiss.timeout?o.dismiss.timeout:5e3;$.bind(this.element, {mouseenter:function() {
return clearTimeout(_this11.closeTimeout);
}, mouseleave:Mavo.rr(function() {
return _this11.closeTimeout=setTimeout(function() {
return _this11.close();
}, timeout);
})});
}o.dismiss.submit&&this.element.addEventListener("submit", function(evt) {
evt.preventDefault(), _this11.close(evt.target);
});
}, close:function(resolve) {
var _this12=this;clearTimeout(this.closeTimeout);var duration=this.element.style.transition?1e3*parseFloat(window.getComputedStyle(this.element, null).transitionDuration):400;$.transition(this.element, {opacity:0}, duration).then(function() {
$.remove(_this12.element), _this12.closed.resolve(resolve);
});
}});
}(Bliss, Bliss.$), function($) {
var _=Mavo.Permissions=$.Class({constructor:function(o) {
this.triggers=[], this.hooks=new $.Hooks, this.parentChanged=_.prototype.parentChanged.bind(this), this.set(o);
}, set:function(o) {
for (var action in o) {
this[action]=o[action];
}
}, on:function(actions) {
var _this13=this;return Mavo.toArray(actions).forEach(function(action) {
return _this13[action]=!0;
}), this;
}, off:function(actions) {
var _this14=this;return actions=Array.isArray(actions)?actions:[actions], actions.forEach(function(action) {
return _this14[action]=!1;
}), this;
}, can:function(actions, callback, cannot) {
this.observe(actions, !0, callback), cannot&&this.cannot(actions, cannot);
}, cannot:function(actions, callback) {
this.observe(actions, !1, callback);
}, observe:function(actions, value, callback) {
actions=Mavo.toArray(actions), this.is(actions, value)&&callback(), this.triggers.push({actions:actions, value:value, callback:callback, active:!0});
}, is:function(actions) {
var _this15=this, able=!(1<arguments.length&&arguments[1]!==void 0)||arguments[1], or=Mavo.toArray(actions).map(function(action) {
return !!_this15[action];
}).reduce(function(prev, current) {
return prev||current;
});return able?or:!or;
}, onchange:function(callback) {
var _this16=this;this.hooks.add("change", callback), _.actions.forEach(function(action) {
callback.call(_this16, {action:action, value:_this16[action]});
});
}, parentChanged:function() {
var o=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{}, localValue=this["_"+o.action];void 0!==localValue||o.from==o.value||(this.fireTriggers(o.action), this.hooks.run("change", $.extend({context:this}, o)));
}, changed:function(action, value, from) {
from=!!from, value=!!value;value==from||(this["_"+action]=value, this.fireTriggers(action), this.hooks.run("change", {action:action, value:value, from:from, context:this}));
}, fireTriggers:function(action) {
var _this17=this;this.triggers.forEach(function(trigger) {
var match=_this17.is(trigger.actions, trigger.value);trigger.active&&-1<trigger.actions.indexOf(action)&&match?(trigger.active=!1, trigger.callback()):!match&&(trigger.active=!0);
});
}, or:function(permissions) {
var _this18=this;return _.actions.forEach(function(action) {
_this18[action]=_this18[action]||permissions[action];
}), this;
}, live:{parent:function(_parent) {
var _this19=this, oldParent=this._parent;oldParent==_parent||(this._parent=_parent, oldParent&&Mavo["delete"](oldParent.hooks.change, this.parentChanged), _.actions.forEach(function(action) {
_this19.parentChanged({action:action, value:_parent?_parent[action]:void 0, from:oldParent?oldParent[action]:void 0});
}), _parent&&_parent.onchange(this.parentChanged));
}}, static:{actions:[], register:function(action, setter) {
return Array.isArray(action)?void action.forEach(function(action) {
return _.register(action, setter);
}):void($.live(_.prototype, action, {get:function() {
var ret=this["_"+action];return void 0===ret&&this.parent?this.parent[action]:ret;
}, set:function(able, previous) {
setter&&setter.call(this, able, previous), this.changed(action, able, previous);
}}), _.actions.push(action));
}}});_.register(["read", "save"]), _.register("login", function(can) {
can&&this.logout&&(this.logout=!1);
}), _.register("logout", function(can) {
can&&this.login&&(this.login=!1);
}), _.register("edit", function(can) {
can&&(this.add=this["delete"]=!0);
}), _.register(["add", "delete"], function(can) {
can||(this.edit=!1);
});
}(Bliss, Bliss.$), function($) {
var _Mathmin=Math.min, _=Mavo.Backend=$.Class({constructor:function(url) {
var o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};this.update(url, o), this.permissions=new Mavo.Permissions;
}, update:function(url) {
var o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};this.source=url, this.url=new URL(this.source, Mavo.base), this.mavo=o.mavo, this.format=Mavo.Formats.create(o.format, this);
}, get:function() {
var url=0<arguments.length&&void 0!==arguments[0]?arguments[0]:new URL(this.url);return "data:"!=url.protocol&&url.searchParams.set("timestamp", Date.now()), $.fetch(url.href).then(function(xhr) {
return Promise.resolve(xhr.responseText);
}, function() {
return Promise.resolve(null);
});
}, load:function() {
var _this20=this;return this.ready.then(function() {
return _this20.get();
}).then(function(response) {
return "string"==typeof response?(response=response.replace(/^\ufeff/, ""), _this20.format.parse(response)):response;
});
}, store:function(data) {
var _this21=this, _ref3=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}, path=_ref3.path, _ref3$format=_ref3.format, format=void 0===_ref3$format?this.format:_ref3$format;return this.ready.then(function() {
var serialize="string"==typeof data?Promise.resolve(data):format.stringify(data);return serialize.then(function(serialized) {
return _this21.put(serialized, path).then(function() {
return {data:data, serialized:serialized};
});
});
});
}, ready:Promise.resolve(), login:function() {
return Promise.resolve();
}, logout:function() {
return Promise.resolve();
}, put:function() {
return Promise.reject();
}, isAuthenticated:function() {
return !!this.accessToken;
}, oAuthParams:function() {
return "";
}, toString:function() {
return "".concat(this.id, " (").concat(this.url, ")");
}, equals:function(backend) {
return backend===this||backend&&this.id==backend.id&&this.source==backend.source;
}, request:function(call, data) {
var _this22=this, method=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"GET", req=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{};if (req=$.extend({}, req), req.method=req.method||method, req.responseType=req.responseType||"json", req.headers=$.extend({"Content-Type":"application/json; charset=utf-8"}, req.headers||{}), this.isAuthenticated()&&(req.headers.Authorization=req.headers.Authorization||"Bearer ".concat(this.accessToken)), req.data=data, call=new URL(call, this.constructor.apiDomain), "GET"==req.method&&call.searchParams.set("timestamp", Date.now()), "object"===$.type(req.data)) {
if ("GET"==req.method) {
for (var p in req.data) {
var action=void 0===req.data[p]?"delete":"set";call.searchParams[action](p, req.data[p]);
} delete req.data;
}
else {
req.data=JSON.stringify(req.data);
}
} return $.fetch(call, req)["catch"](function(err) {
return err&&err.xhr?Promise.reject(err.xhr):void _this22.mavo.error("Something went wrong while connecting to "+_this22.id, err);
}).then(function(xhr) {
return "HEAD"==req.method?xhr:xhr.response;
});
}, oAuthenticate:function(passive) {
var _this23=this;return this.ready.then(function() {
return _this23.isAuthenticated()?Promise.resolve():new Promise(function(resolve, reject) {
var id=_this23.id.toLowerCase();if (passive) {
_this23.accessToken=localStorage["mavo:".concat(id, "token")], _this23.accessToken&&resolve(_this23.accessToken);
}
else {
var popup={width:_Mathmin(1e3, innerWidth-100), height:_Mathmin(800, innerHeight-100)};popup.top=(screen.height-popup.height)/2, popup.left=(screen.width-popup.width)/2;var state={url:location.href, backend:_this23.id};(_this23.authPopup=open("".concat(_this23.constructor.oAuth, "?client_id=").concat(_this23.key, "&state=").concat(encodeURIComponent(JSON.stringify(state)))+_this23.oAuthParams(), "popup", "width=".concat(popup.width, ",height=").concat(popup.height, ",left=").concat(popup.left, ",top=").concat(popup.top)), !_this23.authPopup)&&(_this23.mavo.error("Login popup was blocked! Please check your popup blocker settings."), reject(Error("Login popup was blocked! Please check your popup blocker settings."))), addEventListener("message", function(evt) {
if (evt.source===_this23.authPopup) {
for (var appid in evt.data.backend==_this23.id&&(_this23.accessToken=localStorage["mavo:".concat(id, "token")]=evt.data.token), _this23.accessToken||reject(Error("Authentication error")), resolve(_this23.accessToken), Mavo.all) {
var storage=Mavo.all[appid].primaryBackend;storage&&storage.id===_this23.id&&storage!==_this23&&!storage.isAuthenticated()&&storage.login(!0);
}
}
});
}
});
});
}, oAuthLogout:function() {
if (this.isAuthenticated()) {
var id=this.id.toLowerCase();localStorage.removeItem("mavo:".concat(id, "token")), delete this.accessToken, this.permissions.off(["edit", "add", "delete", "save"]).on("login"), $.fire(this.mavo.element, "mv-logout", {backend:this});
} return Promise.resolve();
}, static:{create:function(url, o, type, existing) {
var Backend;return type&&(Backend=Mavo.Functions.get(_, type)), url&&!Backend&&(Backend=_.types.filter(function(Backend) {
return Backend.test(url);
})[0]||_.Remote), Backend&&existing&&existing.constructor===Backend&&existing.constructor.prototype.hasOwnProperty("update")?(existing.update(url, o), existing):Backend?new Backend(url, o):null;
}, types:[], register:function(Class) {
return _[Class.prototype.id]=Class, _.types.push(Class), Class;
}}});_.register($.Class({id:"Element", extends:_, constructor:function() {
this.permissions.on(["read", "edit", "save"]);
}, update:function(url, o) {
this["super"].update.call(this, url, o), this.element=$(this.source)||$.create("script", {type:"application/json", id:this.source.slice(1), inside:document.body});
}, get:function() {
return Promise.resolve(this.element.textContent);
}, put:function(serialized) {
return Promise.resolve(this.element.textContent=serialized);
}, static:{test:function(url) {
return 0===url.indexOf("#");
}}})), _.register($.Class({id:"Remote", extends:_, constructor:function() {
this.permissions.on("read");
}, static:{test:function() {
return !1;
}}})), _.register($.Class({extends:_, id:"Local", constructor:function() {
this.permissions.on(["read", "edit", "save"]), this.key=this.mavo.id;
}, get:function() {
return Promise[this.key in localStorage?"resolve":"reject"](localStorage[this.key]);
}, put:function(serialized) {
return serialized?localStorage[this.key]=serialized:delete localStorage[this.key], Promise.resolve(serialized);
}, static:{test:function(value) {
return "local"==value;
}}}));
}(Bliss, Bliss.$), function($) {
var _=Mavo.Formats={}, base=_.Base=$.Class({abstract:!0, constructor:function(backend) {
this.backend=backend;
}, proxy:{mavo:"backend"}, parse:function(content) {
return this.constructor.parse(content, this);
}, stringify:function(data) {
return this.constructor.stringify(data, this);
}, static:{parse:function(serialized) {
return Promise.resolve(serialized);
}, stringify:function(data) {
return Promise.resolve(data);
}, extensions:[], dependencies:[], ready:function() {
return Promise.all(this.dependencies.map(function(d) {
return $.include(d.test(), d.url);
}));
}}}), json=_.JSON=$.Class({extends:_.Base, static:{parse:function(serialized) {
return Promise.resolve(serialized?JSON.parse(serialized):null);
}, stringify:function(data) {
return Promise.resolve(Mavo.toJSON(data));
}, extensions:[".json", ".jsonld"]}}), text=_.Text=$.Class({extends:_.Base, constructor:function() {
this.property=this.mavo.root.getNames("Primitive")[0];
}, static:{extensions:[".txt"], parse:function(serialized, me) {
return Promise.resolve(_defineProperty({}, me?me.property:"content", serialized));
}, stringify:function(data, me) {
return Promise.resolve(data[me?me.property:"content"]);
}}}), csv=_.CSV=$.Class({extends:_.Base, constructor:function() {
this.property=this.mavo.root.getNames("Collection")[0], this.options=$.extend({}, _.CSV.defaultOptions);
}, static:{extensions:[".csv", ".tsv"], defaultOptions:{header:!0, dynamicTyping:!0, skipEmptyLines:!0}, dependencies:[{test:function() {
return self.Papa;
}, url:"https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.1.4/papaparse.min.js"}], ready:base.ready, parse:function(serialized, me) {
return csv.ready().then(function() {
var data=Papa.parse(serialized, csv.defaultOptions), property=me?me.property:"content";if (me&&(me.options.delimiter=data.meta.delimiter, me.options.linebreak=data.meta.linebreak), data.meta.aborted) {
throw data.meta.errors.pop();
} return _defineProperty({}, property, data.data);
});
}, stringify:function(data, me) {
return csv.ready().then(function() {
var property=me?me.property:"content", options=me?me.options:csv.defaultOptions;return Papa.unparse(data[property], options);
});
}}});Object.defineProperty(_, "create", {value:function(format, backend) {
if (format&&"object"===_typeof(format)) {
return format;
} if ("string"==typeof format) {
for (var id in format=format.toLowerCase(), _) {
var Format=_[id];if (id.toLowerCase()==format) {
return new Format(backend);
}
}
} if (!format) {
var url=backend.url?backend.url.pathname:backend.source, extension=Mavo.match(url, /\.\w+$/)||".json", Format=_.JSON;for (var id in _) {
-1<_[id].extensions.indexOf(extension)&&(Format=_[id]);
} return new Format(backend);
}
}});
}(Bliss, Bliss.$), function($, $$) {
var _Mathabs=Math.abs, _=Mavo.Node=function() {
function Node(element, mavo) {
var _this24=this, options=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};if (_classCallCheck(this, Node), !element||!mavo) {
throw new Error("Mavo.Node constructor requires an element argument and a mavo object");
} var env={context:this, options:options};this.uid=_.all.push(this)-1, this.property=null, this.element=element, this.isHelperVariable=this.element.matches("meta"), $.extend(this, env.options), _.elements.set(element, [].concat(_toConsumableArray(_.elements.get(this.element)||[]), [this])), this.mavo=mavo, this.group=this.parent=this.parentGroup=env.options.group, this.template=env.options.template, this.alias=this.element.getAttribute("mv-alias"), this.template?this.template.copies.push(this):this.copies=[], this.fromTemplate("property", "type", "storage", "path")||(this.property=_.getProperty(element), this.type=Mavo.Group.normalize(element), this.storage=this.element.getAttribute("mv-storage"), this.path=this.getPath()), this.modes=this.element.getAttribute("mv-mode"), Mavo.hooks.run("node-init-start", env), this.mode=Mavo.getStyle(this.element, "--mv-mode")||"read", this.collection=env.options.collection, this.collection&&(this.group=this.parentGroup=this.collection.parentGroup);var template=this.template;if (template&&template.expressions&&(this.expressions=template.expressions.map(function(et) {
return new Mavo.DOMExpression({template:et, item:_this24, mavo:_this24.mavo});
})), this instanceof Mavo.Group||this.collection) {
var et=Mavo.DOMExpression.search(this.element).filter(function(et) {
return "mv-value"==et.originalAttribute;
})[0];et&&(et.mavoNode=this, this.expressionText=et, this.storage=this.storage||"none", this.modes="read", this.collection&&(this.collection.expressions=[].concat(_toConsumableArray(this.collection.expressions||[]), [et]), et.mavoNode=this.collection, this.collection.storage=this.collection.storage||"none", this.collection.modes="read"));
} this.element.hasAttribute("mv-storage")&&(this.storageObserver=new Mavo.Observer(this.element, "mv-storage", function() {
_this24.storage=_this24.element.getAttribute("mv-storage");
})), Mavo.hooks.run("node-init-end", env);
} return _createClass(Node, [{key:"postInit", value:function() {
"edit"==this.modes&&this.edit();
}}, {key:"destroy", value:function() {
this.template&&Mavo["delete"](this.template.copies, this), this.expressions&&this.expressions.forEach(function(expression) {
return expression.destroy();
}), this.itembar&&this.itembar.destroy(), delete _.all[this.uid], this.propagate("destroy");
}}, {key:"getLiveData", value:function() {
return this.liveData.proxy;
}}, {key:"isDataNull", value:function() {
var o=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}, env={context:this, options:o, result:!this.saved&&!o.live};return Mavo.hooks.run("node-isdatanull", env), env.result;
}}, {key:"walk", value:function(callback) {
var path=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[], o=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};return function walker(obj, path) {
var ret=callback(obj, path);if (!1!==ret) {
for (var i in obj.children) {
var node=obj.children[i];if (node instanceof Mavo.Node) {
var ret=walker.call(node, node, [].concat(_toConsumableArray(path), [i]));if (!1===ret&&!o.descentReturn) {
return !1;
}
}
}
} return !1!==ret;
}(this, path);
}}, {key:"walkUp", value:function(callback) {
for (var group=this, ret;group=group.parentGroup;) {
if (ret=callback(group), void 0!==ret) {
return ret;
}
}
}}, {key:"edit", value:function() {
return this.mode="edit", "edit"==this.mode&&void($.fire(this.element, "mv-edit", {mavo:this.mavo, node:this}), Mavo.hooks.run("node-edit-end", this));
}}, {key:"done", value:function() {
return this.mode=Mavo.getStyle(this.element.parentNode, "--mv-mode")||"read", "read"==this.mode&&void($.unbind(this.element, ".mavo:edit"), $.fire(this.element, "mv-done", {mavo:this.mavo, node:this}), this.propagate("done"), Mavo.hooks.run("node-done-end", this));
}}, {key:"save", value:function() {
this.unsavedChanges=!1, this.propagate("save");
}}, {key:"propagate", value:function(callback) {
for (var i in this.children) {
var node=this.children[i];node instanceof Mavo.Node&&("function"==typeof callback?callback.call(node, node):callback in node&&node[callback]());
}
}}, {key:"fromTemplate", value:function() {
var _this25=this;if (this.template) {
for (var _len3=arguments.length, properties=Array(_len3), _key3=0;_key3<_len3;_key3++) {
properties[_key3]=arguments[_key3];
}properties.forEach(function(property) {
return _this25[property]=_this25.template[property];
});
} return !!this.template;
}}, {key:"render", value:function(data) {
var _this26=this, o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};o.live=o.live||Mavo["in"](Mavo.isProxy, data), o.root=o.root||this, o.live&&(data=Mavo.clone(data)), this.oldData=this.data, this.data=data, o.live||(data=Mavo.subset(data, this.inPath));var env={context:this, data:data, options:o};if (Mavo.hooks.run("node-render-start", env), !this.isHelperVariable) {
if (!Array.isArray(this.children)&&Array.isArray(env.data)) {
if (this.isRoot) {
var mainProperty=this.children.main instanceof Mavo.Collection?"main":this.getNames(function(p, n) {
return n instanceof Mavo.Collection&&!$.value(n.expressions, 0, "isDynamicObject");
})[0];mainProperty&&(env.data=_defineProperty({}, mainProperty, env.data));
} this.isRoot&&mainProperty||(this.inPath.push("0"), env.data=env.data[0]);
}
else {
this.childrenNames&&1==this.childrenNames.length&&this.childrenNames[0]===this.property&&null!==env.data&&Mavo.isPlainObject(env.data)&&(env.data=env.data[this.property]);
}
} this===o.root&&(this.expressionsEnabled=!1);var editing=this.editing;editing&&this.done();var changed=this.dataRender(env.data, o);return editing&&this.edit(), this===o.root&&(this.save(), this.expressionsEnabled=!0, changed&&requestAnimationFrame(function() {
return _this26.mavo.expressions.update(_this26);
})), Mavo.hooks.run("node-render-end", env), changed;
}}, {key:"dataChanged", value:function(action) {
var o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}, change=$.extend({action:action, property:this.property, mavo:this.mavo, node:this}, o);$.fire(o.element||this.element, "mv-change", change), this.mavo.changed(change);
}}, {key:"toString", value:function() {
return "#".concat(this.uid, ": ").concat(this.constructor.name, " (").concat(this.property, ")");
}}, {key:"getClosestCollection", value:function() {
var closestItem=this.closestItem;return closestItem?closestItem.collection:null;
}}, {key:"getClosestItem", value:function() {
return this.collection&&Array.isArray(this.collection.children)?this:this.parentGroup?this.parentGroup.closestItem:null;
}}, {key:"getPath", value:function() {
var path=this.parent?this.parent.path:[];return this.property?[].concat(_toConsumableArray(path), [this.property]):path;
}}, {key:"pathFrom", value:function(node) {
for (var path=this.path, nodePath=node.path, i=0;i<path.length&&nodePath[i]==path[i];i++) {
;
} return path.slice(i);
}}, {key:"getDescendant", value:function(path) {
return path.reduce(function(acc, cur) {
return acc.children[cur];
}, this);
}}, {key:"getCousin", value:function(offset) {
var o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if (!this.closestCollection) {
return null;
} var collection=this.closestCollection, distance=_Mathabs(offset), direction=0>offset?-1:1;if (collection.length<distance+1) {
return null;
} var index=this.closestItem.index+offset;o.wrap&&(index=Mavo.wrap(index, collection.length));for (var i=0, ind;i<collection.length;i++) {
ind=index+i*direction, o.wrap&&(ind=Mavo.wrap(ind, collection.length));var item=collection.children[ind];if (item) {
break;
}
} if (!item||item==this.closestItem) {
return null;
} if (this.collection) {
return item;
} var relativePath=this.pathFrom(this.closestItem);return item.getDescendant(relativePath);
}}, {key:"contains", value:function(node) {
do {
if (node===this) {
return !0;
}node=node.parent;
} while (node);return !1;
}}, {key:"eval", value:function(expr, o) {
return new Mavo.Expression(expr).eval(this.getLiveData(), o);
}}, {key:"editing", get:function() {
return "edit"==this.mode;
}}, {key:"isRoot", get:function() {
return !this.property;
}}, {key:"name", get:function() {
return Mavo.Functions.readable(this.property||this.type).toLowerCase();
}}, {key:"saved", get:function() {
return "none"!==this.storage;
}}, {key:"properties", get:function() {
return Object.keys(this.liveData.data[Mavo.route]);
}}], [{key:"create", value:function(element, mavo) {
var o=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};return Mavo.is("multiple", element)&&!o.collection?new Mavo.Collection(element, mavo, o):new Mavo[Mavo.is("group", element)?"Group":"Primitive"](element, mavo, o);
}}, {key:"getProperty", value:function(element) {
var property=element.getAttribute("property")||element.getAttribute("itemprop");if (!property) {
var multiple=element.getAttribute("mv-multiple");element.hasAttribute("property")&&(property=multiple||element.name||element.id||element.classList[0], !property&&(property=_.generatePropertyName(null===multiple?"prop":"collection", element)));
} return property&&element.setAttribute("property", property), property;
}}, {key:"generatePropertyName", value:function(prefix) {
for (var element=1<arguments.length&&void 0!==arguments[1]?arguments[1]:document.documentElement, root=element.closest(Mavo.selectors.init), i="", name;1e4>i;i++) {
if (name=prefix+i, !$(Mavo.selectors.specificProperty(name), root)) {
return name;
}
}
}}, {key:"get", value:function(element, prioritizePrimitive) {
var nodes=(_.elements.get(element)||[]).filter(function(node) {
return !Array.isArray(node.children);
});return 2>nodes.length||!prioritizePrimitive?nodes[0]:nodes[0]instanceof Mavo.Group?nodes[1]:void 0;
}}, {key:"getClosest", value:function(element, prioritizePrimitive) {
var node;do {
node=_.get(element, prioritizePrimitive);
} while (!node&&(element=element.parentNode));return node;
}}, {key:"getClosestItem", value:function(element) {
var item=_.getClosest(element);return item instanceof Mavo.Primitive&&!item.collection?item.parent:item;
}}, {key:"children", value:function(element) {
var ret=Mavo.Node.get(element);return ret?[ret]:(ret=$$(Mavo.selectors.property, element).map(function(e) {
return Mavo.Node.get(e);
}).filter(function(e) {
return !element.contains(e.parentGroup.element);
}).map(function(e) {
return e.collection||e;
}), Mavo.Functions.unique(ret));
}}]), Node;
}();$.Class(_, {toJSON:Mavo.prototype.toJSON, lazy:{closestCollection:function() {
return this.getClosestCollection();
}, closestItem:function() {
return this.getClosestItem();
}, inPath:function() {
var attribute=this instanceof Mavo.Collection?"mv-multiple-path":"mv-path";return (this.element.getAttribute(attribute)||"").split("/").filter(function(p) {
return p.length;
});
}}, live:{store:function(value) {
$.toggleAttribute(this.element, "mv-storage", value);
}, unsavedChanges:function(value) {
return !value||this.saved&&this.editing||(value=!1), Array.isArray(this.children)||this.element.classList.toggle("mv-unsaved-changes", value), value;
}, mode:function(value) {
var _this27=this;if (this._mode!=value) {
if (this.modes&&value!=this.modes&&(value=this.modes), this._mode=value, !Array.isArray(this.children)&&-1<[null, "", "read", "edit"].indexOf(this.element.getAttribute("mv-mode"))) {
var set=this.modes||"edit"==value;Mavo.Observer.sneak(this.mavo.modeObserver, function() {
$.toggleAttribute(_this27.element, "mv-mode", value, set);
});
} return value;
}
}, modes:function(value) {
return value&&"read"!=value&&"edit"!=value?null:void(this._modes=value, value&&this.mode!=value&&(this.mode=value));
}, collection:function(value) {
this.parent=value||this.parentGroup;
}, index:function(value) {
this._index!==value&&(this._index=value, this.liveData.updateKey());
}, expressionsEnabled:{get:function() {
return !1!==this._expressionsEnabled&&(!this.parent||this.parent.expressionsEnabled);
}}}, static:{all:[], elements:new WeakMap}});
}(Bliss, Bliss.$), function($, $$) {
var _=Mavo.Group=function(_Mavo$Node) {
function Group(element, mavo, o) {
var _this28;if (_classCallCheck(this, Group), _this28=_super.call(this, element, mavo, o), _this28.children={}, _this28.group=_assertThisInitialized(_this28), Mavo.hooks.run("group-init-start", _assertThisInitialized(_this28)), Mavo.Primitive.getValueAttribute(_this28.element)) {
_this28.children[_this28.property]=new Mavo.Primitive(_this28.element, _this28.mavo, {group:_assertThisInitialized(_this28)});
} var properties=$$(Mavo.selectors.property+", "+Mavo.selectors.multiple, _this28.element).filter(function(element) {
return _this28.element===(element.parentNode.closest(Mavo.selectors.childGroup)||_this28.mavo.element);
}), collections={};return properties.forEach(function(element) {
var property=Mavo.Node.getProperty(element);"multiple"!==collections[property]&&(collections[property]=Mavo.is("multiple", element)?"multiple":(collections[property]||0)+1);
}), properties.forEach(function(element) {
var property=Mavo.Node.getProperty(element), template=_this28.template?_this28.template.children[property]:null, options={template:template, group:_assertThisInitialized(_this28)}, isCollection=collections[property];if ("multiple"===isCollection) {
var existing=_this28.children[property];existing instanceof Mavo.Collection?existing.add(element):Mavo.is("multiple", element)?(_this28.children[property]=new Mavo.Collection(element, _this28.mavo, options), (existing||[]).forEach(function(e, i) {
return _this28.children[property].add(e, i);
})):_this28.children[property]=[].concat(_toConsumableArray(existing||[]), [element]);
}
else {
1<isCollection?_this28.children[property]?_this28.children[property].add(element):_this28.children[property]=new Mavo.ImplicitCollection(element, _this28.mavo, options):_this28.children[property]=Mavo.Node.create(element, _this28.mavo, options);
}
}), _this28.childrenNames=Object.keys(_this28.children), _this28.vocab=Mavo.getClosestAttribute(_this28.element, "vocab"), _this28.postInit(), Mavo.hooks.run("group-init-end", _assertThisInitialized(_this28)), _this28;
}_inherits(Group, _Mavo$Node);var _super=_createSuper(Group);return _createClass(Group, [{key:"getNames", value:function() {
var _this29=this, type=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"Node", filter="function"==typeof type?type:function(p, n) {
return n instanceof Mavo[type];
};return Object.keys(this.children).filter(function(p) {
return filter(p, _this29.children[p]);
});
}}, {key:"getData", value:function() {
var o=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}, env={context:this, options:o};if (this.isDataNull(o)) {
return null;
} for (var property in env.data=Mavo.shallowClone(Mavo.subset(this.data, this.inPath))||{}, this.children) {
var obj=this.children[property];if (obj.saved) {
var data=obj.getData(env.options);
}obj.saved&&null!==Mavo.value(data)?env.data[obj.property]=data:delete env.data[obj.property];
} return this.childrenNames.length||this.isRoot||this.collection?1===this.childrenNames.length&&this.property in this.children?env.data=env.data[this.property]:env.data&&"object"===_typeof(env.data)&&(this.type&&this.type!=_.DEFAULT_TYPE&&(env.data["@type"]=this.type), this.vocab&&(env.data["@context"]=this.vocab)):env.data=null, env.data=Mavo.subset(this.data, this.inPath, env.data), Mavo.hooks.run("node-getdata-end", env), env.data;
}}, {key:"edit", value:function() {
var _this30=this, o=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return !1!==_get(_getPrototypeOf(Group.prototype), "edit", this).call(this)&&Promise.all(Object.keys(this.children).map(function(prop) {
return _this30.children[prop].edit(o);
}));
}}, {key:"dataRender", value:function(data) {
var _this31=this, o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if (data) {
var changed=!1;if ("object"!==_typeof(data)) {
if (this.property in this.children) {
var property=this.property;
}
else {
var type=$.type(data), score=function(prop) {
return (_this31.children[prop]instanceof Mavo.Primitive)+(_this31.children[prop].datatype==type);
}, property=Object.keys(this.children).filter(function(p) {
return !_this31.children[p].expressionText;
}).sort(function(prop1, prop2) {
return score(prop1)-score(prop2);
}).reverse()[0];
} if (!property) {
property=this.property;
}data=_defineProperty({}, property, data), this.data=Mavo.subset(this.data, this.inPath, data);
} var copy;this.propagate(function(obj) {
var propertyData=data[obj.property];if (obj.alias) {
for (var aliasesArr=obj.alias.split(" "), i=0, currentAlias;i<aliasesArr.length;i++) {
if (currentAlias=aliasesArr[i], void 0!==data[currentAlias]) {
obj.currentAlias=currentAlias, copy=copy||$.extend({}, data), propertyData=data[obj.currentAlias];break;
}
}
}changed=obj.render(propertyData, o)||changed;
}), copy&&this.propagate(function(obj) {
obj.currentAlias&&(data[obj.property]=copy[obj.currentAlias], !(obj.currentAlias in _this31.children)&&delete data[obj.currentAlias]);
});var oldData=Mavo.subset(this.oldData, this.inPath);for (var property in data) {
if (!(property in this.children)) {
var value=data[property];changed=changed||data[property]!==this.liveData.data[property], this.liveData.set(property, value), "object"==_typeof(value)||oldData&&oldData[property]==value||this.dataChanged("propertychange", {property:property});
}
} return changed;
}
}}, {key:"isRoot", get:function() {
return !this.property;
}}], [{key:"normalize", value:function(element) {
if (Mavo.is("group", element)) {
var type=Mavo.getAttribute(element, "typeof", "mv-group")||_.DEFAULT_TYPE;return element.setAttribute("typeof", type), type;
} return null;
}}]), Group;
}(Mavo.Node);$.Class(_, {lazy:{liveData:function() {
return new Mavo.Data(this, {});
}}, static:{all:new WeakMap, DEFAULT_TYPE:"Item"}});
}(Bliss, Bliss.$), function($, $$) {
var _=Mavo.Primitive=function(_Mavo$Node2) {
function Primitive(element, mavo, o) {
var _this32;_classCallCheck(this, Primitive), _this32=_super2.call(this, element, mavo, o), _this32.liveData=new Mavo.Data(_assertThisInitialized(_this32)), _this32.fromTemplate("config", "attribute", "templateValue", "originalEditor")||(_this32.config=_.getConfig(element), _this32.attribute=_this32.config.attribute, _this32.attribute&&!document.xmlVersion&&(_this32.attribute=_this32.attribute.toLowerCase())), _this32.datatype=_this32.config.datatype, "modes"in _this32.config&&(_this32.modes=_this32.config.modes, _this32.element.setAttribute("mv-mode", _this32.config.modes)), Mavo.hooks.run("primitive-init-start", _assertThisInitialized(_this32)), _this32.expressionText=_this32.expressionText||Mavo.DOMExpression.search(_this32.element, _this32.attribute), _this32.expressionText&&!_this32.expressionText.mavoNode&&(_this32.expressionText.primitive=_assertThisInitialized(_this32), _this32.storage=_this32.storage||"none", _this32.modes="read", _this32.element.setAttribute("aria-live", "polite")), !_this32.editor&&_this32.element.hasAttribute("mv-edit")&&(!_this32.originalEditor&&(_this32.originalEditor=$(_this32.element.getAttribute("mv-edit"))), _this32.originalEditor&&!_this32.template&&(_this32.originalEditorObserver=new Mavo.Observer(_this32.originalEditor, "all", function() {
_this32.copies.concat(_assertThisInitialized(_this32)).forEach(function(primitive) {
"editor"==primitive.defaultSource&&(primitive["default"]=_this32.originalEditor.value), primitive.editor&&(primitive.editor=_this32.originalEditor.cloneNode(!0)), primitive.setValue(primitive.value, {force:!0, silent:!0});
});
}))), _this32.editor||_this32.originalEditor||_this32.attribute||(_this32.editor=$$(_this32.element.children).filter(function(el) {
return el.matches(Mavo.selectors.formControl)&&!el.matches(Mavo.selectors.property);
})[0], _this32.editor&&$.remove(_this32.editor));var editorValue=_this32.editorValue;if (_this32.datatype||"number"!=typeof editorValue&&"boolean"!=typeof editorValue||(_this32.datatype=_typeof(editorValue)), _this32.config.init&&_this32.config.init.call(_assertThisInitialized(_this32), _this32.element), _this32.config.changeEvents&&$.bind(_this32.element, _this32.config.changeEvents, function(evt) {
evt.target===_this32.element&&(_this32.value=_this32.getValue());
}), _this32.templateValue=_this32.getValue(), _this32._default=_this32.element.getAttribute("mv-default"), null===_this32["default"]) {
_this32._default=_this32.modes?_this32.templateValue:editorValue, _this32.defaultSource=_this32.modes?"template":"editor";
}
else if (""===_this32["default"]) {
_this32._default=_this32.templateValue, _this32.defaultSource="template";
}
else {
var defaultExpression=Mavo.DOMExpression.search(_this32.element, "mv-default");defaultExpression?defaultExpression.output=function(value) {
return _this32["default"]=value;
}:_this32.defaultObserver=new Mavo.Observer(_this32.element, "mv-default", function() {
_this32["default"]=_this32.element.getAttribute("mv-default");
}), _this32.defaultSource="attribute";
} var keepTemplateValue=!_this32.template||_this32.template.templateValue!=_this32.templateValue||"edit"==_this32.modes;return _this32.initialValue=void 0===_this32["default"]&&keepTemplateValue?_this32.templateValue:_this32["default"], void 0===_this32.initialValue&&(_this32.initialValue=_this32.emptyValue), _this32.setValue(_this32.initialValue, {silent:!0}), _this32.element.hasAttribute("aria-label")?$.lazy(_assertThisInitialized(_this32), "label", function() {
return _this32.labelObserver=new Mavo.Observer(_this32.element, "aria-label", function() {
_this32.label=_this32.element.getAttribute("aria-label"), "placeholder"in _this32.editor&&(_this32.editor.placeholder="(".concat(_this32.label, ")"));
}), _this32.element.getAttribute("aria-label");
}):(_this32.label=Mavo.Functions.readable(_this32.property), _this32.element.setAttribute("aria-label", _this32.label)), _this32.attribute||Mavo.setAttributeShy(_this32.element, "mv-attribute", "none"), _this32.postInit(), Mavo.hooks.run("primitive-init-end", _assertThisInitialized(_this32)), _this32;
}_inherits(Primitive, _Mavo$Node2);var _super2=_createSuper(Primitive);return _createClass(Primitive, [{key:"updateObserver", value:function() {
var _this33=this;if (this.config) {
if (!1===this.config.observer) {
this.observer&&this.observer.stop();
}
else {
var options={subtree:this.config.subtree, childList:this.config.subtree};this.observer?((this.observer.attribute!==this.attribute||this.observer.options.subtree!==options.subtree)&&this.observer.update(this.element, this.attribute, options), !this.observer.running&&this.observer.run()):this.observer=new Mavo.Observer(this.element, this.attribute, function() {
!1===_this33._config.observer?_this33.observer.stop():(_this33.attribute||!_this33.editing||_this33.config.subtree)&&(_this33.value=_this33.getValue());
}, options);
}
}
}}, {key:"destroy", value:function() {
var _this34=this;_get(_getPrototypeOf(Primitive.prototype), "destroy", this).call(this), ["defaultObserver", "observer", "originalEditorObserver", "labelObserver"].forEach(function(observer) {
_this34[observer]&&_this34[observer].destroy();
});
}}, {key:"isDataNull", value:function(o) {
return _get(_getPrototypeOf(Primitive.prototype), "isDataNull", this).call(this, o)||null===this._value||void 0===this._value;
}}, {key:"getData", value:function() {
var o=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}, env={context:this, options:o};return this.isDataNull(o)?null:(env.data=this.value, ""!==env.data||this.templateValue&&this.initialValue===this.templateValue||(env.data=null), this.inPath.length&&(env.data=Mavo.subset(this.data, this.inPath, env.data)), Mavo.hooks.run("node-getdata-end", env), env.data);
}}, {key:"sneak", value:function(callback) {
return Mavo.Observer.sneak(this.observer, callback);
}}, {key:"save", value:function() {
this.savedValue=this.value, this.unsavedChanges=!1;
}}, {key:"initEdit", value:function() {
var _this35=this;if (!this.editor&&this.originalEditor&&(this.editor=this.originalEditor.cloneNode(!0)), !this.editor) {
var editor=this.config.editor;editor&&"boolean"!=this.datatype||(editor=Mavo.Elements.defaultConfig[this.datatype||"string"].editor), this.editor=$.create("function"===$.type(editor)?editor.call(this):editor), this.editorValue=this.value;
}$.bind(this.editor, {"input change":function() {
_this35.value=_this35.editorValue;
}, "mv-change":function(evt) {
"output"===evt.property&&(evt.stopPropagation(), $.fire(_this35.editor, "input"));
}});var multiline=this.editor.matches("textarea");multiline||this.editor.addEventListener("focus", function() {
_this35.editor.select&&_this35.editor.select();
}), "placeholder"in this.editor&&(this.editor.placeholder="(".concat(this.label, ")")), Mavo.attributeStartsWith("mv-edit-", this.element).forEach(function(attribute) {
_this35.editor.setAttribute(attribute.name.replace("mv-edit-", ""), attribute.value);
}), (this.attribute||this.config.popup)&&(this.popup=new Mavo.UI.Popup(this)), this.popup||this.editor.classList.add("mv-editor"), this.initEdit=null;
}}, {key:"edit", value:function() {
var _this36=this, o=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}, wasEditing=this.editing;if (!1===_get(_getPrototypeOf(Primitive.prototype), "edit", this).call(this)) {
return !1;
} if (wasEditing&&!this.initEdit) {
return this.preEdit;
} this.preEdit||(this.preEdit=Mavo.promise(), this.afterPreEdit=null, this.preEdit.then(function() {
$.unbind(_this36.element, ".mavo:preedit"), requestAnimationFrame(function() {
if (!_this36.popup&&_this36.closestCollection&&_this36.editor&&_this36.editor.matches(Mavo.selectors.textInput)) {
var multiline=_this36.editor.matches("textarea");multiline||$.bind(_this36.editor, "paste.mavo:edit", function(evt) {
if (_this36.closestCollection.editing&&evt.clipboardData) {
var text=evt.clipboardData.getData("text/plain"), CRLF=/\r?\n|\r/;if (CRLF.test(text)) {
evt.preventDefault();var lines=text.split(CRLF);_this36.editor.setRangeText(lines[0]), $.fire(_this36.editor, "input");for (var collection=_this36.closestCollection, index=closestItem&&closestItem.index||0, i=1;i<lines.length;i++) {
var closestItem=_this36.closestItem, next=collection.add(void 0, index+i);collection.editItem(next);var copy=_this36.getCousin(i);copy.render(lines[i]);
}
}
}
}), $.bind(_this36.editor, "keydown.mavo:edit", function(evt) {
if (_this36.closestCollection.editing&&-1!==!["Backspace", "Enter"].indexOf(evt.key)) {
if ("Enter"==evt.key&&(evt.shiftKey||!multiline)) {
if (_this36.bottomUp) {
return;
} var closestItem=_this36.closestItem, next=_this36.closestCollection.add(void 0, closestItem&&closestItem.index+1);_this36.closestCollection.editItem(next);var copy=_this36.getCousin(1);requestAnimationFrame(function() {
copy.edit({immediately:!0}).then(function() {
return copy.editor.focus();
});
}), multiline&&evt.preventDefault();
}
else if ("Backspace"==evt.key&&(_this36.empty||evt[Mavo.superKey])) {
var sibling=_this36.getCousin(1)||_this36.getCousin(-1);_this36.closestCollection["delete"](_this36.closestItem), sibling&&sibling.edit({immediately:!0}).then(function() {
return sibling.editor.focus();
}), evt.preventDefault();
}
}
});
}
});
})), wasEditing||(-1===this.element.tabIndex&&Mavo.revocably.setAttribute(this.element, "tabindex", "0"), this.element.classList.add("mv-pending-edit"), !this.modes&&$.bind(this.element, "click.mavo:edit", function(evt) {
return evt.preventDefault();
}));var events=["mousedown", "focus", "dragover", "dragenter"].map(function(e) {
return e+".mavo:preedit";
}).join(" ");return ($.bind(this.element, events, function(evt) {
return _this36.preEdit.resolve(evt);
}), o.immediately&&this.preEdit.resolve(), this.config.edit)?(this.config.edit.call(this), this.initEdit=null, this.preEdit.resolve()):(this.afterPreEdit||(this.afterPreEdit=this.preEdit.then(function(evt) {
_this36.sneak(function() {
_this36.element.classList.remove("mv-pending-edit"), _this36.initEdit&&_this36.initEdit(), _this36.popup&&(_this36.popup.prepare(), _this36.popup.show()), _this36.attribute||_this36.popup||(_this36.editor.parentNode!=_this36.element&&(_this36.editorValue=_this36.value, _this36.config.hasChildren?_this36.element.textContent="":_.setText(_this36.element, ""), _this36.element.prepend(_this36.editor)), (evt&&"mousedown"==evt.type||document.activeElement===_this36.element)&&requestAnimationFrame(function() {
return _this36.editor.focus();
}), !_this36.collection&&Mavo.revocably.restoreAttribute(_this36.element, "tabindex"));
});
})), this.afterPreEdit);
}}, {key:"done", value:function() {
var _this37=this;return !1!==_get(_getPrototypeOf(Primitive.prototype), "done", this).call(this)&&void(this.afterPreEdit=null, "preEdit"in this&&$.unbind(this.element, ".mavo:preedit .mavo:edit"), this.sneak(function() {
return _this37.config.done?void _this37.config.done.call(_this37):void(_this37.popup?_this37.popup.close():!_this37.attribute&&_this37.editor&&($.remove(_this37.editor), _.setValue(_this37.element, _this37.editorValue, {config:_this37.config, attribute:_this37.attribute, datatype:_this37.datatype, map:_this37.originalEditor||_this37.editor, node:_this37})));
}), !this.collection&&Mavo.revocably.restoreAttribute(this.element, "tabindex"));
}}, {key:"dataRender", value:function(data) {
var _ref5=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}, live=_ref5.live, root=_ref5.root, previousValue=this._value;if ("object"===$.type(data)) {
if (Symbol.toPrimitive in data) {
data=data[Symbol.toPrimitive]("default");
}
else if (!this.isHelperVariable&&Mavo.isPlainObject(data)) {
var properties=Object.keys(data), property;if (1===properties.length) {
property=properties[0];
}
else {
for (var _i2=0, _arr=[this.property, "value", "content"], p;_i2<_arr.length;_i2++) {
if (p=_arr[_i2], p in data) {
property=p;break;
}
} for (var _p in data) {
var type=$.type(data[_p]);if (type===this.datatype||!this.datatype&&"string"==type) {
property=_p;break;
}
}
}property&&(data=data[property], !live&&this.inPath.push(property));
}
} return void 0===data?!this.modes&&this.value===this.templateValue&&(this.value=this.closestCollection?this["default"]:this.templateValue):this.value=data, this._value!==previousValue;
}}, {key:"find", value:function(property) {
var o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if (this.property==property&&o.exclude!==this) {
return this;
}
}}, {key:"getValue", value:function() {
return _.getValue(this.element, {config:this.config, attribute:this.attribute, datatype:this.datatype});
}}, {key:"setValue", value:function(value) {
var _this38=this, o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return this.sneak(function() {
void 0===value&&(value=null);var oldDatatype=_this38.datatype;return _this38.datatype||"number"!=typeof value&&"boolean"!=typeof value||(_this38.datatype=_typeof(value)), value=_.safeCast(value, _this38.datatype), o.force||value!==_this38._value||oldDatatype!=_this38.datatype?void(_this38.editor&&_this38.editorValue!=value&&(_this38.editorValue=value), (_this38.popup||!_this38.editor||_this38.editor!==document.activeElement&&!_this38.element.contains(_this38.editor))&&(_this38.config.setValue?_this38.config.setValue.call(_this38, _this38.element, value):!o.dataOnly&&_.setValue(_this38.element, value, {config:_this38.config, attribute:_this38.attribute, datatype:_this38.datatype, map:_this38.originalEditor||_this38.editor, node:_this38})), _this38.empty=!value&&0!==value, _this38._value=value, _this38.liveData.update(), !o.silent&&(_this38.saved&&(_this38.unsavedChanges=_this38.mavo.unsavedChanges=!0), _this38.dataChanged("propertychange", {value:value}))):value;
}), value;
}}, {key:"dataChanged", value:function() {
var action=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"propertychange", o=1<arguments.length?arguments[1]:void 0;return _get(_getPrototypeOf(Primitive.prototype), "dataChanged", this).call(this, action, o);
}}, {key:"upload", value:function(file) {
var _this39=this, name=1<arguments.length&&void 0!==arguments[1]?arguments[1]:file.name;if (this.mavo.uploadBackend&&self.FileReader) {
var tempURL=URL.createObjectURL(file);this.sneak(function() {
return _this39.element.setAttribute(_this39.attribute, tempURL);
});var path=this.element.getAttribute("mv-upload-path")||"", relative=path+"/"+name;this.mavo.upload(file, relative).then(function(url) {
var base=Mavo.getClosestAttribute(_this39.element, "mv-upload-url");base&&(url=new URL(relative, new URL(base, location))+""), _this39.value=url, _this39.element.matches("a")||_this39.sneak(function() {
return _this39.element.setAttribute(_this39.attribute, tempURL);
});
});
}
}}, {key:"createUploadPopup", value:function(type) {
var _this40=this, kind=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"file", ext=2<arguments.length?arguments[2]:void 0, env={context:this, type:type, kind:kind, ext:ext};if (env.mainInput=$.create("input", {type:"url", placeholder:"http://example.com/".concat(kind, ".").concat(ext), className:"mv-output", "aria-label":"URL to ".concat(kind)}), this.mavo.uploadBackend&&self.FileReader) {
var checkType=function(file) {
return file&&(!type||0===file.type.indexOf(type.replace("*", "")));
};return env.events={paste:function(evt) {
var item=evt.clipboardData.items[0], ext=item.type.split("/")[1];if ("file"==item.kind&&checkType(item)) {
var defaultName="pasted-".concat(kind, "-").concat(Date.now(), ".").concat(ext), name=prompt(_this40.mavo._("filename"), defaultName);""===name&&(name=defaultName), null!==name&&(_this40.upload(item.getAsFile(), name, type), evt.preventDefault());
}
}, "drag dragstart dragend dragover dragenter dragleave drop":function(evt) {
evt.preventDefault(), evt.stopPropagation();
}, "dragover dragenter":function() {
env.popup.classList.add("mv-dragover"), _this40.element.classList.add("mv-dragover");
}, "dragleave dragend drop":function() {
env.popup.classList.remove("mv-dragover"), _this40.element.classList.remove("mv-dragover");
}, drop:function(evt) {
var file=evt.dataTransfer.files[0];file&&checkType(file)&&_this40.upload(file);
}}, Mavo.hooks.run("primitive-createuploadpopup-beforecreate", env), env.popup=$.create({className:"mv-upload-popup", contents:[env.mainInput, {tag:"input", type:"file", "aria-label":"Upload ".concat(kind), accept:type, events:{change:function(evt) {
var file=evt.target.files[0];file&&checkType(file)&&_this40.upload(file);
}}}, {className:"mv-tip", innerHTML:"<strong>Tip:</strong> You can also drag & drop or paste!"}], events:env.events}), $.bind(this.element, env.events), Mavo.hooks.run("primitive-createuploadpopup-beforereturn", env), env.popup;
} return env.mainInput;
}}, {key:"editorValue", get:function() {
var editor=this.editor||this.originalEditor;if (editor) {
if (editor.matches(Mavo.selectors.formControl)) {
return _.getValue(editor, {datatype:this.datatype});
} var output=$(Mavo.selectors.output+", "+Mavo.selectors.formControl, editor);if (output) {
return _.getValue(output);
}
}
}, set:function(value) {
if (this.config.setEditorValue&&"boolean"!==this.datatype) {
return this.config.setEditorValue.call(this, value);
} if (this.editor) {
if (this.editor.matches(Mavo.selectors.formControl)) {
_.setValue(this.editor, value, {config:this.editorDefaults});
}
else {
var output=$(Mavo.selectors.output+", "+Mavo.selectors.formControl, this.editor);output&&_.setValue(output, value);
}
}
}}], [{key:"getText", value:function(element) {
var node=element.nodeType===Node.TEXT_NODE?element:element.firstChild;return node&&node.nodeType===Node.TEXT_NODE?node.nodeValue:"";
}}, {key:"setText", value:function(element, text) {
var node=element.nodeType===Node.TEXT_NODE?element:element.firstChild;node&&node.nodeType===Node.TEXT_NODE?node.nodeValue=text:element.prepend(text);
}}, {key:"getValueAttribute", value:function(element) {
var config=1<arguments.length&&void 0!==arguments[1]?arguments[1]:Mavo.Elements.search(element), ret=element.getAttribute("mv-attribute")||config.attribute;return ret&&"null"!==ret&&"none"!==ret||(ret=null), ret;
}}, {key:"safeCast", value:function(value, datatype) {
var existingType=_typeof(value), cast=_.cast(value, datatype);return "boolean"==datatype?!!value&&(!!("true"===value||0<value)||value):"number"==datatype?/^[-+]?[0-9.e]+$/i.test(value+"")?cast:value:null===value||void 0===value?value:cast;
}}, {key:"cast", value:function(value, datatype) {
return "number"===datatype?+value:"boolean"===datatype?!!value:"string"===datatype?value+"":value;
}}, {key:"getValue", value:function(element) {
var _ref6=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}, config=_ref6.config, attribute=_ref6.attribute, datatype=_ref6.datatype;if (config||(config=_.getConfig(element, attribute)), attribute=config.attribute, datatype=config.datatype, config.getValue&&attribute==config.attribute) {
return config.getValue(element);
} var ret;return ret=attribute in element&&_.useProperty(element, attribute)?element[attribute]:attribute?element.getAttribute(attribute):element.getAttribute("content")||_.getText(element)||null, _.safeCast(ret, datatype);
}}, {key:"getConfig", value:function(element, attribute, datatype) {
void 0===attribute&&(attribute=element.getAttribute("mv-attribute")||void 0), ("null"==attribute||"none"==attribute)&&(attribute=null);var isAttributeDefault=void 0===attribute||attribute==_.getValueAttribute(element);!datatype&&isAttributeDefault&&(datatype=element.getAttribute("datatype")||void 0);var config=Mavo.Elements.search(element, attribute, datatype);return config=Object.assign({}, config), void 0===config.attribute&&(config.attribute=attribute||null), void 0===config.datatype&&(config.datatype=datatype), config;
}}, {key:"setValue", value:function(element, value) {
var o=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};if (1===element.nodeType&&(o.config||(o.config=_.getConfig(element, o.attribute)), o.attribute=void 0===o.attribute?o.config.attribute:o.attribute, o.datatype=void 0===o.datatype?o.config.datatype:o.datatype, o.config.setValue&&o.attribute==o.config.attribute)) {
return o.config.setValue(element, value, o.attribute);
} if (null!==value||o.datatype||(value=""), o.attribute) {
if (o.attribute in element&&_.useProperty(element, o.attribute)&&element[o.attribute]!==value) {
try {
var previousValue=element[o.attribute], newValue=element[o.attribute]=value;
}
catch (e) {}previousValue!=newValue&&o.config.changeEvents&&o.config.changeEvents.split(/\s+/).forEach(function(type) {
return $.fire(element, type);
});
}"boolean"==o.datatype?value!=element.hasAttribute(o.attribute)&&$.toggleAttribute(element, o.attribute, value, value):element.getAttribute(o.attribute)!=value&&element.setAttribute(o.attribute, value);
}
else {
var presentational=_.format(value, o);o.node&&!o.config.hasChildren?_.setText(element, presentational):element.textContent=presentational, presentational!==value&&element.setAttribute&&element.setAttribute("content", value);
}
}}, {key:"useProperty", value:function(element, attribute) {
return !(-1<["href", "src"].indexOf(attribute))&&"http://www.w3.org/2000/svg"!=element.namespaceURI;
}}, {key:"format", value:function(value) {
var o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if (o.map&&/^select$/i.test(o.map.nodeName)) {
for (var i=0, option;option=o.map.options[i];i++) {
if (option.value==value) {
return option.textContent;
}
}
} if ("number"===$.type(value)||"number"==o.datatype) {
if (null===value) {
return "";
} var skipNumberFormatting=o.attribute||o.element&&o.element.matches("style, pre");if (!skipNumberFormatting) {
return _.formatNumber(value);
}
} return Array.isArray(value)?value.map(_.format).join(", "):"object"===$.type(value)?Mavo.toJSON(value):value;
}}]), Primitive;
}(Mavo.Node);$.Class(_, {lazy:{emptyValue:function() {
switch (this.datatype) {
case "boolean":return !1;case "number":return 0;
} return "";
}, editorDefaults:function() {
return this.editor&&_.getConfig(this.editor);
}}, live:{default:function(value) {
this.value==this._default&&(this.value=value);
}, config:function(_config) {
this._config!==_config&&(this._config=_config, this.updateObserver());
}, attribute:function(_attribute) {
this._attribute!==_attribute&&(this._attribute=_attribute, this.updateObserver());
}, value:function(_value3) {
return this.setValue(_value3);
}, datatype:function(value) {
value!==this._datatype&&("boolean"==value&&!this.attribute&&(this.attribute=Mavo.Elements.defaultConfig.boolean.attribute), $.toggleAttribute(this.element, "datatype", value, value&&"string"!==value));
}, empty:function(value) {
var hide=value&&!this.modes&&(!this.attribute||!$(Mavo.selectors.property, this.element))&&("boolean"!==this.datatype||this.attribute===Mavo.Elements.defaultConfig.boolean.attribute);this.element.classList.toggle("mv-empty", !!hide);
}}, static:{all:new WeakMap, lazy:{formatNumber:function() {
var numberFormat=new Intl.NumberFormat(Mavo.locale, {maximumFractionDigits:2});return function(value) {
return value===1/0||value===-Infinity?0>value?"-\u221E":"\u221E":numberFormat.format(value);
};
}}}});
}(Bliss, Bliss.$), function($) {
Mavo.UI.Popup=$.Class({constructor:function(primitive) {
var _this41=this;this.primitive=primitive, this.position=function() {
var bounds=_this41.primitive.element.getBoundingClientRect(), x=bounds.left, y=bounds.bottom, pointDown=!1;if (_this41.element.offsetHeight&&(_this41.height=_this41.element.getBoundingClientRect().height||_this41.height), _this41.height+y+20>innerHeight) {
if (20<bounds.top-_this41.height) {
var pointDown=!0;y=bounds.top-_this41.height-20;
}
else {
y=innerHeight-_this41.height-20;
}
}_this41.element.classList.toggle("mv-point-down", pointDown), $.style(_this41.element, {top:"".concat(y, "px"), left:"".concat(x, "px")});
}, this.element=$.create("div", {className:"mv-popup", hidden:!0, contents:{tag:"fieldset", contents:[{tag:"legend", textContent:this.primitive.label+":"}, this.editor]}, events:{keyup:function(evt) {
(13==evt.keyCode||27==evt.keyCode)&&(_this41.element.contains(document.activeElement)&&_this41.primitive.element.focus(), evt.stopPropagation(), _this41.hide());
}, transitionend:this.position}}), this.editor.matches("select")&&(this.editor.size=Math.min(10, this.editor.children.length)), this.hideCallback=function(evt) {
_this41.element.contains(evt.target)||_this41.primitive.element.contains(evt.target)||_this41.hide();
};
}, show:function() {
var _this42=this;$.unbind([this.primitive.element, this.element], ".mavo:showpopup"), this.shown=!0, this.element.style.transition="none", this.element.removeAttribute("hidden"), this.position(), this.element.setAttribute("hidden", ""), this.element.style.transition="", document.body.appendChild(this.element), setTimeout(function() {
_this42.element.removeAttribute("hidden");
}, 100), $.bind(document, "focus click", this.hideCallback, !0), window.addEventListener("scroll", this.position, {passive:!0});
}, hide:function() {
var _this43=this;$.unbind(document, "focus click", this.hideCallback, !0), window.removeEventListener("scroll", this.position, {passive:!0}), this.element.setAttribute("hidden", ""), this.shown=!1, setTimeout(function() {
$.remove(_this43.element);
}, 1e3*parseFloat(getComputedStyle(this.element).transitionDuration)||400);
}, prepare:function() {
var _this44=this;$.bind(this.primitive.element, {"click.mavo:edit":function() {
_this44.show();
}, "keyup.mavo:edit":function(evt) {
-1<[13, 113].indexOf(evt.keyCode)&&(_this44.show(), _this44.editor.focus());
}});
}, close:function() {
this.hide(), $.unbind(this.primitive.element, ".mavo:edit .mavo:preedit .mavo:showpopup");
}, proxy:{editor:"primitive"}});
}(Bliss, Bliss.$), function($) {
var _Mathmin2=Math.min, _Mathmax2=Math.max, _=Mavo.Elements={};Object.defineProperties(_, {register:{value:function(id, config) {
if ("object"===_typeof(arguments[0])) {
for (var s in arguments[0]) {
_.register(s, arguments[0][s]);
} return;
} if (config.extend) {
var base=_[config.extend];config=$.extend($.extend({}, base), config);
} if (-1<id.indexOf("@")) {
var parts=id.split("@");config.selector=config.selector||parts[0]||"*", void 0===config.attribute&&(config.attribute=parts[1]);
} return config.selector=config.selector||id, config.id=id, Array.isArray(config.attribute)?config.attribute.forEach(function(attribute) {
var o=$.extend({}, config);o.attribute=attribute, _["".concat(id, "@").concat(attribute)]=o;
}):_[id]=config, _;
}}, search:{value:function(element, attribute, datatype) {
var matches=_.matches(element, attribute, datatype);0===matches.length&&datatype&&(matches=_.matches(element, attribute));var lastMatch=matches[matches.length-1];if (lastMatch) {
return lastMatch;
} var config=$.extend({}, _.defaultConfig[datatype||"string"]);return config.attribute=void 0===attribute?config.attribute:attribute, config;
}}, matches:{value:function(element, attribute, datatype) {
var matches=[];selectorloop:for (var id in _) {
var o=_[id], attributeMatches=void 0===attribute&&o["default"]||attribute===o.attribute;if (attributeMatches&&(void 0===datatype||"string"===datatype||datatype===o.datatype)) {
var selector=o.selector||id;element.matches(selector)&&(!o.test||o.test(element, attribute, datatype))&&matches.push(o);
}
} return matches;
}}, isSVG:{value:function(e) {
return "http://www.w3.org/2000/svg"==e.namespaceURI;
}}, defaultConfig:{value:{string:{editor:{tag:"input"}}, number:{editor:{tag:"input", type:"number"}}, boolean:{attribute:"content", editor:{tag:"input", type:"checkbox"}}}}}), _.register({"@hidden":{datatype:"boolean"}, "@y":{test:_.isSVG, datatype:"number"}, "@x":{default:!0, test:_.isSVG, datatype:"number"}, media:{default:!0, selector:"img, video, audio", attribute:"src", editor:function() {
var kind=this.element.nodeName.toLowerCase();return kind="img"==kind?"image":kind, Mavo.setAttributeShy(this.element, "mv-upload-path", kind+"s"), this.createUploadPopup(kind+"/*", kind, "png");
}}, "a, link":{default:!0, attribute:"href"}, "a[mv-upload-path], link[mv-upload-path]":{default:!0, attribute:"href", editor:function() {
var type=this.element.getAttribute("type"), ext=type&&!/\/\*$/.test(type)?type.split("/")[1]:"pdf";return this.createUploadPopup(type, void 0, ext);
}}, "video, audio":{attribute:["autoplay", "buffered", "loop"], datatype:"boolean"}, details:{attribute:"open", datatype:"boolean"}, "input, select, button, textarea":{attribute:"disabled", datatype:"boolean"}, formControl:{selector:"input", default:!0, attribute:"value", modes:"edit", changeEvents:"input change", edit:function() {}, done:function() {}, init:function() {
this.editor=this.element;
}}, select:{extend:"formControl", selector:"select", subtree:!0}, "select[multiple]":{extend:"select", selector:"select[multiple]", getValue:function(element) {
return Array.from(element.selectedOptions).map(function(option) {
return option.value;
}).join();
}, setValue:function(element, value) {
value=Array.isArray(value)?value:(value+"").split(/\s*,/), Array.from(element.options).forEach(function(option) {
option.selected=!1, value=value.map(function(v) {
return v+"";
}), value.includes(option.value)&&(option.selected=!0);
});
}}, textarea:{extend:"formControl", selector:"textarea", attribute:null, getValue:function(element) {
return element.value;
}, setValue:function(element, value) {
return element.value=value;
}}, formNumber:{extend:"formControl", selector:"input[type=range], input[type=number]", datatype:"number", setValue:function(element, value) {
element.value=value, element.setAttribute("value", value);var attribute=value>element.value?"max":"min";if (!isNaN(value)&&element.value!=value&&!Mavo.data(element, "boundObserver")) {
var observer=new Mavo.Observer(element, attribute, function() {
element.value=value;
});requestAnimationFrame(function() {
$.bind(element, "input mv-change", function handler() {
observer.destroy(), Mavo.data(element, "boundObserver", void 0), $.unbind(element, "input mv-change", handler);
});
}), Mavo.data(element, "boundObserver", observer);
}
}}, checkbox:{extend:"formControl", selector:"input[type=checkbox]", attribute:"checked", datatype:"boolean", changeEvents:"click"}, radio:{extend:"formControl", selector:"input[type=radio]", attribute:"checked", modes:"edit", getValue:function(element) {
if (element.form) {
return element.form[element.name].value;
} var checked=$("input[type=radio][name=\"".concat(element.name, "\"]:checked"));return checked&&checked.value;
}, setValue:function(element, value) {
if (element.form) {
return void(element.form[element.name].value=value);
} var toCheck=$("input[type=radio][name=\"".concat(element.name, "\"][value=\"").concat(value, "\"]"));$.properties(toCheck, {checked:!0});
}, init:function(element) {
var _this45=this;this.mavo.element.addEventListener("change", function(evt) {
evt.target.name==element.name&&(_this45.value=_this45.getValue());
});
}}, counter:{extend:"formControl", selector:"button, .counter", attribute:"mv-clicked", datatype:"number", init:function(element) {
var _this46=this;"mv-clicked"===this.attribute&&(element.setAttribute("mv-clicked", "0"), element.addEventListener("click", function() {
var clicked=+element.getAttribute("mv-clicked")||0;_this46.value=++clicked;
}));
}}, "meter, progress":{default:!0, attribute:"value", datatype:"number", edit:function() {
var _this47=this, min=+this.element.getAttribute("min")||0, max=+this.element.getAttribute("max")||1, range=max-min, step=+this.element.getAttribute("mv-edit-step")||(1<range?1:range/100);$.bind(this.element, "mousemove.mavo:edit", function(evt) {
var left=_this47.element.getBoundingClientRect().left, offset=_Mathmax2(0, (evt.clientX-left)/_this47.element.offsetWidth), newValue=min+range*offset, mod=newValue%step;newValue+=mod>step/2?step-mod:-mod, newValue=_Mathmax2(min, _Mathmin2(newValue, max)), _this47.sneak(function() {
return _this47.element.setAttribute("value", newValue);
});
}), $.bind(this.element, "mouseleave.mavo:edit", function() {
_this47.sneak(function() {
return _this47.element.setAttribute("value", _this47.value);
});
}), $.bind(this.element, "click.mavo:edit", function() {
_this47.value=_this47.getValue();
}), $.bind(this.element, "keydown.mavo:edit", function(evt) {
if (evt.target==_this47.element&&(37==evt.keyCode||39==evt.keyCode)) {
var increment=step*(39==evt.keyCode?1:-1)*(evt.shiftKey?10:1), newValue=_this47.value+increment;newValue=_Mathmax2(min, _Mathmin2(newValue, max)), _this47.element.setAttribute("value", newValue), evt.preventDefault();
}
});
}, done:function() {
$.unbind(this.element, ".mavo:edit");
}}, meta:{default:!0, attribute:"content"}, block:{default:!0, selector:"p, div, dt, dd, h1, h2, h3, h4, h5, h6, article, section, address, pre", editor:function editor() {
var cs=getComputedStyle(this.element), display=cs.display, tag=0===display.indexOf("inline")?"input":"textarea", editor=$.create(tag);if ("textarea"==tag) {
var width=this.element.offsetWidth;width&&(editor.width=width), editor.style.whiteSpace={normal:"pre-wrap", nowrap:"pre"}[cs.whiteSpace]||"inherit";
} return editor;
}, setEditorValue:function(value) {
this.datatype&&"string"!=this.datatype&&(value+="");var cs=getComputedStyle(this.element);return value=value||"", -1<["normal", "nowrap"].indexOf(cs.whiteSpace)&&(value=value.replace(/\r?\n/g, " ")), -1<["normal", "nowrap", "pre-line"].indexOf(cs.whiteSpace)&&(value=value.replace(/^[ \t]+|[ \t]+$/gm, "").replace(/[ \t]+/g, " ")), this.editor.value=value, !0;
}}, time:{attribute:"datetime", default:!0, init:function() {
if (!this.fromTemplate("dateType")) {
var dateFormat=Mavo.DOMExpression.search(this.element, null), datetime=this.element.getAttribute("datetime")||"YYYY-MM-DD";for (var type in this.config.dateTypes) {
if (this.config.dateTypes[type].test(datetime)) {
break;
}
} this.dateType=type, dateFormat||(this.element.textContent=this.config.defaultFormats[this.dateType](this.property), this.mavo.expressions.extract(this.element, null), (dateFormat=Mavo.DOMExpression.search(this.element, null))&&this.mavo.treeBuilt.then(function() {
dateFormat.update();
}));
}
}, dateTypes:{month:/^[Y\d]{4}-[M\d]{2}$/i, time:/^[H\d]{2}:[M\d]{2}/i, "datetime-local":/^[Y\d]{4}-[M\d]{2}-[D\d]{2} [H\d]{2}:[Mi\d]{2}/i, date:/^[Y\d]{4}-[M\d]{2}-[D\d]{2}$/i}, defaultFormats:{date:function(name) {
return "[day(".concat(name, ")] [month(").concat(name, ", 'shortname')] [year(").concat(name, ")]");
}, month:function(name) {
return "[month(".concat(name, ", 'name')] [year(").concat(name, ")]");
}, time:function(name) {
return "[hour(".concat(name, ", '00')]:[minute(").concat(name, ", '00')]");
}, "datetime-local":function(name) {
return this.date(name)+" "+this.time(name);
}}, editor:function() {
return {tag:"input", type:this.dateType};
}}, "circle@r":{default:!0, datatype:"number"}, circle:{attribute:["cx", "cy"], datatype:"number"}, text:{default:!0, popup:!0}, ".mv-toggle":{default:!0, attribute:"aria-checked", datatype:"boolean", edit:function() {
var _this48=this;Mavo.revocably.setAttribute(this.element, "role", "checkbox"), $.bind(this.element, "click.mavo:edit keyup.mavo:edit keydown.mavo:edit", function(evt) {
("click"==evt.type||" "==evt.key||"Enter"==evt.key)&&("keydown"!=evt.type&&(_this48.value=!_this48.value), evt.preventDefault(), evt.stopPropagation());
});
}, done:function() {
Mavo.revocably.restoreAttribute(this.element, "role"), $.unbind(this.element, ".mavo:edit");
}}});
}(Bliss, Bliss.$), function($, $$) {
Mavo.attributes.push("mv-multiple", "mv-order", "mv-accepts", "mv-initial-items", "mv-like");var _=Mavo.Collection=function(_Mavo$Node3) {
function Collection(element, mavo, o) {
var _this49;return _classCallCheck(this, Collection), _this49=_super3.call(this, element, mavo, o), _this49.templateElement=_this49.element, _this49.children=[], _this49.liveData=new Mavo.Data(_assertThisInitialized(_this49), []), _this49.marker=document.createComment("mv-marker"), Mavo.data(_this49.marker, "collection", _assertThisInitialized(_this49)), _this49.templateElement.after(_this49.marker), _this49.addButton=_this49.createAddButton(), _this49.mavo.root||!_this49.templateElement.hasAttribute("mv-like")?_this49.init():_this49.mavo.treeBuilt.then(function() {
return _this49.init();
}), _this49;
}_inherits(Collection, _Mavo$Node3);var _super3=_createSuper(Collection);return _createClass(Collection, [{key:"createAddButton", value:function() {
var _this50=this, selector="button.mv-add-".concat(this.property), group=this.parentGroup.element, button=$$(selector, group).filter(function(button) {
return !_this50.templateElement.contains(button)&&!Mavo.data(button, "collection");
})[0];return button?(button.compareDocumentPosition(this.marker)&Node.DOCUMENT_POSITION_FOLLOWING&&Mavo.setAttributeShy(this.templateElement, "mv-order", "desc"), Mavo.revocably.remove(button)):button=$.create("button", {type:"button", className:"mv-ui", textContent:this.mavo._("add-item", this)}), button.classList.add("mv-add", "mv-add-".concat(this.property)), Mavo.data(button, "collection", this), Mavo.setAttributeShy(button, "mv-action", "add(".concat(this.property, ")")), button;
}}, {key:"init", value:function() {
var _this51=this;if (!this.fromTemplate("templateElement", "accepts", "initialItems", "like", "likeNode")) {
if (this.like=this.templateElement.getAttribute("mv-like"), this.like) {
var candidates=[];this.mavo.walk(function(obj) {
obj instanceof _&&obj.property===_this51.like&&obj!==_this51&&candidates.push(obj);
}), 0<candidates.length?(this.likeNode=candidates.sort(function(a, b) {
return a.pathFrom(_this51).length-b.pathFrom(_this51).length;
})[0], this.likeNode=this.likeNode.likeNode||this.likeNode, this.likeNode=this.likeNode.template||this.likeNode):this.like=null;
} this.accepts=this.templateElement.getAttribute("mv-accepts"), this.accepts=new Set(this.accepts&&this.accepts.split(/\s+/)||[]), this.initialItems=+(this.templateElement.getAttribute("mv-initial-items")||(this.like?0:1)), this.templateElement=this.templateElement.cloneNode(!0);
} if (this.likeNode) {
this.itemTemplate=this.likeNode.itemTemplate||this.likeNode;var templateElement=this.likeNode.templateElement||$.value(this.likeNode.collection, "templateElement")||this.likeNode.element;this.templateElement=templateElement.cloneNode(!0), this.templateElement.setAttribute("property", this.property), this.accepts.size||(this.accepts=this.likeNode.accepts||this.accepts);
}
else if (0<this.initialItems||!this.template) {
var item=this.createItem(this.element);this.add(item, void 0, {silent:!0});
} this.mavo.treeBuilt.then(function() {
if (!_this51.initialItems) {
item?_this51["delete"](item, {silent:!0}):_this51.element.remove();
}
else if (1<_this51.initialItems) {
for (var i=1;i<_this51.initialItems;i++) {
_this51.add();
}
}
}), this.postInit(), Mavo.hooks.run("collection-init-end", this);
}}, {key:"getData", value:function() {
var o=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}, env={context:this, options:o};return env.data=this.children.map(function(item) {
return item.getData(env.options);
}).filter(function(itemData) {
return null!==Mavo.value(itemData);
}), env.data=Mavo.subset(this.data, this.inPath, env.data), Mavo.hooks.run("node-getdata-end", env), env.data;
}}, {key:"createItem", value:function(element) {
element||(element=this.templateElement.cloneNode(!0));var template=this.itemTemplate||(this.template?this.template.itemTemplate:null), item=Mavo.Node.create(element, this.mavo, {collection:this, template:template, property:this.property, type:this.type});return this.itemTemplate||(this.itemTemplate=template||item), item;
}}, {key:"add", value:function(item, index) {
var _this52=this, o=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};item=item instanceof Node?Mavo.Node.get(item)||this.createItem(item):item||this.createItem(), item.collection!=this&&this.adopt(item), void 0===index&&(index=this.bottomUp?0:this.length);var rel=this.children[index]?this.children[index].element:this.marker;$.before(item.element, rel);var env={context:this, item:item};return env.previousIndex=item.index, env.changed=this.splice({remove:env.item}, {index:index, add:env.item}), this.mavo.expressions.active&&!o.silent&&requestAnimationFrame(function() {
env.changed.forEach(function(i) {
i.dataChanged(i==env.item&&void 0===env.previousIndex?"add":"move"), i.unsavedChanges=!0;
}), _this52.unsavedChanges=_this52.mavo.unsavedChanges=!0, _this52.mavo.expressions.update(env.item);
}), Mavo.hooks.run("collection-add-end", env), env.item;
}}, {key:"splice", value:function() {
for (var _this53=this, _len4=arguments.length, actions=Array(_len4), _key4=0;_key4<_len4;_key4++) {
actions[_key4]=arguments[_key4];
}actions.forEach(function(action) {
void 0===action.index&&action.remove&&isNaN(action.remove)&&(action.index=_this53.children.indexOf(action.remove), action.remove=1);
}), actions.sort(function(a, b) {
return b.index-a.index;
});var changed=[], deleted=[];actions.forEach(function(action) {
if (-1<action.index&&(action.remove||action.add)) {
var _deleted, _this53$children;action.remove=action.remove||0, action.add=Mavo.toArray(action.add), (_deleted=deleted).push.apply(_deleted, _toConsumableArray((_this53$children=_this53.children).splice.apply(_this53$children, [action.index, +action.remove].concat(_toConsumableArray(action.add)))));
}
}), deleted=new Set(deleted);for (var i=0, item;i<this.length;i++) {
item=this.children[i], deleted["delete"](item), item&&item.index!==i&&(item.index=i, changed.push(item));
} return deleted.forEach(function(item) {
item.expressions&&item.expressions.forEach(function(domexpression) {
item.mavo.expressions.unregister(domexpression);
});
}), this.liveData.update(), changed;
}}, {key:"adopt", value:function(item) {
var _this54=this;item.collection&&(item.collection.splice({remove:item}), item.collection.dataChanged("delete")), item.collection=this, this.walk(function(obj) {
obj.closestCollection===item.collection&&(obj.closestCollection=_this54), item.mavo!=_this54.mavo&&(obj.mavo=_this54.mavo), obj.path=obj.getPath();
}), item.template&&(Mavo["delete"](item.template.copies, item), item.template=this.itemTemplate);
}}, {key:"delete", value:function(item) {
var _this55=this, _ref7=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}, silent=_ref7.silent, _ref7$undoable=_ref7.undoable, undoable=void 0===_ref7$undoable?!silent:_ref7$undoable, _ref7$transition=_ref7.transition, transition=void 0===_ref7$transition?!silent:_ref7$transition, _ref7$destroy=_ref7.destroy, destroy=void 0===_ref7$destroy?!undoable:_ref7$destroy;if (item.element.classList.remove("mv-highlight"), this.splice({remove:item}), !silent&&transition) {
var stage2=$.transition(item.element, {opacity:0}).then(function() {
item.element.style.opacity="";
});
}
else {
var stage2=Promise.resolve();
} return stage2.then(function() {
return $.remove(item.element), silent||(_this55.unsavedChanges=item.unsavedChanges=_this55.mavo.unsavedChanges=!0, item.collection.dataChanged("delete", {index:item.index})), undoable?_this55.mavo.setDeleted(item):destroy&&item.destroy(), item;
});
}}, {key:"move", value:function(item, offset) {
var index=item.index+offset+(0<offset);index=Mavo.wrap(index, this.children.length+1), this.add(item, index);
}}, {key:"editItem", value:function(item) {
var o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}, when=o.immediately?Promise.resolve():Mavo.inView.when(item.element);return when.then(function() {
return item.itembar||(item.itembar=new Mavo.UI.Itembar(item)), item.itembar.add(), item.edit(o);
});
}}, {key:"edit", value:function() {
var _this56=this, o=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};if (!1===_get(_getPrototypeOf(Collection.prototype), "edit", this).call(this)) {
return !1;
} if (!this.addButton.parentNode) {
var tag=this.element.tagName.toLowerCase();if (tag in Mavo.selectors.container) {
var rel=this.marker.parentNode.closest(Mavo.selectors.container[tag]);
}
else if (this.bottomUp&&this.children[0]) {
var rel=this.children[0].element;
}rel=rel||this.marker, Mavo.revocably.add(this.addButton, function(e) {
return $[_this56.bottomUp?"before":"after"](e, rel);
});
} return _.dragula.then(function() {
_this56.getDragula();
}), Promise.all(this.children.map(function(item) {
return _this56.editItem(item, o);
}));
}}, {key:"done", value:function() {
return !1!==_get(_getPrototypeOf(Collection.prototype), "done", this).call(this)&&void(Mavo.revocably.remove(this.addButton), this.propagate(function(item) {
item.itembar&&item.itembar.remove();
}));
}}, {key:"dataChanged", value:function(action) {
var o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return o.element=o.element||this.marker, _get(_getPrototypeOf(Collection.prototype), "dataChanged", this).call(this, action, o);
}}, {key:"dataRender", value:function(data) {
var o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if (void 0!==data) {
data=null===data?[]:Mavo.toArray(data).filter(function(i) {
return null!==i;
});for (var changed=!1, i=0, item;i<this.children.length;i++) {
item=this.children[i], i<data.length?changed=item.render(data[i], o)||changed:(changed=!0, this["delete"](item, {silent:!0}), i--);
} if (data.length>i) {
for (var fragment=document.createDocumentFragment(), j=i, item;j<data.length;j++) {
item=this.createItem(), changed=item.render(data[j], o)||changed, this.children.push(item), item.index=j, fragment.appendChild(item.element);var env={context:this, item:item};Mavo.hooks.run("collection-add-end", env);
} this.marker.before(fragment);
} if (this.liveData.update(), data.length>i) {
for (var j=i;j<this.children.length;j++) {
this.children[j].dataChanged("add");
}
} return changed;
}
}}, {key:"isCompatible", value:function(c) {
return c&&this.itemTemplate.constructor==c.itemTemplate.constructor&&(c===this||c.template==this||this.template==c||this.template&&this.template==c.template||-1<this.accepts.has(c.property));
}}, {key:"destroy", value:function() {
_get(_getPrototypeOf(Collection.prototype), "destroy", this).call(this), this.dragula&&(this.dragula.destroy(), this.dragula=null), this.propagate("destroy");
}}, {key:"getDragula", value:function() {
var _this57=this;if (this.dragula) {
return this.dragula;
} if (this.template) {
return Mavo.pushUnique(this.template.getDragula().containers, this.marker.parentNode), this.dragula=this.template.dragula||this.template.getDragula();
} this;return this.dragula=dragula({containers:[this.marker.parentNode], isContainer:function(el) {
return !!_this57.accepts.size&&Array.from(el.childNodes).some(function(child) {
var collection=_.get(child);return collection&&_this57.accepts.has(collection.property);
});
}, moves:function(el, container, handle) {
return handle.classList.contains("mv-drag-handle")&&handle.closest(Mavo.selectors.multiple)==el;
}, accepts:function(el, target, source, next) {
if (el.contains(target)) {
return !1;
} var previous=next?next.previousElementSibling:target.lastElementChild, collection=_.get(previous)||_.get(next);if (!collection) {
return !1;
} var item=Mavo.Node.get(el);return item&&item.collection.isCompatible(collection);
}}), this.dragula.on("drop", function(el) {
var item=Mavo.Node.get(el), oldIndex=item&&item.index, next=el.nextElementSibling, previous=el.previousElementSibling, collection=_.get(previous)||_.get(next), closestItem=Mavo.Node.get(previous)||Mavo.Node.get(next);if (closestItem&&closestItem.collection!=collection&&(closestItem=null), item.collection.isCompatible(collection)) {
var index=closestItem?closestItem.index+(closestItem.element===previous):collection.length;collection.add(item, index);
}
else {
return _this57.dragula.cancel(!0);
}
}), _.dragulas.push(this.dragula), this.dragula;
}}, {key:"getClosestCollection", value:function() {
return this;
}}, {key:"length", get:function() {
return this.children.length;
}}], [{key:"get", value:function(element) {
var collection=Mavo.data(element, "collection");if (collection) {
return collection;
} var item=Mavo.Node.get(element);return item&&item.collection||null;
}}, {key:"delete", value:function(nodes) {
var o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}, deleted=new Mavo.BucketMap({arrays:!0}), collections=new Set, options={silent:!0, undoable:!1, destroy:!1}, promises=nodes.filter(function(node) {
return !!node.collection;
}).map(function(node) {
return collections.add(node.collection), node.collection["delete"](node, options).then(function(node) {
return deleted.set(node.mavo, node);
});
});o.silent||Promise.all(promises).then(function() {
collections.forEach(function(collection) {
collection.dataChanged("delete");
}), !1!==o.undoable&&deleted.forEach(function(nodes, mavo) {
mavo.setDeleted.apply(mavo, _toConsumableArray(nodes));
});
});
}}]), Collection;
}(Mavo.Node);$.Class(_, {lazy:{bottomUp:function() {
return /^desc\b/i.test(this.templateElement.getAttribute("mv-order"));
}}, static:{dragulas:[], lazy:{dragula:function() {
return $.include(self.dragula, "https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.min.js");
}}}});
}(Bliss, Bliss.$), function() {
Mavo.ImplicitCollection=function(_Mavo$Node4) {
function ImplicitCollection(element, mavo, o) {
var _this58;return _classCallCheck(this, ImplicitCollection), _this58=_super4.call(this, element, mavo, o), _this58.children=[], _this58.liveData=new Mavo.Data(_assertThisInitialized(_this58), []), _this58.add(element), _this58.postInit(), Mavo.hooks.run("implicit-collection-init-end", _assertThisInitialized(_this58)), _this58;
}_inherits(ImplicitCollection, _Mavo$Node4);var _super4=_createSuper(ImplicitCollection);return _createClass(ImplicitCollection, [{key:"getData", value:function() {
var o=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}, env={context:this, options:o, data:[]};if (this.children.forEach(function(node) {
node.isDataNull()||env.data.push(node.getData(o));
}), this.data) {
var rendered=Mavo.toArray(Mavo.subset(this.data, this.inPath));rendered.length>env.data.length&&(env.data=env.data.concat(rendered.slice(env.data.length)));
} return Array.isArray(env.data)&&1>=env.data.length&&(env.data=1===env.data.length?env.data[0]:null), env.data=Mavo.subset(this.data, this.inPath, env.data), Mavo.hooks.run("node-getdata-end", env), env.data;
}}, {key:"add", value:function(element) {
var item=Mavo.Node.create(element, this.mavo, {collection:this, template:this.template&&this.template.children[this.length]||null, property:this.property, type:this.type});return item.index=this.length, this.children.push(item), this.liveData.update(), item;
}}, {key:"edit", value:function() {
var o=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return !1!==_get(_getPrototypeOf(ImplicitCollection.prototype), "edit", this).call(this)&&Promise.all(this.children.map(function(item) {
return item.edit(o);
}));
}}, {key:"dataRender", value:function(data) {
var o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if (void 0!==data) {
data=null===data?[]:Mavo.toArray(data).filter(function(i) {
return null!==i;
});var changed=data.length!==this.liveData.length;this.children.forEach(function(item, i) {
return changed=item.render(data&&data[i], o)||changed;
});
} this.liveData.update();
}}, {key:"length", get:function() {
return this.children.length;
}}]), ImplicitCollection;
}(Mavo.Node);
}(Bliss, Bliss.$), function($, $$) {
var _=Mavo.UI.Itembar=$.Class({constructor:function(item) {
var _this59=this;if (this.item=item, this.element=$$(".mv-item-bar:not([mv-rel]), .mv-item-bar[mv-rel=\"".concat(this.item.property, "\"]"), this.item.element).filter(function(el) {
return el.closest(Mavo.selectors.multiple)==_this59.item.element&&!Mavo.data(el, "item");
})[0], !this.element&&this.item.template&&this.item.template.itembar) {
this.element=this.item.template.itembar.element.cloneNode(!0), this.dragHandle=$(".mv-drag-handle", this.element)||this.item.element;
}
else {
this.element=this.element||$.create({className:"mv-item-bar mv-ui"});var bottomUp=this.collection.bottomUp, args="$item".concat(bottomUp?", $index + 1":""), buttons=[{tag:"button", type:"button", title:this.mavo._("delete-item", this.item), className:"mv-delete", "mv-action":"delete($item)"}, {tag:"button", type:"button", title:this.mavo._("add-item-".concat(bottomUp?"after":"before"), this.item), className:"mv-add", "mv-action":"if($cmd, add($item, ".concat(args, "), add(").concat(args, "))")}];this.item instanceof Mavo.Group?(this.dragHandle=$.create({tag:"button", type:"button", title:this.mavo._("drag-to-reorder", this.item), className:"mv-drag-handle"}), buttons.push(this.dragHandle)):this.dragHandle=this.item.element, $.set(this.element, {"mv-rel":this.item.property, contents:buttons});
} this.element.setAttribute("hidden", ""), $.bind([this.item.element, this.element], "focusin mouseover", this), $.bind(this.element, {mouseenter:function() {
_this59.item.element.classList.add("mv-highlight");
}, mouseleave:function() {
_this59.item.element.classList.remove("mv-highlight");
}}), this.dragHandle.addEventListener("keydown", function(evt) {
evt.target===_this59.dragHandle&&_this59.item.editing&&37<=evt.keyCode&&40>=evt.keyCode&&(_this59.collection.move(_this59.item, 38>=evt.keyCode?-1:1), evt.stopPropagation(), evt.preventDefault(), evt.target.focus());
}), this.dragHandle!==this.item.element&&this.dragHandle.addEventListener("click", function(evt) {
return evt.target.focus();
}), Mavo.data(this.element, "item", this.item);
}, destroy:function() {
this.hide();
}, show:function(sticky) {
var _this60=this;_.visible.forEach(function(instance) {
instance!=_this60&&(!_this60.sticky||instance.sticky)&&(clearTimeout(instance.hideTimeout), instance.hide(sticky, _.DELAY));
}), _.visible.add(this), (this.element.hasAttribute("hidden")||sticky&&!this.sticky)&&(this.element.removeAttribute("hidden"), this.sticky=this.sticky||sticky, $.bind([this.item.element, this.element], "focusout mouseleave", this));
}, hide:function(sticky) {
var _this61=this, timeout=1<arguments.length&&arguments[1]!==void 0?arguments[1]:0;(!this.sticky||sticky)&&(timeout?this.hideTimeout=setTimeout(function() {
return _this61.hide(sticky);
}, timeout):(this.element.setAttribute("hidden", ""), $.unbind([this.item.element, this.element], "focusout mouseleave", this), this.sticky=!1, _.visible["delete"](this)));
}, handleEvent:function(evt) {
var sticky=-1===evt.type.indexOf("mouse");this.isWithinItem(evt.target)&&(clearTimeout(this.hideTimeout), -1<["mouseleave", "focusout", "blur"].indexOf(evt.type)?!this.isWithinItem(evt.relatedTarget)&&this.hide(sticky, _.DELAY):(this.show(sticky), evt.stopPropagation()));
}, isWithinItem:function(element) {
if (!element) {
return !1;
} var itemBar=element.closest(".mv-item-bar");return itemBar?itemBar===this.element:element.closest(Mavo.selectors.item)===this.item.element;
}, add:function() {
if (!this.element.parentNode&&!Mavo.revocably.add(this.element)) {
var tag=this.item.element.nodeName.toLowerCase();if (tag in _.container) {
var rel=$(_.container[tag], this.item.element);
}(rel||this.item.element).appendChild(this.element);
} this.dragHandle==this.item.element&&this.item.element.classList.add("mv-drag-handle");
}, remove:function() {
Mavo.revocably.remove(this.element), this.dragHandle==this.item.element&&this.item.element.classList.remove("mv-drag-handle");
}, live:{sticky:function(v) {
this.element.classList.toggle("mv-sticky", v);
}}, proxy:{collection:"item", mavo:"item"}, static:{DELAY:100, visible:new Set, container:{details:"summary"}}});
}(Bliss, Bliss.$), function($) {
var _=Mavo.Expression=$.Class({constructor:function(expression) {
this.expression=expression;
}, eval:function() {
var data=0<arguments.length&&void 0!==arguments[0]?arguments[0]:Mavo.Data.stub, o=1<arguments.length?arguments[1]:void 0;if (Mavo.hooks.run("expression-eval-beforeeval", this), !this["function"]) {
try {
this["function"]=Mavo.Script.compile(this.expression, o);
}
catch (error) {
return this.error("There is something wrong with the expression ".concat(this.expression), error.message, "Not an expression? See https://mavo.io/docs/expressions/#disabling-expressions for information on how to disable expressions."), Mavo.hooks.run("expression-compile-error", {context:this, error:error}), this["function"]=error;
}
}
 else if (this["function"]instanceof Error) {
return this["function"];
} try {
return this["function"](data);
}
catch (error) {
return this.error("Something went wrong with the expression ".concat(this.expression), error.message, "Data was: ".concat(JSON.stringify(data))), Mavo.hooks.run("expression-eval-error", {context:this, error:error}), error;
}
}, error:function(title) {
for (var _len5=arguments.length, message=Array(1<_len5?_len5-1:0), _key5=1;_key5<_len5;_key5++) {
message[_key5-1]=arguments[_key5];
}message=message.join("\n"), console.info("%cOops! \uD83D\uDE33 ".concat(title, ":"), "color: #c04; font-weight: bold;", message);
}, toString:function() {
return this.expression;
}, changedBy:function(evt) {
return _.changedBy(this.identifiers, evt);
}, live:{expression:function(value) {
this["function"]=null, this.identifiers=value.match(/[$a-z][$\w]*/ig)||[];
}}});_.Syntax=$.Class({constructor:function(start, end) {
this.start=start, this.end=end, this.regex=RegExp("".concat(Mavo.escapeRegExp(start), "([\\S\\s]*?)").concat(Mavo.escapeRegExp(end)), "gi");
}, test:function(str) {
return this.regex.lastIndex=0, this.regex.test(str);
}, tokenize:function(str) {
var ret=[], lastIndex=0, match;for (this.regex.lastIndex=0;null!==(match=this.regex.exec(str));) {
match.index>lastIndex&&ret.push(str.substring(lastIndex, match.index)), lastIndex=this.regex.lastIndex, /\S/.test(match[1])?ret.push(new Mavo.Expression(match[1])):ret.push(match[0]);
} return lastIndex<str.length&&ret.push(str.substring(lastIndex)), ret;
}, static:{create:function(element) {
if (element) {
var syntax=element.getAttribute("mv-expressions");if (syntax) {
return syntax=syntax.trim(), /\s/.test(syntax)?_construct(_.Syntax, _toConsumableArray(syntax.split(/\s+/))):_.Syntax.ESCAPE;
}
}
}, ESCAPE:-1}}), _.Syntax["default"]=new _.Syntax("[", "]");
}(Bliss, Bliss.$), function($) {
var _=Mavo.DOMExpression=$.Class({constructor:function() {
var _this62=this, o=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};this.mavo=o.mavo, this.template=o.template&&o.template.template||o.template;for (var _i3=0, _arr2=["item", "path", "syntax", "fallback", "attribute", "originalAttribute", "expression", "parsed", "identifiers"], prop;_i3<_arr2.length;_i3++) {
prop=_arr2[_i3], this[prop]=void 0===o[prop]&&this.template?this.template[prop]:o[prop];
} if (this.node=o.node, this.node||(this.node=Mavo.elementPath(this.item.element, this.path)), this.element=this.node, this.attribute=this.attribute||null, Mavo.hooks.run("domexpression-init-start", this), "mv-value"==this.attribute) {
this.originalAttribute="mv-value", this.attribute=Mavo.Primitive.getValueAttribute(this.element), this.fallback=this.fallback||Mavo.Primitive.getValue(this.element, {attribute:this.attribute});var expression=this.element.getAttribute("mv-value");this.element.removeAttribute("mv-value"), this.parsed=[new Mavo.Expression(expression)], this.expression=this.syntax.start+expression+this.syntax.end;
} if (3===this.node.nodeType&&this.element===this.node&&(this.element=this.node.parentNode, (!this.node.parentNode.children.length||this.attribute)&&(this.node=this.element, this.element.normalize())), !this.expression) {
if (this.attribute) {
var value=Element.prototype.getAttribute.call(this.node, this.attribute);this.expression=(value||"").trim();
}
else {
if (this.node.normalize(), this.node.firstChild&&1===this.node.childNodes.length&&3===this.node.firstChild.nodeType) {
var whitespace=this.node.firstChild.textContent.match(/^\s*|\s*$/g);whitespace[1]&&(this.node.firstChild.splitText(this.node.firstChild.textContent.length-whitespace[1].length), this.node.after(this.node.lastChild)), whitespace[0]&&(this.node.firstChild.splitText(whitespace[0].length), this.node.parentNode.insertBefore(this.node.firstChild, this.node));
} this.expression=this.node.textContent;
} this.parsed=this.template?this.template.parsed:this.syntax.tokenize(this.expression);
} this.oldValue=this.value=this.parsed.map(function(x) {
return x instanceof Mavo.Expression?x.expression:x;
}), this.identifiers=this.identifiers||Mavo.flatten(this.parsed.map(function(x) {
return x.identifiers||[];
})), _.special.add(this), this.mavo.treeBuilt.then(function() {
_this62.template||_this62.item||(_this62.item=Mavo.Node.getClosestItem(_this62.element)), "mv-value"==_this62.originalAttribute&&_this62.mavoNode&&_this62.mavoNode==_this62.item.collection&&Mavo["delete"](_this62.item.expressions, _this62), _this62.mavo.expressions.register(_this62), Mavo.hooks.run("domexpression-init-treebuilt", _this62);
}), Mavo.hooks.run("domexpression-init-end", this), _.elements.set(this.element, [].concat(_toConsumableArray(_.elements.get(this.element)||[]), [this]));
}, destroy:function() {
_.special["delete"](this), this.mavo.expressions.unregister(this);
}, get isDynamicObject() {
return "mv-value"==this.originalAttribute&&this.mavoNode&&!(this.mavoNode instanceof Mavo.Primitive);
}, changedBy:function(evt) {
return this.isDynamicObject?!evt||!this.mavoNode.contains(evt.node):Mavo.Expression.changedBy(this.identifiers, evt);
}, update:function() {
var _this63=this, env={context:this}, parentEnv=env;if (this.item) {
var scope=this.isDynamicObject?this.item.parent:this.item, data=this.data=scope.getLiveData();
}
else {
var data=void 0===this.data?Mavo.Data.stub:this.data;
}Mavo.hooks.run("domexpression-update-start", env), this.oldValue=this.value;var changed=!1;env.value=this.value=this.parsed.map(function(expr) {
if (expr instanceof Mavo.Expression) {
var env={context:_this63, expr:expr, parentEnv:parentEnv};return Mavo.hooks.run("domexpression-update-beforeeval", env), env.value=Mavo.value(env.expr.eval(data)), Mavo.hooks.run("domexpression-update-aftereval", env), changed=!0, env.value instanceof Error?void 0===_this63.fallback?_this63.syntax.start+env.expr.expression+_this63.syntax.end:_this63.fallback:void 0===env.value||null===env.value?"":env.value;
} return expr;
});changed&&(env.value=1===env.value.length?env.value[0]:env.value.map(function(v) {
return Mavo.Primitive.format(v, {attribute:_this63.attribute, element:_this63.element});
}).join(""), this.output(env.value), Mavo.hooks.run("domexpression-update-end", env));
}, output:function(value) {
this.primitive?(Mavo["in"](Mavo.isProxy, value)&&(value=Mavo.clone(value)), this.primitive.value=value):this.mavoNode?this.mavoNode.render(value):Mavo.Primitive.setValue(this.node, value, {attribute:this.attribute});
}, live:{item:function(_item) {
_item&&this._item!=_item&&(this._item&&Mavo["delete"](this._item.expressions, this), _item.expressions=_item.expressions||[], _item.expressions.push(this));
}}, static:{elements:new WeakMap, search:function(element, attribute) {
if (null===element) {
return element;
}attribute&&!element.ownerDocument.xmlVersion&&(attribute=attribute.toLowerCase());var all=_.elements.get(element)||[];return 1<arguments.length?all.length?all.filter(function(et) {
return et.attribute===attribute;
})[0]||null:null:all;
}, special:{add:function(domexpression, name) {
if (name) {
var o=this.vars[name], hasName=-1<domexpression.identifiers.indexOf(name), hasUnprefixedName=name.startsWith("$")&&-1<domexpression.identifiers.indexOf(name.substr(1));o&&(hasName||hasUnprefixedName)&&(o.all=o.all||new Set, o.all.add(domexpression), 1===o.all.size?o.observe():!o.all.size&&o.unobserve());
}
else {
for (var name in this.vars) {
this.add(domexpression, name);
}
}
}, delete:function(domexpression, name) {
if (name) {
var o=this.vars[name];o.all=o.all||new Set, o.all["delete"](domexpression), o.all.size||o.unobserve();
}
else {
for (var name in this.vars) {
this["delete"](domexpression, name);
}
}
}, update:function() {
this.update&&this.update.apply(this, arguments), this.all.forEach(function(domexpression) {
return domexpression.update();
});
}, event:function(name) {
var _ref8=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}, type=_ref8.type, update=_ref8.update, _ref8$target=_ref8.target, target=void 0===_ref8$target?document:_ref8$target;this.vars[name]={observe:function() {
this.callback=this.callback||_.special.update.bind(this), target.addEventListener(type, this.callback);
}, unobserve:function() {
target.removeEventListener(type, this.callback);
}}, update&&(this.vars[name].update=function(evt) {
Mavo.Functions[name]=update(evt);
});
}, vars:{$now:{observe:function() {
var _this64=this;this.timer=requestAnimationFrame(function callback() {
_.special.update.call(_this64), _this64.timer=requestAnimationFrame(callback);
});
}, unobserve:function() {
cancelAnimationFrame(this.timer);
}}}}}});_.special.event("$mouse", {type:"mousemove", update:function(evt) {
return {x:evt.clientX, y:evt.clientY};
}}), _.special.event("$hash", {type:"hashchange", target:window});
}(Bliss, Bliss.$), function($, $$) {
Mavo.attributes.push("mv-expressions");var _=Mavo.Expressions=$.Class({constructor:function(mavo) {
var _this65=this;this.mavo=mavo, this.active=!0, this.expressions=[], this.identifiers={};var syntax=Mavo.Expression.Syntax.create(this.mavo.element.closest("[mv-expressions]"))||Mavo.Expression.Syntax["default"];this.traverse(this.mavo.element, void 0, syntax), this.scheduled={}, this.mavo.treeBuilt.then(function() {
_this65.expressions=[], _this65.update();
});
}, register:function(domexpression) {
var _this66=this, ids=this.identifiers;domexpression.registeredApp=domexpression.registeredApp||new Set, domexpression.identifiers.forEach(function(id) {
ids[id]instanceof Set||(ids[id]=new Set), ids[id].add(domexpression), Mavo.all[id]instanceof Mavo&&Mavo.all[id]!==_this66.mavo&&!domexpression.registeredApp.has(id)&&(domexpression.registeredApp.add(id), Mavo.all[id].expressions.register(domexpression));
});
}, unregister:function(domexpression) {
var ids=this.identifiers;domexpression.identifiers.forEach(function(id) {
ids[id]&&ids[id]["delete"](domexpression), id in Mavo.all&&"undefined"!=typeof domexpresssion&&Mavo.all[id].expressions.unregister(domexpresssion);
});
}, updateThrottled:function(evt) {
var _this67=this;if (this.active) {
var scheduled=this.scheduled[evt.action]=this.scheduled[evt.action]||new Set;evt.node.template?!scheduled.has(evt.node.template)&&(setTimeout(function() {
scheduled["delete"](evt.node.template), _this67.update(evt);
}, _.THROTTLE), scheduled.add(evt.node.template)):requestAnimationFrame(function() {
return _this67.update(evt);
});
}
}, update:function(evt) {
if (this.active) {
var root, rootObject;if (evt instanceof Mavo.Node) {
rootObject=evt;
}
else if (evt instanceof Element) {
root=evt.closest(Mavo.selectors.item), rootObject=Mavo.Node.get(root);
}
else {
if (evt) {
var cache={updated:new Set};if (this.updateByIdThrottled(evt.property, evt, cache), "propertychange"==evt.action) {
evt.node&&evt.node.path&&this.updateByIdThrottled(evt.node.path, evt, cache);
}
else {
this.updateById(Object.keys(Mavo.Data.special), evt, cache);var collection=evt.node.collection||evt.node;this.updateById(collection.properties, evt, cache);
} return;
}rootObject=this.mavo.root;
}rootObject.walk(function(obj) {
return !!obj.expressionsEnabled&&void(obj.expressions&&obj.expressions.forEach(function(et) {
evt&&et.mavoNode===evt||et.update();
}));
});
}
}, updateByIdThrottled:function(property, evt, cache) {
var _this68=this;if (property) {
if (property.forEach) {
property.forEach(function(property) {
return _this68.updateByIdThrottled(property, evt, cache);
});
}
else {
var scheduled=this.scheduledIds=this.scheduledIds||new Set;scheduled.has(property)||(setTimeout(function() {
scheduled["delete"](property), _this68.updateById(property, evt, cache);
}, _.THROTTLE), scheduled.add(property));
}
}
}, updateById:function(property, evt, cache) {
var _this69=this;if (property.forEach) {
return void property.forEach(function(p) {
return _this69.updateById(p, evt, cache);
});
} var exprs=this.identifiers[property];exprs&&exprs.forEach(function(expr) {
"mv-value"==expr.originalAttribute&&expr.mavoNode&&!(expr.mavoNode instanceof Mavo.Primitive)&&expr.mavoNode.contains(evt.node)||!cache.updated.has(expr)&&expr.update();
});
}, extract:function(node, attribute, path) {
var syntax=3<arguments.length&&arguments[3]!==void 0?arguments[3]:Mavo.Expression.Syntax["default"];attribute&&-1<_.skip.indexOf(attribute.name)||(attribute&&-1<_.directives.indexOf(attribute.name)||syntax!==Mavo.Expression.Syntax.ESCAPE&&syntax.test(attribute?attribute.value:node.textContent))&&(path===void 0&&(path=Mavo.elementPath(node.closest(Mavo.selectors.item), node)), this.expressions.push(new Mavo.DOMExpression({node:node, syntax:syntax, path:path, attribute:attribute&&attribute.name, mavo:this.mavo})));
}, traverse:function(node) {
var _this70=this, path=1<arguments.length&&arguments[1]!==void 0?arguments[1]:[], syntax=2<arguments.length?arguments[2]:void 0;if (8!==node.nodeType) {
if (3===node.nodeType) {
this.extract(node, null, path, syntax);
}
else {
if (node.normalize(), syntax=Mavo.Expression.Syntax.create(node)||syntax, Mavo.is("item", node)&&(path=[]), node.hasAttribute("mv-expressions-ignore")) {
var ignore=new Set(node.getAttribute("mv-expressions-ignore").trim().split(/\s*,\s*/));
}$$(node.attributes).forEach(function(attribute) {
ignore&&ignore.has(attribute.name)||_this70.extract(node, attribute, path, syntax);
});var index=-1, offset=0;node.matches("script:not([mv-expressions])")||$$(node.childNodes).forEach(function(child) {
if (1==child.nodeType?(offset=0, index++):offset++, 1==child.nodeType||3==child.nodeType) {
var segment=0<offset?"".concat(index, ".").concat(offset):index;_this70.traverse(child, [].concat(_toConsumableArray(path||[]), [segment]), syntax);
}
});
}
}
}, static:{directives:["mv-value"], skip:["mv-expressions", "mv-action"], THROTTLE:50, directive:function(name, o) {
_.directives.push(name), Mavo.attributes.push(name), Mavo.Plugins.register(name, o);
}}});
}(Bliss, Bliss.$), function($, $$) {
Mavo.Expressions.directive("mv-if", {extend:{Primitive:{live:{hidden:function(value) {
this._hidden!==value&&(this._hidden=value, this.liveData.update(), this.dataChanged());
}}}, DOMExpression:{lazy:{childProperties:function() {
var _this71=this, properties=$$(Mavo.selectors.property, this.element).filter(function(el) {
return el.closest("[mv-if]")==_this71.element;
}).map(function(el) {
return Mavo.Node.get(el);
});return this.element.addEventListener("mv-change", function(evt) {
requestAnimationFrame(function() {
_this71.element.parentNode||_this71.item.element.dispatchEvent(evt);
});
}), properties;
}}}}, hooks:{"domexpression-init-start":function() {
"mv-if"!=this.attribute||(!Mavo.Node.prototype.fromTemplate.call(this, "parsed", "expression")&&(this.expression=this.element.getAttribute("mv-if"), this.parsed=[new Mavo.Expression(this.expression)], this.expression=this.syntax.start+this.expression+this.syntax.end), this.parentIf=this.element.parentNode&&Mavo.DOMExpression.search(this.element.parentNode.closest("[mv-if]"), "mv-if"), this.parentIf&&(this.parentIf.childIfs=(this.parentIf.childIfs||new Set).add(this)));
}, "domexpression-update-end":function() {
var _this72=this;if ("mv-if"==this.attribute) {
var value=this.value[0], oldValue=this.oldValue[0];this.item.mavo.treeBuilt.then(function() {
if (_this72.parentIf) {
var parentValue=_this72.parentIf.value[0];_this72.value[0]=value=value&&parentValue;
}!1!==parentValue&&(value?Mavo.revocably.add(_this72.element):_this72.element.parentNode&&Mavo.revocably.remove(_this72.element, "mv-if")), value!==oldValue&&(_this72.childProperties&&_this72.childProperties.forEach(function(property) {
return property.hidden=!value;
}), _this72.childIfs&&_this72.childIfs.forEach(function(childIf) {
return childIf.update();
}));
});
}
}, "node-isdatanull":function(env) {
env.result=env.result||this.hidden&&env.options.live;
}}});
}(Bliss, Bliss.$), function($, val) {
var _Mathfloor=Math.floor, _Mathabs2=Math.abs, _Mathmin3=Math.min;function str() {
var str=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"";return str=val(str), str||0===str?str+"":"";
} function empty(v) {
return v=Mavo.value(v), null===v||!1===v||""===v;
} function not(v) {
return !val(v);
} var _arguments=arguments, _=Mavo.Functions={operators:{"=":"eq"}, get:function(obj, property) {
var meta=2<arguments.length&&arguments[2]!==void 0?arguments[2]:{};property=meta.property=val(property);var canonicalProperty=Mavo.getCanonicalProperty(obj, property);if (canonicalProperty!==void 0) {
meta.property=canonicalProperty;var ret=obj[canonicalProperty];return "function"==typeof ret&&0!==ret.name.indexOf("bound")?ret.bind(obj):ret;
} if (Array.isArray(obj)&&property&&isNaN(property)) {
var eqIndex=property.indexOf("=");return -1<eqIndex?(meta.query={property:property.slice(0, eqIndex), value:property.slice(eqIndex+1)}, meta.property=[], ret=obj.filter(function(e, i) {
var passes=_.get(e, meta.query.property)==meta.query.value;return passes&&meta.property.push(i), passes;
}), "id"==meta.query.property&&(meta.property=meta.property[0], ret=ret[0]), void 0===ret?meta.property=obj.length:0===ret.length&&(meta.property=[obj.length]), ret):obj.map(function(e) {
return _.get(e, property);
});
} return null;
}, url:function(id) {
var _url=1<arguments.length&&arguments[1]!==void 0?arguments[1]:location;if (id===void 0) {
return location.href;
} if (id) {
id=str(id).replace(/[^\w-:]/g);var ret=_url.search.match(RegExp("[?&]".concat(id, "(?:=(.+?))?(?=$|&)")))||_url.pathname.match(RegExp("(?:^|\\/)".concat(id, "\\/([^\\/]*)")));
} return null!==ret&&id?decodeURIComponent(ret[1]||""):null;
}, first:function(n, arr) {
if (void 0===arr&&(arr=n, n=void 0), void 0===arr) {
return null;
} if (!Array.isArray(arr)) {
return void 0===n?arr:[arr];
} if (0>n) {
return _.last(_Mathabs2(n), arr);
} for (var ret=[], numReturn=void 0===n?1:_Mathfloor(n), i=0;i<arr.length&&ret.length<numReturn;i++) {
null!==Mavo.value(arr[i])&&ret.push(arr[i]);
} return void 0===n?void 0===ret[0]?null:ret[0]:ret;
}, last:function(n, arr) {
if (void 0===arr&&(arr=n, n=void 0), void 0===arr) {
return null;
} if (!Array.isArray(arr)) {
return void 0===n?arr:[arr];
} if (0>n) {
return _.first(_Mathabs2(n), arr);
} for (var ret=[], numReturn=void 0===n?1:_Mathfloor(n), i=arr.length-1;0<=i&&ret.length<numReturn;i--) {
null!==Mavo.value(arr[i])&&ret.push(arr[i]);
} return void 0===n?void 0===ret[0]?null:ret[0]:ret;
}, condense:function(arr) {
return _.first(arr.length, arr);
}, unique:function(arr) {
return Array.isArray(arr)?_toConsumableArray(new Set(arr.map(val))):arr;
}, intersects:function(arr1, arr2) {
if (arr1&&arr2) {
var set2=new Set(Mavo.toArray(arr2).map(val));return arr1=Mavo.toArray(arr1).map(val), !arr1.every(function(el) {
return !set2.has(el);
});
}
}, sum:$.extend(function(array) {
return $u.numbers(array, arguments).reduce(function(prev, current) {
return +prev+(+current||0);
}, 0);
}, {isAggregate:!0}), average:$.extend(function(array) {
return array=$u.numbers(array, arguments), array.length&&_.sum(array)/array.length;
}, {isAggregate:!0, alias:"avg"}), median:$.extend(function(array) {
var _Mathceil=Math.ceil;array=$u.numbers(array, arguments).sort(function(a, b) {
return a-b;
});var mi=(array.length-1)/2, _ref9=[array[_Mathfloor(mi)], array[_Mathceil(mi)]];return m1=_ref9[0], m2=_ref9[1], (m1+m2)/2||0;
}, {isAggregate:!0}), min:$.extend(function(array) {
return _Mathmin3.apply(Math, _toConsumableArray($u.numbers(array, arguments)));
}, {isAggregate:!0}), max:$.extend(function(array) {
return Math.max.apply(Math, _toConsumableArray($u.numbers(array, arguments)));
}, {isAggregate:!0}), atan2:$.extend(function(dividend, divisor) {
return Math.atan2(dividend, divisor);
}, {multiValued:!0, rightUnary:function(b) {
return b;
}, default:1}), pow:$.extend(function(base, exponent) {
return Math.pow(base, exponent);
}, {multiValued:!0, default:1}), imul:$.extend(function(a, b) {
return Math.imul(a, b);
}, {multiValued:!0, default:1}), count:$.extend(function(array) {
return Mavo.toArray(array).filter(function(a) {
return !empty(a);
}).length;
}, {isAggregate:!0}), reverse:function(array) {
return Mavo.toArray(array).slice().reverse();
}, round:$.extend(function(num, decimals) {
var _Mathround=Math.round;return not(num)||not(decimals)||!isFinite(num)?_Mathround(num):+(+num).toLocaleString("en-US", {useGrouping:!1, maximumFractionDigits:decimals});
}, {multiValued:!0, rightUnary:function(b) {
return b;
}, default:0}), ordinal:$.extend(function(num) {
if (empty(num)) {
return "";
} if (10>num||20<num) {
var ord=["th", "st", "nd", "rd", "th"][num%10];
} return ord||"th";
}, {multiValued:!0, alias:"th"}), digits:$.extend(function(digits, decimals, num) {
if (void 0===num&&(num=decimals, decimals=void 0), isNaN(num)) {
return null;
} var parts=(num+"").split(".");return parts[0]=parts[0].slice(-digits), void 0!==decimals&&parts[1]&&(parts[1]=parts[1].slice(0, decimals)), num=+parts.join("."), num.toLocaleString("en", {useGrouping:!1, minimumIntegerDigits:digits, minimumFractionDigits:decimals, maximumFractionDigits:decimals||20});
}, {multiValued:!0}), iff:function(condition) {
var iftrue=1<arguments.length&&arguments[1]!==void 0?arguments[1]:condition, iffalse=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;return Array.isArray(condition)?condition.map(function(c, i) {
var ret=val(c)?iftrue:iffalse;return Array.isArray(ret)?ret[_Mathmin3(i, ret.length-1)]:ret;
}):val(condition)?iftrue:iffalse;
}, group:function() {
return Object.assign.apply(Object, arguments);
}, list:function() {
for (var _len6=arguments.length, items=Array(_len6), _key6=0;_key6<_len6;_key6++) {
items[_key6]=arguments[_key6];
} return Mavo.flatten(items);
}, random:$.extend(function() {
var min=0<arguments.length&&arguments[0]!==void 0?arguments[0]:0, max=1<arguments.length&&arguments[1]!==void 0?arguments[1]:100, step=2<arguments.length&&arguments[2]!==void 0?arguments[2]:1;1==_arguments.length&&(max=min, min=0);var rand=Math.random(), range=(max-min)/step;return _Mathfloor(rand*(range+1))*step+min;
}, {multiValued:!0}), range:function(a, b, step) {
step===void 0&&(b===void 0&&(b=a, a=0<=b?1:-1), step=a<=b?1:-1);var steps=_Mathfloor((b-a)/step+1);if (0>=steps||!isFinite(steps)) {
return [a];
} for (var ret=[], i=0, n=a;i++<steps;n+=step) {
ret.push(n);
} return ret;
}, shuffle:function(list) {
if (Array.isArray(list)) {
for (var ret=list.slice(), i=ret.length-1;0<i;i--) {
var j=_Mathfloor(Math.random()*(i+1)), _ref10=[ret[j], ret[i]];ret[i]=_ref10[0], ret[j]=_ref10[1];
} return ret;
} return list;
}, replace:$.extend(function(haystack, needle) {
var replacement=2<arguments.length&&arguments[2]!==void 0?arguments[2]:"", iterations=3<arguments.length&&arguments[3]!==void 0?arguments[3]:1;if (Array.isArray(haystack)) {
return haystack.map(function(item) {
return _.replace(item, needle, replacement);
});
} for (var needleRegex=RegExp(Mavo.escapeRegExp(needle), "g"), ret=haystack, counter=0, prev;ret!=prev&&counter++<iterations;) {
prev=ret, ret=ret.replace(needleRegex, replacement);
} return ret;
}, {multiValued:!0}), len:$.extend(function(text) {
return str(text).length;
}, {multiValued:!0}), contains:$.extend(function(haystack, needle) {
var haystackType=$.type(haystack), ret;if ("object"===$.type(needle)) {
return 0<=JSON.stringify(haystack).indexOf(JSON.stringify(needle));
} if ("object"===haystackType||"array"===haystackType) {
for (var property in haystack) {
if (ret=_.contains(haystack[property], needle), Array.isArray(ret)&&(ret=Mavo.Functions.or(ret)), ret) {
return !0;
}
}
}
else {
return 0<=_.search(haystack, needle);
} return ret;
}, {multiValued:!0}), search:$.extend(function(haystack, needle) {
return haystack=str(haystack), needle=str(needle), haystack&&needle?haystack.toLowerCase().indexOf(needle.toLowerCase()):-1;
}, {multiValued:!0}), starts:$.extend(function(haystack, needle) {
return 0===_.search(str(haystack), str(needle));
}, {multiValued:!0}), ends:$.extend(function(haystack, needle) {
var _ref11=[str(haystack), str(needle)];haystack=_ref11[0], needle=_ref11[1];var i=_.search(haystack, needle);return -1<i&&i===haystack.length-needle.length;
}, {multiValued:!0}), join:function(array, glue) {
return Mavo.toArray(array).filter(function(a) {
return !empty(a);
}).join(str(glue));
}, idify:$.extend(function(readable) {
return str(readable).normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^\w\s-]/g, "").trim().replace(/\s+/g, "-").toLowerCase();
}, {multiValued:!0}), readable:$.extend(function(identifier) {
return str(identifier).replace(/([a-z])([A-Z])(?=[a-z])/g, function($0, $1, $2) {
return $1+" "+$2.toLowerCase();
}).replace(/([a-z0-9])[_\/-](?=[a-z0-9])/g, "$1 ").replace(/^[a-z]/, function($0) {
return $0.toUpperCase();
});
}, {multiValued:!0}), uppercase:$.extend(function(text) {
return str(text).toUpperCase();
}, {multiValued:!0}), lowercase:$.extend(function(text) {
return str(text).toLowerCase();
}, {multiValued:!0}), from:$.extend(function(haystack, needle) {
return _.between(haystack, needle);
}, {multiValued:!0}), fromlast:$.extend(function(haystack, needle) {
return _.between(haystack, needle, "", !0);
}, {multiValued:!0}), to:$.extend(function(haystack, needle) {
return _.between(haystack, "", needle);
}, {multiValued:!0}), tofirst:$.extend(function(haystack, needle) {
return _.between(haystack, "", needle, !0);
}, {multiValued:!0}), between:$.extend(function(haystack, from, to, tight) {
var _ref12=[str(haystack), str(from), str(to)];haystack=_ref12[0], from=_ref12[1], to=_ref12[2];var i1=from?haystack[tight?"lastIndexOf":"indexOf"](from):-1, i2=haystack[tight?"indexOf":"lastIndexOf"](to);return from&&-1===i1||-1===i2?"":haystack.slice(i1+1, -1!==i2&&to?i2:haystack.length);
}, {multiValued:!0}), phrase:$.extend(function($this, id, vars, lang) {
if (3===arguments.length&&"string"===$.type(vars)) {
var _ref13=[vars];lang=_ref13[0], vars=_ref13[1];
} var locale=lang?Mavo.Locale.get(lang):$this&&$this[Mavo.mavo]?$this[Mavo.mavo].locale:Mavo.Locale["default"];return locale.phrase(id, vars);
}, {needsContext:!0}), filename:$.extend(function(url) {
return Mavo.match(new URL(str(url), Mavo.base).pathname, /[^/]+?$/);
}, {multiValued:!0}), json:function(data) {
return Mavo.safeToJSON(data);
}, split:$.extend(function(text) {
var separator=1<arguments.length&&void 0!==arguments[1]?arguments[1]:/\s+/;return text=str(text), text.split(separator);
}, {multiValued:!0}), log:function() {
for (var _len7=arguments.length, args=Array(_len7), _key7=0, _console2;_key7<_len7;_key7++) {
args[_key7]=arguments[_key7];
} return (_console2=console).log.apply(_console2, _toConsumableArray(args.map(val))), args[0];
}, $mouse:{x:0, y:0}, get $hash() {
return location.hash.slice(1);
}, get $alt() {
return !!_.$evt&&_.$evt.altKey;
}, get $ctrl() {
return !!_.$evt&&_.$evt.ctrlKey;
}, get $shift() {
return !!_.$evt&&_.$evt.shiftKey;
}, get $cmd() {
return !!_.$evt&&_.$evt[Mavo.superKey];
}, util:{numbers:function(array, args) {
return array=Array.isArray(array)?array:args?$$(args):[array], array.filter(function(number) {
return !isNaN(number)&&""!==val(number)&&null!==val(number);
}).map(function(n) {
return +n;
});
}, postProcess:function(callback) {
var multiValued=callback.multiValued, _newCallback;if (!0===multiValued||multiValued&&2===multiValued.length?_newCallback=function() {
for (var _len8=arguments.length, args=Array(_len8), _key8=0;_key8<_len8;_key8++) {
args[_key8]=arguments[_key8];
} var idxA=multiValued[0]||0, idxB=multiValued[1]||1;return Mavo.Script.binaryOperation(args[idxA], args[idxB], _objectSpread({scalar:function(a, b) {
return idxA in args&&(args[idxA]=a), idxB in args&&(args[idxB]=b), callback.apply(void 0, args);
}}, callback));
}:callback.isAggregate&&(_newCallback=function(array) {
if (Mavo["in"](Mavo.groupedBy, array)) {
return array.map(function(e) {
return _newCallback(e.$items);
});
} var ret=callback.call.apply(callback, [this].concat(Array.prototype.slice.call(arguments)));return void 0===ret?array:ret;
}), _newCallback&&($.extend(_newCallback, callback), _newCallback.original=callback), callback.alias) {
var _iterator=_createForOfIteratorHelper(Mavo.toArray(callback.alias)), _step;try {
for (_iterator.s();!(_step=_iterator.n()).done;) {
var alias=_step.value;Mavo.Functions[alias]=_newCallback||callback;
}
}
catch (err) {
_iterator.e(err);
}
finally {
_iterator.f();
}
} return _newCallback;
}}}, $u=_.util;Mavo.ready.then(function() {
Object.getOwnPropertyNames(Mavo.Functions).forEach(function(property) {
var newCallback=$u.postProcess(Mavo.Functions[property]);newCallback&&(Mavo.Functions[property]=newCallback);
}), Object.getOwnPropertyNames(Math).forEach(function(property) {
1!==Math[property].length||Mavo.Functions.hasOwnProperty(property)||(Mavo.Functions[property]=function(operand) {
return Mavo.Script.unaryOperation(operand, function(operand) {
return Math[property](operand);
});
});
});
});
}(Bliss, Mavo.value), function($, val, _) {
var $u=3<arguments.length&&arguments[3]!==void 0?arguments[3]:_.util, s={seconds:1, minutes:60};s.hours=60*s.minutes, s.days=24*s.hours, s.weeks=7*s.days, s.months=30.4368*s.days, s.years=52*s.weeks;var numeric={year:function(d) {
return d.getFullYear();
}, month:function(d) {
return d.getMonth()+1;
}, day:function(d) {
return d.getDate();
}, weekday:function(d) {
return d.getDay()||7;
}, hour:function(d) {
return d.getHours();
}, minute:function(d) {
return d.getMinutes();
}, second:function(d) {
return d.getSeconds();
}, ms:function(d) {
return d.getMilliseconds();
}};$.extend(_, {get $now() {
return new Date;
}, $startup:new Date, get $today() {
return _.date(new Date);
}, year:$.extend(function() {
return $u.dateComponent.apply($u, ["year"].concat(Array.prototype.slice.call(arguments)));
}, {multiValued:!0}), month:$.extend(function() {
return $u.dateComponent.apply($u, ["month"].concat(Array.prototype.slice.call(arguments)));
}, {multiValued:!0}), week:function() {
return 1e3*s.weeks;
}, day:$.extend(function() {
return $u.dateComponent.apply($u, ["day"].concat(Array.prototype.slice.call(arguments)));
}, {multiValued:!0}), weekday:$.extend(function() {
return $u.dateComponent.apply($u, ["weekday"].concat(Array.prototype.slice.call(arguments)));
}, {multiValued:!0}), hour:$.extend(function() {
return $u.dateComponent.apply($u, ["hour"].concat(Array.prototype.slice.call(arguments)));
}, {multiValued:!0}), minute:$.extend(function() {
return $u.dateComponent.apply($u, ["minute"].concat(Array.prototype.slice.call(arguments)));
}, {multiValued:!0}), second:$.extend(function() {
return $u.dateComponent.apply($u, ["second"].concat(Array.prototype.slice.call(arguments)));
}, {multiValued:!0}), ms:$.extend(function() {
return $u.dateComponent.apply($u, ["ms"].concat(Array.prototype.slice.call(arguments)));
}, {multiValued:!0}), date:$.extend(function(date) {
return date=$u.date(date), date?"".concat(_.year(date), "-").concat(_.month(date, "00"), "-").concat(_.day(date, "00")):"";
}, {multiValued:!0}), time:$.extend(function(date) {
var precision=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"seconds";if (date=$u.date(date), !date) {
return "";
} var ret="".concat(_.hour(date, "00"), ":").concat("hours"==precision?"00":_.minute(date, "00"));return ("seconds"==precision||"ms"==precision)&&(ret+=":".concat(_.second(date, "00")), "ms"==precision&&(ret+=".".concat(_.ms(date)))), ret;
}, {multiValued:!0}), localTimezone:-new Date().getTimezoneOffset()}), _.msTo=function(what, ms) {
return Math.floor(Math.abs(ms)/(1e3*s[what]))||0;
};var _loop2=function(unit) {
_[unit]=$.extend(function(ms) {
return 0===arguments.length?1e3*s[unit]:_.msTo(unit, ms);
}, {multiValued:!0});
};for (var unit in s) {
_loop2(unit);
}_.duration=$.extend(function($this, ms) {
if (1===arguments.length) {
var _ref14=[$this, null];ms=_ref14[0], $this=_ref14[1];
} var count=ms||0, unit="ms";for (var nextUnit in s) {
var nextCount=_.msTo(nextUnit, ms);if (0===nextCount) {
break;
}count=nextCount, unit=nextUnit;
} return unit=1===count&&"ms"!==unit?unit.slice(0, -1):unit, count+" "+_.phrase($this, unit);
}, {needsContext:!0}), $.extend(_.util, {fixDateString:function(date) {
date=date.trim();var hasDate=/^\d{4}-\d{2}(-\d{2})?/.test(date), hasTime=-1<date.indexOf(":");return hasDate||hasTime?(date=hasDate?date.replace(/^(\d{4}-\d{2})(?!-\d{2})/, "$1-01"):_.$today+" "+date, hasTime?date=date.replace(/\-(\d{2})\s+(?=\d{2}:)/, "-$1T"):date+="T00:00:00", date=date.replace(/\s+/g, ""), date):null;
}, dateComponent:function(component, date, format) {
if (1===arguments.length&&component+"s"in s) {
return _[component+"s"]();
} var dateO=$u.date(date);if ("year"===component) {
date=date&&date.match?date:date+"";var ret=dateO?dateO.getFullYear()+"":(date.match(/\b[1-9]\d\d\b|\d+/)||[])[0];
} if (!ret&&!dateO) {
return "";
} var ret=ret||numeric[component](dateO);return format?/^0+$/.test(format)?(ret+"").padStart(format.length, "0").slice(-format.length):(format={name:"long", shortname:"short"}[format]||format, ret=dateO.toLocaleString(Mavo.locale, _defineProperty({}, component, format)), ret=ret.replace(/\u200e/g, ""), ret):"year"===component?ret:+ret;
}, date:function(_date) {
if (_date=val(_date), !_date) {
return null;
} var object=new Date(_date);if ("string"!==$.type(_date)||!isNaN(object)&&object+""==_date) {
return object;
} if (_date=$u.fixDateString(_date), null===_date) {
return null;
} var timezone=Mavo.match(_date, /[+-]\d{2}:?\d{2}|Z$/);if (timezone) {
_date=new Date(_date);
}
else {
var fields=_date.match(/\d+/g);_date=new Date(fields[0], (fields[1]||1)-1, fields[2]||1, fields[3]||0, fields[4]||0, fields[5]||0, fields[6]||0);
} return isNaN(_date)?null:_date;
}});
}(Bliss, Mavo.value, Mavo.Functions), function($, val, $u) {
var _Mathmax3=Math.max, _=Mavo.Script={$fn:self.Proxy?new Proxy(_defineProperty({}, Symbol.unscopables, {undefined:!0}), {get:function(data, property) {
var propertyL=property.toLowerCase(), ret;return propertyL in Mavo.Actions.Functions&&(Mavo.Actions.running?ret=Mavo.Actions.Functions[propertyL]:ret=Mavo.Actions.nope), void 0===ret&&(propertyL in Mavo.Functions?ret=Mavo.Functions[propertyL]:ret=Math[property]||Math[propertyL]), ret;
}, has:function(data, property) {
var propertyL=property.toLowerCase();return propertyL in Mavo.Functions||propertyL in Mavo.Actions.Functions||property in Math||propertyL in Math;
}}):Mavo.Functions, addUnaryOperator:function(name, o) {
return o.symbol&&Mavo.toArray(o.symbol).forEach(function(symbol) {
_.unarySymbols[symbol]=name, jsep.addUnaryOp(symbol);
}), function(operand) {
return _.unaryOperation(operand, function(operand) {
return o.scalar(val(operand));
});
};
}, unaryOperation:function(operand, scalar) {
return Array.isArray(operand)?operand.map(scalar):scalar(operand);
}, binaryOperation:function(a, b) {
var o=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};o.scalar="function"==typeof o?o:o.scalar;var result;if (!Array.isArray(b)) {
result=Array.isArray(a)?a.map(function(n) {
return o.scalar(n, b);
}):o.scalar(a, b);
}
else if (Array.isArray(a)) {
result=[];for (var max=_Mathmax3(a.length, b.length), leftUnary=o.leftUnary||o.unary, rightUnary=o.rightUnary||o.unary, leftDefault=void 0===o.leftDefault?o["default"]:o.leftDefault, rightDefault=void 0===o.rightDefault?o["default"]:o.rightDefault, i=0;i<max;i++) {
result[i]=o.comparison&&(void 0===a[i]||void 0===b[i])?o["default"]:void 0===a[i]?rightUnary?rightUnary(b[i]):o.scalar(leftDefault, b[i]):void 0===b[i]?leftUnary?leftUnary(a[i]):o.scalar(a[i], rightDefault):o.scalar(a[i], b[i]);
}
}
else {
result=b.map(function(n) {
return o.scalar(a, n);
});
} return result;
}, addBinaryOperator:function(name, o) {
return o.symbol&&Mavo.toArray(o.symbol).forEach(function(symbol) {
_.symbols[symbol]=name, o.precedence&&jsep.addBinaryOp(symbol, o.precedence);
}), o["default"]=void 0===o["default"]?0:o["default"], o.code||function() {
for (var _len9=arguments.length, operands=Array(_len9), _key9=0;_key9<_len9;_key9++) {
operands[_key9]=arguments[_key9];
}1===operands.length&&Array.isArray(operands[0])&&(operands=_toConsumableArray(operands[0])), o.raw||(operands=operands.map(val));for (var prev=!!o.comparison||operands[0], i=1, result;i<operands.length;i++) {
var a=o.comparison?operands[i-1]:prev, b=operands[i];Array.isArray(b)&&"number"==typeof o["default"]&&(b=$u.numbers(b));var result=_.binaryOperation(a, b, o);prev=o.comparison?_.binaryOperation(prev, result, _.operators.and):result;
} return prev;
};
}, symbols:{}, unarySymbols:{}, getOperatorName:function(op, unary) {
return _[unary?"unarySymbols":"symbols"][op]||op;
}, isComparisonOperator:function(op) {
if (op) {
var operatorDefinition=_.operators[_.symbols[op]];return operatorDefinition&&operatorDefinition.comparison;
}
}, isStatic:function(node) {
if ("Identifier"===node.type) {
return !1;
} var _iterator2=_createForOfIteratorHelper(_.childProperties), _step2;try {
for (_iterator2.s();!(_step2=_iterator2.n()).done;) {
var property=_step2.value;if (node[property]&&"callee"!==property&&!_.isStatic(node[property])) {
return !1;
}
}
}
catch (err) {
_iterator2.e(err);
}
finally {
_iterator2.f();
} return !0;
}, operators:{not:{symbol:"!", scalar:function(a) {
return !val(a);
}}, multiply:{scalar:function(a, b) {
return a*b;
}, default:1, symbol:"*"}, divide:{scalar:function(a, b) {
return a/b;
}, rightUnary:function(b) {
return b;
}, default:1, symbol:"/"}, addition:{scalar:function(a, b) {
if (isNaN(a)||isNaN(b)) {
var dateA=$u.date(a), dateB=$u.date(b);if (dateA||dateB) {
return +dateA+ +dateB;
}
} return +a+ +b;
}, symbol:"+"}, plus:{scalar:function(a) {
return +a;
}, symbol:"+"}, subtract:{scalar:function(a, b) {
if (isNaN(a)||isNaN(b)) {
var dateA=$u.date(a), dateB=$u.date(b);if (dateA&&dateB) {
return dateA-dateB;
}
} return a-b;
}, symbol:"-"}, minus:{scalar:function(a) {
return -a;
}, symbol:"-"}, mod:{scalar:function(a, b) {
var ret=a%b;return ret+=0>ret?b:0, ret;
}, symbol:"mod", precedence:10}, lte:{comparison:!0, scalar:function(a, b) {
var _$getNumericalOperand=_.getNumericalOperands(a, b), _$getNumericalOperand2=_slicedToArray(_$getNumericalOperand, 2);return a=_$getNumericalOperand2[0], b=_$getNumericalOperand2[1], a<=b;
}, default:!1, symbol:"<="}, lt:{comparison:!0, scalar:function(a, b) {
var _$getNumericalOperand3=_.getNumericalOperands(a, b), _$getNumericalOperand4=_slicedToArray(_$getNumericalOperand3, 2);return a=_$getNumericalOperand4[0], b=_$getNumericalOperand4[1], a<b;
}, default:!1, symbol:"<"}, gte:{comparison:!0, scalar:function(a, b) {
var _$getNumericalOperand5=_.getNumericalOperands(a, b), _$getNumericalOperand6=_slicedToArray(_$getNumericalOperand5, 2);return a=_$getNumericalOperand6[0], b=_$getNumericalOperand6[1], a>=b;
}, default:!1, symbol:">="}, gt:{comparison:!0, scalar:function(a, b) {
var _$getNumericalOperand7=_.getNumericalOperands(a, b), _$getNumericalOperand8=_slicedToArray(_$getNumericalOperand7, 2);return a=_$getNumericalOperand8[0], b=_$getNumericalOperand8[1], a>b;
}, default:!1, symbol:">"}, eq:{comparison:!0, scalar:function(a, b) {
return a==b||Mavo.safeToJSON(a)===Mavo.safeToJSON(b);
}, symbol:["=", "=="], default:!1, precedence:7}, neq:{comparison:!0, scalar:function(a, b) {
return a!=b&&Mavo.safeToJSON(a)!==Mavo.safeToJSON(b);
}, symbol:["!="], default:!0, precedence:7}, and:{scalar:function(a, b) {
return a&&b;
}, default:!1, symbol:["&&", "and"], precedence:2}, or:{scalar:function(a, b) {
return a||b;
}, default:!1, symbol:["||", "or"], precedence:2}, concatenate:{symbol:"&", default:"", scalar:function(a, b) {
return ""+(a||"")+(b||"");
}, precedence:10}, keyvalue:{symbol:":", code:function() {
for (var i=arguments.length-1, value=0>i||arguments.length<=i?void 0:arguments[i];i--;) {
value=_defineProperty({}, 0>i||arguments.length<=i?void 0:arguments[i], value);
} return value;
}, transformation:function(node) {
"Identifier"==node.left.type&&(node.left={type:"Literal", value:node.left.name, raw:JSON.stringify(node.left.name)});
}, precedence:4}, filter:{symbol:"where", code:function(a) {
for (var _len10=arguments.length, filters=Array(1<_len10?_len10-1:0), _key10=1;_key10<_len10;_key10++) {
filters[_key10-1]=arguments[_key10];
} for (var _loop3=function() {
var b=_filters[_i4];Array.isArray(a)?Array.isArray(b)?a=a.map(function(v, i) {
return val(b[i])?v:null;
}):(b=val(b), a="boolean"==typeof b?b?a:a.map(function() {
return null;
}):a.map(function(v) {
return v==b?v:null;
})):a=val(b)?a:null;
}, _i4=0, _filters=filters;_i4<_filters.length;_i4++) {
_loop3();
} return a;
}, precedence:1, postFlattenTransformation:function(node) {
for (var object=node.arguments[0], i=1;i<node.arguments.length;i++) {
_.isStatic(node.arguments[i])||(node.arguments[i]=Object.assign(_.parse("scope()"), {arguments:[object, node.arguments[i]]}));
}
}}, range:{symbol:"..", scalar:function(a, b) {
return Mavo.Functions.range(a, b);
}, precedence:2, export:!1}, has:{symbol:"in", code:function(needle) {
for (var _len11=arguments.length, haystacks=Array(1<_len11?_len11-1:0), _key11=1, ret;_key11<_len11;_key11++) {
haystacks[_key11-1]=arguments[_key11];
} return haystacks.map(function(b) {
if (Array.isArray(b)) {
var op=function(a) {
var fn="object"===$.type(val(a))?Mavo.safeToJSON:val;return -1<b.map(fn).indexOf(fn(a));
};
}
else if ("object"===$.type(b)) {
var op=function(a) {
return Mavo["in"](val(a), b);
};
}
else {
var op=function(a) {
return Mavo.Functions.eq(a, b);
};
} var result=Mavo.Script.unaryOperation(needle, op);ret=void 0===ret?result:Mavo.Functions.and(result, ret);
}), ret;
}, precedence:3}, groupby:{symbol:"by", code:function(array, key) {
array=Mavo.toArray(array), key=Mavo.toArray(key);var property=key[Mavo.as]||$.value(key[0], Mavo.toNode, "property"), groups=new Mavo.BucketMap({arrays:!0}), ret=[];return ret[Mavo.groupedBy]=!0, array.forEach(function(item, i) {
var k=i<key.length?Mavo.value(key[i]):null;groups.set(k, item);
}), Mavo["in"](Mavo.route, array)&&(ret[Mavo.route]=Object.assign({}, array[Mavo.route])), groups.forEach(function(items, value) {
var obj=(_obj={$value:value}, _defineProperty(_obj, property||"$value", value), _defineProperty(_obj, "$items", items), _obj), _obj;Mavo["in"](Mavo.route, array)&&(items[Mavo.route]=obj[Mavo.route]=Object.assign({}, array[Mavo.route]), obj[Mavo.route]=$.each(items[Mavo.route], function() {
return new Set(["$items"]);
})), ret.push(obj);
}), Mavo.Data.proxify(ret);
}, precedence:2}, as:{symbol:"as", code:function(property, name) {
if (void 0!==property&&"array"===$.type(property)&&void 0!==name) {
var ret=property.slice();return Array.isArray(name)||void 0===$.value(name, Mavo.toNode, "property")?"string"===$.type(name)?(ret[Mavo.as]=name, ret):void 0===$.value(name[0], Mavo.toNode, "property")?property:(ret[Mavo.as]=$.value(name[0], Mavo.toNode, "property"), ret):(ret[Mavo.as]=$.value(name, Mavo.toNode, "property"), ret);
} return property;
}, precedence:3}}, getNumericalOperands:function(a, b) {
if (isNaN(a)||isNaN(b)) {
var da=$u.date(a), db=$u.date(b);if (da&&db) {
return [da, db];
}
} return [a, b];
}, childProperties:["arguments", "argument", "callee", "left", "right", "elements", "test", "consequent", "alternate", "object", "body"], walk:function(node, callback) {
var o=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{}, property=3<arguments.length?arguments[3]:void 0, parent=4<arguments.length?arguments[4]:void 0;if (!o.type||node.type===o.type) {
var ret=callback(node, property, parent);
} return o.ignore&&-1!==o.ignore.indexOf(node.type)||_.childProperties.forEach(function(property) {
node[property]&&_.walk(node[property], callback, o, property, node);
}), void 0!==ret&&parent&&(parent[property]=ret), ret;
}, serializers:{BinaryExpression:function(node) {
return "".concat(_.serialize(node.left), " ").concat(node.operator, " ").concat(_.serialize(node.right));
}, UnaryExpression:function(node) {
return "".concat(node.operator).concat(_.serialize(node.argument));
}, CallExpression:function(node) {
var nameSerialized=_.serialize(node.callee), argsSerialized=node.arguments.map(_.serialize);if ("Identifier"==node.callee.type) {
var name=node.callee.name;if ("scope"===name) {
return _.serializeScopeCall(node.arguments);
} if (name in Mavo.Script.$fn) {
return "$fn.".concat(name, "(").concat(argsSerialized.join(", "), ")");
}
} return "".concat(nameSerialized, "(").concat(argsSerialized.join(", "), ")");
}, ConditionalExpression:function(node) {
return "".concat(_.serialize(node.test), "? ").concat(_.serialize(node.consequent), " : ").concat(_.serialize(node.alternate));
}, MemberExpression:function(node) {
if ("Identifier"===node.object.type&&"$fn"===node.object.name) {
var property=node.computed?"[".concat(_.serialize(node.property), "]"):".".concat(node.property.name);return "$fn".concat(property);
} var property=node.computed?_.serialize(node.property):"\"".concat(node.property.name, "\"");return "$fn.get(".concat(_.serialize(node.object), ", ").concat(property, ")");
}, ArrayExpression:function(node) {
return "[".concat(node.elements.map(_.serialize).join(", "), "]");
}, Literal:function(node) {
return node.raw.replace(/\r/g, "\\r").replace(/\n/g, "\\n");
}, Identifier:function(node) {
return node.name;
}, ThisExpression:function() {
return "this";
}, Compound:function(node) {
return node.body.map(_.serialize).join(", ");
}}, transformations:{BinaryExpression:function(node) {
var name=_.getOperatorName(node.operator), def=_.operators[name];def.transformation&&def.transformation(node);var nodeLeft=node, ret={type:"CallExpression", arguments:[], callee:{type:"Identifier", name:name}};if (def.comparison) {
var comparisonOperands=[];do {
var operatorName=_.getOperatorName(nodeLeft.operator);comparisonOperands.unshift({comparison:operatorName, operand:nodeLeft.right}), nodeLeft=nodeLeft.left;
} while (!1!==def.flatten&&_.isComparisonOperator(nodeLeft.operator));for (var comparisonsHeterogeneous=!1, i=0;i<comparisonOperands.length-1;i++) {
if (comparisonOperands[i].comparison!=comparisonOperands[i+1].comparison) {
comparisonsHeterogeneous=!0;break;
}
}ret.arguments.push(nodeLeft), comparisonsHeterogeneous?(ret.callee.name="compare", comparisonOperands.forEach(function(co) {
ret.arguments.push({type:"Literal", value:co.comparison, raw:"\"".concat(co.comparison, "\"")}), ret.arguments.push(co.operand);
})):comparisonOperands.forEach(function(co) {
ret.arguments.push(co.operand);
});
}
else {
do {
ret.arguments.unshift(nodeLeft.right), nodeLeft=nodeLeft.left;
} while (!1!==def.flatten&&_.getOperatorName(nodeLeft.operator)===name);ret.arguments.unshift(nodeLeft);
} return def.postFlattenTransformation&&def.postFlattenTransformation(ret), ret;
}, UnaryExpression:function(node) {
var name=_.getOperatorName(node.operator, !0);if (name) {
return {type:"CallExpression", arguments:[node.argument], callee:{type:"Identifier", name:name}};
}
}, CallExpression:function(node) {
if ("Identifier"==node.callee.type) {
if ("if"==node.callee.name) {
node.callee.name="iff";for (var condition=node.arguments[0], i=1;i<node.arguments.length;i++) {
2==i&&(condition=_.parse("not()"), condition.arguments.push(node.arguments[0])), _.walk(node.arguments[i], function(n) {
var name=n.callee.name;Mavo.Actions.Functions.hasOwnProperty(name)&&!/if$/.test(name)&&(n.callee.name+="if", n.arguments.unshift(condition));
}, {type:"CallExpression"});
}
}
else if ("delete"==node.callee.name) {
node.callee.name="clear";
}
else {
var def=Mavo.Functions[node.callee.name];def&&def.needsContext&&node.arguments.unshift({type:"Identifier", name:"$this"});
}
}
}, ThisExpression:function() {
return {type:"Identifier", name:"$this"};
}}, serialize:function(node) {
if ("string"==typeof node) {
return node;
} var ret=_.transformations[node.type]&&_.transformations[node.type](node);if ("object"==_typeof(ret)&&ret&&ret.type) {
node=ret;
}
else if (void 0!==ret) {
return ret;
} return _.serializers[node.type](node);
}, rewrite:function(code) {
try {
return _.serialize(_.parse(code));
}
catch (e) {
return code;
}
}, compile:function(code) {
var o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return /\S/.test(code)?(code=_.rewrite(code), code="with (Mavo.Data.stub)\n\twith (data || {}) {\n\t\treturn (".concat(code, ");\n\t}"), o.actions&&(code="\nMavo.Actions._running = Mavo.Actions.running;\nMavo.Actions.running = true;\n".concat(code, "\nMavo.Actions.running = Mavo.Actions._running;")), new Function("data", code)):function() {
return "";
};
}, parse:self.jsep, serializeScopeCall:function(args) {
var withCode="with (Mavo.Script.subScope(scope, $this) || {}) { return (".concat(_.serialize(args[1]), "); }");return "(function() {\n\tvar scope = ".concat(_.serialize(args[0]), ";\n\tif (Array.isArray(scope)) {\n\t\treturn scope.map(function(scope) {\n\t\t\t").concat(withCode, "\n\t\t});\n\t}\n\n\t").concat(withCode, "\n})()");
}, subScope:function(proxy, $this) {
var unscopables=Object.keys($this).reduce(function(o, k) {
return o[k]=!0, o;
}, {$this:!0});return proxy&&"object"===_typeof(proxy)?new Proxy(proxy, {get:function(t, property, r) {
return property===Symbol.unscopables?unscopables:Reflect.get(t, property, r);
}}):proxy;
}};for (var name in _.serializers.LogicalExpression=_.serializers.BinaryExpression, _.transformations.LogicalExpression=_.transformations.BinaryExpression, _.operators) {
var details=_.operators[name];if (details.scalar&&2>details.scalar.length) {
var ret=_.addUnaryOperator(name, details);
}
else {
var ret=_.addBinaryOperator(name, details);
}details.code=details.code||ret, ret&&!1!==details["export"]&&(Mavo.Functions[name]=ret);
}Mavo.Functions.compare=function() {
for (var result=!0, i=2;i<arguments.length;i+=2) {
var a=0>i-2||arguments.length<=i-2?void 0:arguments[i-2], op=0>i-1||arguments.length<=i-1?void 0:arguments[i-1], b=0>i||arguments.length<=i?void 0:arguments[i], term=_.binaryOperation(a, b, Mavo.Script.operators[op]);result=_.binaryOperation(result, term, Mavo.Script.operators.and);
} return result;
};
}(Bliss, Mavo.value, Mavo.Functions.util), function($) {
Mavo.attributes.push("mv-action");var _=Mavo.Actions={listener:function(evt) {
var tag="submit"===evt.type?"form":":not(form)", element=evt.target.closest(tag+"[mv-action]");if (element) {
var node=Mavo.Node.get(element);node&&node.editing||("submit"===evt.type&&evt.preventDefault(), element&&_.run(element.getAttribute("mv-action"), element, evt));
}
}, run:function(code, element, evt) {
if (code) {
var node=Mavo.Node.getClosest(element);if (node) {
var expression=new Mavo.Expression(code), previousEvt=Mavo.Functions.$evt;Mavo.Functions.$evt=evt;var ret=expression.eval(node.getLiveData(), {actions:!0});return Mavo.Functions.$evt=previousEvt, ret;
}
}
}, getNodes:function(ref) {
var node=_.getNode(ref);return node?[node]:Mavo.toArray(ref).map(function(n) {
return _.getNode(n);
}).filter(function(n) {
return n!==void 0;
});
}, getNode:function(node) {
if (node instanceof Mavo.Node) {
return node;
} return node&&node[Mavo.toNode]?node[Mavo.toNode]:void 0;
}, getCollection:function(ref) {
var collection=_.getNode(ref);return collection instanceof Mavo.Collection?collection:collection?collection.collection:null;
}, nope:function() {
var actions=Object.keys(_.Functions).map(function(name) {
return "".concat(name, "()");
});Mavo.warn("Mavo actions (".concat(actions, ") can only be used in the mv-action attribute."));
}, Functions:{add:function(data, ref, index) {
if (3>arguments.length) {
if (1>=arguments.length) {
var _ref15=[void 0, data];data=_ref15[0], ref=_ref15[1];
}
else if (2===arguments.length) {
var collection=_.getCollection(ref);if (!collection&&(collection=_.getCollection(data), collection)) {
var _ref16=[void 0, data, ref];data=_ref16[0], ref=_ref16[1], index=_ref16[2];
}
}
} if (ref) {
if (collection=collection||_.getCollection(ref), !collection) {
return Mavo.warn("No collection or collection item provided to add().", {once:!1}), data;
} if (void 0===index) {
var node=_.getNode(ref);node!==collection&&(index=node.index);
} return (Array.isArray(data)?data:[data]).map(function(datum) {
var item=collection.add(void 0, index);return void 0!==datum&&item.render(datum), collection.editing&&collection.editItem(item), item.getLiveData();
});
}
}, move:function(from, to, index) {
if (from&&void 0!==to) {
if ("number"==$.type(to)&&!toNode) {
var _ref17=[to];index=_ref17[0], to=_ref17[1];
} var toNode=_.getNode(to), fromNodes=Mavo.toArray(from).map(_.getNode).filter(function(n) {
return n&&n.closestCollection;
}), collection=(toNode||fromNodes[0]).closestCollection;if (!fromNodes.length) {
return collection?(Mavo.warn("First parameter of move() was not a collection or collection item, using add() instead.", {once:!1}), _.Functions.add(from, collection, index)):(Mavo.warn("You need to provide at least one collection or collection item for move() to have something to do.", {once:!1}), from);
} var ret=_.Functions.add(from, collection, index);return Mavo.Collection["delete"](fromNodes, {silent:!0}), ret;
}
}, clear:function() {
for (var _len12=arguments.length, ref=Array(_len12), _key12=0;_key12<_len12;_key12++) {
ref[_key12]=arguments[_key12];
} if (ref.length&&ref[0]) {
var nodes=_.getNodes(Mavo.flatten(ref)), itemsToDelete=[];return nodes.forEach(function(node) {
node&&(node instanceof Mavo.Collection?itemsToDelete.push.apply(itemsToDelete, _toConsumableArray(node.children)):node.collection?itemsToDelete.push(node):node.walk(function(n) {
n instanceof Mavo.Primitive?n.value=null:n!==node&&_.clear(n);
}));
}), Mavo.Collection["delete"](itemsToDelete), nodes.map(function(n) {
return n.getLiveData();
});
}
}, clearif:function(condition) {
for (var _len13=arguments.length, targets=Array(1<_len13?_len13-1:0), _key13=1, _$Functions;_key13<_len13;_key13++) {
targets[_key13-1]=arguments[_key13];
} return targets=targets.map(function(t) {
return Mavo.Functions.iff(condition, t);
}), (_$Functions=_.Functions).clear.apply(_$Functions, _toConsumableArray(targets));
}, set:function(ref, values) {
if (ref) {
var node=_.getNode(ref);if (node) {
node.render(values);
}
else {
var wasArray=Array.isArray(ref), nodes=_.getNodes(ref);nodes.length?Mavo.Script.binaryOperation(wasArray?nodes:nodes[0], values, {scalar:function(node, value) {
return node?node.render(value):null;
}}):Mavo.warn("The first parameter of set() needs to be one or more existing properties, ".concat(Mavo.safeToJSON(ref), " is not."));
} return values;
}
}}}, _loop4=function(name) {
var nameif=name+"if";nameif in _.Functions||(_.Functions[nameif]=function(condition, target) {
var _$Functions2;target=Mavo.Functions.iff(condition, target);for (var _len14=arguments.length, rest=Array(2<_len14?_len14-2:0), _key14=2;_key14<_len14;_key14++) {
rest[_key14-2]=arguments[_key14];
} return Mavo.value(condition)?(_$Functions2=_.Functions)[name].apply(_$Functions2, [target].concat(rest)):null;
});
};for (var name in _.Functions) {
_loop4(name);
}_.Functions.deleteif=_.Functions.clearif;
}(Bliss, Bliss.$), function($) {
var _=Mavo.Data=$.Class(function() {
function Data(node, data) {
_classCallCheck(this, Data), this.node=node, void 0!==data&&(this.data=data);
} return _createClass(Data, [{key:"proxify", value:function() {
return _.proxify(this.data);
}}, {key:"update", value:function() {
if (this.node instanceof Mavo.Collection||this.node instanceof Mavo.ImplicitCollection) {
this.data.length=0;for (var i=0;i<this.node.children.length;i++) {
this.data[i]=this.node.children[i].liveData.data;
} this.node instanceof Mavo.ImplicitCollection&&(Mavo.filter(this.data, function(data) {
return null!==Mavo.value(data);
}), this.updateParent());
}
else if (this.node instanceof Mavo.Primitive) {
var value=this.node.value;this.node.isDataNull({live:!0})&&(value=null), this.data=Mavo.objectify(value), Mavo.isPlainObject(value)||Array.isArray(value)?_.computeRoutes(this.data):_.computeMetadata(this.data, this.key, this.parent), this.updateParent();
}
}}, {key:"updateParent", value:function() {
if (this.parent) {
if (this.node instanceof Mavo.ImplicitCollection) {
var data=1===this.data.length?this.data[0]:this.data;this.parent.set(this.node.property, data, !0);
}
else if (this.collection instanceof Mavo.ImplicitCollection) {
this.parent.update();
}
else {
var key=this.key, isDeleted=!1;this.collection instanceof Mavo.Collection&&(isDeleted=this.collection.children[this.node.index]!==this.node), void 0===key||isDeleted||this.parent.set(key, this.data, !0);
}
}
}}, {key:"set", value:function(property, value, shallow) {
this.data[property]=value, _["computeRoute"+(shallow?"":"s")](value, property, this.data);
}}, {key:"updateKey", value:function() {
var oldKey=this._key;this.parent[oldKey]===this.data&&delete this.parent[oldKey], this.updateParent();
}}, {key:"resolve", value:function(property) {
return _.resolve(property, this.data);
}}, {key:"parent", get:function() {
var parent=this.node.parent;return parent?parent.liveData:null;
}}, {key:"collection", get:function() {
return this.node.collection;
}}, {key:"key", get:function() {
return this._key=this.collection?this.node.index:this.node.property;
}}]), Data;
}(), {live:{data:function(_data2) {
if (_data2!==this._data) {
return this.isArray=Array.isArray(_data2), this._data=_data2, _data2[Mavo.toNode]=this.node, _data2[Mavo.parent]=this.parent&&this.parent.data, _data2[Mavo.mavo]=this.node.mavo, this.proxy=this.proxify(), this.updateParent(), this._data;
}
}}, static:{stub:self.Proxy?new Proxy(_defineProperty({}, Symbol.unscopables, {data:!0, undefined:!0}), {get:function(data, property) {
var ret=Reflect.get(data, property);if (void 0!==ret||"string"!=typeof property) {
return ret;
} var propertyL=property.toLowerCase();if ("$fn"===property) {
return Mavo.Script.$fn;
} if ("$"===propertyL[0]&&propertyL in Mavo.Functions) {
return Mavo.Functions[propertyL];
} var propertyU=property.toUpperCase();if (propertyU in Math) {
return Math[propertyU];
} if ("undefined"!=typeof window&&window.hasOwnProperty(property)) {
return window[property];
} if ("$"!==property[0]) {
var $property="$"+property.toLowerCase();if ($property in Mavo.Functions) {
return Mavo.Functions[$property];
}
} return property;
}, has:function(data, property) {
return Reflect.has(data, property)||"string"==typeof property;
}}):Mavo.Functions, isItem:function(data) {
return Array.isArray($.value(data, Mavo.parent));
}, closest:function(obj, test) {
var path=[];do {
if (test(obj)) {
return {value:obj, path:path};
}path.push(obj[Mavo.property]);
} while (obj=obj[Mavo.parent]);return {value:null, path:path};
}, root:function(obj) {
return _.closest(obj, function(o) {
return !o[Mavo.parent];
});
}, closestItem:function(obj) {
return _.closest(obj, _.isItem);
}, closestArray:function(obj) {
return _.closest(obj, Array.isArray);
}, getProperty:function(data) {
var ret=_.isItem(data)?data[Mavo.parent]:data;return ret[Mavo.property];
}, find:function(property, data) {
var o=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};if (data&&o.exclude!==data) {
if (Mavo["in"](property, data)&&o.exclude!==data[property]) {
return data[property];
} if (!data[Mavo.route]||!Mavo["in"](property, data[Mavo.route])) {
if (data[Mavo.property]===property) {
return data;
} if (_.isItem(data)&&_.getProperty(data)===property) {
return data;
} if (Array.isArray(data)) {
var ret=data.map(function(a) {
return _.find(property, a);
}).filter(function(x) {
return void 0!==x;
});if (ret.length) {
return Mavo.flatten(ret);
}
} return;
} var results=[], returnArray=Array.isArray(data), ret;results[Mavo.route]={}, results[Mavo.mavo]=data[Mavo.mavo];var findDown=function(prop) {
var ret=_.find(property, data[prop], o);if (void 0!==ret) {
if (Mavo["in"](Mavo.route, ret)) {
for (var p in ret[Mavo.route]) {
results[Mavo.route][p]=!0;
}
}Array.isArray(ret)?(results.push.apply(results, _toConsumableArray(ret)), returnArray=!0):results.push(ret);
}
};if (Array.isArray(data)||!0===data[Mavo.route][property]) {
for (var prop in data) {
findDown(prop);
}
}
else {
data[Mavo.route][property].forEach(findDown);
} return returnArray||1<results.length?results:results[0];
}
}, findUp:function(property, data) {
var parent=data, child;do {
var ret=_.find(property, parent, {exclude:child});if (void 0!==ret) {
return ret;
} if (_.getProperty(parent)===property) {
return parent;
}child=parent, parent=parent[Mavo.parent];
} while (parent);
}, resolve:function(property, data) {
if (property===Mavo.isProxy) {
return !0;
} if ("symbol"===_typeof(property)) {
return data[property];
} var propertyIsNumeric=!isNaN(property), ret;if (property in data) {
ret=data[property];
}
else if (!propertyIsNumeric) {
if (property in _.special) {
ret=_.special[property](data);
}
else if (data[Mavo.mavo]) {
var all=data[Mavo.mavo].root.liveData.data[Mavo.route];Mavo["in"](property, all)&&(ret=_.findUp(property, data));
}
else {
Mavo["in"](Mavo.route, data)&&Mavo["in"](property, data[Mavo.route])&&(ret=_.find(property, data));
}
} if (!propertyIsNumeric) {
var propertyL=property.toLowerCase();
} if (void 0!==ret) {
var proxify=null!==ret&&"object"===_typeof(ret)&&(Mavo.route in ret||Mavo.toNode in ret);return proxify?_.proxify(ret):ret;
} if (!propertyIsNumeric) {
if (property in Mavo.all&&isNaN(property)&&Mavo.all[property].root) {
return Mavo.all[property].root.getLiveData();
} if ("$"!==property[0]) {
var $property="$"+propertyL;if ($property in _.special) {
return _.resolve($property, data);
}
}
}
}, has:function(property, data) {
if (property===Mavo.isProxy) {
return !0;
} if ("string"!=typeof property) {
return Reflect.has(data, property);
} var objects=[data, Mavo.all, _.special];if (objects.some(function(obj) {
return property in obj;
})) {
return !0;
} if ("string"==typeof property) {
var propertyL=property.toLowerCase();if (propertyL!==property&&objects.some(function(obj) {
return propertyL in obj;
})) {
return !0;
} if ("$"!==propertyL[0]&&"$"+propertyL in _.special) {
return !0;
}
} return data[Mavo.mavo]?Mavo["in"](property, data[Mavo.mavo].root.liveData.data[Mavo.route]):void 0;
}, proxify:function(data) {
return data&&"object"===_typeof(data)&&self.Proxy&&!data[Mavo.isProxy]?new Proxy(data, {get:function(data, property) {
return _.resolve(property, data);
}, has:function(data, property) {
return _.has(property, data);
}, set:function(data) {
var property=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"", value=2<arguments.length?arguments[2]:void 0;return "symbol"===_typeof(property)?Reflect.set(data, property, value):(Mavo.warn("You cannot set data via expressions. Attempt to set ".concat(property.toString(), " to ").concat(value, " ignored.")), value);
}}):data;
}, computeMetadata:function(object, property, parent) {
object&&"object"===_typeof(object)&&(void 0!==property&&(object[Mavo.property]=property), parent&&!object[Mavo.parent]&&(object[Mavo.parent]=parent));
}, computeRoute:function(object, property, parent) {
if ("function"!=typeof object&&(_.computeMetadata(object, property, parent), (Mavo.isPlainObject(object)===Object.prototype||Array.isArray(object))&&!object[Mavo.route]&&(object[Mavo.route]={}), "number"!==$.type(property))) {
for (var child=object;parent;) {
parent[Mavo.route]||(parent[Mavo.route]={});var up=child&&child[Mavo.property];if (up&&!0!==parent[Mavo.route][property]) {
if (parent[Mavo.route][property]||(parent[Mavo.route][property]=new Set), parent[Mavo.route][property].has(up)) {
break;
}parent[Mavo.route][property].add(up);
}
else {
parent[Mavo.route][property]=!0;
}child=parent, parent=parent[Mavo.parent];
}
}
}, computeRoutes:function(object, property, parent) {
_.traverse(_.computeRoute, object, property, parent);
}, traverseDown:function(callback, object) {
if (Array.isArray(object)) {
object.forEach(function(item, i) {
return _.traverse(callback, item, i, object);
});
}
else if ("object"===$.type(object)) {
for (var prop in object) {
_.traverse(callback, object[prop], prop, object);
}
}
}, traverse:function(callback, object, property, parent) {
callback(object, property, parent), _.traverseDown(callback, object, property, parent);
}, special:{$index:function(obj) {
var closestItem=_.closestItem(obj).value;if (!closestItem) {
return -1;
} var property=closestItem[Mavo.property];return isNaN(property)?closestItem[Mavo.parent].indexOf(closestItem):property;
}, $item:function(obj) {
return _.closestItem(obj).value;
}, $all:function(obj) {
var arr=_.closestArray(obj), path=arr.path.reverse().slice(1), ret=arr.value.map(function(a) {
return $.value.apply($, [a].concat(_toConsumableArray(path)));
});return 0<ret.length&&ret[0][Mavo.route]&&(ret[Mavo.route]=$.each(ret[0][Mavo.route], function() {
return !0;
}), ret[Mavo.mavo]=ret[0][Mavo.mavo]), ret;
}, $next:function(obj) {
var arr=_.closestArray(obj), path=arr.path.reverse(), index=arr.path[0];path=path.slice(1);var nextClosestItem=$.value(arr.value, index+1);return nextClosestItem?$.value.apply($, [nextClosestItem].concat(_toConsumableArray(path))):null;
}, $previous:function(obj) {
var arr=_.closestArray(obj), path=arr.path.reverse(), index=arr.path[0];path=path.slice(1);var prevClosestItem=$.value(arr.value, index-1);return prevClosestItem?$.value.apply($, [prevClosestItem].concat(_toConsumableArray(path))):null;
}, $this:function(obj) {
return obj;
}}}});
}(Bliss, Bliss.$), function($) {
var _=Mavo.Backend.register($.Class({extends:Mavo.Backend, id:"Dropbox", constructor:function() {
this.permissions.on(["login", "read"]), this.key=this.mavo.element.getAttribute("mv-dropbox-key")||"2mx6061p054bpbp", this.login(!0);
}, update:function(url, o) {
this["super"].update.call(this, url, o), this.url=_.fixShareURL(this.url);
}, upload:function(file, path) {
var _this73=this;return path=this.path.replace(/[^/]+$/, "")+path, this.put(file, path).then(function() {
return _this73.getURL(path);
});
}, getURL:function(path) {
return this.request("sharing/create_shared_link_with_settings", {path:path}, "POST").then(function(shareInfo) {
return _.fixShareURL(shareInfo.url);
});
}, put:function(serialized) {
var path=1<arguments.length&&arguments[1]!==void 0?arguments[1]:this.path, o=2<arguments.length&&arguments[2]!==void 0?arguments[2]:{};return this.request("https://content.dropboxapi.com/2/files/upload", serialized, "POST", {headers:{"Dropbox-API-Arg":JSON.stringify({path:path, mode:"overwrite"}), "Content-Type":"application/octet-stream"}});
}, oAuthParams:function() {
return "&redirect_uri=".concat(encodeURIComponent("https://auth.mavo.io"), "&response_type=code");
}, getUser:function() {
var _this74=this;return this.user?Promise.resolve(this.user):this.request("users/get_current_account", "null", "POST").then(function(info) {
_this74.user={username:info.email, name:info.name.display_name, avatar:info.profile_photo_url, info:info}, $.fire(_this74.mavo.element, "mv-login", {backend:_this74});
});
}, login:function(passive) {
var _this75=this;return this.oAuthenticate(passive).then(function() {
return _this75.getUser();
}).then(function() {
_this75.user&&(_this75.permissions.logout=!0, _this75.request("sharing/get_shared_link_metadata", {url:_this75.source}, "POST").then(function(info) {
_this75.path=info.path_lower, _this75.permissions.on(["edit", "save"]);
}));
});
}, logout:function() {
return this.oAuthLogout();
}, static:{apiDomain:"https://api.dropboxapi.com/2/", oAuth:"https://www.dropbox.com/oauth2/authorize", test:function(url) {
return url=new URL(url, Mavo.base), /dropbox.com/.test(url.host);
}, fixShareURL:function(url) {
return url=new URL(url, Mavo.base), url.hostname="dl.dropboxusercontent.com", url.search=url.search.replace(/\bdl=0|^$/, "raw=1"), url;
}}}));
}(Bliss, Bliss.$), function($) {
var _=Mavo.Backend.register($.Class({extends:Mavo.Backend, id:"Github", constructor:function() {
this.permissions.on(["login", "read"]), this.key=this.mavo.element.getAttribute("mv-github-key")||"7e08e016048000bc594e";var extension=this.format.constructor.extensions[0]||".json";this.defaults={repo:"mv-data", filename:"".concat(this.mavo.id).concat(extension)}, this.info=_.parseURL(this.source, this.defaults), $.extend(this, this.info), this.login(!0);
}, update:function(url, o) {
this["super"].update.call(this, url, o), this.info=_.parseURL(this.source, this.defaults), $.extend(this, this.info);
}, get:function(url) {
if (this.isAuthenticated()||!this.path||url) {
var info=url?_.parseURL(url):this.info;return info.apiData?this.request(info.apiCall, info.apiData, "POST").then(function(response) {
return response.errors&&response.errors.length?Promise.reject(response.errors.map(function(x) {
return x.message;
}).join("\n")):response.data;
}):this.request(info.apiCall, {ref:this.branch}, "GET", {headers:{Accept:"application/vnd.github.squirrel-girl-preview"}}).then(function(response) {
return Promise.resolve(info.repo?_.atob(response.content):response);
});
} return url=new URL("https://raw.githubusercontent.com/".concat(this.username, "/").concat(this.repo, "/").concat(this.branch||"master", "/").concat(this.path)), url.searchParams.set("timestamp", Date.now()), $.fetch(url.href).then(function(xhr) {
return Promise.resolve(xhr.responseText);
}, function() {
return Promise.resolve(null);
});
}, upload:function(file) {
var _this76=this, path=1<arguments.length&&arguments[1]!==void 0?arguments[1]:this.path;return Mavo.readFile(file).then(function(dataURL) {
var base64=dataURL.slice(5), media=base64.match(/^\w+\/[\w+]+/)[0];return base64=base64.replace(RegExp("^".concat(media, "(;base64)?,")), ""), path=_this76.path.replace(/[^/]+$/, "")+path, _this76.put(base64, path, {isEncoded:!0});
}).then(function(fileInfo) {
return _this76.getURL(path, fileInfo.commit.sha);
});
}, put:function(serialized) {
var _this77=this, path=1<arguments.length&&void 0!==arguments[1]?arguments[1]:this.path, o=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};if (path) {
var repoCall="repos/".concat(this.username, "/").concat(this.repo), fileCall="".concat(repoCall, "/contents/").concat(path), commitPrefix=this.mavo.element.getAttribute("mv-github-commit-prefix")||"", repoInfo=this.repoInfo?Promise.resolve(this.repoInfo):this.request("user/repos", {name:this.repo}, "POST").then(function(repoInfo) {
return _this77.repoInfo=repoInfo;
});return serialized=o.isEncoded?serialized:_.btoa(serialized), repoInfo.then(function(repoInfo) {
return _this77.canPush()?repoInfo:_this77.request("".concat(repoCall, "/forks"), {name:_this77.repo}, "POST").then(function(forkInfo) {
return fileCall="repos/".concat(forkInfo.full_name, "/contents/").concat(path), _this77.forkInfo=forkInfo;
}).then(function(forkInfo) {
var test=function test(resolve) {
clearTimeout(timeout), _this77.request("repos/".concat(forkInfo.full_name, "/commits"), {until:"1970-01-01T00:00:00Z"}, "HEAD").then(function() {
resolve(forkInfo);
})["catch"](function() {
timeout=setTimeout(test, 1e3);
});
}, timeout;return new Promise(test);
});
}).then(function() {
return _this77.request(fileCall, {ref:_this77.branch}).then(function(fileInfo) {
return _this77.request(fileCall, {message:commitPrefix+_this77.mavo._("gh-updated-file", {name:fileInfo.name||"file"}), content:serialized, branch:_this77.branch, sha:fileInfo.sha}, "PUT");
}, function(xhr) {
return 404==xhr.status?_this77.request(fileCall, {message:commitPrefix+"Created file", content:serialized, branch:_this77.branch}, "PUT"):xhr;
});
}).then(function(fileInfo) {
if (_this77.repoInfo.fork) {
_this77.forkInfo=_this77.repoInfo.parent, _this77.request("repos/".concat(_this77.repoInfo.parent.owner.login, "/").concat(_this77.repoInfo.parent.name, "/pulls"), {head:"".concat(_this77.user.username, ":").concat(_this77.branch), base:_this77.repoInfo.parent.default_branch}).then(function(prs) {
_this77.pullRequest(prs[0]);
});
}
else if (_this77.forkInfo) {
var params=new URL(location).searchParams;params.append("storage", fileInfo.content.download_url), history.pushState({}, "", "".concat(location.pathname, "?").concat(params)), location.replace("".concat(location.pathname, "?").concat(params)), _this77.request("repos/".concat(_this77.username, "/").concat(_this77.repo, "/pulls"), {head:"".concat(_this77.user.username, ":").concat(_this77.branch), base:_this77.branch}).then(function(prs) {
_this77.pullRequest(prs[0]);
});
} return fileInfo;
});
}
}, pullRequest:function(existing) {
var _this78=this, previewURL=new URL(location);previewURL.searchParams.set(this.mavo.id+"-storage", "https://github.com/".concat(this.forkInfo.full_name, "/").concat(this.path));var message=this.mavo._("gh-edit-suggestion-saved-in-profile", {previewURL:previewURL}), lastNoticeName="";if (this.notice&&(lastNoticeName=this.notice.options.name, this.notice.element.style.transition="none", this.notice.close()), existing) {
var style="closePR"===lastNoticeName?{animation:"none", transition:"none"}:{};this.notice=this.mavo.message("".concat(message, "\n\t\t\t\t").concat(this.mavo._("gh-edit-suggestion-notreviewed"), "\n\t\t\t\t<form onsubmit=\"return false\">\n\t\t\t\t\t<button class=\"mv-danger\">").concat(this.mavo._("gh-edit-suggestion-revoke"), "</button>\n\t\t\t\t</form>"), {classes:"mv-inline", dismiss:["button", "submit"], style:style, name:"closePR"}), this.notice.element.style.transitionDuration="400ms", this.notice.closed.then(function(form) {
if (form) {
var username, repo;_this78.repoInfo.fork?(username=_this78.repoInfo.parent.owner.login, repo=_this78.repoInfo.parent.name):(username=_this78.username, repo=_this78.repo), _this78.request("repos/".concat(username, "/").concat(repo, "/pulls/").concat(existing.number), {state:"closed"}, "POST").then(function(prInfo) {
new Mavo.UI.Message(_this78.mavo, "<a href=\"".concat(prInfo.html_url, "\">").concat(_this78.mavo._("gh-edit-suggestion-cancelled"), "</a>"), {dismiss:["button", "timeout"], style:style}), _this78.pullRequest();
});
}
});
}
else {
var style="createPR"===lastNoticeName?{animation:"none", transition:"none"}:{};this.notice=this.mavo.message("".concat(message, "\n\t\t\t\t").concat(this.mavo._("gh-edit-suggestion-instructions"), "\n\t\t\t\t<form onsubmit=\"return false\">\n\t\t\t\t\t<textarea name=\"edits\" class=\"mv-autosize\" placeholder=\"").concat(this.mavo._("gh-edit-suggestion-reason-placeholder"), "\"></textarea>\n\t\t\t\t\t<button>").concat(this.mavo._("gh-edit-suggestion-send"), "</button>\n\t\t\t\t</form>"), {classes:"mv-inline", dismiss:["button", "submit"], style:style, name:"createPR"}), this.notice.element.style.transitionDuration="400ms", this.notice.closed.then(function(form) {
if (form) {
var username, repo, base;_this78.repoInfo.fork?(username=_this78.repoInfo.parent.owner.login, repo=_this78.repoInfo.parent.name, base=_this78.repoInfo.parent.default_branch):(username=_this78.username, repo=_this78.repo, base=_this78.branch), _this78.request("repos/".concat(username, "/").concat(repo, "/pulls"), {title:_this78.mavo._("gh-edit-suggestion-title"), body:_this78.mavo._("gh-edit-suggestion-body", {description:form.elements.edits.value, previewURL:previewURL}), head:"".concat(_this78.user.username, ":").concat(_this78.branch), base:base}, "POST").then(function(prInfo) {
new Mavo.UI.Message(_this78.mavo, "<a href=\"".concat(prInfo.html_url, "\">").concat(_this78.mavo._("gh-edit-suggestion-sent"), "</a>"), {dismiss:["button", "timeout"], style:style}), _this78.pullRequest(prInfo);
});
}
});
}
}, login:function(passive) {
var _this79=this;return this.oAuthenticate(passive).then(function() {
return _this79.getUser();
})["catch"](function(xhr) {
401==xhr.status&&_this79.logout();
}).then(function() {
if (_this79.user&&(_this79.permissions.on("logout"), _this79.info.path&&_this79.permissions.on(["edit", "save"]), _this79.repo)) {
return _this79.request("repos/".concat(_this79.username, "/").concat(_this79.repo)).then(function(repoInfo) {
void 0===_this79.branch&&(_this79.branch=repoInfo.default_branch), _this79.repoInfo=repoInfo;new URL(location).searchParams;if (!_this79.mavo.source) {
if (repoInfo.fork) {
return _this79.forkInfo=repoInfo.parent, _this79.request("repos/".concat(repoInfo.parent.owner.login, "/").concat(repoInfo.parent.name, "/pulls"), {head:"".concat(_this79.user.username, ":").concat(_this79.branch), base:repoInfo.parent.default_branch}).then(function(prs) {
_this79.pullRequest(prs[0]);
}), repoInfo;
} if (!_this79.canPush()) {
if (_this79.user.info.public_repos<repoInfo.forks) {
return _this79.request("https://api.github.com/graphql", {query:"query {\n\t\t\t\t\t\t\t\t\t\t\t\t\t  viewer {\n\t\t\t\t\t\t\t\t\t\t\t\t\t    name\n\t\t\t\t\t\t\t\t\t\t\t\t\t      repositories(last: 100, isFork: true) {\n\t\t\t\t\t\t\t\t\t\t\t\t\t      nodes {\n\t\t\t\t\t\t\t\t\t\t\t\t\t        url\n\t\t\t\t\t\t\t\t\t\t\t\t\t        parent {\n\t\t\t\t\t\t\t\t\t\t\t\t\t          nameWithOwner\n\t\t\t\t\t\t\t\t\t\t\t\t\t        }\n\t\t\t\t\t\t\t\t\t\t\t\t\t      }\n\t\t\t\t\t\t\t\t\t\t\t\t\t    }\n\t\t\t\t\t\t\t\t\t\t\t\t\t  }\n\t\t\t\t\t\t\t\t\t\t\t\t\t}"}, "POST").then(function(data) {
var repos=data.data.viewer.repositories.nodes;for (var i in repos) {
if (repos[i].parent.nameWithOwner===repoInfo.full_name) {
return _this79.switchToMyForkDialog(repos[i].url), repoInfo;
}
} return repoInfo;
});
} return _this79.request(repoInfo.forks_url).then(function(forks) {
for (var i in forks) {
if (forks[i].owner.login===_this79.user.username) {
return _this79.switchToMyForkDialog(forks[i].html_url), repoInfo;
}
} return repoInfo;
});
}
} return repoInfo;
});
}
});
}, canPush:function() {
return this.repoInfo?this.repoInfo.permissions.push:this.user&&this.user.username.toLowerCase()==this.username.toLowerCase();
}, oAuthParams:function() {
return "&scope=repo,gist";
}, logout:function() {
var _this80=this;return this.oAuthLogout().then(function() {
_this80.user=null;
});
}, getUser:function() {
var _this81=this;return this.user?Promise.resolve(this.user):this.request("user").then(function(info) {
_this81.user={username:info.login, name:info.name||info.login, avatar:info.avatar_url, url:"https://github.com/"+info.login, info:info}, $.fire(_this81.mavo.element, "mv-login", {backend:_this81});
});
}, getURL:function() {
var _this82=this, path=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.path, sha=1<arguments.length?arguments[1]:void 0, repoInfo=this.forkInfo||this.repoInfo, repo=repoInfo.full_name;return path=path.replace(/ /g, "%20"), repoInfo.pagesInfo=repoInfo.pagesInfo||this.request("repos/".concat(repo, "/pages"), {}, "GET", {headers:{Accept:"application/vnd.github.mister-fantastic-preview+json"}}), repoInfo.pagesInfo.then(function(pagesInfo) {
return pagesInfo.html_url+path;
})["catch"](function() {
return "https://cdn.jsdelivr.net/gh/".concat(repo, "@").concat(sha||_this82.branch||"latest", "/").concat(path);
});
}, switchToMyForkDialog:function(forkURL) {
var params=new URL(location).searchParams;return params.append("storage", forkURL+"/"+this.path), this.notice=this.mavo.message("\n\t\t\t".concat(this.mavo._("gh-login-fork-options"), "\n\t\t\t<form onsubmit=\"return false\">\n\t\t\t\t<a href=\"").concat(location.pathname, "?").concat(params, "\"><button>").concat(this.mavo._("gh-use-my-fork"), "</button></a>\n\t\t\t</form>"), {classes:"mv-inline", dismiss:["button", "submit"]}), void this.notice.closed.then(function(form) {
form&&(history.pushState({}, "", "".concat(location.pathname, "?").concat(params)), location.replace("".concat(location.pathname, "?").concat(params)));
});
}, static:{apiDomain:"https://api.github.com/", oAuth:"https://github.com/login/oauth/authorize", test:function(url) {
return url=new URL(url, Mavo.base), /\bgithub.com|raw.githubusercontent.com/.test(url.host);
}, parseURL:function(source) {
var defaults=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}, ret={}, url=new URL(source, Mavo.base), path=url.pathname.slice(1).split("/");if (ret.username=path.shift(), ret.repo=path.shift()||defaults.repo, /raw.githubusercontent.com$/.test(url.host)) {
ret.branch=path.shift();
}
else {
if (/api.github.com$/.test(url.host)) {
var apiCall=url.pathname.slice(1)+url.search, data=Mavo.Functions.from(source, "#");return {apiCall:apiCall, apiData:"graphql"==apiCall?{query:data}:data};
}"blob"==path[0]&&(path.shift(), ret.branch=path.shift());
} var lastSegment=path[path.length-1];return /\.\w+$/.test(lastSegment)?(ret.filename=lastSegment, path.splice(path.length-1, 1)):ret.filename=defaults.filename, ret.filepath=path.join("/")||defaults.filepath||"", ret.path=(ret.filepath?ret.filepath+"/":"")+ret.filename, ret.apiCall="repos/".concat(ret.username, "/").concat(ret.repo, "/contents/").concat(ret.path), ret;
}, btoa:function(_btoa) {
function btoa() {
return _btoa.apply(this, arguments);
} return btoa.toString=function() {
return _btoa.toString();
}, btoa;
}(function(str) {
return btoa(unescape(encodeURIComponent(str)));
}), atob:function(str) {
return decodeURIComponent(escape(window.atob(str)));
}}}));
}(Bliss, Bliss.$);
// # sourceMappingURL=maps/mavo.es5.min.js.map
