{"version":3,"sources":["expressions.js"],"names":[],"mappings":"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","file":"mavo.es5.js","sourcesContent":["(function($, $$) {\n\nMavo.attributes.push(\"mv-value\", \"mv-if\");\n\nvar _ = Mavo.Expressions = $.Class({\n\tconstructor: function(group) {\n\t\tif (group) {\n\t\t\tthis.group = group;\n\t\t\tthis.group.expressions = this;\n\t\t}\n\n\t\tthis.all = []; // all Expression.Text objects in this group\n\n\t\tMavo.hooks.run(\"expressions-init-start\", this);\n\n\t\tif (this.group) {\n\t\t\tvar template = this.group.template;\n\n\t\t\tif (template && template.expressions) {\n\t\t\t\t// We know which expressions we have, don't traverse again\n\t\t\t\tfor (let et of template.expressions.all) {\n\t\t\t\t\tthis.all.push(new Mavo.Expression.Text({\n\t\t\t\t\t\ttemplate: et,\n\t\t\t\t\t\tgroup: this.group\n\t\t\t\t\t}));\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tvar syntax = Mavo.Expression.Syntax.create(this.group.element.closest(\"[mv-expressions]\")) || Mavo.Expression.Syntax.default;\n\t\t\t\tthis.traverse(this.group.element, undefined, syntax);\n\t\t\t}\n\t\t}\n\n\t\tthis.dependents = new Set();\n\n\t\tthis.active = true;\n\n\t\t// Watch changes and update value\n\t\tthis.group.element.addEventListener(\"mavo:datachange\", evt => this.update(evt));\n\t},\n\n\t/**\n\t * Update all expressions in this group\n\t */\n\tupdate: function callee(evt) {\n\t\tif (!this.active || this.group.isDeleted() || this.all.length + this.dependents.size === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar env = { context: this, data: this.group.getRelativeData() };\n\n\t\tMavo.hooks.run(\"expressions-update-start\", env);\n\n\t\tfor (let ref of this.all) {\n\t\t\tif (ref.changedBy(evt)) {\n\t\t\t\tref.update(env.data, evt);\n\t\t\t}\n\t\t}\n\n\t\tfor (let exp of this.dependents) {\n\t\t\texp.update();\n\t\t}\n\t},\n\n\textract: function(node, attribute, path, syntax) {\n\t\tif (attribute && attribute.name == \"mv-expressions\") {\n\t\t\treturn;\n\t\t}\n\n\t\tif ((attribute && _.directives.indexOf(attribute.name) > -1) ||\n\t\t    syntax.test(attribute? attribute.value : node.textContent)\n\t\t) {\n\t\t\tthis.all.push(new Mavo.Expression.Text({\n\t\t\t\tnode, syntax,\n\t\t\t\tpath: path? path.slice(1).split(\"/\").map(i => +i) : [],\n\t\t\t\tattribute: attribute && attribute.name,\n\t\t\t\tgroup: this.group\n\t\t\t}));\n\t\t}\n\t},\n\n\t// Traverse an element, including attribute nodes, text nodes and all descendants\n\ttraverse: function(node, path = \"\", syntax) {\n\t\tif (node.nodeType === 8) {\n\t\t\t// We don't want expressions to be picked up from comments!\n\t\t\t// Commenting stuff out is a common debugging technique\n\t\t\treturn;\n\t\t}\n\n\t\tif (node.nodeType === 3) { // Text node\n\t\t\t// Leaf node, extract references from content\n\t\t\tthis.extract(node, null, path, syntax);\n\t\t}\n\t\t// Traverse children and attributes as long as this is NOT the root of a child group\n\t\t// (otherwise, it will be taken care of its own Expressions object)\n\t\telse if (node == this.group.element || !Mavo.is(\"group\", node)) {\n\t\t\tsyntax = Mavo.Expression.Syntax.create(node) || syntax;\n\n\t\t\tif (syntax === Mavo.Expression.Syntax.ESCAPE) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t$$(node.attributes).forEach(attribute => this.extract(node, attribute, path, syntax));\n\t\t\t$$(node.childNodes).forEach((child, i) => this.traverse(child, `${path}/${i}`, syntax));\n\t\t}\n\t},\n\n\tstatic: {\n\t\tdirectives: []\n\t}\n});\n\nif (self.Proxy) {\n\tMavo.hooks.add(\"node-getdata-end\", function(env) {\n\t\tif (env.options.relative && env.data && typeof env.data === \"object\") {\n\t\t\tenv.data = new Proxy(env.data, {\n\t\t\t\tget: (data, property, proxy) => {\n\t\t\t\t\t// Checking if property is in proxy might add it to the data\n\t\t\t\t\tif (property in data || (property in proxy && property in data)) {\n\t\t\t\t\t\treturn data[property];\n\t\t\t\t\t}\n\n\t\t\t\t\tif (property == \"$index\") {\n\t\t\t\t\t\treturn this.index + 1;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (property == this.mavo.id) {\n\t\t\t\t\t\treturn data;\n\t\t\t\t\t}\n\t\t\t\t},\n\n\t\t\t\thas: (data, property) => {\n\t\t\t\t\tif (property in data) {\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Property does not exist, look for it elsewhere\n\n\t\t\t\t\tif (property == \"$index\" || property == this.mavo.id) {\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\t// First look in ancestors\n\t\t\t\t\tvar ret = this.walkUp(group => {\n\t\t\t\t\t\tif (property in group.children) {\n\t\t\t\t\t\t\treturn group.children[property];\n\t\t\t\t\t\t};\n\t\t\t\t\t});\n\n\t\t\t\t\tif (ret === undefined) {\n\t\t\t\t\t\t// Still not found, look in descendants\n\t\t\t\t\t\tret = this.find(property);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (ret !== undefined) {\n\t\t\t\t\t\tif (Array.isArray(ret)) {\n\t\t\t\t\t\t\tret = ret.map(item => item.getRelativeData(env.options))\n\t\t\t\t\t\t\t\t\t .filter(item => item !== null);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (ret instanceof Mavo.Node) {\n\t\t\t\t\t\t\tret = ret.getRelativeData(env.options);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tdata[property] = ret;\n\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\n\t\t\t\tset: function(data, property, value) {\n\t\t\t\t\tthrow Error(\"You canâ€™t set data via expressions.\");\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t});\n}\n\nMavo.Node.prototype.getRelativeData = function() {\n\treturn this.getData({\n\t\trelative: true,\n\t\tstore: \"*\",\n\t\tnull: true,\n\t\tunhandled: this.mavo.unhandled\n\t});\n};\n\nMavo.hooks.add(\"group-init-start\", function() {\n\tnew Mavo.Expressions(this);\n});\n\nMavo.hooks.add(\"group-init-end\", function() {\n\tthis.expressions.update();\n});\n\n\n// Disable expressions during rendering, for performance\nMavo.hooks.add(\"group-render-start\", function() {\n\tthis.expressions.active = false;\n});\n\nMavo.hooks.add(\"group-render-end\", function() {\n\trequestAnimationFrame(() => {\n\t\tthis.expressions.active = true;\n\t\tthis.expressions.update();\n\t});\n});\n\n})(Bliss, Bliss.$);\n\n// mv-value plugin\nMavo.Expressions.directives.push(\"mv-value\");\n\nMavo.hooks.add(\"expressiontext-init-start\", function() {\n\tif (this.attribute == \"mv-value\") {\n\t\tthis.attribute = Mavo.Primitive.getValueAttribute(this.element);\n\t\tthis.fallback = this.fallback || Mavo.Primitive.getValue(this.element, {attribute: this.attribute});\n\t\tthis.expression = this.element.getAttribute(\"mv-value\");\n\n\t\tthis.parsed = [new Mavo.Expression(this.expression)];\n\t\tthis.expression = this.syntax.start + this.expression + this.syntax.end;\n\t}\n});\n"],"sourceRoot":"/source/"}