{"version":3,"sources":["collection.js"],"names":["_toConsumableArray","arr","Array","isArray","i","arr2","length","from","$","$$","Mavo","attributes","push","_","Collection","Class","extends","Node","nodeType","constructor","element","mavo","o","this","templateElement","children","fromTemplate","properties","selectors","property","map","getProperty","mutable","matches","multiple","accepts","getAttribute","split","cloneNode","item","createItem","add","itemTemplate","template","hooks","run","getData","arguments","undefined","env","context","options","data","_iteratorNormalCompletion","_didIteratorError","_iteratorError","_step","_iterator","Symbol","iterator","next","done","value","deleted","itemData","err","unhandled","before","concat","after","create","collection","type","index","get","adopt","bottomUp","nextItem","marker","changed","splice","remove","forEach","silent","dataChanged","unsavedChanges","_len","actions","_key","_iteratorNormalCompletion2","_didIteratorError2","_iteratorError2","_step2","_iterator2","action","isNaN","indexOf","sort","a","b","_iteratorNormalCompletion3","_didIteratorError3","_iteratorError3","_step3","_iterator3","_action","_children","toArray","apply","_item","_this","walk","obj","closestCollection","copies","delete","hard","_this2","transition","opacity","then","style","edit","_this3","call","addButton","parentNode","tag","tagName","toLowerCase","containerSelector","container","closest","dragula","getDragula","clear","propagate","_iteratorNormalCompletion4","_didIteratorError4","_iteratorError4","_step4","_iterator4","childNodes","save","_iteratorNormalCompletion5","_didIteratorError5","_iteratorError5","_step5","_iterator5","_item2","propagated","revert","_iteratorNormalCompletion6","_didIteratorError6","_iteratorError6","_step6","_iterator6","_item3","render","_this4","fragment","document","createDocumentFragment","datum","appendChild","insertBefore","slice","find","items","filter","collections","ret","flatten","isCompatible","c","live","_mutable","needsEdit","createComment","classList","_this5","pushUnique","containers","isContainer","el","root","moves","handle","contains","target","source","previous","previousElementSibling","lastElementChild","on","nextElementSibling","closestItem","cancel","dragulas","lazy","order","test","compareDocumentPosition","DOCUMENT_POSITION_FOLLOWING","parent","_this6","selector","group","button","className","textContent","name","addEventListener","evt","preventDefault","static","include","self","_this7","attribute","swapUI","callback","sneak","ui","inside","descriptor","Object","getOwnPropertyDescriptor","prototype","defineProperty","_this8","set","_this9","_this10","itemControls","contents","title","events","click","replace","getClosestCollection","parentGroup","_this11","toggle","elementContents","node","_deleted","isDeleted","Bliss"],"mappings":"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","file":"mavo.min.js","sourcesContent":["(function($, $$) {\n\nMavo.attributes.push(\"mv-multiple\", \"mv-order\", \"mv-accepts\");\n\nvar _ = Mavo.Collection = $.Class({\n\textends: Mavo.Node,\n\tnodeType: \"Collection\",\n\tconstructor: function (element, mavo, o) {\n\t\t/*\n\t\t * Create the template, remove it from the DOM and store it\n\t\t */\n\t\tthis.templateElement = this.element;\n\n\t\tthis.children = [];\n\n\t\t// ALL descendant property names as an array\n\t\tif (!this.fromTemplate(\"properties\", \"mutable\", \"templateElement\", \"accepts\")) {\n\t\t\tthis.properties = $$(Mavo.selectors.property, this.templateElement).map(Mavo.Node.getProperty);\n\t\t\tthis.mutable = this.templateElement.matches(Mavo.selectors.multiple);\n\t\t\tthis.accepts = (this.templateElement.getAttribute(\"mv-accepts\") || \"\").split(/\\s+/);\n\n\t\t\t// Must clone because otherwise once expressions are parsed on the template element\n\t\t\t// we will not be able to pick them up from subsequent items\n\t\t\tthis.templateElement = this.templateElement.cloneNode(true);\n\t\t}\n\n\t\tif (this.mutable) {\n\t\t\tvar item = this.createItem(this.element);\n\t\t\tthis.add(item);\n\t\t\tthis.itemTemplate = item.template || item;\n\t\t}\n\n\t\tMavo.hooks.run(\"collection-init-end\", this);\n\t},\n\n\tget length() {\n\t\treturn this.children.length;\n\t},\n\n\tgetData: function(o = {}) {\n\t\tvar env = {\n\t\t\tcontext: this,\n\t\t\toptions: o,\n\t\t\tdata: []\n\t\t};\n\n\t\tfor (item of this.children) {\n\t\t\tif (!item.deleted) {\n\t\t\t\tlet itemData = item.getData(env.options);\n\n\t\t\t\tif (itemData) {\n\t\t\t\t\tenv.data.push(itemData);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (this.unhandled && env.options.unhandled) {\n\t\t\tenv.data = this.unhandled.before.concat(env.data, this.unhandled.after);\n\t\t}\n\n\t\tif (!this.mutable && env.data.length == 1) {\n\t\t\t// See https://github.com/LeaVerou/mavo/issues/50#issuecomment-266079652\n\t\t\tenv.data = env.data[0];\n\t\t}\n\n\t\tMavo.hooks.run(\"node-getdata-end\", env);\n\n\t\treturn env.data;\n\t},\n\n\t// Create item but don't insert it anywhere\n\t// Mostly used internally\n\tcreateItem: function (element) {\n\t\tif (!element) {\n\t\t\telement = this.templateElement.cloneNode(true);\n\t\t}\n\n\t\tvar item = Mavo.Node.create(element, this.mavo, {\n\t\t\tcollection: this,\n\t\t\ttemplate: this.itemTemplate || (this.template? this.template.itemTemplate : null),\n\t\t\tproperty: this.property,\n\t\t\ttype: this.type\n\t\t});\n\n\t\treturn item;\n\t},\n\n\t/**\n\t * Add a new item to this collection\n\t * @param item {Node|Mavo.Node} Optional. Element or Mavo object for the new item\n\t * @param index {Number} Optional. Index of existing item, will be added opposite to list direction\n\t * @param silent {Boolean} Optional. Throw a datachange event? Mainly used internally.\n\t */\n\tadd: function(item, index, o = {}) {\n\t\tif (item instanceof Node) {\n\t\t\titem = Mavo.Node.get(item) || this.createItem(item);\n\t\t}\n\t\telse {\n\t\t\titem = item || this.createItem();\n\t\t}\n\n\t\tif (item.collection != this) {\n\t\t\tthis.adopt(item);\n\t\t}\n\n\t\tif (index in this.children) {\n\t\t\tif (this.bottomUp) {\n\t\t\t\tindex++;\n\t\t\t}\n\t\t}\n\t\telse if (index === undefined) {\n\t\t\tindex = this.bottomUp? 0 : this.length;\n\t\t}\n\n\t\tif (this.mutable) {\n\t\t\t// Add it to the DOM, or fix its place\n\t\t\tvar nextItem = this.children[index];\n\n\t\t\titem.element._.before(nextItem && nextItem.element || this.marker);\n\t\t}\n\n\t\t// Update internal data model\n\t\tvar changed = this.splice({\n\t\t\tremove: item\n\t\t}, {\n\t\t\tindex: index,\n\t\t\tadd: item\n\t\t});\n\n\t\tchanged.forEach(item => {\n\t\t\tif (!o.silent) {\n\t\t\t\titem.dataChanged(\"move\");\n\t\t\t\titem.unsavedChanges = true;\n\t\t\t}\n\t\t});\n\n\t\tif (!o.silent) {\n\t\t\tthis.unsavedChanges = this.mavo.unsavedChanges = true;\n\t\t}\n\n\t\treturn item;\n\t},\n\n\tsplice: function(...actions) {\n\t\tfor (let action of actions) {\n\t\t\tif (action.index === undefined && action.remove && isNaN(action.remove)) {\n\t\t\t\t// Remove is an item\n\t\t\t\taction.index = this.children.indexOf(action.remove);\n\t\t\t\taction.remove = 1;\n\t\t\t}\n\t\t}\n\n\t\t// Sort in reverse index order\n\t\tactions.sort((a, b) => b.index - a.index);\n\n\t\tfor (let action of actions) {\n\t\t\tif (action.index > -1 && (action.remove || action.add)) {\n\t\t\t\taction.remove = action.remove || 0;\n\t\t\t\taction.add = Mavo.toArray(action.add);\n\n\t\t\t\tthis.children.splice(action.index, +action.remove, ...action.add);\n\t\t\t}\n\t\t}\n\n\t\tvar changed = [];\n\n\t\tfor (let i = 0; i < this.length; i++) {\n\t\t\tlet item = this.children[i];\n\n\t\t\tif (item && item.index !== i) {\n\t\t\t\titem.index = i;\n\t\t\t\tchanged.push(item);\n\t\t\t}\n\t\t}\n\n\t\treturn changed;\n\t},\n\n\tadopt: function(item) {\n\t\tif (item.collection) {\n\t\t\t// It belongs to another collection, delete from there first\n\t\t\titem.collection.splice({remove: item});\n\t\t\titem.collection.dataChanged(\"delete\");\n\t\t}\n\n\t\t // Update collection & closestCollection properties\n\t\tthis.walk(obj => {\n\t\t\tif (obj.closestCollection === item.collection) {\n\t\t\t\tobj.closestCollection = this;\n\t\t\t}\n\n\t\t\t// Belongs to another Mavo?\n\t\t\tif (item.mavo != this.mavo) {\n\t\t\t\titem.mavo = this.mavo;\n\t\t\t}\n\t\t});\n\n\t\titem.collection = this;\n\n\t\t// Adjust templates and their copies\n\t\tif (item.template) {\n\t\t\tMavo.delete(item.template.copies, item);\n\n\t\t\titem.template = this.itemTemplate;\n\t\t}\n\t},\n\n\tdelete: function(item, hard) {\n\t\tif (hard) {\n\t\t\t// Hard delete\n\t\t\t$.remove(item.element);\n\t\t\tthis.splice({remove: item});\n\t\t\treturn;\n\t\t}\n\n\t\treturn $.transition(item.element, {opacity: 0}).then(() => {\n\t\t\titem.deleted = true; // schedule for deletion\n\t\t\titem.element.style.opacity = \"\";\n\n\t\t\titem.dataChanged(\"delete\");\n\n\t\t\tthis.unsavedChanges = item.unsavedChanges = this.mavo.unsavedChanges = true;\n\t\t});\n\t},\n\n\tedit: function() {\n\t\tthis.super.edit.call(this);\n\n\t\tif (this.mutable) {\n\t\t\t// Insert the add button if it's not already in the DOM\n\t\t\tif (!this.addButton.parentNode) {\n\t\t\t\tif (this.bottomUp) {\n\t\t\t\t\tthis.addButton._.before($.value(this.children[0], \"element\") || this.marker);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tvar tag = this.element.tagName.toLowerCase();\n\t\t\t\t\tvar containerSelector = Mavo.selectors.container[tag];\n\n\t\t\t\t\tif (containerSelector) {\n\t\t\t\t\t\tvar after = this.marker.parentNode.closest(containerSelector);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.addButton._.after(after && after.parentNode? after : this.marker);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Set up drag & drop\n\t\t\t_.dragula.then(() => {\n\t\t\t\tthis.getDragula();\n\t\t\t});\n\t\t}\n\t},\n\n\tdone: function() {\n\t\tthis.super.done.call(this);\n\n\t\tif (this.mutable) {\n\t\t\tif (this.addButton.parentNode) {\n\t\t\t\tthis.addButton.remove();\n\t\t\t}\n\t\t}\n\t},\n\n\t/**\n\t * Delete all items in the collection.\n\t */\n\tclear: function() {\n\t\tif (this.mutable) {\n\t\t\tthis.propagate(item => {\n\t\t\t\tif (item.element.remove) {\n\t\t\t\t\titem.element.remove();\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// Document fragment, remove all children\n\t\t\t\t\tfor (let node of item.element.childNodes) {\n\t\t\t\t\t\tnode => node.remove();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tthis.children = [];\n\n\t\t\tthis.dataChanged(\"clear\");\n\t\t}\n\t},\n\n\tdataChanged: function(action, o = {}) {\n\t\to.element = o.element || this.marker;\n\t\treturn this.super.dataChanged.call(this, action, o);\n\t},\n\n\tsave: function() {\n\t\tfor (let item of this.children) {\n\t\t\tif (item.deleted) {\n\t\t\t\tthis.delete(item, true);\n\t\t\t}\n\t\t\telse {\n\t\t\t\titem.unsavedChanges = false;\n\t\t\t}\n\t\t}\n\t},\n\n\tpropagated: [\"save\"],\n\n\trevert: function() {\n\t\tfor (let item of this.children) {\n\t\t\t// Delete added items\n\t\t\tif (item.unsavedChanges) {\n\t\t\t\tthis.delete(item, true);\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Bring back deleted items\n\t\t\t\tif (item.deleted) {\n\t\t\t\t\titem.deleted = false;\n\t\t\t\t}\n\n\t\t\t\t// Revert all properties\n\t\t\t\titem.revert();\n\t\t\t}\n\t\t}\n\t},\n\n\trender: function(data) {\n\t\tthis.unhandled = {before: [], after: []};\n\n\t\tif (!data) {\n\t\t\treturn;\n\t\t}\n\n\t\tdata = Mavo.toArray(data);\n\n\t\tif (!this.mutable) {\n\t\t\tthis.children.forEach((item, i) => item.render(data && data[i]));\n\n\t\t\tif (data) {\n\t\t\t\tthis.unhandled.after = data.slice(this.length);\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tthis.clear();\n\n\t\t\t// Using document fragments improved rendering performance by 60%\n\t\t\tvar fragment = document.createDocumentFragment();\n\n\t\t\tdata.forEach((datum, i) => {\n\t\t\t\tvar item = this.createItem();\n\n\t\t\t\titem.render(datum);\n\n\t\t\t\tthis.children.push(item);\n\t\t\t\titem.index = i;\n\n\t\t\t\tfragment.appendChild(item.element);\n\t\t\t});\n\n\t\t\tthis.marker.parentNode.insertBefore(fragment, this.marker);\n\t\t}\n\n\t\tthis.save();\n\t},\n\n\tfind: function(property, o = {}) {\n\t\tvar items = this.children.filter(item => !item.deleted);\n\n\t\tif (this.property == property) {\n\t\t\treturn o.collections? this : items;\n\t\t}\n\n\t\tif (this.properties.indexOf(property) > -1) {\n\t\t\tvar ret = items.map(item => item.find(property, o));\n\n\t\t\treturn Mavo.flatten(ret);\n\t\t}\n\t},\n\n\tisCompatible: function(c) {\n\t\treturn c && this.itemTemplate.nodeType == c.itemTemplate.nodeType && (c === this\n\t\t       || c.template == this || this.template == c || this.template && this.template == c.template\n\t\t       || this.accepts.indexOf(c.property) > -1);\n\t},\n\n\tlive: {\n\t\tmutable: function(value) {\n\t\t\tif (value && value !== this.mutable) {\n\t\t\t\t// Why is all this code here? Because we want it executed\n\t\t\t\t// every time mutable changes, not just in the constructor\n\t\t\t\t// (think multiple elements with the same property name, where only one has mv-multiple)\n\t\t\t\tthis._mutable = value;\n\n\t\t\t\tthis.mavo.needsEdit = true;\n\n\t\t\t\t// Keep position of the template in the DOM, since we might remove it\n\t\t\t\tthis.marker = document.createComment(\"mv-marker\");\n\t\t\t\tMavo.data(this.marker, \"collection\", this);\n\t\t\t\t$.after(this.marker, this.templateElement);\n\n\t\t\t\tthis.templateElement.classList.add(\"mv-item\");\n\t\t\t}\n\t\t}\n\t},\n\n\t// Make sure to only call after dragula has loaded\n\tgetDragula: function() {\n\t\tif (this.dragula) {\n\t\t\treturn this.dragula;\n\t\t}\n\n\t\tif (this.template) {\n\t\t\tMavo.pushUnique(this.template.dragula.containers, this.marker.parentNode);\n\t\t\treturn this.dragula = this.template.dragula || this.template.getDragula();\n\t\t}\n\n\t\tvar me = this;\n\t\tthis.dragula = dragula({\n\t\t\tcontainers: [this.marker.parentNode],\n\t\t\tisContainer: el => {\n\t\t\t\tif (this.accepts.length) {\n\t\t\t\t\treturn Mavo.flatten(this.accepts.map(property => this.mavo.root.find(property, {collections: true})))\n\t\t\t\t\t\t\t\t.filter(c => c && c instanceof _)\n\t\t\t\t\t\t\t\t.map(c => c.marker.parentNode)\n\t\t\t\t\t\t\t\t.indexOf(el) > -1;\n\t\t\t\t}\n\n\t\t\t\treturn false;\n\t\t\t},\n\t\t\tmoves: (el, container, handle) => {\n\t\t\t\treturn handle.classList.contains(\"mv-drag-handle\") && handle.closest(Mavo.selectors.item) == el;\n\t\t\t},\n\t\t\taccepts: function(el, target, source, next) {\n\t\t\t\tif (el.contains(target)) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tvar previous = next? next.previousElementSibling : target.lastElementChild;\n\n\t\t\t\tvar collection = _.get(previous) || _.get(next);\n\n\t\t\t\tif (!collection) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tvar item = Mavo.Node.get(el);\n\n\t\t\t\treturn item && item.collection.isCompatible(collection);\n\t\t\t}\n\t\t});\n\n\t\tthis.dragula.on(\"drop\", (el, target, source) => {\n\t\t\tvar item = Mavo.Node.get(el);\n\t\t\tvar oldIndex = item && item.index;\n\t\t\tvar next = el.nextElementSibling;\n\t\t\tvar previous = el.previousElementSibling;\n\t\t\tvar collection = _.get(previous) || _.get(next);\n\t\t\tvar closestItem = Mavo.Node.get(previous) || Mavo.Node.get(next);\n\n\t\t\tif (closestItem && closestItem.collection != collection) {\n\t\t\t\tclosestItem = null;\n\t\t\t}\n\n\t\t\tif (item.collection.isCompatible(collection)) {\n\t\t\t\tvar index = closestItem? closestItem.index + (closestItem.element === previous) : collection.length;\n\t\t\t\tcollection.add(item, index);\n\t\t\t}\n\t\t\telse {\n\t\t\t\treturn this.dragula.cancel(true);\n\t\t\t}\n\t\t});\n\n\t\t_.dragulas.push(this.dragula);\n\n\t\treturn this.dragula;\n\t},\n\n\tlazy: {\n\t\tbottomUp: function() {\n\t\t\t/*\n\t\t\t * Add new items at the top or bottom?\n\t\t\t */\n\n\t\t\tif (!this.mutable) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tvar order = this.templateElement.getAttribute(\"mv-order\");\n\t\t\tif (order !== null) {\n\t\t\t\t// Attribute has the highest priority and overrides any heuristics\n\t\t\t\treturn /^desc\\b/i.test(order);\n\t\t\t}\n\n\t\t\tif (!this.addButton.parentNode) {\n\t\t\t\t// If add button not in DOM, do the default\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// If add button is already in the DOM and *before* our template, then we default to prepending\n\t\t\treturn !!(this.addButton.compareDocumentPosition(this.templateElement) & Node.DOCUMENT_POSITION_FOLLOWING);\n\t\t},\n\n\t\tclosestCollection: function() {\n\t\t\tvar parent = this.marker? this.marker.parentNode : this.templateElement.parentNode;\n\n\t\t\treturn parent.closest(Mavo.selectors.item);\n\t\t},\n\n\t\taddButton: function() {\n\t\t\t// Find add button if provided, or generate one\n\t\t\tvar selector = `button.mv-add-${this.property}`;\n\t\t\tvar group = this.closestCollection || this.marker.parentNode.closest(Mavo.selectors.group);\n\n\t\t\tif (group) {\n\t\t\t\tvar button = $$(selector, group).filter(button => {\n\t\t\t\t\treturn !this.templateElement.contains(button);\n\t\t\t\t})[0];\n\t\t\t}\n\n\t\t\tif (!button) {\n\t\t\t\tbutton = $.create(\"button\", {\n\t\t\t\t\tclassName: \"mv-add\",\n\t\t\t\t\ttextContent: \"Add \" + this.name\n\t\t\t\t});\n\t\t\t};\n\n\t\t\tbutton.classList.add(\"mv-ui\", \"mv-add\");\n\t\t\tMavo.data(button, \"collection\", this);\n\n\t\t\tif (this.property) {\n\t\t\t\tbutton.classList.add(`mv-add-${this.property}`);\n\t\t\t}\n\n\t\t\tbutton.addEventListener(\"click\", evt => {\n\t\t\t\tevt.preventDefault();\n\n\t\t\t\tthis.add().edit();\n\t\t\t});\n\n\t\t\treturn button;\n\t\t}\n\t},\n\n\tstatic: {\n\t\tdragulas: [],\n\t\tget: element => {\n\t\t\t// Is it an add button or a marker?\n\t\t\tvar collection = Mavo.data(element, \"collection\");\n\n\t\t\tif (collection) {\n\t\t\t\treturn collection;\n\t\t\t}\n\n\t\t\t// Maybe it's a collection item?\n\t\t\tvar item = Mavo.Node.get(element);\n\n\t\t\treturn item && item.collection || null;\n\t\t},\n\n\t\tlazy: {\n\t\t\tdragula: () => $.include(self.dragula, \"https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.min.js\")\n\t\t}\n\t}\n});\n\nMavo.hooks.add(\"primitive-init-end\", function() {\n\tif (this.collection && !this.attribute) {\n\t\t// Collection of primitives, deal with setting textContent etc without the UI interfering.\n\t\tvar swapUI = callback => {\n\t\t\tvar ret;\n\n\t\t\tthis.sneak(() => {\n\t\t\t\tvar ui = $.remove($(\".mv-item-controls\", this.element));\n\n\t\t\t\tret = callback();\n\n\t\t\t\t$.inside(ui, this.element);\n\t\t\t});\n\n\t\t\treturn ret;\n\t\t};\n\n\t\t// Intercept certain properties so that any Mavo UI inside this primitive will not be destroyed\n\t\t[\"textContent\", \"innerHTML\"].forEach(property => {\n\t\t\tvar descriptor = Object.getOwnPropertyDescriptor(Node.prototype, property);\n\n\t\t\tObject.defineProperty(this.element, property, {\n\t\t\t\tget: function() {\n\t\t\t\t\treturn swapUI(() => descriptor.get.call(this));\n\t\t\t\t},\n\n\t\t\t\tset: function(value) {\n\t\t\t\t\tswapUI(() => descriptor.set.call(this, value));\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n});\n\nMavo.hooks.add(\"node-edit-end\", function() {\n\tif (this.collection) {\n\t\tif (!this.itemControls) {\n\t\t\tthis.itemControls = $$(\".mv-item-controls\", this.element)\n\t\t\t\t\t\t\t\t   .filter(el => el.closest(Mavo.selectors.item) == this.element)[0];\n\n\t\t\tthis.itemControls = this.itemControls || $.create({\n\t\t\t\tclassName: \"mv-item-controls mv-ui\"\n\t\t\t});\n\n\t\t\t$.set(this.itemControls, {\n\t\t\t\tcontents: [\n\t\t\t\t\t{\n\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\ttitle: \"Delete this \" + this.name,\n\t\t\t\t\t\tclassName: \"mv-delete\",\n\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\"click\": evt => this.collection.delete(this)\n\t\t\t\t\t\t}\n\t\t\t\t\t}, {\n\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\ttitle: `Add new ${this.name.replace(/s$/i, \"\")} ${this.bottomUp? \"after\" : \"before\"}`,\n\t\t\t\t\t\tclassName: \"mv-add\",\n\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\"click\": evt => this.collection.add(null, this.collection.children.indexOf(item)).edit()\n\t\t\t\t\t\t}\n\t\t\t\t\t}, {\n\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\ttitle: \"Drag to reorder \" + this.name,\n\t\t\t\t\t\tclassName: \"mv-drag-handle\"\n\t\t\t\t\t}\n\t\t\t\t]\n\t\t\t});\n\t\t}\n\n\t\tif (!this.itemControls.parentNode) {\n\t\t\tthis.element.appendChild(this.itemControls);\n\t\t}\n\t}\n});\n\nMavo.hooks.add(\"node-done-end\", function() {\n\tif (this.collection) {\n\t\tif (this.itemControls) {\n\t\t\tthis.itemControls.remove();\n\t\t}\n\t}\n});\n\nMavo.Node.prototype.getClosestCollection = function() {\n\treturn this.collection ||\n\t\t   this.group.collection ||\n\t\t   (this.parentGroup? this.parentGroup.closestCollection : null);\n};\n\n$.lazy(Mavo.Node.prototype, \"closestCollection\", function() {\n\treturn this.getClosestCollection();\n});\n\n$.live(Mavo.Node.prototype, \"deleted\", function(value) {\n\tthis.element.classList.toggle(\"mv-deleted\", value);\n\n\tif (value) {\n\t\t// Soft delete, store element contents in a fragment\n\t\t// and replace them with an undo prompt.\n\t\tthis.elementContents = document.createDocumentFragment();\n\t\t$$(this.element.childNodes).forEach(node => {\n\t\t\tthis.elementContents.appendChild(node);\n\t\t});\n\n\t\t$.contents(this.element, [\n\t\t\t{\n\t\t\t\ttag: \"button\",\n\t\t\t\tclassName: \"mv-close mv-ui\",\n\t\t\t\ttextContent: \"Ã—\",\n\t\t\t\tevents: {\n\t\t\t\t\t\"click\": function(evt) {\n\t\t\t\t\t\t$.remove(this.parentNode);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t\t\"Deleted \" + this.name,\n\t\t\t{\n\t\t\t\ttag: \"button\",\n\t\t\t\tclassName: \"mv-undo mv-ui\",\n\t\t\t\ttextContent: \"Undo\",\n\t\t\t\tevents: {\n\t\t\t\t\t\"click\": evt => this.deleted = false\n\t\t\t\t}\n\t\t\t}\n\t\t]);\n\n\t\tthis.element.classList.remove(\"mv-delete-hover\");\n\t}\n\telse if (this.deleted) {\n\t\t// Undelete\n\t\tthis.element.textContent = \"\";\n\t\tthis.element.appendChild(this.elementContents);\n\n\t\t// otherwise expressions won't update because this will still seem as deleted\n\t\t// Alternatively, we could fire datachange with a timeout.\n\t\tthis._deleted = false;\n\n\t\tthis.dataChanged(\"undelete\");\n\t}\n});\n\n/**\n * Check if this unit is either deleted or inside a deleted group\n */\nMavo.Node.prototype.isDeleted = function() {\n\tvar ret = this.deleted;\n\n\tif (this.deleted) {\n\t\treturn true;\n\t}\n\n\treturn !!this.parentGroup && this.parentGroup.isDeleted();\n};\n\nMavo.hooks.add(\"node-init-end\", function(env) {\n\tthis.collection = env.options.collection;\n\n\tif (this.collection) {\n\t\t// This is a collection item\n\t\tthis.group = this.parentGroup = this.collection.parentGroup;\n\t}\n});\n\n})(Bliss, Bliss.$);\n"],"sourceRoot":"/source/"}