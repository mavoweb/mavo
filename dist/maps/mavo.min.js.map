{"version":3,"sources":["collection.js"],"names":["$","$$","Mavo","attributes","push","Collection","Class","extends","Node","nodeType","constructor","element","mavo","o","this","templateElement","children","fromTemplate","properties","selectors","property","map","getProperty","mutable","matches","multiple","cloneNode","item","createItem","add","itemTemplate","template","hooks","run","length","containsTemplate","getData","arguments","undefined","env","context","options","data","_iteratorNormalCompletion","_didIteratorError","_iteratorError","_step","_iterator","Symbol","iterator","next","done","value","deleted","itemData","err","unhandled","before","concat","after","create","collection","type","index","get","bottomUp","parentNode","nextItem","_","marker","splice","i","_item","silent","fire","node","action","unsavedChanges","delete","hard","_this","remove","indexOf","transition","opacity","then","style","edit","call","addButton","tag","tagName","toLowerCase","containerSelector","container","closest","clear","propagate","_iteratorNormalCompletion2","_didIteratorError2","_iteratorError2","_step2","_iterator2","childNodes","save","_iteratorNormalCompletion3","_didIteratorError3","_iteratorError3","_step3","_iterator3","_item2","propagated","revert","_iteratorNormalCompletion4","_didIteratorError4","_iteratorError4","_step4","_iterator4","_item3","render","_this2","toArray","fragment","document","createDocumentFragment","forEach","datum","appendChild","insertBefore","slice","find","items","filter","ret","flatten","live","_mutable","needsEdit","hidden","className","classList","lazy","order","getAttribute","test","compareDocumentPosition","DOCUMENT_POSITION_FOLLOWING","closestCollection","parent","_this3","selector","group","button","contains","textContent","name","addEventListener","evt","preventDefault","_this4","attribute","swapUI","callback","sneak","ui","inside","descriptor","Object","getOwnPropertyDescriptor","prototype","defineProperty","_this5","set","_this6","_this7","itemControls","el","contents","title","events","click","replace","console","log","parentGroup","_this8","toggle","elementContents","_deleted","unit","isDeleted","Bliss"],"mappings":"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","file":"mavo.min.js","sourcesContent":["(function($, $$) {\n\nMavo.attributes.push(\"mv-multiple\", \"mv-order\");\n\nvar _ = Mavo.Collection = $.Class({\n\textends: Mavo.Node,\n\tnodeType: \"Collection\",\n\tconstructor: function (element, mavo, o) {\n\t\t/*\n\t\t * Create the template, remove it from the DOM and store it\n\t\t */\n\t\tthis.templateElement = this.element;\n\n\t\tthis.children = [];\n\n\t\t// ALL descendant property names as an array\n\t\tif (!this.fromTemplate(\"properties\", \"mutable\", \"templateElement\")) {\n\t\t\tthis.properties = $$(Mavo.selectors.property, this.templateElement).map(Mavo.Node.getProperty);\n\t\t\tthis.mutable = this.templateElement.matches(Mavo.selectors.multiple);\n\n\t\t\t// Must clone because otherwise once expressions are parsed on the template element\n\t\t\t// we will not be able to pick them up from subsequent items\n\t\t\tthis.templateElement = this.templateElement.cloneNode(true);\n\t\t}\n\n\t\tif (this.mutable) {\n\t\t\tvar item = this.createItem(this.element);\n\t\t\tthis.add(item);\n\t\t\tthis.itemTemplate = item.template || item;\n\t\t}\n\n\t\tMavo.hooks.run(\"collection-init-end\", this);\n\t},\n\n\tget length() {\n\t\treturn this.children.length;\n\t},\n\n\t// Collection still contains its template as data\n\tget containsTemplate() {\n\t\treturn this.children.length && this.children[0].element === this.element;\n\t},\n\n\tgetData: function(o = {}) {\n\t\tvar env = {\n\t\t\tcontext: this,\n\t\t\toptions: o,\n\t\t\tdata: []\n\t\t};\n\n\t\tfor (item of this.children) {\n\t\t\tif (!item.deleted) {\n\t\t\t\tlet itemData = item.getData(env.options);\n\n\t\t\t\tif (itemData) {\n\t\t\t\t\tenv.data.push(itemData);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (this.unhandled && env.options.unhandled) {\n\t\t\tenv.data = this.unhandled.before.concat(env.data, this.unhandled.after);\n\t\t}\n\n\t\tif (!this.mutable && env.data.length == 1) {\n\t\t\t// See https://github.com/LeaVerou/mavo/issues/50#issuecomment-266079652\n\t\t\tenv.data = env.data[0];\n\t\t}\n\n\t\tMavo.hooks.run(\"collection-getdata-end\", env);\n\n\t\treturn env.data;\n\t},\n\n\t// Create item but don't insert it anywhere\n\t// Mostly used internally\n\tcreateItem: function (element) {\n\t\tif (!element) {\n\t\t\telement = this.templateElement.cloneNode(true);\n\t\t}\n\n\t\tvar item = Mavo.Node.create(element, this.mavo, {\n\t\t\tcollection: this,\n\t\t\ttemplate: this.itemTemplate || (this.template? this.template.itemTemplate : null),\n\t\t\tproperty: this.property,\n\t\t\ttype: this.type\n\t\t});\n\n\t\treturn item;\n\t},\n\n\t/**\n\t * Add a new item to this collection\n\t * @param item {Node|Mavo.Node} Optional. Element or Mavo object for the new item\n\t * @param index {Number} Optional. Index of existing item, will be added opposite to list direction\n\t * @param silent {Boolean} Optional. Throw a datachange event? Mainly used internally.\n\t */\n\tadd: function(item, index, o = {}) {\n\t\tif (item instanceof Node) {\n\t\t\titem = Mavo.Node.get(item) || this.createItem(item);\n\t\t}\n\t\telse {\n\t\t\titem = item || this.createItem();\n\t\t}\n\n\t\tif (index in this.children) {\n\t\t\tif (this.bottomUp) {\n\t\t\t\tindex++;\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tindex = this.bottomUp? 0 : this.length;\n\t\t}\n\n\t\tif (!item.element.parentNode) {\n\t\t\t// Add it to the DOM, if not already in\n\t\t\tvar nextItem = this.children[index];\n\n\t\t\titem.element._.before(nextItem && nextItem.element || this.marker);\n\t\t}\n\n\t\t// Update internal data model\n\t\tthis.children.splice(index, 0, item);\n\n\t\tfor (let i = index - 1; i < this.length; i++) {\n\t\t\tlet item = this.children[i];\n\n\t\t\tif (item) {\n\t\t\t\titem.index = i;\n\n\t\t\t\tif (!o.silent) {\n\t\t\t\t\titem.element._.fire(\"mavo:datachange\", {\n\t\t\t\t\t\tnode: this,\n\t\t\t\t\t\tmavo: this.mavo,\n\t\t\t\t\t\taction: \"add\",\n\t\t\t\t\t\titem\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (!o.silent) {\n\t\t\tthis.unsavedChanges = item.unsavedChanges = this.mavo.unsavedChanges = true;\n\t\t}\n\n\t\treturn item;\n\t},\n\n\tdelete: function(item, hard) {\n\t\tif (hard) {\n\t\t\t// Hard delete\n\t\t\t$.remove(item.element);\n\t\t\tthis.children.splice(this.children.indexOf(item), 1);\n\t\t\treturn;\n\t\t}\n\n\t\treturn $.transition(item.element, {opacity: 0}).then(() => {\n\t\t\titem.deleted = true; // schedule for deletion\n\t\t\titem.element.style.opacity = \"\";\n\n\t\t\titem.element._.fire(\"mavo:datachange\", {\n\t\t\t\tnode: this,\n\t\t\t\tmavo: this.mavo,\n\t\t\t\taction: \"delete\",\n\t\t\t\titem: item\n\t\t\t});\n\n\t\t\tthis.unsavedChanges = item.unsavedChanges = this.mavo.unsavedChanges = true;\n\t\t});\n\t},\n\n\tedit: function() {\n\t\tthis.super.edit.call(this);\n\n\t\tif (this.mutable) {\n\t\t\t// Insert the add button if it's not already in the DOM\n\t\t\tif (!this.addButton.parentNode) {\n\t\t\t\tif (this.bottomUp) {\n\t\t\t\t\tthis.addButton._.before($.value(this.children[0], \"element\") || this.marker);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tvar tag = this.element.tagName.toLowerCase();\n\t\t\t\t\tvar containerSelector = Mavo.selectors.container[tag];\n\n\t\t\t\t\tif (containerSelector) {\n\t\t\t\t\t\tvar after = this.marker.closest(containerSelector);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.addButton._.after(after && after.parentNode? after : this.marker);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\tdone: function() {\n\t\tthis.super.done.call(this);\n\n\t\tif (this.mutable) {\n\t\t\tif (this.addButton.parentNode) {\n\t\t\t\tthis.addButton.remove();\n\t\t\t}\n\t\t}\n\t},\n\n\t/**\n\t * Delete all items in the collection.\n\t */\n\tclear: function() {\n\t\tif (this.mutable) {\n\t\t\tthis.propagate(item => {\n\t\t\t\tif (item.element.remove) {\n\t\t\t\t\titem.element.remove();\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// Document fragment, remove all children\n\t\t\t\t\tfor (let node of item.element.childNodes) {\n\t\t\t\t\t\tnode => node.remove();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tthis.children = [];\n\n\t\t\tthis.marker._.fire(\"mavo:datachange\", {\n\t\t\t\tnode: this,\n\t\t\t\tmavo: this.mavo,\n\t\t\t\taction: \"clear\"\n\t\t\t});\n\t\t}\n\t},\n\n\tsave: function() {\n\t\tfor (let item of this.children) {\n\t\t\tif (item.deleted) {\n\t\t\t\tthis.delete(item, true);\n\t\t\t}\n\t\t\telse {\n\t\t\t\titem.unsavedChanges = false;\n\t\t\t}\n\t\t}\n\t},\n\n\tpropagated: [\"save\"],\n\n\trevert: function() {\n\t\tfor (let item of this.children) {\n\t\t\t// Delete added items\n\t\t\tif (item.unsavedChanges) {\n\t\t\t\tthis.delete(item, true);\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Bring back deleted items\n\t\t\t\tif (item.deleted) {\n\t\t\t\t\titem.deleted = false;\n\t\t\t\t}\n\n\t\t\t\t// Revert all properties\n\t\t\t\titem.revert();\n\t\t\t}\n\t\t}\n\t},\n\n\trender: function(data) {\n\t\tthis.unhandled = {before: [], after: []};\n\n\t\tif (!data) {\n\t\t\treturn;\n\t\t}\n\n\t\tdata = Mavo.toArray(data);\n\n\t\tif (!this.mutable) {\n\t\t\tthis.children.forEach((item, i) => item.render(data && data[i]));\n\n\t\t\tif (data) {\n\t\t\t\tthis.unhandled.after = data.slice(this.children.length);\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tthis.clear();\n\n\t\t\t// Using document fragments improved rendering performance by 60%\n\t\t\tvar fragment = document.createDocumentFragment();\n\n\t\t\tdata.forEach((datum, i) => {\n\t\t\t\tvar item = this.createItem();\n\n\t\t\t\titem.render(datum);\n\n\t\t\t\tthis.children.push(item);\n\t\t\t\titem.index = i;\n\n\t\t\t\tfragment.appendChild(item.element);\n\t\t\t});\n\n\t\t\tthis.marker.parentNode.insertBefore(fragment, this.marker);\n\t\t}\n\n\t\tthis.save();\n\t},\n\n\tfind: function(property) {\n\t\tvar items = this.children.filter(item => !item.deleted);\n\n\t\tif (this.property == property) {\n\t\t\treturn items;\n\t\t}\n\n\t\tif (this.properties.indexOf(property) > -1) {\n\t\t\tvar ret = items.map(item => item.find(property));\n\n\t\t\treturn Mavo.flatten(ret);\n\t\t}\n\t},\n\n\tlive: {\n\t\tmutable: function(value) {\n\t\t\tif (value && value !== this.mutable) {\n\t\t\t\t// Why is all this code here? Because we want it executed\n\t\t\t\t// every time mutable changes, not just in the constructor\n\t\t\t\t// (think multiple elements with the same property name, where only one has mv-multiple)\n\t\t\t\tthis._mutable = value;\n\n\t\t\t\tthis.mavo.needsEdit = true;\n\n\t\t\t\t// Keep position of the template in the DOM, since we might remove it\n\t\t\t\tthis.marker = $.create(\"div\", {\n\t\t\t\t\thidden: true,\n\t\t\t\t\tclassName: \"mv-marker\",\n\t\t\t\t\tafter: this.templateElement\n\t\t\t\t});\n\n\t\t\t\tthis.templateElement.classList.add(\"mv-item\");\n\t\t\t}\n\t\t}\n\t},\n\n\tlazy: {\n\t\tbottomUp: function() {\n\t\t\t/*\n\t\t\t * Add new items at the top or bottom?\n\t\t\t */\n\n\t\t\tif (!this.mutable) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tvar order = this.templateElement.getAttribute(\"mv-order\");\n\t\t\tif (order !== null) {\n\t\t\t\t// Attribute has the highest priority and overrides any heuristics\n\t\t\t\treturn /^desc\\b/i.test(order);\n\t\t\t}\n\n\t\t\tif (!this.addButton.parentNode) {\n\t\t\t\t// If add button not in DOM, do the default\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// If add button is already in the DOM and *before* our template, then we default to prepending\n\t\t\treturn !!(this.addButton.compareDocumentPosition(this.templateElement) & Node.DOCUMENT_POSITION_FOLLOWING);\n\t\t},\n\n\t\tclosestCollection: function() {\n\t\t\tvar parent = this.marker? this.marker.parentNode : this.templateElement.parentNode;\n\n\t\t\treturn parent.closest(Mavo.selectors.item);\n\t\t},\n\n\t\taddButton: function() {\n\t\t\t// Find add button if provided, or generate one\n\t\t\tvar selector = `button.mv-add-${this.property}`;\n\t\t\tvar group = this.closestCollection || this.marker.closest(Mavo.selectors.group);\n\n\t\t\tif (group) {\n\t\t\t\tvar button = $$(selector, group).filter(button => {\n\t\t\t\t\treturn !this.templateElement.contains(button);\n\t\t\t\t})[0];\n\t\t\t}\n\n\t\t\tif (!button) {\n\t\t\t\tbutton = $.create(\"button\", {\n\t\t\t\t\tclassName: \"mv-add\",\n\t\t\t\t\ttextContent: \"Add \" + this.name\n\t\t\t\t});\n\t\t\t};\n\n\t\t\tbutton.classList.add(\"mv-ui\", \"mv-add\");\n\n\t\t\tif (this.property) {\n\t\t\t\tbutton.classList.add(`mv-add-${this.property}`);\n\t\t\t}\n\n\t\t\tbutton.addEventListener(\"click\", evt => {\n\t\t\t\tevt.preventDefault();\n\n\t\t\t\tthis.add().edit();\n\t\t\t});\n\n\t\t\treturn button;\n\t\t}\n\t}\n});\n\nMavo.hooks.add(\"primitive-init-end\", function() {\n\tif (this.collection && !this.attribute) {\n\t\t// Collection of primitives, deal with setting textContent etc without the UI interfering.\n\t\tvar swapUI = callback => {\n\t\t\tvar ret;\n\n\t\t\tthis.sneak(() => {\n\t\t\t\tvar ui = $.remove($(\".mv-item-controls\", this.element));\n\n\t\t\t\tret = callback();\n\n\t\t\t\t$.inside(ui, this.element);\n\t\t\t});\n\n\t\t\treturn ret;\n\t\t};\n\n\t\t// Intercept certain properties so that any Mavo UI inside this primitive will not be destroyed\n\t\t[\"textContent\", \"innerHTML\"].forEach(property => {\n\t\t\tvar descriptor = Object.getOwnPropertyDescriptor(Node.prototype, property);\n\n\t\t\tObject.defineProperty(this.element, property, {\n\t\t\t\tget: function() {\n\t\t\t\t\treturn swapUI(() => descriptor.get.call(this));\n\t\t\t\t},\n\n\t\t\t\tset: function(value) {\n\t\t\t\t\tswapUI(() => descriptor.set.call(this, value));\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n});\n\nMavo.hooks.add(\"node-edit-end\", function() {\n\tif (this.collection) {\n\t\tif (!this.itemControls) {\n\t\t\tthis.itemControls = $$(\".mv-item-controls\", this.element)\n\t\t\t\t\t\t\t\t   .filter(el => el.closest(Mavo.selectors.item) == this.element)[0];\n\n\t\t\tthis.itemControls = this.itemControls || $.create({\n\t\t\t\tclassName: \"mv-item-controls mv-ui\"\n\t\t\t});\n\n\t\t\t$.set(this.itemControls, {\n\t\t\t\tcontents: [\n\t\t\t\t\t{\n\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\ttitle: \"Delete this \" + this.name,\n\t\t\t\t\t\tclassName: \"mv-delete\",\n\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\"click\": evt => this.collection.delete(this)\n\t\t\t\t\t\t}\n\t\t\t\t\t}, {\n\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\ttitle: `Add new ${this.name.replace(/s$/i, \"\")} ${this.bottomUp? \"after\" : \"before\"}`,\n\t\t\t\t\t\tclassName: \"mv-add\",\n\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\"click\": evt => this.collection.add(null, this.children.indexOf(item)).edit()\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t]\n\t\t\t});\n\t\t}\n\n\t\tif (!this.itemControls.parentNode) {\n\t\t\tthis.element.appendChild(this.itemControls);\n\t\t}\n\t}\n});\n\nMavo.hooks.add(\"node-done-end\", function() {\n\tif (this.collection) {\n\t\tif (this.itemControls) {\n\t\t\tthis.itemControls.remove();\n\t\t}\n\t}\n});\n\n$.lazy(Mavo.Node.prototype, \"closestCollection\", function() {\n\tif (!this.group) {\n\t\tconsole.log(this.nodeType);\n\t}\n\treturn this.collection ||\n\t\t   this.group.collection ||\n\t\t   (this.parentGroup? this.parentGroup.closestCollection : null);\n});\n\n$.live(Mavo.Node.prototype, \"deleted\", function(value) {\n\tthis.element.classList.toggle(\"mv-deleted\", value);\n\n\tif (value) {\n\t\t// Soft delete, store element contents in a fragment\n\t\t// and replace them with an undo prompt.\n\t\tthis.elementContents = document.createDocumentFragment();\n\t\t$$(this.element.childNodes).forEach(node => {\n\t\t\tthis.elementContents.appendChild(node);\n\t\t});\n\n\t\t$.contents(this.element, [\n\t\t\t{\n\t\t\t\ttag: \"button\",\n\t\t\t\tclassName: \"mv-close mv-ui\",\n\t\t\t\ttextContent: \"Ã—\",\n\t\t\t\tevents: {\n\t\t\t\t\t\"click\": function(evt) {\n\t\t\t\t\t\t$.remove(this.parentNode);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t\t\"Deleted \" + this.name,\n\t\t\t{\n\t\t\t\ttag: \"button\",\n\t\t\t\tclassName: \"mv-undo mv-ui\",\n\t\t\t\ttextContent: \"Undo\",\n\t\t\t\tevents: {\n\t\t\t\t\t\"click\": evt => this.deleted = false\n\t\t\t\t}\n\t\t\t}\n\t\t]);\n\n\t\tthis.element.classList.remove(\"mv-delete-hover\");\n\t}\n\telse if (this.deleted) {\n\t\t// Undelete\n\t\tthis.element.textContent = \"\";\n\t\tthis.element.appendChild(this.elementContents);\n\n\t\t// otherwise expressions won't update because this will still seem as deleted\n\t\t// Alternatively, we could fire datachange with a timeout.\n\t\tthis._deleted = false;\n\n\t\t$.fire(this.element, \"mavo:datachange\", {\n\t\t\tunit: this.collection,\n\t\t\tmavo: this.mavo,\n\t\t\taction: \"undelete\",\n\t\t\titem: this\n\t\t});\n\t}\n});\n\n/**\n * Check if this unit is either deleted or inside a deleted group\n */\nMavo.Node.prototype.isDeleted = function() {\n\tvar ret = this.deleted;\n\n\tif (this.deleted) {\n\t\treturn true;\n\t}\n\n\treturn !!this.parentGroup && this.parentGroup.isDeleted();\n};\n\nMavo.hooks.add(\"node-init-end\", function(env) {\n\tthis.collection = env.options.collection;\n\n\tif (this.collection) {\n\t\t// This is a collection item\n\t\tthis.group = this.parentGroup = this.collection.parentGroup;\n\t}\n});\n\n})(Bliss, Bliss.$);\n"],"sourceRoot":"/source/"}