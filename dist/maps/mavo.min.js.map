{"version":3,"sources":["mavo.js"],"names":["_toConsumableArray","arr","Array","isArray","i","arr2","length","from","$","$$","_","self","Mavo","Class","constructor","element","_this","this","index","all","push","id","getAttribute","Node","getProperty","unhandled","classList","contains","autoEdit","has","is","selectors","rootScope","setAttribute","removeAttribute","add","storage","urlParam","source","wrapper","closest","test","Backend","create","permissions","Permissions","property","scope","concat","forEach","hasAttribute","addEventListener","evt","keyCode","superKey","preventDefault","save","primitive","isScope","not","formControl","Primitive","getValueAttribute","matches","around","parentNode","ui","bar","className","start","status","inside","authControls","can","loginHash","login","tag","href","textContent","events","click","after","location","hash","history","replaceState","document","title","URL","window","remove","unbind","backend","innerHTML","contents","name","e","logout","needsEdit","hooks","run","root","setUnsavedChanges","onchange","_ref","action","value","toggle","edit","onclick","editing","done","mouseenter focus","mouseleave blur","revert","disabled","unsavedChanges","clear","appendChild","cannot","load","on","fire","off","data","getData","o","toJSON","arguments","undefined","render","context","confirm","store","target","item","type","parent","walk","obj","_this2","inProgress","ready","then","get","err","Promise","reject","response","JSON","parse","xhr","console","error","log","stack","_this3","put","file","dataString","callback","live","set","static","navigator","platform","indexOf","init","container","map","Hooks","s","specificProperty","multiple","required","computed","option","li","tr","dt","dd","documentFragment","selector","split","join","or","selector1","selector2","and","ret","s1","apply","s2","andNot","extend","output","autoMultiple","include","Intl","documentElement","Stretchy","filter","Bliss"],"mappings":"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","file":"mavo.min.js","sourcesContent":["(function ($, $$) {\n\n\"use strict\";\n\nvar _ = self.Mavo = $.Class({\n\tconstructor: function (element) {\n\t\t// Index among other mavos in the page, 1 is first\n\t\tthis.index = _.all.push(this);\n\n\t\t// Assign a unique (for the page) id to this mavo instance\n\t\tthis.id = element.getAttribute(\"data-mavo\") || Mavo.Node.getProperty(element) || element.id || `mavo${this.index}`;\n\n\t\tthis.unhandled = element.classList.contains(\"mv-keep-unhandled\");\n\n\t\tthis.autoEdit = _.has(\"autoedit\", element);\n\n\t\tthis.element = _.is(\"scope\", element)? element : $(_.selectors.rootScope, element);\n\n\t\tif (!this.element) {\n\t\t\telement.setAttribute(\"typeof\", element.getAttribute(\"property\") || \"\");\n\t\t\telement.removeAttribute(\"property\");\n\t\t\tthis.element = element;\n\t\t}\n\n\t\tthis.element.classList.add(\"mv-root\");\n\n\t\tif (this.index == 1) {\n\t\t\tthis.storage = _.urlParam(\"store\");\n\t\t\tthis.source = _.urlParam(\"source\");\n\t\t}\n\n\t\tthis.wrapper = element.closest(\".mv-wrapper\") || element;\n\n\t\tthis.storage = this.storage || _.urlParam(`${this.id}_store`) || element.getAttribute(\"data-store\") || null;\n\t\tthis.source = this.source || _.urlParam(`${this.id}_source`) || element.getAttribute(\"data-source\") || null;\n\n\t\tif (this.storage && !/^\\s*none\\s*$/i.test(this.storage)) {\n\t\t\tthis.storage = _.Backend.create(this.storage, this);\n\t\t}\n\n\t\tif (this.source) {\n\t\t\tthis.source = _.Backend.create(this.source, this);\n\t\t}\n\n\t\tthis.permissions = this.storage ? this.storage.permissions : new Mavo.Permissions();\n\n\t\t// Apply heuristic for collections\n\t\t$$(_.selectors.property + \", \" + _.selectors.scope, element).concat([this.element]).forEach(element => {\n\t\t\tif (_.is(\"autoMultiple\", element) && !element.hasAttribute(\"data-multiple\")) {\n\t\t\t\telement.setAttribute(\"data-multiple\", \"\");\n\t\t\t}\n\t\t});\n\n\t\t// Ctrl + S or Cmd + S to save\n\t\tthis.wrapper.addEventListener(\"keydown\", evt => {\n\t\t\tif (evt.keyCode == 83 && evt[_.superKey]) {\n\t\t\t\tevt.preventDefault();\n\t\t\t\tthis.save();\n\t\t\t}\n\t\t});\n\n\t\t// Apply heuristic for scopes\n\t\t$$(_.selectors.primitive, element).forEach(element => {\n\t\t\tvar isScope = $(`${_.selectors.not(_.selectors.formControl)}, ${_.selectors.property}`, element) && (// Contains other properties or non-form elements and...\n\t\t\t                Mavo.is(\"multiple\", element) || // is a collection...\n\t\t\t                Mavo.Primitive.getValueAttribute(element) === null  // ...or its content is not in an attribute\n\t\t\t\t\t\t) || element.matches(\"template\");\n\n\t\t\tif (isScope) {\n\t\t\t\telement.setAttribute(\"typeof\", \"\");\n\t\t\t}\n\t\t});\n\n\t\tif (this.wrapper === this.element && _.is(\"multiple\", element)) {\n\t\t\t// Need to create a wrapper\n\t\t\tvar around = this.element;\n\n\t\t\t// Avoid producing invalid HTML\n\t\t\tif (this.element.matches(\"li, option\")) {\n\t\t\t\taround = around.parentNode;\n\t\t\t}\n\t\t\telse if (this.element.matches(\"td, tr, tbody, thead, tfoot\")) {\n\t\t\t\taround = around.closest(\"table\");\n\t\t\t}\n\n\t\t\tthis.wrapper = $.create({ around });\n\t\t}\n\n\t\tthis.wrapper.classList.add(\"mv-wrapper\");\n\n\t\tthis.ui = {\n\t\t\tbar: $(\".mv-bar\", this.wrapper) || $.create({\n\t\t\t\tclassName: \"mv-bar mv-ui\",\n\t\t\t\tstart: this.wrapper\n\t\t\t})\n\t\t};\n\n\t\tthis.ui.status = $(\".status\", this.ui.bar) || $.create(\"span\", {\n\t\t\tclassName: \"status\",\n\t\t\tinside: this.ui.bar\n\t\t});\n\n\t\tif (this.storage) {\n\t\t\t// Reflect backend permissions in global permissions\n\t\t\tthis.authControls = {};\n\n\t\t\tthis.permissions.can(\"login\", () => {\n\t\t\t\t// #login authenticates if only 1 mavo on the page, or if the first.\n\t\t\t\t// Otherwise, we have to generate a slightly more complex hash\n\t\t\t\tthis.loginHash = \"#login\" + (Mavo.all[0] === this? \"\" : \"-\" + this.id);\n\n\t\t\t\tthis.authControls.login = $.create({\n\t\t\t\t\ttag: \"a\",\n\t\t\t\t\thref: this.loginHash,\n\t\t\t\t\ttextContent: \"Login\",\n\t\t\t\t\tclassName: \"login button\",\n\t\t\t\t\tevents: {\n\t\t\t\t\t\tclick: evt => {\n\t\t\t\t\t\t\tevt.preventDefault();\n\t\t\t\t\t\t\tthis.login();\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\tafter: $(\".status\", this.ui.bar)\n\t\t\t\t});\n\n\t\t\t\t// We also support a hash to trigger login, in case the user doesn't want visible login UI\n\t\t\t\tvar login;\n\t\t\t\t(login = () => {\n\t\t\t\t\tif (location.hash === this.loginHash) {\n\t\t\t\t\t\t// This just does location.hash = \"\" without getting a pointless # at the end of the URL\n\t\t\t\t\t\thistory.replaceState(null, document.title, new URL(\"\", location) + \"\");\n\t\t\t\t\t\tthis.login();\n\t\t\t\t\t}\n\t\t\t\t})();\n\t\t\t\twindow.addEventListener(\"hashchange.mavo\", login);\n\t\t\t}, () => {\n\t\t\t\t$.remove(this.authControls.login);\n\t\t\t\tthis.wrapper._.unbind(\"hashchange.mavo\");\n\t\t\t});\n\n\t\t\t// Update login status\n\t\t\tthis.wrapper.addEventListener(\"mavo:login.mavo\", evt => {\n\t\t\t\tif (evt.backend == this.storage) { // ignore logins from source backend\n\t\t\t\t\tvar status = $(\".status\", this.ui.bar);\n\t\t\t\t\tstatus.innerHTML = \"\";\n\t\t\t\t\tstatus._.contents([\n\t\t\t\t\t\t\"Logged in to \" + evt.backend.id + \" as \",\n\t\t\t\t\t\t{tag: \"strong\", innerHTML: evt.name},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\t\ttextContent: \"Logout\",\n\t\t\t\t\t\t\tclassName: \"logout\",\n\t\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\tclick: e => evt.backend.logout()\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t}\n\t\t\t\t\t]);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tthis.wrapper.addEventListener(\"mavo:logout.mavo\", evt => {\n\t\t\t\t$(\".status\", this.ui.bar).textContent = \"\";\n\t\t\t});\n\t\t}\n\n\t\t// Is there any control that requires an edit button?\n\t\tthis.needsEdit = false;\n\n\t\t// Build mavo objects\n\t\tMavo.hooks.run(\"init-tree-before\", this);\n\n\t\tthis.root = Mavo.Node.create(this.element, this);\n\n\t\tMavo.hooks.run(\"init-tree-after\", this);\n\n\t\tthis.setUnsavedChanges(false);\n\n\t\tthis.permissions.onchange(({action, value}) => {\n\t\t\tthis.wrapper.classList.toggle(`can-${action}`, value);\n\t\t});\n\n\t\tthis.permissions.can([\"edit\", \"add\", \"delete\"], () => {\n\t\t\tthis.ui.edit = $.create(\"button\", {\n\t\t\t\tclassName: \"edit\",\n\t\t\t\ttextContent: \"Edit\",\n\t\t\t\tonclick: e => this.editing? this.done() : this.edit(),\n\t\t\t\tinside: this.ui.bar\n\t\t\t});\n\n\t\t\tif (this.autoEdit) {\n\t\t\t\tthis.wrapper.addEventListener(\"mavo:load\", evt => this.ui.edit.click());\n\t\t\t}\n\t\t}, () => { // cannot\n\t\t\t$.remove(this.ui.edit);\n\n\t\t\tif (this.editing) {\n\t\t\t\tthis.done();\n\t\t\t}\n\t\t});\n\n\t\tif (this.needsEdit) {\n\t\t\tthis.permissions.can(\"save\", () => {\n\t\t\t\tthis.ui.save = $.create(\"button\", {\n\t\t\t\t\tclassName: \"save\",\n\t\t\t\t\ttextContent: \"Save\",\n\t\t\t\t\tevents: {\n\t\t\t\t\t\tclick: e => this.save(),\n\t\t\t\t\t\t\"mouseenter focus\": e => {\n\t\t\t\t\t\t\tthis.wrapper.classList.add(\"save-hovered\");\n\t\t\t\t\t\t\tthis.setUnsavedChanges();\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"mouseleave blur\": e => this.wrapper.classList.remove(\"save-hovered\")\n\t\t\t\t\t},\n\t\t\t\t\tinside: this.ui.bar\n\t\t\t\t});\n\n\t\t\t\tthis.ui.revert = $.create(\"button\", {\n\t\t\t\t\tclassName: \"revert\",\n\t\t\t\t\ttextContent: \"Revert\",\n\t\t\t\t\tdisabled: true,\n\t\t\t\t\tevents: {\n\t\t\t\t\t\tclick: e => this.revert(),\n\t\t\t\t\t\t\"mouseenter focus\": e => {\n\t\t\t\t\t\t\tif (!this.unsavedChanges) {\n\t\t\t\t\t\t\t\tthis.wrapper.classList.add(\"revert-hovered\");\n\t\t\t\t\t\t\t\tthis.setUnsavedChanges();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"mouseleave blur\": e => this.wrapper.classList.remove(\"revert-hovered\")\n\t\t\t\t\t},\n\t\t\t\t\tinside: this.ui.bar\n\t\t\t\t});\n\t\t\t}, () => {\n\t\t\t\t$.remove([this.ui.save, this.ui.revert]);\n\t\t\t\tthis.ui.save = this.ui.revert = null;\n\t\t\t});\n\t\t}\n\n\t\tthis.permissions.can(\"delete\", () => {\n\t\t\tthis.ui.clear = $.create(\"button\", {\n\t\t\t\tclassName: \"clear\",\n\t\t\t\ttextContent: \"Clear\",\n\t\t\t\tonclick: e => this.clear()\n\t\t\t});\n\n\t\t\tthis.ui.bar.appendChild(this.ui.clear);\n\t\t});\n\n\t\tthis.permissions.cannot([\"delete\", \"edit\"], () => {\n\t\t\t$.remove(this.ui.clear);\n\t\t});\n\n\t\tif (this.storage || this.source) {\n\t\t\t// Fetch existing data\n\t\t\tthis.permissions.can(\"read\", () => this.load());\n\t\t}\n\t\telse {\n\t\t\t// No storage\n\t\t\tthis.permissions.on([\"read\", \"edit\"]);\n\n\t\t\t$.fire(this.wrapper, \"mavo:load\");\n\t\t}\n\n\t\tif (!this.needsEdit) {\n\t\t\tthis.permissions.off([\"edit\", \"add\", \"delete\"]);\n\t\t}\n\n\t\tMavo.hooks.run(\"init-end\", this);\n\t},\n\n\tget data() {\n\t\treturn this.getData();\n\t},\n\n\tgetData: function(o) {\n\t\treturn this.root.getData(o);\n\t},\n\n\ttoJSON: function(data = this.data) {\n\t\treturn _.toJSON(data);\n\t},\n\n\trender: function(data) {\n\t\t_.hooks.run(\"render-start\", {context: this, data});\n\n\t\tif (data) {\n\t\t\tif (this.editing) {\n\t\t\t\tthis.done();\n\t\t\t\tthis.root.render(data);\n\t\t\t\tthis.edit();\n\t\t\t}\n\t\t\telse {\n\t\t\t\tthis.root.render(data);\n\t\t\t}\n\n\t\t}\n\n\t\tthis.unsavedChanges = false;\n\t},\n\n\tclear: function() {\n\t\tif (confirm(\"This will delete all your data. Are you sure?\")) {\n\t\t\tthis.store(null);\n\t\t\tthis.root.clear();\n\t\t}\n\t},\n\n\tedit: function() {\n\t\tthis.editing = true;\n\n\t\tthis.root.edit();\n\n\t\t$.events(this.wrapper, \"mouseenter.mavo:edit mouseleave.mavo:edit\", evt => {\n\t\t\tif (evt.target.matches(\".mv-item-controls .delete\")) {\n\t\t\t\tvar item = evt.target.closest(_.selectors.item);\n\t\t\t\titem.classList.toggle(\"delete-hover\", evt.type == \"mouseenter\");\n\t\t\t}\n\n\t\t\tif (evt.target.matches(_.selectors.item)) {\n\t\t\t\tevt.target.classList.remove(\"has-hovered-item\");\n\n\t\t\t\tvar parent = evt.target.parentNode.closest(_.selectors.item);\n\n\t\t\t\tif (parent) {\n\t\t\t\t\tparent.classList.toggle(\"has-hovered-item\", evt.type == \"mouseenter\");\n\t\t\t\t}\n\t\t\t}\n\t\t}, true);\n\n\t\tthis.setUnsavedChanges();\n\t},\n\n\t/**\n\t * Set this mavo instanceâ€™s unsavedChanges flag.\n\t * @param {Boolean} [value]\n\t *        If true, just sets the flag to true, no traversal.\n\t *        If false, sets the flag of the Mavo instance and every tree node to false\n\t *        If not provided, traverses the tree and recalculates the flag value.\n\t */\n\tsetUnsavedChanges: function(value) {\n\t\tvar unsavedChanges = !!value;\n\n\t\tif (!value) {\n\t\t\tthis.walk(obj => {\n\t\t\t\tif (obj.unsavedChanges) {\n\t\t\t\t\tunsavedChanges = true;\n\n\t\t\t\t\tif (value === false) {\n\t\t\t\t\t\tobj.unsavedChanges = false;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\treturn this.unsavedChanges = unsavedChanges;\n\t},\n\n\t// Conclude editing\n\tdone: function() {\n\t\tthis.root.done();\n\t\t$.unbind(this.wrapper, \".mavo:edit\");\n\t\tthis.editing = false;\n\t\tthis.unsavedChanges = false;\n\t},\n\n\t/**\n\t * load - Fetch data from source and render it.\n\t *\n\t * @return {Promise}  A promise that resolves when the data is loaded.\n\t */\n\tload: function() {\n\t\tthis.inProgress = \"Loading\";\n\n\t\tvar backend = this.storage || this.source;\n\n\t\treturn backend.ready.then(() => backend.get())\n\t\t.catch(err => {\n\t\t\t// Try again with source\n\t\t\tif (this.source && backend !== this.source) {\n\t\t\t\treturn this.source.ready.then(() => this.source.get());\n\t\t\t}\n\n\t\t\treturn Promise.reject(err);\n\t\t})\n\t\t.then(response => {\n\t\t\tif (response && $.type(response) == \"string\") {\n\t\t\t\tresponse = JSON.parse(response);\n\t\t\t}\n\n\t\t\tthis.render(response);\n\t\t})\n\t\t.catch(err => {\n\t\t\tif (err) {\n\t\t\t\tif (err.xhr && err.xhr.status == 404) {\n\t\t\t\t\tthis.render(\"\");\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// TODO display error to user\n\t\t\t\t\tconsole.error(err);\n\t\t\t\t\tconsole.log(err.stack);\n\t\t\t\t}\n\t\t\t}\n\t\t})\n\t\t.then(() => {\n\t\t\tthis.inProgress = false;\n\t\t\t$.fire(this.wrapper, \"mavo:load\");\n\t\t});\n\t},\n\n\tstore: function() {\n\t\tif (!this.storage) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.inProgress = \"Saving\";\n\n\t\tthis.storage.login()\n\t\t.then(() => this.storage.put())\n\t\t.then(file => {\n\t\t\t$.fire(this.wrapper, \"mavo:save\", {\n\t\t\t\tdata: file.data,\n\t\t\t\tdataString: file.dataString\n\t\t\t});\n\t\t})\n\t\t.catch(err => {\n\t\t\tif (err) {\n\t\t\t\tconsole.error(err);\n\t\t\t\tconsole.log(err.stack);\n\t\t\t}\n\t\t})\n\t\t.then(() => {\n\t\t\tthis.inProgress = false;\n\t\t});\n\t},\n\n\tsave: function() {\n\t\tthis.root.save();\n\n\t\tthis.store();\n\n\t\tthis.unsavedChanges = false;\n\t},\n\n\trevert: function() {\n\t\tthis.root.revert();\n\t},\n\n\twalk: function(callback) {\n\t\tthis.root.walk(callback);\n\t},\n\n\tlive: {\n\t\tinProgress: function(value) {\n\t\t\tthis.wrapper[`${value? \"set\" : \"remove\"}Attribute`](\"data-mv-progress\", value);\n\t\t},\n\n\t\tediting: {\n\t\t\tset: function(value) {\n\t\t\t\tthis.wrapper.classList.toggle(\"editing\", value);\n\n\t\t\t\tif (value) {\n\t\t\t\t\tthis.wrapper.setAttribute(\"data-editing\", \"\");\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tthis.wrapper.removeAttribute(\"data-editing\");\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\n\t\tunsavedChanges: function(value) {\n\t\t\tthis.wrapper.classList.toggle(\"unsaved-changes\", value);\n\n\t\t\tif (this.ui && this.ui.save) {\n\t\t\t\tthis.ui.save.disabled = !value;\n\t\t\t\tthis.ui.revert.disabled = !value;\n\t\t\t}\n\t\t},\n\n\t\tneedsEdit: function(value) {\n\t\t\tthis.ui.bar[`${value? \"remove\" : \"set\"}Attribute`](\"hidden\", \"\");\n\t\t}\n\t},\n\n\tstatic: {\n\t\tall: [],\n\n\t\tsuperKey: navigator.platform.indexOf(\"Mac\") === 0? \"metaKey\" : \"ctrlKey\",\n\n\t\tinit: container => $$(_.selectors.init, container || document).map(element => new _(element)),\n\n\t\thooks: new $.Hooks()\n\t}\n});\n\n{\n\nlet s = _.selectors = {\n\tinit: \".mavo, [mavo], [data-mavo], [data-store]\",\n\tproperty: \"[property], [itemprop]\",\n\tspecificProperty: name => `[property=${name}], [itemprop=${name}]`,\n\tscope: \"[typeof], [itemscope], [itemtype], .mv-group\",\n\tmultiple: \"[multiple], [data-multiple], .multiple\",\n\trequired: \"[required], [data-required], .required\",\n\tformControl: \"input, select, option, textarea\",\n\tcomputed: \".computed\", // Properties or scopes with computed properties, will not be saved\n\titem: \".mv-item\",\n\tui: \".mv-ui\",\n\toption: name => `[${name}], [data-${name}], [data-mv-options~='${name}'], .${name}`,\n\tcontainer: {\n\t\t\"li\": \"ul, ol\",\n\t\t\"tr\": \"table\",\n\t\t\"option\": \"select\",\n\t\t\"dt\": \"dl\",\n\t\t\"dd\": \"dl\"\n\t},\n\tdocumentFragment: \".document-fragment\"\n};\n\nlet arr = s.arr = selector => selector.split(/\\s*,\\s*/g);\nlet not = s.not = selector => arr(selector).map(s => `:not(${s})`).join(\"\");\nlet or = s.or = (selector1, selector2) => selector1 + \", \" + selector2;\nlet and = s.and = (selector1, selector2) => {\n\tvar ret = [], arr2 = arr(selector2);\n\n\tarr(selector1).forEach(s1 => ret.push(...arr2.map(s2 => s1 + s2)));\n\n\treturn ret.join(\", \");\n};\nlet andNot = s.andNot = (selector1, selector2) => and(selector1, not(selector2));\n\n$.extend(_.selectors, {\n\tprimitive: andNot(s.property, s.scope),\n\trootScope: andNot(s.scope, s.property),\n\toutput: or(s.specificProperty(\"output\"), \".output, .value\"),\n\tautoMultiple: and(\"li, tr, option\", \":only-of-type\")\n});\n\n}\n\n// Init mavo\nPromise.all([\n\t$.ready(),\n\t$.include(Array.from && window.Intl && document.documentElement.closest, \"https://cdn.polyfill.io/v2/polyfill.min.js?features=blissfuljs,Intl.~locale.en\")\n])\n.catch(err => console.error(err))\n.then(() => Mavo.init());\n\nStretchy.selectors.filter = \".mv-editor:not([property])\";\n\n})(Bliss, Bliss.$);\n"],"sourceRoot":"/source/"}