{"version":3,"sources":["collection.js"],"names":["_toConsumableArray","arr","Array","isArray","i","arr2","length","from","$","$$","Mavo","attributes","push","_","Collection","Class","extends","Node","nodeType","constructor","element","mavo","o","this","templateElement","children","fromTemplate","properties","selectors","property","map","getProperty","mutable","matches","multiple","accepts","getAttribute","split","cloneNode","item","createItem","add","itemTemplate","template","hooks","run","getData","arguments","undefined","env","context","options","data","_iteratorNormalCompletion","_didIteratorError","_iteratorError","_step","_iterator","Symbol","iterator","next","done","value","deleted","itemData","err","unhandled","before","concat","after","create","collection","type","index","get","adopt","bottomUp","nextItem","marker","previousIndex","changed","splice","remove","silent","forEach","dataChanged","unsavedChanges","_len","actions","_key","_iteratorNormalCompletion2","_didIteratorError2","_iteratorError2","_step2","_iterator2","action","isNaN","indexOf","sort","a","b","_iteratorNormalCompletion3","_didIteratorError3","_iteratorError3","_step3","_iterator3","_action","_children","toArray","apply","_item","_this","walk","obj","closestCollection","copies","delete","hard","_this2","transition","opacity","then","style","edit","_this3","call","addButton","parentNode","tag","tagName","toLowerCase","containerSelector","container","closest","dragula","getDragula","clear","propagate","_iteratorNormalCompletion4","_didIteratorError4","_iteratorError4","_step4","_iterator4","childNodes","save","_iteratorNormalCompletion5","_didIteratorError5","_iteratorError5","_step5","_iterator5","_item2","propagated","revert","_iteratorNormalCompletion6","_didIteratorError6","_iteratorError6","_step6","_iterator6","_item3","dataRender","_this4","fragment","document","createDocumentFragment","datum","render","appendChild","insertBefore","slice","find","items","filter","collections","ret","flatten","isCompatible","c","live","_mutable","createComment","classList","_this5","pushUnique","containers","isContainer","el","root","moves","handle","contains","target","source","previous","previousElementSibling","lastElementChild","on","nextElementSibling","closestItem","cancel","dragulas","lazy","order","test","compareDocumentPosition","DOCUMENT_POSITION_FOLLOWING","parent","_this6","selector","group","button","className","textContent","name","addEventListener","evt","preventDefault","static","include","self","_this7","attribute","swapUI","callback","sneak","ui","inside","descriptor","Object","getOwnPropertyDescriptor","prototype","defineProperty","_this8","set","_this9","_this10","itemControls","contents","title","events","click","replace","superKey","inViewport","scrollIntoView","behavior","getClosestCollection","parentGroup","_this11","toggle","elementContents","node","_deleted","isDeleted","Bliss"],"mappings":"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","file":"mavo.min.js","sourcesContent":["(function($, $$) {\n\nMavo.attributes.push(\"mv-multiple\", \"mv-order\", \"mv-accepts\");\n\nvar _ = Mavo.Collection = $.Class({\n\textends: Mavo.Node,\n\tnodeType: \"Collection\",\n\tconstructor: function (element, mavo, o) {\n\t\t/*\n\t\t * Create the template, remove it from the DOM and store it\n\t\t */\n\t\tthis.templateElement = this.element;\n\n\t\tthis.children = [];\n\n\t\t// ALL descendant property names as an array\n\t\tif (!this.fromTemplate(\"properties\", \"mutable\", \"templateElement\", \"accepts\")) {\n\t\t\tthis.properties = $$(Mavo.selectors.property, this.templateElement).map(Mavo.Node.getProperty);\n\t\t\tthis.mutable = this.templateElement.matches(Mavo.selectors.multiple);\n\t\t\tthis.accepts = (this.templateElement.getAttribute(\"mv-accepts\") || \"\").split(/\\s+/);\n\n\t\t\t// Must clone because otherwise once expressions are parsed on the template element\n\t\t\t// we will not be able to pick them up from subsequent items\n\t\t\tthis.templateElement = this.templateElement.cloneNode(true);\n\t\t}\n\n\t\tif (this.mutable) {\n\t\t\tvar item = this.createItem(this.element);\n\t\t\tthis.add(item);\n\t\t\tthis.itemTemplate = item.template || item;\n\t\t}\n\n\t\tMavo.hooks.run(\"collection-init-end\", this);\n\t},\n\n\tget length() {\n\t\treturn this.children.length;\n\t},\n\n\tgetData: function(o = {}) {\n\t\tvar env = {\n\t\t\tcontext: this,\n\t\t\toptions: o,\n\t\t\tdata: []\n\t\t};\n\n\t\tfor (item of this.children) {\n\t\t\tif (!item.deleted) {\n\t\t\t\tlet itemData = item.getData(env.options);\n\n\t\t\t\tif (itemData) {\n\t\t\t\t\tenv.data.push(itemData);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (this.unhandled && env.options.unhandled) {\n\t\t\tenv.data = this.unhandled.before.concat(env.data, this.unhandled.after);\n\t\t}\n\n\t\tif (!this.mutable && env.data.length == 1) {\n\t\t\t// See https://github.com/LeaVerou/mavo/issues/50#issuecomment-266079652\n\t\t\tenv.data = env.data[0];\n\t\t}\n\n\t\tMavo.hooks.run(\"node-getdata-end\", env);\n\n\t\treturn env.data;\n\t},\n\n\t// Create item but don't insert it anywhere\n\t// Mostly used internally\n\tcreateItem: function (element) {\n\t\tif (!element) {\n\t\t\telement = this.templateElement.cloneNode(true);\n\t\t}\n\n\t\tvar item = Mavo.Node.create(element, this.mavo, {\n\t\t\tcollection: this,\n\t\t\ttemplate: this.itemTemplate || (this.template? this.template.itemTemplate : null),\n\t\t\tproperty: this.property,\n\t\t\ttype: this.type\n\t\t});\n\n\t\treturn item;\n\t},\n\n\t/**\n\t * Add a new item to this collection\n\t * @param item {Node|Mavo.Node} Optional. Element or Mavo object for the new item\n\t * @param index {Number} Optional. Index of existing item, will be added opposite to list direction\n\t * @param silent {Boolean} Optional. Throw a datachange event? Mainly used internally.\n\t */\n\tadd: function(item, index, o = {}) {\n\t\tif (item instanceof Node) {\n\t\t\titem = Mavo.Node.get(item) || this.createItem(item);\n\t\t}\n\t\telse {\n\t\t\titem = item || this.createItem();\n\t\t}\n\n\t\tif (item.collection != this) {\n\t\t\tthis.adopt(item);\n\t\t}\n\n\t\tif (index === undefined) {\n\t\t\tindex = this.bottomUp? 0 : this.length;\n\t\t}\n\n\t\tif (this.mutable) {\n\t\t\t// Add it to the DOM, or fix its place\n\t\t\tvar nextItem = this.children[index];\n\n\t\t\titem.element._.before(nextItem && nextItem.element || this.marker);\n\t\t}\n\n\t\tvar env = {context: this, item};\n\n\t\tenv.previousIndex = item.index;\n\n\t\t// Update internal data model\n\t\tenv.changed = this.splice({\n\t\t\tremove: env.item\n\t\t}, {\n\t\t\tindex: index,\n\t\t\tadd: env.item\n\t\t});\n\n\t\tif (!o.silent) {\n\t\t\tenv.changed.forEach(i => {\n\t\t\t\ti.dataChanged(i == env.item && env.previousIndex === undefined? \"add\" : \"move\");\n\t\t\t\ti.unsavedChanges = true;\n\t\t\t});\n\n\t\t\tthis.unsavedChanges = this.mavo.unsavedChanges = true;\n\t\t}\n\n\t\tMavo.hooks.run(\"collection-add-end\", env);\n\n\t\treturn env.item;\n\t},\n\n\tsplice: function(...actions) {\n\t\tfor (let action of actions) {\n\t\t\tif (action.index === undefined && action.remove && isNaN(action.remove)) {\n\t\t\t\t// Remove is an item\n\t\t\t\taction.index = this.children.indexOf(action.remove);\n\t\t\t\taction.remove = 1;\n\t\t\t}\n\t\t}\n\n\t\t// Sort in reverse index order\n\t\tactions.sort((a, b) => b.index - a.index);\n\n\t\t// FIXME this could still result in buggy behavior.\n\t\t// Think of e.g. adding items on i, then removing > 1 items on i-1.\n\t\t// The new items would get removed instead of the old ones.\n\t\t// Not a pressing issue though since we always remove 1 max when adding things too.\n\t\tfor (let action of actions) {\n\t\t\tif (action.index > -1 && (action.remove || action.add)) {\n\t\t\t\taction.remove = action.remove || 0;\n\t\t\t\taction.add = Mavo.toArray(action.add);\n\n\t\t\t\tthis.children.splice(action.index, +action.remove, ...action.add);\n\t\t\t}\n\t\t}\n\n\t\tvar changed = [];\n\n\t\tfor (let i = 0; i < this.length; i++) {\n\t\t\tlet item = this.children[i];\n\n\t\t\tif (item && item.index !== i) {\n\t\t\t\titem.index = i;\n\t\t\t\tchanged.push(item);\n\t\t\t}\n\t\t}\n\n\t\treturn changed;\n\t},\n\n\tadopt: function(item) {\n\t\tif (item.collection) {\n\t\t\t// It belongs to another collection, delete from there first\n\t\t\titem.collection.splice({remove: item});\n\t\t\titem.collection.dataChanged(\"delete\");\n\t\t}\n\n\t\t // Update collection & closestCollection properties\n\t\tthis.walk(obj => {\n\t\t\tif (obj.closestCollection === item.collection) {\n\t\t\t\tobj.closestCollection = this;\n\t\t\t}\n\n\t\t\t// Belongs to another Mavo?\n\t\t\tif (item.mavo != this.mavo) {\n\t\t\t\titem.mavo = this.mavo;\n\t\t\t}\n\t\t});\n\n\t\titem.collection = this;\n\n\t\t// Adjust templates and their copies\n\t\tif (item.template) {\n\t\t\tMavo.delete(item.template.copies, item);\n\n\t\t\titem.template = this.itemTemplate;\n\t\t}\n\t},\n\n\tdelete: function(item, hard) {\n\t\tif (hard) {\n\t\t\t// Hard delete\n\t\t\t$.remove(item.element);\n\t\t\tthis.splice({remove: item});\n\t\t\treturn;\n\t\t}\n\n\t\treturn $.transition(item.element, {opacity: 0}).then(() => {\n\t\t\titem.deleted = true; // schedule for deletion\n\t\t\titem.element.style.opacity = \"\";\n\n\t\t\titem.dataChanged(\"delete\");\n\n\t\t\tthis.unsavedChanges = item.unsavedChanges = this.mavo.unsavedChanges = true;\n\t\t});\n\t},\n\n\tedit: function() {\n\t\tthis.super.edit.call(this);\n\n\t\tif (this.mutable) {\n\t\t\t// Insert the add button if it's not already in the DOM\n\t\t\tif (!this.addButton.parentNode) {\n\t\t\t\tif (this.bottomUp) {\n\t\t\t\t\tthis.addButton._.before($.value(this.children[0], \"element\") || this.marker);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tvar tag = this.element.tagName.toLowerCase();\n\t\t\t\t\tvar containerSelector = Mavo.selectors.container[tag];\n\n\t\t\t\t\tif (containerSelector) {\n\t\t\t\t\t\tvar after = this.marker.parentNode.closest(containerSelector);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.addButton._.after(after && after.parentNode? after : this.marker);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Set up drag & drop\n\t\t\t_.dragula.then(() => {\n\t\t\t\tthis.getDragula();\n\t\t\t});\n\t\t}\n\t},\n\n\tdone: function() {\n\t\tthis.super.done.call(this);\n\n\t\tif (this.mutable) {\n\t\t\tif (this.addButton.parentNode) {\n\t\t\t\tthis.addButton.remove();\n\t\t\t}\n\t\t}\n\t},\n\n\t/**\n\t * Delete all items in the collection.\n\t */\n\tclear: function() {\n\t\tif (this.mutable) {\n\t\t\tthis.propagate(item => {\n\t\t\t\tif (item.element.remove) {\n\t\t\t\t\titem.element.remove();\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// Document fragment, remove all children\n\t\t\t\t\tfor (let node of item.element.childNodes) {\n\t\t\t\t\t\tnode => node.remove();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tthis.children = [];\n\n\t\t\tthis.dataChanged(\"clear\");\n\t\t}\n\t},\n\n\tdataChanged: function(action, o = {}) {\n\t\to.element = o.element || this.marker;\n\t\treturn this.super.dataChanged.call(this, action, o);\n\t},\n\n\tsave: function() {\n\t\tfor (let item of this.children) {\n\t\t\tif (item.deleted) {\n\t\t\t\tthis.delete(item, true);\n\t\t\t}\n\t\t\telse {\n\t\t\t\titem.unsavedChanges = false;\n\t\t\t}\n\t\t}\n\t},\n\n\tpropagated: [\"save\"],\n\n\trevert: function() {\n\t\tfor (let item of this.children) {\n\t\t\t// Delete added items\n\t\t\tif (item.unsavedChanges) {\n\t\t\t\tthis.delete(item, true);\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Bring back deleted items\n\t\t\t\tif (item.deleted) {\n\t\t\t\t\titem.deleted = false;\n\t\t\t\t}\n\n\t\t\t\t// Revert all properties\n\t\t\t\titem.revert();\n\t\t\t}\n\t\t}\n\t},\n\n\tdataRender: function(data) {\n\t\tthis.unhandled = {before: [], after: []};\n\n\t\tif (!data) {\n\t\t\treturn;\n\t\t}\n\n\t\tdata = Mavo.toArray(data);\n\n\t\tif (!this.mutable) {\n\t\t\tthis.children.forEach((item, i) => item.render(data && data[i]));\n\n\t\t\tif (data) {\n\t\t\t\tthis.unhandled.after = data.slice(this.length);\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tthis.clear();\n\n\t\t\t// Using document fragments improved rendering performance by 60%\n\t\t\tvar fragment = document.createDocumentFragment();\n\n\t\t\tdata.forEach((datum, i) => {\n\t\t\t\tvar item = this.createItem();\n\n\t\t\t\titem.render(datum);\n\n\t\t\t\tthis.children.push(item);\n\t\t\t\titem.index = i;\n\n\t\t\t\tfragment.appendChild(item.element);\n\n\t\t\t\tvar env = {context: this, item};\n\t\t\t\tMavo.hooks.run(\"collection-add-end\", env);\n\t\t\t});\n\n\t\t\tthis.marker.parentNode.insertBefore(fragment, this.marker);\n\t\t}\n\t},\n\n\tfind: function(property, o = {}) {\n\t\tvar items = this.children.filter(item => !item.deleted);\n\n\t\tif (this.property == property) {\n\t\t\treturn o.collections? this : items;\n\t\t}\n\n\t\tif (this.properties.indexOf(property) > -1) {\n\t\t\tvar ret = items.map(item => item.find(property, o));\n\n\t\t\treturn Mavo.flatten(ret);\n\t\t}\n\t},\n\n\tisCompatible: function(c) {\n\t\treturn c && this.itemTemplate.nodeType == c.itemTemplate.nodeType && (c === this\n\t\t       || c.template == this || this.template == c || this.template && this.template == c.template\n\t\t       || this.accepts.indexOf(c.property) > -1);\n\t},\n\n\tlive: {\n\t\tmutable: function(value) {\n\t\t\tif (value && value !== this.mutable) {\n\t\t\t\t// Why is all this code here? Because we want it executed\n\t\t\t\t// every time mutable changes, not just in the constructor\n\t\t\t\t// (think multiple elements with the same property name, where only one has mv-multiple)\n\t\t\t\tthis._mutable = value;\n\n\t\t\t\t// Keep position of the template in the DOM, since we might remove it\n\t\t\t\tthis.marker = document.createComment(\"mv-marker\");\n\t\t\t\tMavo.data(this.marker, \"collection\", this);\n\t\t\t\t$.after(this.marker, this.templateElement);\n\n\t\t\t\tthis.templateElement.classList.add(\"mv-item\");\n\t\t\t}\n\t\t}\n\t},\n\n\t// Make sure to only call after dragula has loaded\n\tgetDragula: function() {\n\t\tif (this.dragula) {\n\t\t\treturn this.dragula;\n\t\t}\n\n\t\tif (this.template) {\n\t\t\tMavo.pushUnique(this.template.getDragula().containers, this.marker.parentNode);\n\t\t\treturn this.dragula = this.template.dragula || this.template.getDragula();\n\t\t}\n\n\t\tvar me = this;\n\t\tthis.dragula = dragula({\n\t\t\tcontainers: [this.marker.parentNode],\n\t\t\tisContainer: el => {\n\t\t\t\tif (this.accepts.length) {\n\t\t\t\t\treturn Mavo.flatten(this.accepts.map(property => this.mavo.root.find(property, {collections: true})))\n\t\t\t\t\t\t\t\t.filter(c => c && c instanceof _)\n\t\t\t\t\t\t\t\t.map(c => c.marker.parentNode)\n\t\t\t\t\t\t\t\t.indexOf(el) > -1;\n\t\t\t\t}\n\n\t\t\t\treturn false;\n\t\t\t},\n\t\t\tmoves: (el, container, handle) => {\n\t\t\t\treturn handle.classList.contains(\"mv-drag-handle\") && handle.closest(Mavo.selectors.item) == el;\n\t\t\t},\n\t\t\taccepts: function(el, target, source, next) {\n\t\t\t\tif (el.contains(target)) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tvar previous = next? next.previousElementSibling : target.lastElementChild;\n\n\t\t\t\tvar collection = _.get(previous) || _.get(next);\n\n\t\t\t\tif (!collection) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tvar item = Mavo.Node.get(el);\n\n\t\t\t\treturn item && item.collection.isCompatible(collection);\n\t\t\t}\n\t\t});\n\n\t\tthis.dragula.on(\"drop\", (el, target, source) => {\n\t\t\tvar item = Mavo.Node.get(el);\n\t\t\tvar oldIndex = item && item.index;\n\t\t\tvar next = el.nextElementSibling;\n\t\t\tvar previous = el.previousElementSibling;\n\t\t\tvar collection = _.get(previous) || _.get(next);\n\t\t\tvar closestItem = Mavo.Node.get(previous) || Mavo.Node.get(next);\n\n\t\t\tif (closestItem && closestItem.collection != collection) {\n\t\t\t\tclosestItem = null;\n\t\t\t}\n\n\t\t\tif (item.collection.isCompatible(collection)) {\n\t\t\t\tvar index = closestItem? closestItem.index + (closestItem.element === previous) : collection.length;\n\t\t\t\tcollection.add(item, index);\n\t\t\t}\n\t\t\telse {\n\t\t\t\treturn this.dragula.cancel(true);\n\t\t\t}\n\t\t});\n\n\t\t_.dragulas.push(this.dragula);\n\n\t\treturn this.dragula;\n\t},\n\n\tlazy: {\n\t\tbottomUp: function() {\n\t\t\t/*\n\t\t\t * Add new items at the top or bottom?\n\t\t\t */\n\n\t\t\tif (!this.mutable) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tvar order = this.templateElement.getAttribute(\"mv-order\");\n\t\t\tif (order !== null) {\n\t\t\t\t// Attribute has the highest priority and overrides any heuristics\n\t\t\t\treturn /^desc\\b/i.test(order);\n\t\t\t}\n\n\t\t\tif (!this.addButton.parentNode) {\n\t\t\t\t// If add button not in DOM, do the default\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// If add button is already in the DOM and *before* our template, then we default to prepending\n\t\t\treturn !!(this.addButton.compareDocumentPosition(this.templateElement) & Node.DOCUMENT_POSITION_FOLLOWING);\n\t\t},\n\n\t\tclosestCollection: function() {\n\t\t\tvar parent = this.marker? this.marker.parentNode : this.templateElement.parentNode;\n\n\t\t\treturn parent.closest(Mavo.selectors.item);\n\t\t},\n\n\t\taddButton: function() {\n\t\t\t// Find add button if provided, or generate one\n\t\t\tvar selector = `button.mv-add-${this.property}`;\n\t\t\tvar group = this.closestCollection || this.marker.parentNode.closest(Mavo.selectors.group);\n\n\t\t\tif (group) {\n\t\t\t\tvar button = $$(selector, group).filter(button => {\n\t\t\t\t\treturn !this.templateElement.contains(button);\n\t\t\t\t})[0];\n\t\t\t}\n\n\t\t\tif (!button) {\n\t\t\t\tbutton = $.create(\"button\", {\n\t\t\t\t\tclassName: \"mv-add\",\n\t\t\t\t\ttextContent: \"Add \" + this.name\n\t\t\t\t});\n\t\t\t};\n\n\t\t\tbutton.classList.add(\"mv-ui\", \"mv-add\");\n\t\t\tMavo.data(button, \"collection\", this);\n\n\t\t\tif (this.property) {\n\t\t\t\tbutton.classList.add(`mv-add-${this.property}`);\n\t\t\t}\n\n\t\t\tbutton.addEventListener(\"click\", evt => {\n\t\t\t\tevt.preventDefault();\n\n\t\t\t\tthis.add().edit();\n\t\t\t});\n\n\t\t\treturn button;\n\t\t}\n\t},\n\n\tstatic: {\n\t\tdragulas: [],\n\t\tget: element => {\n\t\t\t// Is it an add button or a marker?\n\t\t\tvar collection = Mavo.data(element, \"collection\");\n\n\t\t\tif (collection) {\n\t\t\t\treturn collection;\n\t\t\t}\n\n\t\t\t// Maybe it's a collection item?\n\t\t\tvar item = Mavo.Node.get(element);\n\n\t\t\treturn item && item.collection || null;\n\t\t},\n\n\t\tlazy: {\n\t\t\tdragula: () => $.include(self.dragula, \"https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.min.js\")\n\t\t}\n\t}\n});\n\nMavo.hooks.add(\"primitive-init-end\", function() {\n\tif (this.collection && !this.attribute) {\n\t\t// Collection of primitives, deal with setting textContent etc without the UI interfering.\n\t\tvar swapUI = callback => {\n\t\t\tvar ret;\n\n\t\t\tthis.sneak(() => {\n\t\t\t\tvar ui = $.remove($(\".mv-item-controls\", this.element));\n\n\t\t\t\tret = callback();\n\n\t\t\t\t$.inside(ui, this.element);\n\t\t\t});\n\n\t\t\treturn ret;\n\t\t};\n\n\t\t// Intercept certain properties so that any Mavo UI inside this primitive will not be destroyed\n\t\t[\"textContent\", \"innerHTML\"].forEach(property => {\n\t\t\tvar descriptor = Object.getOwnPropertyDescriptor(Node.prototype, property);\n\n\t\t\tObject.defineProperty(this.element, property, {\n\t\t\t\tget: function() {\n\t\t\t\t\treturn swapUI(() => descriptor.get.call(this));\n\t\t\t\t},\n\n\t\t\t\tset: function(value) {\n\t\t\t\t\tswapUI(() => descriptor.set.call(this, value));\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n});\n\nMavo.hooks.add(\"node-edit-end\", function() {\n\tif (this.collection) {\n\t\tif (!this.itemControls) {\n\t\t\tthis.itemControls = $$(\".mv-item-controls\", this.element)\n\t\t\t\t\t\t\t\t   .filter(el => el.closest(Mavo.selectors.item) == this.element)[0];\n\n\t\t\tthis.itemControls = this.itemControls || $.create({\n\t\t\t\tclassName: \"mv-item-controls mv-ui\"\n\t\t\t});\n\n\t\t\t$.set(this.itemControls, {\n\t\t\t\tcontents: [\n\t\t\t\t\t{\n\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\ttitle: \"Delete this \" + this.name,\n\t\t\t\t\t\tclassName: \"mv-delete\",\n\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\"click\": evt => this.collection.delete(this)\n\t\t\t\t\t\t}\n\t\t\t\t\t}, {\n\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\ttitle: `Add new ${this.name.replace(/s$/i, \"\")} ${this.collection.bottomUp? \"after\" : \"before\"}`,\n\t\t\t\t\t\tclassName: \"mv-add\",\n\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\"click\": evt => {\n\t\t\t\t\t\t\t\tvar item = this.collection.add(null, this.index + this.collection.bottomUp);\n\n\t\t\t\t\t\t\t\tif (evt[Mavo.superKey]) {\n\t\t\t\t\t\t\t\t\titem.render(this.data);\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tif (!Mavo.inViewport(item.element)) {\n\t\t\t\t\t\t\t\t\titem.element.scrollIntoView({behavior: \"smooth\"});\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\treturn item.edit();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}, {\n\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\ttitle: \"Drag to reorder \" + this.name,\n\t\t\t\t\t\tclassName: \"mv-drag-handle\"\n\t\t\t\t\t}\n\t\t\t\t]\n\t\t\t});\n\t\t}\n\n\t\tif (!this.itemControls.parentNode) {\n\t\t\tthis.element.appendChild(this.itemControls);\n\t\t}\n\t}\n});\n\nMavo.hooks.add(\"node-done-end\", function() {\n\tif (this.collection) {\n\t\tif (this.itemControls) {\n\t\t\tthis.itemControls.remove();\n\t\t}\n\t}\n});\n\nMavo.Node.prototype.getClosestCollection = function() {\n\treturn this.collection ||\n\t\t   this.group.collection ||\n\t\t   (this.parentGroup? this.parentGroup.closestCollection : null);\n};\n\n$.lazy(Mavo.Node.prototype, \"closestCollection\", function() {\n\treturn this.getClosestCollection();\n});\n\n$.live(Mavo.Node.prototype, \"deleted\", function(value) {\n\tthis.element.classList.toggle(\"mv-deleted\", value);\n\n\tif (value) {\n\t\t// Soft delete, store element contents in a fragment\n\t\t// and replace them with an undo prompt.\n\t\tthis.elementContents = document.createDocumentFragment();\n\t\t$$(this.element.childNodes).forEach(node => {\n\t\t\tthis.elementContents.appendChild(node);\n\t\t});\n\n\t\t$.contents(this.element, [\n\t\t\t{\n\t\t\t\ttag: \"button\",\n\t\t\t\tclassName: \"mv-close mv-ui\",\n\t\t\t\ttextContent: \"Ã—\",\n\t\t\t\tevents: {\n\t\t\t\t\t\"click\": function(evt) {\n\t\t\t\t\t\t$.remove(this.parentNode);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t\t\"Deleted \" + this.name,\n\t\t\t{\n\t\t\t\ttag: \"button\",\n\t\t\t\tclassName: \"mv-undo mv-ui\",\n\t\t\t\ttextContent: \"Undo\",\n\t\t\t\tevents: {\n\t\t\t\t\t\"click\": evt => this.deleted = false\n\t\t\t\t}\n\t\t\t}\n\t\t]);\n\n\t\tthis.element.classList.remove(\"mv-highlight\");\n\t}\n\telse if (this.deleted) {\n\t\t// Undelete\n\t\tthis.element.textContent = \"\";\n\t\tthis.element.appendChild(this.elementContents);\n\n\t\t// otherwise expressions won't update because this will still seem as deleted\n\t\t// Alternatively, we could fire datachange with a timeout.\n\t\tthis._deleted = false;\n\n\t\tthis.dataChanged(\"undelete\");\n\t}\n});\n\n/**\n * Check if this unit is either deleted or inside a deleted group\n */\nMavo.Node.prototype.isDeleted = function() {\n\tvar ret = this.deleted;\n\n\tif (this.deleted) {\n\t\treturn true;\n\t}\n\n\treturn !!this.parentGroup && this.parentGroup.isDeleted();\n};\n\nMavo.hooks.add(\"node-init-end\", function(env) {\n\tthis.collection = env.options.collection;\n\n\tif (this.collection) {\n\t\t// This is a collection item\n\t\tthis.group = this.parentGroup = this.collection.parentGroup;\n\t}\n});\n\n})(Bliss, Bliss.$);\n"],"sourceRoot":"/source/"}