!function(){"use strict";function t(e,n,i){return n=void 0===n?1:n,i=i||n+1,i-n<=1?function(){if(arguments.length<=n||"string"===r.type(arguments[n]))return e.apply(this,arguments);var t,i=arguments[n];for(var o in i){var s=Array.prototype.slice.call(arguments);s.splice(n,1,o,i[o]),t=e.apply(this,s)}return t}:t(t(e,n+1,i),n,i-1)}function e(t,r,i){var o=n(i);if("string"===o){var s=Object.getOwnPropertyDescriptor(r,i);!s||s.writable&&s.configurable&&s.enumerable&&!s.get&&!s.set?t[i]=r[i]:(delete t[i],Object.defineProperty(t,i,s))}else if("array"===o)i.forEach(function(n){n in r&&e(t,r,n)});else for(var a in r)i&&("regexp"===o&&!i.test(a)||"function"===o&&!i.call(r,a))||e(t,r,a);return t}function n(t){if(null===t)return"null";if(void 0===t)return"undefined";var e=(Object.prototype.toString.call(t).match(/^\[object\s+(.*?)\]$/)[1]||"").toLowerCase();return"number"==e&&isNaN(t)?"nan":e}var r=self.Bliss=e(function(t,e){return 2==arguments.length&&!e||!t?null:"string"===r.type(t)?(e||document).querySelector(t):t||null},self.Bliss);e(r,{extend:e,overload:t,type:n,property:r.property||"_",listeners:self.WeakMap?new WeakMap:new Map,original:{addEventListener:(self.EventTarget||Node).prototype.addEventListener,removeEventListener:(self.EventTarget||Node).prototype.removeEventListener},sources:{},noop:function(){},$:function(t,e){return t instanceof Node||t instanceof Window?[t]:2!=arguments.length||e?Array.prototype.slice.call("string"==typeof t?(e||document).querySelectorAll(t):t||[]):[]},defined:function(){for(var t=0;t<arguments.length;t++)if(void 0!==arguments[t])return arguments[t]},create:function(t,e){return t instanceof Node?r.set(t,e):(1===arguments.length&&("string"===r.type(t)?e={}:(e=t,t=e.tag,e=r.extend({},e,function(t){return"tag"!==t}))),r.set(document.createElement(t||"div"),e))},each:function(t,e,n){n=n||{};for(var r in t)n[r]=e.call(t,r,t[r]);return n},ready:function(t,e,n){if("function"!=typeof t||e||(e=t,t=void 0),t=t||document,e&&("loading"!==t.readyState?e():r.once(t,"DOMContentLoaded",function(){e()})),!n)return new Promise(function(e){r.ready(t,e,!0)})},Class:function(t){var e,n=["constructor","extends","abstract","static"].concat(Object.keys(r.classProps)),i=t.hasOwnProperty("constructor")?t.constructor:r.noop;2==arguments.length?(e=arguments[0],t=arguments[1]):(e=function(){if(this.constructor.__abstract&&this.constructor===e)throw new Error("Abstract classes cannot be directly instantiated.");e["super"]&&e["super"].apply(this,arguments),i.apply(this,arguments)},e["super"]=t["extends"]||null,e.prototype=r.extend(Object.create(e["super"]?e["super"].prototype:Object),{constructor:e}),e.prototype["super"]=e["super"]?e["super"].prototype:null,e.__abstract=!!t["abstract"]);var o=function(t){return this.hasOwnProperty(t)&&n.indexOf(t)===-1};if(t["static"]){r.extend(e,t["static"],o);for(var s in r.classProps)s in t["static"]&&r.classProps[s](e,t["static"][s])}r.extend(e.prototype,t,o);for(var s in r.classProps)s in t&&r.classProps[s](e.prototype,t[s]);return e},classProps:{lazy:t(function(t,e,n){return Object.defineProperty(t,e,{get:function(){var t=n.call(this);return Object.defineProperty(this,e,{value:t,configurable:!0,enumerable:!0,writable:!0}),t},set:function(t){Object.defineProperty(this,e,{value:t,configurable:!0,enumerable:!0,writable:!0})},configurable:!0,enumerable:!0}),t}),live:t(function(t,e,n){return"function"===r.type(n)&&(n={set:n}),Object.defineProperty(t,e,{get:function(){var t=this["_"+e],r=n.get&&n.get.call(this,t);return void 0!==r?r:t},set:function(t){var r=this["_"+e],i=n.set&&n.set.call(this,t,r);this["_"+e]=void 0!==i?i:t},configurable:n.configurable,enumerable:n.enumerable}),t})},include:function(){var t=arguments[arguments.length-1],e=2===arguments.length&&arguments[0],n=document.createElement("script");return e?Promise.resolve():new Promise(function(e,i){r.set(n,{async:!0,onload:function(){e(),n.parentNode&&n.parentNode.removeChild(n)},onerror:function(){i()},src:t,inside:document.head})})},fetch:function(t,n){if(!t)throw new TypeError("URL parameter is mandatory and cannot be "+t);var i=e({url:new URL(t,location),data:"",method:"GET",headers:{},xhr:new XMLHttpRequest},n);i.method=i.method.toUpperCase(),r.hooks.run("fetch-args",i),"GET"===i.method&&i.data&&(i.url.search+=i.data),document.body.setAttribute("data-loading",i.url),i.xhr.open(i.method,i.url.href,i.async!==!1,i.user,i.password);for(var o in n)if("upload"===o)i.xhr.upload&&"object"==typeof n[o]&&r.extend(i.xhr.upload,n[o]);else if(o in i.xhr)try{i.xhr[o]=n[o]}catch(s){self.console&&console.error(s)}var a=Object.keys(i.headers).map(function(t){return t.toLowerCase()});"GET"!==i.method&&a.indexOf("content-type")===-1&&i.xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded");for(var c in i.headers)void 0!==i.headers[c]&&i.xhr.setRequestHeader(c,i.headers[c]);var u=new Promise(function(t,e){i.xhr.onload=function(){document.body.removeAttribute("data-loading"),0===i.xhr.status||i.xhr.status>=200&&i.xhr.status<300||304===i.xhr.status?t(i.xhr):e(r.extend(Error(i.xhr.statusText),{xhr:i.xhr,get status(){return this.xhr.status}}))},i.xhr.onerror=function(){document.body.removeAttribute("data-loading"),e(r.extend(Error("Network Error"),{xhr:i.xhr}))},i.xhr.ontimeout=function(){document.body.removeAttribute("data-loading"),e(r.extend(Error("Network Timeout"),{xhr:i.xhr}))},i.xhr.send("GET"===i.method?null:i.data)});return u.xhr=i.xhr,u},value:function(t){var e="string"!==r.type(t);return r.$(arguments).slice(+e).reduce(function(t,e){return t&&t[e]},e?t:self)}}),r.Hooks=new r.Class({add:function(t,e,n){if("string"==typeof arguments[0])(Array.isArray(t)?t:[t]).forEach(function(t){this[t]=this[t]||[],e&&this[t][n?"unshift":"push"](e)},this);else for(var t in arguments[0])this.add(t,arguments[0][t],arguments[1])},run:function(t,e){this[t]=this[t]||[],this[t].forEach(function(t){t.call(e&&e.context?e.context:e,e)})}}),r.hooks=new r.Hooks;r.property;r.Element=function(t){this.subject=t,this.data={},this.bliss={}},r.Element.prototype={set:t(function(t,e){t in r.setProps?r.setProps[t].call(this,e):t in this?this[t]=e:this.setAttribute(t,e)},0),transition:function(t,e){return e=+e||400,new Promise(function(n,i){if("transition"in this.style){var o=r.extend({},this.style,/^transition(Duration|Property)$/);r.style(this,{transitionDuration:(e||400)+"ms",transitionProperty:Object.keys(t).join(", ")}),r.once(this,"transitionend",function(){clearTimeout(s),r.style(this,o),n(this)});var s=setTimeout(n,e+50,this);r.style(this,t)}else r.style(this,t),n(this)}.bind(this))},fire:function(t,e){var n=document.createEvent("HTMLEvents");return n.initEvent(t,!0,!0),this.dispatchEvent(r.extend(n,e))},bind:t(function(t,e){if(arguments.length>1&&("function"===r.type(e)||e.handleEvent)){var n=e;e="object"===r.type(arguments[2])?arguments[2]:{capture:!!arguments[2]},e.callback=n}var i=r.listeners.get(this)||{};t.trim().split(/\s+/).forEach(function(t){if(t.indexOf(".")>-1){t=t.split(".");var n=t[1];t=t[0]}i[t]=i[t]||[],0===i[t].filter(function(t){return t.callback===e.callback&&t.capture==e.capture}).length&&i[t].push(r.extend({className:n},e)),r.original.addEventListener.call(this,t,e.callback,e)},this),r.listeners.set(this,i)},0),unbind:t(function(t,e){if(e&&("function"===r.type(e)||e.handleEvent)){var n=e;e=arguments[2]}"boolean"==r.type(e)&&(e={capture:e}),e=e||{},e.callback=e.callback||n;var i=r.listeners.get(this);(t||"").trim().split(/\s+/).forEach(function(t){if(t.indexOf(".")>-1){t=t.split(".");var n=t[1];t=t[0]}if(t&&e.callback)return r.original.removeEventListener.call(this,t,e.callback,e.capture);if(i)for(var o in i)if(!t||o===t)for(var s,a=0;s=i[o][a];a++)n&&n!==s.className||e.callback&&e.callback!==s.callback||!!e.capture!=!!s.capture||(i[o].splice(a,1),r.original.removeEventListener.call(this,o,s.callback,s.capture),a--)},this)},0)},r.setProps={style:function(t){for(var e in t)e in this.style?this.style[e]=t[e]:this.style.setProperty(e,t[e])},attributes:function(t){for(var e in t)this.setAttribute(e,t[e])},properties:function(t){r.extend(this,t)},events:function(t){if(1!=arguments.length||!t||!t.addEventListener)return r.bind.apply(this,[this].concat(r.$(arguments)));var e=this;if(r.listeners){var n=r.listeners.get(t);for(var i in n)n[i].forEach(function(t){r.bind(e,i,t.callback,t.capture)})}for(var o in t)0===o.indexOf("on")&&(this[o]=t[o])},once:t(function(t,e){var n=this,i=function(){return r.unbind(n,t,i),e.apply(n,arguments)};r.bind(this,t,i,{once:!0})},0),delegate:t(function(t,e,n){r.bind(this,t,function(t){t.target.closest(e)&&n.call(this,t)})},0,2),contents:function(t){(t||0===t)&&(Array.isArray(t)?t:[t]).forEach(function(t){var e=r.type(t);/^(string|number)$/.test(e)?t=document.createTextNode(t+""):"object"===e&&(t=r.create(t)),t instanceof Node&&this.appendChild(t)},this)},inside:function(t){t&&t.appendChild(this)},before:function(t){t&&t.parentNode.insertBefore(this,t)},after:function(t){t&&t.parentNode.insertBefore(this,t.nextSibling)},start:function(t){t&&t.insertBefore(this,t.firstChild)},around:function(t){t&&t.parentNode&&r.before(this,t),this.appendChild(t)}},r.Array=function(t){this.subject=t},r.Array.prototype={all:function(t){var e=r.$(arguments).slice(1);return this[t].apply(this,e)}},r.add=t(function(t,e,n,i){n=r.extend({$:!0,element:!0,array:!0},n),"function"==r.type(e)&&(!n.element||t in r.Element.prototype&&i||(r.Element.prototype[t]=function(){return this.subject&&r.defined(e.apply(this.subject,arguments),this.subject)}),!n.array||t in r.Array.prototype&&i||(r.Array.prototype[t]=function(){var t=arguments;return this.subject.map(function(n){return n&&r.defined(e.apply(n,t),n)})}),n.$&&(r.sources[t]=r[t]=e,(n.array||n.element)&&(r[t]=function(){var e=[].slice.apply(arguments),i=e.shift(),o=n.array&&Array.isArray(i)?"Array":"Element";return r[o].prototype[t].apply({subject:i},e)})))},0),r.add(r.Array.prototype,{element:!1}),r.add(r.Element.prototype),r.add(r.setProps),r.add(r.classProps,{element:!1,array:!1});var i=document.createElement("_");r.add(r.extend({},HTMLElement.prototype,function(t){return"function"===r.type(i[t])}),null,!0)}();
/* jsep v0.3.2 (http://jsep.from.so/) */
!function(e){"use strict";var r=function(e,r){var t=new Error(e+" at character "+r);throw t.index=r,t.description=e,t},t={"-":!0,"!":!0,"~":!0,"+":!0},n={"||":1,"&&":2,"|":3,"^":4,"&":5,"==":6,"!=":6,"===":6,"!==":6,"<":7,">":7,"<=":7,">=":7,"<<":8,">>":8,">>>":8,"+":9,"-":9,"*":10,"/":10,"%":10},o=function(e){var r,t=0;for(var n in e)(r=n.length)>t&&e.hasOwnProperty(n)&&(t=r);return t},i=o(t),a=o(n),u={true:!0,false:!1,null:null},s=function(e){return n[e]||0},p=function(e,r,t){return{type:"||"===e||"&&"===e?"LogicalExpression":"BinaryExpression",operator:e,left:r,right:t}},f=function(e){return e>=48&&e<=57},c=function(e){return 36===e||95===e||e>=65&&e<=90||e>=97&&e<=122||e>=128&&!n[String.fromCharCode(e)]},l=function(e){return 36===e||95===e||e>=65&&e<=90||e>=97&&e<=122||e>=48&&e<=57||e>=128&&!n[String.fromCharCode(e)]},d=function(e){for(var o,d,h=0,v=e.charAt,x=e.charCodeAt,y=function(r){return v.call(e,r)},m=function(r){return x.call(e,r)},b=e.length,E=function(){for(var e=m(h);32===e||9===e||10===e||13===e;)e=m(++h)},g=function(){var e,t,n=w();return E(),63!==m(h)?n:(h++,(e=g())||r("Expected expression",h),E(),58===m(h)?(h++,(t=g())||r("Expected expression",h),{type:"ConditionalExpression",test:n,consequent:e,alternate:t}):void r("Expected :",h))},C=function(){E();for(var r=e.substr(h,a),t=r.length;t>0;){if(n.hasOwnProperty(r))return h+=t,r;r=r.substr(0,--t)}return!1},w=function(){var e,t,n,o,i,a,u,f;if(a=O(),!(t=C()))return a;for(i={value:t,prec:s(t)},(u=O())||r("Expected expression after "+t,h),o=[a,i,u];(t=C())&&0!==(n=s(t));){for(i={value:t,prec:n};o.length>2&&n<=o[o.length-2].prec;)u=o.pop(),t=o.pop().value,a=o.pop(),e=p(t,a,u),o.push(e);(e=O())||r("Expected expression after "+t,h),o.push(i,e)}for(e=o[f=o.length-1];f>1;)e=p(o[f-1].value,o[f-2],e),f-=2;return e},O=function(){var r,n,o;if(E(),r=m(h),f(r)||46===r)return U();if(39===r||34===r)return k();if(91===r)return S();for(o=(n=e.substr(h,i)).length;o>0;){if(t.hasOwnProperty(n))return h+=o,{type:"UnaryExpression",operator:n,argument:O(),prefix:!0};n=n.substr(0,--o)}return!(!c(r)&&40!==r)&&A()},U=function(){for(var e,t,n="";f(m(h));)n+=y(h++);if(46===m(h))for(n+=y(h++);f(m(h));)n+=y(h++);if("e"===(e=y(h))||"E"===e){for(n+=y(h++),"+"!==(e=y(h))&&"-"!==e||(n+=y(h++));f(m(h));)n+=y(h++);f(m(h-1))||r("Expected exponent ("+n+y(h)+")",h)}return t=m(h),c(t)?r("Variable names cannot start with a number ("+n+y(h)+")",h):46===t&&r("Unexpected period",h),{type:"Literal",value:parseFloat(n),raw:n}},k=function(){for(var e,t="",n=y(h++),o=!1;h<b;){if((e=y(h++))===n){o=!0;break}if("\\"===e)switch(e=y(h++)){case"n":t+="\n";break;case"r":t+="\r";break;case"t":t+="\t";break;case"b":t+="\b";break;case"f":t+="\f";break;case"v":t+="\v";break;default:t+=e}else t+=e}return o||r('Unclosed quote after "'+t+'"',h),{type:"Literal",value:t,raw:n+t+n}},L=function(){var t,n=m(h),o=h;for(c(n)?h++:r("Unexpected "+y(h),h);h<b&&(n=m(h),l(n));)h++;return t=e.slice(o,h),u.hasOwnProperty(t)?{type:"Literal",value:u[t],raw:t}:"this"===t?{type:"ThisExpression"}:{type:"Identifier",name:t}},j=function(e){for(var t,n,o=[],i=!1;h<b;){if(E(),(t=m(h))===e){i=!0,h++;break}44===t?h++:((n=g())&&"Compound"!==n.type||r("Expected comma",h),o.push(n))}return i||r("Expected "+String.fromCharCode(e),h),o},A=function(){var e,t;for(t=40===(e=m(h))?P():L(),E(),e=m(h);46===e||91===e||40===e;)h++,46===e?(E(),t={type:"MemberExpression",computed:!1,object:t,property:L()}):91===e?(t={type:"MemberExpression",computed:!0,object:t,property:g()},E(),93!==(e=m(h))&&r("Unclosed [",h),h++):40===e&&(t={type:"CallExpression",arguments:j(41),callee:t}),E(),e=m(h);return t},P=function(){h++;var e=g();if(E(),41===m(h))return h++,e;r("Unclosed (",h)},S=function(){return h++,{type:"ArrayExpression",elements:j(93)}},B=[];h<b;)59===(o=m(h))||44===o?h++:(d=g())?B.push(d):h<b&&r('Unexpected "'+y(h)+'"',h);return 1===B.length?B[0]:{type:"Compound",body:B}};if(d.version="0.3.2",d.toString=function(){return"JavaScript Expression Parser (JSEP) v"+d.version},d.addUnaryOp=function(e){return i=Math.max(e.length,i),t[e]=!0,this},d.addBinaryOp=function(e,r){return a=Math.max(e.length,a),n[e]=r,this},d.addLiteral=function(e,r){return u[e]=r,this},d.removeUnaryOp=function(e){return delete t[e],e.length===i&&(i=o(t)),this},d.removeAllUnaryOps=function(){return t={},i=0,this},d.removeBinaryOp=function(e){return delete n[e],e.length===a&&(a=o(n)),this},d.removeAllBinaryOps=function(){return n={},a=0,this},d.removeLiteral=function(e){return delete u[e],this},d.removeAllLiterals=function(){return u={},this},"undefined"==typeof exports){var h=e.jsep;e.jsep=d,d.noConflict=function(){return e.jsep===d&&(e.jsep=h),d}}else"undefined"!=typeof module&&module.exports?exports=module.exports=d:exports.parse=d}(this);
//# sourceMappingURL=jsep.min.js.map
!function(){function e(e,t){return e instanceof Node||e instanceof Window?[e]:[].slice.call("string"==typeof e?(t||document).querySelectorAll(e):e||[])}if(self.Element&&(Element.prototype.matches||(Element.prototype.matches=Element.prototype.webkitMatchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||null),Element.prototype.matches)){var t=self.Stretchy={selectors:{base:'textarea, select:not([size]), input:not([type]), input[type="'+"text number url email tel".split(" ").join('"], input[type="')+'"]',filter:"*"},script:document.currentScript||e("script").pop(),resize:function(e){if(t.resizes(e)){var i,n=getComputedStyle(e),o=0;!e.value&&e.placeholder&&(i=!0,e.value=e.placeholder);var l=e.nodeName.toLowerCase();if("textarea"==l)e.style.height="0","border-box"==n.boxSizing?o=e.offsetHeight:"content-box"==n.boxSizing&&(o=-e.clientHeight+parseFloat(n.minHeight)),
e.style.height=e.scrollHeight+o+"px";else if("input"==l)if(e.style.width="1000px",e.offsetWidth){e.style.width="0","border-box"==n.boxSizing?o=e.offsetWidth:"padding-box"==n.boxSizing?o=e.clientWidth:"content-box"==n.boxSizing&&(o=parseFloat(n.minWidth));var r=Math.max(o,e.scrollWidth-e.clientWidth);e.style.width=r+"px";for(var s=0;s<10&&(e.scrollLeft=1e10,0!=e.scrollLeft);s++)r+=e.scrollLeft,e.style.width=r+"px"}else e.style.width=e.value.length+1+"ch";else if("select"==l){var c=e.selectedIndex>0?e.selectedIndex:0,a=document.createElement("_");a.textContent=e.options[c].textContent,e.parentNode.insertBefore(a,e.nextSibling);var d;for(var h in n){var p=n[h];/^(width|webkitLogicalWidth|length)$/.test(h)||"string"!=typeof p||(a.style[h]=p,/appearance$/i.test(h)&&(d=h))}a.style.width="",a.offsetWidth>0&&(e.style.width=a.offsetWidth+"px",n[d]&&"none"===n[d]||(e.style.width="calc("+e.style.width+" + 2em)")),a.parentNode.removeChild(a),a=null}i&&(e.value="")}},resizeAll:function(i){
e(i||t.selectors.base).forEach(function(e){t.resize(e)})},active:!0,resizes:function(e){return e&&e.parentNode&&e.matches&&e.matches(t.selectors.base)&&e.matches(t.selectors.filter)},init:function(){t.selectors.filter=t.script.getAttribute("data-filter")||(e("[data-stretchy-filter]").pop()||document.body).getAttribute("data-stretchy-filter")||Stretchy.selectors.filter||"*",t.resizeAll()},$$:e};"loading"!==document.readyState?t.init():document.addEventListener("DOMContentLoaded",t.init);var i=function(e){t.active&&t.resize(e.target)};document.documentElement.addEventListener("input",i),document.documentElement.addEventListener("change",i),self.MutationObserver&&new MutationObserver(function(e){t.active&&e.forEach(function(e){"childList"==e.type&&Stretchy.resizeAll(e.addedNodes)})}).observe(document.documentElement,{childList:!0,subtree:!0})}}();
//# sourceMappingURL=stretchy.min.js.map

(function(a,b){var c=self.Mavo=a.Class({constructor:function(d){this.treeBuilt=Mavo.defer(),this.dataLoaded=Mavo.defer(),this.element=d,this.inProgress=!1,this.index=Object.keys(c.all).length+1,Object.defineProperty(c.all,this.index-1,{value:this});var e=c.attributes.map((a)=>`[data-${a}]`).join(", ");if([this.element,...b(e,this.element)].forEach((a)=>{c.attributes.forEach((b)=>{var c=a.getAttribute("data-"+b);null!==c&&a.setAttribute(b,c)})}),this.id=Mavo.getAttribute(this.element,"mv-app","id")||`mavo${this.index}`,this.id in c.all){for(var f=2;this.id+f in c.all;f++);this.id+=f}c.all[this.id]=this,this.element.setAttribute("mv-app",this.id);var g=a.value(this.element.closest("[lang]"),"lang")||Mavo.locale;this.locale=Mavo.Locale.get(g),this.autoEdit=this.element.classList.contains("mv-autoedit"),this.autoSave=this.element.hasAttribute("mv-autosave"),this.autoSaveDelay=1e3*(this.element.getAttribute("mv-autosave")||3),this.element.setAttribute("typeof",""),Mavo.hooks.run("init-start",this),b(c.selectors.primitive+","+c.selectors.multiple,this.element).forEach((b)=>{var d=a(`${c.selectors.not(c.selectors.formControl)}, ${c.selectors.property}`,b);if(d){var e=Mavo.Primitive.getConfig(b),f=Mavo.is("multiple",b);!f&&(e.attribute||e.hasChildren)||b.setAttribute("typeof","")}}),this.expressions=new Mavo.Expressions(this),Mavo.hooks.run("init-tree-before",this),this.root=new Mavo.Group(this.element,this),this.treeBuilt.resolve(),Mavo.hooks.run("init-tree-after",this),this.permissions=new Mavo.Permissions;var h=["source","storage","init"];h.forEach((a)=>this.updateBackend(a)),this.backendObserver=new Mavo.Observer(this.element,h.map((a)=>"mv-"+a),(a)=>{var b={},c=a.map((a)=>{var c=a.attributeName.replace(/^mv-/,"");return b[c]=this.updateBackend(c),c});b.source?this.load():!this.source&&(b.storage||b.init&&!this.root.data)&&this.load()}),this.permissions.can("login",()=>{(null!==Mavo.Functions.url("login")&&1==this.index||null!==Mavo.Functions.url(this.id+"-login"))&&this.primaryBackend.login()}),a.bind(this.element,"mv-login.mavo",(a)=>{a.backend!=(this.source||this.storage)||this.root.data||this.unsavedChanges||this.load()}),this.bar=new Mavo.UI.Bar(this),a("summary [property]:not([typeof])")&&this.element.addEventListener("click",(a)=>{a.target!=document.activeElement&&a.preventDefault()}),this.needsEdit=this.calculateNeedsEdit(),this.setUnsavedChanges(!1),this.permissions.onchange(({action:b,value:a})=>{var c=this.element.getAttribute("mv-permissions")||"";c=c.trim().split(/\s+/).filter((c)=>c!=b),a&&c.push(b),this.element.setAttribute("mv-permissions",c.join(" "))}),this.needsEdit&&this.permissions.can(["edit","add","delete"],()=>{this.modeObserver=new Mavo.Observer(this.element,"mv-mode",(a)=>{a.forEach((a)=>{let b=a.target,d=c.Node.children(b);nodeloop:for(let a=0;a<d.length;a++){let e,f=d[a],g=f.mode;if(f.element==b)e=f.element.getAttribute("mv-mode"),f.modes=e;else{if(f.modes)continue nodeloop;e=c.getStyle(f.element.parentNode,"--mv-mode")}f.mode=e,g!=f.mode&&f["edit"==f.mode?"edit":"done"]()}})},{subtree:!0}),this.autoEdit&&this.edit()},()=>{this.modeObserver&&this.modeObserver.destroy()}),this.storage||this.source?this.permissions.can("read",()=>this.load()):requestAnimationFrame(()=>{this.dataLoaded.resolve(),a.fire(this.element,"mv-load")}),location.hash&&a.bind(this.element,"mv-load.mavo",()=>{var a=()=>{var a=document.getElementById(location.hash.slice(1));return(a||!location.hash)&&(this.element.contains(a)&&requestAnimationFrame(()=>{Mavo.scrollIntoViewIfNeeded(a)}),b&&(b.destroy(),b=null)),a};if(!a())var b=new Mavo.Observer(this.element,"id",a,{subtree:!0})}),this.autoSave&&this.dataLoaded.then(()=>{var b=c.debounce(()=>{this.save()},this.autoSaveDelay),d=(a)=>{a.node.saved&&b()};requestAnimationFrame(()=>{this.permissions.can("save",()=>{a.bind(this.element,"mv-change.mavo:autosave",d)},()=>{a.unbind(this.element,"mv-change.mavo:autosave",d)})})}),this.element.addEventListener("keydown",(a)=>{if(this.permissions.save&&83==a.keyCode&&a[c.superKey]&&!a.altKey)a.preventDefault(),this.save();else if(38==a.keyCode||40==a.keyCode){var b=a.target;if(b.matches("textarea, input[type=range], input[type=number]"))return;if(b.matches(".mv-editor")){b=b.parentNode}var d=Mavo.Node.get(b);if(d&&d.closestCollection){var e=d.getCousin(38==a.keyCode?-1:1,{wrap:!0});e&&(e.editing?e.edit({immediately:!0}).then(()=>e.editor.focus()):e.element.focus(),a.preventDefault())}}}),Mavo.hooks.run("init-end",this)},get editing(){return this.root.editing},getData:function(a){return this.root.getData(a)},toJSON:function(){return c.toJSON(this.getData())},message:function(a,b){return new c.UI.Message(this,a,b)},error:function(a,...b){this.message(a,{type:"error",dismiss:["button","timeout"]}),0<b.length&&console.log(`%c${this.id}: ${a}`,"color: red; font-weight: bold",...b)},render:function(a){this.expressions.active=!1;var b={context:this,data:a};c.hooks.run("render-start",b),b.data&&this.root.render(b.data),this.unsavedChanges=!1,this.expressions.active=!0,requestAnimationFrame(()=>this.expressions.update()),c.hooks.run("render-end",b)},edit:function(){this.root.edit(),a.bind(this.element,"mouseenter.mavo:edit mouseleave.mavo:edit",(a)=>{if(a.target.matches(c.selectors.multiple)){a.target.classList.remove("mv-has-hovered-item");var b=a.target.parentNode.closest(c.selectors.multiple);b&&b.classList.toggle("mv-has-hovered-item","mouseenter"==a.type)}},!0),this.setUnsavedChanges()},setUnsavedChanges:function(a){var b=!!a;return a||this.walk((c)=>{if(c.unsavedChanges)return b=!0,!1===a&&(c.unsavedChanges=!1),!1}),this.unsavedChanges=b},done:function(){this.root.done(),a.unbind(this.element,".mavo:edit"),this.unsavedChanges=!1},updateBackend:function(a){var b,d=this[a];1==this.index&&(b=c.Functions.url(a)),b||(b=c.Functions.url(`${this.id}-${a}`)||this.element.getAttribute("mv-"+a)||null),b&&(b=b.trim(),"none"==b&&(b=null)),!b||d&&d.equals(b)?!b&&(this[a]=null):this[a]=b=c.Backend.create(b,{mavo:this,format:this.element.getAttribute(`mv-${a}-format`)||this.element.getAttribute("mv-format")},this.element.getAttribute(`mv-${a}-type`));var e=b?!b.equals(d):!!d;if(e){this.storage||this.source||!this.init||(this.source=this.init,this.init=null);var f=this.storage?this.storage.permissions:new Mavo.Permissions({edit:!0,save:!1});f.parent=this.source&&this.source.permissions,this.permissions.parent=f,this.primaryBackend=this.storage||this.source}return e},load:function(){var b=this.source||this.storage;return b?(this.inProgress="Loading",b.ready.then(()=>b.load()).catch((a)=>{return this.init&&this.init!=b?(b=this.init,this.init.ready.then(()=>this.init.load())):Promise.reject(a)}).catch((a)=>{if(a){var b=a instanceof XMLHttpRequest?a:a.xhr;if(b&&404==b.status)this.render(null);else{var c=this._("problem-loading");b&&(c+=b.status?this._("http-error",a):": "+this._("cant-connect")),this.error(c,a)}}return null}).then((a)=>this.render(a)).then(()=>{this.inProgress=!1,requestAnimationFrame(()=>{this.dataLoaded.resolve(),a.fire(this.element,"mv-load")})})):Promise.resolve()},store:function(){return this.storage?(this.inProgress="Saving",this.storage.store(this.getData()).catch((a)=>{if(a){var b=this._("problem-saving");a instanceof XMLHttpRequest&&(b+=": "+(a.status?this._("http-error",a):this._("cant-connect"))),this.error(b,a)}return null}).then((a)=>{return this.inProgress=!1,a})):Promise.resolve()},upload:function(a,b="images/"+a.name){return this.uploadBackend?(this.inProgress=this._("uploading"),this.uploadBackend.upload(a,b).then((a)=>{return this.inProgress=!1,a}).catch((a)=>{return this.error(this._("error-uploading"),a),this.inProgress=!1,null})):Promise.reject()},save:function(){return this.store().then((b)=>{b&&(a.fire(this.element,"mv-save",b),this.lastSaved=Date.now(),this.root.save(),this.unsavedChanges=!1)})},walk:function(){return this.root.walk(...arguments)},calculateNeedsEdit:function(){var a=!1;return this.walk((b)=>{return!a&&(a=!b.modes&&"Group"!=b.nodeType,!b.modes)},void 0,{descentReturn:!0}),a},live:{inProgress:function(b){a.toggleAttribute(this.element,"mv-progress",b,b),a.toggleAttribute(this.element,"aria-busy",!!b,!!b),this.element.style.setProperty("--mv-progress-text",b?`"${this._(b)}"`:"")},unsavedChanges:function(a){this.element.classList.toggle("mv-unsaved-changes",a)},needsEdit:function(a){this.bar.toggle("edit",a&&this.permissions.edit)},storage:function(a){if(a!==this._storage&&!a){var b=new Mavo.Permissions({edit:!0,save:!1});b.parent=this.permissions.parent,this.permissions.parent=b}},primaryBackend:function(a){if(a=a||null,a!=this._primaryBackend)return a},uploadBackend:{get:function(){if(this.storage&&this.storage.upload)return this.storage}}},static:{version:"%%VERSION%%",all:{},get:function(a){if(a instanceof Element){for(var b in c.all)if(c.all[b].element==a)return c.all[b];return null}var b="number"==typeof a?Object.keys(c.all)[a]:a;return c.all[b]||null},superKey:0===navigator.platform.indexOf("Mac")?"metaKey":"ctrlKey",base:"about:"==location.protocol?document.currentScript?document.currentScript.src:"http://mavo.io":location,dependencies:[],init:function(a=document){var d=Array.isArray(arguments[0])?arguments[0]:b(c.selectors.init,a);return d.filter((a)=>!c.get(a)).map((a)=>new c(a))},UI:{},hooks:new a.Hooks,attributes:["mv-app","mv-storage","mv-source","mv-init","mv-path","mv-multiple-path","mv-format","mv-attribute","mv-default","mv-mode","mv-edit","mv-permisssions","mv-rel","mv-value"],lazy:{locale:()=>document.documentElement.lang||"en-GB",toNode:()=>Symbol("toNode")}}});Object.defineProperty(c.all,"length",{get:function(){return Object.keys(this).length}});{let b=c.selectors={init:".mv-app, [mv-app], [data-mv-app]",property:"[property], [itemprop]",specificProperty:(a)=>`[property=${a}], [itemprop=${a}]`,group:"[typeof], [itemscope], [itemtype], [mv-group]",multiple:"[mv-multiple]",formControl:"input, select, option, textarea",textInput:["text","email","url","tel","search"].map((a)=>`input[type=${a}]`).join(", ")+", input:not([type]), textarea",ui:".mv-ui",container:{tr:"table",option:"select"}},d=b.arr=(a)=>a.split(/\s*,\s*/g),e=b.not=(a)=>d(a).map((a)=>`:not(${a})`).join(""),f=b.or=(a,b)=>a+", "+b,g=b.and=(a,b)=>{var c=[],e=d(b);return d(a).forEach((a)=>c.push(...e.map((b)=>a+b))),c.join(", ")},h=b.andNot=(a,b)=>g(a,e(b));a.extend(c.selectors,{primitive:h(b.property,b.group),rootGroup:h(b.group,b.property),item:f(b.multiple,b.group),output:f(b.specificProperty("output"),".mv-output")})}requestAnimationFrame(()=>{var d=[];a.each({blissfuljs:Array.from&&document.documentElement.closest&&self.URL&&"searchParams"in URL.prototype,"Intl.~locale.en":self.Intl,IntersectionObserver:self.IntersectionObserver,Symbol:self.Symbol,"Element.prototype.remove":Element.prototype.remove},(a,b)=>{b||d.push(a)});var e="https://cdn.polyfill.io/v2/polyfill.min.js?unknown=polyfill&features="+d.map((b)=>b+"|gated").join(",");c.dependencies.push(a.ready().then(()=>c.Plugins.load()),a.include(!d.length,e)),c.inited=a.ready().then(()=>{return a.attributes(b(c.selectors.init),{"mv-progress":"Loading"}),c.ready}).catch(console.error).then(()=>Mavo.init()),c.ready=c.thenAll(c.dependencies)}),Stretchy.selectors.filter=".mv-editor:not([property]), .mv-autosize",self.$=self.$||a,self.$$=self.$$||b})(Bliss,Bliss.$);
(function(a,b){function c(){var a=d.getTarget();const c="mv-target-within";for(b("."+c).forEach((a)=>a.classList.remove(c));a&&a.classList;)a.classList.add(c),a=a.parentNode}var d=a.extend(Mavo,{load:(b,c=document.currentScript?document.currentScript.src:location)=>{if(d.loaded=d.loaded||new Set,!d.loaded.has(b+""))return b=new URL(b,c),/\.css$/.test(b.pathname)?(a.create("link",{href:b,rel:"stylesheet",inside:document.head}),Promise.resolve()):a.include(b)},readFile:(a,b="DataURL")=>{var c=new FileReader;return new Promise((d,e)=>{c.onload=()=>d(c.result),c.onerror=c.onabort=e,c["readAs"+b](a)})},toJSON:(a)=>{return null===a?"":"string"==typeof a?a:JSON.stringify(a,null,"\t")},safeToJSON:function(a){var b=self.WeakSet?new WeakSet:new Set;return JSON.stringify(a,(a,c)=>{if("object"==typeof c&&null!==c){if(b.has(c))return;b.add(c)}return c})},objectify:(b,c)=>{var d=Mavo.value(b);if("object"!=typeof b||null===b){if(null===b)b={[Symbol.toStringTag]:"Null",toJSON:()=>null};else{var e=b.constructor;b=new e(d),b[Symbol.toStringTag]=e.name}b.valueOf=b[Symbol.toPrimitive]=()=>d}return a.extend(b,c)},value:(a)=>a&&a.valueOf?a.valueOf():a,toArray:(a)=>{return a===void 0?[]:Array.isArray(a)?a:[a]},delete:(a,b,c)=>{do{var d=a&&a.indexOf(b);-1<d&&a.splice(d,1)}while(-1<d&&c)},flatten:(a)=>{return Array.isArray(a)?a.reduce((a,b)=>d.toArray(a).concat(d.flatten(b)),[]):[a]},pushUnique:(a,b)=>{-1===a.indexOf(b)&&a.push(b)},union:(a,b)=>{return new Set([...(a||[]),...(b||[])])},is:function(a,...b){for(let c,e=0;e<b.length;e++)if(c=b[e],c&&c.matches&&c.matches(d.selectors[a]))return!0;return!1},getStyle:(a,b)=>{if(a){var c=getComputedStyle(a).getPropertyValue(b);if(c)return c.trim()}},data:function(a,b,c){var e,f=d.elementData.get(a)||{};return 2==arguments.length?e=f[b]:void 0===c?delete f[b]:e=f[b]=c,d.elementData.set(a,f),e},elementData:new WeakMap,elementPath:function(a,b){if(Array.isArray(b)){var c=b,d=c.reduce((a,b)=>{return a.children[b>>0]||a},a),e=c[c.length-1];if(e!=e>>0){var f=+(e+"").split(".")[1];0>e>>0&&(d=d.firstChild,f--);for(var g=0;g<f;g++)d=d.nextSibling}return d}for(var c=[],h=b;h&&h!=a;h=h.parentNode){for(var i=0,j=h===b&&1!==b.nodeType,f=j?1:0,k=h;k=k[`previous${j?"":"Element"}Sibling`];)j?(f++,1==k.nodeType&&(j=!1)):i++;0<f&&(i=i-1+"."+f),c.unshift(i)}return h?c:null},revocably:{add:function(a,b){var c=d.revocably.isRemoved(a);return c&&c.parentNode?c.parentNode.replaceChild(a,c):a&&b&&!a.parentNode&&b.appendChild(a),c},remove:function(a,b){if(a){var c=d.data(a,"commentstub");return c||(b=b||a.id||a.className||a.nodeName,c=d.data(a,"commentstub",document.createComment(b))),a.parentNode&&a.parentNode.replaceChild(c,a),c}},isRemoved:function(a){if(!a||a.parentNode)return!1;var b=d.data(a,"commentstub");return b&&b.parentNode&&b},setAttribute:function(a,b,c){var e=d.data(a,"attribute-"+b);e===void 0&&d.data(a,"attribute-"+b,a.getAttribute(b)),a.setAttribute(b,c)},restoreAttribute:function(b,c){var e=d.data(b,"attribute-"+c);e!==void 0&&(a.toggleAttribute(b,c,e),d.data(b,"attribute-"+c,void 0))}},inView:{is:(a)=>{var b=a.getBoundingClientRect();return(0<=b.bottom&&b.bottom<=innerHeight||0<=b.top&&b.top<=innerHeight)&&(0<=b.right&&b.right<=innerWidth||0<=b.left&&b.left<=innerWidth)},when:(b)=>{var c=d.inView.observer=d.inView.observer||new IntersectionObserver(function(b){b.forEach((b)=>{this.unobserve(b.target),a.fire(b.target,"mv-inview",{entry:b})})});return new Promise((a)=>{d.is(b)&&a(),c.observe(b);var e=(c)=>{b.removeEventListener("mv-inview",e),c.stopPropagation(),a()};b.addEventListener("mv-inview",e)})}},scrollIntoViewIfNeeded:(a)=>{a&&!Mavo.inView.is(a)&&a.scrollIntoView({behavior:"smooth"})},setAttributeShy:function(a,b,c){a.hasAttribute(b)||a.setAttribute(b,c)},getAttribute:function(a,...b){for(let c,d,e=0;c=b[e];e++)if(d=a.getAttribute(c),d)return d;return null},getTarget:function(){var a=location.hash.substr(1);return document.getElementById(a)},in:function(a,b){if(a)return"object"==typeof a&&b in a||void 0!==a[b]},getCanonicalProperty:function(a,b){if(a&&(b||0===b)){if(d.in(a,b))return b;if(b.toLowerCase){var c=b.toLowerCase();if(d.in(a,c))return c;var e=Object.keys(a),f=e.map((a)=>a.toLowerCase()).indexOf(c);if(-1<f)return e[f]}}},subset:function(b,c,d){if(3==arguments.length){if(c.length){var e=c[c.length-1],f=a.value(b,...c.slice(0,-1));return Array.isArray(f)&&Array.isArray(d)?f.splice(e,1,...d):f[c[c.length-1]]=d,b}return d}return"object"==typeof b&&c&&c.length?c.reduce((a,b,d)=>{var e={},f=Mavo.Functions.get(a,b,e);return c[d]=Array.isArray(e.property)?e.property[0]:e.property,void 0===f&&e.query&&(f={[e.query.property]:e.query.value}),f},b):b},clone:function(a){return JSON.parse(d.safeToJSON(a))},debounce:function(a,b){if(!b)return a;var c,d=null;return function(){var e=this,f=arguments;c=function(){a.apply(e,f),removeEventListener("beforeunload",c)},clearTimeout(d),d=setTimeout(c,b),addEventListener("beforeunload",c)}},timeout:(a)=>new Promise((b)=>setTimeout(b,a)),escapeRegExp:(a)=>a.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),matches:(a,b)=>{var c=(a+"").match(b);return c?c:[]},match:(a,b,c=0)=>d.matches(a,b)[c]||"",observeResize:function(a,b){if(self.ResizeObserver){var c=null,d=b instanceof ResizeObserver?b:new ResizeObserver((a)=>{var d=a[a.length-1].contentRect;c&&c.width==d.width&&c.height==d.height||(b(a),c=d)});return d.observe(a),d}},Observer:a.Class({constructor:function(b,c,d,e={}){d instanceof MutationObserver&&(this.observer=d),this.observer=this.observer||new MutationObserver(d),this.element=b,this.callback=d,this.attribute=c,this.options=a.extend({},e),c&&a.extend(this.options,{attributes:!0,attributeFilter:"all"==this.attribute?void 0:Mavo.toArray(this.attribute),attributeOldValue:!!e.oldValue}),this.attribute&&"all"!=this.attribute||a.extend(this.options,{characterData:!0,childList:!0,subtree:!0,characterDataOldValue:!!e.oldValue}),this.run()},stop:function(){return this.observer&&this.observer.disconnect(),this.running=!1,this},run:function(){return this.observer&&(this.observer.observe(this.element,this.options),this.running=!0),this},sneak:function(a){if(this.running){this.stop();var b=a();this.run()}else var b=a();return b},destroy:function(){this.stop(),this.observer=this.element=null},static:{sneak:function(a,b){return a?a.sneak(b):b()}}}),defer:function(a){var b,c,d=new Promise((d,e)=>{a&&a(d,e),b=d,c=e});return d.resolve=(c)=>{return b(c),d},d.reject=(b)=>{return c(b),d},d},thenAll:function(c){return b(c).forEach((b)=>{"promise"==a.type(b)&&(b=b.catch((a)=>a))}),Promise.all(c).then((a)=>{return c.length==a.length?a:d.thenAll(c)})},rr:function(a){return a(),a},wrap:(a,b)=>0>a?b-1:a>=b?0:a,options:(a)=>{var b={};return(a.trim().match(/(?:\\[,;]|[^,;])+/g)||[]).forEach((a)=>{if(a){a=a.trim().replace(/\\([,;])/g,"$1");var c=a.match(/^\s*((?:\\:|[^:])+?)\s*:\s*(.+)$/);c?b[c[1].replace(/\\:/g,":")]=c[2]:b[a]=!0}}),b}});a.add("toggleAttribute",function(a,b,c=null!==b){c?this.setAttribute(a,b):this.removeAttribute(a)}),a.proxy=a.classProps.proxy=a.overload(function(a,b,c){return Object.defineProperty(a,b,{get:function(){return this[c][b]},set:function(a){this[c][b]=a},configurable:!0,enumerable:!0}),a}),a.classProps.propagated=function(a,b){Mavo.toArray(b).forEach((b)=>{var c=a[b];a[b]=function(){var a=c&&c.apply(this,arguments);this.propagate&&!1!==a&&this.propagate(b)}})};addEventListener("hashchange",c);new Mavo.Observer(document.documentElement,"id",c)})(Bliss,Bliss.$);
(function(a,b){var c=Mavo.Locale=a.Class({constructor:function(a,b){this.lang=a,this.phrases={},this.extend(b)},get fallback(){return c.all[this.baseLang]?c.all[this.baseLang]:this===c.default?void 0:c.default},extend:function(b){a.extend(this.phrases,b)},phrase:function(a,b){var c=a.toLowerCase(),d=this.phrases[c];if(void 0===d&&this.fallback&&(d=this.fallback.phrase(c)),void 0===d)d=Mavo.Functions.readable(c);else if(b){var e=Mavo.matches(d,/\{\w+(?=\})/g).map((a)=>a.slice(1));Mavo.Functions.unique(e).forEach((a)=>{a in b&&(d=d.replace(RegExp(`{${a}}`,"gi"),b[a]))})}return d},live:{lang:function(a){this.baseLang=c.getBaseLang(a),a==this.baseLang&&(this.baseLang=null)}},static:{all:{},register:function(a,b){c.all[a]?c.all[a].extend(b):c.all[a]=new c(a,b)},match:function(a=""){return c.all[a]||c.all[c.getBaseLang(a)]},get:function(a){return c.match(a)||c.default},getBaseLang:function(a){return a.split("-")[0]},lazy:{default:()=>{return c.match(Mavo.locale)||c.all.en}}}});Mavo.prototype._=function(a,b){return this.locale&&a?this.locale.phrase(a,b):a},a.ready().then(()=>{b("datalist.mv-phrases[lang]").forEach((a)=>{var c=b("option",a).reduce((a,b)=>{return a[b.value]=b.textContent.trim(),a},{});Mavo.Locale.register(a.lang,c)})})})(Bliss,Bliss.$);
Mavo.Locale.register("en",{edit:"Edit",save:"Save",import:"Import",export:"Export",logout:"Logout",login:"Login",loading:"Loading",uploading:"Uploading",saving:"Saving","logged-in-as":"Logged in to {id} as ","login-to":"Login to {id}","error-uploading":"Error uploading file","cannot-load-uploaded-file":"Cannot load uploaded file","problem-saving":"Problem saving data","problem-loading":"Problem loading data","cannot-parse":"Can\u2019t understand this file","http-error":"HTTP error {status}: {statusText}","cant-connect":"Can\u2019t connect to the Internet","add-item":"Add {name}","add-item-before":"Add new {name} before","add-item-after":"Add new {name} after","drag-to-reorder":"Drag to reorder {name}","delete-item":"Delete this {name}","gh-updated-file":"Updated {name}","gh-edit-suggestion-saved-in-profile":"Your edits are saved to <a href=\"{previewURL}\" target=\"_blank\">your own profile</a>, because you are not allowed to edit this page.","gh-edit-suggestion-instructions":"Write a short description of your edits below to suggest them to the page admins:","gh-edit-suggestion-notreviewed":"You have selected to suggest your edits to the page admins. Your suggestions have not been reviewed yet.","gh-edit-suggestion-send":"Send edit suggestion","gh-edit-suggestion-revoke":"Revoke edit suggestion","gh-edit-suggestion-reason-placeholder":"I added / corrected / deleted ...","gh-edit-suggestion-cancelled":"Edit suggestion cancelled successfully!","gh-edit-suggestion-title":"Suggested edits to data","gh-edit-suggestion-body":`Hello there! I used Mavo to suggest the following edits:
{description}
Preview my changes here: {previewURL}`,"gh-edit-suggestion-sent":"Edit suggestion sent successfully!"});
(function(a,b){Mavo.attributes.push("mv-plugins");var c=Mavo.Plugins={loaded:{},load:function(){return c.plugins=new Set,b("[mv-plugins]").forEach((a)=>{a.getAttribute("mv-plugins").trim().split(/\s+/).forEach((a)=>c.plugins.add(a))}),c.plugins.size?a.fetch(c.url+"/plugins.json",{responseType:"json"}).then((b)=>{return Mavo.thenAll(b.response.plugin.filter((a)=>c.plugins.has(a.id)).map((b)=>{if(b.repo)var d=`https://raw.githubusercontent.com/${b.repo}/`;else var d=`${c.url}/${b.id}/`;var e=`${d}mavo-${b.id}.js`;return a.include(c.loaded[b.id],e)}))}):Promise.resolve()},register:function(b,d={}){if(!c.loaded[b]){for(let b in Mavo.hooks.add(d.hooks),d.extend){let c="Mavo"==b?Mavo:Mavo[b];"function"===a.type(c)?a.Class(c,d.extend[b]):a.extend(c,d.extend[b])}var e=[];if(d.ready&&e.push(d.ready),d.dependencies){var f=document.currentScript?document.currentScript.src:location,g=d.dependencies.map((a)=>Mavo.load(a,f));e.push(...g)}e.length&&Mavo.dependencies.push(...e),c.loaded[b]=d,d.init&&Promise.all(e).then(()=>d.init())}},url:"https://plugins.mavo.io"}})(Bliss,Bliss.$);
(function(b){Mavo.attributes.push("mv-bar");var a=Mavo.UI.Bar=b.Class({constructor:function(c){if(this.mavo=c,this.element=b(".mv-bar",this.mavo.element),this.template=this.mavo.element.getAttribute("mv-bar")||"",this.element)for(let c in this.custom=!0,this.template+=" "+(this.element.getAttribute("mv-bar")||""),this.template=this.template.trim(),a.controls)this[c]=b(`.mv-${c}`,this.element),this[c]&&(this.template=this.template||"with",this.template+=` ${c}`);else this.element=b.create({className:"mv-bar mv-ui",start:this.mavo.element,innerHTML:"<button>&nbsp;</button>"});for(let d in this.element.classList.contains("mv-compact")&&(this.noResize=!0),/\byes-\w+/.test(this.template)&&console.warn(`${this.mavo.id}: You used mv-bar="${this.template}". Note that yes-* in mv-bar is deprecated and will be removed in v0.1.6. Please use the new syntax: http://mavo.io/docs/ui/#bar`),this.controls=a.getControls(this.template),this.controls.length&&(this.targetHeight=this.element.offsetHeight),this.custom||(this.element.innerHTML=""),this.controls.forEach((c)=>{let d=a.controls[c];for(var e in this[c]&&this[c].remove(),d.create?this[c]=d.create.call(this.mavo,this[c]):!this[c]&&(this[c]=b.create("button",{className:`mv-${c}`,textContent:this.mavo._(c)})),this.add(c),d.permission?this.permissions.can(d.permission,()=>{this.toggle(c,!d.condition||d.condition.call(this.mavo))},()=>{this.remove(c)}):d.condition&&!d.condition.call(this.mavo)&&this.remove(c),d.events)b.bind(this[c],e,d.events[e].bind(this.mavo))}),a.controls){let c=a.controls[d];c.action&&b.delegate(this.mavo.element,"click",".mv-"+d,(a)=>{(!c.permission||this.permissions.is(c.permission))&&(c.action.call(this.mavo),a.preventDefault())})}this.controls.length&&!this.noResize&&(this.resize(),self.ResizeObserver&&(this.resizeObserver=Mavo.observeResize(this.element,()=>{this.resize()})))},resize:function(){return this.targetHeight?void(this.resizeObserver&&this.resizeObserver.disconnect(),this.element.classList.remove("mv-compact","mv-tiny"),this.element.offsetHeight>1.6*this.targetHeight&&(this.element.classList.add("mv-compact"),this.element.offsetHeight>1.2*this.targetHeight&&this.element.classList.add("mv-tiny")),this.resizeObserver&&this.resizeObserver.observe(this.element)):void(this.targetHeight=this.element.offsetHeight)},add:function(b){var c=a.controls[b];c.prepare&&c.prepare.call(this.mavo),Mavo.revocably.add(this[b],this.element),this.resizeObserver||this.noResize||requestAnimationFrame(()=>this.resize())},remove:function(b){var c=a.controls[b];Mavo.revocably.remove(this[b],"mv-"+b),c.cleanup&&c.cleanup.call(this.mavo),this.resizeObserver||this.noResize||requestAnimationFrame(()=>this.resize())},toggle:function(a,b){return this[b?"add":"remove"](a)},proxy:{permissions:"mavo"},static:{getControls:function(b){var c=Object.keys(a.controls);if(b&&(b=b.trim())){if("none"==b)return[];var d=/^with\s|\b(yes|no)-\w+\b/.test(b);b=b.replace(/\byes-|^with\s+/g,"");var e=b.split(/\s+/);return e=Mavo.Functions.unique(e.reverse()).reverse(),d?c.filter((b)=>{var c=Math.max,d=e.lastIndexOf(b),f=e.lastIndexOf("no-"+b),g=d>c(-1,f),h=f>c(-1,d);return g||!a.controls[b].optional&&!h}):e}return c.filter((b)=>!a.controls[b].optional)},controls:{status:{create:function(a){return a||b.create({className:"mv-status"})},prepare:function(){var a=this.primaryBackend;if(a&&a.user){var b=a.user,c=b.name||"";b.avatar&&(c=`<img class="mv-avatar" src="${b.avatar}" /> ${c}`),b.url&&(c=`<a href="${b.url}" target="_blank">${c}</a>`),this.bar.status.innerHTML=`<span>${this._("logged-in-as",a)}</span> `+c}},permission:"logout"},edit:{action:function(){this.editing?this.done():this.edit()},permission:["edit","add","delete"],cleanup:function(){this.editing&&this.done()},condition:function(){return this.needsEdit}},save:{action:function(){this.save()},events:{"mouseenter focus":function(){this.element.classList.add("mv-highlight-unsaved")},"mouseleave blur":function(){this.element.classList.remove("mv-highlight-unsaved")}},permission:"save",condition:function(){return!this.autoSave||0<this.autoSaveDelay}},export:{create:function(c){var d;return d=c?c.matches("a")?c:b.create("a",{className:"mv-button",around:c}):b.create("a",{className:"mv-export mv-button",textContent:this._("export")}),d.setAttribute("download",this.id+".json"),d},events:{mousedown:function(){this.bar.export.href="data:application/json;charset=UTF-8,"+encodeURIComponent(this.toJSON())}},permission:"edit",optional:!0},import:{create:function(a){var c=a||b.create("span",{role:"button",tabIndex:"0",className:"mv-import mv-button",textContent:this._("import"),events:{focus:()=>{d.focus()}}}),d=b.create("input",{type:"file",inside:c,events:{change:(a)=>{var c=a.target.files[0];if(c){var d=b.extend(new FileReader,{onload:()=>{this.inProgress=!1;try{var a=JSON.parse(d.result);this.render(a)}catch(a){this.error(this._("cannot-parse"))}},onerror:()=>{this.error(this._("problem-loading"))}});this.inProgress=this._("uploading"),d.readAsText(c)}}}});return c},optional:!0},login:{action:function(){this.primaryBackend.login()},permission:"login"},logout:{action:function(){this.primaryBackend.logout()},permission:"logout"}}}})})(Bliss,Bliss.$);
(function(a){Mavo.UI.Message=a.Class({constructor:function(b,c,d){if(this.mavo=b,this.message=c,this.closed=Mavo.defer(),this.element=a.create({className:"mv-ui mv-message"+(d.type?" mv-"+d.type:""),innerHTML:this.message,events:{click:()=>Mavo.scrollIntoViewIfNeeded(this.mavo.element)},[this.mavo.bar?"after":"start"]:(this.mavo.bar||this.mavo).element}),d.classes&&this.element.classList.add(d.classes),"error"==d.type?this.element.setAttribute("role","alert"):this.element.setAttribute("aria-live","polite"),d.dismiss=d.dismiss||{},"string"==typeof d.dismiss||Array.isArray(d.dismiss)){var e={};Mavo.toArray(d.dismiss).forEach((a)=>{e[a]=!0}),d.dismiss=e}if(d.dismiss.button&&a.create("button",{className:"mv-close mv-ui",textContent:"\xD7",events:{click:()=>this.close()},start:this.element}),d.dismiss.timeout){var f,g="number"==typeof d.dismiss.timeout?d.dismiss.timeout:5e3;a.bind(this.element,{mouseenter:()=>clearTimeout(f),mouseleave:Mavo.rr(()=>f=setTimeout(()=>this.close(),g))})}d.dismiss.submit&&this.element.addEventListener("submit",(a)=>{a.preventDefault(),this.close(a.target)})},close:function(b){a.transition(this.element,{opacity:0}).then(()=>{a.remove(this.element),this.closed.resolve(b)})}})})(Bliss,Bliss.$);
(function(a){var b=Mavo.Permissions=a.Class({constructor:function(c){this.triggers=[],this.hooks=new a.Hooks,this.parentChanged=b.prototype.parentChanged.bind(this),this.set(c)},set:function(a){for(var b in a)this[b]=a[b]},on:function(a){return Mavo.toArray(a).forEach((a)=>this[a]=!0),this},off:function(a){return a=Array.isArray(a)?a:[a],a.forEach((a)=>this[a]=!1),this},can:function(a,b,c){this.observe(a,!0,b),c&&this.cannot(a,c)},cannot:function(a,b){this.observe(a,!1,b)},observe:function(a,b,c){a=Mavo.toArray(a),this.is(a,b)&&c(),this.triggers.push({actions:a,value:b,callback:c,active:!0})},is:function(a,b=!0){var c=Mavo.toArray(a).map((a)=>!!this[a]).reduce((a,b)=>a||b);return b?c:!c},onchange:function(a){this.hooks.add("change",a),b.actions.forEach((b)=>{a.call(this,{action:b,value:this[b]})})},parentChanged:function(b={}){var c=this["_"+b.action];void 0!==c||b.from==b.value||(this.fireTriggers(b.action),this.hooks.run("change",a.extend({context:this},b)))},changed:function(a,b,c){c=!!c,b=!!b;b==c||(this["_"+a]=b,this.fireTriggers(a),this.hooks.run("change",{action:a,value:b,from:c,context:this}))},fireTriggers:function(a){this.triggers.forEach((b)=>{var c=this.is(b.actions,b.value);b.active&&-1<b.actions.indexOf(a)&&c?(b.active=!1,b.callback()):!c&&(b.active=!0)})},or:function(a){return b.actions.forEach((b)=>{this[b]=this[b]||a[b]}),this},live:{parent:function(a){var c=this._parent;c==a||(this._parent=a,c&&Mavo.delete(c.hooks.change,this.parentChanged),b.actions.forEach((b)=>{this.parentChanged({action:b,value:a?a[b]:void 0,from:c?c[b]:void 0})}),a&&a.onchange(this.parentChanged))}},static:{actions:[],register:function(c,d){return Array.isArray(c)?void c.forEach((a)=>b.register(a,d)):void(a.live(b.prototype,c,{get:function(){var a=this["_"+c];return void 0===a&&this.parent?this.parent[c]:a},set:function(a,b){d&&d.call(this,a,b),this.changed(c,a,b)}}),b.actions.push(c))}}});b.register(["read","save"]),b.register("login",function(a){a&&this.logout&&(this.logout=!1)}),b.register("logout",function(a){a&&this.login&&(this.login=!1)}),b.register("edit",function(a){a&&(this.add=this.delete=!0)}),b.register(["add","delete"],function(a){a||(this.edit=!1)})})(Bliss,Bliss.$);
(function(a){var b=Mavo.Backend=a.Class({constructor:function(a,b={}){this.source=a,this.url=new URL(this.source,Mavo.base),this.mavo=b.mavo,this.format=Mavo.Formats.create(b.format,this),this.permissions=new Mavo.Permissions},get:function(b=new URL(this.url)){return b.searchParams.set("timestamp",Date.now()),a.fetch(b.href).then((a)=>Promise.resolve(a.responseText),()=>Promise.resolve(null))},load:function(){return this.ready.then(()=>this.get()).then((a)=>{return"string"==typeof a?(a=a.replace(/^\ufeff/,""),this.format.parse(a)):a})},store:function(a,{path:b,format:c=this.format}={}){return this.ready.then(()=>{var d="string"==typeof a?Promise.resolve(a):c.stringify(a);return d.then((c)=>this.put(c,b).then(()=>{return{data:a,serialized:c}}))})},ready:Promise.resolve(),login:()=>Promise.resolve(),logout:()=>Promise.resolve(),put:()=>Promise.reject(),isAuthenticated:function(){return!!this.accessToken},oAuthParams:()=>"",toString:function(){return`${this.id} (${this.url})`},equals:function(a){return a===this||a&&this.id==a.id&&this.source==a.source},request:function(b,c,d="GET",e={}){return e.method=e.method||d,e.responseType=e.responseType||"json",e.headers=a.extend({"Content-Type":"application/json; charset=utf-8"},e.headers||{}),e.data=c,this.isAuthenticated()&&(e.headers.Authorization=e.headers.Authorization||`Bearer ${this.accessToken}`),"object"===a.type(e.data)&&("GET"==e.method?e.data=Object.keys(e.data).map((a)=>a+"="+encodeURIComponent(e.data[a])).join("&"):e.data=JSON.stringify(e.data)),b=new URL(b,this.constructor.apiDomain),"GET"==e.method&&b.searchParams.set("timestamp",Date.now()),a.fetch(b,e).catch((a)=>{return a&&a.xhr?Promise.reject(a.xhr):void this.mavo.error("Something went wrong while connecting to "+this.id,a)}).then((a)=>"HEAD"==e.method?a:a.response)},oAuthenticate:function(a){return this.ready.then(()=>{return this.isAuthenticated()?Promise.resolve():new Promise((b,c)=>{var d=Math.min,e=this.id.toLowerCase();if(a)this.accessToken=localStorage[`mavo:${e}token`],this.accessToken&&b(this.accessToken);else{var f={width:d(1e3,innerWidth-100),height:d(800,innerHeight-100)};f.top=(screen.height-f.height)/2,f.left=(screen.width-f.width)/2;var g={url:location.href,backend:this.id};if(this.authPopup=open(`${this.constructor.oAuth}?client_id=${this.key}&state=${encodeURIComponent(JSON.stringify(g))}`+this.oAuthParams(),"popup",`width=${f.width},height=${f.height},left=${f.left},top=${f.top}`),!this.authPopup){var h="Login popup was blocked! Please check your popup blocker settings.";this.mavo.error(h),c(Error(h))}addEventListener("message",(a)=>{if(a.source===this.authPopup)for(var d in a.data.backend==this.id&&(this.accessToken=localStorage[`mavo:${e}token`]=a.data.token),this.accessToken||c(Error("Authentication error")),b(this.accessToken),Mavo.all){var f=Mavo.all[d].primaryBackend;f&&f.id===this.id&&f!==this&&!f.isAuthenticated()&&f.login(!0)}})}})})},oAuthLogout:function(){if(this.isAuthenticated()){var b=this.id.toLowerCase();localStorage.removeItem(`mavo:${b}token`),delete this.accessToken,this.permissions.off(["edit","add","delete","save"]).on("login"),a.fire(this.mavo.element,"mv-logout",{backend:this})}return Promise.resolve()},static:{create:function(a,c,d){var e;return d&&(e=Mavo.Functions.get(b,d)),a&&!e&&(e=b.types.filter((b)=>b.test(a))[0]||b.Remote),e?new e(a,c):null},types:[],register:function(a){return b[a.prototype.id]=a,b.types.push(a),a}}});b.register(a.Class({id:"Element",extends:b,constructor:function(){this.permissions.on(["read","edit","save"]),this.element=a(this.source)||a.create("script",{type:"application/json",id:this.source.slice(1),inside:document.body})},get:function(){return Promise.resolve(this.element.textContent)},put:function(a){return Promise.resolve(this.element.textContent=a)},static:{test:(a)=>0===a.indexOf("#")}})),b.register(a.Class({id:"Remote",extends:b,constructor:function(){this.permissions.on("read")},static:{test:()=>!1}})),b.register(a.Class({extends:b,id:"Local",constructor:function(){this.permissions.on(["read","edit","save"]),this.key=this.mavo.id},get:function(){return Promise[this.key in localStorage?"resolve":"reject"](localStorage[this.key])},put:function(a){return a?localStorage[this.key]=a:delete localStorage[this.key],Promise.resolve(a)},static:{test:(a)=>"local"==a}}))})(Bliss,Bliss.$);
(function(a){var b=Mavo.Formats={},c=b.Base=a.Class({abstract:!0,constructor:function(a){this.backend=a},proxy:{mavo:"backend"},parse:function(a){return this.constructor.parse(a,this)},stringify:function(a){return this.constructor.stringify(a,this)},static:{parse:(a)=>Promise.resolve(a),stringify:(a)=>Promise.resolve(a),extensions:[],dependencies:[],ready:function(){return Promise.all(this.dependencies.map((b)=>a.include(b.test(),b.url)))}}}),d=b.JSON=a.Class({extends:b.Base,static:{parse:(a)=>Promise.resolve(a?JSON.parse(a):null),stringify:(a)=>Promise.resolve(Mavo.toJSON(a)),extensions:[".json",".jsonld"]}}),e=b.Text=a.Class({extends:b.Base,constructor:function(){this.property=this.mavo.root.getNames("Primitive")[0]},static:{extensions:[".txt"],parse:(a,b)=>Promise.resolve({[b?b.property:"content"]:a}),stringify:(a,b)=>Promise.resolve(a[b?b.property:"content"])}}),f=b.CSV=a.Class({extends:b.Base,constructor:function(){this.property=this.mavo.root.getNames("Collection")[0],this.options=a.extend({},b.CSV.defaultOptions)},static:{extensions:[".csv",".tsv"],defaultOptions:{header:!0,dynamicTyping:!0,skipEmptyLines:!0},dependencies:[{test:()=>self.Papa,url:"https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.1.4/papaparse.min.js"}],ready:c.ready,parse:(a,b)=>f.ready().then(()=>{var c=Papa.parse(a,f.defaultOptions),d=b?b.property:"content";if(b&&(b.options.delimiter=c.meta.delimiter,b.options.linebreak=c.meta.linebreak),c.meta.aborted)throw c.meta.errors.pop();return{[d]:c.data}}),stringify:(a,b)=>f.ready().then(()=>{var c=b?b.property:"content",d=b?b.options:f.defaultOptions;return Papa.unparse(a[c],d)})}});Object.defineProperty(b,"create",{value:function(a,c){if(a&&"object"==typeof a)return a;if("string"==typeof a)for(var d in a=a.toLowerCase(),b){var e=b[d];if(d.toLowerCase()==a)return new e(c)}if(!a){var f=c.url?c.url.pathname:c.source,g=Mavo.match(f,/\.\w+$/)||".json",e=b.JSON;for(var d in b)-1<b[d].extensions.indexOf(g)&&(e=b[d]);return new e(c)}}})})(Bliss,Bliss.$);
(function(a,b){var c=Mavo.Node=a.Class({abstract:!0,constructor:function(b,d,e={}){if(!b||!d)throw new Error("Mavo.Node constructor requires an element argument and a mavo object");var f={context:this,options:e};this.uid=++c.maxId,this.nodeType=this.nodeType,this.property=null,this.element=b,a.extend(this,f.options),c.all.set(b,[...(c.all.get(this.element)||[]),this]),this.mavo=d,this.group=this.parentGroup=f.options.group,this.template=f.options.template,this.alias=this.element.getAttribute("mv-alias"),this.template?this.template.copies.push(this):this.copies=[],this.fromTemplate("property","type")||(this.property=c.getProperty(b),this.type=Mavo.Group.normalize(b),this.storage=this.element.getAttribute("mv-storage")),this.modes=this.element.getAttribute("mv-mode"),Mavo.hooks.run("node-init-start",f),this.mode=Mavo.getStyle(this.element,"--mv-mode")||"read",this.collection=f.options.collection,this.collection&&(this.group=this.parentGroup=this.collection.parentGroup);var g=this.template;if(g&&g.expressions&&(this.expressions=g.expressions.map((a)=>new Mavo.DOMExpression({template:a,item:this,mavo:this.mavo}))),this instanceof Mavo.Group||this.collection){var h=Mavo.DOMExpression.search(this.element).filter((a)=>"mv-value"==a.originalAttribute)[0];h&&(h.mavoNode=this,this.expressionText=h,this.storage=this.storage||"none",this.modes="read",this.collection&&(this.collection.expressions=[...(this.collection.expressions||[]),h],h.mavoNode=this.collection,this.collection.storage=this.collection.storage||"none",this.collection.modes="read"))}Mavo.hooks.run("node-init-end",f)},get editing(){return"edit"==this.mode},get isRoot(){return!this.property},get name(){return Mavo.Functions.readable(this.property||this.type).toLowerCase()},get saved(){return"none"!==this.storage},get parent(){return this.collection||this.parentGroup},postInit:function(){"edit"==this.modes&&this.edit()},destroy:function(){this.template&&Mavo.delete(this.template.copies,this),this.expressions&&this.expressions.forEach((a)=>a.destroy()),this.itembar&&this.itembar.destroy()},getData:function(a={}){if(this.isDataNull(a))return a.forceObjects?Mavo.objectify(null):null},isDataNull:function(a){var b={context:this,options:a,result:this.deleted||!this.saved&&!a.live};return Mavo.hooks.run("unit-isdatanull",b),b.result},walk:function(a,b=[],c={}){var d=(b,e)=>{var f=a(b,e);if(!1!==f)for(let a in b.children){let g=b.children[a];if(g instanceof Mavo.Node){var f=d.call(g,g,[...e,a]);if(!1===f&&!c.descentReturn)return!1}}return!1!==f};return d(this,b)},walkUp:function(a){for(var b=this;b=b.parentGroup;){var c=a(b);if(c!==void 0)return c}},edit:function(){return this.mode="edit","edit"==this.mode&&void(a.fire(this.element,"mv-edit",{mavo:this.mavo,node:this}),Mavo.hooks.run("node-edit-end",this))},done:function(){return this.mode=Mavo.getStyle(this.element.parentNode,"--mv-mode")||"read","read"==this.mode&&void(a.unbind(this.element,".mavo:edit"),a.fire(this.element,"mv-done",{mavo:this.mavo,node:this}),this.propagate("done"),Mavo.hooks.run("node-done-end",this))},propagate:function(a){for(let b in this.children){let c=this.children[b];c instanceof Mavo.Node&&("function"==typeof a?a.call(c,c):a in c&&c[a]())}},propagated:["save","destroy"],toJSON:Mavo.prototype.toJSON,fromTemplate:function(...a){return this.template&&a.forEach((a)=>this[a]=this.template[a]),!!this.template},render:function(a){this.oldData=this.data,this.data=a,a=Mavo.subset(a,this.inPath);var b={context:this,data:a};if(Mavo.hooks.run("node-render-start",b),"Collection"!=this.nodeType&&Array.isArray(a)){var c;this.isRoot&&1===(c=Object.keys(this.children)).length&&"Collection"===this.children[c[0]].nodeType?b.data={[c[0]]:b.data}:(this.inPath.push("0"),b.data=b.data[0])}this.editing?(this.done(),this.dataRender(b.data),this.edit()):this.dataRender(b.data),this.save(),Mavo.hooks.run("node-render-end",b)},dataChanged:function(b,c={}){a.fire(c.element||this.element,"mv-change",a.extend({property:this.property,action:b,mavo:this.mavo,node:this},c))},toString:function(){return`#${this.uid}: ${this.nodeType} (${this.property})`},getClosestCollection:function(){var a=this.closestItem;return a?a.collection:null},getClosestItem:function(){return this.collection&&this.collection.mutable?this:this.parentGroup?this.parentGroup.closestItem:null},isDeleted:function(){this.deleted;return!!this.deleted||!!this.parentGroup&&this.parentGroup.isDeleted()},resolve:function(a){var b=this.find(a);return void 0===b&&(b=this.walkUp((b)=>{return b.property==a?b:a in b.children?b.children[a]:void 0})),void 0===b&&(b=this.mavo.root.find(a)),b},relativizeData:self.Proxy?function(a,b={live:!0}){var c={};return new Proxy(a,{get:(a,b,d)=>{return b in a?a[b]:b in d&&b in c?c[b]:void 0},has:(a,d)=>{if(d in a||d in c)return!0;switch(d){case"$index":return c[d]=this.index||0,!0;case"$next":case"$previous":return this.closestCollection?(c[d]=this.closestCollection.getData(b)[this.index+("$next"==d?1:-1)],!0):(c[d]=null,!1);}var e=this.resolve(d);return void 0===e?d in Mavo.all&&Mavo.all[d].root&&(c[d]=Mavo.all[d].root.getData(b)):(Array.isArray(e)?e=e.map((a)=>a.getData(b)).filter((a)=>null!==a):e instanceof Mavo.Node&&(e=e.getData(b)),c[d]=e,!0)},set:function(a,b="",c){return console.warn(`You cannot set data via expressions. Attempt to set ${b.toString()} to ${c} ignored.`),c}})}:(a)=>a,pathFrom:function(a){for(var b=this.path,c=a.path,d=0;d<b.length&&c[d]==b[d];d++);return b.slice(d)},getDescendant:function(a){return a.reduce((a,b)=>a.children[b],this)},getCousin:function(a,b={}){if(!this.closestCollection)return null;var c=this.closestCollection,d=Math.abs(a),e=0>a?-1:1;if(c.length<d+1)return null;var f=this.closestItem.index+a;b.wrap&&(f=Mavo.wrap(f,c.length));for(var g,h=0;h<c.length;h++){g=f+h*e,g=b.wrap?Mavo.wrap(g,c.length):g;var i=c.children[g];if(!i||!i.isDeleted())break}if(!i||i.isDeleted()||i==this.closestItem)return null;if(this.collection)return i;var j=this.pathFrom(this.closestItem);return i.getDescendant(j)},contains:function(a){do{if(a===this)return!0;a=a.parent}while(a);return!1},lazy:{closestCollection:function(){return this.getClosestCollection()},closestItem:function(){return this.getClosestItem()},inPath:function(){var a="Collection"==this.nodeType?"mv-multiple-path":"mv-path";return(this.element.getAttribute(a)||"").split("/").filter((a)=>a.length)},properties:function(){if(this.template)return this.template.properties;var a=new Set(this.property&&[this.property]);if("Group"==this.nodeType)for(var b in this.children)a=Mavo.union(a,this.children[b].properties);else"Collection"==this.nodeType&&(a=Mavo.union(a,this.itemTemplate.properties));return a}},live:{store:function(b){a.toggleAttribute(this.element,"mv-storage",b)},unsavedChanges:function(a){return!a||this.saved&&this.editing||(a=!1),this.element.classList.toggle("mv-unsaved-changes",a),a},mode:function(b){if(this._mode!=b){if(this.modes&&b!=this.modes&&(b=this.modes),this._mode=b,!(this instanceof Mavo.Collection)&&-1<[null,"","read","edit"].indexOf(this.element.getAttribute("mv-mode"))){var c=this.modes||"edit"==b;Mavo.Observer.sneak(this.mavo.modeObserver,()=>{a.toggleAttribute(this.element,"mv-mode",b,c)})}return b}},modes:function(a){return a&&"read"!=a&&"edit"!=a?null:void(this._modes=a,a&&this.mode!=a&&(this.mode=a))},deleted:function(c){this.element.classList.toggle("mv-deleted",c),c?(this.elementContents=document.createDocumentFragment(),b(this.element.childNodes).forEach((a)=>{this.elementContents.appendChild(a)}),a.contents(this.element,[{tag:"button",className:"mv-close mv-ui",textContent:"\xD7",events:{click:function(){a.remove(this.parentNode)}}},"Deleted "+this.name,{tag:"button",className:"mv-undo mv-ui",textContent:"Undo",events:{click:()=>this.deleted=!1}}]),this.element.classList.remove("mv-highlight"),this.itembar.remove()):this.deleted&&(this.element.textContent="",this.element.appendChild(this.elementContents),this._deleted=!1,this.dataChanged("undelete"),this.itembar.add())},path:{get:function(){var a=this.parent?this.parent.path:[];return this.property?[...a,this.property]:a}}},static:{maxId:0,all:new WeakMap,create:function(a,b,c={}){return Mavo.is("multiple",a)&&!c.collection?new Mavo.Collection(a,b,c):new Mavo[Mavo.is("group",a)?"Group":"Primitive"](a,b,c)},getProperty:function(a){var b=a.getAttribute("property")||a.getAttribute("itemprop");return b||(a.hasAttribute("property")?b=a.name||a.id||a.classList[0]:a.matches(Mavo.selectors.multiple)&&(b=a.getAttribute("mv-multiple")||"collection")),b&&a.setAttribute("property",b),b},get:function(a,b){var d=(c.all.get(a)||[]).filter((a)=>!(a instanceof Mavo.Collection));return 2>d.length||!b?d[0]:d[0]instanceof Mavo.Group?node[1]:void 0},children:function(a){var c=Mavo.Node.get(a);return c?[c]:(c=b(Mavo.selectors.property,a).map((a)=>Mavo.Node.get(a)).filter((b)=>!a.contains(b.parentGroup.element)).map((a)=>a.collection||a),Mavo.Functions.unique(c))}}})})(Bliss,Bliss.$);
(function(a,b){var c=Mavo.Group=a.Class({extends:Mavo.Node,nodeType:"Group",constructor:function(){if(this.children={},this.group=this,Mavo.hooks.run("group-init-start",this),Mavo.Primitive.getValueAttribute(this.element))this.children[this.property]=new Mavo.Primitive(this.element,this.mavo,{group:this});var a=b(Mavo.selectors.property+", "+Mavo.selectors.multiple,this.element).filter((a)=>{return this.element===a.parentNode.closest(Mavo.selectors.group)}),c=a.map((a)=>Mavo.Node.getProperty(a));a.forEach((a,b)=>{var d=c[b],e=this.template?this.template.children[d]:null,f={template:e,group:this};if(this.children[d]){var g=this.children[d];g.add(a),g.mutable=g.mutable||Mavo.is("multiple",a)}else this.children[d]=c.indexOf(d)==c.lastIndexOf(d)?Mavo.Node.create(a,this.mavo,f):new Mavo.Collection(a,this.mavo,f)});var d=(this.isRoot?this.element.closest("[vocab]"):null)||this.element;this.vocab=d.getAttribute("vocab"),this.postInit(),Mavo.hooks.run("group-init-end",this)},get isRoot(){return!this.property},getNames:function(a="Node"){return Object.keys(this.children).filter((b)=>this.children[b]instanceof Mavo[a])},getData:function(b={}){var d={context:this,options:b,data:this.super.getData.call(this,b)};if(void 0!==d.data)return d.data;d.data=(this.data?Mavo.clone(Mavo.subset(this.data,this.inPath)):{})||{};var e=Object.keys(this.children);if(1==e.length&&e[0]==this.property){var f=a.extend(a.extend({},d.options),{forceObjects:!0});d.data=this.children[this.property].getData(f)}else for(var g in this.children){var h=this.children[g];if(h.saved||d.options.live){var i=h.getData(d.options);null!==i||d.options.live?d.data[h.property]=i:delete d.data[h.property]}}return d.options.live?d.data&&(d.data[Mavo.toNode]=this,d.data=this.relativizeData(d.data)):(d.data=Mavo.subset(this.data,this.inPath,d.data),e.length||this.isRoot?d.data&&"object"==typeof d.data&&(this.type&&this.type!=c.DEFAULT_TYPE&&(d.data["@type"]=this.type),this.vocab&&(d.data["@context"]=this.vocab)):d.data=null),Mavo.hooks.run("node-getdata-end",d),d.data},find:function(a,b={}){if(this.property==a)return this;if(a in this.children)return this.children[a].find(a,b);if(this.properties.has(a)){var c,d,e=[];for(var f in this.children)d=this.children[f].find(a,b),void 0!==d&&(Array.isArray(d)?(e.push(...d),c=!0):e.push(d));return c||1<e.length?e:e[0]}},edit:function(a={}){return!1!==this.super.edit.call(this)&&Promise.all(Object.keys(this.children).map((b)=>this.children[b].edit(a)))},save:function(){this.unsavedChanges=!1},propagated:["save","import"],dataRender:function(b){if(b){if("object"!=typeof b){if(this.property in this.children)var c=this.property;else var d=a.type(b),e=(a)=>(this.children[a]instanceof Mavo.Primitive)+(this.children[a].datatype==d),c=Object.keys(this.children).filter((a)=>!this.children[a].expressionText).sort((a,b)=>e(a)-e(b)).reverse()[0];b={[c]:b},this.data=Mavo.subset(this.data,this.inPath,b)}var f;this.propagate((c)=>{var d=b[c.property];c.alias&&void 0!==b[c.alias]&&(f=f||a.extend({},b),d=b[c.alias]),c.render(d)}),f&&this.propagate((a)=>{a.alias&&(b[a.property]=f[a.alias],!(a.alias in this.children)&&delete b[a.alias])});var c}},static:{all:new WeakMap,DEFAULT_TYPE:"Item",normalize:function(a){if(Mavo.is("group",a)){var b=Mavo.getAttribute(a,"typeof","itemtype")||c.DEFAULT_TYPE;return a.setAttribute("typeof",b),b}return null}}})})(Bliss,Bliss.$);
(function(a,b){var c=Mavo.Primitive=a.Class({extends:Mavo.Node,nodeType:"Primitive",constructor:function(d){this.fromTemplate("config","attribute","templateValue","originalEditor")||(this.config=c.getConfig(d),this.attribute=this.config.attribute),this.datatype=this.config.datatype,"modes"in this.config&&(this.modes=this.config.modes,this.element.setAttribute("mv-mode",this.config.modes)),Mavo.hooks.run("primitive-init-start",this),this.expressionText=this.expressionText||Mavo.DOMExpression.search(this.element,this.attribute),this.expressionText&&!this.expressionText.mavoNode&&(this.expressionText.primitive=this,this.storage=this.storage||"none",this.modes="read",this.element.setAttribute("aria-live","polite")),!this.editor&&this.element.hasAttribute("mv-edit")&&(!this.originalEditor&&(this.originalEditor=a(this.element.getAttribute("mv-edit"))),this.originalEditor&&!this.template&&(this.originalEditorObserver=new Mavo.Observer(this.originalEditor,"all",()=>{this.copies.concat(this).forEach((a)=>{"editor"==a.defaultSource&&(a.default=this.originalEditor.value),a.editor&&(a.editor=this.originalEditor.cloneNode(!0)),a.setValue(a.value,{force:!0,silent:!0})})}))),this.editor||this.originalEditor||this.attribute||(this.editor=b(this.element.children).filter(function(a){return a.matches(Mavo.selectors.formControl)&&!a.matches(Mavo.selectors.property)})[0],this.editor&&a.remove(this.editor));var e=this.editorValue;this.datatype||"number"!=typeof e&&"boolean"!=typeof e||(this.datatype=typeof e),this.config.init&&this.config.init.call(this,this.element),this.config.changeEvents&&a.bind(this.element,this.config.changeEvents,(a)=>{a.target===this.element&&(this.value=this.getValue())}),this.templateValue=this.getValue(),this._default=this.element.getAttribute("mv-default"),null===this.default?(this._default=this.modes?this.templateValue:e,this.defaultSource=this.modes?"template":"editor"):""===this.default?(this._default=this.templateValue,this.defaultSource="template"):(this.defaultObserver=new Mavo.Observer(this.element,"mv-default",()=>{this.default=this.element.getAttribute("mv-default")}),this.defaultSource="attribute");var f=!this.template||this.template.templateValue!=this.templateValue||"edit"==this.modes;this.initialValue=void 0===this.default&&f?this.templateValue:this.default,this.initialValue===void 0&&(this.initialValue=this.emptyValue),this.setValue(this.initialValue,{silent:!0}),Mavo.setAttributeShy(this.element,"aria-label",this.label),this.attribute||Mavo.setAttributeShy(this.element,"mv-attribute","none"),!1!==this.config.observer&&(this.observer=new Mavo.Observer(this.element,this.attribute,()=>{this.observer.running&&(this.attribute||!this.editing||this.config.subtree)&&(this.value=this.getValue())},{subtree:this.config.subtree,childList:this.config.subtree})),this.postInit(),Mavo.hooks.run("primitive-init-end",this)},get editorValue(){var b=this.editor||this.originalEditor;if(b){if(b.matches(Mavo.selectors.formControl))return c.getValue(b,{datatype:this.datatype});var d=a(Mavo.selectors.output+", "+Mavo.selectors.formControl,b);if(d)return c.getValue(d)}},set editorValue(b){if(this.config.setEditorValue&&"boolean"!==this.datatype)return this.config.setEditorValue.call(this,b);if(this.editor)if(this.editor.matches(Mavo.selectors.formControl))c.setValue(this.editor,b,{config:this.editorDefaults});else{var d=a(Mavo.selectors.output+", "+Mavo.selectors.formControl,this.editor);d&&c.setValue(d,b)}},destroy:function(){this.super.destroy.call(this),this.defaultObserver&&this.defaultObserver.destroy(),this.observer&&this.observer.destroy()},getData:function(a={}){var b={context:this,options:a,data:this.super.getData.call(this,a)};return void 0===b.data&&(b.data=this.value,""===b.data&&(b.data=null)),b.options.live?(this.collection||a.forceObjects)&&(b.data=Mavo.objectify(b.data,{[Mavo.toNode]:this}),this.collection&&(b.data[this.property]=b.data,b.data=this.relativizeData(b.data))):this.inPath.length&&(b.data=Mavo.subset(this.data,this.inPath,b.data)),Mavo.hooks.run("node-getdata-end",b),b.data},sneak:function(a){return Mavo.Observer.sneak(this.observer,a)},save:function(){this.savedValue=this.value,this.unsavedChanges=!1},initEdit:function(){if(!this.editor&&this.originalEditor&&(this.editor=this.originalEditor.cloneNode(!0)),!this.editor){var c=this.config.editor;c&&"boolean"!=this.datatype||(c=Mavo.Elements.defaultConfig[this.datatype||"string"].editor),this.editor=a.create("function"===a.type(c)?c.call(this):c),this.editorValue=this.value}a.bind(this.editor,{"input change":()=>{this.value=this.editorValue},"mv-change":(b)=>{"output"===b.property&&(b.stopPropagation(),a.fire(this.editor,"input"))}});var d=this.editor.matches("textarea");d||this.editor.addEventListener("focus",()=>{this.editor.select&&this.editor.select()}),!this.popup&&this.closestCollection&&this.editor.matches(Mavo.selectors.textInput)&&this.editor.addEventListener("keydown",(a)=>{if(13==a.keyCode&&this.closestCollection.editing&&(a.shiftKey||!d)){var b=this.getCousin(1);if(!b){if(this.bottomUp)return;var c=this.closestCollection.add();this.closestCollection.editItem(c,{immediately:!0})}b=this.getCousin(1),b.edit({immediately:!0}).then(()=>b.editor.focus()),d&&a.preventDefault()}else if(8==a.keyCode&&(this.empty&&this.collection||a[Mavo.superKey])){this.closestCollection.delete(this.closestItem);var e=this.getCousin(1)||this.getCousin(-1);e&&e.edit({immediately:!0}).then(()=>e.editor.focus())}}),"placeholder"in this.editor&&(this.editor.placeholder="("+this.label+")");var e=/^mv-edit-/i;b(this.element.attributes).forEach(function(a){e.test(a.name)&&this.editor.setAttribute(a.name.replace(e,""),a.value)},this),(this.attribute||this.config.popup)&&(this.popup=new Mavo.UI.Popup(this)),this.popup||this.editor.classList.add("mv-editor"),this.initEdit=null},edit:function(b={}){return!1!==this.super.edit.call(this)&&(-1===this.element.tabIndex&&Mavo.revocably.setAttribute(this.element,"tabindex","0"),this.modes||a.bind(this.element,"click.mavo:edit",(a)=>a.preventDefault()),this.preEdit=Mavo.defer((c)=>{if(b.immediately)return c();var d=["click","focus","dragover","dragenter"].map((a)=>a+".mavo:preedit").join(" ");a.bind(this.element,d,c)}).then(()=>a.unbind(this.element,".mavo:preedit")),this.config.edit?void this.config.edit.call(this):this.preEdit.then(()=>{this.sneak(()=>{this.initEdit&&this.initEdit(),this.popup&&(this.popup.prepare(),this.popup.show()),this.attribute||this.popup||(this.editor.parentNode!=this.element&&(this.editorValue=this.value,this.element.textContent="",this.element.appendChild(this.editor)),!this.collection&&(document.activeElement===this.element&&this.editor.focus(),Mavo.revocably.restoreAttribute(this.element,"tabindex")))})}))},done:function(){return!1!==this.super.done.call(this)&&void("preEdit"in this&&a.unbind(this.element,".mavo:preedit .mavo:edit"),this.sneak(()=>{return this.config.done?void this.config.done.call(this):void(this.popup?this.popup.close():!this.attribute&&this.editor&&(a.remove(this.editor),c.setValue(this.element,this.editorValue,{config:this.config,attribute:this.attribute,datatype:this.datatype,map:this.originalEditor||this.editor})))}),!this.collection&&Mavo.revocably.restoreAttribute(this.element,"tabindex"))},dataRender:function(a){if(a&&"object"==typeof a)if(Symbol.toPrimitive in a)a=a[Symbol.toPrimitive]();else for(let b of[this.property,"value","content"])if(b in a){a=a[b],this.inPath.push(b);break}a===void 0?!this.modes&&(this.value=this.closestCollection?this.default:this.templateValue):this.value=a},find:function(a){if(this.property==a)return this},getValue:function(){return c.getValue(this.element,{config:this.config,attribute:this.attribute,datatype:this.datatype})},lazy:{label:function(){return Mavo.Functions.readable(this.property)},emptyValue:function(){switch(this.datatype){case"boolean":return!1;case"number":return 0;}return""},editorDefaults:function(){return this.editor&&c.getConfig(this.editor)}},setValue:function(a,b={}){return this.sneak(()=>{a=a||0===a||!1===a?a:"";var d=this.datatype;return this.datatype||"number"!=typeof a&&"boolean"!=typeof a||(this.datatype=typeof a),a=c.safeCast(a,this.datatype),b.force||a!=this._value||d!=this.datatype?void(this.editor&&document.activeElement!=this.editor&&(this.editorValue=a),(this.popup||!this.editor||this.editor!==document.activeElement)&&(this.config.setValue?this.config.setValue.call(this,this.element,a):!b.dataOnly&&c.setValue(this.element,a,{config:this.config,attribute:this.attribute,datatype:this.datatype,map:this.originalEditor||this.editor})),this.empty=!a&&0!==a,this._value=a,!b.silent&&(this.saved&&(this.unsavedChanges=this.mavo.unsavedChanges=!0),this.dataChanged("propertychange",{value:a}))):a}),a},dataChanged:function(a="propertychange",b){return this.super.dataChanged.call(this,a,b)},live:{default:function(a){this.value==this._default&&(this.value=a)},value:function(a){return this.setValue(a)},datatype:function(b){b!==this._datatype&&("boolean"==b&&!this.attribute&&(this.attribute=Mavo.Elements.defaultConfig.boolean.attribute),a.toggleAttribute(this.element,"datatype",b,b&&"string"!==b))},empty:function(b){var c=b&&!this.modes&&!(this.attribute&&a(Mavo.selectors.property,this.element));this.element.classList.toggle("mv-empty",!!c)}},static:{all:new WeakMap,getValueAttribute:function(a,b=Mavo.Elements.search(a)){var c=a.getAttribute("mv-attribute")||b.attribute;return c&&"null"!==c&&"none"!==c||(c=null),c},safeCast:function(a,b){var d=c.cast(a,b);return null===a||void 0===a?a:"boolean"==b?"false"===a||0===a||""===a?!1:"true"===a||0<a||a:"number"==b?/^[-+]?[0-9.e]+$/i.test(a+"")?d:a:d},cast:function(a,b){return"number"===b?+a:"boolean"===b?!!a:"string"===b?a+"":a},getValue:function(a,{config:b,attribute:d,datatype:e}={}){if(b||(b=c.getConfig(a,d)),d=b.attribute,e=b.datatype,b.getValue&&d==b.attribute)return b.getValue(a);var f;return f=d in a&&c.useProperty(a,d)?a[d]:d?a.getAttribute(d):a.getAttribute("content")||a.textContent||null,c.safeCast(f,e)},getConfig:function(a,b,d){void 0===b&&(b=a.getAttribute("mv-attribute")||void 0),("null"==b||"none"==b)&&(b=null),d||b!=c.getValueAttribute(a)||(d=a.getAttribute("datatype")||void 0);var e=Mavo.Elements.search(a,b,d);return void 0===e.attribute&&(e.attribute=b||null),void 0===e.datatype&&(e.datatype=d),e},setValue:function(b,d,e={}){if(1===b.nodeType&&(e.config||(e.config=c.getConfig(b,e.attribute)),e.attribute=void 0===e.attribute?e.config.attribute:e.attribute,e.datatype=void 0===e.datatype?e.config.datatype:e.datatype,e.config.setValue&&e.attribute==e.config.attribute))return e.config.setValue(b,d,e.attribute);if(e.attribute){if(e.attribute in b&&c.useProperty(b,e.attribute)&&b[e.attribute]!==d){try{var f=b[e.attribute],g=b[e.attribute]=d}catch(a){}f!=g&&e.config.changeEvents&&e.config.changeEvents.split(/\s+/).forEach((c)=>a.fire(b,c))}"boolean"==e.datatype?d!=b.hasAttribute(e.attribute)&&a.toggleAttribute(b,e.attribute,d,d):b.getAttribute(e.attribute)!=d&&b.setAttribute(e.attribute,d)}else{var h=c.format(d,e);h===d?b.textContent=d:(b.textContent=h,b.setAttribute&&b.setAttribute("content",d))}},useProperty:function(a,b){return!(-1<["href","src"].indexOf(b))&&"http://www.w3.org/2000/svg"!=a.namespaceURI},format:(b,d={})=>{if(d.map&&/^select$/i.test(d.map.nodeName))for(var e,f=0;e=d.map.options[f];f++)if(e.value==b)return e.textContent;if("number"===a.type(b)||"number"==d.datatype){var g=d.attribute||d.element&&d.element.matches("style, pre");if(!g)return c.formatNumber(b)}return Array.isArray(b)?b.map(c.format).join(", "):"object"===a.type(b)?Mavo.toJSON(b):b},lazy:{formatNumber:()=>{var a=new Intl.NumberFormat(Mavo.locale,{maximumFractionDigits:2});return function(b){return b===Infinity||b===-Infinity?0>b?"-\u221E":"\u221E":a.format(b)}}}}})})(Bliss,Bliss.$);
(function(a){Mavo.UI.Popup=a.Class({constructor:function(b){this.primitive=b,this.position=()=>{var b=this.primitive.element.getBoundingClientRect(),c=b.left,d=b.bottom,e=!1;if(this.element.offsetHeight&&(this.height=this.element.getBoundingClientRect().height||this.height),this.height+d+20>innerHeight)if(20<b.top-this.height){var e=!0;d=b.top-this.height-20}else d=innerHeight-this.height-20;this.element.classList.toggle("mv-point-down",e),a.style(this.element,{top:`${d}px`,left:`${c}px`})},this.element=a.create("div",{className:"mv-popup",hidden:!0,contents:{tag:"fieldset",contents:[{tag:"legend",textContent:this.primitive.label+":"},this.editor]},events:{keyup:(a)=>{(13==a.keyCode||27==a.keyCode)&&(this.element.contains(document.activeElement)&&this.primitive.element.focus(),a.stopPropagation(),this.hide())},transitionend:this.position}}),this.editor.matches("select")&&(this.editor.size=Math.min(10,this.editor.children.length))},show:function(){a.unbind([this.primitive.element,this.element],".mavo:showpopup"),this.shown=!0,this.hideCallback=(a)=>{this.element.contains(a.target)||this.primitive.element.contains(a.target)||this.hide()},this.element.style.transition="none",this.element.removeAttribute("hidden"),this.position(),this.element.setAttribute("hidden",""),this.element.style.transition="",document.body.appendChild(this.element),setTimeout(()=>{this.element.removeAttribute("hidden")},100),a.bind(document,"focus click",this.hideCallback,!0),window.addEventListener("scroll",this.position,{passive:!0})},hide:function(){a.unbind(document,"focus click",this.hideCallback,!0),window.removeEventListener("scroll",this.position,{passive:!0}),this.element.setAttribute("hidden",""),this.shown=!1,setTimeout(()=>{a.remove(this.element)},1e3*parseFloat(getComputedStyle(this.element).transitionDuration)||400)},prepare:function(){a.bind(this.primitive.element,{"click.mavo:edit":()=>{this.show()},"keyup.mavo:edit":(a)=>{-1<[13,113].indexOf(a.keyCode)&&(this.show(),this.editor.focus())}})},close:function(){this.hide(),a.unbind(this.primitive.element,".mavo:edit .mavo:preedit .mavo:showpopup")},proxy:{editor:"primitive"}})})(Bliss,Bliss.$);
(function(a){var b=Mavo.Elements={};Object.defineProperties(b,{register:{value:function(c,d){if("object"==typeof arguments[0]){for(let a in arguments[0])b.register(a,arguments[0][a]);return}if(d.extend){var e=b[d.extend];d=a.extend(a.extend({},e),d)}if(-1<c.indexOf("@")){var f=c.split("@");d.selector=d.selector||f[0]||"*",void 0===d.attribute&&(d.attribute=f[1])}return d.selector=d.selector||c,d.id=c,Array.isArray(d.attribute)?d.attribute.forEach((e)=>{var f=a.extend({},d);f.attribute=e,b[`${c}@${e}`]=f}):b[c]=d,b}},search:{value:function(c,d,e){var f=b.matches(c,d,e),g=f[f.length-1];if(g)return g;var h=a.extend({},b.defaultConfig[e||"string"]);return h.attribute=void 0===d?h.attribute:d,h}},matches:{value:function(a,c,d){var e=[];selectorloop:for(var f in b){var g=b[f],h=void 0===c&&g.default||c===g.attribute;if(h&&(void 0===d||"string"===d||d===g.datatype)){var i=g.selector||f;a.matches(i)&&(!g.test||g.test(a,c,d))&&e.push(g)}}return e}},isSVG:{value:(a)=>"http://www.w3.org/2000/svg"==a.namespaceURI},defaultConfig:{value:{string:{editor:{tag:"input"}},number:{editor:{tag:"input",type:"number"}},boolean:{attribute:"content",editor:{tag:"input",type:"checkbox"}}}}}),b.register({"@hidden":{datatype:"boolean"},"@y":{test:b.isSVG,datatype:"number"},"@x":{default:!0,test:b.isSVG,datatype:"number"},media:{default:!0,selector:"img, video, audio",attribute:"src",editor:function(){var b=a.create("input",{type:"url",placeholder:"http://example.com/image.png",className:"mv-output","aria-label":"URL to image"});if(this.mavo.uploadBackend&&self.FileReader){var c,d=this.element.nodeName.toLowerCase();d="img"==d?"image":d;var e=this.element.getAttribute("mv-uploads")||d+"s",f=(a,c=a.name)=>{if(a&&0===a.type.indexOf(d+"/")){var f=URL.createObjectURL(a);this.sneak(()=>this.element.src=f),this.mavo.upload(a,e+"/"+c).then((a)=>{var c=0,d=Mavo.rr(()=>Mavo.timeout(1e3+500*c).then(()=>{c++,this.element.src=a})),e=()=>{URL.revokeObjectURL(f),this.element.removeEventListener("load",g),this.element.removeEventListener("error",g)},g=()=>{this.element.src!=f&&(this.element.src=a,e())};b.value=a,this.element.addEventListener("load",g),this.element.addEventListener("error",()=>{10>=c?(this.sneak(()=>this.element.src=f),d()):(this.mavo.error(this.mavo._("cannot-load-uploaded-file")+" "+a),e())})})}},g={paste:(a)=>{var b=a.clipboardData.items[0];if("file"==b.kind&&0===b.type.indexOf(d+"/")){var c=`pasted-${d}-${Date.now()}.${b.type.slice(6)}`;f(b.getAsFile(),c),a.preventDefault()}},"drag dragstart dragend dragover dragenter dragleave drop":(a)=>{a.preventDefault(),a.stopPropagation()},"dragover dragenter":()=>{c.classList.add("mv-dragover"),this.element.classList.add("mv-dragover")},"dragleave dragend drop":()=>{c.classList.remove("mv-dragover"),this.element.classList.remove("mv-dragover")},drop:(a)=>{f(a.dataTransfer.files[0])}};return a.bind(this.element,g),c=a.create({className:"mv-upload-popup",contents:[b,{tag:"input",type:"file","aria-label":"Upload image",accept:d+"/*",events:{change:(a)=>{var b=a.target.files[0];b&&f(b)}}},{className:"mv-tip",innerHTML:"<strong>Tip:</strong> You can also drag & drop or paste!"}],events:g})}return b}},"video, audio":{attribute:["autoplay","buffered","loop"],datatype:"boolean"},details:{attribute:"open",datatype:"boolean"},"a, link":{default:!0,attribute:"href"},"input, select, button, textarea":{attribute:"disabled",datatype:"boolean"},formControl:{selector:"input",default:!0,attribute:"value",modes:"edit",changeEvents:"input change",edit:()=>{},done:()=>{},init:function(){this.editor=this.element}},select:{extend:"formControl",selector:"select",subtree:!0},textarea:{extend:"formControl",selector:"textarea",attribute:null,getValue:(a)=>a.value,setValue:(a,b)=>a.value=b},formNumber:{extend:"formControl",selector:"input[type=range], input[type=number]",datatype:"number",setValue:function(b,c){b.value=c,b.setAttribute("value",c);var d=c>b.value?"max":"min";if(!isNaN(c)&&b.value!=c&&!Mavo.data(b,"boundObserver")){var e=new Mavo.Observer(b,d,()=>{b.value=c});requestAnimationFrame(()=>{a.bind(b,"input mv-change",function c(){e.destroy(),Mavo.data(b,"boundObserver",void 0),a.unbind(b,"input mv-change",c)})}),Mavo.data(b,"boundObserver",e)}}},checkbox:{extend:"formControl",selector:"input[type=checkbox]",attribute:"checked",datatype:"boolean",changeEvents:"click"},radio:{extend:"formControl",selector:"input[type=radio]",attribute:"checked",modes:"edit",getValue:(b)=>{if(b.form)return b.form[b.name].value;var c=a(`input[type=radio][name="${b.name}"]:checked`);return c&&c.value},setValue:(b,c)=>{if(b.form)return void(b.form[b.name].value=c);var d=a(`input[type=radio][name="${b.name}"][value="${c}"]`);a.properties(d,{checked:!0})},init:function(a){this.mavo.element.addEventListener("change",(b)=>{b.target.name==a.name&&(this.value=this.getValue())})}},counter:{extend:"formControl",selector:"button, .counter",attribute:"mv-clicked",datatype:"number",init:function(a){"mv-clicked"===this.attribute&&(a.setAttribute("mv-clicked","0"),a.addEventListener("click",()=>{let b=+a.getAttribute("mv-clicked")||0;this.value=++b}))}},"meter, progress":{default:!0,attribute:"value",datatype:"number",edit:function(){var b=Math.min,c=Math.max,d=+this.element.getAttribute("min")||0,e=+this.element.getAttribute("max")||1,f=e-d,g=+this.element.getAttribute("mv-edit-step")||(1<f?1:f/100);a.bind(this.element,"mousemove.mavo:edit",(a)=>{var h=this.element.getBoundingClientRect().left,i=c(0,(a.clientX-h)/this.element.offsetWidth),j=d+f*i,k=j%g;j+=k>g/2?g-k:-k,j=c(d,b(j,e)),this.sneak(()=>this.element.setAttribute("value",j))}),a.bind(this.element,"mouseleave.mavo:edit",()=>{this.sneak(()=>this.element.setAttribute("value",this.value))}),a.bind(this.element,"click.mavo:edit",()=>{this.value=this.getValue()}),a.bind(this.element,"keydown.mavo:edit",(a)=>{if(a.target==this.element&&(37==a.keyCode||39==a.keyCode)){var f=g*(39==a.keyCode?1:-1)*(a.shiftKey?10:1),h=this.value+f;h=c(d,b(h,e)),this.element.setAttribute("value",h),a.preventDefault()}})},done:function(){a.unbind(this.element,".mavo:edit")}},meta:{default:!0,attribute:"content"},block:{default:!0,selector:"p, div, dt, dd, h1, h2, h3, h4, h5, h6, article, section, address",editor:function(){var b=getComputedStyle(this.element),c=b.display,d=0===c.indexOf("inline")?"input":"textarea",e=a.create(d);if("textarea"==d){var f=this.element.offsetWidth;f&&(e.width=f),e.style.whiteSpace={normal:"pre-wrap",nowrap:"pre"}[b.whiteSpace]||"inherit"}return e},setEditorValue:function(a){this.datatype&&"string"!=this.datatype&&(a+="");var b=getComputedStyle(this.element);return a=a||"",-1<["normal","nowrap"].indexOf(b.whiteSpace)&&(a=a.replace(/\r?\n/g," ")),-1<["normal","nowrap","pre-line"].indexOf(b.whiteSpace)&&(a=a.replace(/^[ \t]+|[ \t]+$/gm,"").replace(/[ \t]+/g," ")),this.editor.value=a,!0}},time:{attribute:"datetime",default:!0,init:function(){if(!this.fromTemplate("dateType")){var a=Mavo.DOMExpression.search(this.element,null),b=this.element.getAttribute("datetime")||"YYYY-MM-DD";for(var c in this.config.dateTypes)if(this.config.dateTypes[c].test(b))break;this.dateType=c,a||(this.element.textContent=this.config.defaultFormats[this.dateType](this.property),this.mavo.expressions.extract(this.element,null))}},dateTypes:{month:/^[Y\d]{4}-[M\d]{2}$/i,time:/^[H\d]{2}:[M\d]{2}/i,"datetime-local":/^[Y\d]{4}-[M\d]{2}-[D\d]{2} [H\d]{2}:[Mi\d]{2}/i,date:/^[Y\d]{4}-[M\d]{2}-[D\d]{2}$/i},defaultFormats:{date:(a)=>`[day(${a})] [month(${a}).shortname] [year(${a})]`,month:(a)=>`[month(${a}).name] [year(${a})]`,time:(a)=>`[hour(${a}).twodigit]:[minute(${a}).twodigit]`,"datetime-local":function(a){return this.date(a)+" "+this.time(a)}},editor:function(){return{tag:"input",type:this.dateType}}},"circle@r":{default:!0,datatype:"number"},circle:{attribute:["cx","cy"],datatype:"number"},text:{default:!0,popup:!0},".mv-toggle":{default:!0,attribute:"aria-checked",datatype:"boolean",edit:function(){Mavo.revocably.setAttribute(this.element,"role","checkbox"),a.bind(this.element,"click.mavo:edit keyup.mavo:edit keydown.mavo:edit",(a)=>{("click"==a.type||" "==a.key||"Enter"==a.key)&&("keydown"!=a.type&&(this.value=!this.value),a.preventDefault(),a.stopPropagation())})},done:function(){Mavo.revocably.restoreAttribute(this.element,"role"),a.unbind(this.element,".mavo:edit")}}})})(Bliss,Bliss.$);
(function(a,b){Mavo.attributes.push("mv-multiple","mv-order","mv-accepts");var d=Mavo.Collection=a.Class({extends:Mavo.Node,nodeType:"Collection",constructor:function(){this.templateElement=this.element,this.children=[],this.fromTemplate("mutable","templateElement","accepts")||(this.mutable=this.templateElement.matches(Mavo.selectors.multiple),this.accepts=(this.templateElement.getAttribute("mv-accepts")||"").split(/\s+/),this.templateElement=this.templateElement.cloneNode(!0));var a=this.createItem(this.element);this.add(a,void 0,{silent:!0}),this.itemTemplate=a.template||a,this.postInit(),Mavo.hooks.run("collection-init-end",this)},get length(){return this.children.length},getData:function(a={}){var b={context:this,options:a,data:[]};if(this.children.forEach((a)=>{if(!a.deleted||b.options.live){var c=a.getData(b.options);(b.options.live||null!==Mavo.value(c))&&b.data.push(c)}}),!this.mutable)if(b.data=b.data.filter((a)=>null!==Mavo.value(a)),b.options.live&&1===b.data.length)b.data=b.data[0];else if(this.data&&!b.options.live){var c=Mavo.subset(this.data,this.inPath);b.data=b.data.concat(c.slice(b.data.length))}return b.options.live&&Array.isArray(b.data)&&(b.data[Mavo.toNode]=this,b.data=this.relativizeData(b.data)),b.options.live||(b.data=Mavo.subset(this.data,this.inPath,b.data)),Mavo.hooks.run("node-getdata-end",b),b.data},createItem:function(a){a||(a=this.templateElement.cloneNode(!0));var b=Mavo.Node.create(a,this.mavo,{collection:this,template:this.itemTemplate||(this.template?this.template.itemTemplate:null),property:this.property,type:this.type});return b},add:function(b,c,d={}){if(b=b instanceof Node?Mavo.Node.get(b)||this.createItem(b):b||this.createItem(),b.collection!=this&&this.adopt(b),this.mutable){var e=this.children[c]?this.children[c].element:this.marker;a[this.bottomUp?"after":"before"](b.element,e),void 0===c&&(c=this.bottomUp?0:this.length)}else c=this.length;var f={context:this,item:b};return f.previousIndex=b.index,f.changed=this.splice({remove:f.item},{index:c,add:f.item}),f.item.itembar&&f.item.itembar.reposition(),this.mavo.expressions.active&&!d.silent&&requestAnimationFrame(()=>{f.changed.forEach((a)=>{a.dataChanged(a==f.item&&void 0===f.previousIndex?"add":"move"),a.unsavedChanges=!0}),this.unsavedChanges=this.mavo.unsavedChanges=!0,this.mavo.expressions.update(f.item)}),Mavo.hooks.run("collection-add-end",f),f.item},splice:function(...a){a.forEach((a)=>{a.index===void 0&&a.remove&&isNaN(a.remove)&&(a.index=this.children.indexOf(a.remove),a.remove=1)}),a.sort((c,a)=>a.index-c.index),a.forEach((a)=>{-1<a.index&&(a.remove||a.add)&&(a.remove=a.remove||0,a.add=Mavo.toArray(a.add),this.children.splice(a.index,+a.remove,...a.add))});var b=[];for(let c,d=0;d<this.length;d++)c=this.children[d],c&&c.index!==d&&(c.index=d,b.push(c));return b},adopt:function(a){a.collection&&(a.collection.splice({remove:a}),a.collection.dataChanged("delete")),this.walk((b)=>{b.closestCollection===a.collection&&(b.closestCollection=this),a.mavo!=this.mavo&&(a.mavo=this.mavo)}),a.collection=this,a.template&&(Mavo.delete(a.template.copies,a),a.template=this.itemTemplate)},delete:function(b,c){return c?(a.remove(b.element),this.splice({remove:b}),void b.destroy()):a.transition(b.element,{opacity:0}).then(()=>{b.deleted=!0,b.element.style.opacity="",b.dataChanged("delete"),this.unsavedChanges=b.unsavedChanges=this.mavo.unsavedChanges=!0})},move:function(a,b){var c=a.index+b+(0<b);c=Mavo.wrap(c,this.children.length+1),this.add(a,c),a instanceof Mavo.Primitive&&a.itembar&&a.itembar.reposition()},editItem:function(a,b={}){var c=b.immediately?Promise.resolve():Mavo.inView.when(a.element);return c.then(()=>{return this.mutable&&(!a.itembar&&(a.itembar=new Mavo.UI.Itembar(a)),a.itembar.add()),a.edit(b)})},edit:function(b={}){if(!1===this.super.edit.call(this))return!1;if(this.mutable){if(!this.addButton.parentNode){var c=this.element.tagName.toLowerCase(),e=Mavo.selectors.container[c],f=e?this.marker.parentNode.closest(e):this.marker;a[this.bottomUp?"before":"after"](this.addButton,f)}d.dragula.then(()=>{this.getDragula()})}return Promise.all(this.children.map((a)=>this.editItem(a,b)))},done:function(){return!1!==this.super.done.call(this)&&void(this.mutable&&(this.addButton.parentNode&&this.addButton.remove(),this.propagate((a)=>{a.itembar&&a.itembar.remove()})))},dataChanged:function(a,b={}){return b.element=b.element||this.marker,this.super.dataChanged.call(this,a,b)},save:function(){this.children.forEach((a)=>{a.deleted?this.delete(a,!0):a.unsavedChanges=!1})},propagated:["save"],dataRender:function(b){if(void 0!==b)if(b=null===b?[]:Mavo.toArray(b).filter((a)=>null!==a),!this.mutable)this.children.forEach((a,c)=>a.render(b&&b[c]));else{for(var c,d=0;d<this.children.length;d++)c=this.children[d],d<b.length?c.render(b[d]):(c.dataChanged("delete"),this.delete(c,!0),d--);if(b.length>d){for(var c,e=document.createDocumentFragment(),f=d;f<b.length;f++){c=this.createItem(),c.render(b[f]),this.children.push(c),c.index=f,e.appendChild(c.element);var g={context:this,item:c};Mavo.hooks.run("collection-add-end",g)}this.bottomUp?a.after(e,0<d?this.children[d-1].element:this.marker):a.before(e,this.marker);for(var f=d;f<this.children.length;f++)this.children[f].dataChanged("add"),this.mavo.expressions.active&&requestAnimationFrame(()=>this.mavo.expressions.update(this.children[f]))}}},find:function(a,b={}){var c=this.children.filter((a)=>!a.deleted);if(this.property==a)return b.collections?this:c;if(this.properties.has(a)){var d=c.map((c)=>c.find(a,b));return Mavo.flatten(d)}},isCompatible:function(a){return a&&this.itemTemplate.nodeType==a.itemTemplate.nodeType&&(a===this||a.template==this||this.template==a||this.template&&this.template==a.template||-1<this.accepts.indexOf(a.property))},live:{mutable:function(b){if(b&&b!==this.mutable){this._mutable=b,this.marker=document.createComment("mv-marker"),Mavo.data(this.marker,"collection",this);var c=this.templateElement.parentNode?this.templateElement:this.children[this.length-1].element;a.after(this.marker,c)}}},getDragula:function(){if(this.dragula)return this.dragula;if(this.template)return Mavo.pushUnique(this.template.getDragula().containers,this.marker.parentNode),this.dragula=this.template.dragula||this.template.getDragula();this;return this.dragula=dragula({containers:[this.marker.parentNode],isContainer:(a)=>{return!!this.accepts.length&&-1<Mavo.flatten(this.accepts.map((a)=>this.mavo.root.find(a,{collections:!0}))).filter((a)=>a&&a instanceof d).map((a)=>a.marker.parentNode).indexOf(a)},moves:(a,b,c)=>{return c.classList.contains("mv-drag-handle")&&c.closest(Mavo.selectors.multiple)==a},accepts:function(a,b,c,e){if(a.contains(b))return!1;var f=e?e.previousElementSibling:b.lastElementChild,g=d.get(f)||d.get(e);if(!g)return!1;var h=Mavo.Node.get(a);return h&&h.collection.isCompatible(g)}}),this.dragula.on("drop",(a)=>{var b=Mavo.Node.get(a),c=b&&b.index,e=a.nextElementSibling,f=a.previousElementSibling,g=d.get(f)||d.get(e),h=Mavo.Node.get(f)||Mavo.Node.get(e);if(h&&h.collection!=g&&(h=null),b.collection.isCompatible(g)){var i=h?h.index+(h.element===f):g.length;g.add(b,i)}else return this.dragula.cancel(!0)}),d.dragulas.push(this.dragula),this.dragula},lazy:{bottomUp:function(){if(!this.mutable)return!1;var a=this.templateElement.getAttribute("mv-order");return null===a?!!this.addButton.parentNode&&!!(this.addButton.compareDocumentPosition(this.marker)&Node.DOCUMENT_POSITION_FOLLOWING):/^desc\b/i.test(a)},closestCollection:function(){var a=this.marker?this.marker.parentNode:this.templateElement.parentNode;return a.closest(Mavo.selectors.multiple)},addButton:function(){var c=`button.mv-add-${this.property}`,d=this.closestCollection||this.marker.parentNode.closest(Mavo.selectors.group);if(d)var e=b(c,d).filter((a)=>{return!this.templateElement.contains(a)})[0];return e||(e=a.create("button",{className:"mv-add",textContent:this.mavo._("add-item",this)})),e.classList.add("mv-ui","mv-add"),Mavo.data(e,"collection",this),this.property&&e.classList.add(`mv-add-${this.property}`),e.addEventListener("click",(a)=>{a.preventDefault(),this.editItem(this.add())}),e}},static:{dragulas:[],get:(a)=>{var b=Mavo.data(a,"collection");if(b)return b;var c=Mavo.Node.get(a);return c&&c.collection||null},lazy:{dragula:()=>a.include(self.dragula,"https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.min.js")}}})})(Bliss,Bliss.$);
(function(a,b){var c=Mavo.UI.Itembar=a.Class({constructor:function(c){if(this.item=c,this.element=b(`.mv-item-bar:not([mv-rel]), .mv-item-bar[mv-rel="${this.item.property}"]`,this.item.element).filter((a)=>{return a.closest(Mavo.selectors.multiple)==this.item.element&&!Mavo.data(a,"item")})[0],!this.element&&this.item.template&&this.item.template.itembar)this.element=this.item.template.itembar.element.cloneNode(!0),this.dragHandle=a(".mv-drag-handle",this.element)||this.item.element;else{this.element=this.element||a.create({className:"mv-item-bar mv-ui"});var d=[{tag:"button",title:this.mavo._("delete-item",this.item),className:"mv-delete"},{tag:"button",title:this.mavo._(`add-item-${this.collection.bottomUp?"after":"before"}`,this.item),className:"mv-add"}];this.item instanceof Mavo.Group?(this.dragHandle=a.create({tag:"button",title:this.mavo._("drag-to-reorder",this.item),className:"mv-drag-handle"}),d.push(this.dragHandle)):this.dragHandle=this.item.element,a.set(this.element,{"mv-rel":this.item.property,contents:d})}this.element.setAttribute("hidden",""),a.bind([this.item.element,this.element],"focusin mouseover",this),a.bind(this.element,{mouseenter:()=>{this.item.element.classList.add("mv-highlight")},mouseleave:()=>{this.item.element.classList.remove("mv-highlight")}}),this.dragHandle.addEventListener("keydown",(a)=>{a.target===this.dragHandle&&this.item.editing&&37<=a.keyCode&&40>=a.keyCode&&(this.collection.move(this.item,38>=a.keyCode?-1:1),a.stopPropagation(),a.preventDefault(),a.target.focus())});var e={add:this.buttonSelector("add"),delete:this.buttonSelector("delete"),drag:this.buttonSelector("drag")};this.element.addEventListener("click",(a)=>{if(this.item.collection.editing){if(a.target.matches(e.add)){var b=this.collection.add(null,this.item.index);return a[Mavo.superKey]&&b.render(this.item.getData()),Mavo.scrollIntoViewIfNeeded(b.element),this.collection.editItem(b)}a.target.matches(e.delete)?this.item.collection.delete(c):a.target.matches(e["drag-handle"])&&((a)=>a.target.focus())}}),Mavo.data(this.element,"item",this.item)},destroy:function(){this.hide()},show:function(b){c.visible.forEach((a)=>{a!=this&&(!this.sticky||a.sticky)&&(clearTimeout(a.hideTimeout),a.hide(b,c.DELAY))}),c.visible.add(this),(this.element.hasAttribute("hidden")||b&&!this.sticky)&&(this.element.removeAttribute("hidden"),this.sticky=this.sticky||b,a.bind([this.item.element,this.element],"focusout mouseleave",this),this.adjacent&&a.style(this.element,{"--mv-item-width":this.item.element.offsetWidth+"px","--mv-item-height":this.item.element.offsetHeight+"px","--mv-item-left":this.item.element.offsetLeft+"px","--mv-item-top":this.item.element.offsetTop+"px"}))},hide:function(b,d=0){(!this.sticky||b)&&(d?this.hideTimeout=setTimeout(()=>this.hide(b),d):(this.element.setAttribute("hidden",""),a.unbind([this.item.element,this.element],"focusout mouseleave",this),this.sticky=!1,c.visible.delete(this)))},handleEvent:function(a){var b=-1===a.type.indexOf("mouse");this.isWithinItem(a.target)&&(clearTimeout(this.hideTimeout),-1<["mouseleave","focusout","blur"].indexOf(a.type)?!this.isWithinItem(a.relatedTarget)&&this.hide(b,c.DELAY):(this.show(b),a.stopPropagation()))},isWithinItem:function(a){if(!a)return!1;var b=a.closest(".mv-item-bar");return b?b===this.element:a.closest(Mavo.selectors.item)===this.item.element},add:function(){this.element.parentNode||Mavo.revocably.add(this.element)||(this.item instanceof Mavo.Primitive&&!this.item.attribute?(this.adjacent=!0,a.after(this.element,this.item.element)):this.item.element.appendChild(this.element)),this.dragHandle==this.item.element&&this.item.element.classList.add("mv-drag-handle")},remove:function(){Mavo.revocably.remove(this.element),this.dragHandle==this.item.element&&this.item.element.classList.remove("mv-drag-handle")},reposition:function(){this.item instanceof Mavo.Primitive&&(this.element.remove(),this.add())},buttonSelector:function(a){return`.mv-${a}[mv-rel="${this.item.property}"], [mv-rel="${this.item.property}"] > .mv-${a}`},live:{sticky:function(a){this.element.classList.toggle("mv-sticky",a)},adjacent:function(a){this.element.classList.toggle("mv-adjacent",a)}},proxy:{collection:"item",mavo:"item"},static:{DELAY:100,visible:new Set}})})(Bliss,Bliss.$);
(function(a){Mavo.attributes.push("mv-expressions");var b=Mavo.Expression=a.Class({constructor:function(a){this.expression=a},eval:function(a){Mavo.hooks.run("expression-eval-beforeeval",this);try{return this.function||(this.function=Mavo.Script.compile(this.expression)),this.function(a)}catch(a){return console.info("%cExpression error!","color: red; font-weight: bold",`${a.message} in expression ${this.expression}`,`
Not an expression? Use mv-expressions="none" to disable expressions on an element and its descendants.`),Mavo.hooks.run("expression-eval-error",{context:this,exception:a}),a}},toString(){return this.expression},changedBy:function(a){return b.changedBy(this.identifiers,a)},live:{expression:function(a){this.function=null,this.identifiers=a.match(/[$a-z][$\w]*/ig)||[]}},static:{changedBy:function(a,b){if(!b)return!0;if(!a)return!1;if(-1<a.indexOf(b.property))return!0;if(Mavo.Functions.intersects(b.properties,a))return!0;if("propertychange"==b.action)return Mavo.Functions.intersects(a,b.node.path);if(Mavo.Functions.intersects(["$index","$previous","$next"],a))return!0;var c=b.node.collection||b.node;return!!Mavo.Functions.intersects(c.properties,a)}}});b.Syntax=a.Class({constructor:function(a,b){this.start=a,this.end=b,this.regex=RegExp(`${Mavo.escapeRegExp(a)}([\\S\\s]+?)${Mavo.escapeRegExp(b)}`,"gi")},test:function(a){return this.regex.lastIndex=0,this.regex.test(a)},tokenize:function(a){var b,c=[],d=0;for(this.regex.lastIndex=0;null!==(b=this.regex.exec(a));)b.index>d&&c.push(a.substring(d,b.index)),d=this.regex.lastIndex,c.push(new Mavo.Expression(b[1]));return d<a.length&&c.push(a.substring(d)),c},static:{create:function(a){if(a){var c=a.getAttribute("mv-expressions");if(c)return c=c.trim(),/\s/.test(c)?new b.Syntax(...c.split(/\s+/)):b.Syntax.ESCAPE}},ESCAPE:-1}}),b.Syntax.default=new b.Syntax("[","]")})(Bliss,Bliss.$);
(function(a){var b=Mavo.DOMExpression=a.Class({constructor:function(c={}){this.mavo=c.mavo,this.template=c.template&&c.template.template||c.template;for(let a of["item","path","syntax","fallback","attribute","originalAttribute","expression","parsed"])this[a]=void 0===c[a]&&this.template?this.template[a]:c[a];if(this.node=c.node,this.node||(this.node=Mavo.elementPath(this.item.element,this.path)),this.element=this.node,this.attribute=this.attribute||null,Mavo.hooks.run("domexpression-init-start",this),"mv-value"==this.attribute){this.originalAttribute="mv-value",this.attribute=Mavo.Primitive.getValueAttribute(this.element),this.fallback=this.fallback||Mavo.Primitive.getValue(this.element,{attribute:this.attribute});var d=this.element.getAttribute("mv-value");this.element.removeAttribute("mv-value"),this.parsed=[new Mavo.Expression(d)],this.expression=this.syntax.start+d+this.syntax.end}if(3===this.node.nodeType&&this.element===this.node&&(this.element=this.node.parentNode,(!this.node.parentNode.children.length||this.attribute)&&(this.node=this.element,this.element.normalize())),!this.expression){if(this.attribute){var e=Element.prototype.getAttribute.call(this.node,this.attribute);this.expression=(e||"").trim()}else{if(this.node.normalize(),this.node.firstChild&&1===this.node.childNodes.length&&3===this.node.firstChild.nodeType){var f=this.node.firstChild.textContent.match(/^\s*|\s*$/g);f[1]&&(this.node.firstChild.splitText(this.node.firstChild.textContent.length-f[1].length),a.after(this.node.lastChild,this.node)),f[0]&&(this.node.firstChild.splitText(f[0].length),this.node.parentNode.insertBefore(this.node.firstChild,this.node))}this.expression=this.node.textContent}this.parsed=c.template?c.template.parsed:this.syntax.tokenize(this.expression)}this.oldValue=this.value=this.parsed.map((a)=>a instanceof Mavo.Expression?a.expression:a),this.item=Mavo.Node.get(this.element.closest(Mavo.selectors.item)),this.mavo.treeBuilt.then(()=>{this.template||this.item||(this.item=Mavo.Node.get(this.element.closest(Mavo.selectors.item))),"mv-value"==this.originalAttribute&&this.mavoNode&&this.mavoNode==this.item.collection&&Mavo.delete(this.item.expressions,this),Mavo.hooks.run("domexpression-init-treebuilt",this)}),Mavo.hooks.run("domexpression-init-end",this),b.elements.set(this.element,[...(b.elements.get(this.element)||[]),this])},destroy:function(){b.special.delete(this)},changedBy:function(a){return"mv-value"==this.originalAttribute&&this.mavoNode&&!(this.mavoNode instanceof Mavo.Primitive)?!a||!this.mavoNode.contains(a.node):(this.identifiers||(this.identifiers=Mavo.flatten(this.parsed.map((a)=>a.identifiers||[])),b.special.add(this)),Mavo.Expression.changedBy(this.identifiers,a))},update:function(a=this.data,b){var c={context:this,event:b},d=c;this.data=a,Mavo.hooks.run("domexpression-update-start",c),this.oldValue=this.value;var e=!1;c.value=this.value=this.parsed.map((b,c)=>{if(b instanceof Mavo.Expression){if(b.changedBy(d.event)){var f={context:this,expr:b,parentEnv:d};return Mavo.hooks.run("domexpression-update-beforeeval",f),f.value=Mavo.value(f.expr.eval(a)),Mavo.hooks.run("domexpression-update-aftereval",f),e=!0,f.value instanceof Error?void 0===this.fallback?this.syntax.start+f.expr.expression+this.syntax.end:this.fallback:void 0===f.value||null===f.value?"":f.value}return this.oldValue[c]}return b});e&&(c.value=1===c.value.length?c.value[0]:c.value.map((a)=>Mavo.Primitive.format(a,{attribute:this.attribute,element:this.element})).join(""),this.output(c.value),Mavo.hooks.run("domexpression-update-end",c))},output:function(a){this.primitive?this.primitive.value=a:this.mavoNode?this.mavoNode.render(a):Mavo.Primitive.setValue(this.node,a,{attribute:this.attribute})},live:{item:function(a){a&&this._item!=a&&(this._item&&Mavo.delete(this._item.expressions,this),a.expressions=a.expressions||[],a.expressions.push(this))}},static:{elements:new WeakMap,search:function(a,c){if(null===a)return a;var d=b.elements.get(a)||[];return 1<arguments.length?d.length?d.filter((a)=>a.attribute===c)[0]||null:null:d},special:{add:function(a,b){if(b){var c=this.vars[b];c&&-1<a.identifiers.indexOf(b)&&(c.all=c.all||new Set,c.all.add(a),1===c.all.size?c.observe():!c.all.size&&c.unobserve())}else for(var b in this.vars)this.add(a,b)},delete:function(a,b){if(b){var c=this.vars[b];c.all=c.all||new Set,c.all.delete(a),c.all.size||c.unobserve()}else for(var b in this.vars)this.delete(a,b)},update:function(){this.update&&this.update(...arguments),this.all.forEach((a)=>a.update())},event:function(a,{type:c,update:d,target:e=document}={}){this.vars[a]={observe:function(){this.callback=this.callback||b.special.update.bind(this),e.addEventListener(c,this.callback)},unobserve:function(){e.removeEventListener(c,this.callback)}},d&&(this.vars[a].update=function(b){Mavo.Functions[a]=d(b)})},vars:{$now:{observe:function(){var a=()=>{b.special.update.call(this),this.timer=requestAnimationFrame(a)};this.timer=requestAnimationFrame(a)},unobserve:function(){cancelAnimationFrame(this.timer)}}}}}});b.special.event("$mouse",{type:"mousemove",update:function(a){return{x:a.clientX,y:a.clientY}}}),b.special.event("$hash",{type:"hashchange",target:window})})(Bliss,Bliss.$);
(function(a,b){var c=Mavo.Expressions=a.Class({constructor:function(a){this.mavo=a,this.active=!0,this.expressions=[];var b=Mavo.Expression.Syntax.create(this.mavo.element.closest("[mv-expressions]"))||Mavo.Expression.Syntax.default;this.traverse(this.mavo.element,void 0,b),this.scheduled={},this.mavo.treeBuilt.then(()=>{this.expressions=[],document.documentElement.addEventListener("mv-change",(a)=>{if(this.active){var b=this.scheduled[a.action]=this.scheduled[a.action]||new Set;a.node.template?!b.has(a.node.template)&&(setTimeout(()=>{b.delete(a.node.template),this.update(a)},c.THROTTLE),b.add(a.node.template)):requestAnimationFrame(()=>this.update(a))}}),this.update()})},update:function(b){if(this.active){var c,d;b instanceof Mavo.Node?(d=b,b=null):b instanceof Element?(c=b.closest(Mavo.selectors.item),d=Mavo.Node.get(c),b=null):d=this.mavo.root;var e=d.getData({live:!0});d.walk((c,d)=>{if(c.expressions&&c.expressions.length&&!c.isDeleted()){var f=a.value(e,...d);c.expressions.forEach((a)=>{a.changedBy(b)&&a.update(f,b)})}})}},extract:function(a,b,d,e=Mavo.Expression.Syntax.default){b&&"mv-expressions"==b.name||(b&&-1<c.directives.indexOf(b.name)||e!==Mavo.Expression.Syntax.ESCAPE&&e.test(b?b.value:a.textContent))&&(d===void 0&&(d=Mavo.elementPath(a.closest(Mavo.selectors.item),a)),this.expressions.push(new Mavo.DOMExpression({node:a,syntax:e,path:d,attribute:b&&b.name,mavo:this.mavo})))},traverse:function(a,c=[],d){if(8!==a.nodeType)if(3===a.nodeType)this.extract(a,null,c,d);else{a.normalize(),d=Mavo.Expression.Syntax.create(a)||d,Mavo.is("item",a)&&(c=[]),b(a.attributes).forEach((b)=>this.extract(a,b,c,d));var e=-1,f=0;a.matches("script:not([mv-expressions])")||b(a.childNodes).forEach((a)=>{if(1==a.nodeType?(f=0,e++):f++,1==a.nodeType||3==a.nodeType){var b=0<f?`${e}.${f}`:e;this.traverse(a,[...(c||[]),b],d)}})}},static:{directives:["mv-value"],THROTTLE:50,directive:function(a,b){c.directives.push(a),Mavo.attributes.push(a),Mavo.Plugins.register(a,b)}}})})(Bliss,Bliss.$);
(function(a,b){Mavo.Expressions.directive("mv-if",{extend:{Primitive:{live:{hidden:function(a){this._hidden!==a&&(this._hidden=a,this.dataChanged())}}},DOMExpression:{lazy:{childProperties:function(){var a=b(Mavo.selectors.property,this.element).filter((a)=>a.closest("[mv-if]")==this.element).map((a)=>Mavo.Node.get(a));return this.element.addEventListener("mv-change",(a)=>{requestAnimationFrame(()=>{this.element.parentNode||this.item.element.dispatchEvent(a)})}),a}}}},hooks:{"domexpression-init-start":function(){"mv-if"!=this.attribute||(this.expression=this.element.getAttribute("mv-if"),this.parsed=[new Mavo.Expression(this.expression)],this.expression=this.syntax.start+this.expression+this.syntax.end,this.parentIf=this.element.parentNode&&Mavo.DOMExpression.search(this.element.parentNode.closest("[mv-if]"),"mv-if"),this.parentIf&&(this.parentIf.childIfs=(this.parentIf.childIfs||new Set).add(this)))},"domexpression-update-end":function(){if("mv-if"==this.attribute){var a=this.value[0],b=this.oldValue[0];this.item.mavo.treeBuilt.then(()=>{if(this.parentIf){var c=this.parentIf.value[0];this.value[0]=a=a&&c}!1!==c&&(a?Mavo.revocably.add(this.element):this.element.parentNode&&Mavo.revocably.remove(this.element,"mv-if")),a!==b&&(this.childProperties&&this.childProperties.forEach((b)=>b.hidden=!a),this.childIfs&&this.childIfs.forEach((a)=>a.update()))})}},"unit-isdatanull":function(a){a.result=a.result||this.hidden&&a.options.live}}})})(Bliss,Bliss.$);
(function(a,b){function c(a=""){return a=b(a),a||0===a?a+"":""}function d(a){return a=Mavo.value(a),null===a||!1===a||""===a}function e(a){return!b(a)}function f(a,b){var c=a.toLocaleString(Mavo.locale,b);return c=c.replace(/\u200e/g,""),c}function g(a){return function(b){if(b=l.date(b),!b)return"";var c=m[a](b);return c=new self["year"==a?"String":"Number"](c),("month"==a||"weekday"==a)&&(c.name=f(b,{[a]:"long"}),c.shortname=f(b,{[a]:"short"})),"weekday"!=a&&(c.twodigit=(10>c%100?"0":"")+c%100),c}}var h=Math.floor,i=Math.abs,j=Math.min,k=Mavo.Functions={operators:{"=":"eq"},get:function(a,c,d={}){c=d.property=b(c);var e=Mavo.getCanonicalProperty(a,c);if(void 0!==e){d.property=e;var f=a[e];return"function"==typeof f&&0!==f.name.indexOf("bound")?f.bind(a):f}if(Array.isArray(a)&&c&&isNaN(c)){var g=c.indexOf("=");return-1<g?(d.query={property:c.slice(0,g),value:c.slice(g+1)},d.property=[],f=a.filter((a,b)=>{var c=k.get(a,d.query.property)==d.query.value;return c&&d.property.push(b),c}),"id"==d.query.property&&(d.property=d.property[0],f=f[0]),void 0===f?d.property=a.length:0===f.length&&(d.property=[a.length]),f):a.map((a)=>k.get(a,c))}return null},url:(a,b=location)=>{if(void 0===a)return location.href;if(a){a=c(a).replace(/[^\w-:]/g);var d=b.search.match(RegExp(`[?&]${a}(?:=(.+?))?(?=$|&)`))||b.pathname.match(RegExp(`(?:^|\\/)${a}\\/([^\\/]*)`))}return null!==d&&a?decodeURIComponent(d[1])||"":null},first:(a)=>a&&a[0]||"",last:(a)=>a&&a[a.length-1]||"",unique:function(a){return Array.isArray(a)?[...new Set(a.map(b))]:a},intersects:function(a,c){if(a&&c){var d=new Set(c.map?c.map(b):c);return a=a.map?a.map(b):[...a],!a.every((a)=>!d.has(a))}},sum:function(a){return l.numbers(a,arguments).reduce((a,b)=>{return+a+(+b||0)},0)},average:function(a){return a=l.numbers(a,arguments),a.length&&k.sum(a)/a.length},min:function(a){return j(...l.numbers(a,arguments))},max:function(a){return Math.max(...l.numbers(a,arguments))},count:function(a){return Mavo.toArray(a).filter((b)=>!d(b)).length},reverse:function(a){return Mavo.toArray(a).slice().reverse()},round:function(a,b){return e(a)||e(b)||!isFinite(a)?Math.round(a):+a.toLocaleString("en-US",{useGrouping:!1,maximumFractionDigits:b})},th:function(a){if(d(a))return"";if(10>b||20<b)var b=["th","st","nd","th"][a%10];return b=b||"th",a+b},iff:function(a,d=a,e=""){return Array.isArray(a)?a.map((a,c)=>{var f=b(a)?d:e;return Array.isArray(f)?f[j(c,f.length-1)]:f}):b(a)?d:e},replace:function(a,b,c="",d=1){if(Array.isArray(a))return a.map((a)=>k.replace(a,b,c));for(var e,f=RegExp(Mavo.escapeRegExp(b),"g"),g=a,h=0;g!=e&&h++<d;)e=g,g=g.replace(f,c);return g},len:(a)=>c(a).length,search:(a,b)=>a&&b?c(a).toLowerCase().indexOf((b+"").toLowerCase()):-1,starts:(a,b)=>0===k.search(c(a),c(b)),ends:function(a,b){[a,b]=[c(a),c(b)];var d=k.search(a,b);return-1<d&&d===a.length-b.length},join:function(a,b){return Mavo.toArray(a).join(c(b))},idify:function(a){return c(a).trim().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\w\s-]/g,"").replace(/\s+/g,"-").toLowerCase()},readable:function(a){return c(a).replace(/([a-z])([A-Z])(?=[a-z])/g,(a,b,c)=>b+" "+c.toLowerCase()).replace(/([a-z0-9])[_\/-](?=[a-z0-9])/g,"$1 ").replace(/^[a-z]/,(a)=>a.toUpperCase())},uppercase:(a)=>c(a).toUpperCase(),lowercase:(a)=>c(a).toLowerCase(),from:(a,b)=>k.between(a,b),fromlast:(a,b)=>k.between(a,b,"",!0),to:(a,b)=>k.between(a,"",b),tofirst:(a,b)=>k.between(a,"",b,!0),between:(a,b,d,e)=>{[a,b,d]=[c(a),c(b),c(d)];var f=b?a[e?"lastIndexOf":"indexOf"](b):-1,g=a[e?"indexOf":"lastIndexOf"](d);return a.slice(f+1,-1!==g&&d?g:a.length)},filename:(a)=>Mavo.match(new URL(c(a),Mavo.base).pathname,/[^/]+?$/),json:(a)=>Mavo.safeToJSON(a),get $now(){return new Date},$startup:new Date,get $today(){return k.date(new Date)},year:g("year"),month:g("month"),day:g("day"),weekday:g("weekday"),hour:g("hour"),minute:g("minute"),second:g("second"),ms:g("ms"),date:(a)=>{return a=l.date(a),a?`${k.year(a)}-${k.month(a).twodigit}-${k.day(a).twodigit}`:""},time:(a)=>{return a=l.date(a),a?`${k.hour(a).twodigit}:${k.minute(a).twodigit}:${k.second(a).twodigit}`:""},minutes:(a)=>h(i(a)/60)||0,hours:(a)=>h(i(a)/3600)||0,days:(a)=>h(i(a)/86400)||0,weeks:(a)=>h(i(a)/604800)||0,months:(a)=>h(i(a)/(30.4368*86400))||0,years:(a)=>h(i(a)/(12*(30.4368*86400)))||0,localTimezone:-new Date().getTimezoneOffset(),log:(...a)=>{return console.log(...a.map(b)),a[0]},$mouse:{x:0,y:0},get $hash(){return location.hash.slice(1)},util:{numbers:function(a,c){return a=Array.isArray(a)?a:c?$$(c):[a],a.filter((a)=>!isNaN(a)&&""!==b(a)).map((a)=>+a)},fixDateString:function(a){a=a.trim();var b=/^\d{4}-\d{2}(-\d{2})?/.test(a),c=-1<a.indexOf(":");return b||c?(a=b?a.replace(/^(\d{4}-\d{2})(?!-\d{2})/,"$1-01"):k.$today+" "+a,c?a=a.replace(/\-(\d{2})\s+(?=\d{2}:)/,"-$1T"):a+="T00:00:00",a=a.replace(/\s+/g,""),a):null},date:function(c){if(c=b(c),!c)return null;if("string"===a.type(c)){if(c=l.fixDateString(c),null===c)return null;var d=Mavo.match(c,/[+-]\d{2}:?\d{2}|Z$/);if(d)c=new Date(c);else{var e=c.match(/\d+/g);c=new Date(e[0],(e[1]||1)-1,e[2]||1,e[3]||0,e[4]||0,e[5]||0,e[6]||0)}}else c=new Date(c);return isNaN(c)?null:c}}},l=k.util;k._Trap=self.Proxy?new Proxy(k,{get:(a,b)=>{var c,d=Mavo.getCanonicalProperty(a,b)||Mavo.getCanonicalProperty(Math,b);return d&&(c=a[d],void 0===c&&(c=Math[d])),void 0===c?b in self?self[b]:b:("function"==typeof c&&(c.toString=()=>b),c)},has:(a,b)=>"data"!=b}):k;var m={year:(a)=>a.getFullYear(),month:(a)=>a.getMonth()+1,day:(a)=>a.getDate(),weekday:(a)=>a.getDay()||7,hour:(a)=>a.getHours(),minute:(a)=>a.getMinutes(),second:(a)=>a.getSeconds(),ms:(a)=>a.getMilliseconds()}})(Bliss,Mavo.value);
(function(a,c,d){var b=Mavo.Script={addUnaryOperator:function(a,b){return b.symbol&&Mavo.toArray(b.symbol).forEach((b)=>{Mavo.Script.unarySymbols[b]=a,jsep.addUnaryOp(b)}),Mavo.Functions[a]=(a)=>Array.isArray(a)?a.map(c).map(b.scalar):b.scalar(c(a))},addBinaryOperator:function(a,e){return e.symbol&&Mavo.toArray(e.symbol).forEach((b)=>{Mavo.Script.symbols[b]=a,e.precedence&&jsep.addBinaryOp(b,e.precedence)}),e.identity=void 0===e.identity?0:e.identity,Mavo.Functions[a]=e.code||function(...f){1===f.length&&Array.isArray(f[0])&&(f=[...f[0]]),e.raw||(f=f.map(c));var g,h=e.logical?e.identity:f[0];for(let c=1;c<f.length;c++){let j=e.logical?f[c-1]:h,a=f[c];Array.isArray(a)?("number"==typeof e.identity&&(a=d.numbers(a)),g=Array.isArray(j)?[...a.map((a,b)=>e.scalar(void 0===j[b]?e.identity:j[b],a)),...j.slice(a.length)]:a.map((a)=>e.scalar(j,a))):Array.isArray(j)?g=j.map((b)=>e.scalar(b,a)):g=e.scalar(j,a),h=e.reduce?e.reduce(h,g,j,a):e.logical?h&&g:g}return h}},symbols:{},unarySymbols:{},getOperatorName:(a,b)=>Mavo.Script[b?"unarySymbols":"symbols"][a]||a,operators:{not:{symbol:"!",scalar:(b)=>!b},multiply:{scalar:(c,a)=>c*a,identity:1,symbol:"*"},divide:{scalar:(c,a)=>c/a,identity:1,symbol:"/"},add:{scalar:(c,d)=>+c+ +d,symbol:"+"},plus:{scalar:(b)=>+b,symbol:"+"},subtract:{scalar:(c,a)=>{if(isNaN(c)||isNaN(a)){var b=d.date(c),e=d.date(a);if(b&&e)return(b-e)/1e3}return c-a},symbol:"-"},minus:{scalar:(b)=>-b,symbol:"-"},mod:{scalar:(c,a)=>{var b=c%a;return b+=0>b?a:0,b},symbol:"mod",precedence:6},lte:{logical:!0,scalar:(c,a)=>{return[c,a]=Mavo.Script.getNumericalOperands(c,a),c<=a},identity:!0,symbol:"<="},lt:{logical:!0,scalar:(c,a)=>{return[c,a]=Mavo.Script.getNumericalOperands(c,a),c<a},identity:!0,symbol:"<"},gte:{logical:!0,scalar:(c,a)=>{return[c,a]=Mavo.Script.getNumericalOperands(c,a),c>=a},identity:!0,symbol:">="},gt:{logical:!0,scalar:(c,a)=>{return[c,a]=Mavo.Script.getNumericalOperands(c,a),c>a},identity:!0,symbol:">"},eq:{logical:!0,scalar:(c,a)=>c==a,symbol:["=","=="],identity:!0,precedence:6},neq:{logical:!0,scalar:(c,a)=>c!=a,symbol:["!="],identity:!0},and:{logical:!0,scalar:(c,d)=>!!c&&!!d,identity:!0,symbol:["&&","and"],precedence:2},or:{logical:!0,scalar:(c,a)=>c||a,reduce:(a,b)=>a||b,identity:!1,symbol:["||","or"],precedence:2},concatenate:{symbol:"&",identity:"",scalar:(c,a)=>""+(c||"")+(a||""),precedence:10},filter:{scalar:(d,a)=>c(a)?d:null,raw:!0}},getNumericalOperands:function(c,a){if(isNaN(c)||isNaN(a)){var b=d.date(c),e=d.date(a);if(b&&e)return[b,e]}return[c,a]},serializers:{BinaryExpression:(a)=>`${b.serialize(a.left)} ${a.operator} ${b.serialize(a.right)}`,UnaryExpression:(a)=>`${a.operator}${b.serialize(a.argument)}`,CallExpression:(a)=>`${b.serialize(a.callee)}(${a.arguments.map(b.serialize).join(", ")})`,ConditionalExpression:(a)=>`${b.serialize(a.test)}? ${b.serialize(a.consequent)} : ${b.serialize(a.alternate)}`,MemberExpression:(a)=>{var c=a.computed?b.serialize(a.property):`"${a.property.name}"`;return`get(${b.serialize(a.object)}, ${c})`},ArrayExpression:(a)=>`[${a.elements.map(b.serialize).join(", ")}]`,Literal:(a)=>a.raw,Identifier:(a)=>a.name,ThisExpression:()=>"this",Compound:(a)=>a.body.map(b.serialize).join(" ")},transformations:{BinaryExpression:(a)=>{let c=Mavo.Script.getOperatorName(a.operator);var d=a,e=[];do e.unshift(d.right),d=d.left;while(Mavo.Script.getOperatorName(d.operator)===c);if(e.unshift(d),1<e.length)return`${c}(${e.map(b.serialize).join(", ")})`},UnaryExpression:(a)=>{var c=Mavo.Script.getOperatorName(a.operator,!0);if(c)return`${c}(${b.serialize(a.argument)})`},CallExpression:(a)=>{"Identifier"==a.callee.type&&("if"==a.callee.name&&(a.callee.name="iff"),a.callee.name="Mavo.Functions._Trap."+a.callee.name)}},serialize:(a)=>{var c=b.transformations[a.type]&&b.transformations[a.type](a);return void 0===c?b.serializers[a.type](a):c},rewrite:function(a){try{return b.serialize(b.parse(a))}catch(b){return a}},compile:function(a){return a=b.rewrite(a),new Function("data",`with(Mavo.Functions._Trap)
				with (data || {}) {
					return (${a});
				}`)},parse:self.jsep};for(let e in b.serializers.LogicalExpression=b.serializers.BinaryExpression,b.transformations.LogicalExpression=b.transformations.BinaryExpression,Mavo.Script.operators){let a=Mavo.Script.operators[e];2>a.scalar.length?Mavo.Script.addUnaryOperator(e,a):Mavo.Script.addBinaryOperator(e,a)}var e={average:"avg",iff:"iff IF",multiply:"mult product",divide:"div",lt:"smaller",gt:"larger bigger",eq:"equal equality",th:"ordinal"};for(let b in e)e[b].split(/\s+/g).forEach((a)=>Mavo.Functions[a]=Mavo.Functions[b])})(Bliss,Mavo.value,Mavo.Functions.util);
(function(a){var b=Mavo.Backend.register(a.Class({extends:Mavo.Backend,id:"Dropbox",constructor:function(){this.permissions.on(["login","read"]),this.key=this.mavo.element.getAttribute("mv-dropbox-key")||"2mx6061p054bpbp",this.url=b.fixShareURL(this.url),this.login(!0)},upload:function(a,b){return b=this.path.replace(/[^/]+$/,"")+b,this.put(a,b).then(()=>this.getURL(b))},getURL:function(a){return this.request("sharing/create_shared_link_with_settings",{path:a},"POST").then((a)=>b.fixShareURL(a.url))},put:function(a,b=this.path,c={}){return this.request("https://content.dropboxapi.com/2/files/upload",a,"POST",{headers:{"Dropbox-API-Arg":JSON.stringify({path:b,mode:"overwrite"}),"Content-Type":"application/octet-stream"}})},oAuthParams:()=>`&redirect_uri=${encodeURIComponent("https://auth.mavo.io")}&response_type=code`,getUser:function(){return this.user?Promise.resolve(this.user):this.request("users/get_current_account","null","POST").then((a)=>{this.user={username:a.email,name:a.name.display_name,avatar:a.profile_photo_url,info:a}})},login:function(a){return this.oAuthenticate(a).then(()=>this.getUser()).then(()=>{this.user&&(this.permissions.logout=!0,this.request("sharing/get_shared_link_metadata",{url:this.source},"POST").then((a)=>{this.path=a.path_lower,this.permissions.on(["edit","save"])}))})},logout:function(){return this.oAuthLogout()},static:{apiDomain:"https://api.dropboxapi.com/2/",oAuth:"https://www.dropbox.com/oauth2/authorize",test:function(a){return a=new URL(a,Mavo.base),/dropbox.com/.test(a.host)},fixShareURL:(a)=>{return a=new URL(a,Mavo.base),a.hostname="dl.dropboxusercontent.com",a.search=a.search.replace(/\bdl=0|^$/,"raw=1"),a}}}))})(Bliss,Bliss.$);
(function(a){var b=Mavo.Backend.register(a.Class({extends:Mavo.Backend,id:"Github",constructor:function(){this.permissions.on(["login","read"]),this.key=this.mavo.element.getAttribute("mv-github-key")||"7e08e016048000bc594e";var c=b.parseURL(this.url);if(c.username){if(a.extend(this,c),this.repo=this.repo||"mv-data",this.path=this.path||"",!/\.\w+$/.test(this.path)){var d=this.format.constructor.extensions[0]||".json";this.path+=`/${this.mavo.id}${d}`}this.path=this.path.replace(/\/\/|^\/|\/$/g,""),this.apiCall=`repos/${this.username}/${this.repo}/contents/${this.path}`}else this.apiCall=this.url.pathname.slice(1);this.login(!0)},get:function(){if(this.isAuthenticated()||!this.path)return this.request(this.apiCall).then((a)=>Promise.resolve(this.repo?b.atob(a.content):a));var a=new URL(`https://raw.githubusercontent.com/${this.username}/${this.repo}/${this.branch||"master"}/${this.path}`);return this.super.get.call(this,a)},upload:function(a,b=this.path){return Mavo.readFile(a).then((a)=>{var c=a.slice(5),d=c.match(/^\w+\/[\w+]+/)[0];return c=c.replace(RegExp(`^${d}(;base64)?,`),""),b=this.path.replace(/[^/]+$/,"")+b,this.put(c,b,{isEncoded:!0})}).then((a)=>this.getURL(b,a.commit.sha))},put:function(a,c=this.path,d={}){if(c){var e=`repos/${this.username}/${this.repo}`,f=`${e}/contents/${c}`,g=this.mavo.element.getAttribute("mv-github-commit-prefix")||"",h=this.repoInfo||this.request("user/repos",{name:this.repo},"POST").then((a)=>this.repoInfo=a);return a=d.isEncoded?a:b.btoa(a),Promise.resolve(h).then((a)=>{return this.canPush()?a:this.request(`${e}/forks`,{name:this.repo},"POST").then((a)=>{return f=`repos/${a.full_name}/contents/${c}`,this.forkInfo=a}).then((a)=>{var b,c=(d)=>{clearTimeout(b),this.request(`repos/${a.full_name}/commits`,{until:"1970-01-01T00:00:00Z"},"HEAD").then(()=>{d(a)}).catch(()=>{b=setTimeout(c,1e3)})};return new Promise(c)})}).then(()=>{return this.request(f,{ref:this.branch}).then((b)=>this.request(f,{message:g+this.mavo._("gh-updated-file",{name:b.name||"file"}),content:a,branch:this.branch,sha:b.sha},"PUT"),(b)=>{return 404==b.status?this.request(f,{message:g+"Created file",content:a,branch:this.branch},"PUT"):b})}).then((a)=>{return this.forkInfo&&this.request(`repos/${this.username}/${this.repo}/pulls`,{head:`${this.user.username}:${this.branch}`,base:this.branch}).then((a)=>{this.pullRequest(a[0])}),a})}},pullRequest:function(a){var b=new URL(location);b.searchParams.set(this.mavo.id+"-storage",`https://github.com/${this.forkInfo.full_name}/${this.path}`);var c=this.mavo._("gh-edit-suggestion-saved-in-profile",{previewURL:b});this.notice&&this.notice.close(),a?(this.notice=this.mavo.message(`${c}
				${this.mavo._("gh-edit-suggestion-notreviewed")}
				<form onsubmit="return false">
					<button class="mv-danger">${this.mavo._("gh-edit-suggestion-revoke")}</button>
				</form>`,{classes:"mv-inline",dismiss:["button","submit"]}),this.notice.closed.then((b)=>{b&&this.request(`repos/${this.username}/${this.repo}/pulls/${a.number}`,{state:"closed"},"POST").then((a)=>{new Mavo.UI.Message(this.mavo,`<a href="${a.html_url}">${this.mavo._("gh-edit-suggestion-cancelled")}</a>`,{dismiss:["button","timeout"]}),this.pullRequest()})})):(this.notice=this.mavo.message(`${c}
				${this.mavo._("gh-edit-suggestion-instructions")}
				<form onsubmit="return false">
					<textarea name="edits" class="mv-autosize" placeholder="${this.mavo._("gh-edit-suggestion-reason-placeholder")}"></textarea>
					<button>${this.mavo._("gh-edit-suggestion-send")}</button>
				</form>`,{classes:"mv-inline",dismiss:["button","submit"]}),this.notice.closed.then((a)=>{a&&this.request(`repos/${this.username}/${this.repo}/pulls`,{title:this.mavo._("gh-edit-suggestion-title"),body:this.mavo._("gh-edit-suggestion-body",{description:a.elements.edits.value,previewURL:b}),head:`${this.user.username}:${this.branch}`,base:this.branch},"POST").then((a)=>{new Mavo.UI.Message(this.mavo,`<a href="${a.html_url}">${this.mavo._("gh-edit-suggestion-sent")}</a>`,{dismiss:["button","timeout"]}),this.pullRequest(a)})}))},login:function(a){return this.oAuthenticate(a).then(()=>this.getUser()).catch((a)=>{401==a.status&&this.logout()}).then(()=>{if(this.user&&(this.permissions.on(["edit","save","logout"]),this.repo))return this.request(`repos/${this.username}/${this.repo}`).then((a)=>{return void 0===this.branch&&(this.branch=a.default_branch),this.repoInfo=a})})},canPush:function(){return this.repoInfo?this.repoInfo.permissions.push:this.user&&this.user.username.toLowerCase()==this.username.toLowerCase()},oAuthParams:()=>"&scope=repo,gist",logout:function(){return this.oAuthLogout().then(()=>{this.user=null})},getUser:function(){return this.user?Promise.resolve(this.user):this.request("user").then((b)=>{this.user={username:b.login,name:b.name||b.login,avatar:b.avatar_url,url:"https://github.com/"+b.login,info:b},a.fire(this.mavo.element,"mv-login",{backend:this})})},getURL:function(a=this.path,b){var c=this.forkInfo||this.repoInfo,d=c.full_name;return a=a.replace(/ /g,"%20"),c.pagesInfo=c.pagesInfo||this.request(`repos/${d}/pages`,{},"GET",{headers:{Accept:"application/vnd.github.mister-fantastic-preview+json"}}),c.pagesInfo.then((b)=>b.html_url+a).catch(()=>{return b?`https://cdn.rawgit.com/${d}/${b}/${a}`:`https://rawgit.com/${d}/${this.branch}/${a}`})},static:{apiDomain:"https://api.github.com/",oAuth:"https://github.com/login/oauth/authorize",test:function(a){return a=new URL(a,Mavo.base),/\bgithub.com|raw.githubusercontent.com/.test(a.host)},parseURL:function(a){var b={};a=new URL(a,Mavo.base);var c=a.pathname.slice(1).split("/");if(b.username=c.shift(),b.repo=c.shift(),/raw.githubusercontent.com$/.test(a.host))b.branch=c.shift();else{if(/api.github.com$/.test(a.host))return{};"blob"==c[0]&&(c.shift(),b.branch=c.shift())}return b.path=c.join("/"),b},btoa:(a)=>btoa(unescape(encodeURIComponent(a))),atob:(a)=>decodeURIComponent(escape(window.atob(a)))}}))})(Bliss,Bliss.$);
//# sourceMappingURL=maps/mavo.min.js.map
