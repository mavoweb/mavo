!function() {
"use strict";function t(e, r, i) {
return r=void 0===r?1:r, i=i||r+1, i-r<=1?function() {
if (arguments.length<=r||"string"===n.type(arguments[r])) {
return e.apply(this, arguments);
} var t, i=arguments[r];for (var s in i) {
var o=Array.from(arguments);o.splice(r, 1, s, i[s]), t=e.apply(this, o);
} return t;
}:t(t(e, r+1, i), r, i-1);
} function e(t, n, i) {
var s=r(i);if ("string"===s) {
var o=Object.getOwnPropertyDescriptor(n, i);!o||o.writable&&o.configurable&&o.enumerable&&!o.get&&!o.set?t[i]=n[i]:(delete t[i], Object.defineProperty(t, i, o));
}
else if ("array"===s) {
i.forEach(function(r) {
r in n&&e(t, n, r);
});
}
else {
for (var a in n) {
i&&("regexp"===s&&!i.test(a)||"function"===s&&!i.call(n, a))||e(t, n, a);
}
} return t;
} function r(t) {
if (null===t) {
return "null";
} if (void 0===t) {
return "undefined";
} var e=(Object.prototype.toString.call(t).match(/^\[object\s+(.*?)\]$/)[1]||"").toLowerCase();return "number"==e&&isNaN(t)?"nan":e;
} var n=self.Bliss=e(function(t, e) {
return 2==arguments.length&&!e||!t?null:"string"===n.type(t)?(e||document).querySelector(t):t||null;
}, self.Bliss);e(n, {extend:e, overload:t, type:r, property:n.property||"_", sources:{}, noop:function() {}, $:function(t, e) {
return t instanceof Node||t instanceof Window?[t]:2!=arguments.length||e?Array.from("string"==typeof t?(e||document).querySelectorAll(t):t||[]):[];
}, defined:function() {
for (var t=0;t<arguments.length;t++) {
if (void 0!==arguments[t]) {
return arguments[t];
}
}
}, create:function(t, e) {
return t instanceof Node?n.set(t, e):(1===arguments.length&&("string"===n.type(t)?e={}:(e=t, t=e.tag, e=n.extend({}, e, function(t) {
return "tag"!==t;
}))), n.set(document.createElement(t||"div"), e));
}, each:function(t, e, r) {
r=r||{};for (var n in t) {
r[n]=e.call(t, n, t[n]);
} return r;
}, ready:function(t) {
return t=t||document, new Promise(function(e, r) {
"loading"!==t.readyState?e():t.addEventListener("DOMContentLoaded", function() {
e();
});
});
}, Class:function(t) {
var e, r=["constructor", "extends", "abstract", "static"].concat(Object.keys(n.classProps)), i=t.hasOwnProperty("constructor")?t.constructor:n.noop;2==arguments.length?(e=arguments[0], t=arguments[1]):(e=function() {
if (this.constructor.__abstract&&this.constructor===e) {
throw new Error("Abstract classes cannot be directly instantiated.");
}e["super"]&&e["super"].apply(this, arguments), i.apply(this, arguments);
}, e["super"]=t["extends"]||null, e.prototype=n.extend(Object.create(e["super"]?e["super"].prototype:Object), {constructor:e}), e.prototype["super"]=e["super"]?e["super"].prototype:null, e.__abstract=!!t["abstract"]);var s=function(t) {
return this.hasOwnProperty(t)&&r.indexOf(t)===-1;
};if (t["static"]) {
n.extend(e, t["static"], s);for (var o in n.classProps) {
o in t["static"]&&n.classProps[o](e, t["static"][o]);
}
}n.extend(e.prototype, t, s);for (var o in n.classProps) {
o in t&&n.classProps[o](e.prototype, t[o]);
} return e;
}, classProps:{lazy:t(function(t, e, r) {
return Object.defineProperty(t, e, {get:function() {
var t=r.call(this);return Object.defineProperty(this, e, {value:t, configurable:!0, enumerable:!0, writable:!0}), t;
}, set:function(t) {
Object.defineProperty(this, e, {value:t, configurable:!0, enumerable:!0, writable:!0});
}, configurable:!0, enumerable:!0}), t;
}), live:t(function(t, e, r) {
return "function"===n.type(r)&&(r={set:r}), Object.defineProperty(t, e, {get:function() {
var t=this["_"+e], n=r.get&&r.get.call(this, t);return void 0!==n?n:t;
}, set:function(t) {
var n=this["_"+e], i=r.set&&r.set.call(this, t, n);this["_"+e]=void 0!==i?i:t;
}, configurable:r.configurable, enumerable:r.enumerable}), t;
})}, include:function() {
var t=arguments[arguments.length-1], e=2===arguments.length&&arguments[0], r=document.createElement("script");return e?Promise.resolve():new Promise(function(e, i) {
n.set(r, {async:!0, onload:function() {
e(), n.remove(r);
}, onerror:function() {
i();
}, src:t, inside:document.head});
});
}, fetch:function(t, r) {
if (!t) {
throw new TypeError("URL parameter is mandatory and cannot be "+t);
} var i=e({url:new URL(t, location), data:"", method:"GET", headers:{}, xhr:new XMLHttpRequest}, r);i.method=i.method.toUpperCase(), n.hooks.run("fetch-args", i), "GET"===i.method&&i.data&&(i.url.search+=i.data), document.body.setAttribute("data-loading", i.url), i.xhr.open(i.method, i.url.href, i.async!==!1, i.user, i.password);for (var s in r) {
if (s in i.xhr) {
try {
i.xhr[s]=r[s];
}
catch (o) {
self.console&&console.error(o);
}
}
}"GET"===i.method||i.headers["Content-type"]||i.headers["Content-Type"]||i.xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");for (var a in i.headers) {
i.xhr.setRequestHeader(a, i.headers[a]);
} return new Promise(function(t, e) {
i.xhr.onload=function() {
document.body.removeAttribute("data-loading"), 0===i.xhr.status||i.xhr.status>=200&&i.xhr.status<300||304===i.xhr.status?t(i.xhr):e(n.extend(Error(i.xhr.statusText), {xhr:i.xhr, get status() {
return this.xhr.status;
}}));
}, i.xhr.onerror=function() {
document.body.removeAttribute("data-loading"), e(n.extend(Error("Network Error"), {xhr:i.xhr}));
}, i.xhr.ontimeout=function() {
document.body.removeAttribute("data-loading"), e(n.extend(Error("Network Timeout"), {xhr:i.xhr}));
}, i.xhr.send("GET"===i.method?null:i.data);
});
}, value:function(t) {
var e="string"!==n.type(t);return n.$(arguments).slice(+e).reduce(function(t, e) {
return t&&t[e];
}, e?t:self);
}}), n.Hooks=new n.Class({add:function(t, e, r) {
if ("string"==typeof arguments[0]) {
(Array.isArray(t)?t:[t]).forEach(function(t) {
this[t]=this[t]||[], e&&this[t][r?"unshift":"push"](e);
}, this);
}
else {
for (var t in arguments[0]) {
this.add(t, arguments[0][t], arguments[1]);
}
}
}, run:function(t, e) {
this[t]=this[t]||[], this[t].forEach(function(t) {
t.call(e&&e.context?e.context:e, e);
});
}}), n.hooks=new n.Hooks;var i=n.property;n.Element=function(t) {
this.subject=t, this.data={}, this.bliss={};
}, n.Element.prototype={set:t(function(t, e) {
t in n.setProps?n.setProps[t].call(this, e):t in this?this[t]=e:this.setAttribute(t, e);
}, 0), transition:function(t, e) {
return e=+e||400, new Promise(function(r, i) {
if ("transition"in this.style) {
var s=n.extend({}, this.style, /^transition(Duration|Property)$/);n.style(this, {transitionDuration:(e||400)+"ms", transitionProperty:Object.keys(t).join(", ")}), n.once(this, "transitionend", function() {
clearTimeout(o), n.style(this, s), r(this);
});var o=setTimeout(r, e+50, this);n.style(this, t);
}
else {
n.style(this, t), r(this);
}
}.bind(this));
}, fire:function(t, e) {
var r=document.createEvent("HTMLEvents");return r.initEvent(t, !0, !0), this.dispatchEvent(n.extend(r, e));
}, unbind:t(function(t, e) {
(t||"").split(/\s+/).forEach(function(t) {
if (i in this&&(t.indexOf(".")>-1||!e)) {
t=(t||"").split(".");var r=t[1];t=t[0];var n=this[i].bliss.listeners=this[i].bliss.listeners||{};for (var s in n) {
if (!t||s===t) {
for (var o, a=0;o=n[s][a];a++) {
r&&r!==o.className||e&&e!==o.callback||(this.removeEventListener(s, o.callback, o.capture), a--);
}
}
}
}
else {
this.removeEventListener(t, e);
}
}, this);
}, 0)}, n.setProps={style:function(t) {
for (var e in t) {
e in this.style?this.style[e]=t[e]:this.style.setProperty(e, t[e]);
}
}, attributes:function(t) {
for (var e in t) {
this.setAttribute(e, t[e]);
}
}, properties:function(t) {
n.extend(this, t);
}, events:function(t) {
if (t&&t.addEventListener) {
var e=this;if (t[i]&&t[i].bliss) {
var r=t[i].bliss.listeners;for (var s in r) {
r[s].forEach(function(t) {
e.addEventListener(s, t.callback, t.capture);
});
}
} for (var o in t) {
0===o.indexOf("on")&&(this[o]=t[o]);
}
}
else if (arguments.length>1&&"string"===n.type(t)) {
var a=arguments[1], c=arguments[2];t.split(/\s+/).forEach(function(t) {
this.addEventListener(t, a, c);
}, this);
}
else {
for (var u in t) {
n.events(this, u, t[u]);
}
}
}, once:t(function(t, e) {
t=t.split(/\s+/);var r=this, n=function() {
return t.forEach(function(t) {
r.removeEventListener(t, n);
}), e.apply(r, arguments);
};t.forEach(function(t) {
r.addEventListener(t, n);
});
}, 0), delegate:t(function(t, e, r) {
this.addEventListener(t, function(t) {
t.target.closest(e)&&r.call(this, t);
});
}, 0, 2), contents:function(t) {
(t||0===t)&&(Array.isArray(t)?t:[t]).forEach(function(t) {
var e=n.type(t);/^(string|number)$/.test(e)?t=document.createTextNode(t+""):"object"===e&&(t=n.create(t)), t instanceof Node&&this.appendChild(t);
}, this);
}, inside:function(t) {
t.appendChild(this);
}, before:function(t) {
t.parentNode.insertBefore(this, t);
}, after:function(t) {
t.parentNode.insertBefore(this, t.nextSibling);
}, start:function(t) {
t.insertBefore(this, t.firstChild);
}, around:function(t) {
t.parentNode&&n.before(this, t), (/^template$/i.test(this.nodeName)?this.content||this:this).appendChild(t);
}}, n.Array=function(t) {
this.subject=t;
}, n.Array.prototype={all:function(t) {
var e=$$(arguments).slice(1);return this[t].apply(this, e);
}}, n.add=t(function(t, e, r, i) {
r=n.extend({$:!0, element:!0, array:!0}, r), "function"==n.type(e)&&(!r.element||t in n.Element.prototype&&i||(n.Element.prototype[t]=function() {
return this.subject&&n.defined(e.apply(this.subject, arguments), this.subject);
}), !r.array||t in n.Array.prototype&&i||(n.Array.prototype[t]=function() {
var t=arguments;return this.subject.map(function(r) {
return r&&n.defined(e.apply(r, t), r);
});
}), r.$&&(n.sources[t]=n[t]=e, (r.array||r.element)&&(n[t]=function() {
var e=[].slice.apply(arguments), i=e.shift(), s=r.array&&Array.isArray(i)?"Array":"Element";return n[s].prototype[t].apply({subject:i}, e);
})));
}, 0), n.add(n.Array.prototype, {element:!1}), n.add(n.Element.prototype), n.add(n.setProps), n.add(n.classProps, {element:!1, array:!1});var s=document.createElement("_");n.add(n.extend({}, HTMLElement.prototype, function(t) {
return "function"===n.type(s[t]);
}), null, !0);
}(), function(t) {
"use strict";if (Bliss&&!Bliss.shy) {
var e=Bliss.property;if (t.add({clone:function() {
var e=this.cloneNode(!0), r=t.$("*", e).concat(e);return t.$("*", this).concat(this).forEach(function(e, n, i) {
t.events(r[n], e), r[n]._.data=t.extend({}, e._.data);
}), e;
}}, {array:!1}), Object.defineProperty(Node.prototype, e, {get:function o() {
return Object.defineProperty(Node.prototype, e, {get:void 0}), Object.defineProperty(this, e, {value:new t.Element(this)}), Object.defineProperty(Node.prototype, e, {get:o}), this[e];
}, configurable:!0}), Object.defineProperty(Array.prototype, e, {get:function() {
return Object.defineProperty(this, e, {value:new t.Array(this)}), this[e];
}, configurable:!0}), self.EventTarget&&"addEventListener"in EventTarget.prototype) {
var r=EventTarget.prototype.addEventListener, n=EventTarget.prototype.removeEventListener, i=function(t, e, r) {
return r.callback===t&&r.capture==e;
}, s=function() {
return !i.apply(this, arguments);
};EventTarget.prototype.addEventListener=function(t, n, s) {
if (this&&this[e]&&this[e].bliss&&n) {
var o=this[e].bliss.listeners=this[e].bliss.listeners||{};if (t.indexOf(".")>-1) {
t=t.split(".");var a=t[1];t=t[0];
}o[t]=o[t]||[], 0===o[t].filter(i.bind(null, n, s)).length&&o[t].push({callback:n, capture:s, className:a});
} return r.call(this, t, n, s);
}, EventTarget.prototype.removeEventListener=function(t, r, i) {
if (this&&this[e]&&this[e].bliss&&r) {
var o=this[e].bliss.listeners=this[e].bliss.listeners||{};o[t]&&(o[t]=o[t].filter(s.bind(null, r, i)));
} return n.call(this, t, r, i);
};
}self.$=self.$||t, self.$$=self.$$||t.$;
}
}(Bliss);
/* jsep v0.3.1 (http://jsep.from.so/) */
!function(a) {
"use strict";var b="Compound", c="Identifier", d="MemberExpression", e="Literal", f="ThisExpression", g="CallExpression", h="UnaryExpression", i="BinaryExpression", j="LogicalExpression", k="ConditionalExpression", l="ArrayExpression", m=46, n=44, o=39, p=34, q=40, r=41, s=91, t=93, u=63, v=59, w=58, x=function(a, b) {
var c=new Error(a+" at character "+b);throw c.index=b, c.description=a, c;
}, y=!0, z={"-":y, "!":y, "~":y, "+":y}, A={"||":1, "&&":2, "|":3, "^":4, "&":5, "==":6, "!=":6, "===":6, "!==":6, "<":7, ">":7, "<=":7, ">=":7, "<<":8, ">>":8, ">>>":8, "+":9, "-":9, "*":10, "/":10, "%":10}, B=function(a) {
var b, c=0;for (var d in a) {
(b=d.length)>c&&a.hasOwnProperty(d)&&(c=b);
} return c;
}, C=B(z), D=B(A), E={"true":!0, "false":!1, "null":null}, F="this", G=function(a) {
return A[a]||0;
}, H=function(a, b, c) {
var d="||"===a||"&&"===a?j:i;return {type:d, operator:a, left:b, right:c};
}, I=function(a) {
return a>=48&&a<=57;
}, J=function(a) {
return 36===a||95===a||a>=65&&a<=90||a>=97&&a<=122||a>=128&&!A[String.fromCharCode(a)];
}, K=function(a) {
return 36===a||95===a||a>=65&&a<=90||a>=97&&a<=122||a>=48&&a<=57||a>=128&&!A[String.fromCharCode(a)];
}, L=function(a) {
for (var i, j, y=0, B=a.charAt, L=a.charCodeAt, M=function(b) {
return B.call(a, b);
}, N=function(b) {
return L.call(a, b);
}, O=a.length, P=function() {
for (var a=N(y);32===a||9===a||10===a||13===a;) {
a=N(++y);
}
}, Q=function() {
var a, b, c=S();return P(), N(y)!==u?c:(y++, a=Q(), a||x("Expected expression", y), P(), N(y)===w?(y++, b=Q(), b||x("Expected expression", y), {type:k, test:c, consequent:a, alternate:b}):void x("Expected :", y));
}, R=function() {
P();for (var b=a.substr(y, D), c=b.length;c>0;) {
if (A.hasOwnProperty(b)) {
return y+=c, b;
}b=b.substr(0, --c);
} return !1;
}, S=function() {
var a, b, c, d, e, f, g, h;if (f=T(), b=R(), !b) {
return f;
} for (e={value:b, prec:G(b)}, g=T(), g||x("Expected expression after "+b, y), d=[f, e, g];(b=R())&&(c=G(b), 0!==c);) {
for (e={value:b, prec:c};d.length>2&&c<=d[d.length-2].prec;) {
g=d.pop(), b=d.pop().value, f=d.pop(), a=H(b, f, g), d.push(a);
}a=T(), a||x("Expected expression after "+b, y), d.push(e, a);
} for (h=d.length-1, a=d[h];h>1;) {
a=H(d[h-1].value, d[h-2], a), h-=2;
} return a;
}, T=function() {
var b, c, d;if (P(), b=N(y), I(b)||b===m) {
return U();
} if (b===o||b===p) {
return V();
} if (J(b)||b===q) {
return Y();
} if (b===s) {
return $();
} for (c=a.substr(y, C), d=c.length;d>0;) {
if (z.hasOwnProperty(c)) {
return y+=d, {type:h, operator:c, argument:T(), prefix:!0};
}c=c.substr(0, --d);
} return !1;
}, U=function() {
for (var a, b, c="";I(N(y));) {
c+=M(y++);
} if (N(y)===m) {
for (c+=M(y++);I(N(y));) {
c+=M(y++);
}
} if (a=M(y), "e"===a||"E"===a) {
for (c+=M(y++), a=M(y), "+"!==a&&"-"!==a||(c+=M(y++));I(N(y));) {
c+=M(y++);
}I(N(y-1))||x("Expected exponent ("+c+M(y)+")", y);
} return b=N(y), J(b)?x("Variable names cannot start with a number ("+c+M(y)+")", y):b===m&&x("Unexpected period", y), {type:e, value:parseFloat(c), raw:c};
}, V=function() {
for (var a, b="", c=M(y++), d=!1;y<O;) {
if (a=M(y++), a===c) {
d=!0;break;
} if ("\\"===a) {
switch (a=M(y++)) {
case "n":b+="\n";break;case "r":b+="\r";break;case "t":b+="\t";break;case "b":b+="\b";break;case "f":b+="\f";break;case "v":b+="\x0B";break;default:b+="\\"+a;
}
}
 else {
b+=a;
}
} return d||x('Unclosed quote after "'+b+'"', y), {type:e, value:b, raw:c+b+c};
}, W=function() {
var b, d=N(y), g=y;for (J(d)?y++:x("Unexpected "+M(y), y);y<O&&(d=N(y), K(d));) {
y++;
} return b=a.slice(g, y), E.hasOwnProperty(b)?{type:e, value:E[b], raw:b}:b===F?{type:f}:{type:c, name:b};
}, X=function(a) {
for (var c, d, e=[], f=!1;y<O;) {
if (P(), c=N(y), c===a) {
f=!0, y++;break;
}c===n?y++:(d=Q(), d&&d.type!==b||x("Expected comma", y), e.push(d));
} return f||x("Expected "+String.fromCharCode(a), y), e;
}, Y=function() {
var a, b;for (a=N(y), b=a===q?Z():W(), P(), a=N(y);a===m||a===s||a===q;) {
y++, a===m?(P(), b={type:d, computed:!1, object:b, property:W()}):a===s?(b={type:d, computed:!0, object:b, property:Q()}, P(), a=N(y), a!==t&&x("Unclosed [", y), y++):a===q&&(b={type:g, arguments:X(r), callee:b}), P(), a=N(y);
} return b;
}, Z=function() {
y++;var a=Q();return P(), N(y)===r?(y++, a):void x("Unclosed (", y);
}, $=function() {
return y++, {type:l, elements:X(t)};
}, _=[];y<O;) {
i=N(y), i===v||i===n?y++:(j=Q())?_.push(j):y<O&&x('Unexpected "'+M(y)+'"', y);
} return 1===_.length?_[0]:{type:b, body:_};
};if (L.version="0.3.1", L.toString=function() {
return "JavaScript Expression Parser (JSEP) v"+L.version;
}, L.addUnaryOp=function(a) {
return C=Math.max(a.length, C), z[a]=y, this;
}, L.addBinaryOp=function(a, b) {
return D=Math.max(a.length, D), A[a]=b, this;
}, L.addLiteral=function(a, b) {
return E[a]=b, this;
}, L.removeUnaryOp=function(a) {
return delete z[a], a.length===C&&(C=B(z)), this;
}, L.removeBinaryOp=function(a) {
return delete A[a], a.length===D&&(D=B(A)), this;
}, L.removeLiteral=function(a) {
return delete E[a], this;
}, "undefined"==typeof exports) {
var M=a.jsep;a.jsep=L, L.noConflict=function() {
return a.jsep===L&&(a.jsep=M), L;
};
}
else {
"undefined"!=typeof module&&module.exports?exports=module.exports=L:exports.parse=L;
}
}(this);
// # sourceMappingURL=jsep.min.js.map
!function() {
function e(e, t) {
return e instanceof Node||e instanceof Window?[e]:[].slice.call("string"==typeof e?(t||document).querySelectorAll(e):e||[]);
} if (self.Element&&(Element.prototype.matches||(Element.prototype.matches=Element.prototype.webkitMatchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||null), Element.prototype.matches)) {
var t=self.Stretchy={selectors:{base:'textarea, select:not([size]), input:not([type]), input[type="'+"text url email tel".split(" ").join('"], input[type="')+'"]', filter:"*"}, script:document.currentScript||e("script").pop(), resize:function(e) {
if (t.resizes(e)) {
var i, n=getComputedStyle(e), o=0;!e.value&&e.placeholder&&(i=!0, e.value=e.placeholder);var l=e.nodeName.toLowerCase();if ("textarea"==l) {
e.style.height="0", "border-box"==n.boxSizing?o=e.offsetHeight:"content-box"==n.boxSizing&&(o=-e.clientHeight+parseFloat(n.minHeight)), e.style.height=e.scrollHeight+o+"px";
}
else if ("input"==l) {
if (e.style.width="1000px",
e.offsetWidth) {
e.style.width="0", "border-box"==n.boxSizing?o=e.offsetWidth:"padding-box"==n.boxSizing?o=e.clientWidth:"content-box"==n.boxSizing&&(o=parseFloat(n.minWidth));var r=Math.max(o, e.scrollWidth-e.clientWidth);e.style.width=r+"px";for (var s=0;s<10&&(e.scrollLeft=1e10, 0!=e.scrollLeft);s++) {
r+=e.scrollLeft, e.style.width=r+"px";
}
}
else {
e.style.width=e.value.length+1+"ch";
}
}
else if ("select"==l) {
var c=e.selectedIndex>0?e.selectedIndex:0, a=document.createElement("_");a.textContent=e.options[c].textContent, e.parentNode.insertBefore(a, e.nextSibling);var d;for (var h in n) {
var p=n[h];/^(width|webkitLogicalWidth|length)$/.test(h)||"string"!=typeof p||(a.style[h]=p, /appearance$/i.test(h)&&(d=h));
}a.style.width="", a.offsetWidth>0&&(e.style.width=a.offsetWidth+"px", n[d]&&"none"===n[d]||(e.style.width="calc("+e.style.width+" + 2em)")), a.parentNode.removeChild(a), a=null;
}i&&(e.value="");
}
}, resizeAll:function(i) {
e(i||t.selectors.base).forEach(function(e) {
t.resize(e);
});
}, active:!0, resizes:function(e) {
return e&&e.parentNode&&e.matches&&e.matches(t.selectors.base)&&e.matches(t.selectors.filter);
}, init:function() {
t.selectors.filter=t.script.getAttribute("data-filter")||(e("[data-stretchy-filter]").pop()||document.body).getAttribute("data-stretchy-filter")||Stretchy.selectors.filter||"*", t.resizeAll();
}, $$:e};"loading"!==document.readyState?t.init():document.addEventListener("DOMContentLoaded", t.init);var i=function(e) {
t.active&&t.resize(e.target);
};document.documentElement.addEventListener("input", i), document.documentElement.addEventListener("change", i), self.MutationObserver&&new MutationObserver(function(e) {
t.active&&e.forEach(function(e) {
"childList"==e.type&&Stretchy.resizeAll(e.addedNodes);
});
}).observe(document.documentElement, {childList:!0, subtree:!0});
}
}();
// # sourceMappingURL=stretchy.min.js.map

(function(b, c) {
var d=self.Mavo=b.Class({constructor:function(e) {
this.treeBuilt=Mavo.defer(), this.element=e, this.inProgress=!1, this.index=Object.keys(d.all).length+1, Object.defineProperty(d.all, this.index-1, {value:this});var f=d.attributes.map(n => `[data-${n}]`).join(", ");if ([this.element, ...c(f, this.element)].forEach(n => {
for (let p of d.attributes) {
let q=n.getAttribute("data-"+p);null!==q&&n.setAttribute(p, q);
}
}), this.id=Mavo.getAttribute(this.element, "mv-app", "id")||`mavo${this.index}`, this.id in d.all) {
for (var g=2;this.id+g in d.all;g++) {
;
} this.id+=g;
}d.all[this.id]=this, this.element.setAttribute("mv-app", this.id);var h=b.value(this.element.closest("[lang]"), "lang")||Mavo.locale;this.locale=Mavo.Locale.get(h), this.autoEdit=this.element.classList.contains("mv-autoedit"), this.autoSave=this.element.hasAttribute("mv-autosave"), this.autoSaveDelay=1e3*(this.element.getAttribute("mv-autosave")||3), this.element.setAttribute("typeof", ""), Mavo.hooks.run("init-start", this);for (var e of c(d.selectors.primitive+","+d.selectors.multiple, this.element)) {
var j=b(`${d.selectors.not(d.selectors.formControl)}, ${d.selectors.property}`, e);if (j) {
var k=Mavo.Primitive.getConfig(e), l=Mavo.is("multiple", e);!l&&(k.attribute||k.hasChildren)||e.setAttribute("typeof", "");
}
} this.expressions=new Mavo.Expressions(this), Mavo.hooks.run("init-tree-before", this), this.root=new Mavo.Group(this.element, this), this.treeBuilt.resolve(), Mavo.hooks.run("init-tree-after", this), this.permissions=new Mavo.Permissions;var m=["source", "storage", "init"];for (let n of m) {
this.updateBackend(n);
} this.backendObserver=new Mavo.Observer(this.element, m.map(n => "mv-"+n), n => {
var p={}, q=n.map(r => {
var u=r.attributeName.replace(/^mv-/, "");return p[u]=this.updateBackend(u), u;
});p.source?this.load():!this.source&&(p.storage||p.init&&!this.root.data)&&this.load();
}), this.permissions.can("login", () => {
("login"in Mavo.Functions.$url&&1==this.index||this.id+"-login"in Mavo.Functions.$url)&&this.primaryBackend.login();
}), this.element.addEventListener("mavo:login.mavo", n => {
n.backend!=(this.source||this.storage)||this.root.data||this.unsavedChanges||this.load();
}), this.bar=new Mavo.UI.Bar(this), b("summary [property]:not([typeof])")&&this.element.addEventListener("click", n => {
n.target!=document.activeElement&&n.preventDefault();
}), this.needsEdit=this.calculateNeedsEdit(), this.setUnsavedChanges(!1), this.permissions.onchange(({action:n, value:p}) => {
var q=this.element.getAttribute("mv-permissions")||"";q=q.trim().split(/\s+/).filter(r => r!=n), p&&q.push(n), this.element.setAttribute("mv-permissions", q.join(" "));
}), this.needsEdit&&this.permissions.can(["edit", "add", "delete"], () => {
this.modeObserver=new Mavo.Observer(this.element, "mv-mode", n => {
for (let p of n) {
let q=p.target;nodeloop:for (let r of d.Node.children(q)) {
let v, u=r.mode;if (r.element==q) {
v=r.element.getAttribute("mv-mode"), r.modes=v;
}
else {
if (r.modes) {
continue nodeloop;
}v=d.getStyle(r.element.parentNode, "--mv-mode");
}r.mode=v, u!=r.mode&&r["edit"==r.mode?"edit":"done"]();
}
}
}, {subtree:!0}), this.autoEdit&&this.edit();
}, () => {
this.modeObserver&&this.modeObserver.destroy();
}), this.storage||this.source?this.permissions.can("read", () => this.load()):requestAnimationFrame(() => {
b.fire(this.element, "mavo:load");
}), this.permissions.can("save", () => {
this.autoSave&&this.element.addEventListener("mavo:load.mavo:autosave", () => {
var p=d.debounce(() => {
this.save();
}, this.autoSaveDelay), q=r => {
r.node.saved&&p();
};requestAnimationFrame(() => {
this.permissions.can("save", () => {
this.element.addEventListener("mavo:datachange.mavo:autosave", q);
}, () => {
this.element.removeEventListener("mavo:datachange.mavo:autosave", q);
});
});
});
}, () => {
b.unbind(this.element, ".mavo:save .mavo:autosave");
}), this.element.addEventListener("keydown", n => {
if (this.permissions.save&&83==n.keyCode&&n[d.superKey]&&!n.altKey) {
n.preventDefault(), this.save();
}
else if (38==n.keyCode||40==n.keyCode) {
var p=n.target;if (p.matches("textarea, input[type=range], input[type=number]")) {
return;
} if (p.matches(".mv-editor")) {
p=p.parentNode;
} var r=Mavo.Node.get(p);if (r&&r.closestCollection) {
var u=r.getCousin(38==n.keyCode?-1:1, {wrap:!0});u&&(u.editing?u.edit({immediately:!0}).then(() => u.editor.focus()):u.element.focus(), n.preventDefault());
}
}
}), Mavo.hooks.run("init-end", this);
}, get editing() {
return this.root.editing;
}, getData:function(e) {
return this.root.getData(e);
}, toJSON:function() {
return d.toJSON(this.getData());
}, message:function(e, f) {
return new d.UI.Message(this, e, f);
}, error:function(e, ...f) {
this.message(e, {type:"error", dismiss:["button", "timeout"]}), 0<f.length&&console.log(`%c${this.id}: ${e}`, "color: red; font-weight: bold", ...f);
}, render:function(e) {
this.expressions.active=!1;var f={context:this, data:e};d.hooks.run("render-start", f), f.data&&this.root.render(f.data), this.unsavedChanges=!1, this.expressions.active=!0, requestAnimationFrame(() => this.expressions.update()), d.hooks.run("render-end", f);
}, clear:function() {
confirm(this._("delete-confirmation"))&&this.store(null).then(() => this.root.clear());
}, edit:function() {
this.root.edit(), b.events(this.element, "mouseenter.mavo:edit mouseleave.mavo:edit", e => {
if (e.target.matches(d.selectors.multiple)) {
e.target.classList.remove("mv-has-hovered-item");var f=e.target.parentNode.closest(d.selectors.multiple);f&&f.classList.toggle("mv-has-hovered-item", "mouseenter"==e.type);
}
}, !0), this.setUnsavedChanges();
}, setUnsavedChanges:function(e) {
var f=!!e;return e||this.walk(g => {
if (g.unsavedChanges) {
return f=!0, !1===e&&(g.unsavedChanges=!1), !1;
}
}), this.unsavedChanges=f;
}, done:function() {
this.root.done(), b.unbind(this.element, ".mavo:edit"), this.unsavedChanges=!1;
}, updateBackend:function(e) {
var g, f=this[e];1==this.index&&(g=d.Functions.$url[e]), g||(g=d.Functions.$url[`${this.id}-${e}`]||this.element.getAttribute("mv-"+e)||null), g&&(g=g.trim(), "none"==g&&(g=null)), !g||f&&f.equals(g)?!g&&(this[e]=null):this[e]=g=d.Backend.create(g, {mavo:this, format:this.element.getAttribute(`mv-${e}-format`)||this.element.getAttribute("mv-format")}, this.element.getAttribute(`mv-${e}-type`));var h=g?!g.equals(f):!!f;if (h) {
this.storage||this.source||!this.init||(this.source=this.init, this.init=null);var j=this.storage?this.storage.permissions:new Mavo.Permissions({edit:!0, save:!1});j.parent=this.source&&this.source.permissions, this.permissions.parent=j, this.primaryBackend=this.storage||this.source;
} return h;
}, load:function() {
var e=this.source||this.storage;return e?(this.inProgress="Loading", e.ready.then(() => e.load()).catch(f => {
return this.init&&this.init!=e?(e=this.init, this.init.ready.then(() => this.init.load())):Promise.reject(f);
}).catch(f => {
if (f) {
var g=f instanceof XMLHttpRequest?f:f.xhr;if (g&&404==g.status) {
this.render(null);
}
else {
var h="Problem loading data";g&&(h+=g.status?`: HTTP error ${f.status}: ${f.statusText}`:": Can\u2019t connect to the Internet"), this.error(h, f);
}
} return null;
}).then(f => this.render(f)).then(() => {
this.inProgress=!1, b.fire(this.element, "mavo:load");
})):Promise.resolve();
}, store:function() {
return this.storage?(this.inProgress="Saving", this.storage.store(this.getData()).catch(e => {
if (e) {
var f=this._("problem-saving");e instanceof XMLHttpRequest&&(f+=": "+(e.status?this._("http-error", e):this._("cant-connect"))), this.error(f, e);
} return null;
}).then(e => {
return this.inProgress=!1, e;
})):Promise.resolve();
}, upload:function(e, f="images/"+e.name) {
return this.uploadBackend?(this.inProgress=this._("uploading"), this.uploadBackend.upload(e, f).then(g => {
return this.inProgress=!1, g;
}).catch(g => {
return this.error(this._("error-uploading"), g), this.inProgress=!1, null;
})):Promise.reject();
}, save:function() {
return this.store().then(e => {
e&&(b.fire(this.element, "mavo:save", e), this.lastSaved=Date.now(), this.root.save(), this.unsavedChanges=!1);
});
}, walk:function(e) {
return this.root.walk(e);
}, calculateNeedsEdit:function() {
var f=!1;return this.walk(g => {
return !f&&(f=!g.modes&&"Group"!=g.nodeType, !g.modes||void 0);
}, void 0, {descentReturn:!0}), f;
}, live:{inProgress:function(e) {
b.toggleAttribute(this.element, "mv-progress", e, e), b.toggleAttribute(this.element, "aria-busy", !!e, !!e), this.element.style.setProperty("--mv-progress-text", e?`"${this._(e)}"`:"");
}, unsavedChanges:function(e) {
this.element.classList.toggle("mv-unsaved-changes", e);
}, needsEdit:function(e) {
this.bar.toggle("edit", e&&this.permissions.edit);
}, storage:function(e) {
if (e!==this._storage&&!e) {
var f=new Mavo.Permissions({edit:!0, save:!1});f.parent=this.permissions.parent, this.permissions.parent=f;
}
}, primaryBackend:function(e) {
if (e=e||null, e!=this._primaryBackend) {
return e?this.element.style.setProperty("--mv-backend", `"${e.id}"`):this.element.style.removeProperty("--mv-backend"), e;
}
}, uploadBackend:{get:function() {
if (this.storage&&this.storage.upload) {
return this.storage;
}
}}}, static:{all:{}, get:function(e) {
if (e instanceof Element) {
for (var f in d.all) {
if (d.all[f].element==e) {
return d.all[f];
}
} return null;
} var f="number"==typeof e?Object.keys(d.all)[e]:e;return d.all[f]||null;
}, toNode:Symbol("toNode"), superKey:0===navigator.platform.indexOf("Mac")?"metaKey":"ctrlKey", base:"about:"==location.protocol?document.currentScript?document.currentScript.src:"http://mavo.io":location, dependencies:[], init:function(e=document) {
var f=Array.isArray(arguments[0])?arguments[0]:c(d.selectors.init, e);return f.filter(g => !d.get(g)).map(g => new d(g));
}, UI:{}, hooks:new b.Hooks, attributes:["mv-app", "mv-storage", "mv-source", "mv-init", "mv-path", "mv-format", "mv-attribute", "mv-default", "mv-mode", "mv-edit", "mv-permisssions", "mv-rel"], lazy:{locale:() => document.documentElement.lang||"en-GB"}}});Object.defineProperty(d.all, "length", {get:function() {
return Object.keys(this).length;
}}); {let e=d.selectors={init:".mv-app, [mv-app], [data-mv-app]", property:"[property], [itemprop]", specificProperty:l => `[property=${l}], [itemprop=${l}]`, group:"[typeof], [itemscope], [itemtype], [mv-group]", multiple:"[mv-multiple]", formControl:"input, select, option, textarea", textInput:["text", "email", "url", "tel", "search"].map(l => `input[type=${l}]`).join(", ")+", input:not([type]), textarea", ui:".mv-ui", container:{tr:"table", option:"select"}}, f=e.arr=l => l.split(/\s*,\s*/g), g=e.not=l => f(l).map(m => `:not(${m})`).join(""), h=e.or=(l, m) => l+", "+m, j=e.and=(l, m) => {
var n=[], p=f(m);return f(l).forEach(q => n.push(...p.map(r => q+r))), n.join(", ");
}, k=e.andNot=(l, m) => j(l, g(m));b.extend(d.selectors, {primitive:k(e.property, e.group), rootGroup:k(e.group, e.property), item:h(e.multiple, e.group), output:h(e.specificProperty("output"), ".mv-output")});}requestAnimationFrame(() => {
var e=[];b.each({blissfuljs:Array.from&&document.documentElement.closest&&self.URL&&"searchParams"in URL.prototype, "Intl.~locale.en":self.Intl, IntersectionObserver:self.IntersectionObserver, Symbol:self.Symbol}, (f, g) => {
g||e.push(f);
}), d.dependencies.push(b.ready(), d.Plugins.load(), b.include(!e.length, "https://cdn.polyfill.io/v2/polyfill.min.js?features="+e.join(","))), d.inited=b.ready().then(() => {
return b.attributes(c(d.selectors.init), {"mv-progress":"Loading"}), d.ready;
}).catch(console.error).then(() => Mavo.init()), d.ready=d.thenAll(d.dependencies);
}), Stretchy.selectors.filter=".mv-editor:not([property]), .mv-autosize";
})(Bliss, Bliss.$);
(function(b, d) {
function e(h, k) {
for (h="mv-"+h+"-within", d("."+h).forEach(l => l.classList.remove(h));k&&k.classList;) {
k.classList.add(h), k=k.parentNode;
}
} var g=b.extend(Mavo, {load:(h, k=document.currentScript?document.currentScript.src:location) => {
if (g.loaded=g.loaded||new Set, !g.loaded.has(h+"")) {
return h=new URL(h, k), /\.css$/.test(h.pathname)?(b.create("link", {href:h, rel:"stylesheet", inside:document.head}), Promise.resolve()):b.include(h);
}
}, readFile:(h, k="DataURL") => {
var l=new FileReader;return new Promise((m, n) => {
l.onload=() => m(l.result), l.onerror=l.onabort=n, l["readAs"+k](h);
});
}, toJSON:h => {
return null===h?"":"string"==typeof h?h:JSON.stringify(h, null, "\t");
}, safeToJSON:function(h) {
var k=new WeakSet;return JSON.stringify(h, (l, m) => {
if ("object"==typeof m&&null!==m) {
if (k.has(m)) {
return;
}k.add(m);
} return m;
});
}, objectify:(h, k) => {
var l=Mavo.value(h);if ("object"!=typeof h||null===h) {
if (null===h) {
h={[Symbol.toStringTag]:"Null", toJSON:() => null};
}
else {
var m=h.constructor;h=new m(l), h[Symbol.toStringTag]=m.name;
}h.valueOf=h[Symbol.toPrimitive]=() => l;
} return b.extend(h, k);
}, value:h => h&&h.valueOf?h.valueOf():h, toArray:h => {
return h===void 0?[]:Array.isArray(h)?h:[h];
}, delete:(h, k, l) => {
do {
var m=h&&h.indexOf(k);-1<m&&h.splice(m, 1);
} while (-1<m&&l);
}, flatten:h => {
return Array.isArray(h)?h.reduce((k, l) => g.toArray(k).concat(g.flatten(l)), []):[h];
}, pushUnique:(h, k) => {
-1===h.indexOf(k)&&h.push(k);
}, union:(h, k) => {
return new Set([...(h||[]), ...(k||[])]);
}, is:function(h, ...k) {
for (let l of k) {
if (l&&l.matches&&l.matches(g.selectors[h])) {
return !0;
}
} return !1;
}, getStyle:(h, k) => h&&getComputedStyle(h).getPropertyValue(k).trim(), data:function(h, k, l) {
return 2==arguments.length?b.value(h, "_", "data", "mavo", k):(h._.data.mavo=h._.data.mavo||{}, void 0===l)?void delete h._.data.mavo[k]:h._.data.mavo[k]=l;
}, elementPath:function(h, k, l=[1, 3]) {
var m=1===l.length&&1==l[0];if (Array.isArray(k)) {
var n=k;return n.reduce((v, w) => {
if (m) {
var x=v.children;
}
else {
var x=d(v.childNodes).filter(y => -1<l.indexOf(y.nodeType));
} return x[w];
}, h);
} for (var n=[], q=k;q&&q!=h;q=q.parentNode) {
for (var t=0, u=q;u=u[`previous${m?"Element":""}Sibling`];) {
-1<l.indexOf(u.nodeType)&&t++;
}n.unshift(t);
} return q?n:null;
}, revocably:{add:function(h, k) {
var l=g.revocably.isRemoved(h);return l&&l.parentNode?l.parentNode.replaceChild(h, l):h&&k&&!h.parentNode&&k.appendChild(h), l;
}, remove:function(h, k) {
if (h) {
var l=g.data(h, "commentstub");return l||(k=k||h.id||h.className||h.nodeName, l=g.data(h, "commentstub", document.createComment(k))), h.parentNode&&h.parentNode.replaceChild(l, h), l;
}
}, isRemoved:function(h) {
if (!h||h.parentNode) {
return !1;
} var k=g.data(h, "commentstub");return k&&k.parentNode&&k;
}, setAttribute:function(h, k, l) {
var m=g.data(h, "attribute-"+k);m===void 0&&g.data(h, "attribute-"+k, h.getAttribute(k)), h.setAttribute(k, l);
}, restoreAttribute:function(h, k) {
var l=g.data(h, "attribute-"+k);l!==void 0&&(b.toggleAttribute(h, k, l), g.data(h, "attribute-"+k, void 0));
}}, inView:{is:h => {
var k=h.getBoundingClientRect();return (0<=k.bottom&&k.bottom<=innerHeight||0<=k.top&&k.top<=innerHeight)&&(0<=k.right&&k.right<=innerWidth||0<=k.left&&k.left<=innerWidth);
}, when:h => {
var k=g.inView.observer=g.inView.observer||new IntersectionObserver(function(l) {
for (var m of l) {
this.unobserve(m.target), b.fire(m.target, "mavo:inview", {entry:m});
}
});return new Promise(l => {
g.is(h)&&l(), k.observe(h);var m=n => {
h.removeEventListener("mavo:inview", m), n.stopPropagation(), l();
};h.addEventListener("mavo:inview", m);
});
}}, scrollIntoViewIfNeeded:h => {
h&&!Mavo.inView.is(h)&&h.scrollIntoView({behavior:"smooth"});
}, setAttributeShy:function(h, k, l) {
h.hasAttribute(k)||h.setAttribute(k, l);
}, getAttribute:function(h, ...k) {
for (let m, n, l=0;m=k[l];l++) {
if (n=h.getAttribute(m), n) {
return n;
}
} return null;
}, getTarget:function() {
var h=location.hash.substr(1);return document.getElementById(h);
}, in:function(h, k) {
if (h) {
return "object"==typeof h&&k in h||void 0!==h[k];
}
}, getCanonicalProperty:function(h, k) {
if (h&&(k||0===k)) {
if (g.in(h, k)) {
return k;
} if (k.toLowerCase) {
var l=k.toLowerCase();if (g.in(h, l)) {
return l;
} var m=Object.keys(h), n=m.map(q => q.toLowerCase()).indexOf(l);if (-1<n) {
return m[n];
}
}
}
}, subset:function(h, k, l) {
if (3==arguments.length) {
if (k.length) {
var m=b.value(h, ...k.slice(0, -1));return m[k[k.length-1]]=l, h;
} return l;
} return "object"==typeof h&&k&&k.length?k.reduce((n, q, t) => {
if (n&&q in n) {
return n[q];
} if (Array.isArray(n)&&isNaN(q)) {
for (var u=0;u<n.length;u++) {
if (n[u]&&n[u].id==q) {
return k[t]=u, n[u];
}
}
} return n;
}, h):h;
}, clone:function(h) {
return JSON.parse(g.safeToJSON(h));
}, debounce:function(h, k) {
if (!k) {
return h;
} var m, l=null;return function() {
var n=this, q=arguments;m=function() {
h.apply(n, q), removeEventListener("beforeunload", m);
}, clearTimeout(l), l=setTimeout(m, k), addEventListener("beforeunload", m);
};
}, timeout:h => new Promise(k => setTimeout(k, h)), escapeRegExp:h => h.replace(/[-\/\\^$*+?.()|[\]{}]/g, "\\$&"), matches:(h, k) => {
var l=(h+"").match(k);return l?l:[];
}, match:(h, k, l=0) => g.matches(h, k)[l]||"", observeResize:function(h, k) {
if (self.ResizeObserver) {
var l=null, m=k instanceof ResizeObserver?k:new ResizeObserver(n => {
var q=n[n.length-1].contentRect;l&&l.width==q.width&&l.height==q.height||(k(n), l=q);
});return m.observe(h), m;
}
}, Observer:b.Class({constructor:function(h, k, l, m={}) {
l instanceof MutationObserver&&(this.observer=l), this.observer=this.observer||new MutationObserver(l), this.element=h, this.callback=l, this.attribute=k, this.options=b.extend({}, m), k&&b.extend(this.options, {attributes:!0, attributeFilter:"all"==this.attribute?void 0:Mavo.toArray(this.attribute), attributeOldValue:!!m.oldValue}), this.attribute&&"all"!=this.attribute||b.extend(this.options, {characterData:!0, childList:!0, subtree:!0, characterDataOldValue:!!m.oldValue}), this.run();
}, stop:function() {
return this.observer.disconnect(), this.running=!1, this;
}, run:function() {
return this.observer&&(this.observer.observe(this.element, this.options), this.running=!0), this;
}, sneak:function(h) {
if (this.running) {
this.stop();var k=h();this.run();
}
else {
var k=h();
} return k;
}, destroy:function() {
this.observer.disconnect(), this.observer=this.element=null;
}, static:{sneak:function(h, k) {
return h?h.sneak(k):k();
}}}), defer:function(h) {
var k, l, m=new Promise((n, q) => {
h&&h(n, q), k=n, l=q;
});return m.resolve=n => {
return k(n), m;
}, m.reject=n => {
return l(n), m;
}, m;
}, thenAll:function(h) {
for (let k of h) {
"promise"==b.type(k)&&(k=k.catch(l => l));
} return Promise.all(h).then(k => {
return h.length==k.length?k:g.thenAll(h);
});
}, rr:function(h) {
return h(), h;
}, wrap:(h, k) => 0>h?k-1:h>=k?0:h});b.add("toggleAttribute", function(h, k, l=null!==k) {
l?this.setAttribute(h, k):this.removeAttribute(h);
}), b.proxy=b.classProps.proxy=b.overload(function(h, k, l) {
return Object.defineProperty(h, k, {get:function() {
return this[l][k];
}, set:function(m) {
this[l][k]=m;
}, configurable:!0, enumerable:!0}), h;
}), b.classProps.propagated=function(h, k) {
Mavo.toArray(k).forEach(l => {
var m=h[l];h[l]=function() {
var n=m&&m.apply(this, arguments);this.propagate&&!1!==n&&this.propagate(l);
};
});
};document.addEventListener("focus", h => {
e("focus", h.target);
}, !0), document.addEventListener("blur", () => {
e("focus", null);
}, !0), addEventListener("hashchange", () => {
e("target", g.getTarget());
}), document.documentElement.addEventListener("mavo:datachange", () => {
e("target", g.getTarget());
}), e("focus", document.activeElement===document.body?null:document.activeElement);
})(Bliss, Bliss.$);
(function(a) {
var b=Mavo.Locale=a.Class({constructor:function(c, d) {
this.lang=c, this.phrases={}, this.extend(d);
}, get fallback() {
return b.all[this.baseLang]?b.all[this.baseLang]:this===b.default?void 0:b.default;
}, extend:function(c) {
a.extend(this.phrases, c);
}, phrase:function(c, d) {
var e=c.toLowerCase(), f=this.phrases[e];if (void 0===f&&this.fallback&&(f=this.fallback.phrase(e)), void 0===f) {
f=Mavo.Functions.readable(e);
}
else if (d) {
var g=Mavo.matches(f, /\{\w+(?=\})/g).map(i => i.slice(1));g=Mavo.Functions.unique(g);for (var h of g) {
h in d&&(f=f.replace(RegExp(`{${h}}`, "gi"), d[h]));
}
} return f;
}, live:{lang:function(c) {
this.baseLang=b.getBaseLang(c), c==this.baseLang&&(this.baseLang=null);
}}, static:{all:{}, register:function(c, d) {
b.all[c]?b.all[c].extend(d):b.all[c]=new b(c, d);
}, match:function(c="") {
return b.all[c]||b.all[b.getBaseLang(c)];
}, get:function(c) {
return b.match(c)||b.default;
}, getBaseLang:function(c) {
return c.split("-")[0];
}, lazy:{default:() => {
return b.match(Mavo.locale)||b.all.en;
}}}});Mavo.prototype._=function(c, d) {
return this.locale&&c?this.locale.phrase(c, d):c;
}, a.ready().then(() => {
for (var c of $$("datalist.mv-phrases[lang]")) {
var d=$$("option", c).reduce((e, f) => {
return e[f.value]=f.textContent.trim(), e;
}, {});Mavo.Locale.register(c.lang, d);
}
});
})(Bliss);
Mavo.Locale.register("en", {edit:"Edit", save:"Save", clear:"Clear", logout:"Logout", login:"Login", loading:"Loading", uploading:"Uploading", saving:"Saving", "logged-in-as":"Logged in to {id} as ", "login-to":"Login to {id}", "error-uploading":"Error uploading file", "problem-saving":"Problem saving data", "http-error":"HTTP error {status}: {statusText}", "cant-connect":"Can\u2019t connect to the Internet", "add-item":"Add {name}", "add-item-before":"Add new {name} before", "add-item-after":"Add new {name} after", "drag-to-reorder":"Drag to reorder {name}", "delete-item":"Delete this {name}", "delete-confirmation":"This will delete all your data. Are you sure?", "gh-updated-file":"Updated {name}", "gh-edit-suggestion-saved-in-profile":"Your edits are saved to <a href=\"{previewURL}\" target=\"_blank\">your own profile</a>, because you are not allowed to edit this page.", "gh-edit-suggestion-instructions":"Write a short description of your edits below to suggest them to the page admins:", "gh-edit-suggestion-notreviewed":"You have selected to suggest your edits to the page admins. Your suggestions have not been reviewed yet.", "gh-edit-suggestion-send":"Send edit suggestion", "gh-edit-suggestion-revoke":"Revoke edit suggestion", "gh-edit-suggestion-reason-placeholder":"I added / corrected / deleted ...", "gh-edit-suggestion-cancelled":"Edit suggestion cancelled successfully!", "gh-edit-suggestion-title":"Suggested edits to data", "gh-edit-suggestion-body":`Hello there! I used Mavo to suggest the following edits:
{description}
Preview my changes here: {previewURL}`, "gh-edit-suggestion-sent":"Edit suggestion sent successfully!"});
(function(a) {
Mavo.attributes.push("mv-plugins");var b=Mavo.Plugins={loaded:{}, load:function() {
b.plugins=new Set;for (let c of $$("[mv-plugins]")) {
let d=c.getAttribute("mv-plugins").trim().split(/\s+/);for (let e of d) {
b.plugins.add(e);
}
} return b.plugins.size?a.fetch(b.url+"/plugins.json", {responseType:"json"}).then(c => {
return Mavo.thenAll(c.response.plugin.filter(d => b.plugins.has(d.id)).map(d => {
if (d.repo) {
var e=`https://raw.githubusercontent.com/${d.repo}/`;
}
else {
var e=`${b.url}/${d.id}/`;
} var f=`${e}mavo-${d.id}.js`;return a.include(b.loaded[d.id], f);
}));
}):Promise.resolve();
}, register:function(c, d={}) {
if (!b.loaded[c]) {
for (let h in Mavo.hooks.add(d.hooks), d.extend) {
let i="Mavo"==h?Mavo:Mavo[h];"function"===a.type(i)?a.Class(i, d.extend[h]):a.extend(i, d.extend[h]);
} var e=[];if (d.ready&&e.push(d.ready), d.dependencies) {
var f=document.currentScript?document.currentScript.src:location, g=d.dependencies.map(h => Mavo.load(h, f));e.push(...g);
}e.length&&Mavo.dependencies.push(...e), b.loaded[c]=d, d.init&&Promise.all(e).then(() => d.init());
}
}, url:"https://plugins.mavo.io/"};
})(Bliss);
(function(a) {
Mavo.attributes.push("mv-bar");var c=Mavo.UI.Bar=a.Class({constructor:function(d) {
this.mavo=d, this.element=a(".mv-bar", this.mavo.element), this.element?this.custom=!0:this.element=a.create({className:"mv-bar mv-ui", start:this.mavo.element, innerHTML:"<button>&nbsp;</button>"}), this.element.classList.contains("mv-compact")&&(this.noResize=!0), this.controls=c.getControls(this.mavo.element.getAttribute("mv-bar")||this.element.getAttribute("mv-bar")), this.controls.length&&(this.targetHeight=this.element.offsetHeight), this.custom||(this.element.innerHTML="");for (let f of this.controls) {
let g=c.controls[f];for (var e in this[f]=a(`.mv-${f}`, this.element), this[f]?this[f].remove():g.create?this[f]=g.create.call(this.mavo):this[f]=a.create("button", {className:`mv-${f}`, textContent:this.mavo._(f)}), this.add(f), g.permission?this.permissions.can(g.permission, () => {
this.toggle(f, !g.condition||g.condition.call(this.mavo));
}, () => {
this.remove(f);
}):g.condition&&!g.condition.call(this.mavo)&&this.remove(f), g.events) {
a.events(this[f], e, g.events[e].bind(this.mavo));
}
} for (let f in c.controls) {
let g=c.controls[f];g.action&&a.delegate(this.mavo.element, "click", ".mv-"+f, h => {
(!g.permission||this.permissions.is(g.permission))&&(g.action.call(this.mavo), h.preventDefault());
});
} this.controls.length&&!this.noResize&&(this.resize(), self.ResizeObserver&&(this.resizeObserver=Mavo.observeResize(this.element, () => {
this.resize();
})));
}, resize:function() {
return this.targetHeight?void(this.resizeObserver&&this.resizeObserver.disconnect(), this.element.classList.remove("mv-compact", "mv-tiny"), this.element.offsetHeight>1.5*this.targetHeight&&(this.element.classList.add("mv-compact"), this.element.offsetHeight>1.2*this.targetHeight&&this.element.classList.add("mv-tiny")), this.resizeObserver&&this.resizeObserver.observe(this.element)):void(this.targetHeight=this.element.offsetHeight);
}, add:function(d) {
var e=c.controls[d];e.prepare&&e.prepare.call(this.mavo), Mavo.revocably.add(this[d], this.element), this.resizeObserver||this.noResize||requestAnimationFrame(() => this.resize());
}, remove:function(d) {
var e=c.controls[d];Mavo.revocably.remove(this[d], "mv-"+d), e.cleanup&&e.cleanup.call(this.mavo), this.resizeObserver||this.noResize||requestAnimationFrame(() => this.resize());
}, toggle:function(d, e) {
return this[e?"add":"remove"](d);
}, proxy:{permissions:"mavo"}, static:{getControls:function(d) {
if (d) {
var e="none"==d?[]:d.split(/\s+/), f=!/(\s+|^)(?!no\-)[a-z]+(\s+|$)/.test(d), g=f?Object.keys(c.controls):[];for (var h of e) {
var i=/^\s*no\-/i.test(h), j=Mavo.match(h, /([a-z]+)\s*$/i, 1);i?Mavo.delete(g, j):j in c.controls&&g.push(j);
}
}
else {
return Object.keys(c.controls);
} return g;
}, controls:{status:{create:function() {
var d=a.create({className:"mv-status"});return d;
}, prepare:function() {
var d=this.primaryBackend;if (d&&d.user) {
var e=d.user, f=e.name||"";e.avatar&&(f=`<img class="mv-avatar" src="${e.avatar}" /> ${f}`), e.url&&(f=`<a href="${e.url}" target="_blank">${f}</a>`), this.bar.status.innerHTML=`<span>${this._("logged-in-as", d)}</span> `+f;
}
}, permission:"logout"}, edit:{action:function() {
this.editing?this.done():this.edit();
}, permission:["edit", "add", "delete"], cleanup:function() {
this.editing&&this.done();
}}, save:{action:function() {
this.save();
}, events:{"mouseenter focus":function() {
this.element.classList.add("mv-highlight-unsaved");
}, "mouseleave blur":function() {
this.element.classList.remove("mv-highlight-unsaved");
}}, permission:"save", condition:function() {
return !this.autoSave||0<this.autoSaveDelay;
}}, clear:{action:function() {
this.clear();
}, permission:"delete"}, login:{action:function() {
this.primaryBackend.login();
}, permission:"login"}, logout:{action:function() {
this.primaryBackend.logout();
}, permission:"logout"}}}});
})(Bliss, Bliss.$);
(function(a) {
Mavo.UI.Message=a.Class({constructor:function(d, f, g) {
if (this.mavo=d, this.message=f, this.closed=Mavo.defer(), this.element=a.create({className:"mv-ui mv-message"+(g.type?" mv-"+g.type:""), innerHTML:this.message, events:{click:() => Mavo.scrollIntoViewIfNeeded(this.mavo.element)}, after:this.mavo.bar.element}), g.classes&&this.element.classList.add(g.classes), "error"==g.type?this.element.setAttribute("role", "alert"):this.element.setAttribute("aria-live", "polite"), g.dismiss=g.dismiss||{}, "string"==typeof g.dismiss||Array.isArray(g.dismiss)) {
var h={};for (let k of Mavo.toArray(g.dismiss)) {
h[k]=!0;
}g.dismiss=h;
} if (g.dismiss.button&&a.create("button", {className:"mv-close mv-ui", textContent:"\xD7", events:{click:() => this.close()}, start:this.element}), g.dismiss.timeout) {
var j, i="number"==typeof g.dismiss.timeout?g.dismiss.timeout:5e3;a.events(this.element, {mouseenter:() => clearTimeout(j), mouseleave:Mavo.rr(() => j=setTimeout(() => this.close(), i))});
}g.dismiss.submit&&this.element.addEventListener("submit", k => {
k.preventDefault(), this.close(k.target);
});
}, close:function(d) {
a.transition(this.element, {opacity:0}).then(() => {
a.remove(this.element), this.closed.resolve(d);
});
}});
})(Bliss, Bliss.$);
(function(a) {
var b=Mavo.Permissions=a.Class({constructor:function(c) {
this.triggers=[], this.hooks=new a.Hooks, this.parentChanged=b.prototype.parentChanged.bind(this), this.set(c);
}, set:function(c) {
for (var d in c) {
this[d]=c[d];
}
}, on:function(c) {
return Mavo.toArray(c).forEach(d => this[d]=!0), this;
}, off:function(c) {
return c=Array.isArray(c)?c:[c], c.forEach(d => this[d]=!1), this;
}, can:function(c, d, e) {
this.observe(c, !0, d), e&&this.cannot(c, e);
}, cannot:function(c, d) {
this.observe(c, !1, d);
}, observe:function(c, d, e) {
c=Mavo.toArray(c), this.is(c, d)&&e(), this.triggers.push({actions:c, value:d, callback:e, active:!0});
}, is:function(c, d=!0) {
var e=Mavo.toArray(c).map(f => !!this[f]).reduce((f, g) => f||g);return d?e:!e;
}, onchange:function(c) {
this.hooks.add("change", c);for (let d of b.actions) {
c.call(this, {action:d, value:this[d]});
}
}, parentChanged:function(c={}) {
var d=this["_"+c.action];void 0!==d||c.from==c.value||(this.fireTriggers(c.action), this.hooks.run("change", a.extend({context:this}, c)));
}, changed:function(c, d, e) {
e=!!e, d=!!d;d==e||(this["_"+c]=d, this.fireTriggers(c), this.hooks.run("change", {action:c, value:d, from:e, context:this}));
}, fireTriggers:function(c) {
for (let e of this.triggers) {
var d=this.is(e.actions, e.value);e.active&&-1<e.actions.indexOf(c)&&d?(e.active=!1, e.callback()):!d&&(e.active=!0);
}
}, or:function(c) {
for (let d of b.actions) {
this[d]=this[d]||c[d];
} return this;
}, live:{parent:function(c) {
var d=this._parent;if (d!=c) {
this._parent=c, d&&Mavo.delete(d.hooks.change, this.parentChanged);for (let e of b.actions) {
this.parentChanged({action:e, value:c?c[e]:void 0, from:d?d[e]:void 0});
}c&&c.onchange(this.parentChanged);
}
}}, static:{actions:[], register:function(c, d) {
return Array.isArray(c)?void c.forEach(e => b.register(e, d)):void(a.live(b.prototype, c, {get:function() {
var e=this["_"+c];return void 0===e&&this.parent?this.parent[c]:e;
}, set:function(e, f) {
d&&d.call(this, e, f), this.changed(c, e, f);
}}), b.actions.push(c));
}}});b.register(["read", "save"]), b.register("login", function(c) {
c&&this.logout&&(this.logout=!1);
}), b.register("logout", function(c) {
c&&this.login&&(this.login=!1);
}), b.register("edit", function(c) {
c&&(this.add=this.delete=!0);
}), b.register(["add", "delete"], function(c) {
c||(this.edit=!1);
});
})(Bliss);
(function(a) {
var b=Mavo.Backend=a.Class({constructor:function(c, d={}) {
this.source=c, this.url=new URL(this.source, Mavo.base), this.mavo=d.mavo, this.format=Mavo.Formats.create(d.format, this), this.permissions=new Mavo.Permissions;
}, get:function(c=new URL(this.url)) {
return c.searchParams.set("timestamp", Date.now()), a.fetch(c.href).then(d => Promise.resolve(d.responseText), () => Promise.resolve(null));
}, load:function() {
return this.ready.then(() => this.get()).then(c => {
return "string"==typeof c?(c=c.replace(/^\ufeff/, ""), this.format.parse(c)):c;
});
}, store:function(c, {path:d, format:e=this.format}={}) {
return this.ready.then(() => {
var f="string"==typeof c?Promise.resolve(c):e.stringify(c);return f.then(g => this.put(g, d).then(() => {
return {data:c, serialized:g};
}));
});
}, ready:Promise.resolve(), login:() => Promise.resolve(), logout:() => Promise.resolve(), put:() => Promise.reject(), isAuthenticated:function() {
return !!this.accessToken;
}, oAuthParams:() => "", toString:function() {
return `${this.id} (${this.url})`;
}, equals:function(c) {
return c===this||c&&this.id==c.id&&this.source==c.source;
}, request:function(c, d, e="GET", f={}) {
return f.method=f.method||e, f.responseType=f.responseType||"json", f.headers=a.extend({"Content-Type":"application/json; charset=utf-8"}, f.headers||{}), f.data=d, this.isAuthenticated()&&(f.headers.Authorization=f.headers.Authorization||`Bearer ${this.accessToken}`), "object"===a.type(f.data)&&("GET"==f.method?f.data=Object.keys(f.data).map(g => g+"="+encodeURIComponent(f.data[g])).join("&"):f.data=JSON.stringify(f.data)), c=new URL(c, this.constructor.apiDomain), "GET"==f.method&&c.searchParams.set("timestamp", Date.now()), a.fetch(c, f).catch(g => {
return g&&g.xhr?Promise.reject(g.xhr):void this.mavo.error("Something went wrong while connecting to "+this.id, g);
}).then(g => "HEAD"==f.method?g:g.response);
}, oAuthenticate:function(c) {
return this.ready.then(() => {
return this.isAuthenticated()?Promise.resolve():new Promise((d, e) => {
var f=this.id.toLowerCase();if (c) {
this.accessToken=localStorage[`mavo:${f}token`], this.accessToken&&d(this.accessToken);
}
else {
var g={width:Math.min(1e3, innerWidth-100), height:Math.min(800, innerHeight-100)};g.top=(screen.height-g.height)/2, g.left=(screen.width-g.width)/2;var h={url:location.href, backend:this.id};if (this.authPopup=open(`${this.constructor.oAuth}?client_id=${this.key}&state=${encodeURIComponent(JSON.stringify(h))}`+this.oAuthParams(), "popup", `width=${g.width},height=${g.height},left=${g.left},top=${g.top}`), !this.authPopup) {
var i="Login popup was blocked! Please check your popup blocker settings.";this.mavo.error(i), e(Error(i));
}addEventListener("message", j => {
if (j.source===this.authPopup) {
for (var k in j.data.backend==this.id&&(this.accessToken=localStorage[`mavo:${f}token`]=j.data.token), this.accessToken||e(Error("Authentication error")), d(this.accessToken), Mavo.all) {
var l=Mavo.all[k].primaryBackend;l&&l.id===this.id&&l!==this&&!l.isAuthenticated()&&l.login(!0);
}
}
});
}
});
});
}, oAuthLogout:function() {
if (this.isAuthenticated()) {
var c=this.id.toLowerCase();localStorage.removeItem(`mavo:${c}token`), delete this.accessToken, this.permissions.off(["edit", "add", "delete", "save"]).on("login"), this.mavo.element._.fire("mavo:logout", {backend:this});
} return Promise.resolve();
}, static:{create:function(c, d, e) {
var f;return e&&(f=Mavo.Functions.get(b, e)), c&&!f&&(f=b.types.filter(g => g.test(c))[0]||b.Remote), f?new f(c, d):null;
}, types:[], register:function(c) {
return b[c.prototype.id]=c, b.types.push(c), c;
}}});b.register(a.Class({id:"Element", extends:b, constructor:function() {
this.permissions.on(["read", "edit", "save"]), this.element=a(this.source)||a.create("script", {type:"application/json", id:this.source.slice(1), inside:document.body});
}, get:function() {
return Promise.resolve(this.element.textContent);
}, put:function(c) {
return Promise.resolve(this.element.textContent=c);
}, static:{test:c => 0===c.indexOf("#")}})), b.register(a.Class({id:"Remote", extends:b, constructor:function() {
this.permissions.on("read");
}, static:{test:() => !1}})), b.register(a.Class({extends:b, id:"Local", constructor:function() {
this.permissions.on(["read", "edit", "save"]), this.key=this.mavo.id;
}, get:function() {
return Promise[this.key in localStorage?"resolve":"reject"](localStorage[this.key]);
}, put:function(c) {
return c?localStorage[this.key]=c:delete localStorage[this.key], Promise.resolve(c);
}, static:{test:c => "local"==c}}));
})(Bliss);
(function(a) {
var c=Mavo.Formats={}, e=c.Base=a.Class({abstract:!0, constructor:function(i) {
this.backend=i;
}, proxy:{mavo:"backend"}, parse:function(i) {
return this.constructor.parse(i, this);
}, stringify:function(i) {
return this.constructor.stringify(i, this);
}, static:{parse:i => Promise.resolve(i), stringify:i => Promise.resolve(i), extensions:[], dependencies:[], ready:function() {
return Promise.all(this.dependencies.map(i => a.include(i.test(), i.url)));
}}}), f=c.JSON=a.Class({extends:c.Base, static:{parse:i => Promise.resolve(i?JSON.parse(i):null), stringify:i => Promise.resolve(Mavo.toJSON(i)), extensions:[".json", ".jsonld"]}}), g=c.Text=a.Class({extends:c.Base, constructor:function() {
this.property=this.mavo.root.getNames("Primitive")[0];
}, static:{extensions:[".txt"], parse:(i, j) => Promise.resolve({[j?j.property:"content"]:i}), stringify:(i, j) => Promise.resolve(i[j?j.property:"content"])}}), h=c.CSV=a.Class({extends:c.Base, constructor:function() {
this.property=this.mavo.root.getNames("Collection")[0], this.options=a.extend({}, c.CSV.defaultOptions);
}, static:{extensions:[".csv", ".tsv"], defaultOptions:{header:!0, dynamicTyping:!0, skipEmptyLines:!0}, dependencies:[{test:() => self.Papa, url:"https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.1.4/papaparse.min.js"}], ready:e.ready, parse:(i, j) => h.ready().then(() => {
var k=Papa.parse(i, h.defaultOptions), l=j?j.property:"content";if (j&&(j.options.delimiter=k.meta.delimiter, j.options.linebreak=k.meta.linebreak), k.meta.aborted) {
throw k.meta.errors.pop();
} return {[l]:k.data};
}), stringify:(i, j) => h.ready().then(() => {
var k=j?j.property:"content", l=j?j.options:h.defaultOptions;return Papa.unparse(i[k], l);
})}});Object.defineProperty(c, "create", {value:function(i, j) {
if (i&&"object"==typeof i) {
return i;
} if ("string"==typeof i) {
for (var k in i=i.toLowerCase(), c) {
var l=c[k];if (k.toLowerCase()==i) {
return new l(j);
}
}
} if (!i) {
var m=j.url?j.url.pathname:j.source, n=Mavo.match(m, /\.\w+$/)||".json", l=c.JSON;for (var k in c) {
-1<c[k].extensions.indexOf(n)&&(l=c[k]);
} return new l(j);
}
}});
})(Bliss, Bliss.$);
(function(a, b) {
var c=Mavo.Node=a.Class({abstract:!0, constructor:function(d, f, g={}) {
if (!d||!f) {
throw new Error("Mavo.Node constructor requires an element argument and a mavo object");
} var h={context:this, options:g};this.uid=++c.maxId, this.nodeType=this.nodeType, this.property=null, this.element=d, a.extend(this, h.options), c.all.set(d, [...(c.all.get(this.element)||[]), this]), this.mavo=f, this.group=this.parentGroup=h.options.group, this.template=h.options.template, this.alias=this.element.getAttribute("mv-alias"), this.template?this.template.copies.push(this):this.copies=[], this.fromTemplate("property", "type")||(this.property=c.getProperty(d), this.type=Mavo.Group.normalize(d), this.storage=this.element.getAttribute("mv-storage")), this.modes=this.element.getAttribute("mv-mode"), Mavo.hooks.run("node-init-start", h), this.mode=Mavo.getStyle(this.element, "--mv-mode")||"read", this.collection=h.options.collection, this.collection&&(this.group=this.parentGroup=this.collection.parentGroup);var j=this.template;j&&j.expressions&&(this.expressions=j.expressions.map(k => new Mavo.DOMExpression({template:k, item:this, mavo:this.mavo}))), Mavo.hooks.run("node-init-end", h);
}, get editing() {
return "edit"==this.mode;
}, get isRoot() {
return !this.property;
}, get name() {
return Mavo.Functions.readable(this.property||this.type).toLowerCase();
}, get saved() {
return "none"!==this.storage;
}, get parent() {
return this.collection||this.parentGroup;
}, postInit:function() {
"edit"==this.modes&&this.edit();
}, destroy:function() {
this.template&&Mavo.delete(this.template.copies, this);
}, getData:function(d={}) {
if (this.isDataNull(d)) {
return d.forceObjects?Mavo.objectify(null):null;
}
}, isDataNull:function(d) {
var f={context:this, options:d, result:this.deleted||!this.saved&&!d.live};return Mavo.hooks.run("unit-isdatanull", f), f.result;
}, walk:function(d, f=[], g={}) {
var h=(j, k) => {
var l=d(j, k);if (!1!==l) {
for (let m in j.children) {
let n=j.children[m];if (n instanceof Mavo.Node) {
var l=h.call(n, n, [...k, m]);if (!1===l&&!g.descentReturn) {
return !1;
}
}
}
} return !1!==l;
};return h(this, f);
}, walkUp:function(d) {
for (var g, f=this;f=f.parentGroup;) {
if (g=d(f), void 0!==g) {
return g;
}
}
}, edit:function() {
return this.mode="edit", "edit"==this.mode&&void Mavo.hooks.run("node-edit-end", this);
}, done:function() {
return this.mode=Mavo.getStyle(this.element.parentNode, "--mv-mode")||"read", "read"==this.mode&&void(a.unbind(this.element, ".mavo:edit"), this.propagate("done"), Mavo.hooks.run("node-done-end", this));
}, clear:function() {
"read"!=this.modes&&this.propagate("clear");
}, propagate:function(d) {
for (let f in this.children) {
let g=this.children[f];g instanceof Mavo.Node&&("function"==typeof d?d.call(g, g):d in g&&g[d]());
}
}, propagated:["save", "destroy"], toJSON:Mavo.prototype.toJSON, fromTemplate:function(...d) {
if (this.template) {
for (let f of d) {
this[f]=this.template[f];
}
} return !!this.template;
}, render:function(d) {
this.oldData=this.data, this.data=d, d=Mavo.subset(d, this.inPath);var f={context:this, data:d};if (Mavo.hooks.run("node-render-start", f), "Collection"!=this.nodeType&&Array.isArray(d)) {
var g;this.isRoot&&1===(g=Object.keys(this.children)).length&&"Collection"===this.children[g[0]].nodeType?f.data={[g[0]]:f.data}:(this.inPath.push("0"), f.data=f.data[0]);
} this.editing?(this.done(), this.dataRender(f.data), this.edit()):this.dataRender(f.data), this.save(), Mavo.hooks.run("node-render-end", f);
}, dataChanged:function(d, f={}) {
a.fire(f.element||this.element, "mavo:datachange", a.extend({property:this.property, action:d, mavo:this.mavo, node:this}, f));
}, toString:function() {
return `#${this.uid}: ${this.nodeType} (${this.property})`;
}, getClosestCollection:function() {
var d=this.closestItem;return d?d.collection:null;
}, getClosestItem:function() {
return this.collection&&this.collection.mutable?this:this.parentGroup?this.parentGroup.closestItem:null;
}, isDeleted:function() {
this.deleted;return !!this.deleted||!!this.parentGroup&&this.parentGroup.isDeleted();
}, relativizeData:self.Proxy?function(d, f={live:!0}) {
var g={};return new Proxy(d, {get:(h, j, k) => {
return j in h?h[j]:j in k&&j in g?g[j]:void 0;
}, has:(h, j) => {
if (j in h||j in g) {
return !0;
} switch (j) {
case "$index":return g[j]=this.index||0, !0;case "$next":case "$previous":return this.closestCollection?(g[j]=this.closestCollection.getData(f)[this.index+("$next"==j?1:-1)], !0):(g[j]=null, !1);
} if (this instanceof Mavo.Group&&j==this.property&&this.collection) {
return g[j]=h, !0;
} var k=this.walkUp(l => {
if (j in l.children) {
return l.children[j];
}
});return void 0===k&&(k=this.find(j)), void 0===k&&(k=this.mavo.root.find(j)), void 0===k?j in Mavo.all&&Mavo.all[j].root&&(g[j]=Mavo.all[j].root.getData(f)):(Array.isArray(k)?k=k.map(l => l.getData(f)).filter(l => null!==l):k instanceof Mavo.Node&&(k=k.getData(f)), g[j]=k, !0);
}, set:function(h, j="", k) {
return console.warn(`You cannot set data via expressions. Attempt to set ${j.toString()} to ${k} ignored.`), k;
}});
}:d => d, pathFrom:function(d) {
for (var f=this.path, g=d.path, h=0;h<f.length&&g[h]==f[h];h++) {
;
} return f.slice(h);
}, getDescendant:function(d) {
return d.reduce((f, g) => f.children[g], this);
}, getCousin:function(d, f={}) {
if (!this.closestCollection) {
return null;
} var g=this.closestCollection, h=Math.abs(d), j=0>d?-1:1;if (g.length<h+1) {
return null;
} var k=this.closestItem.index+d;f.wrap&&(k=Mavo.wrap(k, g.length));for (var m, l=0;l<g.length;l++) {
m=k+l*j, m=f.wrap?Mavo.wrap(m, g.length):m;var n=g.children[m];if (!n||!n.isDeleted()) {
break;
}
} if (!n||n.isDeleted()||n==this.closestItem) {
return null;
} if (this.collection) {
return n;
} var q=this.pathFrom(this.closestItem);return n.getDescendant(q);
}, lazy:{closestCollection:function() {
return this.getClosestCollection();
}, closestItem:function() {
return this.getClosestItem();
}, inPath:function() {
return "Collection"==this.nodeType?[]:(this.element.getAttribute("mv-path")||"").split("/").filter(d => d.length);
}, properties:function() {
if (this.template) {
return this.template.properties;
} var d=new Set(this.property&&[this.property]);if ("Group"==this.nodeType) {
for (var f in this.children) {
d=Mavo.union(d, this.children[f].properties);
}
}
else {
"Collection"==this.nodeType&&(d=Mavo.union(d, this.itemTemplate.properties));
} return d;
}}, live:{store:function(d) {
a.toggleAttribute(this.element, "mv-storage", d);
}, unsavedChanges:function(d) {
return !d||this.saved&&this.editing||(d=!1), this.element.classList.toggle("mv-unsaved-changes", d), d;
}, mode:function(d) {
if (this._mode!=d) {
if (this.modes&&d!=this.modes&&(d=this.modes), this._mode=d, !(this instanceof Mavo.Collection)&&-1<[null, "", "read", "edit"].indexOf(this.element.getAttribute("mv-mode"))) {
var f=this.modes||"edit"==d;Mavo.Observer.sneak(this.mavo.modeObserver, () => {
a.toggleAttribute(this.element, "mv-mode", d, f);
});
} return d;
}
}, modes:function(d) {
return d&&"read"!=d&&"edit"!=d?null:void(this._modes=d, d&&this.mode!=d&&(this.mode=d));
}, deleted:function(d) {
this.element.classList.toggle("mv-deleted", d), d?(this.elementContents=document.createDocumentFragment(), b(this.element.childNodes).forEach(f => {
this.elementContents.appendChild(f);
}), a.contents(this.element, [{tag:"button", className:"mv-close mv-ui", textContent:"\xD7", events:{click:function() {
a.remove(this.parentNode);
}}}, "Deleted "+this.name, {tag:"button", className:"mv-undo mv-ui", textContent:"Undo", events:{click:() => this.deleted=!1}}]), this.element.classList.remove("mv-highlight"), this.itembar.remove()):this.deleted&&(this.element.textContent="", this.element.appendChild(this.elementContents), this._deleted=!1, this.dataChanged("undelete"), this.itembar.add());
}, path:{get:function() {
var d=this.parent?this.parent.path:[];return this.property?[...d, this.property]:d;
}}}, static:{maxId:0, all:new WeakMap, create:function(d, f, g={}) {
return Mavo.is("multiple", d)&&!g.collection?new Mavo.Collection(d, f, g):new Mavo[Mavo.is("group", d)?"Group":"Primitive"](d, f, g);
}, getProperty:function(d) {
var f=d.getAttribute("property")||d.getAttribute("itemprop");return f||(d.hasAttribute("property")?f=d.name||d.id||d.classList[0]:d.matches(Mavo.selectors.multiple)&&(f=d.getAttribute("mv-multiple")||"collection")), f&&d.setAttribute("property", f), f;
}, get:function(d, f) {
var g=(c.all.get(d)||[]).filter(h => !(h instanceof Mavo.Collection));return 2>g.length||!f?g[0]:g[0]instanceof Mavo.Group?node[1]:void 0;
}, children:function(d) {
var f=Mavo.Node.get(d);return f?[f]:(f=b(Mavo.selectors.property, d).map(g => Mavo.Node.get(g)).filter(g => !d.contains(g.parentGroup.element)).map(g => g.collection||g), Mavo.Functions.unique(f));
}}});
})(Bliss, Bliss.$);
(function(a, b) {
var c=Mavo.Group=a.Class({extends:Mavo.Node, nodeType:"Group", constructor:function() {
if (this.children={}, this.group=this, Mavo.hooks.run("group-init-start", this), Mavo.Primitive.getValueAttribute(this.element)) {
this.children[this.property]=new Mavo.Primitive(this.element, this.mavo, {group:this});
} var h=b(Mavo.selectors.property+", "+Mavo.selectors.multiple, this.element).filter(l => {
return this.element===l.parentNode.closest(Mavo.selectors.group);
}), j=h.map(l => Mavo.Node.getProperty(l));h.forEach((l, m) => {
var n=j[m], q=this.template?this.template.children[n]:null, r={template:q, group:this};if (this.children[n]) {
var s=this.children[n];s.add(l), s.mutable=s.mutable||Mavo.is("multiple", l);
}
else {
this.children[n]=j.indexOf(n)==j.lastIndexOf(n)?Mavo.Node.create(l, this.mavo, r):new Mavo.Collection(l, this.mavo, r);
}
});var k=(this.isRoot?this.element.closest("[vocab]"):null)||this.element;this.vocab=k.getAttribute("vocab"), this.postInit(), Mavo.hooks.run("group-init-end", this);
}, get isRoot() {
return !this.property;
}, getNames:function(d="Node") {
return Object.keys(this.children).filter(e => this.children[e]instanceof Mavo[d]);
}, getData:function(d={}) {
var e={context:this, options:d, data:this.super.getData.call(this, d)};if (void 0!==e.data) {
return e.data;
}e.data=this.data?Mavo.clone(Mavo.subset(this.data, this.inPath)):{};var f=Object.keys(this.children);if (1==f.length&&f[0]==this.property) {
var g=a.extend(a.extend({}, e.options), {forceObjects:!0});e.data=this.children[this.property].getData(g);
}
else {
for (var h in this.children) {
var j=this.children[h];if (j.saved||e.options.live) {
var k=j.getData(e.options);null!==k||e.options.live?e.data[j.property]=k:delete e.data[j.property];
}
}
} return e.options.live?e.data&&(e.data[Mavo.toNode]=this, e.data=this.relativizeData(e.data)):(e.data=Mavo.subset(this.data, this.inPath, e.data), f.length||this.isRoot?e.data&&"object"==typeof e.data&&(this.type&&this.type!=c.DEFAULT_TYPE&&(e.data["@type"]=this.type), this.vocab&&(e.data["@context"]=this.vocab)):e.data=null), Mavo.hooks.run("node-getdata-end", e), e.data;
}, find:function(d, e={}) {
if (this.property==d) {
return this;
} if (d in this.children) {
return this.children[d].find(d, e);
} if (this.properties.has(d)) {
var g, h, f=[];for (var j in this.children) {
h=this.children[j].find(d, e), void 0!=h&&(Array.isArray(h)?(f.push(...h), g=!0):f.push(h));
} return g||1<f.length?f:f[0];
}
}, edit:function(d={}) {
return !1!==this.super.edit.call(this)&&Promise.all(Object.keys(this.children).map(e => this.children[e].edit(d)));
}, save:function() {
this.unsavedChanges=!1;
}, propagated:["save", "import"], dataRender:function(d) {
if (d) {
if ("object"!=typeof d) {
if (this.property in this.children) {
var f=this.property;
}
else {
var g=a.type(d), h=l => (this.children[l]instanceof Mavo.Primitive)+(this.children[l].datatype==g), f=Object.keys(this.children).filter(l => !this.children[l].expressionText).sort((l, m) => h(l)-h(m)).reverse()[0];
}d={[f]:d}, this.data=Mavo.subset(this.data, this.inPath, d);
} this.propagate(l => {
var m=d[l.property], n=void 0===m&&l.alias?d[l.alias]:m;l.render(n);
});var f;
}
}, static:{all:new WeakMap, DEFAULT_TYPE:"Item", normalize:function(d) {
if (Mavo.is("group", d)) {
var e=Mavo.getAttribute(d, "typeof", "itemtype")||c.DEFAULT_TYPE;return d.setAttribute("typeof", e), e;
} return null;
}}});
})(Bliss, Bliss.$);
(function(a, b) {
var c=Mavo.Primitive=a.Class({extends:Mavo.Node, nodeType:"Primitive", constructor:function(d) {
this.fromTemplate("config", "attribute", "templateValue", "originalEditor")||(this.config=c.getConfig(d), this.attribute=this.config.attribute), this.datatype=this.config.datatype, "modes"in this.config&&(this.modes=this.config.modes, this.element.setAttribute("mv-mode", this.config.modes)), Mavo.hooks.run("primitive-init-start", this), this.expressionText=Mavo.DOMExpression.search(this.element, this.attribute), this.expressionText&&!this.expressionText.mavoNode&&(this.expressionText.primitive=this, this.storage=this.storage||"none", this.modes="read", this.element.setAttribute("aria-live", "polite")), !this.editor&&this.element.hasAttribute("mv-edit")&&(!this.originalEditor&&(this.originalEditor=a(this.element.getAttribute("mv-edit"))), this.originalEditor&&!this.template&&(this.originalEditorObserver=new Mavo.Observer(this.originalEditor, "all", () => {
var l=this.copies.concat(this);for (let m of l) {
m.editor&&(m.editor=this.originalEditor.cloneNode(!0)), m.setValue(m.value, {force:!0, silent:!0});
}
}))), this.editor||this.originalEditor||this.attribute||(this.editor=b(this.element.children).filter(function(k) {
return k.matches(Mavo.selectors.formControl)&&!k.matches(Mavo.selectors.property);
})[0], this.editor&&a.remove(this.editor));var h=this.editorValue;this.datatype||"number"!=typeof h&&"boolean"!=typeof h||(this.datatype=typeof h), this.config.init&&this.config.init.call(this, this.element), this.config.changeEvents&&a.events(this.element, this.config.changeEvents, k => {
k.target===this.element&&(this.value=this.getValue());
}), this.templateValue=this.getValue(), this._default=this.element.getAttribute("mv-default"), null===this.default?this._default=this.modes?this.templateValue:h:""===this.default?this._default=this.templateValue:this.defaultObserver=new Mavo.Observer(this.element, "mv-default", () => {
this.default=this.element.getAttribute("mv-default");
});var j=!this.template||this.template.templateValue!=this.templateValue||"edit"==this.modes;this.initialValue=void 0===this.default&&j?this.templateValue:this.default, this.initialValue===void 0&&(this.initialValue=this.emptyValue), this.setValue(this.initialValue, {silent:!0}), Mavo.setAttributeShy(this.element, "aria-label", this.label), this.attribute||Mavo.setAttributeShy(this.element, "mv-attribute", "none"), this.observer=new Mavo.Observer(this.element, this.attribute, () => {
(this.attribute||!this.editing)&&(this.value=this.getValue());
}), this.postInit(), Mavo.hooks.run("primitive-init-end", this);
}, get editorValue() {
var d=this.editor||this.originalEditor;if (d) {
if (d.matches(Mavo.selectors.formControl)) {
return c.getValue(d, {datatype:this.datatype});
} var f=a(Mavo.selectors.output+", "+Mavo.selectors.formControl, d);if (f) {
return c.getValue(f);
}
}
}, set editorValue(d) {
if (this.config.setEditorValue&&"boolean"!==this.datatype) {
return this.config.setEditorValue.call(this, d);
} if (this.editor) {
if (this.editor.matches(Mavo.selectors.formControl)) {
c.setValue(this.editor, d, {config:this.editorDefaults});
}
else {
var f=a(Mavo.selectors.output+", "+Mavo.selectors.formControl, this.editor);f&&c.setValue(f, d);
}
}
}, destroy:function() {
this.super.destroy.call(this), this.defaultObserver&&this.defaultObserver.destroy(), this.observer&&this.observer.destroy();
}, getData:function(d={}) {
var f={context:this, options:d, data:this.super.getData.call(this, d)};return void 0===f.data&&(f.data=this.value, ""===f.data&&(f.data=null)), f.options.live?(this.collection||d.forceObjects)&&(f.data=Mavo.objectify(f.data, {[Mavo.toNode]:this}), this.collection&&(f.data[this.property]=f.data, f.data=this.relativizeData(f.data))):!this.inPath.length&&(f.data=Mavo.subset(this.data, this.inPath, f.data)), Mavo.hooks.run("node-getdata-end", f), f.data;
}, sneak:function(d) {
return Mavo.Observer.sneak(this.observer, d);
}, save:function() {
this.savedValue=this.value, this.unsavedChanges=!1;
}, initEdit:function() {
if (!this.editor&&this.originalEditor&&(this.editor=this.originalEditor.cloneNode(!0)), !this.editor) {
var d=this.config.editor;d&&"boolean"!=this.datatype||(d=Mavo.Elements.defaultConfig[this.datatype||"string"].editor), this.editor=a.create("function"===a.type(d)?d.call(this):d), this.editorValue=this.value;
} if (a.events(this.editor, {"input change":() => {
this.value=this.editorValue;
}, focus:() => {
this.editor.select&&this.editor.select();
}, "mavo:datachange":h => {
"output"===h.property&&(h.stopPropagation(), a.fire(this.editor, "input"));
}}), !this.popup&&this.closestCollection&&this.editor.matches(Mavo.selectors.textInput)) {
var f=this.editor.matches("textarea");this.editor.addEventListener("keydown", h => {
if (13==h.keyCode&&this.closestCollection.editing&&(h.shiftKey||!f)) {
var j=this.getCousin(1);if (!j) {
if (this.bottomUp) {
return;
} var k=this.closestCollection.add();this.closestCollection.editItem(k, {immediately:!0});
}j=this.getCousin(1), j.edit({immediately:!0}).then(() => j.editor.focus()), f&&h.preventDefault();
}
});
}"placeholder"in this.editor&&(this.editor.placeholder="("+this.label+")");var g=/^mv-edit-/i;b(this.element.attributes).forEach(function(h) {
g.test(h.name)&&this.editor.setAttribute(h.name.replace(g, ""), h.value);
}, this), (this.attribute||this.config.popup)&&(this.popup=new Mavo.UI.Popup(this)), this.popup||this.editor.classList.add("mv-editor"), this.initEdit=null;
}, edit:function(d={}) {
return !1!==this.super.edit.call(this)&&(-1===this.element.tabIndex&&Mavo.revocably.setAttribute(this.element, "tabindex", "0"), this.modes||this.element.addEventListener("click.mavo:edit", f => f.preventDefault()), this.preEdit=Mavo.defer(f => {
if (d.immediately) {
return f();
} var g, h="click focus dragover dragenter".split(" ").map(j => j+".mavo:preedit").join(" ");a.events(this.element, h, f), this.attribute||a.events(this.element, {"mouseenter.mavo:preedit":() => {
clearTimeout(g), g=setTimeout(f, 150);
}, "mouseleave.mavo:preedit":() => {
clearTimeout(g);
}});
}).then(() => a.unbind(this.element, ".mavo:preedit")), this.config.edit?void this.config.edit.call(this):this.preEdit.then(() => {
this.initEdit&&this.initEdit(), this.popup&&(this.popup.prepare(), this.popup.show()), this.attribute||this.popup||(this.editor.parentNode!=this.element&&(this.editorValue=this.value, this.element.textContent="", this.element.appendChild(this.editor)), !this.collection&&(document.activeElement===this.element&&this.editor.focus(), Mavo.revocably.restoreAttribute(this.element, "tabindex")));
}));
}, done:function() {
return !1!==this.super.done.call(this)&&void("preEdit"in this&&a.unbind(this.element, ".mavo:preedit .mavo:edit"), this.sneak(() => {
return this.config.done?void this.config.done.call(this):void(this.popup?this.popup.close():!this.attribute&&this.editor&&(a.remove(this.editor), c.setValue(this.element, this.editorValue, {config:this.config, attribute:this.attribute, datatype:this.datatype, map:this.originalEditor||this.editor})));
}), !this.collection&&Mavo.revocably.restoreAttribute(this.element, "tabindex"));
}, clear:function() {
"read"!=this.modes&&(this.value=this.templateValue);
}, dataRender:function(d) {
if (d&&"object"==typeof d) {
if (Symbol.toPrimitive in d) {
d=d[Symbol.toPrimitive]();
}
else {
for (let f of [this.property, "value", ...Object.keys(d)]) {
if (f in d) {
d=d[f], this.inPath.push(f);break;
}
}
}
}d===void 0?!this.modes&&(this.value=this.closestCollection?this.default:this.templateValue):this.value=d;
}, find:function(d) {
if (this.property==d) {
return this;
}
}, getValue:function() {
return c.getValue(this.element, {config:this.config, attribute:this.attribute, datatype:this.datatype});
}, lazy:{label:function() {
return Mavo.Functions.readable(this.property);
}, emptyValue:function() {
switch (this.datatype) {
case "boolean":return !1;case "number":return 0;
} return "";
}, editorDefaults:function() {
return this.editor&&c.getConfig(this.editor);
}}, setValue:function(d, f={}) {
return this.sneak(() => {
return d=d||0===d||!1===d?d:"", this.datatype||"number"!=typeof d&&"boolean"!=typeof d||(this.datatype=typeof d), d=c.safeCast(d, this.datatype), d!=this._value||f.force?void(this.editor&&document.activeElement!=this.editor&&(this.editorValue=d), (!this.editing||this.popup||!this.editor)&&(this.config.setValue?this.config.setValue.call(this, this.element, d):!f.dataOnly&&c.setValue(this.element, d, {config:this.config, attribute:this.attribute, datatype:this.datatype, map:this.originalEditor||this.editor})), this.empty=!d&&0!==d, this._value=d, !f.silent&&(this.saved&&(this.unsavedChanges=this.mavo.unsavedChanges=!0), this.dataChanged("propertychange", {value:d}))):d;
}), d;
}, dataChanged:function(d="propertychange", f) {
return this.super.dataChanged.call(this, d, f);
}, live:{default:function(d) {
this.value==this._default&&(this.value=d);
}, value:function(d) {
return this.setValue(d);
}, datatype:function(d) {
d!==this._datatype&&("boolean"==d&&!this.attribute&&(this.attribute=Mavo.Elements.defaultConfig.boolean.attribute), a.toggleAttribute(this.element, "datatype", d, d&&"string"!==d));
}, empty:function(d) {
var f=d&&!this.modes&&!(this.attribute&&a(Mavo.selectors.property, this.element));this.element.classList.toggle("mv-empty", !!f);
}}, static:{all:new WeakMap, getValueAttribute:function(d, f=Mavo.Elements.search(d)) {
var g=d.getAttribute("mv-attribute")||f.attribute;return g&&"null"!==g&&"none"!==g||(g=null), g;
}, safeCast:function(d, f) {
var h=c.cast(d, f);return null===d||void 0===d?d:"boolean"==f?"false"===d||0===d||""===d?!1:"true"===d||0<d||d:"number"==f?/^[-+]?[0-9.e]+$/i.test(d+"")?h:d:h;
}, cast:function(d, f) {
return "number"===f?+d:"boolean"===f?!!d:"string"===f?d+"":d;
}, getValue:function(d, {config:f, attribute:g, datatype:h}={}) {
if (f||(f=c.getConfig(d, g)), g=f.attribute, h=f.datatype, f.getValue&&g==f.attribute) {
return f.getValue(d);
} var j;return j=g in d&&c.useProperty(d, g)?d[g]:g?d.getAttribute(g):d.getAttribute("content")||d.textContent||null, c.safeCast(j, h);
}, getConfig:function(d, f, g) {
void 0===f&&(f=d.getAttribute("mv-attribute")||void 0), ("null"==f||"none"==f)&&(f=null), g||(g=d.getAttribute("datatype")||void 0);var h=Mavo.Elements.search(d, f, g);return void 0===h.attribute&&(h.attribute=f||null), void 0===h.datatype&&(h.datatype=g), h;
}, setValue:function(d, f, g={}) {
if (1===d.nodeType&&(g.config||(g.config=c.getConfig(d, g.attribute)), g.attribute=void 0===g.attribute?g.config.attribute:g.attribute, g.datatype=void 0===g.datatype?g.config.datatype:g.datatype, g.config.setValue&&g.attribute==g.config.attribute)) {
return g.config.setValue(d, f);
} if (g.attribute) {
if (g.attribute in d&&c.useProperty(d, g.attribute)&&d[g.attribute]!==f) {
try {
d[g.attribute]=f;
}
catch (j) {}
}"boolean"==g.datatype?f!=d.hasAttribute(g.attribute)&&a.toggleAttribute(d, g.attribute, f, f):d.getAttribute(g.attribute)!=f&&d.setAttribute(g.attribute, f);
}
else {
var h=c.format(f, g);h===f?d.textContent=f:(d.textContent=h, d.setAttribute&&d.setAttribute("content", f));
}
}, useProperty:function(d, f) {
return !(-1<["href", "src"].indexOf(f))&&"http://www.w3.org/2000/svg"!=d.namespaceURI;
}, format:(d, f={}) => {
if (f.map&&/^select$/i.test(f.map.nodeName)) {
for (var h, g=0;h=f.map.options[g];g++) {
if (h.value==d) {
return h.textContent;
}
}
} return "number"===a.type(d)||"number"==f.datatype?c.formatNumber(d):Array.isArray(d)?d.map(c.format).join(", "):"object"===a.type(d)?Mavo.toJSON(d):d;
}, lazy:{formatNumber:() => {
var d=new Intl.NumberFormat(Mavo.locale, {maximumFractionDigits:2});return function(f) {
return f===Infinity||f===-Infinity?0>f?"-\u221E":"\u221E":d.format(f);
};
}}}});
})(Bliss, Bliss.$);
(function(a) {
Mavo.UI.Popup=a.Class({constructor:function(d) {
this.primitive=d, this.position=() => {
var g=this.primitive.element.getBoundingClientRect(), h=g.left, i=g.bottom;if (this.element.offsetHeight) {
var j=this.element.getBoundingClientRect();j.height+i>innerHeight&&(i=innerHeight-j.height-20);
}a.style(this.element, {top:`${i}px`, left:`${h}px`});
}, this.element=a.create("div", {className:"mv-popup", hidden:!0, contents:{tag:"fieldset", contents:[{tag:"legend", textContent:this.primitive.label+":"}, this.editor]}, events:{keyup:f => {
(13==f.keyCode||27==f.keyCode)&&(this.element.contains(document.activeElement)&&this.primitive.element.focus(), f.stopPropagation(), this.hide());
}, transitionend:this.position}}), this.editor.matches("select")&&(this.editor.size=Math.min(10, this.editor.children.length));
}, show:function() {
a.unbind([this.primitive.element, this.element], ".mavo:showpopup"), this.shown=!0, this.hideCallback=d => {
this.element.contains(d.target)||this.primitive.element.contains(d.target)||this.hide();
}, this.position(), document.body.appendChild(this.element), requestAnimationFrame(() => this.element.removeAttribute("hidden")), a.events(document, "focus click", this.hideCallback, !0), window.addEventListener("scroll", this.position);
}, hide:function() {
a.unbind(document, "focus click", this.hideCallback, !0), window.removeEventListener("scroll", this.position), this.element.setAttribute("hidden", ""), this.shown=!1, setTimeout(() => {
a.remove(this.element);
}, 1e3*parseFloat(getComputedStyle(this.element).transitionDuration)||400);
}, prepare:function() {
a.events(this.primitive.element, {"click.mavo:edit":() => {
this.show();
}, "keyup.mavo:edit":d => {
-1<[13, 113].indexOf(d.keyCode)&&(this.show(), this.editor.focus());
}});
}, close:function() {
this.hide(), a.unbind(this.primitive.element, ".mavo:edit .mavo:preedit .mavo:showpopup");
}, proxy:{editor:"primitive"}});
})(Bliss, Bliss.$);
(function(a) {
var c=Mavo.Elements={};Object.defineProperties(c, {register:{value:function(d, f) {
if ("object"==typeof arguments[0]) {
for (let k in arguments[0]) {
c.register(k, arguments[0][k]);
} return;
} if (f.extend) {
var g=c[f.extend];f=a.extend(a.extend({}, g, k => "selector"!=k), f);
} if (-1<d.indexOf("@")) {
var h=d.split("@");f.selector=f.selector||h[0]||"*", void 0===f.attribute&&(f.attribute=h[1]);
} if (f.selector=f.selector||d, f.id=d, Array.isArray(f.attribute)) {
for (var i of f.attribute) {
var j=a.extend({}, f);j.attribute=i, c[`${d}@${i}`]=j;
}
}
 else {
c[d]=f;
} return c;
}}, search:{value:function(d, f, g) {
var h=c.matches(d, f, g), i=h[h.length-1];if (i) {
return i;
} var j=a.extend({}, c.defaultConfig[g||"string"]);return j.attribute=void 0===f?j.attribute:f, j;
}}, matches:{value:function(d, f, g) {
var h=[];selectorloop:for (var i in c) {
var j=c[i], k=f===void 0&&j.default||f===j.attribute;if (k&&(void 0===g||"string"===g||g===j.datatype)) {
var l=j.selector||i;d.matches(l)&&(!j.test||j.test(d, f, g))&&h.push(j);
}
} return h;
}}, isSVG:{value:d => "http://www.w3.org/2000/svg"==d.namespaceURI}, defaultConfig:{value:{string:{editor:{tag:"input"}}, number:{editor:{tag:"input", type:"number"}}, boolean:{attribute:"content", editor:{tag:"input", type:"checkbox"}}}}}), c.register({"@hidden":{datatype:"boolean"}, "@y":{test:c.isSVG, datatype:"number"}, "@x":{default:!0, test:c.isSVG, datatype:"number"}, media:{default:!0, selector:"img, video, audio", attribute:"src", editor:function() {
var d=this.mavo.storage&&this.mavo.storage.upload?this.mavo.storage:this.uploadBackend, f=a.create("input", {type:"url", placeholder:"http://example.com/image.png", className:"mv-output", "aria-label":"URL to image"});if (d&&self.FileReader) {
var g, h=this.element.nodeName.toLowerCase();h="img"==h?"image":h;var i=this.element.getAttribute("mv-uploads")||h+"s", j=(l, m=l.name) => {
l&&0===l.type.indexOf(h+"/")&&this.mavo.upload(l, i+"/"+m).then(n => {
f.value=n;var q=0, r=Mavo.rr(() => {
return a.fetch(n+"?"+Date.now()).then(() => {
this.mavo.inProgress=!1, a.fire(f, "input");
}).catch(t => {
if (400<t.status&&10>q) {
return this.mavo.inProgress="Loading Image", q++, Mavo.timeout(2e3).then(r);
}
});
});
});
}, k={paste:l => {
var m=l.clipboardData.items[0];if ("file"==m.kind&&0===m.type.indexOf(h+"/")) {
var n=`pasted-${h}-${Date.now()}.${m.type.slice(6)}`;j(m.getAsFile(), n), l.preventDefault();
}
}, "drag dragstart dragend dragover dragenter dragleave drop":l => {
l.preventDefault(), l.stopPropagation();
}, "dragover dragenter":() => {
g.classList.add("mv-dragover"), this.element.classList.add("mv-dragover");
}, "dragleave dragend drop":() => {
g.classList.remove("mv-dragover"), this.element.classList.remove("mv-dragover");
}, drop:l => {
j(l.dataTransfer.files[0]);
}};return a.events(this.element, k), g=a.create({className:"mv-upload-popup", contents:[f, {tag:"input", type:"file", "aria-label":"Upload image", accept:h+"/*", events:{change:l => {
var m=l.target.files[0];m&&j(m);
}}}, {className:"mv-tip", innerHTML:"<strong>Tip:</strong> You can also drag & drop or paste!"}], events:k});
} return f;
}}, "video, audio":{attribute:["autoplay", "buffered", "loop"], datatype:"boolean"}, "a, link":{default:!0, attribute:"href"}, "input, select, button, textarea":{attribute:"disabled", datatype:"boolean"}, formControl:{selector:"select, input", default:!0, attribute:"value", modes:"edit", changeEvents:"input change", edit:() => {}, done:() => {}, init:function() {
this.editor=this.element;
}}, textarea:{extend:"formControl", attribute:null, getValue:d => d.value, setValue:(d, f) => d.value=f}, formNumber:{extend:"formControl", selector:"input[type=range], input[type=number]", datatype:"number"}, checkbox:{extend:"formControl", selector:"input[type=checkbox]", attribute:"checked", datatype:"boolean", changeEvents:"click"}, "input[type=radio]":{extend:"formControl", attribute:"checked", modes:"edit", getValue:d => {
if (d.form) {
return d.form[d.name].value;
} var f=a(`input[type=radio][name="${d.name}"]:checked`);return f&&f.value;
}, setValue:(d, f) => {
if (d.form) {
return void(d.form[d.name].value=f);
} var g=a(`input[type=radio][name="${d.name}"][value="${f}"]`);a.properties(g, {checked:!0});
}, init:function(d) {
this.mavo.element.addEventListener("change", f => {
f.target.name==d.name&&(this.value=this.getValue());
});
}}, counter:{extend:"formControl", selector:"button, .counter", attribute:"mv-clicked", datatype:"number", init:function(d) {
"mv-clicked"===this.attribute&&(d.setAttribute("mv-clicked", "0"), d.addEventListener("click", () => {
let g=+d.getAttribute("mv-clicked")||0;this.value=++g;
}));
}}, "meter, progress":{default:!0, attribute:"value", datatype:"number", edit:function() {
var d=+this.element.getAttribute("min")||0, f=+this.element.getAttribute("max")||1, g=f-d, h=+this.element.getAttribute("mv-edit-step")||(1<g?1:g/100);this.element.addEventListener("mousemove.mavo:edit", i => {
var j=this.element.getBoundingClientRect().left, k=Math.max(0, (i.clientX-j)/this.element.offsetWidth), l=d+g*k, m=l%h;l+=m>h/2?h-m:-m, l=Math.max(d, Math.min(l, f)), this.sneak(() => this.element.setAttribute("value", l));
}), this.element.addEventListener("mouseleave.mavo:edit", () => {
this.sneak(() => this.element.setAttribute("value", this.value));
}), this.element.addEventListener("click.mavo:edit", () => {
this.value=this.getValue();
}), this.element.addEventListener("keydown.mavo:edit", i => {
if (i.target==this.element&&(37==i.keyCode||39==i.keyCode)) {
var j=h*(39==i.keyCode?1:-1)*(i.shiftKey?10:1), k=this.value+j;k=Math.max(d, Math.min(k, f)), this.element.setAttribute("value", k), i.preventDefault();
}
});
}, done:function() {
a.unbind(this.element, ".mavo:edit");
}}, meta:{default:!0, attribute:"content"}, block:{default:!0, selector:"p, div, dt, dd, h1, h2, h3, h4, h5, h6, article, section, address", editor:function() {
var d=getComputedStyle(this.element).display, f=0===d.indexOf("inline")?"input":"textarea", g=a.create(f);if ("textarea"==f) {
var h=this.element.offsetWidth;h&&(g.width=h);
} return g;
}, setEditorValue:function(d) {
this.datatype&&"string"!=this.datatype&&(d+="");var f=getComputedStyle(this.element);return d=d||"", -1<["normal", "nowrap"].indexOf(f.whiteSpace)&&(d=d.replace(/\r?\n/g, " ")), -1<["normal", "nowrap", "pre-line"].indexOf(f.whiteSpace)&&(d=d.replace(/^[ \t]+|[ \t]+$/gm, "").replace(/[ \t]+/g, " ")), this.editor.value=d, !0;
}}, time:{attribute:"datetime", default:!0, init:function() {
if (!this.fromTemplate("dateType")) {
var d=Mavo.DOMExpression.search(this.element, null), f=this.element.getAttribute("datetime")||"YYYY-MM-DD";for (var g in this.config.dateTypes) {
if (this.config.dateTypes[g].test(f)) {
break;
}
} this.dateType=g, d||(this.element.textContent=this.config.defaultFormats[this.dateType](this.property), this.mavo.expressions.extract(this.element, null));
}
}, dateTypes:{date:/^[Y\d]{4}-[M\d]{2}-[D\d]{2}$/i, month:/^[Y\d]{4}-[M\d]{2}$/i, time:/^[H\d]{2}:[M\d]{2}/i, "datetime-local":/^[Y\d]{4}-[M\d]{2}-[D\d]{2} [H\d]{2}:[M\d]{2}/i}, defaultFormats:{date:d => `[day(${d})] [month(${d}).shortname] [year(${d})]`, month:d => `[month(${d}).name] [year(${d})]`, time:d => `[hour(${d}).twodigit]:[minute(${d}).twodigit]`, "datetime-local":d => `[day(${d})] [month(${d}).shortname] [year(${d})]`}, editor:function() {
return {tag:"input", type:this.dateType};
}}, "circle@r":{default:!0, datatype:"number"}, circle:{attribute:["cx", "cy"], datatype:"number"}, text:{default:!0, popup:!0}, "[role=checkbox]":{default:!0, attribute:"aria-checked", datatype:"boolean", edit:function() {
this.element.addEventListener("click.mavo:edit", d => {
this.value=!this.value, d.preventDefault();
});
}, done:function() {
a.unbind(this.element, ".mavo:edit");
}}});
})(Bliss, Bliss.$);
(function(d, e) {
Mavo.attributes.push("mv-multiple", "mv-order", "mv-accepts");var f=Mavo.Collection=d.Class({extends:Mavo.Node, nodeType:"Collection", constructor:function() {
this.templateElement=this.element, this.children=[], this.fromTemplate("mutable", "templateElement", "accepts")||(this.mutable=this.templateElement.matches(Mavo.selectors.multiple), this.accepts=(this.templateElement.getAttribute("mv-accepts")||"").split(/\s+/), this.templateElement=this.templateElement.cloneNode(!0));var l=this.createItem(this.element);this.add(l, void 0, {silent:!0}), this.itemTemplate=l.template||l, this.postInit(), Mavo.hooks.run("collection-init-end", this);
}, get length() {
return this.children.length;
}, getData:function(g={}) {
var h={context:this, options:g, data:[]};for (var k of this.children) {
if (!k.deleted||h.options.live) {
let m=k.getData(h.options);(h.options.live||null!==Mavo.value(m))&&h.data.push(m);
}
} if (!this.mutable) {
if (h.data=h.data.filter(m => null!==Mavo.value(m)), h.options.live&&1===h.data.length) {
h.data=h.data[0];
}
else if (this.data&&!h.options.live) {
var l=Mavo.subset(this.data, this.inPath);h.data=h.data.concat(l.slice(h.data.length));
}
} return h.options.live&&Array.isArray(h.data)&&(h.data[Mavo.toNode]=this, h.data=this.relativizeData(h.data)), Mavo.hooks.run("node-getdata-end", h), h.data;
}, createItem:function(g) {
g||(g=this.templateElement.cloneNode(!0));var h=Mavo.Node.create(g, this.mavo, {collection:this, template:this.itemTemplate||(this.template?this.template.itemTemplate:null), property:this.property, type:this.type});return h;
}, add:function(g, h, k={}) {
if (g=g instanceof Node?Mavo.Node.get(g)||this.createItem(g):g||this.createItem(), g.collection!=this&&this.adopt(g), this.mutable) {
var l=this.children[h]?this.children[h].element:this.marker;d[this.bottomUp?"after":"before"](g.element, l), void 0===h&&(h=this.bottomUp?0:this.length);
}
else {
h=this.length;
} var m={context:this, item:g};return m.previousIndex=g.index, m.changed=this.splice({remove:m.item}, {index:h, add:m.item}), m.item.itembar&&m.item.itembar.reposition(), this.mavo.expressions.active&&!k.silent&&requestAnimationFrame(() => {
m.changed.forEach(n => {
n.dataChanged(n==m.item&&void 0===m.previousIndex?"add":"move"), n.unsavedChanges=!0;
}), this.unsavedChanges=this.mavo.unsavedChanges=!0, this.mavo.expressions.update(m.item);
}), Mavo.hooks.run("collection-add-end", m), m.item;
}, splice:function(...g) {
for (let k of g) {
void 0===k.index&&k.remove&&isNaN(k.remove)&&(k.index=this.children.indexOf(k.remove), k.remove=1);
}g.sort((k, l) => l.index-k.index);for (let k of g) {
-1<k.index&&(k.remove||k.add)&&(k.remove=k.remove||0, k.add=Mavo.toArray(k.add), this.children.splice(k.index, +k.remove, ...k.add));
} var h=[];for (let l, k=0;k<this.length;k++) {
l=this.children[k], l&&l.index!==k&&(l.index=k, h.push(l));
} return h;
}, adopt:function(g) {
g.collection&&(g.collection.splice({remove:g}), g.collection.dataChanged("delete")), this.walk(h => {
h.closestCollection===g.collection&&(h.closestCollection=this), g.mavo!=this.mavo&&(g.mavo=this.mavo);
}), g.collection=this, g.template&&(Mavo.delete(g.template.copies, g), g.template=this.itemTemplate);
}, delete:function(g, h) {
return h?(d.remove(g.element), this.splice({remove:g}), void g.destroy()):d.transition(g.element, {opacity:0}).then(() => {
g.deleted=!0, g.element.style.opacity="", g.dataChanged("delete"), this.unsavedChanges=g.unsavedChanges=this.mavo.unsavedChanges=!0;
});
}, move:function(g, h) {
var k=g.index+h+(0<h);k=Mavo.wrap(k, this.children.length+1), this.add(g, k), g instanceof Mavo.Primitive&&g.itembar&&g.itembar.reposition();
}, editItem:function(g, h={}) {
var k=h.immediately?Promise.resolve():Mavo.inView.when(g.element);return k.then(() => {
return this.mutable&&(!g.itembar&&(g.itembar=new Mavo.UI.Itembar(g)), g.itembar.add()), g.edit(h);
});
}, edit:function(g={}) {
if (!1===this.super.edit.call(this)) {
return !1;
} if (this.mutable) {
if (!this.addButton.parentNode) {
var h=this.element.tagName.toLowerCase(), k=Mavo.selectors.container[h], l=k?this.marker.parentNode.closest(k):this.marker;d[this.bottomUp?"before":"after"](this.addButton, l);
}f.dragula.then(() => {
this.getDragula();
});
} return Promise.all(this.children.map(m => this.editItem(m, g)));
}, done:function() {
return !1!==this.super.done.call(this)&&void(this.mutable&&(this.addButton.parentNode&&this.addButton.remove(), this.propagate(g => {
g.itembar&&g.itembar.remove();
})));
}, clear:function() {
if ("read"!=this.modes) {
if (this.mutable) {
for (var h, g=1;h=this.children[g];g++) {
h.element.remove(), h.destroy();
} this.children=this.children.slice(0, 1), this.dataChanged("clear");
} this.propagate("clear");
}
}, dataChanged:function(g, h={}) {
return h.element=h.element||this.marker, this.super.dataChanged.call(this, g, h);
}, save:function() {
for (let g of this.children) {
g.deleted?this.delete(g, !0):g.unsavedChanges=!1;
}
}, propagated:["save"], dataRender:function(g) {
if (void 0!==g) {
if (g=null===g?[]:Mavo.toArray(g).filter(p => null!==p), !this.mutable) {
this.children.forEach((p, q) => p.render(g&&g[q]));
}
else {
for (var k, h=0;h<this.children.length;h++) {
k=this.children[h], h<g.length?k.render(g[h]):(k.dataChanged("delete"), this.delete(k, !0));
} if (g.length>h) {
for (var k, l=document.createDocumentFragment(), m=h;m<g.length;m++) {
k=this.createItem(), k.render(g[m]), this.children.push(k), k.index=m, l.appendChild(k.element);var n={context:this, item:k};Mavo.hooks.run("collection-add-end", n);
} this.bottomUp?d.after(l, 0<h?this.children[h-1].element:this.marker):d.before(l, this.marker);for (var m=h;m<this.children.length;m++) {
this.children[m].dataChanged("add"), this.mavo.expressions.active&&requestAnimationFrame(() => this.mavo.expressions.update(this.children[m]));
}
}
}
}
}, find:function(g, h={}) {
var k=this.children.filter(m => !m.deleted);if (this.property==g) {
return h.collections?this:k;
} if (this.properties.has(g)) {
var l=k.map(m => m.find(g, h));return Mavo.flatten(l);
}
}, isCompatible:function(g) {
return g&&this.itemTemplate.nodeType==g.itemTemplate.nodeType&&(g===this||g.template==this||this.template==g||this.template&&this.template==g.template||-1<this.accepts.indexOf(g.property));
}, live:{mutable:function(g) {
if (g&&g!==this.mutable) {
this._mutable=g, this.marker=document.createComment("mv-marker"), Mavo.data(this.marker, "collection", this);var h=this.templateElement.parentNode?this.templateElement:this.children[this.length-1].element;d.after(this.marker, h);
}
}}, getDragula:function() {
if (this.dragula) {
return this.dragula;
} if (this.template) {
return Mavo.pushUnique(this.template.getDragula().containers, this.marker.parentNode), this.dragula=this.template.dragula||this.template.getDragula();
} this;return this.dragula=dragula({containers:[this.marker.parentNode], isContainer:h => {
return !!this.accepts.length&&-1<Mavo.flatten(this.accepts.map(k => this.mavo.root.find(k, {collections:!0}))).filter(k => k&&k instanceof f).map(k => k.marker.parentNode).indexOf(h);
}, moves:(h, k, l) => {
return l.classList.contains("mv-drag-handle")&&l.closest(Mavo.selectors.multiple)==h;
}, accepts:function(h, k, l, m) {
if (h.contains(k)) {
return !1;
} var n=m?m.previousElementSibling:k.lastElementChild, p=f.get(n)||f.get(m);if (!p) {
return !1;
} var q=Mavo.Node.get(h);return q&&q.collection.isCompatible(p);
}}), this.dragula.on("drop", h => {
var m=Mavo.Node.get(h), n=m&&m.index, p=h.nextElementSibling, q=h.previousElementSibling, r=f.get(q)||f.get(p), s=Mavo.Node.get(q)||Mavo.Node.get(p);if (s&&s.collection!=r&&(s=null), m.collection.isCompatible(r)) {
var t=s?s.index+(s.element===q):r.length;r.add(m, t);
}
else {
return this.dragula.cancel(!0);
}
}), f.dragulas.push(this.dragula), this.dragula;
}, lazy:{bottomUp:function() {
if (!this.mutable) {
return !1;
} var g=this.templateElement.getAttribute("mv-order");return null===g?!!this.addButton.parentNode&&!!(this.addButton.compareDocumentPosition(this.marker)&Node.DOCUMENT_POSITION_FOLLOWING):/^desc\b/i.test(g);
}, closestCollection:function() {
var g=this.marker?this.marker.parentNode:this.templateElement.parentNode;return g.closest(Mavo.selectors.multiple);
}, addButton:function() {
var g=`button.mv-add-${this.property}`, h=this.closestCollection||this.marker.parentNode.closest(Mavo.selectors.group);if (h) {
var k=e(g, h).filter(l => {
return !this.templateElement.contains(l);
})[0];
} return k||(k=d.create("button", {className:"mv-add", textContent:this.mavo._("add-item", this)})), k.classList.add("mv-ui", "mv-add"), Mavo.data(k, "collection", this), this.property&&k.classList.add(`mv-add-${this.property}`), k.addEventListener("click", l => {
l.preventDefault(), this.editItem(this.add());
}), k;
}}, static:{dragulas:[], get:g => {
var h=Mavo.data(g, "collection");if (h) {
return h;
} var k=Mavo.Node.get(g);return k&&k.collection||null;
}, lazy:{dragula:() => d.include(self.dragula, "https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.min.js")}}});
})(Bliss, Bliss.$);
(function(a, b) {
Mavo.UI.Itembar=a.Class({constructor:function(d) {
if (this.item=d, this.element=b(`.mv-item-bar:not([mv-rel]), .mv-item-bar[mv-rel="${this.item.property}"]`, this.item.element).filter(g => {
return g.closest(Mavo.selectors.multiple)==this.item.element&&!Mavo.data(g, "item");
})[0], !this.element&&this.item.template&&this.item.template.itembar) {
this.element=this.item.template.itembar.element.cloneNode(!0), this.dragHandle=a(".mv-drag-handle", this.element)||this.item.element;
}
else {
this.element=this.element||a.create({className:"mv-item-bar mv-ui"});var e=[{tag:"button", title:this.mavo._("delete-item", this.item), className:"mv-delete"}, {tag:"button", title:this.mavo._(`add-item-${this.collection.bottomUp?"after":"before"}`, this.item), className:"mv-add"}];this.item instanceof Mavo.Group?(this.dragHandle=a.create({tag:"button", title:this.mavo._("drag-to-reorder", this.item), className:"mv-drag-handle"}), e.push(this.dragHandle)):this.dragHandle=this.item.element, a.set(this.element, {"mv-rel":this.item.property, contents:e});
}a.events(this.element, {mouseenter:() => {
this.item.element.classList.add("mv-highlight");
}, mouseleave:() => {
this.item.element.classList.remove("mv-highlight");
}}), this.dragHandle.addEventListener("keydown", g => {
g.target===this.dragHandle&&this.item.editing&&37<=g.keyCode&&40>=g.keyCode&&(this.collection.move(this.item, 38>=g.keyCode?-1:1), g.stopPropagation(), g.preventDefault(), g.target.focus());
});var f={add:this.buttonSelector("add"), delete:this.buttonSelector("delete"), drag:this.buttonSelector("drag")};this.element.addEventListener("click", g => {
if (this.item.collection.editing) {
if (g.target.matches(f.add)) {
var h=this.collection.add(null, this.item.index);return g[Mavo.superKey]&&h.render(this.item.getData()), Mavo.scrollIntoViewIfNeeded(h.element), this.collection.editItem(h);
}g.target.matches(f.delete)?this.item.collection.delete(d):g.target.matches(f["drag-handle"])&&(i => i.target.focus());
}
}), Mavo.data(this.element, "item", this.item);
}, add:function() {
this.element.parentNode||Mavo.revocably.add(this.element)||(this.item instanceof Mavo.Primitive&&!this.item.attribute?(this.element.classList.add("mv-adjacent"), a.after(this.element, this.item.element)):this.item.element.appendChild(this.element)), this.dragHandle==this.item.element&&this.item.element.classList.add("mv-drag-handle");
}, remove:function() {
Mavo.revocably.remove(this.element), this.dragHandle==this.item.element&&this.item.element.classList.remove("mv-drag-handle");
}, reposition:function() {
this.item instanceof Mavo.Primitive&&(this.element.remove(), this.add());
}, buttonSelector:function(d) {
return `.mv-${d}[mv-rel="${this.item.property}"], [mv-rel="${this.item.property}"] > .mv-${d}`;
}, proxy:{collection:"item", mavo:"item"}});
})(Bliss, Bliss.$);
(function(a) {
Mavo.attributes.push("mv-expressions");var b=Mavo.Expression=a.Class({constructor:function(c) {
this.expression=c;
}, eval:function(c) {
this.oldValue=this.value, Mavo.hooks.run("expression-eval-beforeeval", this);try {
this.function||(this.function=Mavo.Script.compile(this.expression), this.identifiers=this.expression.match(/[$a-z][$\w]*/ig)||[]), this.value=this.function(c);
}
catch (d) {
console.info("%cExpression error!", "color: red; font-weight: bold", `${d.message} in expression ${this.expression}`, `
Not an expression? Use mv-expressions="none" to disable expressions on an element and its descendants.`), Mavo.hooks.run("expression-eval-error", {context:this, exception:d}), this.value=d;
} return this.value;
}, toString() {
return this.expression;
}, changedBy:function(c) {
if (!c) {
return !0;
} if (!this.identifiers) {
return !1;
} if (-1<this.identifiers.indexOf(c.property)) {
return !0;
} if (Mavo.Functions.intersects(c.properties, this.identifiers)) {
return !0;
} if ("propertychange"!=c.action) {
if (Mavo.Functions.intersects(["$index", "$previous", "$next"], this.identifiers)) {
return !0;
} var d=c.node.collection||c.node;if (Mavo.Functions.intersects(d.properties, this.identifiers)) {
return !0;
}
} return !1;
}, live:{expression:function() {
this.function=null;
}}, static:{}});b.Syntax=a.Class({constructor:function(c, d) {
this.start=c, this.end=d, this.regex=RegExp(`${Mavo.escapeRegExp(c)}([\\S\\s]+?)${Mavo.escapeRegExp(d)}`, "gi");
}, test:function(c) {
return this.regex.lastIndex=0, this.regex.test(c);
}, tokenize:function(c) {
var d, e=[], f=0;for (this.regex.lastIndex=0;null!==(d=this.regex.exec(c));) {
d.index>f&&e.push(c.substring(f, d.index)), f=this.regex.lastIndex, e.push(new Mavo.Expression(d[1]));
} return f<c.length&&e.push(c.substring(f)), e;
}, static:{create:function(c) {
if (c) {
var d=c.getAttribute("mv-expressions");if (d) {
return d=d.trim(), /\s/.test(d)?new b.Syntax(...d.split(/\s+/)):b.Syntax.ESCAPE;
}
}
}, ESCAPE:-1}}), b.Syntax.default=new b.Syntax("[", "]");
})(Bliss);
(function(a) {
var b=Mavo.DOMExpression=a.Class({constructor:function(c={}) {
this.mavo=c.mavo, this.template=c.template&&c.template.template||c.template;for (let e of ["item", "path", "syntax", "fallback", "attribute", "originalAttribute", "expression", "parsed"]) {
this[e]=void 0===c[e]&&this.template?this.template[e]:c[e];
} if (this.node=c.node, this.node||(this.node=Mavo.elementPath(this.item.element, this.path)), this.element=this.node, this.attribute=this.attribute||null, Mavo.hooks.run("domexpression-init-start", this), 3===this.node.nodeType&&this.element===this.node&&(this.element=this.node.parentNode, (!this.node.parentNode.children.length||this.attribute)&&(this.node=this.element, this.element.normalize())), !this.expression) {
if (this.attribute) {
this.expression=this.node.getAttribute(this.attribute).trim();
}
else {
if (this.node.normalize(), this.node.firstChild&&1===this.node.childNodes.length&&3===this.node.firstChild.nodeType) {
var d=this.node.firstChild.textContent.match(/^\s*|\s*$/g);d[1]&&(this.node.firstChild.splitText(this.node.firstChild.textContent.length-d[1].length), a.after(this.node.lastChild, this.node)), d[0]&&(this.node.firstChild.splitText(d[0].length), this.node.parentNode.insertBefore(this.node.firstChild, this.node));
} this.expression=this.node.textContent;
} this.parsed=c.template?c.template.parsed:this.syntax.tokenize(this.expression);
} this.oldValue=this.value=this.parsed.map(e => e instanceof Mavo.Expression?e.expression:e), this.item=Mavo.Node.get(this.element.closest(Mavo.selectors.item)), this.mavo.treeBuilt.then(() => {
this.template||this.item||(this.item=Mavo.Node.get(this.element.closest(Mavo.selectors.item))), Mavo.hooks.run("domexpression-init-treebuilt", this);
}), Mavo.hooks.run("domexpression-init-end", this), b.elements.set(this.element, [...(b.elements.get(this.element)||[]), this]);
}, changedBy:function(c) {
return !this.parsed.every(d => !(d instanceof Mavo.Expression)||!d.changedBy(c));
}, update:function(c=this.data, d) {
var e={context:this, event:d}, f=e;this.data=c, Mavo.hooks.run("domexpression-update-start", e), this.oldValue=this.value;var g=!1;e.value=this.value=this.parsed.map((h, j) => {
if (h instanceof Mavo.Expression) {
if (h.changedBy(f.event)) {
var k={context:this, expr:h, parentEnv:f};return Mavo.hooks.run("domexpression-update-beforeeval", k), k.value=Mavo.value(k.expr.eval(c)), Mavo.hooks.run("domexpression-update-aftereval", k), g=!0, k.value instanceof Error?void 0===this.fallback?this.syntax.start+k.expr.expression+this.syntax.end:this.fallback:void 0===k.value||null===k.value?"":k.value;
} return this.oldValue[j];
} return h;
});g&&(e.value=1===e.value.length?e.value[0]:e.value.map(Mavo.Primitive.format).join(""), this.output(e.value), Mavo.hooks.run("domexpression-update-end", e));
}, output:function(c) {
this.primitive?this.primitive.value=c:Mavo.Primitive.setValue(this.node, c, {attribute:this.attribute});
}, live:{item:function(c) {
c&&this._item!=c&&(this._item&&Mavo.delete(this._item.expressions, this), c.expressions=c.expressions||[], c.expressions.push(this));
}}, static:{elements:new WeakMap, search:function(c, d) {
var e=b.elements.get(c)||[];return 1<arguments.length?e.length?e.filter(f => f.attribute===d)[0]||null:null:e;
}}});
})(Bliss);
(function(a, b) {
var c=Mavo.Expressions=a.Class({constructor:function(d) {
this.mavo=d, this.active=!0, this.expressions=[];var e=Mavo.Expression.Syntax.create(this.mavo.element.closest("[mv-expressions]"))||Mavo.Expression.Syntax.default;this.traverse(this.mavo.element, void 0, e), this.scheduled={}, this.mavo.treeBuilt.then(() => {
this.expressions=[], document.documentElement.addEventListener("mavo:datachange", f => {
if (this.active) {
var g=this.scheduled[f.action]=this.scheduled[f.action]||new Set;f.node.template?!g.has(f.node.template)&&(setTimeout(() => {
g.delete(f.node.template), this.update(f);
}, c.THROTTLE), g.add(f.node.template)):requestAnimationFrame(() => this.update(f));
}
}), this.update();
});
}, update:function(d) {
if (this.active) {
var e, f;d instanceof Mavo.Node?(f=d, d=null):d instanceof Element?(e=d.closest(Mavo.selectors.item), f=Mavo.Node.get(e), d=null):f=this.mavo.root;var g=f.getData({live:!0});f.walk((h, j) => {
if (h.expressions&&h.expressions.length&&!h.isDeleted()) {
var k=a.value(g, ...j);for (let l of h.expressions) {
l.changedBy(d)&&l.update(k, d);
}
}
});
}
}, extract:function(d, e, f, g=Mavo.Expression.Syntax.default) {
e&&"mv-expressions"==e.name||(f=void 0===f?Mavo.elementPath(d.closest(Mavo.selectors.item), d):f&&"string"==typeof f?f.slice(1).split("/").map(h => +h):[], (e&&-1<c.directives.indexOf(e.name)||g.test(e?e.value:d.textContent))&&this.expressions.push(new Mavo.DOMExpression({node:d, syntax:g, path:f, attribute:e&&e.name, mavo:this.mavo})));
}, traverse:function(d, e="", f) {
if (8!==d.nodeType) {
if (3===d.nodeType) {
this.extract(d, null, e, f);
}
else {
if (d.normalize(), f=Mavo.Expression.Syntax.create(d)||f, f===Mavo.Expression.Syntax.ESCAPE) {
return;
}Mavo.is("item", d)&&(e=""), b(d.attributes).forEach(h => this.extract(d, h, e, f));var g=0;b(d.childNodes).forEach(h => {
(1==h.nodeType||3==h.nodeType)&&(this.traverse(h, `${e}/${g}`, f), g++);
});
}
}
}, static:{directives:[], THROTTLE:50, directive:function(d, e) {
c.directives.push(d), Mavo.attributes.push(d), Mavo.Plugins.register(d, e);
}}});
})(Bliss, Bliss.$);
(function(a, b) {
Mavo.Expressions.directive("mv-if", {extend:{Primitive:{live:{hidden:function(c) {
this._hidden!==c&&(this._hidden=c, this.dataChanged());
}}}, DOMExpression:{lazy:{childProperties:function() {
var c=b(Mavo.selectors.property, this.element).filter(d => d.closest("[mv-if]")==this.element).map(d => Mavo.Node.get(d));return this.element.addEventListener("mavo:datachange", d => {
requestAnimationFrame(() => {
this.element.parentNode||this.item.element.dispatchEvent(d);
});
}), c;
}}}}, hooks:{"domexpression-init-start":function() {
"mv-if"!=this.attribute||(this.expression=this.element.getAttribute("mv-if"), this.parsed=[new Mavo.Expression(this.expression)], this.expression=this.syntax.start+this.expression+this.syntax.end, this.parentIf=this.element.parentNode&&Mavo.DOMExpression.search(this.element.parentNode.closest("[mv-if]"), "mv-if"), this.parentIf&&(this.parentIf.childIfs=(this.parentIf.childIfs||new Set).add(this)));
}, "domexpression-update-end":function() {
if ("mv-if"==this.attribute) {
var c=this.value[0], d=this.oldValue[0];this.item.mavo.treeBuilt.then(() => {
if (this.parentIf) {
var e=this.parentIf.value[0];this.value[0]=c=c&&e;
} if (c!==d) {
if (!1!==e&&(c?Mavo.revocably.add(this.element):this.element.parentNode&&Mavo.revocably.remove(this.element, "mv-if")), this.childProperties) {
for (let f of this.childProperties) {
f.hidden=!c;
}
} if (this.childIfs) {
for (let f of this.childIfs) {
f.update();
}
}
}
});
}
}, "unit-isdatanull":function(c) {
c.result=c.result||this.hidden&&c.options.live;
}}});
})(Bliss, Bliss.$);
Mavo.Expressions.directive("mv-value", {hooks:{"node-init-start":function() {
if (this instanceof Mavo.Group||this.collection) {
var a=Mavo.DOMExpression.search(this.element).filter(b => "mv-value"==b.originalAttribute)[0];a&&(a.mavoNode=this, this.expressionText=a, this.storage=this.storage||"none", this.modes="read", this.collection&&(this.collection.expressions=[...(this.collection.expressions||[]), a], a.mavoNode=this.collection, this.collection.storage=this.collection.storage||"none", this.collection.modes="read"));
}
}, "domexpression-init-start":function() {
if ("mv-value"==this.attribute) {
this.originalAttribute="mv-value", this.attribute=Mavo.Primitive.getValueAttribute(this.element), this.fallback=this.fallback||Mavo.Primitive.getValue(this.element, {attribute:this.attribute}), this.expression=this.element.getAttribute("mv-value"), this.element.removeAttribute("mv-value"), this.parsed=[new Mavo.Expression(this.expression)], this.expression=this.syntax.start+this.expression+this.syntax.end;var a=Mavo.Expression.prototype.changedBy;this.parsed[0].changedBy=function(b) {
var c=a.call(this, b);return !c&&b&&"propertychange"==b.action&&(c=Mavo.Functions.intersects(this.identifiers, b.node.path)), c;
};
}
}, "domexpression-init-treebuilt":function() {
"mv-value"==this.originalAttribute&&this.mavoNode&&(this.mavoNode==this.item||this.mavoNode==this.item.collection)&&(this.mavoNode==this.item.collection&&Mavo.delete(this.item.expressions, this), this.output=function(a) {
a=a.value||a, this.mavoNode.render(a);
}, this.changedBy=a => !(a&&(a.node===this.mavoNode||a.node.collection===this.mavoNode)));
}}});
(function(b, f) {
function g(s="") {
return s=f(s), s||0===s?s+"":"";
} function h(s) {
return s=Mavo.value(s), null===s||!1===s||""===s;
} function j(s) {
return !f(s);
} function k(s, t) {
var u=s.toLocaleString(Mavo.locale, t);return u=u.replace(/\u200e/g, ""), u;
} function l(s) {
return function(t) {
if (t=o.date(t), !t) {
return "";
} var u=r[s](t);return u=new self["year"==s?"String":"Number"](u), ("month"==s||"weekday"==s)&&(u.name=k(t, {[s]:"long"}), u.shortname=k(t, {[s]:"short"})), "weekday"!=s&&(u.twodigit=(10>u?"0":"")+(1>u?"0":"")+u%100), u;
};
} var m=Mavo.Functions={operators:{"=":"eq"}, get:function(s, t) {
t=f(t);var u=Mavo.getCanonicalProperty(s, t);if (u!==void 0) {
var w=s[u];return "function"==typeof w&&0!==w.name.indexOf("bound")?w.bind(s):w;
} if (Array.isArray(s)&&isNaN(t)) {
for (var x of s) {
if (x&&"object"==typeof x) {
break;
}
} if (x) {
if ("id"in x) {
for (var y=0;y<s.length;y++) {
if (s[y]&&s[y].id==t) {
return s[y];
}
}
} return s.map(z => m.get(z, t));
}
} return null;
}, first:s => s&&s[0]||"", last:s => s&&s[s.length-1]||"", unique:function(s) {
return Array.isArray(s)?[...new Set(s.map(f))]:s;
}, intersects:function(s, t) {
if (s&&t) {
var u=new Set(t.map?t.map(f):t);return s=s.map?s.map(f):[...s], !s.every(w => !u.has(w));
}
}, sum:function(s) {
return o.numbers(s, arguments).reduce((t, u) => {
return +t+(+u||0);
}, 0);
}, average:function(s) {
return s=o.numbers(s, arguments), s.length&&m.sum(s)/s.length;
}, min:function(s) {
return Math.min(...o.numbers(s, arguments));
}, max:function(s) {
return Math.max(...o.numbers(s, arguments));
}, count:function(s) {
return Mavo.toArray(s).filter(t => !h(t)).length;
}, round:function(s, t) {
return j(s)||j(t)||!isFinite(s)?Math.round(s):+s.toLocaleString("en-US", {useGrouping:!1, maximumFractionDigits:t});
}, th:function(s) {
if (h(s)) {
return "";
} if (10>t||20<t) {
var t=["th", "st", "nd", "th"][s%10];
} return t=t||"th", s+t;
}, iff:function(s, t, u="") {
return Array.isArray(s)?s.map((w, x) => {
var y=f(w)?t:u;return Array.isArray(y)?y[Math.min(x, y.length-1)]:y;
}):f(s)?t:u;
}, replace:function(s, t, u="", w=1) {
if (Array.isArray(s)) {
return s.map(B => m.replace(B, t, u));
} for (var z, x=RegExp(Mavo.escapeRegExp(t), "g"), y=s, A=0;y!=z&&A++<w;) {
z=y, y=y.replace(x, u);
} return y;
}, len:s => g(s).length, search:(s, t) => s&&t?g(s).toLowerCase().indexOf((t+"").toLowerCase()):-1, starts:(s, t) => 0===m.search(g(s), g(t)), ends:function(s, t) {
[s, t]=[g(s), g(t)];var u=m.search(s, t);return -1<u&&u===s.length-t.length;
}, join:function(s, t) {
return Mavo.toArray(s).join(g(t));
}, idify:function(s) {
return g(s).replace(/\s+/g, "-").replace(/[^\w-]/g, "").toLowerCase();
}, readable:function(s) {
return g(s).replace(/([a-z])([A-Z])(?=[a-z])/g, (t, u, w) => u+" "+w.toLowerCase()).replace(/([a-z0-9])[_\/-](?=[a-z0-9])/g, "$1 ").replace(/^[a-z]/, t => t.toUpperCase());
}, uppercase:s => g(s).toUpperCase(), lowercase:s => g(s).toLowerCase(), from:(s, t) => m.between(s, t), fromlast:(s, t) => m.between(s, t, "", !0), to:(s, t) => m.between(s, "", t), tofirst:(s, t) => m.between(s, "", t, !0), between:(s, t, u, w) => {
[s, u, u]=[g(s), g(t), g(u)];var x=t?s[w?"lastIndexOf":"indexOf"](t):-1, y=s[w?"indexOf":"lastIndexOf"](u);return s.slice(x+1, -1!==y&&u?y:s.length);
}, filename:s => Mavo.match(new URL(g(s), Mavo.base).pathname, /[^/]+?$/), json:s => Mavo.safeToJSON(s), get $now() {
return new Date;
}, get $today() {
return m.date(new Date);
}, year:l("year"), month:l("month"), day:l("day"), weekday:l("weekday"), hour:l("hour"), minute:l("minute"), second:l("second"), date:s => {
return `${m.year(s)}-${m.month(s).twodigit}-${m.day(s).twodigit}`;
}, time:s => {
return `${m.hour(s).twodigit}:${m.minute(s).twodigit}:${m.second(s).twodigit}`;
}, minutes:s => Math.floor(Math.abs(s)/60), hours:s => Math.floor(Math.abs(s)/3600), days:s => Math.floor(Math.abs(s)/86400), weeks:s => Math.floor(Math.abs(s)/604800), months:s => Math.floor(Math.abs(s)/(86400*30.4368)), years:s => Math.floor(Math.abs(s)/(12*(86400*30.4368))), localTimezone:-new Date().getTimezoneOffset(), log:(...s) => {
return console.log(...s), s[0];
}, util:{numbers:function(s, t) {
return s=Array.isArray(s)?s:t?$$(t):[s], s.filter(u => !isNaN(u)&&""!==f(u)).map(u => +u);
}, date:function(s) {
if (s=f(s), !s) {
return null;
} if ("string"===b.type(s)) {
s=s.trim(), /^\d{4}-\d{2}-\d{2}/.test(s)||(s=m.$today+" "+s), -1===s.indexOf(":")?s+="T00:00:00":s=s.replace(/\-(\d{2})\s+(?=\d{2}:)/, "-$1T"), s=s.replace(/\s+/g, "");var t=Mavo.match(s, /[+-]\d{2}:?\d{2}|Z$/);if (t) {
s=new Date(s);
}
else {
var u=s.match(/\d+/g);s=new Date(u[0], (u[1]||1)-1, u[2]||1, u[3]||0, u[4]||0, u[5]||0, u[6]||0);
}
}
else {
s=new Date(s);
} return isNaN(s)?null:s;
}}}, o=m.util;b.lazy(m, "$url", function() {
var s={}, t=new URL(location);for (let u of t.searchParams) {
s[u[0]]=u[1];
} return Object.defineProperties(s, {path:{value:t.pathname.split("/").filter(u => !!u)}, toString:{value:() => new URL(location)}}), s;
});var p={average:"avg", iff:"iff IF", subtract:"minus", multiply:"mult product", divide:"div", lt:"lessThan smaller", gt:"moreThan greater greaterThan bigger", eq:"equal equality", th:"ordinal"};for (let s in p) {
p[s].split(/\s+/g).forEach(t => m[t]=m[s]);
}m._Trap=self.Proxy?new Proxy(m, {get:(s, t) => {
var u, w=Mavo.getCanonicalProperty(s, t)||Mavo.getCanonicalProperty(Math, t);return w&&(u=s[w]||Math[w]), u?(u.toString=() => t, u):t in self?self[t]:t;
}, has:(s, t) => "data"!=t}):m;var q=new Intl.NumberFormat("en", {minimumIntegerDigits:"2"});q=q.format.bind(q);var r={year:s => s.getFullYear(), month:s => s.getMonth()+1, day:s => s.getDate(), weekday:s => s.getDay()||7, hour:s => s.getHours(), minute:s => s.getMinutes(), second:s => s.getSeconds()};
})(Bliss, Mavo.value);
(function(c, d, f) {
var g=Mavo.Script={addUnaryOperator:function(h, j) {
if (j.symbol) {
for (let k of Mavo.toArray(j.symbol)) {
Mavo.Script.symbols[k]=h;
}
} return Mavo.Functions[h]=k => Array.isArray(k)?k.map(d).map(j.scalar):j.scalar(d(k));
}, addBinaryOperator:function(h, j) {
if (j.symbol) {
for (let k of Mavo.toArray(j.symbol)) {
Mavo.Script.symbols[k]=h;
}
} return j.identity=void 0===j.identity?0:j.identity, Mavo.Functions[h]=j.code||function(...k) {
1===k.length&&Array.isArray(k[0])&&(k=[...k[0]]), j.raw||(k=k.map(d));var m, l=j.logical?j.identity:k[0];for (let q=1;q<k.length;q++) {
let s=j.logical?k[q-1]:l, t=k[q];Array.isArray(t)?("number"==typeof j.identity&&(t=f.numbers(t)), m=Array.isArray(s)?[...t.map((u, v) => j.scalar(void 0===s[v]?j.identity:s[v], u)), ...s.slice(t.length)]:t.map(u => j.scalar(s, u))):Array.isArray(s)?m=s.map(u => j.scalar(u, t)):m=j.scalar(s, t), l=j.reduce?j.reduce(l, m, s, t):j.logical?l&&m:m;
} return l;
};
}, symbols:{}, getOperatorName:h => Mavo.Script.symbols[h]||h, operators:{not:{symbol:"!", scalar:h => !h}, multiply:{scalar:(h, j) => h*j, identity:1, symbol:"*"}, divide:{scalar:(h, j) => h/j, identity:1, symbol:"/"}, add:{scalar:(h, j) => +h+ +j, symbol:"+"}, subtract:{scalar:(h, j) => {
if (isNaN(h)||isNaN(j)) {
var k=f.date(h), l=f.date(j);if (k&&l) {
return (k-l)/1e3;
}
} return h-j;
}, symbol:"-"}, mod:{scalar:(h, j) => {
var k=h%j;return k+=0>k?j:0, k;
}}, lte:{logical:!0, scalar:(h, j) => {
return [h, j]=Mavo.Script.getNumericalOperands(h, j), h<=j;
}, identity:!0, symbol:"<="}, lt:{logical:!0, scalar:(h, j) => {
return [h, j]=Mavo.Script.getNumericalOperands(h, j), h<j;
}, identity:!0, symbol:"<"}, gte:{logical:!0, scalar:(h, j) => {
return [h, j]=Mavo.Script.getNumericalOperands(h, j), h>=j;
}, identity:!0, symbol:">="}, gt:{logical:!0, scalar:(h, j) => {
return [h, j]=Mavo.Script.getNumericalOperands(h, j), h>j;
}, identity:!0, symbol:">"}, eq:{logical:!0, scalar:(h, j) => h==j, symbol:["=", "=="], identity:!0}, neq:{logical:!0, scalar:(h, j) => h!=j, symbol:["!="], identity:!0}, and:{logical:!0, scalar:(h, j) => !!h&&!!j, identity:!0, symbol:"&&"}, or:{logical:!0, scalar:(h, j) => h||j, reduce:(h, j) => h||j, identity:!1, symbol:"||"}, concatenate:{symbol:"&", identity:"", scalar:(h, j) => ""+(h||"")+(j||"")}, filter:{scalar:(h, j) => d(j)?h:null, raw:!0}}, getNumericalOperands:function(h, j) {
if (isNaN(h)||isNaN(j)) {
var k=f.date(h), l=f.date(j);if (k&&l) {
return [k, l];
}
} return [h, j];
}, serializers:{BinaryExpression:h => `${g.serialize(h.left)} ${h.operator} ${g.serialize(h.right)}`, UnaryExpression:h => `${h.operator}${g.serialize(h.argument)}`, CallExpression:h => `${g.serialize(h.callee)}(${h.arguments.map(g.serialize).join(", ")})`, ConditionalExpression:h => `${g.serialize(h.test)}? ${g.serialize(h.consequent)} : ${g.serialize(h.alternate)}`, MemberExpression:h => {
var j=h.computed?g.serialize(h.property):`"${h.property.name}"`;return `get(${g.serialize(h.object)}, ${j})`;
}, ArrayExpression:h => `[${h.elements.map(g.serialize).join(", ")}]`, Literal:h => h.raw, Identifier:h => h.name, ThisExpression:() => "this", Compound:h => h.body.map(g.serialize).join(" ")}, transformations:{BinaryExpression:h => {
let j=Mavo.Script.getOperatorName(h.operator);var k=h, l=[];do {
l.unshift(k.right), k=k.left;
} while (Mavo.Script.getOperatorName(k.operator)===j);if (l.unshift(k), 1<l.length) {
return `${j}(${l.map(g.serialize).join(", ")})`;
}
}, UnaryExpression:h => {
var j=Mavo.Script.getOperatorName(h.operator);if (j) {
return `${j}(${g.serialize(h.argument)})`;
}
}, CallExpression:h => {
"Identifier"==h.callee.type&&("if"==h.callee.name&&(h.callee.name="iff"), h.callee.name="Mavo.Functions._Trap."+h.callee.name);
}}, serialize:h => {
var j=g.transformations[h.type]&&g.transformations[h.type](h);return void 0===j?g.serializers[h.type](h):j;
}, rewrite:function(h) {
try {
return g.serialize(g.parse(h));
}
catch (j) {
return h;
}
}, compile:function(h) {
return h=g.rewrite(h), new Function("data", `with(Mavo.Functions._Trap)
				with (data || {}) {
					return ${h};
				}`);
}, parse:self.jsep};for (let h in self.jsep&&(jsep.addBinaryOp("and", 2), jsep.addBinaryOp("or", 2), jsep.addBinaryOp("=", 6), jsep.addBinaryOp("mod", 10), jsep.removeBinaryOp("===")), g.serializers.LogicalExpression=g.serializers.BinaryExpression, g.transformations.LogicalExpression=g.transformations.BinaryExpression, Mavo.Script.operators) {
let j=Mavo.Script.operators[h];2>j.scalar.length?Mavo.Script.addUnaryOperator(h, j):Mavo.Script.addBinaryOperator(h, j);
}
})(Bliss, Mavo.value, Mavo.Functions.util);
(function(a) {
var b=Mavo.Backend.register(a.Class({extends:Mavo.Backend, id:"Dropbox", constructor:function() {
this.permissions.on(["login", "read"]), this.key=this.mavo.element.getAttribute("mv-dropbox-key")||"2mx6061p054bpbp", this.url=b.fixShareURL(this.url), this.login(!0);
}, upload:function(c, d) {
return d=this.path.replace(/[^/]+$/, "")+d, this.put(c, d).then(() => this.getURL(d));
}, getURL:function(c) {
return this.request("sharing/create_shared_link_with_settings", {path:c}, "POST").then(d => b.fixShareURL(d.url));
}, put:function(c, d=this.path, e={}) {
return this.request("https://content.dropboxapi.com/2/files/upload", c, "POST", {headers:{"Dropbox-API-Arg":JSON.stringify({path:d, mode:"overwrite"}), "Content-Type":"application/octet-stream"}});
}, oAuthParams:() => `&redirect_uri=${encodeURIComponent("https://auth.mavo.io")}&response_type=code`, getUser:function() {
return this.user?Promise.resolve(this.user):this.request("users/get_current_account", "null", "POST").then(c => {
this.user={username:c.email, name:c.name.display_name, avatar:c.profile_photo_url, info:c};
});
}, login:function(c) {
return this.oAuthenticate(c).then(() => this.getUser()).then(() => {
this.user&&(this.permissions.logout=!0, this.request("sharing/get_shared_link_metadata", {url:this.source}, "POST").then(e => {
this.path=e.path_lower, this.permissions.on(["edit", "save"]);
}));
});
}, logout:function() {
return this.oAuthLogout();
}, static:{apiDomain:"https://api.dropboxapi.com/2/", oAuth:"https://www.dropbox.com/oauth2/authorize", test:function(c) {
return c=new URL(c, Mavo.base), /dropbox.com/.test(c.host);
}, fixShareURL:c => {
return c=new URL(c, Mavo.base), c.hostname="dl.dropboxusercontent.com", c.search=c.search.replace(/\bdl=0|^$/, "raw=1"), c;
}}}));
})(Bliss);
(function(a) {
var b=Mavo.Backend.register(a.Class({extends:Mavo.Backend, id:"Github", constructor:function() {
this.permissions.on(["login", "read"]), this.key=this.mavo.element.getAttribute("mv-github-key")||"7e08e016048000bc594e";var c=b.parseURL(this.url);if (c.username) {
if (a.extend(this, c), this.repo=this.repo||"mv-data", this.path=this.path||"", !/\.\w+$/.test(this.path)) {
var d=this.format.constructor.extensions[0]||".json";this.path+=`/${this.mavo.id}${d}`;
} this.path=this.path.replace(/\/\/|^\/|\/$/g, ""), this.apiCall=`repos/${this.username}/${this.repo}/contents/${this.path}`;
}
else {
this.apiCall=this.url.pathname.slice(1);
} this.login(!0);
}, get:function() {
if (this.isAuthenticated()||!this.path) {
return this.request(this.apiCall).then(d => Promise.resolve(this.repo?b.atob(d.content):d));
} var c=new URL(`https://raw.githubusercontent.com/${this.username}/${this.repo}/${this.branch||"master"}/${this.path}`);return this.super.get.call(this, c);
}, upload:function(c, d=this.path) {
return Mavo.readFile(c).then(e => {
var f=e.slice(5), g=f.match(/^\w+\/[\w+]+/)[0];return f=f.replace(RegExp(`^${g}(;base64)?,`), ""), d=this.path.replace(/[^/]+$/, "")+d, this.put(f, d, {isEncoded:!0});
}).then(e => this.getURL(d, e.commit.sha));
}, put:function(c, d=this.path, e={}) {
if (d) {
var f=`repos/${this.username}/${this.repo}`, g=`${f}/contents/${d}`, h=this.mavo.element.getAttribute("mv-github-commit-prefix")||"", i=this.repoInfo||this.request("user/repos", {name:this.repo}, "POST").then(j => this.repoInfo=j);return c=e.isEncoded?c:b.btoa(c), Promise.resolve(i).then(j => {
return this.canPush()?j:this.request(`${f}/forks`, {name:this.repo}, "POST").then(k => {
return g=`repos/${k.full_name}/contents/${d}`, this.forkInfo=k;
}).then(k => {
var l, m=n => {
clearTimeout(l), this.request(`repos/${k.full_name}/commits`, {until:"1970-01-01T00:00:00Z"}, "HEAD").then(() => {
n(k);
}).catch(() => {
l=setTimeout(m, 1e3);
});
};return new Promise(m);
});
}).then(() => {
return this.request(g, {ref:this.branch}).then(k => this.request(g, {message:h+this.mavo._("gh-updated-file", {name:k.name||"file"}), content:c, branch:this.branch, sha:k.sha}, "PUT"), k => {
return 404==k.status?this.request(g, {message:h+"Created file", content:c, branch:this.branch}, "PUT"):k;
});
}).then(j => {
return this.forkInfo&&this.request(`repos/${this.username}/${this.repo}/pulls`, {head:`${this.user.username}:${this.branch}`, base:this.branch}).then(k => {
this.pullRequest(k[0]);
}), j;
});
}
}, pullRequest:function(c) {
var d=new URL(location);d.searchParams.set(this.mavo.id+"-storage", `https://github.com/${this.forkInfo.full_name}/${this.path}`);var e=this.mavo._("gh-edit-suggestion-saved-in-profile", {previewURL:d});this.notice&&this.notice.close(), c?(this.notice=this.mavo.message(`${e}
				${this.mavo._("gh-edit-suggestion-notreviewed")}
				<form onsubmit="return false">
					<button class="mv-danger">${this.mavo._("gh-edit-suggestion-revoke")}</button>
				</form>`, {classes:"mv-inline", dismiss:["button", "submit"]}), this.notice.closed.then(f => {
f&&this.request(`repos/${this.username}/${this.repo}/pulls/${c.number}`, {state:"closed"}, "POST").then(g => {
new Mavo.UI.Message(this.mavo, `<a href="${g.html_url}">${this.mavo._("gh-edit-suggestion-cancelled")}</a>`, {dismiss:["button", "timeout"]}), this.pullRequest();
});
})):(this.notice=this.mavo.message(`${e}
				${this.mavo._("gh-edit-suggestion-instructions")}
				<form onsubmit="return false">
					<textarea name="edits" class="mv-autosize" placeholder="${this.mavo._("gh-edit-suggestion-reason-placeholder")}"></textarea>
					<button>${this.mavo._("gh-edit-suggestion-send")}</button>
				</form>`, {classes:"mv-inline", dismiss:["button", "submit"]}), this.notice.closed.then(f => {
f&&this.request(`repos/${this.username}/${this.repo}/pulls`, {title:this.mavo._("gh-edit-suggestion-title"), body:this.mavo._("gh-edit-suggestion-body", {description:f.elements.edits.value, previewURL:d}), head:`${this.user.username}:${this.branch}`, base:this.branch}, "POST").then(g => {
new Mavo.UI.Message(this.mavo, `<a href="${g.html_url}">${this.mavo._("gh-edit-suggestion-sent")}</a>`, {dismiss:["button", "timeout"]}), this.pullRequest(g);
});
}));
}, login:function(c) {
return this.oAuthenticate(c).then(() => this.getUser()).catch(d => {
401==d.status&&this.logout();
}).then(() => {
if (this.user&&(this.permissions.on(["edit", "save", "logout"]), this.repo)) {
return this.request(`repos/${this.username}/${this.repo}`).then(e => {
return void 0===this.branch&&(this.branch=e.default_branch), this.repoInfo=e;
});
}
});
}, canPush:function() {
return this.repoInfo?this.repoInfo.permissions.push:this.user&&this.user.username.toLowerCase()==this.username.toLowerCase();
}, oAuthParams:() => "&scope=repo,gist", logout:function() {
return this.oAuthLogout().then(() => {
this.user=null;
});
}, getUser:function() {
return this.user?Promise.resolve(this.user):this.request("user").then(c => {
this.user={username:c.login, name:c.name||c.login, avatar:c.avatar_url, url:"https://github.com/"+c.login, info:c}, a.fire(this.mavo.element, "mavo:login", {backend:this});
});
}, getURL:function(c=this.path, d) {
var e=this.forkInfo||this.repoInfo, f=e.full_name;return c=c.replace(/ /g, "%20"), e.pagesInfo=e.pagesInfo||this.request(`repos/${f}/pages`, {}, "GET", {headers:{Accept:"application/vnd.github.mister-fantastic-preview+json"}}), e.pagesInfo.then(g => g.html_url+c).catch(() => {
return d?`https://cdn.rawgit.com/${f}/${d}/${c}`:`https://rawgit.com/${f}/${this.branch}/${c}`;
});
}, static:{apiDomain:"https://api.github.com/", oAuth:"https://github.com/login/oauth/authorize", test:function(c) {
return c=new URL(c, Mavo.base), /\bgithub.com|raw.githubusercontent.com/.test(c.host);
}, parseURL:function(c) {
var d={};c=new URL(c, Mavo.base);var e=c.pathname.slice(1).split("/");if (d.username=e.shift(), d.repo=e.shift(), /raw.githubusercontent.com$/.test(c.host)) {
d.branch=e.shift();
}
else {
if (/api.github.com$/.test(c.host)) {
return {};
}"blob"==e[0]&&(e.shift(), d.branch=e.shift());
} return d.path=e.join("/"), d;
}, btoa:c => btoa(unescape(encodeURIComponent(c))), atob:c => decodeURIComponent(escape(window.atob(c)))}}));
})(Bliss);
// # sourceMappingURL=maps/mavo.min.js.map
