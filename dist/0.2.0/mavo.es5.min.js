!function() {
"use strict";function t(e, n, i) {
return n=void 0===n?1:n, i=i||n+1, i-n<=1?function() {
if (arguments.length<=n||"string"===r.type(arguments[n])) {
return e.apply(this, arguments);
} var t, i=arguments[n];for (var o in i) {
var s=Array.prototype.slice.call(arguments);s.splice(n, 1, o, i[o]), t=e.apply(this, s);
} return t;
}:t(t(e, n+1, i), n, i-1);
} function e(t, r, i) {
var o=n(i);if ("string"===o) {
var s=Object.getOwnPropertyDescriptor(r, i);!s||s.writable&&s.configurable&&s.enumerable&&!s.get&&!s.set?t[i]=r[i]:(delete t[i], Object.defineProperty(t, i, s));
}
else if ("array"===o) {
i.forEach(function(n) {
n in r&&e(t, r, n);
});
}
else {
for (var a in r) {
i&&("regexp"===o&&!i.test(a)||"function"===o&&!i.call(r, a))||e(t, r, a);
}
} return t;
} function n(t) {
if (null===t) {
return "null";
} if (void 0===t) {
return "undefined";
} var e=(Object.prototype.toString.call(t).match(/^\[object\s+(.*?)\]$/)[1]||"").toLowerCase();return "number"==e&&isNaN(t)?"nan":e;
} var r=self.Bliss=e(function(t, e) {
return 2==arguments.length&&!e||!t?null:"string"===r.type(t)?(e||document).querySelector(t):t||null;
}, self.Bliss);e(r, {extend:e, overload:t, type:n, property:r.property||"_", listeners:self.WeakMap?new WeakMap:new Map, original:{addEventListener:(self.EventTarget||Node).prototype.addEventListener, removeEventListener:(self.EventTarget||Node).prototype.removeEventListener}, sources:{}, noop:function() {}, $:function(t, e) {
return t instanceof Node||t instanceof Window?[t]:2!=arguments.length||e?Array.prototype.slice.call("string"==typeof t?(e||document).querySelectorAll(t):t||[]):[];
}, defined:function() {
for (var t=0;t<arguments.length;t++) {
if (void 0!==arguments[t]) {
return arguments[t];
}
}
}, create:function(t, e) {
return t instanceof Node?r.set(t, e):(1===arguments.length&&("string"===r.type(t)?e={}:(e=t, t=e.tag, e=r.extend({}, e, function(t) {
return "tag"!==t;
}))), r.set(document.createElement(t||"div"), e));
}, each:function(t, e, n) {
n=n||{};for (var r in t) {
n[r]=e.call(t, r, t[r]);
} return n;
}, ready:function(t, e, n) {
if ("function"!=typeof t||e||(e=t, t=void 0), t=t||document, e&&("loading"!==t.readyState?e():r.once(t, "DOMContentLoaded", function() {
e();
})), !n) {
return new Promise(function(e) {
r.ready(t, e, !0);
});
}
}, Class:function(t) {
var e, n=["constructor", "extends", "abstract", "static"].concat(Object.keys(r.classProps)), i=t.hasOwnProperty("constructor")?t.constructor:r.noop;2==arguments.length?(e=arguments[0], t=arguments[1]):(e=function() {
if (this.constructor.__abstract&&this.constructor===e) {
throw new Error("Abstract classes cannot be directly instantiated.");
}e["super"]&&e["super"].apply(this, arguments), i.apply(this, arguments);
}, e["super"]=t["extends"]||null, e.prototype=r.extend(Object.create(e["super"]?e["super"].prototype:Object), {constructor:e}), e.prototype["super"]=e["super"]?e["super"].prototype:null, e.__abstract=!!t["abstract"]);var o=function(t) {
return this.hasOwnProperty(t)&&n.indexOf(t)===-1;
};if (t["static"]) {
r.extend(e, t["static"], o);for (var s in r.classProps) {
s in t["static"]&&r.classProps[s](e, t["static"][s]);
}
}r.extend(e.prototype, t, o);for (var s in r.classProps) {
s in t&&r.classProps[s](e.prototype, t[s]);
} return e;
}, classProps:{lazy:t(function(t, e, n) {
return Object.defineProperty(t, e, {get:function() {
var t=n.call(this);return Object.defineProperty(this, e, {value:t, configurable:!0, enumerable:!0, writable:!0}), t;
}, set:function(t) {
Object.defineProperty(this, e, {value:t, configurable:!0, enumerable:!0, writable:!0});
}, configurable:!0, enumerable:!0}), t;
}), live:t(function(t, e, n) {
return "function"===r.type(n)&&(n={set:n}), Object.defineProperty(t, e, {get:function() {
var t=this["_"+e], r=n.get&&n.get.call(this, t);return void 0!==r?r:t;
}, set:function(t) {
var r=this["_"+e], i=n.set&&n.set.call(this, t, r);this["_"+e]=void 0!==i?i:t;
}, configurable:n.configurable, enumerable:n.enumerable}), t;
})}, include:function() {
var t=arguments[arguments.length-1], e=2===arguments.length&&arguments[0], n=document.createElement("script");return e?Promise.resolve():new Promise(function(e, i) {
r.set(n, {async:!0, onload:function() {
e(n), n.parentNode&&n.parentNode.removeChild(n);
}, onerror:function() {
i(n);
}, src:t, inside:document.head});
});
}, load:function o(t, e) {
e=e?new URL(e, location.href):location.href, t=new URL(t, e);var n=o.loading=o.loading||{};return n[t+""]?n[t+""]:/\.css$/.test(t.pathname)?n[t+""]=new Promise(function(e, n) {
var i=r.create("link", {href:t, rel:"stylesheet", inside:document.head, onload:function() {
e(i);
}, onerror:function() {
n(i);
}});
}):n[t+""]=r.include(t);
}, fetch:function(t, n) {
if (!t) {
throw new TypeError("URL parameter is mandatory and cannot be "+t);
} var i=e({url:new URL(t, location), data:"", method:"GET", headers:{}, xhr:new XMLHttpRequest}, n);i.method=i.method.toUpperCase(), r.hooks.run("fetch-args", i), "GET"===i.method&&i.data&&(i.url.search+=i.data), document.body.setAttribute("data-loading", i.url), i.xhr.open(i.method, i.url.href, i.async!==!1, i.user, i.password);for (var o in n) {
if ("upload"===o) {
i.xhr.upload&&"object"==typeof n[o]&&r.extend(i.xhr.upload, n[o]);
}
else if (o in i.xhr) {
try {
i.xhr[o]=n[o];
}
catch (s) {
self.console&&console.error(s);
}
}
} var a=Object.keys(i.headers).map(function(t) {
return t.toLowerCase();
});"GET"!==i.method&&a.indexOf("content-type")===-1&&i.xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");for (var c in i.headers) {
void 0!==i.headers[c]&&i.xhr.setRequestHeader(c, i.headers[c]);
} var u=new Promise(function(t, e) {
i.xhr.onload=function() {
document.body.removeAttribute("data-loading"), 0===i.xhr.status||i.xhr.status>=200&&i.xhr.status<300||304===i.xhr.status?t(i.xhr):e(r.extend(Error(i.xhr.statusText), {xhr:i.xhr, get status() {
return this.xhr.status;
}}));
}, i.xhr.onerror=function() {
document.body.removeAttribute("data-loading"), e(r.extend(Error("Network Error"), {xhr:i.xhr}));
}, i.xhr.ontimeout=function() {
document.body.removeAttribute("data-loading"), e(r.extend(Error("Network Timeout"), {xhr:i.xhr}));
}, i.xhr.send("GET"===i.method?null:i.data);
});return u.xhr=i.xhr, u;
}, value:function(t) {
var e="string"!=typeof t;return r.$(arguments).slice(+e).reduce(function(t, e) {
return t&&t[e];
}, e?t:self);
}}), r.Hooks=new r.Class({add:function(t, e, n) {
if ("string"==typeof arguments[0]) {
(Array.isArray(t)?t:[t]).forEach(function(t) {
this[t]=this[t]||[], e&&this[t][n?"unshift":"push"](e);
}, this);
}
else {
for (var t in arguments[0]) {
this.add(t, arguments[0][t], arguments[1]);
}
}
}, run:function(t, e) {
this[t]=this[t]||[], this[t].forEach(function(t) {
t.call(e&&e.context?e.context:e, e);
});
}}), r.hooks=new r.Hooks;r.property;r.Element=function(t) {
this.subject=t, this.data={}, this.bliss={};
}, r.Element.prototype={set:t(function(t, e) {
t in r.setProps?r.setProps[t].call(this, e):t in this?this[t]=e:this.setAttribute(t, e);
}, 0), transition:function(t, e) {
return new Promise(function(n, i) {
if ("transition"in this.style&&0!==e) {
var o=r.extend({}, this.style, /^transition(Duration|Property)$/);r.style(this, {transitionDuration:(e||400)+"ms", transitionProperty:Object.keys(t).join(", ")}), r.once(this, "transitionend", function() {
clearTimeout(s), r.style(this, o), n(this);
});var s=setTimeout(n, e+50, this);r.style(this, t);
}
else {
r.style(this, t), n(this);
}
}.bind(this));
}, fire:function(t, e) {
var n=document.createEvent("HTMLEvents");return n.initEvent(t, !0, !0), this.dispatchEvent(r.extend(n, e));
}, bind:t(function(t, e) {
if (arguments.length>1&&("function"===r.type(e)||e.handleEvent)) {
var n=e;e="object"===r.type(arguments[2])?arguments[2]:{capture:!!arguments[2]}, e.callback=n;
} var i=r.listeners.get(this)||{};t.trim().split(/\s+/).forEach(function(t) {
if (t.indexOf(".")>-1) {
t=t.split(".");var n=t[1];t=t[0];
}i[t]=i[t]||[], 0===i[t].filter(function(t) {
return t.callback===e.callback&&t.capture==e.capture;
}).length&&i[t].push(r.extend({className:n}, e)), r.original.addEventListener.call(this, t, e.callback, e);
}, this), r.listeners.set(this, i);
}, 0), unbind:t(function(t, e) {
if (e&&("function"===r.type(e)||e.handleEvent)) {
var n=e;e=arguments[2];
}"boolean"==r.type(e)&&(e={capture:e}), e=e||{}, e.callback=e.callback||n;var i=r.listeners.get(this);(t||"").trim().split(/\s+/).forEach(function(t) {
if (t.indexOf(".")>-1) {
t=t.split(".");var n=t[1];t=t[0];
} if (i) {
for (var o in i) {
if (!t||o===t) {
for (var s, a=0;s=i[o][a];a++) {
n&&n!==s.className||e.callback&&e.callback!==s.callback||!!e.capture!=!!s.capture&&(t||e.callback||void 0!==e.capture)||(i[o].splice(a, 1), r.original.removeEventListener.call(this, o, s.callback, s.capture), a--);
}
}
}
}
else if (t&&e.callback) {
return r.original.removeEventListener.call(this, t, e.callback, e.capture);
}
}, this);
}, 0), when:function(t, e) {
var n=this;return new Promise(function(r) {
n.addEventListener(t, function i(n) {
e&&!e.call(this, n)||(this.removeEventListener(t, i), r(n));
});
});
}, toggleAttribute:function(t, e, n) {
arguments.length<3&&(n=null!==e), n?this.setAttribute(t, e):this.removeAttribute(t);
}}, r.setProps={style:function(t) {
for (var e in t) {
e in this.style?this.style[e]=t[e]:this.style.setProperty(e, t[e]);
}
}, attributes:function(t) {
for (var e in t) {
this.setAttribute(e, t[e]);
}
}, properties:function(t) {
r.extend(this, t);
}, events:function(t) {
if (1!=arguments.length||!t||!t.addEventListener) {
return r.bind.apply(this, [this].concat(r.$(arguments)));
} var e=this;if (r.listeners) {
var n=r.listeners.get(t);for (var i in n) {
n[i].forEach(function(t) {
r.bind(e, i, t.callback, t.capture);
});
}
} for (var o in t) {
0===o.indexOf("on")&&(this[o]=t[o]);
}
}, once:t(function(t, e) {
var n=this, i=function() {
return r.unbind(n, t, i), e.apply(n, arguments);
};r.bind(this, t, i, {once:!0});
}, 0), delegate:t(function(t, e, n) {
r.bind(this, t, function(t) {
t.target.closest(e)&&n.call(this, t);
});
}, 0, 2), contents:function(t) {
(t||0===t)&&(Array.isArray(t)?t:[t]).forEach(function(t) {
var e=r.type(t);/^(string|number)$/.test(e)?t=document.createTextNode(t+""):"object"===e&&(t=r.create(t)), t instanceof Node&&this.appendChild(t);
}, this);
}, inside:function(t) {
t&&t.appendChild(this);
}, before:function(t) {
t&&t.parentNode.insertBefore(this, t);
}, after:function(t) {
t&&t.parentNode.insertBefore(this, t.nextSibling);
}, start:function(t) {
t&&t.insertBefore(this, t.firstChild);
}, around:function(t) {
t&&t.parentNode&&r.before(this, t), this.appendChild(t);
}}, r.Array=function(t) {
this.subject=t;
}, r.Array.prototype={all:function(t) {
var e=r.$(arguments).slice(1);return this[t].apply(this, e);
}}, r.add=t(function(t, e, n, i) {
n=r.extend({$:!0, element:!0, array:!0}, n), "function"==r.type(e)&&(!n.element||t in r.Element.prototype&&i||(r.Element.prototype[t]=function() {
return this.subject&&r.defined(e.apply(this.subject, arguments), this.subject);
}), !n.array||t in r.Array.prototype&&i||(r.Array.prototype[t]=function() {
var t=arguments;return this.subject.map(function(n) {
return n&&r.defined(e.apply(n, t), n);
});
}), n.$&&(r.sources[t]=r[t]=e, (n.array||n.element)&&(r[t]=function() {
var e=[].slice.apply(arguments), i=e.shift(), o=n.array&&Array.isArray(i)?"Array":"Element";return r[o].prototype[t].apply({subject:i}, e);
})));
}, 0), r.add(r.Array.prototype, {element:!1}), r.add(r.Element.prototype), r.add(r.setProps), r.add(r.classProps, {element:!1, array:!1});var i=document.createElement("_");r.add(r.extend({}, HTMLElement.prototype, function(t) {
return "function"===r.type(i[t]);
}), null, !0);
}();
/* jsep v0.3.2 (http://jsep.from.so/) */
!function(e) {
"use strict";var r=function(e, r) {
var t=new Error(e+" at character "+r);throw t.index=r, t.description=e, t;
}, t={"-":!0, "!":!0, "~":!0, "+":!0}, n={"||":1, "&&":2, "|":3, "^":4, "&":5, "==":6, "!=":6, "===":6, "!==":6, "<":7, ">":7, "<=":7, ">=":7, "<<":8, ">>":8, ">>>":8, "+":9, "-":9, "*":10, "/":10, "%":10}, o=function(e) {
var r, t=0;for (var n in e) {
(r=n.length)>t&&e.hasOwnProperty(n)&&(t=r);
} return t;
}, i=o(t), a=o(n), u={true:!0, false:!1, null:null}, s=function(e) {
return n[e]||0;
}, p=function(e, r, t) {
return {type:"||"===e||"&&"===e?"LogicalExpression":"BinaryExpression", operator:e, left:r, right:t};
}, f=function(e) {
return e>=48&&e<=57;
}, c=function(e) {
return 36===e||95===e||e>=65&&e<=90||e>=97&&e<=122||e>=128&&!n[String.fromCharCode(e)];
}, l=function(e) {
return 36===e||95===e||e>=65&&e<=90||e>=97&&e<=122||e>=48&&e<=57||e>=128&&!n[String.fromCharCode(e)];
}, d=function(e) {
for (var o, d, h=0, v=e.charAt, x=e.charCodeAt, y=function(r) {
return v.call(e, r);
}, m=function(r) {
return x.call(e, r);
}, b=e.length, E=function() {
for (var e=m(h);32===e||9===e||10===e||13===e;) {
e=m(++h);
}
}, g=function() {
var e, t, n=w();return E(), 63!==m(h)?n:(h++, (e=g())||r("Expected expression", h), E(), 58===m(h)?(h++, (t=g())||r("Expected expression", h), {type:"ConditionalExpression", test:n, consequent:e, alternate:t}):void r("Expected :", h));
}, C=function() {
E();for (var r=e.substr(h, a), t=r.length;t>0;) {
if (n.hasOwnProperty(r)) {
return h+=t, r;
}r=r.substr(0, --t);
} return !1;
}, w=function() {
var e, t, n, o, i, a, u, f;if (a=O(), !(t=C())) {
return a;
} for (i={value:t, prec:s(t)}, (u=O())||r("Expected expression after "+t, h), o=[a, i, u];(t=C())&&0!==(n=s(t));) {
for (i={value:t, prec:n};o.length>2&&n<=o[o.length-2].prec;) {
u=o.pop(), t=o.pop().value, a=o.pop(), e=p(t, a, u), o.push(e);
}(e=O())||r("Expected expression after "+t, h), o.push(i, e);
} for (e=o[f=o.length-1];f>1;) {
e=p(o[f-1].value, o[f-2], e), f-=2;
} return e;
}, O=function() {
var r, n, o;if (E(), r=m(h), f(r)||46===r) {
return U();
} if (39===r||34===r) {
return k();
} if (91===r) {
return S();
} for (o=(n=e.substr(h, i)).length;o>0;) {
if (t.hasOwnProperty(n)) {
return h+=o, {type:"UnaryExpression", operator:n, argument:O(), prefix:!0};
}n=n.substr(0, --o);
} return !(!c(r)&&40!==r)&&A();
}, U=function() {
for (var e, t, n="";f(m(h));) {
n+=y(h++);
} if (46===m(h)) {
for (n+=y(h++);f(m(h));) {
n+=y(h++);
}
} if ("e"===(e=y(h))||"E"===e) {
for (n+=y(h++), "+"!==(e=y(h))&&"-"!==e||(n+=y(h++));f(m(h));) {
n+=y(h++);
}f(m(h-1))||r("Expected exponent ("+n+y(h)+")", h);
} return t=m(h), c(t)?r("Variable names cannot start with a number ("+n+y(h)+")", h):46===t&&r("Unexpected period", h), {type:"Literal", value:parseFloat(n), raw:n};
}, k=function() {
for (var e, t="", n=y(h++), o=!1;h<b;) {
if ((e=y(h++))===n) {
o=!0;break;
} if ("\\"===e) {
switch (e=y(h++)) {
case "n":t+="\n";break;case "r":t+="\r";break;case "t":t+="\t";break;case "b":t+="\b";break;case "f":t+="\f";break;case "v":t+="\v";break;default:t+=e;
}
}
 else {
t+=e;
}
} return o||r('Unclosed quote after "'+t+'"', h), {type:"Literal", value:t, raw:n+t+n};
}, L=function() {
var t, n=m(h), o=h;for (c(n)?h++:r("Unexpected "+y(h), h);h<b&&(n=m(h), l(n));) {
h++;
} return t=e.slice(o, h), u.hasOwnProperty(t)?{type:"Literal", value:u[t], raw:t}:"this"===t?{type:"ThisExpression"}:{type:"Identifier", name:t};
}, j=function(e) {
for (var t, n, o=[], i=!1;h<b;) {
if (E(), (t=m(h))===e) {
i=!0, h++;break;
}44===t?h++:((n=g())&&"Compound"!==n.type||r("Expected comma", h), o.push(n));
} return i||r("Expected "+String.fromCharCode(e), h), o;
}, A=function() {
var e, t;for (t=40===(e=m(h))?P():L(), E(), e=m(h);46===e||91===e||40===e;) {
h++, 46===e?(E(), t={type:"MemberExpression", computed:!1, object:t, property:L()}):91===e?(t={type:"MemberExpression", computed:!0, object:t, property:g()}, E(), 93!==(e=m(h))&&r("Unclosed [", h), h++):40===e&&(t={type:"CallExpression", arguments:j(41), callee:t}), E(), e=m(h);
} return t;
}, P=function() {
h++;var e=g();if (E(), 41===m(h)) {
return h++, e;
}r("Unclosed (", h);
}, S=function() {
return h++, {type:"ArrayExpression", elements:j(93)};
}, B=[];h<b;) {
59===(o=m(h))||44===o?h++:(d=g())?B.push(d):h<b&&r('Unexpected "'+y(h)+'"', h);
} return 1===B.length?B[0]:{type:"Compound", body:B};
};if (d.version="0.3.2", d.toString=function() {
return "JavaScript Expression Parser (JSEP) v"+d.version;
}, d.addUnaryOp=function(e) {
return i=Math.max(e.length, i), t[e]=!0, this;
}, d.addBinaryOp=function(e, r) {
return a=Math.max(e.length, a), n[e]=r, this;
}, d.addLiteral=function(e, r) {
return u[e]=r, this;
}, d.removeUnaryOp=function(e) {
return delete t[e], e.length===i&&(i=o(t)), this;
}, d.removeAllUnaryOps=function() {
return t={}, i=0, this;
}, d.removeBinaryOp=function(e) {
return delete n[e], e.length===a&&(a=o(n)), this;
}, d.removeAllBinaryOps=function() {
return n={}, a=0, this;
}, d.removeLiteral=function(e) {
return delete u[e], this;
}, d.removeAllLiterals=function() {
return u={}, this;
}, "undefined"==typeof exports) {
var h=e.jsep;e.jsep=d, d.noConflict=function() {
return e.jsep===d&&(e.jsep=h), d;
};
}
else {
"undefined"!=typeof module&&module.exports?exports=module.exports=d:exports.parse=d;
}
}(this);
// # sourceMappingURL=jsep.min.js.map
!function() {
if (self.Element&&(Element.prototype.matches||(Element.prototype.matches=Element.prototype.webkitMatchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||null), Element.prototype.matches)) {
var p=self.Stretchy={selectors:{base:'textarea, select:not([size]), input:not([type]), input[type="'+"text number url email tel".split(" ").join('"], input[type="')+'"]', filter:"*"}, script:document.currentScript||t("script").pop(), resize:function(e) {
if (p.resizes(e)) {
var t, i=getComputedStyle(e), n=0;!e.value&&e.placeholder&&(t=!0, e.value=e.placeholder);var o=e.nodeName.toLowerCase();if ("textarea"==o) {
e.style.height="0", "border-box"==i.boxSizing?n=e.offsetHeight:"content-box"==i.boxSizing&&(n=-e.clientHeight+parseFloat(i.minHeight)), e.style.height=e.scrollHeight+n+"px";
}
else if ("input"==o) {
if (e.style.width="1000px", e.offsetWidth) {
e.style.width="0",
"border-box"==i.boxSizing?n=e.offsetWidth:"padding-box"==i.boxSizing?n=e.clientWidth:"content-box"==i.boxSizing&&(n=parseFloat(i.minWidth));var r=Math.max(n, e.scrollWidth-e.clientWidth);e.style.width=r+"px";for (var l=0;l<10&&(e.scrollLeft=1e10, 0!=e.scrollLeft);l++) {
r+=e.scrollLeft, e.style.width=r+"px";
}
}
else {
e.style.width=e.value.length+1+"ch";
}
}
else if ("select"==o) {
var s, c=0<e.selectedIndex?e.selectedIndex:0, a=document.createElement("_");for (var d in a.textContent=e.options[c].textContent, e.parentNode.insertBefore(a, e.nextSibling), i) {
var h=i[d];/^(width|webkitLogicalWidth|length)$/.test(d)||"string"!=typeof h||(a.style[d]=h, /appearance$/i.test(d)&&(s=d));
}a.style.width="", 0<a.offsetWidth&&(e.style.width=a.offsetWidth+"px", i[s]&&"none"===i[s]||(e.style.width="calc("+e.style.width+" + 2em)")), a.parentNode.removeChild(a), a=null;
}t&&(e.value="");
}
}, resizeAll:function(e) {
t(e||p.selectors.base).forEach(function(e) {
p.resize(e);
});
}, active:!0, resizes:function(e) {
return e&&e.parentNode&&e.matches&&e.matches(p.selectors.base)&&e.matches(p.selectors.filter);
}, init:function() {
p.selectors.filter=p.script.getAttribute("data-filter")||(t("[data-stretchy-filter]").pop()||document.body).getAttribute("data-stretchy-filter")||p.selectors.filter, p.resizeAll(), self.MutationObserver&&!p.observer&&(p.observer=new MutationObserver(function(e) {
p.active&&e.forEach(function(e) {
"childList"==e.type&&p.resizeAll(e.addedNodes);
});
}), p.observer.observe(document.documentElement, {childList:!0, subtree:!0}));
}, $$:t};"loading"!==document.readyState?requestAnimationFrame(p.init):document.addEventListener("DOMContentLoaded", p.init), window.addEventListener("load", function() {
p.resizeAll();
});var e=function(e) {
p.active&&p.resize(e.target);
};document.documentElement.addEventListener("input", e), document.documentElement.addEventListener("change", e);
} function t(e, t) {
return e instanceof Node||e instanceof Window?[e]:[].slice.call("string"==typeof e?(t||document).querySelectorAll(e):e||[]);
}
}();
// # sourceMappingURL=stretchy.min.js.map

"use strict";function _slicedToArray(e, t) {
return _arrayWithHoles(e)||_iterableToArrayLimit(e, t)||_nonIterableRest();
} function _nonIterableRest() {
throw new TypeError("Invalid attempt to destructure non-iterable instance");
} function _iterableToArrayLimit(e, t) {
var a=[], n=!0, o=!1, r=void 0;try {
for (var i=e[Symbol.iterator](), s;!(n=(s=i.next()).done)&&(a.push(s.value), !(t&&a.length===t));n=!0) {
;
}
}
catch (e) {
o=!0, r=e;
}
finally {
try {
n||null==i["return"]||i["return"]();
}
finally {
if (o) {
throw r;
}
}
} return a;
} function _arrayWithHoles(e) {
if (Array.isArray(e)) {
return e;
}
} function _objectSpread(e) {
for (var t=1;t<arguments.length;t++) {
var a=null==arguments[t]?{}:arguments[t], n=Object.keys(a);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(a).filter(function(e) {
return Object.getOwnPropertyDescriptor(a, e).enumerable;
}))), n.forEach(function(t) {
_defineProperty(e, t, a[t]);
});
} return e;
} function isNativeReflectConstruct() {
if ("undefined"==typeof Reflect||!Reflect.construct) {
return !1;
} if (Reflect.construct.sham) {
return !1;
} if ("function"==typeof Proxy) {
return !0;
} try {
return Date.prototype.toString.call(Reflect.construct(Date, [], function() {})), !0;
}
catch (t) {
return !1;
}
} function _construct() {
return _construct=isNativeReflectConstruct()?Reflect.construct:function(e, t, n) {
var o=[null];o.push.apply(o, t);var a=Function.bind.apply(e, o), r=new a;return n&&_setPrototypeOf(r, n.prototype), r;
}, _construct.apply(null, arguments);
} function _possibleConstructorReturn(e, t) {
return t&&("object"===_typeof(t)||"function"==typeof t)?t:_assertThisInitialized(e);
} function _assertThisInitialized(e) {
if (void 0===e) {
throw new ReferenceError("this hasn't been initialised - super() hasn't been called");
} return e;
} function _get(e, t, a) {
return _get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e, t, a) {
var n=_superPropBase(e, t);if (n) {
var o=Object.getOwnPropertyDescriptor(n, t);return o.get?o.get.call(a):o.value;
}
}, _get(e, t, a||e);
} function _superPropBase(e, t) {
for (;!Object.prototype.hasOwnProperty.call(e, t)&&(e=_getPrototypeOf(e), null!==e);) {
;
} return e;
} function _getPrototypeOf(e) {
return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e) {
return e.__proto__||Object.getPrototypeOf(e);
}, _getPrototypeOf(e);
} function _inherits(e, t) {
if ("function"!=typeof t&&null!==t) {
throw new TypeError("Super expression must either be null or a function");
}e.prototype=Object.create(t&&t.prototype, {constructor:{value:e, writable:!0, configurable:!0}}), t&&_setPrototypeOf(e, t);
} function _setPrototypeOf(e, t) {
return _setPrototypeOf=Object.setPrototypeOf||function(e, t) {
return e.__proto__=t, e;
}, _setPrototypeOf(e, t);
} function _classCallCheck(e, t) {
if (!(e instanceof t)) {
throw new TypeError("Cannot call a class as a function");
}
} function _defineProperties(e, t) {
for (var a=0, n;a<t.length;a++) {
n=t[a], n.enumerable=n.enumerable||!1, n.configurable=!0, "value"in n&&(n.writable=!0), Object.defineProperty(e, n.key, n);
}
} function _createClass(e, t, a) {
return t&&_defineProperties(e.prototype, t), a&&_defineProperties(e, a), e;
} function _toConsumableArray(e) {
return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread();
} function _nonIterableSpread() {
throw new TypeError("Invalid attempt to spread non-iterable instance");
} function _iterableToArray(e) {
if (Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)) {
return Array.from(e);
}
} function _arrayWithoutHoles(e) {
if (Array.isArray(e)) {
for (var t=0, a=Array(e.length);t<e.length;t++) {
a[t]=e[t];
} return a;
}
} function _defineProperty(e, t, a) {
return t in e?Object.defineProperty(e, t, {value:a, enumerable:!0, configurable:!0, writable:!0}):e[t]=a, e;
} function _typeof(e) {
return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e) {
return typeof e;
}:function(e) {
return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e;
}, _typeof(e);
}(function(e, t) {
var a=self.Mavo=e.Class({constructor:function(n) {
var o=this;if (this.treeBuilt=Mavo.promise(), this.dataLoaded=Mavo.promise(), this.deleted=[], this.element=n, this.inProgress=!1, this.index=Object.keys(a.all).length+1, Object.defineProperty(a.all, this.index-1, {value:this, configurable:!0}), Mavo.attributeStartsWith("data-mv-", this.element).forEach(function(e) {
var t=e.ownerElement, a=e.name.replace("data-", "");t.attributes[a]||t.setAttribute(a, e.value);
}), this.id=Mavo.getAttribute(this.element, "mv-app", "id")||"mavo".concat(this.index), this.id in a.all) {
for (var r=2;this.id+r in a.all;r++) {
;
} this.id+=r;
}a.all[this.id]=this, this.element.setAttribute("mv-app", this.id);var s=Mavo.getClosestAttribute(this.element, "lang")||Mavo.locale;this.locale=Mavo.Locale.get(s), this.autoEdit=this.element.classList.contains("mv-autoedit"), this.autoSave=this.element.hasAttribute("mv-autosave"), this.autoSaveDelay=1e3*(this.element.getAttribute("mv-autosave")||0), Mavo.setAttributeShy(this.element, "typeof", ""), Mavo.hooks.run("init-start", this), t(a.selectors.multiple, this.element).forEach(function(e) {
a.setAttributeShy(e, "property", "");
}), t(a.selectors.primitive, this.element).forEach(function(t) {
if (e(a.selectors.property, t)) {
var n=Mavo.Primitive.getConfig(t);(n.attribute||n.hasChildren)&&!Mavo.is("multiple", t)||Mavo.setAttributeShy(t, "typeof", "");
}
}), this.expressions=new Mavo.Expressions(this), Mavo.hooks.run("init-tree-before", this), this.root=new Mavo.Group(this.element, this), this.treeBuilt.resolve(), Mavo.hooks.run("init-tree-after", this), this.permissions=new Mavo.Permissions;var l=["source", "storage", "init"];l.forEach(function(e) {
return o.updateBackend(e);
}), this.backendObserver=new Mavo.Observer(this.element, l.map(function(e) {
return "mv-"+e;
}), function(e) {
var t={}, a=e.map(function(e) {
var a=e.attributeName.replace(/^mv-/, "");return t[a]=o.updateBackend(a), a;
});t.source?o.load():!o.source&&(t.storage||t.init&&!o.root.data)&&o.load();
}), this.permissions.can("login", function() {
(null!==Mavo.Functions.url("login")&&1==o.index||null!==Mavo.Functions.url(o.id+"-login"))&&o.primaryBackend.login();
}), e.bind(this.element, "mv-login.mavo", function(e) {
e.backend!=(o.source||o.storage)||o.root.data||o.unsavedChanges||o.load();
}), this.bar=new Mavo.UI.Bar(this), e("summary [property]:not([typeof])")&&this.element.addEventListener("click", function(e) {
e.target!=document.activeElement&&e.preventDefault();
}), this.needsEdit=this.calculateNeedsEdit(), this.setUnsavedChanges(!1), this.permissions.onchange(function(e) {
var t=e.action, a=e.value, n=o.element.getAttribute("mv-permissions")||"";n=n.trim().split(/\s+/).filter(function(e) {
return e!=t;
}), a&&n.push(t), o.element.setAttribute("mv-permissions", n.join(" "));
}), this.permissions.can(["edit", "add", "delete"], function() {
o.modeObserver=new Mavo.Observer(o.element, "mv-mode", function(e) {
e.forEach(function(e) {
var t=e.target, n=a.Node.children(t);nodeloop:for (var o=0;o<n.length;o++) {
var r=n[o], i=r.mode, s=void 0;if (r.element==t) {
s=r.element.getAttribute("mv-mode"), r.modes=s;
}
else {
if (r.modes) {
continue nodeloop;
}s=a.getStyle(r.element.parentNode, "--mv-mode");
}r.mode=s, i!=r.mode&&r["edit"==r.mode?"edit":"done"]();
}
});
}, {subtree:!0}), o.autoEdit&&o.edit();
}, function() {
o.modeObserver&&o.modeObserver.destroy();
}), this.storage||this.source?this.permissions.can("read", function() {
return o.load();
}):requestAnimationFrame(function() {
o.dataLoaded.resolve(), o.expressions.update(), e.fire(o.element, "mv-load");
}), e.bind(this.element, "mv-load.mavo", function() {
if (location.hash) {
var e=function() {
var e=document.getElementById(location.hash.slice(1));return (e||!location.hash)&&(o.element.contains(e)&&requestAnimationFrame(function() {
Mavo.scrollIntoViewIfNeeded(e);
}), o.idObserver&&(o.idObserver.destroy(), o.idObserver=null)), e;
};e()||(o.idObserver=new Mavo.Observer(o.element, "id", e, {subtree:!0}));
}requestAnimationFrame(function() {
return Stretchy.resizeAll();
});
}), this.autoSave&&this.dataLoaded.then(function() {
var t=a.debounce(function() {
o.save();
}, o.autoSaveDelay), n=function(e) {
e.node.saved&&t();
};requestAnimationFrame(function() {
o.permissions.can("save", function() {
e.bind(o.element, "mv-change.mavo:autosave", n);
}, function() {
e.unbind(o.element, "mv-change.mavo:autosave", n);
});
});
}), this.element.addEventListener("keydown", function(e) {
if (o.permissions.save&&83==e.keyCode&&e[a.superKey]&&!e.altKey) {
e.preventDefault(), o.save();
}
else if (38==e.keyCode||40==e.keyCode) {
var t=e.target;if (t.matches("textarea, input[type=range], input[type=number]")) {
return;
} if (t.matches(".mv-editor")) {
var n=!0;t=t.parentNode;
} var r=Mavo.Node.get(t);if (r&&r.closestCollection) {
var i=r.getCousin(38==e.keyCode?-1:1, {wrap:!0});i&&(n&&i.editing?i.edit({immediately:!0}).then(function() {
return i.editor.focus();
}):i.element.focus(), e.preventDefault());
}
}
}), e.bind(this.element, "click submit", a.Actions.listener), Mavo.hooks.run("init-end", this);
}, get editing() {
return this.root.editing;
}, getData:function(e) {
return this.root.getData(e);
}, toJSON:function() {
return a.toJSON(this.getData());
}, message:function(e) {
var t=1<arguments.length&&arguments[1]!==void 0?arguments[1]:{};return new a.UI.Message(this, e, t);
}, error:function(e) {
this.message(e, {type:"error", dismiss:["button", "timeout"]});for (var t=arguments.length, a=Array(1<t?t-1:0), n=1;n<t;n++) {
a[n-1]=arguments[n];
} if (0<a.length) {
var o;(o=console).log.apply(o, ["%c".concat(this.id, ": ").concat(e), "color: red; font-weight: bold"].concat(a));
}
}, render:function(e) {
var t={context:this, data:e};a.hooks.run("render-start", t), t.data&&this.root.render(t.data), this.unsavedChanges=!1, a.hooks.run("render-end", t);
}, edit:function() {
this.root.edit(), e.bind(this.element, "mouseenter.mavo:edit mouseleave.mavo:edit", function(e) {
if (e.target.matches(a.selectors.multiple)) {
e.target.classList.remove("mv-has-hovered-item");var t=e.target.parentNode.closest(a.selectors.multiple);t&&t.classList.toggle("mv-has-hovered-item", "mouseenter"==e.type);
}
}, !0), this.setUnsavedChanges();
}, done:function() {
this.root.done(), e.unbind(this.element, ".mavo:edit"), this.unsavedChanges=!1;
}, setUnsavedChanges:function(e) {
var t=!!e;return e||this.walk(function(a) {
if (a.unsavedChanges) {
return t=!0, !1===e&&(a.unsavedChanges=!1), !1;
}
}), this.unsavedChanges=t;
}, updateBackend:function(e) {
var t=this[e], n, o;if (1==this.index&&(n=a.Functions.url(e)), n||(n=a.Functions.url("".concat(this.id, "-").concat(e))||this.element.getAttribute("mv-"+e)||null), n&&(n=n.trim(), "none"==n&&(n=null)), !n||t&&t.equals(n)?!n&&(this[e]=null):(this[e]=n=a.Backend.create(n, {mavo:this, format:this.element.getAttribute("mv-".concat(e, "-format"))||this.element.getAttribute("mv-format")}, this.element.getAttribute("mv-".concat(e, "-type")), this[e]), o=!0), o=o||(n?!n.equals(t):!!t), o) {
this.storage||this.source||!this.init||(this.source=this.init, this.init=null);var r=this.storage?this.storage.permissions:new Mavo.Permissions({edit:!0, save:!1});r.parent=this.source&&this.source.permissions, this.permissions.parent=r, this.primaryBackend=this.storage||this.source;
} return o;
}, load:function() {
var t=this, a=this.source||this.storage;return a?(this.inProgress="Loading", a.ready.then(function() {
return a.load();
})["catch"](function(e) {
return t.init&&t.init!=a?(a=t.init, t.init.ready.then(function() {
return t.init.load();
})):Promise.reject(e);
})["catch"](function(e) {
if (e) {
var a=e instanceof XMLHttpRequest?e:e.xhr;if (a&&404==a.status) {
t.render(null);
}
else {
var n=t._("problem-loading");a&&(n+=a.status?t._("http-error", e):": "+t._("cant-connect")), t.error(n, e);
}
} return null;
}).then(function(e) {
return t.render(e);
}).then(function() {
t.inProgress=!1, requestAnimationFrame(function() {
t.dataLoaded.resolve(), e.fire(t.element, "mv-load");
});
})):Promise.resolve();
}, store:function() {
var e=this;return this.storage?(this.inProgress="Saving", this.storage.store(this.getData())["catch"](function(t) {
if (t) {
var a=e._("problem-saving");t instanceof XMLHttpRequest&&(a+=": "+(t.status?e._("http-error", t):e._("cant-connect"))), e.error(a, t);
} return null;
}).then(function(t) {
return e.inProgress=!1, t;
})):Promise.resolve();
}, upload:function(e) {
var t=this, a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"images/"+e.name;return this.uploadBackend?(this.inProgress=this._("uploading"), this.uploadBackend.upload(e, a).then(function(e) {
return t.inProgress=!1, e;
})["catch"](function(e) {
return t.error(t._("error-uploading"), e), t.inProgress=!1, null;
})):Promise.reject();
}, save:function() {
var t=this;return this.store().then(function(a) {
a&&(e.fire(t.element, "mv-save", a), t.lastSaved=Date.now(), t.root.save(), t.unsavedChanges=!1);
});
}, walk:function() {
var e;return (e=this.root).walk.apply(e, arguments);
}, calculateNeedsEdit:function() {
var e=!1;return this.walk(function(t) {
return !e&&(e=!t.modes&&!(t instanceof Mavo.Group), !t.modes);
}, void 0, {descentReturn:!0}), e;
}, changed:function(e) {
!this.root||this.expressions.active&&this.expressions.updateThrottled(e);
}, setDeleted:function() {
var e=this, t;this.deleted.forEach(function(e) {
return e.destroy();
}), this.deleted.length=[], this.deletionNotice&&this.deletionNotice.close();for (var a=arguments.length, n=Array(a), o=0;o<a;o++) {
n[o]=arguments[o];
} if (n.length) {
if ((t=this.deleted).push.apply(t, n), 1==n.length) {
var r=n[0].name;
}
else {
var i={}, s=[];for (var l in n.forEach(function(e) {
i[e.name]=(i[e.name]||0)+1;
}), i) {
s.push(this._("n-items", {name:l, n:i[l]}));
} var r=s.join(", ");
} var d=this.deletionNotice=this.message([this._("item-deleted", {name:r}), {tag:"button", type:"button", textContent:this._("undo"), events:{click:function() {
e.undoDelete(), e.deletionNotice.close(!0);
}}}], {classes:"mv-deleted", dismiss:{button:!0, timeout:2e4}});d.closed.then(function(t) {
!t&&e.deleted.length&&(e.deleted.forEach(function(e) {
return e.destroy();
}), e.deleted.length=0), e.deletionNotice==d&&(e.deletionNotice=null);
});
}
}, undoDelete:function() {
this.deleted.forEach(function(e) {
return e.collection.add(e, e.index);
}), this.deleted.length=0;
}, live:{inProgress:function(t) {
e.toggleAttribute(this.element, "mv-progress", t, t), e.toggleAttribute(this.element, "aria-busy", !!t, !!t), this.element.style.setProperty("--mv-progress-text", t?"\"".concat(this._(t), "\""):"");
}, unsavedChanges:function(e) {
this.element.classList.toggle("mv-unsaved-changes", e);
}, needsEdit:function(e) {
this.bar&&this.bar.toggle("edit", e&&this.permissions.edit);
}, storage:function(e) {
if (e!==this._storage&&!e) {
var t=new Mavo.Permissions({edit:!0, save:!1});t.parent=this.permissions.parent, this.permissions.parent=t;
}
}, primaryBackend:function(e) {
if (e=e||null, e!=this._primaryBackend) {
return e;
}
}, uploadBackend:{get:function() {
if (this.storage&&this.storage.upload) {
return this.storage;
}
}}}, static:{version:"v0.2.0", all:{}, get:function(e) {
if (e instanceof Element) {
for (var t in a.all) {
if (a.all[t].element==e) {
return a.all[t];
}
} return null;
} var t="number"==typeof e?Object.keys(a.all)[e]:e;return a.all[t]||null;
}, superKey:0===navigator.platform.indexOf("Mac")?"metaKey":"ctrlKey", base:"about:"==location.protocol?document.currentScript?document.currentScript.src:"http://mavo.io":location, dependencies:[e.ready().then(function() {
return a.Plugins.load();
})], polyfills:[], init:function() {
var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:document, n=Array.isArray(arguments[0])?arguments[0]:t(a.selectors.init, e), o=n.filter(function(e) {
return !a.get(e);
}).map(function(e) {
return new a(e);
});return o;
}, warn:function e(t) {
var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};e.history=e.history||new Set, a.warn.history.has(t)||console.warn(t), !1!==n.once&&e.history.add(t);
}, thenAll:function(n) {
return t(n).forEach(function(t) {
"promise"==e.type(t)&&(t=t["catch"](function(e) {
return e;
}));
}), Promise.all(n).then(function(e) {
return n.length==e.length?e:a.thenAll(n);
});
}, promise:function e(t) {
var e=new Promise(function(e, a) {
t&&t(e, a), n=e, o=a;
}), n, o;return e.resolve=function(t) {
return n(t), e;
}, e.reject=function(t) {
return o(t), e;
}, e;
}, defer:function(e) {
return new Promise(function(t) {
return void 0===e?requestAnimationFrame(t):setTimeout(t, e);
});
}, UI:{}, hooks:new e.Hooks, properties:new Set, attributes:["mv-app", "mv-storage", "mv-source", "mv-init", "mv-path", "mv-multiple-path", "mv-format", "mv-attribute", "mv-default", "mv-mode", "mv-edit", "mv-permisssions", "mv-rel", "mv-value"], lazy:{locale:function() {
return document.documentElement.lang||"en-GB";
}}}});["toNode", "isProxy", "route", "parent", "property", "mavo", "groupedBy", "as"].forEach(function(t) {
e.lazy(a, t, function() {
return Symbol(t);
});
}), Object.defineProperty(a.all, "length", {get:function() {
return Object.keys(this).length;
}}); {var n=a.selectors={init:"[mv-app], [data-mv-app]", property:"[property]", specificProperty:function(e) {
return "[property=".concat(e, "]");
}, group:"[typeof], [mv-group]", primitive:"[property]:not([typeof]):not([mv-group])", childGroup:"[typeof][property], [mv-group][property]", multiple:"[mv-multiple]", formControl:"input, select, option, textarea", textInput:["text", "email", "url", "tel", "search", "number"].map(function(e) {
return "input[type=".concat(e, "]");
}).join(", ")+", input:not([type]), textarea", ui:".mv-ui", container:{tr:"table", option:"select"}};e.extend(a.selectors, {item:n.multiple+", "+n.group, output:n.specificProperty("output")+", .mv-output"});}e.each({blissfuljs:Array.from&&document.documentElement.closest&&self.URL&&"searchParams"in URL.prototype, "Intl.~locale.en":self.Intl, IntersectionObserver:self.IntersectionObserver, Symbol:self.Symbol, "Element.prototype.remove":Element.prototype.remove, "Element.prototype.before":Element.prototype.before, "Element.prototype.after":Element.prototype.after, "Element.prototype.prepend":Element.prototype.prepend}, function(e, t) {
t||a.polyfills.push(e);
}), a.dependencies.push(a.defer().then(function() {
var n="https://cdn.polyfill.io/v2/polyfill.min.js?unknown=polyfill&features="+a.polyfills.map(function(e) {
return e+"|gated";
}).join(",");a.dependencies.push(e.include(!a.polyfills.length, n)), e.ready().then(function() {
return t(a.selectors.init).forEach(function(e) {
a.get(e)||e.setAttribute("mv-progress", "Loading");
}), a.ready;
})["catch"](console.error).then(function() {
a.init(), a.inited.resolve();
});
})), a.ready=a.thenAll(a.dependencies), a.inited=a.promise(), Stretchy.selectors.filter=".mv-editor:not([property]), .mv-autosize", self.$=self.$||e, self.$$=self.$$||t;
})(Bliss, Bliss.$), function(e, t) {
function a() {
var e=n.getTarget(), a="mv-target-within";for (t("."+a).forEach(function(e) {
return e.classList.remove(a);
});e&&e.classList;) {
e.classList.add(a), e=e.parentNode;
}
} var n=e.extend(Mavo, {load:function(t) {
var a=1<arguments.length&&arguments[1]!==void 0?arguments[1]:document.currentScript?document.currentScript.src:location;return e.load(t, a);
}, readFile:function(e) {
var t=1<arguments.length&&arguments[1]!==void 0?arguments[1]:"DataURL", a=new FileReader;return new Promise(function(n, o) {
a.onload=function() {
return n(a.result);
}, a.onerror=a.onabort=o, a["readAs"+t](e);
});
}, toJSON:function(e) {
return null===e?"":"string"==typeof e?e:JSON.stringify(e, null, "\t");
}, safeToJSON:function(e) {
var t=self.WeakSet?new WeakSet:new Set;return JSON.stringify(e, function(e, a) {
if ("object"===_typeof(a)&&null!==a) {
if (t.has(a)) {
return;
}t.add(a);
} return a;
});
}, primitivify:function(e, t) {
return e&&(t&&"object"===_typeof(t)&&(Object.assign(e, t), t=Mavo.value(t)), e.valueOf=e.toJSON=e[Symbol.toPrimitive]=function() {
return t;
}), e;
}, objectify:function(t, a) {
var o=Mavo.value(t);if ("object"!==_typeof(t)||null===t) {
if (null===t) {
var r;t=(r={}, _defineProperty(r, Symbol.toStringTag, "Null"), _defineProperty(r, "toJSON", function() {
return null;
}), r);
}
else {
var i=t.constructor;t=new i(o), t[Symbol.toStringTag]=i.name;
}n.primitivify(t, o);
} return e.extend(t, a);
}, value:function(e) {
return e&&e.valueOf?e.valueOf():e;
}, toArray:function(e) {
return e===void 0?[]:Array.isArray(e)?e:[e];
}, delete:function(e, t, a) {
do {
var n=e&&e.indexOf(t);-1<n&&e.splice(n, 1);
} while (-1<n&&a);
}, flatten:function(e) {
return Array.isArray(e)?e.reduce(function(e, t) {
return n.toArray(e).concat(n.flatten(t));
}, []):[e];
}, pushUnique:function(e, t) {
-1===e.indexOf(t)&&e.push(t);
}, union:function(e, t) {
return e instanceof Set&&t?(t.forEach(function(t) {
return e.add(t);
}), e):new Set([].concat(_toConsumableArray(e||[]), _toConsumableArray(t||[])));
}, filter:function(e, t) {
for (var a=0;a<e.length;a++) {
t(e[a])||(e.splice(a, 1), a--);
}
}, is:function(e) {
for (var t=0, a;t<(1>=arguments.length?0:arguments.length-1);t++) {
if (a=1>t+1||arguments.length<=t+1?void 0:arguments[t+1], a&&a.matches&&a.matches(n.selectors[e])) {
return !0;
}
} return !1;
}, getStyle:function(e, t) {
if (e) {
var a=getComputedStyle(e).getPropertyValue(t);if (a) {
return a.trim();
}
}
}, data:function e(t, a, o) {
if (!t) {
return null;
} var e=n.elementData.get(t)||{}, r;return 2==arguments.length?r=e[a]:void 0===o?delete e[a]:r=e[a]=o, n.elementData.set(t, e), r;
}, elementData:new WeakMap, elementPath:function(e, t) {
if (Array.isArray(t)) {
var a=t, n=a.reduce(function(e, t) {
return e.children[t>>0]||e;
}, e), o=a[a.length-1];if (o!=o>>0) {
var r=+(o+"").split(".")[1];0>o>>0&&(n=n.firstChild, r--);for (var s=0;s<r;s++) {
n=n.nextSibling;
}
} return n;
} for (var a=[], l=t;l&&l!=e;l=l.parentNode) {
for (var d=0, c=l===t&&1!==t.nodeType, r=c?1:0, p=l;p=p["previous".concat(c?"":"Element", "Sibling")];) {
c?(r++, 1==p.nodeType&&(c=!1)):d++;
}0<r&&(d=d-1+"."+r), a.unshift(d);
} return l?a:null;
}, revocably:{add:function(e, t) {
var a=n.revocably.isRemoved(e);return a&&a.parentNode?a.parentNode.replaceChild(e, a):e&&t&&!e.parentNode&&("function"==typeof t?t(e):t.appendChild(e)), a;
}, remove:function(e, t) {
if (e) {
var a=n.data(e, "commentstub");return a||(t=t||e.id||e.className||e.nodeName, a=n.data(e, "commentstub", document.createComment(t))), e.parentNode&&e.parentNode.replaceChild(a, e), a;
}
}, isRemoved:function(e) {
if (!e||e.parentNode) {
return !1;
} var t=n.data(e, "commentstub");return !!(t&&t.parentNode)&&t;
}, setAttribute:function(e, t, a) {
var o=n.data(e, "attribute-"+t);o===void 0&&n.data(e, "attribute-"+t, e.getAttribute(t)), e.setAttribute(t, a);
}, restoreAttribute:function(t, a) {
var o=n.data(t, "attribute-"+a);o!==void 0&&(e.toggleAttribute(t, a, o), n.data(t, "attribute-"+a, void 0));
}}, inView:{is:function(e) {
var t=e.getBoundingClientRect();return (0<=t.bottom&&t.bottom<=innerHeight||0<=t.top&&t.top<=innerHeight)&&(0<=t.right&&t.right<=innerWidth||0<=t.left&&t.left<=innerWidth);
}, when:function(t) {
var a=n.inView.observer=n.inView.observer||new IntersectionObserver(function(t) {
var a=this;t.forEach(function(t) {
a.unobserve(t.target), e.fire(t.target, "mv-inview", {entry:t});
});
});return new Promise(function(e) {
n.is(t)&&e(), a.observe(t);t.addEventListener("mv-inview", function a(n) {
t.removeEventListener("mv-inview", a), n.stopPropagation(), e();
});
});
}}, scrollIntoViewIfNeeded:function(e) {
e&&!Mavo.inView.is(e)&&e.scrollIntoView({behavior:"smooth"});
}, setAttributeShy:function(e, t, a) {
e.hasAttribute(t)||e.setAttribute(t, a);
}, getAttribute:function(e) {
for (var t=0, a, n;a=1>t+1||arguments.length<=t+1?void 0:arguments[t+1];t++) {
if (n=e.getAttribute(a), n) {
return n;
}
} return null;
}, getClosestAttribute:function(e, t) {
return e=e.closest("[".concat(t, "]")), e?e.getAttribute(t):null;
}, getTarget:function() {
var e=location.hash.substr(1);return document.getElementById(e);
}, XPath:function(e) {
var t=1<arguments.length&&arguments[1]!==void 0?arguments[1]:document, a=t.ownerDocument||t, n=[], o;if (a.evaluate) {
for (var r=a.evaluate(e, t, null, XPathResult.ANY_TYPE, null);o=r.iterateNext();) {
n.push(o);
}
} return n;
}, attributeStartsWith:function(e, t) {
return n.XPath(".//@*[starts-with(name(), \"".concat(e, "\")]"), t);
}, in:function(e, t) {
if (t) {
return "object"===_typeof(t)&&e in t||void 0!==t[e];
}
}, getCanonicalProperty:function(e, t) {
if (e&&(t||0===t)) {
if (n["in"](t, e)) {
return t;
} if (t.toLowerCase) {
var a=t.toLowerCase();if (n["in"](a, e)) {
return a;
} var o=Object.keys(e), r=o.map(function(e) {
return e.toLowerCase();
}).indexOf(a);if (-1<r) {
return o[r];
}
}
}
}, subset:function(t, a, n) {
if (3==arguments.length) {
if (a.length) {
var o=a[a.length-1], r=e.value.apply(e, [t].concat(_toConsumableArray(a.slice(0, -1))));return Array.isArray(r)&&Array.isArray(n)?r.splice.apply(r, [o, 1].concat(_toConsumableArray(n))):r&&(r[a[a.length-1]]=n), t;
} return n;
} return "object"==_typeof(t)&&a&&a.length?a.reduce(function(e, t, n) {
var o={}, r=Mavo.Functions.get(e, t, o);return a[n]=Array.isArray(o.property)?o.property[0]:o.property, void 0===r&&o.query&&(r=_defineProperty({}, o.query.property, o.query.value)), r;
}, t):t;
}, clone:function(e) {
return e&&"object"===_typeof(e)?JSON.parse(n.safeToJSON(e)):e;
}, shallowClone:function(t) {
return t&&"object"===_typeof(t)?Array.isArray(t)?_toConsumableArray(t):e.extend({}, t):t;
}, debounce:function(e, t) {
if (!t) {
return e;
} var a=null, n;return function() {
var o=this, r=arguments;n=function() {
e.apply(o, r), removeEventListener("beforeunload", n);
}, clearTimeout(a), a=setTimeout(n, t), addEventListener("beforeunload", n);
};
}, escapeRegExp:function(e) {
return e.replace(/[-\/\\^$*+?.()|[\]{}]/g, "\\$&");
}, matches:function(e, t) {
var a=(e+"").match(t);return a?a:[];
}, match:function(e, t) {
var a=2<arguments.length&&arguments[2]!==void 0?arguments[2]:0;return n.matches(e, t)[a]||"";
}, observeResize:function(e, t) {
if (self.ResizeObserver) {
var a=null, n=t instanceof ResizeObserver?t:new ResizeObserver(function(e) {
var n=e[e.length-1].contentRect;a&&a.width==n.width&&a.height==n.height||(t(e), a=n);
});return n.observe(e), n;
}
}, Observer:e.Class({constructor:function(e, t, a) {
var n=3<arguments.length&&arguments[3]!==void 0?arguments[3]:{};a instanceof MutationObserver&&(this.observer=a), this.observer=this.observer||new MutationObserver(a), this.callback=a, this.update(e, t, n), this.run();
}, update:function(t, a, n) {
this.element=t, this.attribute=a, this.options=e.extend({}, n), this.attribute&&e.extend(this.options, {attributes:!0, attributeFilter:"all"==this.attribute?void 0:Mavo.toArray(this.attribute), attributeOldValue:!!n.oldValue}), this.attribute&&"all"!=this.attribute||e.extend(this.options, {characterData:!0, childList:!0, subtree:!0, characterDataOldValue:!!n.oldValue}), this.observer&&this.observer.running&&(this.stop(), this.run());
}, stop:function() {
return this.observer&&this.observer.disconnect(), this.running=!1, this;
}, run:function() {
return this.observer&&(this.observer.observe(this.element, this.options), this.running=!0), this;
}, sneak:function(e) {
if (this.running) {
this.stop();var t=e();this.run();
}
else {
var t=e();
} return t;
}, destroy:function() {
this.stop(), this.observer=this.element=null;
}, static:{sneak:function(e, t) {
return e?e.sneak(t):t();
}}}), rr:function(e) {
return e(), e;
}, wrap:function(e, t) {
return 0>e?t-1:e>=t?0:e;
}, options:function(e) {
var t={};return (e.trim().match(/(?:\\[,;]|[^,;])+/g)||[]).forEach(function(e) {
if (e) {
e=e.trim().replace(/\\([,;])/g, "$1");var a=e.match(/^\s*((?:\\:|[^:])+?)\s*:\s*(.+)$/);a?t[a[1].replace(/\\:/g, ":")]=a[2]:t[e]=!0;
}
}), t;
}, BucketMap:function() {
function e() {
var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}, a=t.arrays;_classCallCheck(this, e), this.map=new Map, this[Symbol.iterator]=this.map[Symbol.iterator], this.arrays=void 0!==a&&a;
} return _createClass(e, [{key:"set", value:function(e, t) {
if (this.arrays) {
var a=this.map.get(e)||[];a.push(t);
}
else {
var a=this.map.get(e)||new Set;a.add(t);
} this.map.set(e, a);
}}, {key:"delete", value:function(e, t) {
if (2==arguments.length) {
var a=this.map.get(e);a&&(this.arrays?n["delete"](a, t):a["delete"](t));
}
else {
this.map["delete"](e);
}
}}, {key:"forEach", value:function() {
var e;return (e=this.map).forEach.apply(e, arguments);
}}]), e;
}()});e.proxy=e.classProps.proxy=e.overload(function(e, t, a) {
return Object.defineProperty(e, t, {get:function() {
return this[a][t];
}, set:function(e) {
this[a][t]=e;
}, configurable:!0, enumerable:!0}), e;
});document.addEventListener("mv-load", a), addEventListener("hashchange", a);new Mavo.Observer(document.documentElement, "id", a, {subtree:!0});
}(Bliss, Bliss.$), function(e, t) {
var a=Mavo.Locale=e.Class({constructor:function(e, t) {
this.lang=e, this.phrases={}, this.extend(t);
}, get fallback() {
return a.all[this.baseLang]?a.all[this.baseLang]:this===a["default"]?void 0:a["default"];
}, extend:function(t) {
e.extend(this.phrases, t);
}, phrase:function e(t, a) {
var n=t.toLowerCase(), e=this.phrases[n];if (void 0===e&&this.fallback&&(e=this.fallback.phrase(n)), void 0===e) {
e=n.replace(/\b-\b/g, " ");
}
else if (a) {
var o=Mavo.matches(e, /\{\w+(?=\})/g).map(function(e) {
return e.slice(1);
});Mavo.Functions.unique(o).forEach(function(t) {
t in a&&(e=e.replace(RegExp("{".concat(t, "}"), "gi"), a[t]));
});
} return e;
}, live:{lang:function(e) {
this.baseLang=a.getBaseLang(e), e==this.baseLang&&(this.baseLang=null);
}}, static:{all:{}, register:function(e, t) {
a.all[e]?a.all[e].extend(t):a.all[e]=new a(e, t);
}, match:function() {
var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"";return a.all[e]||a.all[a.getBaseLang(e)];
}, get:function(e) {
return a.match(e)||a["default"];
}, getBaseLang:function(e) {
return e.split("-")[0];
}, lazy:{default:function() {
return a.match(Mavo.locale)||a.all.en;
}}}});Mavo.prototype._=function(e, t) {
return this.locale&&e?this.locale.phrase(e, t):e;
}, Mavo.ready.then(function() {
t("datalist.mv-phrases[lang]").forEach(function(e) {
var a=t("option", e).reduce(function(e, t) {
return e[t.value]=t.textContent.trim(), e;
}, {});Mavo.Locale.register(e.lang, a);
});
});
}(Bliss, Bliss.$), Mavo.Locale.register("en", {second:"second", seconds:"seconds", minute:"minute", minutes:"minutes", hour:"hour", hours:"hours", day:"day", days:"days", week:"week", weeks:"weeks", month:"month", months:"months", year:"year", years:"years", edit:"Edit", editing:"Editing", save:"Save", import:"Import", export:"Export", logout:"Logout", login:"Login", loading:"Loading", uploading:"Uploading", saving:"Saving", dismiss:"Dismiss", "logged-in-as":"Logged in to {id} as ", "login-to":"Login to {id}", "error-uploading":"Error uploading file", "cannot-load-uploaded-file":"Cannot load uploaded file", filename:"Filename?", "problem-saving":"Problem saving data", "problem-loading":"Problem loading data", "cannot-parse":"Can\u2019t understand this file", "http-error":"HTTP error {status}: {statusText}", "cant-connect":"Can\u2019t connect to the Internet", "add-item":"Add {name}", "add-item-before":"Add new {name} before", "add-item-after":"Add new {name} after", "drag-to-reorder":"Drag to reorder {name}", "delete-item":"Delete this {name}", "item-deleted":"{name} deleted", "n-items":"{n} {name} items", undo:"Undo", "gh-updated-file":"Updated {name}", "gh-edit-suggestion-saved-in-profile":"Your edits are saved to <a href=\"{previewURL}\" target=\"_blank\">your own profile</a>, because you are not allowed to edit this page.", "gh-edit-suggestion-instructions":"Write a short description of your edits below to suggest them to the page admins:", "gh-edit-suggestion-notreviewed":"You have selected to suggest your edits to the page admins. Your suggestions have not been reviewed yet.", "gh-edit-suggestion-send":"Send edit suggestion", "gh-edit-suggestion-revoke":"Revoke edit suggestion", "gh-edit-suggestion-reason-placeholder":"I added / corrected / deleted ...", "gh-edit-suggestion-cancelled":"Edit suggestion cancelled successfully!", "gh-edit-suggestion-title":"Suggested edits to data", "gh-edit-suggestion-body":"Hello there! I used Mavo to suggest the following edits:\n{description}\nPreview my changes here: {previewURL}", "gh-edit-suggestion-sent":"Edit suggestion sent successfully!", "gh-login-fork-options":"You have your own copy of this page, would you like to use it?", "gh-use-my-fork":"Yes, show me my data."}), function(e, t) {
Mavo.attributes.push("mv-plugins");var a=Mavo.Plugins={loaded:{}, load:function() {
return a.plugins=new Set, t("[mv-plugins]").forEach(function(e) {
e.getAttribute("mv-plugins").trim().split(/\s+/).forEach(function(e) {
return a.plugins.add(e);
});
}), a.plugins.size?e.fetch(a.url+"/plugins.json", {responseType:"json"}).then(function(t) {
return Mavo.thenAll(t.response.plugin.filter(function(e) {
return a.plugins.has(e.id);
}).map(function(t) {
var n="mavo-".concat(t.id, ".js");if (t.repo) {
var o="https://raw.githubusercontent.com/".concat(t.repo, "/master/").concat(n);return a.loaded[t.id]?Promise.resolve():e.fetch(o).then(function(t) {
e.create("script", {textContent:t.responseText, inside:document.head});
});
} var o="".concat(a.url, "/").concat(t.id, "/").concat(n);return e.include(a.loaded[t.id], o);
}));
}):Promise.resolve();
}, register:function(t) {
var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if (!a.loaded[t]) {
for (var o in Mavo.hooks.add(n.hooks), n.extend) {
var r="Mavo"==o?Mavo:Mavo[o];"function"===e.type(r)?e.Class(r, n.extend[o]):e.extend(r, n.extend[o]);
} var i=[];if (n.ready&&i.push(n.ready), n.dependencies) {
var s=document.currentScript?document.currentScript.src:location, l=n.dependencies.map(function(e) {
return Mavo.load(e, s);
});i.push.apply(i, _toConsumableArray(l));
} if (i.length) {
var d;(d=Mavo.dependencies).push.apply(d, i);
}a.loaded[t]=n, n.init&&Promise.all(i).then(function() {
return n.init();
});
}
}, url:"https://plugins.mavo.io"};
}(Bliss, Bliss.$), function(e, t) {
var a=Math.max;Mavo.attributes.push("mv-bar");var n=Mavo.UI.Bar=e.Class({constructor:function(t) {
var a=this;if (this.mavo=t, this.element=e(".mv-bar", this.mavo.element), this.template=this.mavo.element.getAttribute("mv-bar")||"", this.element) {
for (var o in this.custom=!0, this.template+=" "+(this.element.getAttribute("mv-bar")||""), this.template=this.template.trim(), n.controls) {
this[o]=e(".mv-".concat(o), this.element), this[o]&&(this.template=this.template||"with", this.template+=" ".concat(o));
}
}
else {
this.element=e.create({className:"mv-bar mv-ui", start:this.mavo.element, innerHTML:"<button>&nbsp;</button>"});
} this.element.classList.contains("mv-compact")&&(this.noResize=!0), this.controls=n.getControls(this.template), this.controls.length&&(this.targetHeight=this.element.offsetHeight), this.custom||(this.element.innerHTML=""), this.controls.forEach(function(t) {
var r=n.controls[t];for (var o in a[t]&&a[t].remove(), r.create?a[t]=r.create.call(a.mavo, a[t]):!a[t]&&(a[t]=e.create("button", {type:"button", className:"mv-".concat(t), textContent:a.mavo._(t)})), a.add(t), r.permission?a.permissions.can(r.permission, function() {
a.toggle(t, !r.condition||r.condition.call(a.mavo));
}, function() {
a.remove(t);
}):r.condition&&!r.condition.call(a.mavo)&&a.remove(t), r.events) {
e.bind(a[t], o, r.events[o].bind(a.mavo));
}
});var r=function(t) {
var r=n.controls[t];r.action&&e.delegate(a.mavo.element, "click", ".mv-"+t, function(e) {
(!r.permission||a.permissions.is(r.permission))&&(r.action.call(a.mavo), e.preventDefault());
});
};for (var i in n.controls) {
r(i);
} this.controls.length&&!this.noResize&&(this.resize(), self.ResizeObserver&&(this.resizeObserver=Mavo.observeResize(this.element, function() {
a.resize();
})));
}, resize:function() {
return this.targetHeight?void(this.resizeObserver&&this.resizeObserver.disconnect(), this.element.classList.remove("mv-compact", "mv-tiny"), t("button, .mv-button", this.element).forEach(function(e) {
e.title===e.textContent&&(e.title="");
}), this.element.offsetHeight>1.6*this.targetHeight&&(this.element.classList.add("mv-compact"), this.element.offsetHeight>1.2*this.targetHeight&&(this.element.classList.add("mv-tiny"), t("button, .mv-button", this.element).forEach(function(e) {
e.title||(e.title=e.textContent);
}))), this.resizeObserver&&this.resizeObserver.observe(this.element)):void(this.targetHeight=this.element.offsetHeight);
}, add:function(e) {
var t=this, a=n.controls[e];a.prepare&&a.prepare.call(this.mavo), Mavo.revocably.add(this[e], this.element), this.resizeObserver||this.noResize||requestAnimationFrame(function() {
return t.resize();
});
}, remove:function(e) {
var t=this, a=n.controls[e];Mavo.revocably.remove(this[e], "mv-"+e), a.cleanup&&a.cleanup.call(this.mavo), this.resizeObserver||this.noResize||requestAnimationFrame(function() {
return t.resize();
});
}, toggle:function(e, t) {
return this[t?"add":"remove"](e);
}, proxy:{permissions:"mavo"}, static:{getControls:function(e) {
var t=Object.keys(n.controls);if (e&&(e=e.trim())) {
if ("none"==e) {
return [];
} var o=/^with\s|\b(yes|no)-\w+\b/.test(e);e=e.replace(/\byes-|^with\s+/g, "");var r=e.split(/\s+/);return r=Mavo.Functions.unique(r.reverse()).reverse(), o?t.filter(function(e) {
var t=r.lastIndexOf(e), o=r.lastIndexOf("no-"+e), i=t>a(-1, o), s=o>a(-1, t);return i||!n.controls[e].optional&&!s;
}):r;
} return t.filter(function(e) {
return !n.controls[e].optional;
});
}, controls:{status:{create:function(t) {
return t||e.create({className:"mv-status"});
}, prepare:function() {
var t=this.primaryBackend;if (t&&t.user) {
var a=t.user, n=[a.name||""];a.avatar&&n.unshift(e.create("img", {className:"mv-avatar", src:a.avatar}), " "), a.url&&(n=[e.create("a", {href:a.url, target:"_blank", contents:n})]), this.bar.status.textContent="", e.contents(this.bar.status, [{tag:"span", innerHTML:this._("logged-in-as", t)}, " "].concat(_toConsumableArray(n)));
}
}, permission:"logout"}, edit:{action:function() {
this.editing?(this.done(), this.bar.edit.textContent=this._("edit")):(this.edit(), this.bar.edit.textContent=this._("editing"));
}, permission:["edit", "add", "delete"], cleanup:function() {
this.editing&&(this.done(), this.bar&&this.bar.edit&&(this.bar.edit.textContent=this._("edit")));
}, condition:function() {
return this.needsEdit;
}}, save:{action:function() {
this.save();
}, events:{"mouseenter focus":function() {
this.element.classList.add("mv-highlight-unsaved");
}, "mouseleave blur":function() {
this.element.classList.remove("mv-highlight-unsaved");
}}, permission:"save", condition:function() {
return !this.autoSave||0<this.autoSaveDelay;
}}, export:{create:function(t) {
var n;return n=t?t.matches("a")?t:e.create("a", {className:"mv-button", around:t}):e.create("a", {className:"mv-export mv-button", textContent:this._("export")}), n.setAttribute("download", this.id+".json"), n;
}, events:{mousedown:function() {
this.bar["export"].href="data:application/json;charset=UTF-8,"+encodeURIComponent(this.toJSON());
}}, permission:"edit", optional:!0}, import:{create:function(t) {
var a=this, n=t||e.create("span", {role:"button", tabIndex:"0", className:"mv-import mv-button", textContent:this._("import"), events:{focus:function() {
o.focus();
}}}), o=e.create("input", {type:"file", inside:n, events:{change:function(t) {
var n=t.target.files[0];if (n) {
var o=e.extend(new FileReader, {onload:function() {
a.inProgress=!1;try {
var e=JSON.parse(o.result);a.render(e);
}
catch (t) {
a.error(a._("cannot-parse"));
}
}, onerror:function() {
a.error(a._("problem-loading"));
}});a.inProgress=a._("uploading"), o.readAsText(n);
}
}}});return n;
}, optional:!0}, login:{action:function() {
this.primaryBackend.login();
}, permission:"login"}, logout:{action:function() {
this.primaryBackend.logout();
}, permission:"logout"}}}});
}(Bliss, Bliss.$), function(e) {
Mavo.UI.Message=e.Class({constructor:function(t, a) {
var n=this, r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{}, o;if (this.mavo=t, this.message=a, this.closed=Mavo.promise(), this.options=r, this.element=e.create((o={className:"mv-ui mv-message"+(r.type?" mv-"+r.type:"")}, _defineProperty(o, "string"==e.type(this.message)?"innerHTML":"contents", this.message), _defineProperty(o, "events", {click:function() {
return Mavo.scrollIntoViewIfNeeded(n.mavo.element);
}}), _defineProperty(o, this.mavo.bar?"after":"start", (this.mavo.bar||this.mavo).element), o)), r.style&&e.style(this.element, r.style), r.classes) {
var i;(i=this.element.classList).add.apply(i, _toConsumableArray(r.classes.split(/\s+/)));
} if ("error"==r.type?this.element.setAttribute("role", "alert"):this.element.setAttribute("aria-live", "polite"), r.dismiss=r.dismiss||{}, "string"==typeof r.dismiss||Array.isArray(r.dismiss)) {
var s={};Mavo.toArray(r.dismiss).forEach(function(e) {
s[e]=!0;
}), r.dismiss=s;
} if (r.dismiss.button&&e.create("button", {type:"button", className:"mv-close mv-ui", textContent:"\xD7", events:{click:function() {
return n.close();
}}, start:this.element, title:this.mavo._("dismiss")}), r.dismiss.timeout) {
var l="number"==typeof r.dismiss.timeout?r.dismiss.timeout:5e3;e.bind(this.element, {mouseenter:function() {
return clearTimeout(n.closeTimeout);
}, mouseleave:Mavo.rr(function() {
return n.closeTimeout=setTimeout(function() {
return n.close();
}, l);
})});
}r.dismiss.submit&&this.element.addEventListener("submit", function(e) {
e.preventDefault(), n.close(e.target);
});
}, close:function(t) {
var a=this;clearTimeout(this.closeTimeout);var n=this.element.style.transition?1e3*parseFloat(window.getComputedStyle(this.element, null).transitionDuration):400;e.transition(this.element, {opacity:0}, n).then(function() {
e.remove(a.element), a.closed.resolve(t);
});
}});
}(Bliss, Bliss.$), function(e) {
var t=Mavo.Permissions=e.Class({constructor:function(a) {
this.triggers=[], this.hooks=new e.Hooks, this.parentChanged=t.prototype.parentChanged.bind(this), this.set(a);
}, set:function(e) {
for (var t in e) {
this[t]=e[t];
}
}, on:function(e) {
var t=this;return Mavo.toArray(e).forEach(function(e) {
return t[e]=!0;
}), this;
}, off:function(e) {
var t=this;return e=Array.isArray(e)?e:[e], e.forEach(function(e) {
return t[e]=!1;
}), this;
}, can:function(e, t, a) {
this.observe(e, !0, t), a&&this.cannot(e, a);
}, cannot:function(e, t) {
this.observe(e, !1, t);
}, observe:function(e, t, a) {
e=Mavo.toArray(e), this.is(e, t)&&a(), this.triggers.push({actions:e, value:t, callback:a, active:!0});
}, is:function(e) {
var t=this, a=!(1<arguments.length&&arguments[1]!==void 0)||arguments[1], n=Mavo.toArray(e).map(function(e) {
return !!t[e];
}).reduce(function(e, t) {
return e||t;
});return a?n:!n;
}, onchange:function(e) {
var a=this;this.hooks.add("change", e), t.actions.forEach(function(t) {
e.call(a, {action:t, value:a[t]});
});
}, parentChanged:function() {
var t=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{}, a=this["_"+t.action];void 0!==a||t.from==t.value||(this.fireTriggers(t.action), this.hooks.run("change", e.extend({context:this}, t)));
}, changed:function(e, t, a) {
a=!!a, t=!!t;t==a||(this["_"+e]=t, this.fireTriggers(e), this.hooks.run("change", {action:e, value:t, from:a, context:this}));
}, fireTriggers:function(e) {
var t=this;this.triggers.forEach(function(a) {
var n=t.is(a.actions, a.value);a.active&&-1<a.actions.indexOf(e)&&n?(a.active=!1, a.callback()):!n&&(a.active=!0);
});
}, or:function(e) {
var a=this;return t.actions.forEach(function(t) {
a[t]=a[t]||e[t];
}), this;
}, live:{parent:function(e) {
var a=this, n=this._parent;n==e||(this._parent=e, n&&Mavo["delete"](n.hooks.change, this.parentChanged), t.actions.forEach(function(t) {
a.parentChanged({action:t, value:e?e[t]:void 0, from:n?n[t]:void 0});
}), e&&e.onchange(this.parentChanged));
}}, static:{actions:[], register:function(a, n) {
return Array.isArray(a)?void a.forEach(function(e) {
return t.register(e, n);
}):void(e.live(t.prototype, a, {get:function() {
var e=this["_"+a];return void 0===e&&this.parent?this.parent[a]:e;
}, set:function(e, t) {
n&&n.call(this, e, t), this.changed(a, e, t);
}}), t.actions.push(a));
}}});t.register(["read", "save"]), t.register("login", function(e) {
e&&this.logout&&(this.logout=!1);
}), t.register("logout", function(e) {
e&&this.login&&(this.login=!1);
}), t.register("edit", function(e) {
e&&(this.add=this["delete"]=!0);
}), t.register(["add", "delete"], function(e) {
e||(this.edit=!1);
});
}(Bliss, Bliss.$), function(e) {
var t=Math.min, a=Mavo.Backend=e.Class({constructor:function(e) {
var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};this.update(e, t), this.permissions=new Mavo.Permissions;
}, update:function(e) {
var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};this.source=e, this.url=new URL(this.source, Mavo.base), this.mavo=t.mavo, this.format=Mavo.Formats.create(t.format, this);
}, get:function() {
var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:new URL(this.url);return "data:"!=t.protocol&&t.searchParams.set("timestamp", Date.now()), e.fetch(t.href).then(function(e) {
return Promise.resolve(e.responseText);
}, function() {
return Promise.resolve(null);
});
}, load:function() {
var e=this;return this.ready.then(function() {
return e.get();
}).then(function(t) {
return "string"==typeof t?(t=t.replace(/^\ufeff/, ""), e.format.parse(t)):t;
});
}, store:function(e) {
var t=this, a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}, n=a.path, o=a.format, r=void 0===o?this.format:o;return this.ready.then(function() {
var a="string"==typeof e?Promise.resolve(e):r.stringify(e);return a.then(function(a) {
return t.put(a, n).then(function() {
return {data:e, serialized:a};
});
});
});
}, ready:Promise.resolve(), login:function() {
return Promise.resolve();
}, logout:function() {
return Promise.resolve();
}, put:function() {
return Promise.reject();
}, isAuthenticated:function() {
return !!this.accessToken;
}, oAuthParams:function() {
return "";
}, toString:function() {
return "".concat(this.id, " (").concat(this.url, ")");
}, equals:function(e) {
return e===this||e&&this.id==e.id&&this.source==e.source;
}, request:function(t, a) {
var n=this, o=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"GET", r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{};if (r=e.extend({}, r), r.method=r.method||o, r.responseType=r.responseType||"json", r.headers=e.extend({"Content-Type":"application/json; charset=utf-8"}, r.headers||{}), this.isAuthenticated()&&(r.headers.Authorization=r.headers.Authorization||"Bearer ".concat(this.accessToken)), r.data=a, t=new URL(t, this.constructor.apiDomain), "GET"==r.method&&t.searchParams.set("timestamp", Date.now()), "object"===e.type(r.data)) {
if ("GET"==r.method) {
for (var i in r.data) {
var s=void 0===r.data[i]?"delete":"set";t.searchParams[s](i, r.data[i]);
} delete r.data;
}
else {
r.data=JSON.stringify(r.data);
}
} return e.fetch(t, r)["catch"](function(e) {
return e&&e.xhr?Promise.reject(e.xhr):void n.mavo.error("Something went wrong while connecting to "+n.id, e);
}).then(function(e) {
return "HEAD"==r.method?e:e.response;
});
}, oAuthenticate:function(e) {
var a=this;return this.ready.then(function() {
return a.isAuthenticated()?Promise.resolve():new Promise(function(n, o) {
var r=a.id.toLowerCase();if (e) {
a.accessToken=localStorage["mavo:".concat(r, "token")], a.accessToken&&n(a.accessToken);
}
else {
var i={width:t(1e3, innerWidth-100), height:t(800, innerHeight-100)};i.top=(screen.height-i.height)/2, i.left=(screen.width-i.width)/2;var s={url:location.href, backend:a.id};(a.authPopup=open("".concat(a.constructor.oAuth, "?client_id=").concat(a.key, "&state=").concat(encodeURIComponent(JSON.stringify(s)))+a.oAuthParams(), "popup", "width=".concat(i.width, ",height=").concat(i.height, ",left=").concat(i.left, ",top=").concat(i.top)), !a.authPopup)&&(a.mavo.error("Login popup was blocked! Please check your popup blocker settings."), o(Error("Login popup was blocked! Please check your popup blocker settings."))), addEventListener("message", function(e) {
if (e.source===a.authPopup) {
for (var t in e.data.backend==a.id&&(a.accessToken=localStorage["mavo:".concat(r, "token")]=e.data.token), a.accessToken||o(Error("Authentication error")), n(a.accessToken), Mavo.all) {
var i=Mavo.all[t].primaryBackend;i&&i.id===a.id&&i!==a&&!i.isAuthenticated()&&i.login(!0);
}
}
});
}
});
});
}, oAuthLogout:function() {
if (this.isAuthenticated()) {
var t=this.id.toLowerCase();localStorage.removeItem("mavo:".concat(t, "token")), delete this.accessToken, this.permissions.off(["edit", "add", "delete", "save"]).on("login"), e.fire(this.mavo.element, "mv-logout", {backend:this});
} return Promise.resolve();
}, static:{create:function(e, t, n, o) {
var r;return n&&(r=Mavo.Functions.get(a, n)), e&&!r&&(r=a.types.filter(function(t) {
return t.test(e);
})[0]||a.Remote), r&&o&&o.constructor===r&&o.constructor.prototype.hasOwnProperty("update")?(o.update(e, t), o):r?new r(e, t):null;
}, types:[], register:function(e) {
return a[e.prototype.id]=e, a.types.push(e), e;
}}});a.register(e.Class({id:"Element", extends:a, constructor:function() {
this.permissions.on(["read", "edit", "save"]);
}, update:function(t, a) {
this["super"].update.call(this, t, a), this.element=e(this.source)||e.create("script", {type:"application/json", id:this.source.slice(1), inside:document.body});
}, get:function() {
return Promise.resolve(this.element.textContent);
}, put:function(e) {
return Promise.resolve(this.element.textContent=e);
}, static:{test:function(e) {
return 0===e.indexOf("#");
}}})), a.register(e.Class({id:"Remote", extends:a, constructor:function() {
this.permissions.on("read");
}, static:{test:function() {
return !1;
}}})), a.register(e.Class({extends:a, id:"Local", constructor:function() {
this.permissions.on(["read", "edit", "save"]), this.key=this.mavo.id;
}, get:function() {
return Promise[this.key in localStorage?"resolve":"reject"](localStorage[this.key]);
}, put:function(e) {
return e?localStorage[this.key]=e:delete localStorage[this.key], Promise.resolve(e);
}, static:{test:function(e) {
return "local"==e;
}}}));
}(Bliss, Bliss.$), function(e) {
var t=Mavo.Formats={}, a=t.Base=e.Class({abstract:!0, constructor:function(e) {
this.backend=e;
}, proxy:{mavo:"backend"}, parse:function(e) {
return this.constructor.parse(e, this);
}, stringify:function(e) {
return this.constructor.stringify(e, this);
}, static:{parse:function(e) {
return Promise.resolve(e);
}, stringify:function(e) {
return Promise.resolve(e);
}, extensions:[], dependencies:[], ready:function() {
return Promise.all(this.dependencies.map(function(t) {
return e.include(t.test(), t.url);
}));
}}}), n=t.JSON=e.Class({extends:t.Base, static:{parse:function(e) {
return Promise.resolve(e?JSON.parse(e):null);
}, stringify:function(e) {
return Promise.resolve(Mavo.toJSON(e));
}, extensions:[".json", ".jsonld"]}}), o=t.Text=e.Class({extends:t.Base, constructor:function() {
this.property=this.mavo.root.getNames("Primitive")[0];
}, static:{extensions:[".txt"], parse:function(e, t) {
return Promise.resolve(_defineProperty({}, t?t.property:"content", e));
}, stringify:function(e, t) {
return Promise.resolve(e[t?t.property:"content"]);
}}}), r=t.CSV=e.Class({extends:t.Base, constructor:function() {
this.property=this.mavo.root.getNames("Collection")[0], this.options=e.extend({}, t.CSV.defaultOptions);
}, static:{extensions:[".csv", ".tsv"], defaultOptions:{header:!0, dynamicTyping:!0, skipEmptyLines:!0}, dependencies:[{test:function() {
return self.Papa;
}, url:"https://cdnjs.cloudflare.com/ajax/libs/PapaParse/4.1.4/papaparse.min.js"}], ready:a.ready, parse:function(e, t) {
return r.ready().then(function() {
var a=Papa.parse(e, r.defaultOptions), n=t?t.property:"content";if (t&&(t.options.delimiter=a.meta.delimiter, t.options.linebreak=a.meta.linebreak), a.meta.aborted) {
throw a.meta.errors.pop();
} return _defineProperty({}, n, a.data);
});
}, stringify:function(e, t) {
return r.ready().then(function() {
var a=t?t.property:"content", n=t?t.options:r.defaultOptions;return Papa.unparse(e[a], n);
});
}}});Object.defineProperty(t, "create", {value:function(e, a) {
if (e&&"object"===_typeof(e)) {
return e;
} if ("string"==typeof e) {
for (var n in e=e.toLowerCase(), t) {
var o=t[n];if (n.toLowerCase()==e) {
return new o(a);
}
}
} if (!e) {
var r=a.url?a.url.pathname:a.source, i=Mavo.match(r, /\.\w+$/)||".json", o=t.JSON;for (var n in t) {
-1<t[n].extensions.indexOf(i)&&(o=t[n]);
} return new o(a);
}
}});
}(Bliss, Bliss.$), function(e, t) {
var a=Math.abs, n=Mavo.Node=function() {
function o(t, a) {
var r=this, i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};if (_classCallCheck(this, o), !t||!a) {
throw new Error("Mavo.Node constructor requires an element argument and a mavo object");
} var s={context:this, options:i};this.uid=n.all.push(this)-1, this.property=null, this.element=t, this.isHelperVariable=this.element.matches("meta"), e.extend(this, s.options), n.elements.set(t, [].concat(_toConsumableArray(n.elements.get(this.element)||[]), [this])), this.mavo=a, this.group=this.parent=this.parentGroup=s.options.group, this.template=s.options.template, this.alias=this.element.getAttribute("mv-alias"), this.template?this.template.copies.push(this):this.copies=[], this.fromTemplate("property", "type", "storage", "path")||(this.property=n.getProperty(t), this.type=Mavo.Group.normalize(t), this.storage=this.element.getAttribute("mv-storage"), this.path=this.getPath()), this.modes=this.element.getAttribute("mv-mode"), Mavo.hooks.run("node-init-start", s), this.mode=Mavo.getStyle(this.element, "--mv-mode")||"read", this.collection=s.options.collection, this.collection&&(this.group=this.parentGroup=this.collection.parentGroup);var l=this.template;if (l&&l.expressions&&(this.expressions=l.expressions.map(function(e) {
return new Mavo.DOMExpression({template:e, item:r, mavo:r.mavo});
})), this instanceof Mavo.Group||this.collection) {
var d=Mavo.DOMExpression.search(this.element).filter(function(e) {
return "mv-value"==e.originalAttribute;
})[0];d&&(d.mavoNode=this, this.expressionText=d, this.storage=this.storage||"none", this.modes="read", this.collection&&(this.collection.expressions=[].concat(_toConsumableArray(this.collection.expressions||[]), [d]), d.mavoNode=this.collection, this.collection.storage=this.collection.storage||"none", this.collection.modes="read"));
}Mavo.hooks.run("node-init-end", s);
} return _createClass(o, [{key:"postInit", value:function() {
"edit"==this.modes&&this.edit();
}}, {key:"destroy", value:function() {
this.template&&Mavo["delete"](this.template.copies, this), this.expressions&&this.expressions.forEach(function(e) {
return e.destroy();
}), this.itembar&&this.itembar.destroy(), delete n.all[this.uid], this.propagate("destroy");
}}, {key:"getLiveData", value:function() {
return this.liveData.proxy;
}}, {key:"isDataNull", value:function() {
var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}, t={context:this, options:e, result:!this.saved&&!e.live};return Mavo.hooks.run("node-isdatanull", t), t.result;
}}, {key:"walk", value:function(e) {
var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[], a=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};return function t(n, o) {
var r=e(n, o);if (!1!==r) {
for (var s in n.children) {
var i=n.children[s];if (i instanceof Mavo.Node) {
var r=t.call(i, i, [].concat(_toConsumableArray(o), [s]));if (!1===r&&!a.descentReturn) {
return !1;
}
}
}
} return !1!==r;
}(this, t);
}}, {key:"walkUp", value:function(e) {
for (var t=this, a;t=t.parentGroup;) {
if (a=e(t), void 0!==a) {
return a;
}
}
}}, {key:"edit", value:function() {
return this.mode="edit", "edit"==this.mode&&void(e.fire(this.element, "mv-edit", {mavo:this.mavo, node:this}), Mavo.hooks.run("node-edit-end", this));
}}, {key:"done", value:function() {
return this.mode=Mavo.getStyle(this.element.parentNode, "--mv-mode")||"read", "read"==this.mode&&void(e.unbind(this.element, ".mavo:edit"), e.fire(this.element, "mv-done", {mavo:this.mavo, node:this}), this.propagate("done"), Mavo.hooks.run("node-done-end", this));
}}, {key:"save", value:function() {
this.unsavedChanges=!1, this.propagate("save");
}}, {key:"propagate", value:function(e) {
for (var t in this.children) {
var a=this.children[t];a instanceof Mavo.Node&&("function"==typeof e?e.call(a, a):e in a&&a[e]());
}
}}, {key:"fromTemplate", value:function() {
var e=this;if (this.template) {
for (var t=arguments.length, a=Array(t), n=0;n<t;n++) {
a[n]=arguments[n];
}a.forEach(function(t) {
return e[t]=e.template[t];
});
} return !!this.template;
}}, {key:"render", value:function(t) {
var a=this, n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};n.live=n.live||Mavo["in"](Mavo.isProxy, t), n.root=n.root||this, n.live&&(t=Mavo.clone(t)), this.oldData=this.data, this.data=t, n.live||(t=Mavo.subset(t, this.inPath));var o={context:this, data:t, options:n};if (Mavo.hooks.run("node-render-start", o), !this.isHelperVariable) {
if (!Array.isArray(this.children)&&Array.isArray(o.data)) {
if (this.isRoot) {
var r=this.children.main instanceof Mavo.Collection?"main":this.getNames(function(t, a) {
return a instanceof Mavo.Collection&&!e.value(a.expressions, 0, "isDynamicObject");
})[0];r&&(o.data=_defineProperty({}, r, o.data));
} this.isRoot&&r||(this.inPath.push("0"), o.data=o.data[0]);
}
else {
this.childrenNames&&1==this.childrenNames.length&&this.childrenNames[0]===this.property&&null!==o.data&&"object"===_typeof(o.data)&&(o.data=o.data[this.property]);
}
} this===n.root&&(this.expressionsEnabled=!1);var i=this.editing;i&&this.done();var s=this.dataRender(o.data, n);return i&&this.edit(), this===n.root&&(this.save(), this.expressionsEnabled=!0, s&&requestAnimationFrame(function() {
return a.mavo.expressions.update(a);
})), Mavo.hooks.run("node-render-end", o), s;
}}, {key:"dataChanged", value:function(t) {
var a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}, n=e.extend({action:t, property:this.property, mavo:this.mavo, node:this}, a);e.fire(a.element||this.element, "mv-change", n), this.mavo.changed(n);
}}, {key:"toString", value:function() {
return "#".concat(this.uid, ": ").concat(this.constructor.name, " (").concat(this.property, ")");
}}, {key:"getClosestCollection", value:function() {
var e=this.closestItem;return e?e.collection:null;
}}, {key:"getClosestItem", value:function() {
return this.collection&&Array.isArray(this.collection.children)?this:this.parentGroup?this.parentGroup.closestItem:null;
}}, {key:"getPath", value:function() {
var e=this.parent?this.parent.path:[];return this.property?[].concat(_toConsumableArray(e), [this.property]):e;
}}, {key:"pathFrom", value:function(e) {
for (var t=this.path, a=e.path, n=0;n<t.length&&a[n]==t[n];n++) {
;
} return t.slice(n);
}}, {key:"getDescendant", value:function(e) {
return e.reduce(function(e, t) {
return e.children[t];
}, this);
}}, {key:"getCousin", value:function(e) {
var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if (!this.closestCollection) {
return null;
} var n=this.closestCollection, o=a(e), r=0>e?-1:1;if (n.length<o+1) {
return null;
} var s=this.closestItem.index+e;t.wrap&&(s=Mavo.wrap(s, n.length));for (var l=0, d;l<n.length;l++) {
d=s+l*r, t.wrap&&(d=Mavo.wrap(d, n.length));var c=n.children[d];if (c) {
break;
}
} if (!c||c==this.closestItem) {
return null;
} if (this.collection) {
return c;
} var p=this.pathFrom(this.closestItem);return c.getDescendant(p);
}}, {key:"contains", value:function(e) {
do {
if (e===this) {
return !0;
}e=e.parent;
} while (e);return !1;
}}, {key:"eval", value:function(e, t) {
return new Mavo.Expression(e).eval(this.getLiveData(), t);
}}, {key:"editing", get:function() {
return "edit"==this.mode;
}}, {key:"isRoot", get:function() {
return !this.property;
}}, {key:"name", get:function() {
return Mavo.Functions.readable(this.property||this.type).toLowerCase();
}}, {key:"saved", get:function() {
return "none"!==this.storage;
}}, {key:"properties", get:function() {
return Object.keys(this.liveData.data[Mavo.route]);
}}], [{key:"create", value:function(e, t) {
var a=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};return Mavo.is("multiple", e)&&!a.collection?new Mavo.Collection(e, t, a):new Mavo[Mavo.is("group", e)?"Group":"Primitive"](e, t, a);
}}, {key:"getProperty", value:function(e) {
var t=e.getAttribute("property")||e.getAttribute("itemprop");if (!t) {
var a=e.getAttribute("mv-multiple");e.hasAttribute("property")&&(t=a||e.name||e.id||e.classList[0], !t&&(t=n.generatePropertyName(null===a?"prop":"collection", e)));
} return t&&e.setAttribute("property", t), t;
}}, {key:"generatePropertyName", value:function(t) {
for (var a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:document.documentElement, n=a.closest(Mavo.selectors.init), o="", r;1e4>o;o++) {
if (r=t+o, !e(Mavo.selectors.specificProperty(r), n)) {
return r;
}
}
}}, {key:"get", value:function(e, t) {
var a=(n.elements.get(e)||[]).filter(function(e) {
return !Array.isArray(e.children);
});return 2>a.length||!t?a[0]:a[0]instanceof Mavo.Group?a[1]:void 0;
}}, {key:"getClosest", value:function(e, t) {
var a;do {
a=n.get(e, t);
} while (!a&&(e=e.parentNode));return a;
}}, {key:"getClosestItem", value:function(e) {
var t=n.getClosest(e);return t instanceof Mavo.Primitive&&!t.collection?t.parent:t;
}}, {key:"children", value:function(a) {
var n=Mavo.Node.get(a);return n?[n]:(n=t(Mavo.selectors.property, a).map(function(t) {
return Mavo.Node.get(t);
}).filter(function(t) {
return !a.contains(t.parentGroup.element);
}).map(function(t) {
return t.collection||t;
}), Mavo.Functions.unique(n));
}}]), o;
}();e.Class(n, {toJSON:Mavo.prototype.toJSON, lazy:{closestCollection:function() {
return this.getClosestCollection();
}, closestItem:function() {
return this.getClosestItem();
}, inPath:function() {
var e=this instanceof Mavo.Collection?"mv-multiple-path":"mv-path";return (this.element.getAttribute(e)||"").split("/").filter(function(e) {
return e.length;
});
}}, live:{store:function(t) {
e.toggleAttribute(this.element, "mv-storage", t);
}, unsavedChanges:function(e) {
return !e||this.saved&&this.editing||(e=!1), Array.isArray(this.children)||this.element.classList.toggle("mv-unsaved-changes", e), e;
}, mode:function(t) {
var a=this;if (this._mode!=t) {
if (this.modes&&t!=this.modes&&(t=this.modes), this._mode=t, !Array.isArray(this.children)&&-1<[null, "", "read", "edit"].indexOf(this.element.getAttribute("mv-mode"))) {
var n=this.modes||"edit"==t;Mavo.Observer.sneak(this.mavo.modeObserver, function() {
e.toggleAttribute(a.element, "mv-mode", t, n);
});
} return t;
}
}, modes:function(e) {
return e&&"read"!=e&&"edit"!=e?null:void(this._modes=e, e&&this.mode!=e&&(this.mode=e));
}, collection:function(e) {
this.parent=e||this.parentGroup;
}, index:function(e) {
this._index!==e&&(this._index=e, this.liveData.updateKey());
}, expressionsEnabled:{get:function() {
return !1!==this._expressionsEnabled&&(!this.parent||this.parent.expressionsEnabled);
}}}, static:{all:[], elements:new WeakMap}});
}(Bliss, Bliss.$), function(e, t) {
var a=Mavo.Group=function(n) {
function r(e, a, n) {
var o;if (_classCallCheck(this, r), o=_possibleConstructorReturn(this, _getPrototypeOf(r).call(this, e, a, n)), o.children={}, o.group=_assertThisInitialized(o), Mavo.hooks.run("group-init-start", _assertThisInitialized(o)), Mavo.Primitive.getValueAttribute(o.element)) {
o.children[o.property]=new Mavo.Primitive(o.element, o.mavo, {group:_assertThisInitialized(o)});
} var i=t(Mavo.selectors.property+", "+Mavo.selectors.multiple, o.element).filter(function(e) {
return o.element===(e.parentNode.closest(Mavo.selectors.childGroup)||o.mavo.element);
}), s={};return i.forEach(function(e) {
var t=Mavo.Node.getProperty(e);"multiple"!==s[t]&&(s[t]=Mavo.is("multiple", e)?"multiple":(s[t]||0)+1);
}), i.forEach(function(e) {
var t=Mavo.Node.getProperty(e), a=o.template?o.template.children[t]:null, n={template:a, group:_assertThisInitialized(o)}, r=s[t];if ("multiple"===r) {
var i=o.children[t];i instanceof Mavo.Collection?i.add(e):Mavo.is("multiple", e)?(o.children[t]=new Mavo.Collection(e, o.mavo, n), (i||[]).forEach(function(a, e) {
return o.children[t].add(a, e);
})):o.children[t]=[].concat(_toConsumableArray(i||[]), [e]);
}
else {
1<r?o.children[t]?o.children[t].add(e):o.children[t]=new Mavo.ImplicitCollection(e, o.mavo, n):o.children[t]=Mavo.Node.create(e, o.mavo, n);
}
}), o.childrenNames=Object.keys(o.children), o.vocab=Mavo.getClosestAttribute(o.element, "vocab"), o.postInit(), Mavo.hooks.run("group-init-end", _assertThisInitialized(o)), o;
} return _inherits(r, n), _createClass(r, [{key:"getNames", value:function() {
var e=this, t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"Node", a="function"==typeof t?t:function(e, a) {
return a instanceof Mavo[t];
};return Object.keys(this.children).filter(function(t) {
return a(t, e.children[t]);
});
}}, {key:"getData", value:function() {
var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}, t={context:this, options:e};if (this.isDataNull(e)) {
return null;
} for (var n in t.data=Mavo.shallowClone(Mavo.subset(this.data, this.inPath))||{}, this.children) {
var o=this.children[n];if (o.saved) {
var r=o.getData(t.options);
}o.saved&&null!==Mavo.value(r)?t.data[o.property]=r:delete t.data[o.property];
} return this.childrenNames.length||this.isRoot?1===this.childrenNames.length&&this.property in this.children?t.data=t.data[this.property]:t.data&&"object"===_typeof(t.data)&&(this.type&&this.type!=a.DEFAULT_TYPE&&(t.data["@type"]=this.type), this.vocab&&(t.data["@context"]=this.vocab)):t.data=null, t.data=Mavo.subset(this.data, this.inPath, t.data), Mavo.hooks.run("node-getdata-end", t), t.data;
}}, {key:"edit", value:function() {
var e=this, t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return !1!==_get(_getPrototypeOf(r.prototype), "edit", this).call(this)&&Promise.all(Object.keys(this.children).map(function(a) {
return e.children[a].edit(t);
}));
}}, {key:"dataRender", value:function(t) {
var a=this, n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if (t) {
var o=!1;if ("object"!==_typeof(t)) {
if (this.property in this.children) {
var r=this.property;
}
else {
var i=e.type(t), s=function(e) {
return (a.children[e]instanceof Mavo.Primitive)+(a.children[e].datatype==i);
}, r=Object.keys(this.children).filter(function(e) {
return !a.children[e].expressionText;
}).sort(function(e, t) {
return s(e)-s(t);
}).reverse()[0];
}t=_defineProperty({}, r, t), this.data=Mavo.subset(this.data, this.inPath, t);
} var l;this.propagate(function(a) {
var r=t[a.property];if (a.alias) {
for (var s=a.alias.split(" "), d=0, c;d<s.length;d++) {
if (c=s[d], void 0!==t[c]) {
a.currentAlias=c, l=l||e.extend({}, t), r=t[a.currentAlias];break;
}
}
}o=a.render(r, n)||o;
}), l&&this.propagate(function(e) {
e.currentAlias&&(t[e.property]=l[e.currentAlias], !(e.currentAlias in a.children)&&delete t[e.currentAlias]);
});var r;return o;
}
}}, {key:"isRoot", get:function() {
return !this.property;
}}], [{key:"normalize", value:function(e) {
if (Mavo.is("group", e)) {
var t=Mavo.getAttribute(e, "typeof", "mv-group")||a.DEFAULT_TYPE;return e.setAttribute("typeof", t), t;
} return null;
}}]), r;
}(Mavo.Node);e.Class(a, {lazy:{liveData:function() {
return new Mavo.Data(this, {});
}}, static:{all:new WeakMap, DEFAULT_TYPE:"Item"}});
}(Bliss, Bliss.$), function(e, t) {
var a=Mavo.Primitive=function(n) {
function r(n, i, s) {
var o;_classCallCheck(this, r), o=_possibleConstructorReturn(this, _getPrototypeOf(r).call(this, n, i, s)), o.liveData=new Mavo.Data(_assertThisInitialized(o)), o.fromTemplate("config", "attribute", "templateValue", "originalEditor")||(o.config=a.getConfig(n), o.attribute=o.config.attribute, o.attribute&&!document.xmlVersion&&(o.attribute=o.attribute.toLowerCase())), o.datatype=o.config.datatype, "modes"in o.config&&(o.modes=o.config.modes, o.element.setAttribute("mv-mode", o.config.modes)), Mavo.hooks.run("primitive-init-start", _assertThisInitialized(o)), o.expressionText=o.expressionText||Mavo.DOMExpression.search(o.element, o.attribute), o.expressionText&&!o.expressionText.mavoNode&&(o.expressionText.primitive=_assertThisInitialized(o), o.storage=o.storage||"none", o.modes="read", o.element.setAttribute("aria-live", "polite")), !o.editor&&o.element.hasAttribute("mv-edit")&&(!o.originalEditor&&(o.originalEditor=e(o.element.getAttribute("mv-edit"))), o.originalEditor&&!o.template&&(o.originalEditorObserver=new Mavo.Observer(o.originalEditor, "all", function() {
o.copies.concat(_assertThisInitialized(o)).forEach(function(e) {
"editor"==e.defaultSource&&(e["default"]=o.originalEditor.value), e.editor&&(e.editor=o.originalEditor.cloneNode(!0)), e.setValue(e.value, {force:!0, silent:!0});
});
}))), o.editor||o.originalEditor||o.attribute||(o.editor=t(o.element.children).filter(function(e) {
return e.matches(Mavo.selectors.formControl)&&!e.matches(Mavo.selectors.property);
})[0], o.editor&&e.remove(o.editor));var l=o.editorValue;if (o.datatype||"number"!=typeof l&&"boolean"!=typeof l||(o.datatype=_typeof(l)), o.config.init&&o.config.init.call(_assertThisInitialized(o), o.element), o.config.changeEvents&&e.bind(o.element, o.config.changeEvents, function(e) {
e.target===o.element&&(o.value=o.getValue());
}), o.templateValue=o.getValue(), o._default=o.element.getAttribute("mv-default"), null===o["default"]) {
o._default=o.modes?o.templateValue:l, o.defaultSource=o.modes?"template":"editor";
}
else if (""===o["default"]) {
o._default=o.templateValue, o.defaultSource="template";
}
else {
var d=Mavo.DOMExpression.search(o.element, "mv-default");d?d.output=function(e) {
return o["default"]=e;
}:o.defaultObserver=new Mavo.Observer(o.element, "mv-default", function() {
o["default"]=o.element.getAttribute("mv-default");
}), o.defaultSource="attribute";
} var c=!o.template||o.template.templateValue!=o.templateValue||"edit"==o.modes;return o.initialValue=void 0===o["default"]&&c?o.templateValue:o["default"], void 0===o.initialValue&&(o.initialValue=o.emptyValue), o.setValue(o.initialValue, {silent:!0}), o.element.hasAttribute("aria-label")?e.lazy(_assertThisInitialized(o), "label", function() {
return o.labelObserver=new Mavo.Observer(o.element, "aria-label", function() {
o.label=o.element.getAttribute("aria-label"), "placeholder"in o.editor&&(o.editor.placeholder="(".concat(o.label, ")"));
}), o.element.getAttribute("aria-label");
}):(o.label=Mavo.Functions.readable(o.property), o.element.setAttribute("aria-label", o.label)), o.attribute||Mavo.setAttributeShy(o.element, "mv-attribute", "none"), o.postInit(), Mavo.hooks.run("primitive-init-end", _assertThisInitialized(o)), o;
} return _inherits(r, n), _createClass(r, [{key:"updateObserver", value:function() {
var e=this;if (this.config) {
if (!1===this.config.observer) {
this.observer&&this.observer.stop();
}
else {
var t={subtree:this.config.subtree, childList:this.config.subtree};this.observer?((this.observer.attribute!==this.attribute||this.observer.options.subtree!==t.subtree)&&this.observer.update(this.element, this.attribute, t), !this.observer.running&&this.observer.run()):this.observer=new Mavo.Observer(this.element, this.attribute, function() {
!1===e._config.observer?e.observer.stop():(e.attribute||!e.editing||e.config.subtree)&&(e.value=e.getValue());
}, t);
}
}
}}, {key:"destroy", value:function() {
var e=this;_get(_getPrototypeOf(r.prototype), "destroy", this).call(this), ["defaultObserver", "observer", "originalEditorObserver", "labelObserver"].forEach(function(t) {
e[t]&&e[t].destroy();
});
}}, {key:"isDataNull", value:function(e) {
return _get(_getPrototypeOf(r.prototype), "isDataNull", this).call(this, e)||null===this._value||void 0===this._value;
}}, {key:"getData", value:function() {
var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}, t={context:this, options:e};return this.isDataNull(e)?null:(t.data=this.value, ""!==t.data||this.templateValue&&this.initialValue===this.templateValue||(t.data=null), this.inPath.length&&(t.data=Mavo.subset(this.data, this.inPath, t.data)), Mavo.hooks.run("node-getdata-end", t), t.data);
}}, {key:"sneak", value:function(e) {
return Mavo.Observer.sneak(this.observer, e);
}}, {key:"save", value:function() {
this.savedValue=this.value, this.unsavedChanges=!1;
}}, {key:"initEdit", value:function() {
var t=this;if (!this.editor&&this.originalEditor&&(this.editor=this.originalEditor.cloneNode(!0)), !this.editor) {
var a=this.config.editor;a&&"boolean"!=this.datatype||(a=Mavo.Elements.defaultConfig[this.datatype||"string"].editor), this.editor=e.create("function"===e.type(a)?a.call(this):a), this.editorValue=this.value;
}e.bind(this.editor, {"input change":function() {
t.value=t.editorValue;
}, "mv-change":function(a) {
"output"===a.property&&(a.stopPropagation(), e.fire(t.editor, "input"));
}});var n=this.editor.matches("textarea");n||this.editor.addEventListener("focus", function() {
t.editor.select&&t.editor.select();
}), "placeholder"in this.editor&&(this.editor.placeholder="(".concat(this.label, ")")), Mavo.attributeStartsWith("mv-edit-", this.element).forEach(function(e) {
t.editor.setAttribute(e.name.replace("mv-edit-", ""), e.value);
}), (this.attribute||this.config.popup)&&(this.popup=new Mavo.UI.Popup(this)), this.popup||this.editor.classList.add("mv-editor"), this.initEdit=null;
}}, {key:"edit", value:function() {
var t=this, n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}, o=this.editing;if (!1===_get(_getPrototypeOf(r.prototype), "edit", this).call(this)) {
return !1;
} if (o&&!this.initEdit) {
return this.preEdit;
} this.preEdit||(this.preEdit=Mavo.promise(), this.afterPreEdit=null, this.preEdit.then(function() {
e.unbind(t.element, ".mavo:preedit"), requestAnimationFrame(function() {
if (!t.popup&&t.closestCollection&&t.editor&&t.editor.matches(Mavo.selectors.textInput)) {
var a=t.editor.matches("textarea");a||e.bind(t.editor, "paste.mavo:edit", function(a) {
if (t.closestCollection.editing&&a.clipboardData) {
var n=a.clipboardData.getData("text/plain"), o=/\r?\n|\r/;if (o.test(n)) {
a.preventDefault();var r=n.split(o);t.editor.setRangeText(r[0]), e.fire(t.editor, "input");for (var s=t.closestCollection, l=c&&c.index||0, d=1;d<r.length;d++) {
var c=t.closestItem, p=s.add(void 0, l+d);s.editItem(p);var u=t.getCousin(d);u.render(r[d]);
}
}
}
}), e.bind(t.editor, "keydown.mavo:edit", function(e) {
if (t.closestCollection.editing&&-1!==!["Backspace", "Enter"].indexOf(e.key)) {
if ("Enter"==e.key&&(e.shiftKey||!a)) {
if (t.bottomUp) {
return;
} var n=t.closestItem, o=t.closestCollection.add(void 0, n&&n.index+1);t.closestCollection.editItem(o);var r=t.getCousin(1);requestAnimationFrame(function() {
r.edit({immediately:!0}).then(function() {
return r.editor.focus();
});
}), a&&e.preventDefault();
}
else if ("Backspace"==e.key&&(t.empty||e[Mavo.superKey])) {
var i=t.getCousin(1)||t.getCousin(-1);t.closestCollection["delete"](t.closestItem), i&&i.edit({immediately:!0}).then(function() {
return i.editor.focus();
}), e.preventDefault();
}
}
});
}
});
})), o||(-1===this.element.tabIndex&&Mavo.revocably.setAttribute(this.element, "tabindex", "0"), this.element.classList.add("mv-pending-edit"), !this.modes&&e.bind(this.element, "click.mavo:edit", function(e) {
return e.preventDefault();
}));var i=["mousedown", "focus", "dragover", "dragenter"].map(function(t) {
return t+".mavo:preedit";
}).join(" ");return (e.bind(this.element, i, function(e) {
return t.preEdit.resolve(e);
}), n.immediately&&this.preEdit.resolve(), this.config.edit)?(this.config.edit.call(this), this.initEdit=null, this.preEdit.resolve()):(this.afterPreEdit||(this.afterPreEdit=this.preEdit.then(function(e) {
t.sneak(function() {
t.element.classList.remove("mv-pending-edit"), t.initEdit&&t.initEdit(), t.popup&&(t.popup.prepare(), t.popup.show()), t.attribute||t.popup||(t.editor.parentNode!=t.element&&(t.editorValue=t.value, t.config.hasChildren?t.element.textContent="":a.setText(t.element, ""), t.element.prepend(t.editor)), (e&&"mousedown"==e.type||document.activeElement===t.element)&&requestAnimationFrame(function() {
return t.editor.focus();
}), !t.collection&&Mavo.revocably.restoreAttribute(t.element, "tabindex"));
});
})), this.afterPreEdit);
}}, {key:"done", value:function() {
var t=this;return !1!==_get(_getPrototypeOf(r.prototype), "done", this).call(this)&&void(this.afterPreEdit=null, "preEdit"in this&&e.unbind(this.element, ".mavo:preedit .mavo:edit"), this.sneak(function() {
return t.config.done?void t.config.done.call(t):void(t.popup?t.popup.close():!t.attribute&&t.editor&&(e.remove(t.editor), a.setValue(t.element, t.editorValue, {config:t.config, attribute:t.attribute, datatype:t.datatype, map:t.originalEditor||t.editor, node:t})));
}), !this.collection&&Mavo.revocably.restoreAttribute(this.element, "tabindex"));
}}, {key:"dataRender", value:function(t) {
var a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}, n=a.live, o=a.root, r=this._value;if ("object"===e.type(t)) {
if (Symbol.toPrimitive in t) {
t=t[Symbol.toPrimitive]("default");
}
else if (!this.isHelperVariable) {
var i=Object.keys(t), s;if (1===i.length) {
s=i[0];
}
else {
for (var l=0, d=[this.property, "value", "content"], c;l<d.length;l++) {
if (c=d[l], c in t) {
s=c;break;
}
} for (var u in t) {
var p=e.type(t[u]);if (p===this.datatype||!this.datatype&&"string"==p) {
s=u;break;
}
}
}s&&(t=t[s], !n&&this.inPath.push(s));
}
} return void 0===t?!this.modes&&this.value===this.templateValue&&(this.value=this.closestCollection?this["default"]:this.templateValue):this.value=t, this._value!==r;
}}, {key:"find", value:function(e) {
var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if (this.property==e&&t.exclude!==this) {
return this;
}
}}, {key:"getValue", value:function() {
return a.getValue(this.element, {config:this.config, attribute:this.attribute, datatype:this.datatype});
}}, {key:"setValue", value:function(e) {
var t=this, n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return this.sneak(function() {
void 0===e&&(e=null);var o=t.datatype;return t.datatype||"number"!=typeof e&&"boolean"!=typeof e||(t.datatype=_typeof(e)), e=a.safeCast(e, t.datatype), n.force||e!==t._value||o!=t.datatype?void(t.editor&&t.editorValue!=e&&(t.editorValue=e), (t.popup||!t.editor||t.editor!==document.activeElement&&!t.element.contains(t.editor))&&(t.config.setValue?t.config.setValue.call(t, t.element, e):!n.dataOnly&&a.setValue(t.element, e, {config:t.config, attribute:t.attribute, datatype:t.datatype, map:t.originalEditor||t.editor, node:t})), t.empty=!e&&0!==e, t._value=e, t.liveData.update(), !n.silent&&(t.saved&&(t.unsavedChanges=t.mavo.unsavedChanges=!0), t.dataChanged("propertychange", {value:e}))):e;
}), e;
}}, {key:"dataChanged", value:function() {
var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"propertychange", t=1<arguments.length?arguments[1]:void 0;return _get(_getPrototypeOf(r.prototype), "dataChanged", this).call(this, e, t);
}}, {key:"upload", value:function(e) {
var t=this, a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:e.name;if (this.mavo.uploadBackend&&self.FileReader) {
var n=URL.createObjectURL(e);this.sneak(function() {
return t.element.setAttribute(t.attribute, n);
});var o=this.element.getAttribute("mv-uploads")||"", r=o+"/"+a;this.mavo.upload(e, r).then(function(e) {
var a=Mavo.getClosestAttribute(t.element, "mv-upload-url");a&&(e=new URL(r, new URL(a, location))+""), t.value=e, t.element.matches("a")||t.sneak(function() {
return t.element.setAttribute(t.attribute, n);
});
});
}
}}, {key:"createUploadPopup", value:function(t) {
var a=this, n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"file", o=2<arguments.length?arguments[2]:void 0, r={context:this, type:t, kind:n, ext:o};if (r.mainInput=e.create("input", {type:"url", placeholder:"http://example.com/".concat(n, ".").concat(o), className:"mv-output", "aria-label":"URL to ".concat(n)}), this.mavo.uploadBackend&&self.FileReader) {
var i=function(e) {
return e&&(!t||0===e.type.indexOf(t.replace("*", "")));
};return r.events={paste:function(e) {
var o=e.clipboardData.items[0], r=o.type.split("/")[1];if ("file"==o.kind&&i(o)) {
var s="pasted-".concat(n, "-").concat(Date.now(), ".").concat(r), l=prompt(a.mavo._("filename"), s);""===l&&(l=s), null!==l&&(a.upload(o.getAsFile(), l, t), e.preventDefault());
}
}, "drag dragstart dragend dragover dragenter dragleave drop":function(e) {
e.preventDefault(), e.stopPropagation();
}, "dragover dragenter":function() {
r.popup.classList.add("mv-dragover"), a.element.classList.add("mv-dragover");
}, "dragleave dragend drop":function() {
r.popup.classList.remove("mv-dragover"), a.element.classList.remove("mv-dragover");
}, drop:function(e) {
var t=e.dataTransfer.files[0];t&&i(t)&&a.upload(t);
}}, Mavo.hooks.run("primitive-createuploadpopup-beforecreate", r), r.popup=e.create({className:"mv-upload-popup", contents:[r.mainInput, {tag:"input", type:"file", "aria-label":"Upload ".concat(n), accept:t, events:{change:function(e) {
var t=e.target.files[0];t&&i(t)&&a.upload(t);
}}}, {className:"mv-tip", innerHTML:"<strong>Tip:</strong> You can also drag & drop or paste!"}], events:r.events}), e.bind(this.element, r.events), Mavo.hooks.run("primitive-createuploadpopup-beforereturn", r), r.popup;
} return r.mainInput;
}}, {key:"editorValue", get:function() {
var t=this.editor||this.originalEditor;if (t) {
if (t.matches(Mavo.selectors.formControl)) {
return a.getValue(t, {datatype:this.datatype});
} var n=e(Mavo.selectors.output+", "+Mavo.selectors.formControl, t);if (n) {
return a.getValue(n);
}
}
}, set:function(t) {
if (this.config.setEditorValue&&"boolean"!==this.datatype) {
return this.config.setEditorValue.call(this, t);
} if (this.editor) {
if (this.editor.matches(Mavo.selectors.formControl)) {
a.setValue(this.editor, t, {config:this.editorDefaults});
}
else {
var n=e(Mavo.selectors.output+", "+Mavo.selectors.formControl, this.editor);n&&a.setValue(n, t);
}
}
}}], [{key:"getText", value:function(e) {
var t=e.nodeType===Node.TEXT_NODE?e:e.firstChild;return t&&t.nodeType===Node.TEXT_NODE?t.nodeValue:"";
}}, {key:"setText", value:function(e, t) {
var a=e.nodeType===Node.TEXT_NODE?e:e.firstChild;a&&a.nodeType===Node.TEXT_NODE?a.nodeValue=t:e.prepend(t);
}}, {key:"getValueAttribute", value:function(e) {
var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:Mavo.Elements.search(e), a=e.getAttribute("mv-attribute")||t.attribute;return a&&"null"!==a&&"none"!==a||(a=null), a;
}}, {key:"safeCast", value:function(e, t) {
var n=_typeof(e), o=a.cast(e, t);return "boolean"==t?!!e&&(!!("true"===e||0<e)||e):"number"==t?/^[-+]?[0-9.e]+$/i.test(e+"")?o:e:null===e||void 0===e?e:o;
}}, {key:"cast", value:function(e, t) {
return "number"===t?+e:"boolean"===t?!!e:"string"===t?e+"":e;
}}, {key:"getValue", value:function(e) {
var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}, n=t.config, o=t.attribute, r=t.datatype;if (n||(n=a.getConfig(e, o)), o=n.attribute, r=n.datatype, n.getValue&&o==n.attribute) {
return n.getValue(e);
} var i;return i=o in e&&a.useProperty(e, o)?e[o]:o?e.getAttribute(o):e.getAttribute("content")||a.getText(e)||null, a.safeCast(i, r);
}}, {key:"getConfig", value:function(e, t, n) {
void 0===t&&(t=e.getAttribute("mv-attribute")||void 0), ("null"==t||"none"==t)&&(t=null);var o=void 0===t||t==a.getValueAttribute(e);!n&&o&&(n=e.getAttribute("datatype")||void 0);var r=Mavo.Elements.search(e, t, n);return r=Object.assign({}, r), void 0===r.attribute&&(r.attribute=t||null), void 0===r.datatype&&(r.datatype=n), r;
}}, {key:"setValue", value:function(t, n) {
var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};if (1===t.nodeType&&(r.config||(r.config=a.getConfig(t, r.attribute)), r.attribute=void 0===r.attribute?r.config.attribute:r.attribute, r.datatype=void 0===r.datatype?r.config.datatype:r.datatype, r.config.setValue&&r.attribute==r.config.attribute)) {
return r.config.setValue(t, n, r.attribute);
} if (null!==n||r.datatype||(n=""), r.attribute) {
if (r.attribute in t&&a.useProperty(t, r.attribute)&&t[r.attribute]!==n) {
try {
var o=t[r.attribute], i=t[r.attribute]=n;
}
catch (t) {}o!=i&&r.config.changeEvents&&r.config.changeEvents.split(/\s+/).forEach(function(a) {
return e.fire(t, a);
});
}"boolean"==r.datatype?n!=t.hasAttribute(r.attribute)&&e.toggleAttribute(t, r.attribute, n, n):t.getAttribute(r.attribute)!=n&&t.setAttribute(r.attribute, n);
}
else {
var s=a.format(n, r);r.node&&!r.config.hasChildren?a.setText(t, s):t.textContent=s, s!==n&&t.setAttribute&&t.setAttribute("content", n);
}
}}, {key:"useProperty", value:function(e, t) {
return !(-1<["href", "src"].indexOf(t))&&"http://www.w3.org/2000/svg"!=e.namespaceURI;
}}, {key:"format", value:function(t) {
var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if (n.map&&/^select$/i.test(n.map.nodeName)) {
for (var o=0, r;r=n.map.options[o];o++) {
if (r.value==t) {
return r.textContent;
}
}
} if ("number"===e.type(t)||"number"==n.datatype) {
if (null===t) {
return "";
} var s=n.attribute||n.element&&n.element.matches("style, pre");if (!s) {
return a.formatNumber(t);
}
} return Array.isArray(t)?t.map(a.format).join(", "):"object"===e.type(t)?Mavo.toJSON(t):t;
}}]), r;
}(Mavo.Node);e.Class(a, {lazy:{emptyValue:function() {
switch (this.datatype) {
case "boolean":return !1;case "number":return 0;
} return "";
}, editorDefaults:function() {
return this.editor&&a.getConfig(this.editor);
}}, live:{default:function(e) {
this.value==this._default&&(this.value=e);
}, config:function(e) {
this._config!==e&&(this._config=e, this.updateObserver());
}, attribute:function(e) {
this._attribute!==e&&(this._attribute=e, this.updateObserver());
}, value:function(e) {
return this.setValue(e);
}, datatype:function(t) {
t!==this._datatype&&("boolean"==t&&!this.attribute&&(this.attribute=Mavo.Elements.defaultConfig.boolean.attribute), e.toggleAttribute(this.element, "datatype", t, t&&"string"!==t));
}, empty:function(t) {
var a=t&&!this.modes&&(!this.attribute||!e(Mavo.selectors.property, this.element))&&("boolean"!==this.datatype||this.attribute===Mavo.Elements.defaultConfig.boolean.attribute);this.element.classList.toggle("mv-empty", !!a);
}}, static:{all:new WeakMap, lazy:{formatNumber:function() {
var e=new Intl.NumberFormat(Mavo.locale, {maximumFractionDigits:2});return function(t) {
return t===1/0||t===-Infinity?0>t?"-\u221E":"\u221E":e.format(t);
};
}}}});
}(Bliss, Bliss.$), function(e) {
Mavo.UI.Popup=e.Class({constructor:function(t) {
var a=this;this.primitive=t, this.position=function() {
var t=a.primitive.element.getBoundingClientRect(), n=t.left, o=t.bottom, r=!1;if (a.element.offsetHeight&&(a.height=a.element.getBoundingClientRect().height||a.height), a.height+o+20>innerHeight) {
if (20<t.top-a.height) {
var r=!0;o=t.top-a.height-20;
}
else {
o=innerHeight-a.height-20;
}
}a.element.classList.toggle("mv-point-down", r), e.style(a.element, {top:"".concat(o, "px"), left:"".concat(n, "px")});
}, this.element=e.create("div", {className:"mv-popup", hidden:!0, contents:{tag:"fieldset", contents:[{tag:"legend", textContent:this.primitive.label+":"}, this.editor]}, events:{keyup:function(e) {
(13==e.keyCode||27==e.keyCode)&&(a.element.contains(document.activeElement)&&a.primitive.element.focus(), e.stopPropagation(), a.hide());
}, transitionend:this.position}}), this.editor.matches("select")&&(this.editor.size=Math.min(10, this.editor.children.length)), this.hideCallback=function(e) {
a.element.contains(e.target)||a.primitive.element.contains(e.target)||a.hide();
};
}, show:function() {
var t=this;e.unbind([this.primitive.element, this.element], ".mavo:showpopup"), this.shown=!0, this.element.style.transition="none", this.element.removeAttribute("hidden"), this.position(), this.element.setAttribute("hidden", ""), this.element.style.transition="", document.body.appendChild(this.element), setTimeout(function() {
t.element.removeAttribute("hidden");
}, 100), e.bind(document, "focus click", this.hideCallback, !0), window.addEventListener("scroll", this.position, {passive:!0});
}, hide:function() {
var t=this;e.unbind(document, "focus click", this.hideCallback, !0), window.removeEventListener("scroll", this.position, {passive:!0}), this.element.setAttribute("hidden", ""), this.shown=!1, setTimeout(function() {
e.remove(t.element);
}, 1e3*parseFloat(getComputedStyle(this.element).transitionDuration)||400);
}, prepare:function() {
var t=this;e.bind(this.primitive.element, {"click.mavo:edit":function() {
t.show();
}, "keyup.mavo:edit":function(e) {
-1<[13, 113].indexOf(e.keyCode)&&(t.show(), t.editor.focus());
}});
}, close:function() {
this.hide(), e.unbind(this.primitive.element, ".mavo:edit .mavo:preedit .mavo:showpopup");
}, proxy:{editor:"primitive"}});
}(Bliss, Bliss.$), function(e) {
var t=Math.min, a=Math.max, n=Mavo.Elements={};Object.defineProperties(n, {register:{value:function(t, a) {
if ("object"===_typeof(arguments[0])) {
for (var o in arguments[0]) {
n.register(o, arguments[0][o]);
} return;
} if (a.extend) {
var r=n[a.extend];a=e.extend(e.extend({}, r), a);
} if (-1<t.indexOf("@")) {
var i=t.split("@");a.selector=a.selector||i[0]||"*", void 0===a.attribute&&(a.attribute=i[1]);
} return a.selector=a.selector||t, a.id=t, Array.isArray(a.attribute)?a.attribute.forEach(function(r) {
var i=e.extend({}, a);i.attribute=r, n["".concat(t, "@").concat(r)]=i;
}):n[t]=a, n;
}}, search:{value:function(t, a, o) {
var r=n.matches(t, a, o);0===r.length&&o&&(r=n.matches(t, a));var i=r[r.length-1];if (i) {
return i;
} var s=e.extend({}, n.defaultConfig[o||"string"]);return s.attribute=void 0===a?s.attribute:a, s;
}}, matches:{value:function(e, t, a) {
var r=[];selectorloop:for (var i in n) {
var s=n[i], o=void 0===t&&s["default"]||t===s.attribute;if (o&&(void 0===a||"string"===a||a===s.datatype)) {
var l=s.selector||i;e.matches(l)&&(!s.test||s.test(e, t, a))&&r.push(s);
}
} return r;
}}, isSVG:{value:function(t) {
return "http://www.w3.org/2000/svg"==t.namespaceURI;
}}, defaultConfig:{value:{string:{editor:{tag:"input"}}, number:{editor:{tag:"input", type:"number"}}, boolean:{attribute:"content", editor:{tag:"input", type:"checkbox"}}}}}), n.register({"@hidden":{datatype:"boolean"}, "@y":{test:n.isSVG, datatype:"number"}, "@x":{default:!0, test:n.isSVG, datatype:"number"}, media:{default:!0, selector:"img, video, audio", attribute:"src", editor:function() {
var e=this.element.nodeName.toLowerCase();return e="img"==e?"image":e, Mavo.setAttributeShy(this.element, "mv-uploads", e+"s"), this.createUploadPopup(e+"/*", e, "png");
}}, "a, link":{default:!0, attribute:"href"}, "a[mv-uploads], link[mv-uploads]":{default:!0, attribute:"href", editor:function() {
var e=this.element.getAttribute("type"), t=e&&!/\/\*$/.test(e)?e.split("/")[1]:"pdf";return this.createUploadPopup(e, void 0, t);
}}, "video, audio":{attribute:["autoplay", "buffered", "loop"], datatype:"boolean"}, details:{attribute:"open", datatype:"boolean"}, "input, select, button, textarea":{attribute:"disabled", datatype:"boolean"}, formControl:{selector:"input", default:!0, attribute:"value", modes:"edit", changeEvents:"input change", edit:function() {}, done:function() {}, init:function() {
this.editor=this.element;
}}, select:{extend:"formControl", selector:"select", subtree:!0}, textarea:{extend:"formControl", selector:"textarea", attribute:null, getValue:function(e) {
return e.value;
}, setValue:function(e, t) {
return e.value=t;
}}, formNumber:{extend:"formControl", selector:"input[type=range], input[type=number]", datatype:"number", setValue:function(t, a) {
t.value=a, t.setAttribute("value", a);var n=a>t.value?"max":"min";if (!isNaN(a)&&t.value!=a&&!Mavo.data(t, "boundObserver")) {
var o=new Mavo.Observer(t, n, function() {
t.value=a;
});requestAnimationFrame(function() {
e.bind(t, "input mv-change", function a() {
o.destroy(), Mavo.data(t, "boundObserver", void 0), e.unbind(t, "input mv-change", a);
});
}), Mavo.data(t, "boundObserver", o);
}
}}, checkbox:{extend:"formControl", selector:"input[type=checkbox]", attribute:"checked", datatype:"boolean", changeEvents:"click"}, radio:{extend:"formControl", selector:"input[type=radio]", attribute:"checked", modes:"edit", getValue:function(t) {
if (t.form) {
return t.form[t.name].value;
} var a=e("input[type=radio][name=\"".concat(t.name, "\"]:checked"));return a&&a.value;
}, setValue:function(t, a) {
if (t.form) {
return void(t.form[t.name].value=a);
} var n=e("input[type=radio][name=\"".concat(t.name, "\"][value=\"").concat(a, "\"]"));e.properties(n, {checked:!0});
}, init:function(e) {
var t=this;this.mavo.element.addEventListener("change", function(a) {
a.target.name==e.name&&(t.value=t.getValue());
});
}}, counter:{extend:"formControl", selector:"button, .counter", attribute:"mv-clicked", datatype:"number", init:function(e) {
var t=this;"mv-clicked"===this.attribute&&(e.setAttribute("mv-clicked", "0"), e.addEventListener("click", function() {
var a=+e.getAttribute("mv-clicked")||0;t.value=++a;
}));
}}, "meter, progress":{default:!0, attribute:"value", datatype:"number", edit:function() {
var n=this, o=+this.element.getAttribute("min")||0, r=+this.element.getAttribute("max")||1, i=r-o, s=+this.element.getAttribute("mv-edit-step")||(1<i?1:i/100);e.bind(this.element, "mousemove.mavo:edit", function(e) {
var l=n.element.getBoundingClientRect().left, d=a(0, (e.clientX-l)/n.element.offsetWidth), c=o+i*d, p=c%s;c+=p>s/2?s-p:-p, c=a(o, t(c, r)), n.sneak(function() {
return n.element.setAttribute("value", c);
});
}), e.bind(this.element, "mouseleave.mavo:edit", function() {
n.sneak(function() {
return n.element.setAttribute("value", n.value);
});
}), e.bind(this.element, "click.mavo:edit", function() {
n.value=n.getValue();
}), e.bind(this.element, "keydown.mavo:edit", function(e) {
if (e.target==n.element&&(37==e.keyCode||39==e.keyCode)) {
var i=s*(39==e.keyCode?1:-1)*(e.shiftKey?10:1), l=n.value+i;l=a(o, t(l, r)), n.element.setAttribute("value", l), e.preventDefault();
}
});
}, done:function() {
e.unbind(this.element, ".mavo:edit");
}}, meta:{default:!0, attribute:"content"}, block:{default:!0, selector:"p, div, dt, dd, h1, h2, h3, h4, h5, h6, article, section, address", editor:function t() {
var a=getComputedStyle(this.element), n=a.display, o=0===n.indexOf("inline")?"input":"textarea", t=e.create(o);if ("textarea"==o) {
var r=this.element.offsetWidth;r&&(t.width=r), t.style.whiteSpace={normal:"pre-wrap", nowrap:"pre"}[a.whiteSpace]||"inherit";
} return t;
}, setEditorValue:function(e) {
this.datatype&&"string"!=this.datatype&&(e+="");var t=getComputedStyle(this.element);return e=e||"", -1<["normal", "nowrap"].indexOf(t.whiteSpace)&&(e=e.replace(/\r?\n/g, " ")), -1<["normal", "nowrap", "pre-line"].indexOf(t.whiteSpace)&&(e=e.replace(/^[ \t]+|[ \t]+$/gm, "").replace(/[ \t]+/g, " ")), this.editor.value=e, !0;
}}, time:{attribute:"datetime", default:!0, init:function() {
if (!this.fromTemplate("dateType")) {
var e=Mavo.DOMExpression.search(this.element, null), t=this.element.getAttribute("datetime")||"YYYY-MM-DD";for (var a in this.config.dateTypes) {
if (this.config.dateTypes[a].test(t)) {
break;
}
} this.dateType=a, e||(this.element.textContent=this.config.defaultFormats[this.dateType](this.property), this.mavo.expressions.extract(this.element, null), (e=Mavo.DOMExpression.search(this.element, null))&&this.mavo.treeBuilt.then(function() {
e.update();
}));
}
}, dateTypes:{month:/^[Y\d]{4}-[M\d]{2}$/i, time:/^[H\d]{2}:[M\d]{2}/i, "datetime-local":/^[Y\d]{4}-[M\d]{2}-[D\d]{2} [H\d]{2}:[Mi\d]{2}/i, date:/^[Y\d]{4}-[M\d]{2}-[D\d]{2}$/i}, defaultFormats:{date:function(e) {
return "[day(".concat(e, ")] [month(").concat(e, ", 'shortname')] [year(").concat(e, ")]");
}, month:function(e) {
return "[month(".concat(e, ", 'name')] [year(").concat(e, ")]");
}, time:function(e) {
return "[hour(".concat(e, ", '00')]:[minute(").concat(e, ", '00')]");
}, "datetime-local":function(e) {
return this.date(e)+" "+this.time(e);
}}, editor:function() {
return {tag:"input", type:this.dateType};
}}, "circle@r":{default:!0, datatype:"number"}, circle:{attribute:["cx", "cy"], datatype:"number"}, text:{default:!0, popup:!0}, ".mv-toggle":{default:!0, attribute:"aria-checked", datatype:"boolean", edit:function() {
var t=this;Mavo.revocably.setAttribute(this.element, "role", "checkbox"), e.bind(this.element, "click.mavo:edit keyup.mavo:edit keydown.mavo:edit", function(e) {
("click"==e.type||" "==e.key||"Enter"==e.key)&&("keydown"!=e.type&&(t.value=!t.value), e.preventDefault(), e.stopPropagation());
});
}, done:function() {
Mavo.revocably.restoreAttribute(this.element, "role"), e.unbind(this.element, ".mavo:edit");
}}});
}(Bliss, Bliss.$), function(t, e) {
Mavo.attributes.push("mv-multiple", "mv-order", "mv-accepts", "mv-initial-items", "mv-like");var a=Mavo.Collection=function(n) {
function r(e, t, a) {
var n;return _classCallCheck(this, r), n=_possibleConstructorReturn(this, _getPrototypeOf(r).call(this, e, t, a)), n.templateElement=n.element, n.children=[], n.liveData=new Mavo.Data(_assertThisInitialized(n), []), n.marker=document.createComment("mv-marker"), Mavo.data(n.marker, "collection", _assertThisInitialized(n)), n.templateElement.after(n.marker), n.addButton=n.createAddButton(), n.mavo.root||!n.templateElement.hasAttribute("mv-like")?n.init():n.mavo.treeBuilt.then(function() {
return n.init();
}), n;
} return _inherits(r, n), _createClass(r, [{key:"createAddButton", value:function() {
var a=this, n="button.mv-add-".concat(this.property), o=this.parentGroup.element, r=e(n, o).filter(function(e) {
return !a.templateElement.contains(e)&&!Mavo.data(e, "collection");
})[0];return r?(r.compareDocumentPosition(this.marker)&Node.DOCUMENT_POSITION_FOLLOWING&&Mavo.setAttributeShy(this.templateElement, "mv-order", "desc"), Mavo.revocably.remove(r)):r=t.create("button", {type:"button", className:"mv-ui", textContent:this.mavo._("add-item", this)}), r.classList.add("mv-add", "mv-add-".concat(this.property)), Mavo.data(r, "collection", this), Mavo.setAttributeShy(r, "mv-action", "add(".concat(this.property, ")")), r;
}}, {key:"init", value:function() {
var e=this;if (!this.fromTemplate("templateElement", "accepts", "initialItems", "like", "likeNode")) {
if (this.like=this.templateElement.getAttribute("mv-like"), this.like) {
var n=[];this.mavo.walk(function(t) {
t instanceof a&&t.property===e.like&&t!==e&&n.push(t);
}), 0<n.length?(this.likeNode=n.sort(function(t, a) {
return t.pathFrom(e).length-a.pathFrom(e).length;
})[0], this.likeNode=this.likeNode.likeNode||this.likeNode, this.likeNode=this.likeNode.template||this.likeNode):this.like=null;
} this.accepts=this.templateElement.getAttribute("mv-accepts"), this.accepts=new Set(this.accepts&&this.accepts.split(/\s+/)||[]), this.initialItems=+(this.templateElement.getAttribute("mv-initial-items")||(this.like?0:1)), this.templateElement=this.templateElement.cloneNode(!0);
} if (this.likeNode) {
this.itemTemplate=this.likeNode.itemTemplate||this.likeNode;var o=this.likeNode.templateElement||t.value(this.likeNode.collection, "templateElement")||this.likeNode.element;this.templateElement=o.cloneNode(!0), this.templateElement.setAttribute("property", this.property), this.accepts.size||(this.accepts=this.likeNode.accepts||this.accepts);
}
else if (0<this.initialItems||!this.template) {
var r=this.createItem(this.element);this.add(r, void 0, {silent:!0});
} this.mavo.treeBuilt.then(function() {
if (!e.initialItems) {
r?e["delete"](r, {silent:!0}):e.element.remove();
}
else if (1<e.initialItems) {
for (var t=1;t<e.initialItems;t++) {
e.add();
}
}
}), this.postInit(), Mavo.hooks.run("collection-init-end", this);
}}, {key:"getData", value:function() {
var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}, t={context:this, options:e};return t.data=this.children.map(function(e) {
return e.getData(t.options);
}).filter(function(e) {
return null!==Mavo.value(e);
}), t.data=Mavo.subset(this.data, this.inPath, t.data), Mavo.hooks.run("node-getdata-end", t), t.data;
}}, {key:"createItem", value:function(e) {
e||(e=this.templateElement.cloneNode(!0));var t=this.itemTemplate||(this.template?this.template.itemTemplate:null), a=Mavo.Node.create(e, this.mavo, {collection:this, template:t, property:this.property, type:this.type});return this.itemTemplate||(this.itemTemplate=t||a), a;
}}, {key:"add", value:function(e, a) {
var n=this, r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};e=e instanceof Node?Mavo.Node.get(e)||this.createItem(e):e||this.createItem(), e.collection!=this&&this.adopt(e), void 0===a&&(a=this.bottomUp?0:this.length);var o=this.children[a]?this.children[a].element:this.marker;t.before(e.element, o);var s={context:this, item:e};return s.previousIndex=e.index, s.changed=this.splice({remove:s.item}, {index:a, add:s.item}), this.mavo.expressions.active&&!r.silent&&requestAnimationFrame(function() {
s.changed.forEach(function(e) {
e.dataChanged(e==s.item&&void 0===s.previousIndex?"add":"move"), e.unsavedChanges=!0;
}), n.unsavedChanges=n.mavo.unsavedChanges=!0, n.mavo.expressions.update(s.item);
}), Mavo.hooks.run("collection-add-end", s), s.item;
}}, {key:"splice", value:function() {
for (var e=this, t=arguments.length, a=Array(t), n=0;n<t;n++) {
a[n]=arguments[n];
}a.forEach(function(t) {
void 0===t.index&&t.remove&&isNaN(t.remove)&&(t.index=e.children.indexOf(t.remove), t.remove=1);
}), a.sort(function(e, t) {
return t.index-e.index;
});var o=[], r=[];a.forEach(function(t) {
if (-1<t.index&&(t.remove||t.add)) {
var a, n;t.remove=t.remove||0, t.add=Mavo.toArray(t.add), (a=r).push.apply(a, _toConsumableArray((n=e.children).splice.apply(n, [t.index, +t.remove].concat(_toConsumableArray(t.add)))));
}
}), r=new Set(r);for (var s=0, l;s<this.length;s++) {
l=this.children[s], r["delete"](l), l&&l.index!==s&&(l.index=s, o.push(l));
} return r.forEach(function(e) {
e.expressions&&e.expressions.forEach(function(t) {
e.mavo.expressions.unregister(t);
});
}), this.liveData.update(), o;
}}, {key:"adopt", value:function(e) {
var t=this;e.collection&&(e.collection.splice({remove:e}), e.collection.dataChanged("delete")), e.collection=this, this.walk(function(a) {
a.closestCollection===e.collection&&(a.closestCollection=t), e.mavo!=t.mavo&&(a.mavo=t.mavo), a.path=a.getPath();
}), e.template&&(Mavo["delete"](e.template.copies, e), e.template=this.itemTemplate);
}}, {key:"delete", value:function(e) {
var a=this, n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}, o=n.silent, r=n.undoable, i=void 0===r?!o:r, s=n.transition, l=void 0===s?!o:s, d=n.destroy, c=void 0===d?!i:d;if (e.element.classList.remove("mv-highlight"), this.splice({remove:e}), !o&&l) {
var p=t.transition(e.element, {opacity:0}).then(function() {
e.element.style.opacity="";
});
}
else {
var p=Promise.resolve();
} return p.then(function() {
return t.remove(e.element), o||(a.unsavedChanges=e.unsavedChanges=a.mavo.unsavedChanges=!0, e.collection.dataChanged("delete", {index:e.index})), i?a.mavo.setDeleted(e):c&&e.destroy(), e;
});
}}, {key:"move", value:function(e, t) {
var a=e.index+t+(0<t);a=Mavo.wrap(a, this.children.length+1), this.add(e, a);
}}, {key:"editItem", value:function(e) {
var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}, a=t.immediately?Promise.resolve():Mavo.inView.when(e.element);return a.then(function() {
return e.itembar||(e.itembar=new Mavo.UI.Itembar(e)), e.itembar.add(), e.edit(t);
});
}}, {key:"edit", value:function() {
var n=this, i=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};if (!1===_get(_getPrototypeOf(r.prototype), "edit", this).call(this)) {
return !1;
} if (!this.addButton.parentNode) {
var e=this.element.tagName.toLowerCase();if (e in Mavo.selectors.container) {
var o=this.marker.parentNode.closest(Mavo.selectors.container[e]);
}
else if (this.bottomUp&&this.children[0]) {
var o=this.children[0].element;
}o=o||this.marker, Mavo.revocably.add(this.addButton, function(a) {
return t[n.bottomUp?"before":"after"](a, o);
});
} return a.dragula.then(function() {
n.getDragula();
}), Promise.all(this.children.map(function(e) {
return n.editItem(e, i);
}));
}}, {key:"done", value:function() {
return !1!==_get(_getPrototypeOf(r.prototype), "done", this).call(this)&&void(Mavo.revocably.remove(this.addButton), this.propagate(function(e) {
e.itembar&&e.itembar.remove();
}));
}}, {key:"dataChanged", value:function(e) {
var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return t.element=t.element||this.marker, _get(_getPrototypeOf(r.prototype), "dataChanged", this).call(this, e, t);
}}, {key:"dataRender", value:function(e) {
var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if (void 0!==e) {
e=null===e?[]:Mavo.toArray(e).filter(function(e) {
return null!==e;
});for (var a=!1, n=0, o;n<this.children.length;n++) {
o=this.children[n], n<e.length?a=o.render(e[n], t)||a:(a=!0, this["delete"](o, {silent:!0}), n--);
} if (e.length>n) {
for (var r=document.createDocumentFragment(), s=n, o;s<e.length;s++) {
o=this.createItem(), a=o.render(e[s], t)||a, this.children.push(o), o.index=s, r.appendChild(o.element);var l={context:this, item:o};Mavo.hooks.run("collection-add-end", l);
} this.marker.before(r);
} if (this.liveData.update(), e.length>n) {
for (var s=n;s<this.children.length;s++) {
this.children[s].dataChanged("add");
}
} return a;
}
}}, {key:"isCompatible", value:function(e) {
return e&&this.itemTemplate.constructor==e.itemTemplate.constructor&&(e===this||e.template==this||this.template==e||this.template&&this.template==e.template||-1<this.accepts.has(e.property));
}}, {key:"destroy", value:function() {
_get(_getPrototypeOf(r.prototype), "destroy", this).call(this), this.dragula&&(this.dragula.destroy(), this.dragula=null), this.propagate("destroy");
}}, {key:"getDragula", value:function() {
var e=this;if (this.dragula) {
return this.dragula;
} if (this.template) {
return Mavo.pushUnique(this.template.getDragula().containers, this.marker.parentNode), this.dragula=this.template.dragula||this.template.getDragula();
} this;return this.dragula=dragula({containers:[this.marker.parentNode], isContainer:function(t) {
return !!e.accepts.size&&Array.from(t.childNodes).some(function(t) {
var n=a.get(t);return n&&e.accepts.has(n.property);
});
}, moves:function(e, t, a) {
return a.classList.contains("mv-drag-handle")&&a.closest(Mavo.selectors.multiple)==e;
}, accepts:function(e, t, n, o) {
if (e.contains(t)) {
return !1;
} var r=o?o.previousElementSibling:t.lastElementChild, i=a.get(r)||a.get(o);if (!i) {
return !1;
} var s=Mavo.Node.get(e);return s&&s.collection.isCompatible(i);
}}), this.dragula.on("drop", function(t) {
var n=Mavo.Node.get(t), o=n&&n.index, r=t.nextElementSibling, i=t.previousElementSibling, s=a.get(i)||a.get(r), l=Mavo.Node.get(i)||Mavo.Node.get(r);if (l&&l.collection!=s&&(l=null), n.collection.isCompatible(s)) {
var d=l?l.index+(l.element===i):s.length;s.add(n, d);
}
else {
return e.dragula.cancel(!0);
}
}), a.dragulas.push(this.dragula), this.dragula;
}}, {key:"getClosestCollection", value:function() {
return this;
}}, {key:"length", get:function() {
return this.children.length;
}}], [{key:"get", value:function(e) {
var t=Mavo.data(e, "collection");if (t) {
return t;
} var a=Mavo.Node.get(e);return a&&a.collection||null;
}}, {key:"delete", value:function(e) {
var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}, a=new Mavo.BucketMap({arrays:!0}), n=new Set, o={silent:!0, undoable:!1, destroy:!1}, r=e.filter(function(e) {
return !!e.collection;
}).map(function(e) {
return n.add(e.collection), e.collection["delete"](e, o).then(function(e) {
return a.set(e.mavo, e);
});
});t.silent||Promise.all(r).then(function() {
n.forEach(function(e) {
e.dataChanged("delete");
}), !1!==t.undoable&&a.forEach(function(e, t) {
t.setDeleted.apply(t, _toConsumableArray(e));
});
});
}}]), r;
}(Mavo.Node);t.Class(a, {lazy:{bottomUp:function() {
return /^desc\b/i.test(this.templateElement.getAttribute("mv-order"));
}}, static:{dragulas:[], lazy:{dragula:function() {
return t.include(self.dragula, "https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.min.js");
}}}});
}(Bliss, Bliss.$), function() {
Mavo.ImplicitCollection=function(e) {
function t(e, a, n) {
var o;return _classCallCheck(this, t), o=_possibleConstructorReturn(this, _getPrototypeOf(t).call(this, e, a, n)), o.children=[], o.liveData=new Mavo.Data(_assertThisInitialized(o), []), o.add(e), o.postInit(), Mavo.hooks.run("implicit-collection-init-end", _assertThisInitialized(o)), o;
} return _inherits(t, e), _createClass(t, [{key:"getData", value:function() {
var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}, t={context:this, options:e, data:[]};if (this.children.forEach(function(a) {
a.isDataNull()||t.data.push(a.getData(e));
}), this.data) {
var a=Mavo.toArray(Mavo.subset(this.data, this.inPath));a.length>t.data.length&&(t.data=t.data.concat(a.slice(t.data.length)));
} return Array.isArray(t.data)&&1>=t.data.length&&(t.data=1===t.data.length?t.data[0]:null), t.data=Mavo.subset(this.data, this.inPath, t.data), Mavo.hooks.run("node-getdata-end", t), t.data;
}}, {key:"add", value:function(e) {
var t=Mavo.Node.create(e, this.mavo, {collection:this, template:this.template&&this.template.children[this.length]||null, property:this.property, type:this.type});return t.index=this.length, this.children.push(t), this.liveData.update(), t;
}}, {key:"edit", value:function() {
var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return !1!==_get(_getPrototypeOf(t.prototype), "edit", this).call(this)&&Promise.all(this.children.map(function(t) {
return t.edit(e);
}));
}}, {key:"dataRender", value:function(e) {
var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if (void 0!==e) {
e=null===e?[]:Mavo.toArray(e).filter(function(e) {
return null!==e;
});var a=e.length!==this.liveData.length;this.children.forEach(function(n, o) {
return a=n.render(e&&e[o], t)||a;
});
} this.liveData.update();
}}, {key:"length", get:function() {
return this.children.length;
}}]), t;
}(Mavo.Node);
}(Bliss, Bliss.$), function(e, t) {
var a=Mavo.UI.Itembar=e.Class({constructor:function(a) {
var n=this;if (this.item=a, this.element=t(".mv-item-bar:not([mv-rel]), .mv-item-bar[mv-rel=\"".concat(this.item.property, "\"]"), this.item.element).filter(function(e) {
return e.closest(Mavo.selectors.multiple)==n.item.element&&!Mavo.data(e, "item");
})[0], !this.element&&this.item.template&&this.item.template.itembar) {
this.element=this.item.template.itembar.element.cloneNode(!0), this.dragHandle=e(".mv-drag-handle", this.element)||this.item.element;
}
else {
this.element=this.element||e.create({className:"mv-item-bar mv-ui"});var o=this.collection.bottomUp, r="$item".concat(o?", $index + 1":""), i=[{tag:"button", type:"button", title:this.mavo._("delete-item", this.item), className:"mv-delete", "mv-action":"delete($item)"}, {tag:"button", type:"button", title:this.mavo._("add-item-".concat(o?"after":"before"), this.item), className:"mv-add", "mv-action":"if($cmd, add($item, ".concat(r, "), add(").concat(r, "))")}];this.item instanceof Mavo.Group?(this.dragHandle=e.create({tag:"button", type:"button", title:this.mavo._("drag-to-reorder", this.item), className:"mv-drag-handle"}), i.push(this.dragHandle)):this.dragHandle=this.item.element, e.set(this.element, {"mv-rel":this.item.property, contents:i});
} this.element.setAttribute("hidden", ""), e.bind([this.item.element, this.element], "focusin mouseover", this), e.bind(this.element, {mouseenter:function() {
n.item.element.classList.add("mv-highlight");
}, mouseleave:function() {
n.item.element.classList.remove("mv-highlight");
}}), this.dragHandle.addEventListener("keydown", function(e) {
e.target===n.dragHandle&&n.item.editing&&37<=e.keyCode&&40>=e.keyCode&&(n.collection.move(n.item, 38>=e.keyCode?-1:1), e.stopPropagation(), e.preventDefault(), e.target.focus());
}), this.dragHandle!==this.item.element&&this.dragHandle.addEventListener("click", function(e) {
return e.target.focus();
}), Mavo.data(this.element, "item", this.item);
}, destroy:function() {
this.hide();
}, show:function(t) {
var n=this;a.visible.forEach(function(e) {
e!=n&&(!n.sticky||e.sticky)&&(clearTimeout(e.hideTimeout), e.hide(t, a.DELAY));
}), a.visible.add(this), (this.element.hasAttribute("hidden")||t&&!this.sticky)&&(this.element.removeAttribute("hidden"), this.sticky=this.sticky||t, e.bind([this.item.element, this.element], "focusout mouseleave", this));
}, hide:function(t) {
var n=this, o=1<arguments.length&&arguments[1]!==void 0?arguments[1]:0;(!this.sticky||t)&&(o?this.hideTimeout=setTimeout(function() {
return n.hide(t);
}, o):(this.element.setAttribute("hidden", ""), e.unbind([this.item.element, this.element], "focusout mouseleave", this), this.sticky=!1, a.visible["delete"](this)));
}, handleEvent:function(e) {
var t=-1===e.type.indexOf("mouse");this.isWithinItem(e.target)&&(clearTimeout(this.hideTimeout), -1<["mouseleave", "focusout", "blur"].indexOf(e.type)?!this.isWithinItem(e.relatedTarget)&&this.hide(t, a.DELAY):(this.show(t), e.stopPropagation()));
}, isWithinItem:function(e) {
if (!e) {
return !1;
} var t=e.closest(".mv-item-bar");return t?t===this.element:e.closest(Mavo.selectors.item)===this.item.element;
}, add:function() {
if (!this.element.parentNode&&!Mavo.revocably.add(this.element)) {
var t=this.item.element.nodeName.toLowerCase();if (t in a.container) {
var n=e(a.container[t], this.item.element);
}(n||this.item.element).appendChild(this.element);
} this.dragHandle==this.item.element&&this.item.element.classList.add("mv-drag-handle");
}, remove:function() {
Mavo.revocably.remove(this.element), this.dragHandle==this.item.element&&this.item.element.classList.remove("mv-drag-handle");
}, live:{sticky:function(e) {
this.element.classList.toggle("mv-sticky", e);
}}, proxy:{collection:"item", mavo:"item"}, static:{DELAY:100, visible:new Set, container:{details:"summary"}}});
}(Bliss, Bliss.$), function(e) {
var t=Mavo.Expression=e.Class({constructor:function(e) {
this.expression=e;
}, eval:function() {
var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:Mavo.Data.stub, t=1<arguments.length?arguments[1]:void 0;if (Mavo.hooks.run("expression-eval-beforeeval", this), !this["function"]) {
try {
this["function"]=Mavo.Script.compile(this.expression, t);
}
catch (e) {
return this.error("There is something wrong with the expression ".concat(this.expression), e.message, "Not an expression? See https://mavo.io/docs/expressions/#disabling-expressions for information on how to disable expressions."), Mavo.hooks.run("expression-compile-error", {context:this, error:e}), this["function"]=e;
}
}
 else if (this["function"]instanceof Error) {
return this["function"];
} try {
return this["function"](e);
}
catch (t) {
return this.error("Something went wrong with the expression ".concat(this.expression), t.message, "Data was: ".concat(JSON.stringify(e))), Mavo.hooks.run("expression-eval-error", {context:this, error:t}), t;
}
}, error:function(e) {
for (var t=arguments.length, a=Array(1<t?t-1:0), n=1;n<t;n++) {
a[n-1]=arguments[n];
}a=a.join("\n"), console.info("%cOops! \uD83D\uDE33 ".concat(e, ":"), "color: #c04; font-weight: bold;", a);
}, toString:function() {
return this.expression;
}, changedBy:function(e) {
return t.changedBy(this.identifiers, e);
}, live:{expression:function(e) {
this["function"]=null, this.identifiers=e.match(/[$a-z][$\w]*/ig)||[];
}}});t.Syntax=e.Class({constructor:function(e, t) {
this.start=e, this.end=t, this.regex=RegExp("".concat(Mavo.escapeRegExp(e), "([\\S\\s]*?)").concat(Mavo.escapeRegExp(t)), "gi");
}, test:function(e) {
return this.regex.lastIndex=0, this.regex.test(e);
}, tokenize:function(e) {
var t=[], a=0, n;for (this.regex.lastIndex=0;null!==(n=this.regex.exec(e));) {
n.index>a&&t.push(e.substring(a, n.index)), a=this.regex.lastIndex, /\S/.test(n[1])?t.push(new Mavo.Expression(n[1])):t.push(n[0]);
} return a<e.length&&t.push(e.substring(a)), t;
}, static:{create:function(e) {
if (e) {
var a=e.getAttribute("mv-expressions");if (a) {
return a=a.trim(), /\s/.test(a)?_construct(t.Syntax, _toConsumableArray(a.split(/\s+/))):t.Syntax.ESCAPE;
}
}
}, ESCAPE:-1}}), t.Syntax["default"]=new t.Syntax("[", "]");
}(Bliss, Bliss.$), function(e) {
var t=Mavo.DOMExpression=e.Class({constructor:function() {
var e=this, a=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};this.mavo=a.mavo, this.template=a.template&&a.template.template||a.template;for (var n=0, o=["item", "path", "syntax", "fallback", "attribute", "originalAttribute", "expression", "parsed", "identifiers"], r;n<o.length;n++) {
r=o[n], this[r]=void 0===a[r]&&this.template?this.template[r]:a[r];
} if (this.node=a.node, this.node||(this.node=Mavo.elementPath(this.item.element, this.path)), this.element=this.node, this.attribute=this.attribute||null, Mavo.hooks.run("domexpression-init-start", this), "mv-value"==this.attribute) {
this.originalAttribute="mv-value", this.attribute=Mavo.Primitive.getValueAttribute(this.element), this.fallback=this.fallback||Mavo.Primitive.getValue(this.element, {attribute:this.attribute});var i=this.element.getAttribute("mv-value");this.element.removeAttribute("mv-value"), this.parsed=[new Mavo.Expression(i)], this.expression=this.syntax.start+i+this.syntax.end;
} if (3===this.node.nodeType&&this.element===this.node&&(this.element=this.node.parentNode, (!this.node.parentNode.children.length||this.attribute)&&(this.node=this.element, this.element.normalize())), !this.expression) {
if (this.attribute) {
var s=Element.prototype.getAttribute.call(this.node, this.attribute);this.expression=(s||"").trim();
}
else {
if (this.node.normalize(), this.node.firstChild&&1===this.node.childNodes.length&&3===this.node.firstChild.nodeType) {
var l=this.node.firstChild.textContent.match(/^\s*|\s*$/g);l[1]&&(this.node.firstChild.splitText(this.node.firstChild.textContent.length-l[1].length), this.node.after(this.node.lastChild)), l[0]&&(this.node.firstChild.splitText(l[0].length), this.node.parentNode.insertBefore(this.node.firstChild, this.node));
} this.expression=this.node.textContent;
} this.parsed=this.template?this.template.parsed:this.syntax.tokenize(this.expression);
} this.oldValue=this.value=this.parsed.map(function(e) {
return e instanceof Mavo.Expression?e.expression:e;
}), this.identifiers=this.identifiers||Mavo.flatten(this.parsed.map(function(e) {
return e.identifiers||[];
})), t.special.add(this), this.mavo.treeBuilt.then(function() {
e.template||e.item||(e.item=Mavo.Node.getClosestItem(e.element)), "mv-value"==e.originalAttribute&&e.mavoNode&&e.mavoNode==e.item.collection&&Mavo["delete"](e.item.expressions, e), e.mavo.expressions.register(e), Mavo.hooks.run("domexpression-init-treebuilt", e);
}), Mavo.hooks.run("domexpression-init-end", this), t.elements.set(this.element, [].concat(_toConsumableArray(t.elements.get(this.element)||[]), [this]));
}, destroy:function() {
t.special["delete"](this), this.mavo.expressions.unregister(this);
}, get isDynamicObject() {
return "mv-value"==this.originalAttribute&&this.mavoNode&&!(this.mavoNode instanceof Mavo.Primitive);
}, changedBy:function(e) {
return this.isDynamicObject?!e||!this.mavoNode.contains(e.node):Mavo.Expression.changedBy(this.identifiers, e);
}, update:function() {
var e=this, t={context:this}, a=t;if (this.item) {
var n=this.isDynamicObject?this.item.parent:this.item, o=this.data=n.getLiveData();
}
else {
var o=void 0===this.data?Mavo.Data.stub:this.data;
}Mavo.hooks.run("domexpression-update-start", t), this.oldValue=this.value;var r=!1;t.value=this.value=this.parsed.map(function(t) {
if (t instanceof Mavo.Expression) {
var n={context:e, expr:t, parentEnv:a};return Mavo.hooks.run("domexpression-update-beforeeval", n), n.value=Mavo.value(n.expr.eval(o)), Mavo.hooks.run("domexpression-update-aftereval", n), r=!0, n.value instanceof Error?void 0===e.fallback?e.syntax.start+n.expr.expression+e.syntax.end:e.fallback:void 0===n.value||null===n.value?"":n.value;
} return t;
});r&&(t.value=1===t.value.length?t.value[0]:t.value.map(function(t) {
return Mavo.Primitive.format(t, {attribute:e.attribute, element:e.element});
}).join(""), this.output(t.value), Mavo.hooks.run("domexpression-update-end", t));
}, output:function(e) {
this.primitive?(Mavo["in"](Mavo.isProxy, e)&&(e=Mavo.clone(e)), this.primitive.value=e):this.mavoNode?this.mavoNode.render(e):Mavo.Primitive.setValue(this.node, e, {attribute:this.attribute});
}, live:{item:function(e) {
e&&this._item!=e&&(this._item&&Mavo["delete"](this._item.expressions, this), e.expressions=e.expressions||[], e.expressions.push(this));
}}, static:{elements:new WeakMap, search:function(e, a) {
if (null===e) {
return e;
}a&&!e.ownerDocument.xmlVersion&&(a=a.toLowerCase());var n=t.elements.get(e)||[];return 1<arguments.length?n.length?n.filter(function(e) {
return e.attribute===a;
})[0]||null:null:n;
}, special:{add:function(e, t) {
if (t) {
var a=this.vars[t], n=-1<e.identifiers.indexOf(t), o=t.startsWith("$")&&-1<e.identifiers.indexOf(t.substr(1));a&&(n||o)&&(a.all=a.all||new Set, a.all.add(e), 1===a.all.size?a.observe():!a.all.size&&a.unobserve());
}
else {
for (var t in this.vars) {
this.add(e, t);
}
}
}, delete:function(e, t) {
if (t) {
var a=this.vars[t];a.all=a.all||new Set, a.all["delete"](e), a.all.size||a.unobserve();
}
else {
for (var t in this.vars) {
this["delete"](e, t);
}
}
}, update:function() {
this.update&&this.update.apply(this, arguments), this.all.forEach(function(e) {
return e.update();
});
}, event:function(e) {
var a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}, n=a.type, o=a.update, r=a.target, i=void 0===r?document:r;this.vars[e]={observe:function() {
this.callback=this.callback||t.special.update.bind(this), i.addEventListener(n, this.callback);
}, unobserve:function() {
i.removeEventListener(n, this.callback);
}}, o&&(this.vars[e].update=function(t) {
Mavo.Functions[e]=o(t);
});
}, vars:{$now:{observe:function() {
var e=this;this.timer=requestAnimationFrame(function a() {
t.special.update.call(e), e.timer=requestAnimationFrame(a);
});
}, unobserve:function() {
cancelAnimationFrame(this.timer);
}}}}}});t.special.event("$mouse", {type:"mousemove", update:function(e) {
return {x:e.clientX, y:e.clientY};
}}), t.special.event("$hash", {type:"hashchange", target:window});
}(Bliss, Bliss.$), function(e, t) {
Mavo.attributes.push("mv-expressions");var a=Mavo.Expressions=e.Class({constructor:function(e) {
var t=this;this.mavo=e, this.active=!0, this.expressions=[], this.identifiers={};var a=Mavo.Expression.Syntax.create(this.mavo.element.closest("[mv-expressions]"))||Mavo.Expression.Syntax["default"];this.traverse(this.mavo.element, void 0, a), this.scheduled={}, this.mavo.treeBuilt.then(function() {
t.expressions=[], t.update();
});
}, register:function(e) {
var t=this, a=this.identifiers;e.registeredApp=e.registeredApp||new Set, e.identifiers.forEach(function(n) {
a[n]instanceof Set||(a[n]=new Set), a[n].add(e), Mavo.all[n]instanceof Mavo&&Mavo.all[n]!==t.mavo&&!e.registeredApp.has(n)&&(e.registeredApp.add(n), Mavo.all[n].expressions.register(e));
});
}, unregister:function(e) {
var t=this.identifiers;e.identifiers.forEach(function(a) {
t[a]&&t[a]["delete"](e), a in Mavo.all&&"undefined"!=typeof domexpresssion&&Mavo.all[a].expressions.unregister(domexpresssion);
});
}, updateThrottled:function(e) {
var t=this;if (this.active) {
var n=this.scheduled[e.action]=this.scheduled[e.action]||new Set;e.node.template?!n.has(e.node.template)&&(setTimeout(function() {
n["delete"](e.node.template), t.update(e);
}, a.THROTTLE), n.add(e.node.template)):requestAnimationFrame(function() {
return t.update(e);
});
}
}, update:function(e) {
if (this.active) {
var t, a;if (e instanceof Mavo.Node) {
a=e;
}
else if (e instanceof Element) {
t=e.closest(Mavo.selectors.item), a=Mavo.Node.get(t);
}
else {
if (e) {
var n={updated:new Set};if (this.updateByIdThrottled(e.property, e, n), "propertychange"==e.action) {
e.node&&e.node.path&&this.updateByIdThrottled(e.node.path, e, n);
}
else {
this.updateById(Object.keys(Mavo.Data.special), e, n);var o=e.node.collection||e.node;this.updateById(o.properties, e, n);
} return;
}a=this.mavo.root;
}a.walk(function(t) {
return !!t.expressionsEnabled&&void(t.expressions&&t.expressions.forEach(function(t) {
e&&t.mavoNode===e||t.update();
}));
});
}
}, updateByIdThrottled:function(e, t, n) {
var o=this;if (e) {
if (e.forEach) {
e.forEach(function(e) {
return o.updateByIdThrottled(e, t, n);
});
}
else {
var r=this.scheduledIds=this.scheduledIds||new Set;r.has(e)||(setTimeout(function() {
r["delete"](e), o.updateById(e, t, n);
}, a.THROTTLE), r.add(e));
}
}
}, updateById:function(e, t, a) {
var n=this;if (e.forEach) {
return void e.forEach(function(e) {
return n.updateById(e, t, a);
});
} var o=this.identifiers[e];o&&o.forEach(function(e) {
"mv-value"==e.originalAttribute&&e.mavoNode&&!(e.mavoNode instanceof Mavo.Primitive)&&e.mavoNode.contains(t.node)||!a.updated.has(e)&&e.update();
});
}, extract:function(e, t, n) {
var o=3<arguments.length&&arguments[3]!==void 0?arguments[3]:Mavo.Expression.Syntax["default"];t&&-1<a.skip.indexOf(t.name)||(t&&-1<a.directives.indexOf(t.name)||o!==Mavo.Expression.Syntax.ESCAPE&&o.test(t?t.value:e.textContent))&&(n===void 0&&(n=Mavo.elementPath(e.closest(Mavo.selectors.item), e)), this.expressions.push(new Mavo.DOMExpression({node:e, syntax:o, path:n, attribute:t&&t.name, mavo:this.mavo})));
}, traverse:function(e) {
var a=this, n=1<arguments.length&&arguments[1]!==void 0?arguments[1]:[], o=2<arguments.length?arguments[2]:void 0;if (8!==e.nodeType) {
if (3===e.nodeType) {
this.extract(e, null, n, o);
}
else {
if (e.normalize(), o=Mavo.Expression.Syntax.create(e)||o, Mavo.is("item", e)&&(n=[]), e.hasAttribute("mv-expressions-ignore")) {
var r=new Set(e.getAttribute("mv-expressions-ignore").trim().split(/\s*,\s*/));
}t(e.attributes).forEach(function(t) {
r&&r.has(t.name)||a.extract(e, t, n, o);
});var i=-1, s=0;e.matches("script:not([mv-expressions])")||t(e.childNodes).forEach(function(e) {
if (1==e.nodeType?(s=0, i++):s++, 1==e.nodeType||3==e.nodeType) {
var t=0<s?"".concat(i, ".").concat(s):i;a.traverse(e, [].concat(_toConsumableArray(n||[]), [t]), o);
}
});
}
}
}, static:{directives:["mv-value"], skip:["mv-expressions", "mv-action"], THROTTLE:50, directive:function(e, t) {
a.directives.push(e), Mavo.attributes.push(e), Mavo.Plugins.register(e, t);
}}});
}(Bliss, Bliss.$), function(e, t) {
Mavo.Expressions.directive("mv-if", {extend:{Primitive:{live:{hidden:function(e) {
this._hidden!==e&&(this._hidden=e, this.liveData.update(), this.dataChanged());
}}}, DOMExpression:{lazy:{childProperties:function() {
var e=this, a=t(Mavo.selectors.property, this.element).filter(function(t) {
return t.closest("[mv-if]")==e.element;
}).map(function(e) {
return Mavo.Node.get(e);
});return this.element.addEventListener("mv-change", function(t) {
requestAnimationFrame(function() {
e.element.parentNode||e.item.element.dispatchEvent(t);
});
}), a;
}}}}, hooks:{"domexpression-init-start":function() {
"mv-if"!=this.attribute||(!Mavo.Node.prototype.fromTemplate.call(this, "parsed", "expression")&&(this.expression=this.element.getAttribute("mv-if"), this.parsed=[new Mavo.Expression(this.expression)], this.expression=this.syntax.start+this.expression+this.syntax.end), this.parentIf=this.element.parentNode&&Mavo.DOMExpression.search(this.element.parentNode.closest("[mv-if]"), "mv-if"), this.parentIf&&(this.parentIf.childIfs=(this.parentIf.childIfs||new Set).add(this)));
}, "domexpression-update-end":function() {
var e=this;if ("mv-if"==this.attribute) {
var t=this.value[0], a=this.oldValue[0];this.item.mavo.treeBuilt.then(function() {
if (e.parentIf) {
var n=e.parentIf.value[0];e.value[0]=t=t&&n;
}!1!==n&&(t?Mavo.revocably.add(e.element):e.element.parentNode&&Mavo.revocably.remove(e.element, "mv-if")), t!==a&&(e.childProperties&&e.childProperties.forEach(function(e) {
return e.hidden=!t;
}), e.childIfs&&e.childIfs.forEach(function(e) {
return e.update();
}));
});
}
}, "node-isdatanull":function(e) {
e.result=e.result||this.hidden&&e.options.live;
}}});
}(Bliss, Bliss.$), function(e, t) {
var r=Math.floor, s=Math.abs, l=Math.min;function a() {
var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"";return e=t(e), e||0===e?e+"":"";
} function n(e) {
return e=Mavo.value(e), null===e||!1===e||""===e;
} function o(e) {
return !t(e);
} var d=arguments, c=Mavo.Functions={operators:{"=":"eq"}, get:function(e, a) {
var n=2<arguments.length&&arguments[2]!==void 0?arguments[2]:{};a=n.property=t(a);var o=Mavo.getCanonicalProperty(e, a);if (o!==void 0) {
n.property=o;var r=e[o];return "function"==typeof r&&0!==r.name.indexOf("bound")?r.bind(e):r;
} if (Array.isArray(e)&&a&&isNaN(a)) {
var i=a.indexOf("=");return -1<i?(n.query={property:a.slice(0, i), value:a.slice(i+1)}, n.property=[], r=e.filter(function(t, e) {
var a=c.get(t, n.query.property)==n.query.value;return a&&n.property.push(e), a;
}), "id"==n.query.property&&(n.property=n.property[0], r=r[0]), void 0===r?n.property=e.length:0===r.length&&(n.property=[e.length]), r):e.map(function(t) {
return c.get(t, a);
});
} return null;
}, call:function(e, t, a) {
return e?"function"==typeof e?e.apply(a, t):void Mavo.warn("You tried to call ".concat(e, " as a function, but it\u2019s not a function")):void 0;
}, url:function(e) {
var t=1<arguments.length&&arguments[1]!==void 0?arguments[1]:location;if (e===void 0) {
return location.href;
} if (e) {
e=a(e).replace(/[^\w-:]/g);var n=t.search.match(RegExp("[?&]".concat(e, "(?:=(.+?))?(?=$|&)")))||t.pathname.match(RegExp("(?:^|\\/)".concat(e, "\\/([^\\/]*)")));
} return null!==n&&e?decodeURIComponent(n[1]||""):null;
}, first:function(e, t) {
if (void 0===t&&(t=e, e=void 0), void 0===t) {
return null;
} if (!Array.isArray(t)) {
return void 0===e?t:[t];
} if (0>e) {
return c.last(s(e), t);
} for (var a=[], o=void 0===e?1:r(e), l=0;l<t.length&&a.length<o;l++) {
null!==Mavo.value(t[l])&&a.push(t[l]);
} return void 0===e?void 0===a[0]?null:a[0]:a;
}, last:function(e, t) {
if (void 0===t&&(t=e, e=void 0), void 0===t) {
return null;
} if (!Array.isArray(t)) {
return void 0===e?t:[t];
} if (0>e) {
return c.first(s(e), t);
} for (var a=[], o=void 0===e?1:r(e), l=t.length-1;0<=l&&a.length<o;l--) {
null!==Mavo.value(t[l])&&a.push(t[l]);
} return void 0===e?void 0===a[0]?null:a[0]:a;
}, unique:function(e) {
return Array.isArray(e)?_toConsumableArray(new Set(e.map(t))):e;
}, intersects:function(e, a) {
if (e&&a) {
var n=new Set(Mavo.toArray(a).map(t));return e=Mavo.toArray(e).map(t), !e.every(function(e) {
return !n.has(e);
});
}
}, sum:e.extend(function(e) {
return i.numbers(e, arguments).reduce(function(e, t) {
return +e+(+t||0);
}, 0);
}, {isAggregate:!0}), average:e.extend(function(e) {
return e=i.numbers(e, arguments), e.length&&c.sum(e)/e.length;
}, {isAggregate:!0, alias:"avg"}), median:e.extend(function(e) {
var t=Math.ceil;e=i.numbers(e, arguments).sort(function(e, t) {
return e-t;
});var a=(e.length-1)/2, n=[e[r(a)], e[t(a)]];return m1=n[0], m2=n[1], (m1+m2)/2||0;
}, {isAggregate:!0}), min:e.extend(function(e) {
return l.apply(Math, _toConsumableArray(i.numbers(e, arguments)));
}, {isAggregate:!0}), max:e.extend(function(e) {
return Math.max.apply(Math, _toConsumableArray(i.numbers(e, arguments)));
}, {isAggregate:!0}), atan2:e.extend(function(e, t) {
return Math.atan2(e, t);
}, {multiValued:!0, rightUnary:function(e) {
return e;
}, default:1}), pow:e.extend(function(e, t) {
return Math.pow(e, t);
}, {multiValued:!0, default:1}), imul:e.extend(function(e, t) {
return Math.imul(e, t);
}, {multiValued:!0, default:1}), count:e.extend(function(e) {
return Mavo.toArray(e).filter(function(e) {
return !n(e);
}).length;
}, {isAggregate:!0}), reverse:function(e) {
return Mavo.toArray(e).slice().reverse();
}, round:e.extend(function(e, t) {
var a=Math.round;return o(e)||o(t)||!isFinite(e)?a(e):+e.toLocaleString("en-US", {useGrouping:!1, maximumFractionDigits:t});
}, {multiValued:!0, rightUnary:function(e) {
return e;
}, default:0}), ordinal:e.extend(function(e) {
if (n(e)) {
return "";
} if (10>e||20<e) {
var t=["th", "st", "nd", "rd", "th"][e%10];
} return t||"th";
}, {multiValued:!0, alias:"th"}), digits:e.extend(function(e, t, a) {
if (void 0===a&&(a=t, t=void 0), isNaN(a)) {
return null;
} var n=(a+"").split(".");return n[0]=n[0].slice(-e), void 0!==t&&n[1]&&(n[1]=n[1].slice(0, t)), a=+n.join("."), a.toLocaleString("en", {useGrouping:!1, minimumIntegerDigits:e, minimumFractionDigits:t, maximumFractionDigits:t||20});
}, {multiValued:!0}), iff:function(e) {
var a=1<arguments.length&&arguments[1]!==void 0?arguments[1]:e, n=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;return Array.isArray(e)?e.map(function(e, o) {
var r=t(e)?a:n;return Array.isArray(r)?r[l(o, r.length-1)]:r;
}):t(e)?a:n;
}, group:function() {
return Object.assign.apply(Object, arguments);
}, list:function() {
for (var e=arguments.length, t=Array(e), a=0;a<e;a++) {
t[a]=arguments[a];
} return Mavo.flatten(t);
}, random:e.extend(function() {
var e=0<arguments.length&&arguments[0]!==void 0?arguments[0]:0, t=1<arguments.length&&arguments[1]!==void 0?arguments[1]:100, a=2<arguments.length&&arguments[2]!==void 0?arguments[2]:1;1==d.length&&(t=e, e=0);var n=Math.random(), o=(t-e)/a;return r(n*(o+1))*a+e;
}, {multiValued:!0}), range:function(e, t, o) {
o===void 0&&(t===void 0&&(t=e, e=0<=t?1:-1), o=e<=t?1:-1);var s=r((t-e)/o+1);if (0>=s||!isFinite(s)) {
return [e];
} for (var l=[], d=0, c=e;d++<s;c+=o) {
l.push(c);
} return l;
}, shuffle:function(e) {
if (Array.isArray(e)) {
for (var t=e.slice(), a=t.length-1;0<a;a--) {
var n=r(Math.random()*(a+1)), o=[t[n], t[a]];t[a]=o[0], t[n]=o[1];
} return t;
} return e;
}, replace:e.extend(function(e, t) {
var a=2<arguments.length&&arguments[2]!==void 0?arguments[2]:"", n=3<arguments.length&&arguments[3]!==void 0?arguments[3]:1;if (Array.isArray(e)) {
return e.map(function(e) {
return c.replace(e, t, a);
});
} for (var o=RegExp(Mavo.escapeRegExp(t), "g"), r=e, i=0, s;r!=s&&i++<n;) {
s=r, r=r.replace(o, a);
} return r;
}, {multiValued:!0}), len:e.extend(function(e) {
return a(e).length;
}, {multiValued:!0}), contains:e.extend(function(t, a) {
var n=e.type(t), o;if ("object"===e.type(a)) {
return 0<=JSON.stringify(t).indexOf(JSON.stringify(a));
} if ("object"===n||"array"===n) {
for (var r in t) {
if (o=c.contains(t[r], a), Array.isArray(o)&&(o=Mavo.Functions.or(o)), o) {
return !0;
}
}
}
else {
return 0<=c.search(t, a);
} return o;
}, {multiValued:!0}), search:e.extend(function(e, t) {
return e=a(e), t=a(t), e&&t?e.toLowerCase().indexOf(t.toLowerCase()):-1;
}, {multiValued:!0}), starts:e.extend(function(e, t) {
return 0===c.search(a(e), a(t));
}, {multiValued:!0}), ends:e.extend(function(e, t) {
var n=[a(e), a(t)];e=n[0], t=n[1];var o=c.search(e, t);return -1<o&&o===e.length-t.length;
}, {multiValued:!0}), join:function(e, t) {
return Mavo.toArray(e).filter(function(e) {
return !n(e);
}).join(a(t));
}, idify:e.extend(function(e) {
return a(e).normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^\w\s-]/g, "").trim().replace(/\s+/g, "-").toLowerCase();
}, {multiValued:!0}), readable:e.extend(function(e) {
return a(e).replace(/([a-z])([A-Z])(?=[a-z])/g, function(e, t, a) {
return t+" "+a.toLowerCase();
}).replace(/([a-z0-9])[_\/-](?=[a-z0-9])/g, "$1 ").replace(/^[a-z]/, function(e) {
return e.toUpperCase();
});
}, {multiValued:!0}), uppercase:e.extend(function(e) {
return a(e).toUpperCase();
}, {multiValued:!0}), lowercase:e.extend(function(e) {
return a(e).toLowerCase();
}, {multiValued:!0}), from:e.extend(function(e, t) {
return c.between(e, t);
}, {multiValued:!0}), fromlast:e.extend(function(e, t) {
return c.between(e, t, "", !0);
}, {multiValued:!0}), to:e.extend(function(e, t) {
return c.between(e, "", t);
}, {multiValued:!0}), tofirst:e.extend(function(e, t) {
return c.between(e, "", t, !0);
}, {multiValued:!0}), between:e.extend(function(e, t, n, o) {
var r=[a(e), a(t), a(n)];e=r[0], t=r[1], n=r[2];var i=t?e[o?"lastIndexOf":"indexOf"](t):-1, s=e[o?"indexOf":"lastIndexOf"](n);return t&&-1===i||-1===s?"":e.slice(i+1, -1!==s&&n?s:e.length);
}, {multiValued:!0}), phrase:e.extend(function(t, a, n, o) {
if (3===arguments.length&&"string"===e.type(n)) {
var r=[n];o=r[0], n=r[1];
} var i=o?Mavo.Locale.get(o):t&&t[Mavo.mavo]?t[Mavo.mavo].locale:Mavo.Locale["default"];return i.phrase(a, n);
}, {needsContext:!0}), filename:e.extend(function(e) {
return Mavo.match(new URL(a(e), Mavo.base).pathname, /[^/]+?$/);
}, {multiValued:!0}), json:function(e) {
return Mavo.safeToJSON(e);
}, split:e.extend(function(e) {
var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:/\s+/;return e=a(e), e.split(t);
}, {multiValued:!0}), log:function() {
for (var e=arguments.length, a=Array(e), n=0, o;n<e;n++) {
a[n]=arguments[n];
} return (o=console).log.apply(o, _toConsumableArray(a.map(t))), a[0];
}, $mouse:{x:0, y:0}, get $hash() {
return location.hash.slice(1);
}, get $alt() {
return !!c.$evt&&c.$evt.altKey;
}, get $ctrl() {
return !!c.$evt&&c.$evt.ctrlKey;
}, get $shift() {
return !!c.$evt&&c.$evt.shiftKey;
}, get $cmd() {
return !!c.$evt&&c.$evt[Mavo.superKey];
}, util:{numbers:function(e, a) {
return e=Array.isArray(e)?e:a?$$(a):[e], e.filter(function(e) {
return !isNaN(e)&&""!==t(e)&&null!==t(e);
}).map(function(e) {
return +e;
});
}, postProcess:function(t) {
var a=t.multiValued, n;if (!0===a||a&&2===a.length?n=function() {
for (var e=arguments.length, n=Array(e), o=0;o<e;o++) {
n[o]=arguments[o];
} var r=a[0]||0, i=a[1]||1;return Mavo.Script.binaryOperation(n[r], n[i], _objectSpread({scalar:function(e, a) {
return r in n&&(n[r]=e), i in n&&(n[i]=a), t.apply(void 0, n);
}}, t));
}:t.isAggregate&&(n=function(e) {
if (Mavo["in"](Mavo.groupedBy, e)) {
return e.map(function(t) {
return n(t.$items);
});
} var a=t.call.apply(t, [this].concat(Array.prototype.slice.call(arguments)));return void 0===a?e:a;
}), n&&(e.extend(n, t), n.original=t), t.alias) {
var o=!0, r=!1, i=void 0;try {
for (var s=Mavo.toArray(t.alias)[Symbol.iterator](), l, d;!(o=(l=s.next()).done);o=!0) {
d=l.value, Mavo.Functions[d]=n||t;
}
}
catch (e) {
r=!0, i=e;
}
finally {
try {
o||null==s["return"]||s["return"]();
}
finally {
if (r) {
throw i;
}
}
}
} return n;
}}}, i=c.util;Mavo.ready.then(function() {
Object.getOwnPropertyNames(Mavo.Functions).forEach(function(e) {
var t=i.postProcess(Mavo.Functions[e]);t&&(Mavo.Functions[e]=t);
}), Object.getOwnPropertyNames(Math).forEach(function(e) {
1!==Math[e].length||Mavo.Functions.hasOwnProperty(e)||(Mavo.Functions[e]=function(t) {
return Mavo.Script.unaryOperation(t, function(t) {
return Math[e](t);
});
});
});
});
}(Bliss, Mavo.value), function(e, t, a) {
var n=3<arguments.length&&arguments[3]!==void 0?arguments[3]:a.util, o={seconds:1, minutes:60};o.hours=60*o.minutes, o.days=24*o.hours, o.weeks=7*o.days, o.months=30.4368*o.days, o.years=52*o.weeks;var r={year:function(e) {
return e.getFullYear();
}, month:function(e) {
return e.getMonth()+1;
}, day:function(e) {
return e.getDate();
}, weekday:function(e) {
return e.getDay()||7;
}, hour:function(e) {
return e.getHours();
}, minute:function(e) {
return e.getMinutes();
}, second:function(e) {
return e.getSeconds();
}, ms:function(e) {
return e.getMilliseconds();
}};e.extend(a, {get $now() {
return new Date;
}, $startup:new Date, get $today() {
return a.date(new Date);
}, year:e.extend(function() {
return n.dateComponent.apply(n, ["year"].concat(Array.prototype.slice.call(arguments)));
}, {multiValued:!0}), month:e.extend(function() {
return n.dateComponent.apply(n, ["month"].concat(Array.prototype.slice.call(arguments)));
}, {multiValued:!0}), week:function() {
return 1e3*o.weeks;
}, day:e.extend(function() {
return n.dateComponent.apply(n, ["day"].concat(Array.prototype.slice.call(arguments)));
}, {multiValued:!0}), weekday:e.extend(function() {
return n.dateComponent.apply(n, ["weekday"].concat(Array.prototype.slice.call(arguments)));
}, {multiValued:!0}), hour:e.extend(function() {
return n.dateComponent.apply(n, ["hour"].concat(Array.prototype.slice.call(arguments)));
}, {multiValued:!0}), minute:e.extend(function() {
return n.dateComponent.apply(n, ["minute"].concat(Array.prototype.slice.call(arguments)));
}, {multiValued:!0}), second:e.extend(function() {
return n.dateComponent.apply(n, ["second"].concat(Array.prototype.slice.call(arguments)));
}, {multiValued:!0}), ms:e.extend(function() {
return n.dateComponent.apply(n, ["ms"].concat(Array.prototype.slice.call(arguments)));
}, {multiValued:!0}), date:e.extend(function(e) {
return e=n.date(e), e?"".concat(a.year(e), "-").concat(a.month(e, "00"), "-").concat(a.day(e, "00")):"";
}, {multiValued:!0}), time:e.extend(function(e) {
return e=n.date(e), e?"".concat(a.hour(e, "00"), ":").concat(a.minute(e, "00"), ":").concat(a.second(e, "00")):"";
}, {multiValued:!0}), localTimezone:-new Date().getTimezoneOffset()}), a.msTo=function(e, t) {
return Math.floor(Math.abs(t)/(1e3*o[e]))||0;
};var i=function(t) {
a[t]=e.extend(function(e) {
return 0===arguments.length?1e3*o[t]:a.msTo(t, e);
}, {multiValued:!0});
};for (var s in o) {
i(s);
}a.duration=e.extend(function(e, t) {
if (1===arguments.length) {
var n=[e, null];t=n[0], e=n[1];
} var r=t||0, i="ms";for (var s in o) {
var l=a.msTo(s, t);if (0===l) {
break;
}r=l, i=s;
} return i=1===r&&"ms"!=i?i.slice(0, -1):i, r+" "+a.phrase(e, i);
}, {needsContext:!0}), e.extend(a.util, {fixDateString:function(e) {
e=e.trim();var t=/^\d{4}-\d{2}(-\d{2})?/.test(e), n=-1<e.indexOf(":");return t||n?(e=t?e.replace(/^(\d{4}-\d{2})(?!-\d{2})/, "$1-01"):a.$today+" "+e, n?e=e.replace(/\-(\d{2})\s+(?=\d{2}:)/, "-$1T"):e+="T00:00:00", e=e.replace(/\s+/g, ""), e):null;
}, dateComponent:function(e, t, i) {
if (1===arguments.length&&e+"s"in o) {
return a[e+"s"]();
} var s=n.date(t);if ("year"===e) {
t=t&&t.match?t:t+"";var l=s?s.getFullYear()+"":(t.match(/\b[1-9]\d\d\b|\d+/)||[])[0];
} if (!l&&!s) {
return "";
} var l=l||r[e](s);return i?/^0+$/.test(i)?(l+"").padStart(i.length, "0").slice(-i.length):(i={name:"long", shortname:"short"}[i]||i, l=s.toLocaleString(Mavo.locale, _defineProperty({}, e, i)), l=l.replace(/\u200e/g, ""), l):"year"===e?l:+l;
}, date:function(a) {
if (a=t(a), !a) {
return null;
} var o=new Date(a);if ("string"!==e.type(a)||!isNaN(o)&&o+""==a) {
return o;
} if (a=n.fixDateString(a), null===a) {
return null;
} var r=Mavo.match(a, /[+-]\d{2}:?\d{2}|Z$/);if (r) {
a=new Date(a);
}
else {
var i=a.match(/\d+/g);a=new Date(i[0], (i[1]||1)-1, i[2]||1, i[3]||0, i[4]||0, i[5]||0, i[6]||0);
} return isNaN(a)?null:a;
}});
}(Bliss, Mavo.value, Mavo.Functions), function(e, t, n) {
var r=Math.max, s=Mavo.Script={addUnaryOperator:function(e, a) {
return a.symbol&&Mavo.toArray(a.symbol).forEach(function(t) {
s.unarySymbols[t]=e, jsep.addUnaryOp(t);
}), function(e) {
return s.unaryOperation(e, function(e) {
return a.scalar(t(e));
});
};
}, unaryOperation:function(e, t) {
return Array.isArray(e)?e.map(t):t(e);
}, binaryOperation:function(e, t) {
var a=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};a.scalar="function"==typeof a?a:a.scalar;var n;if (!Array.isArray(t)) {
n=Array.isArray(e)?e.map(function(e) {
return a.scalar(e, t);
}):a.scalar(e, t);
}
else if (Array.isArray(e)) {
n=[];for (var o=r(e.length, t.length), s=a.leftUnary||a.unary, l=a.rightUnary||a.unary, d=void 0===a.leftDefault?a["default"]:a.leftDefault, c=void 0===a.rightDefault?a["default"]:a.rightDefault, p=0;p<o;p++) {
n[p]=a.comparison&&(void 0===e[p]||void 0===t[p])?a["default"]:void 0===e[p]?l?l(t[p]):a.scalar(d, t[p]):void 0===t[p]?s?s(e[p]):a.scalar(e[p], c):a.scalar(e[p], t[p]);
}
}
else {
n=t.map(function(t) {
return a.scalar(e, t);
});
} return n;
}, addBinaryOperator:function(e, r) {
return r.symbol&&Mavo.toArray(r.symbol).forEach(function(t) {
s.symbols[t]=e, r.precedence&&jsep.addBinaryOp(t, r.precedence);
}), r["default"]=void 0===r["default"]?0:r["default"], r.code||function() {
for (var e=arguments.length, o=Array(e), l=0;l<e;l++) {
o[l]=arguments[l];
}1===o.length&&Array.isArray(o[0])&&(o=_toConsumableArray(o[0])), r.raw||(o=o.map(t));for (var d=!!r.comparison||o[0], c=1, p;c<o.length;c++) {
var u=r.comparison?o[c-1]:d, a=o[c];Array.isArray(a)&&"number"==typeof r["default"]&&(a=n.numbers(a));var p=s.binaryOperation(u, a, r);d=r.comparison?s.binaryOperation(d, p, s.operators.and):p;
} return d;
};
}, symbols:{}, unarySymbols:{}, getOperatorName:function(e, t) {
return s[t?"unarySymbols":"symbols"][e]||e;
}, isComparisonOperator:function(e) {
if (e) {
var t=s.operators[s.symbols[e]];return t&&t.comparison;
}
}, isStatic:function(e) {
if ("Identifier"===e.type) {
return !1;
} var t=!0, a=!1, n=void 0;try {
for (var o=s.childProperties[Symbol.iterator](), r, i;!(t=(r=o.next()).done);t=!0) {
if (i=r.value, e[i]&&"callee"!==i&&!s.isStatic(e[i])) {
return !1;
}
}
}
catch (e) {
a=!0, n=e;
}
finally {
try {
t||null==o["return"]||o["return"]();
}
finally {
if (a) {
throw n;
}
}
} return !0;
}, operators:{not:{symbol:"!", scalar:function(e) {
return !t(e);
}}, multiply:{scalar:function(e, t) {
return e*t;
}, default:1, symbol:"*"}, divide:{scalar:function(e, t) {
return e/t;
}, rightUnary:function(e) {
return e;
}, default:1, symbol:"/"}, addition:{scalar:function(e, t) {
if (isNaN(e)||isNaN(t)) {
var a=n.date(e), o=n.date(t);if (a||o) {
return +a+ +o;
}
} return +e+ +t;
}, symbol:"+"}, plus:{scalar:function(e) {
return +e;
}, symbol:"+"}, subtract:{scalar:function(e, t) {
if (isNaN(e)||isNaN(t)) {
var a=n.date(e), o=n.date(t);if (a&&o) {
return a-o;
}
} return e-t;
}, symbol:"-"}, minus:{scalar:function(e) {
return -e;
}, symbol:"-"}, mod:{scalar:function(e, t) {
var a=e%t;return a+=0>a?t:0, a;
}, symbol:"mod", precedence:10}, lte:{comparison:!0, scalar:function(e, t) {
var n=s.getNumericalOperands(e, t), o=_slicedToArray(n, 2);return e=o[0], t=o[1], e<=t;
}, default:!1, symbol:"<="}, lt:{comparison:!0, scalar:function(e, t) {
var n=s.getNumericalOperands(e, t), o=_slicedToArray(n, 2);return e=o[0], t=o[1], e<t;
}, default:!1, symbol:"<"}, gte:{comparison:!0, scalar:function(e, t) {
var n=s.getNumericalOperands(e, t), o=_slicedToArray(n, 2);return e=o[0], t=o[1], e>=t;
}, default:!1, symbol:">="}, gt:{comparison:!0, scalar:function(e, t) {
var n=s.getNumericalOperands(e, t), o=_slicedToArray(n, 2);return e=o[0], t=o[1], e>t;
}, default:!1, symbol:">"}, eq:{comparison:!0, scalar:function(e, t) {
return e==t||Mavo.safeToJSON(e)===Mavo.safeToJSON(t);
}, symbol:["=", "=="], default:!1, precedence:7}, neq:{comparison:!0, scalar:function(e, t) {
return e!=t&&Mavo.safeToJSON(e)!==Mavo.safeToJSON(t);
}, symbol:["!="], default:!0, precedence:7}, and:{scalar:function(e, t) {
return e&&t;
}, default:!1, symbol:["&&", "and"], precedence:2}, or:{scalar:function(e, t) {
return e||t;
}, default:!1, symbol:["||", "or"], precedence:2}, concatenate:{symbol:"&", default:"", scalar:function(e, t) {
return ""+(e||"")+(t||"");
}, precedence:10}, keyvalue:{symbol:":", code:function() {
for (var e=arguments.length-1, t=0>e||arguments.length<=e?void 0:arguments[e];e--;) {
t=_defineProperty({}, 0>e||arguments.length<=e?void 0:arguments[e], t);
} return t;
}, transformation:function(e) {
"Identifier"==e.left.type&&(e.left={type:"Literal", value:e.left.name, raw:JSON.stringify(e.left.name)});
}, precedence:4}, filter:{symbol:"where", code:function(e) {
for (var n=arguments.length, o=Array(1<n?n-1:0), r=1;r<n;r++) {
o[r-1]=arguments[r];
} for (var i=function() {
var a=l[s];Array.isArray(e)?Array.isArray(a)?e=e.map(function(e, n) {
return t(a[n])?e:null;
}):(a=t(a), e="boolean"==typeof a?a?e:e.map(function() {
return null;
}):e.map(function(e) {
return e==a?e:null;
})):e=t(a)?e:null;
}, s=0, l=o;s<l.length;s++) {
i();
} return e;
}, precedence:1, postFlattenTransformation:function(e) {
for (var t=e.arguments[0], a=1;a<e.arguments.length;a++) {
s.isStatic(e.arguments[a])||(e.arguments[a]=Object.assign(s.parse("scope()"), {arguments:[t, e.arguments[a]]}));
}
}}, range:{symbol:"..", scalar:function(e, t) {
return Mavo.Functions.range(e, t);
}, precedence:2, export:!1}, has:{symbol:"in", code:function(a) {
for (var n=arguments.length, o=Array(1<n?n-1:0), r=1, i;r<n;r++) {
o[r-1]=arguments[r];
} return o.map(function(n) {
if (Array.isArray(n)) {
var o=function(o) {
var a="object"===e.type(t(o))?Mavo.safeToJSON:t;return -1<n.map(a).indexOf(a(o));
};
}
else if ("object"===e.type(n)) {
var o=function(e) {
return Mavo["in"](t(e), n);
};
}
else {
var o=function(e) {
return Mavo.Functions.eq(e, n);
};
} var r=Mavo.Script.unaryOperation(a, o);i=void 0===i?r:Mavo.Functions.and(r, i);
}), i;
}, precedence:3}, groupby:{symbol:"by", code:function(t, a) {
t=Mavo.toArray(t), a=Mavo.toArray(a);var n=a[Mavo.as]||e.value(a[0], Mavo.toNode, "property"), o=new Mavo.BucketMap({arrays:!0}), r=[];return r[Mavo.groupedBy]=!0, t.forEach(function(e, t) {
var n=t<a.length?Mavo.value(a[t]):null;o.set(n, e);
}), Mavo["in"](Mavo.route, t)&&(r[Mavo.route]=Object.assign({}, t[Mavo.route])), o.forEach(function(a, o) {
var i=(s={$value:o}, _defineProperty(s, n||"$value", o), _defineProperty(s, "$items", a), s), s;Mavo["in"](Mavo.route, t)&&(a[Mavo.route]=i[Mavo.route]=Object.assign({}, t[Mavo.route]), i[Mavo.route]=e.each(a[Mavo.route], function() {
return new Set(["$items"]);
})), r.push(i);
}), Mavo.Data.proxify(r);
}, precedence:2}, as:{symbol:"as", code:function(t, a) {
if (void 0!==t&&"array"===e.type(t)&&void 0!==a) {
var n=t.slice();return Array.isArray(a)||void 0===e.value(a, Mavo.toNode, "property")?"string"===e.type(a)?(n[Mavo.as]=a, n):void 0===e.value(a[0], Mavo.toNode, "property")?t:(n[Mavo.as]=e.value(a[0], Mavo.toNode, "property"), n):(n[Mavo.as]=e.value(a, Mavo.toNode, "property"), n);
} return t;
}, precedence:3}}, getNumericalOperands:function(e, t) {
if (isNaN(e)||isNaN(t)) {
var a=n.date(e), o=n.date(t);if (a&&o) {
return [a, o];
}
} return [e, t];
}, childProperties:["arguments", "argument", "callee", "left", "right", "elements", "test", "consequent", "alternate", "object", "body"], walk:function(e, t) {
var a=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{}, n=3<arguments.length?arguments[3]:void 0, o=4<arguments.length?arguments[4]:void 0;if (!a.type||e.type===a.type) {
var r=t(e, n, o);
} return a.ignore&&-1!==a.ignore.indexOf(e.type)||s.childProperties.forEach(function(n) {
e[n]&&s.walk(e[n], t, a, n, e);
}), void 0!==r&&o&&(o[n]=r), r;
}, serializers:{BinaryExpression:function(e) {
return "".concat(s.serialize(e.left), " ").concat(e.operator, " ").concat(s.serialize(e.right));
}, UnaryExpression:function(e) {
return "".concat(e.operator).concat(s.serialize(e.argument));
}, CallExpression:function(e) {
var t=s.serialize(e.callee), a=e.arguments.map(s.serialize);if ("Identifier"==e.callee.type) {
var n=[Array, String, Number].some(function(t) {
return e.callee.name in t.prototype;
});if (n&&(t="Mavo.Functions.".concat(t.toLowerCase(), " || ").concat(t)), "scope"===e.callee.name) {
var o="with (Mavo.Script.subScope(scope, $this) || {}) { return (".concat(s.serialize(e.arguments[1]), "); }");return "(function() {\n\t\t\t\t\t\tvar scope = ".concat(s.serialize(e.arguments[0]), ";\n\t\t\t\t\t\tif (Array.isArray(scope)) {\n\t\t\t\t\t\t\treturn scope.map(function(scope) {\n\t\t\t\t\t\t\t\t").concat(o, "\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t").concat(o, "\n\t\t\t\t\t})()");
} if (n) {
if ("MemberExpression"==e.callee.type) {
var r=", "+s.serialize(e.callee.object);
} return "call(".concat(t, ", [").concat(a.join(", "), "]").concat(r||"", ")");
}
} return "".concat(t, "(").concat(a.join(", "), ")");
}, ConditionalExpression:function(e) {
return "".concat(s.serialize(e.test), "? ").concat(s.serialize(e.consequent), " : ").concat(s.serialize(e.alternate));
}, MemberExpression:function(e) {
var t=e.computed?s.serialize(e.property):"\"".concat(e.property.name, "\"");return "get(".concat(s.serialize(e.object), ", ").concat(t, ")");
}, ArrayExpression:function(e) {
return "[".concat(e.elements.map(s.serialize).join(", "), "]");
}, Literal:function(e) {
return e.raw.replace(/\r/g, "\\r").replace(/\n/g, "\\n");
}, Identifier:function(e) {
return e.name;
}, ThisExpression:function() {
return "this";
}, Compound:function(e) {
return e.body.map(s.serialize).join(", ");
}}, transformations:{BinaryExpression:function(e) {
var t=s.getOperatorName(e.operator), a=s.operators[t];a.transformation&&a.transformation(e);var n=e, o={type:"CallExpression", arguments:[], callee:{type:"Identifier", name:t}};if (a.comparison) {
var r=[];do {
var l=s.getOperatorName(n.operator);r.unshift({comparison:l, operand:n.right}), n=n.left;
} while (!1!==a.flatten&&s.isComparisonOperator(n.operator));for (var d=!1, c=0;c<r.length-1;c++) {
if (r[c].comparison!=r[c+1].comparison) {
d=!0;break;
}
}o.arguments.push(n), d?(o.callee.name="compare", r.forEach(function(e) {
o.arguments.push({type:"Literal", value:e.comparison, raw:"\"".concat(e.comparison, "\"")}), o.arguments.push(e.operand);
})):r.forEach(function(e) {
o.arguments.push(e.operand);
});
}
else {
do {
o.arguments.unshift(n.right), n=n.left;
} while (!1!==a.flatten&&s.getOperatorName(n.operator)===t);o.arguments.unshift(n);
} return a.postFlattenTransformation&&a.postFlattenTransformation(o), o;
}, UnaryExpression:function(e) {
var t=s.getOperatorName(e.operator, !0);if (t) {
return {type:"CallExpression", arguments:[e.argument], callee:{type:"Identifier", name:t}};
}
}, CallExpression:function(e) {
if ("Identifier"==e.callee.type) {
if ("if"==e.callee.name) {
e.callee.name="iff";for (var t=e.arguments[0], a=1;a<e.arguments.length;a++) {
2==a&&(t=s.parse("not()"), t.arguments.push(e.arguments[0])), s.walk(e.arguments[a], function(e) {
var a=e.callee.name;Mavo.Actions.Functions.hasOwnProperty(a)&&!/if$/.test(a)&&(e.callee.name+="if", e.arguments.unshift(t));
}, {type:"CallExpression"});
}
}
else if ("delete"==e.callee.name) {
e.callee.name="clear";
}
else {
var n=Mavo.Functions[e.callee.name];n&&n.needsContext&&e.arguments.unshift({type:"Identifier", name:"$this"});
}
}
}, ThisExpression:function() {
return {type:"Identifier", name:"$this"};
}}, serialize:function(e) {
var t=s.transformations[e.type]&&s.transformations[e.type](e);if ("object"==_typeof(t)&&t&&t.type) {
e=t;
}
else if (void 0!==t) {
return t;
} return s.serializers[e.type](e);
}, rewrite:function(t) {
try {
return s.serialize(s.parse(t));
}
catch (a) {
return t;
}
}, compile:function(e) {
var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return /\S/.test(e)?(e=s.rewrite(e), e="with (Mavo.Data.stub)\n\twith (data || {}) {\n\t\treturn (".concat(e, ");\n\t}"), t.actions&&(e="\nMavo.Actions._running = Mavo.Actions.running;\nMavo.Actions.running = true;\n".concat(e, "\nMavo.Actions.running = Mavo.Actions._running;")), new Function("data", e)):function() {
return "";
};
}, parse:self.jsep, subScope:function(e, t) {
var a=Object.keys(t).reduce(function(e, t) {
return e[t]=!0, e;
}, {$this:!0});return e&&"object"===_typeof(e)?new Proxy(e, {get:function(e, t, n) {
return t===Symbol.unscopables?a:Reflect.get(e, t, n);
}}):e;
}};for (var a in s.serializers.LogicalExpression=s.serializers.BinaryExpression, s.transformations.LogicalExpression=s.transformations.BinaryExpression, s.operators) {
var o=s.operators[a];if (o.scalar&&2>o.scalar.length) {
var i=s.addUnaryOperator(a, o);
}
else {
var i=s.addBinaryOperator(a, o);
}o.code=o.code||i, i&&!1!==o["export"]&&(Mavo.Functions[a]=i);
}Mavo.Functions.compare=function() {
for (var e=!0, t=2;t<arguments.length;t+=2) {
var n=0>t-2||arguments.length<=t-2?void 0:arguments[t-2], a=0>t-1||arguments.length<=t-1?void 0:arguments[t-1], o=0>t||arguments.length<=t?void 0:arguments[t], r=s.binaryOperation(n, o, Mavo.Script.operators[a]);e=s.binaryOperation(e, r, Mavo.Script.operators.and);
} return e;
};
}(Bliss, Mavo.value, Mavo.Functions.util), function(e) {
Mavo.attributes.push("mv-action");var t=Mavo.Actions={listener:function(e) {
var a="submit"===e.type?"form":":not(form)", n=e.target.closest(a+"[mv-action]");if (n) {
var o=Mavo.Node.get(n);o&&o.editing||("submit"===e.type&&e.preventDefault(), n&&t.run(n.getAttribute("mv-action"), n, e));
}
}, run:function(e, t, a) {
if (e) {
var n=Mavo.Node.getClosest(t);if (n) {
var o=new Mavo.Expression(e), r=Mavo.Functions.$evt;Mavo.Functions.$evt=a;var i=o.eval(n.getLiveData(), {actions:!0});return Mavo.Functions.$evt=r, i;
}
}
}, getNodes:function(e) {
var a=t.getNode(e);return a?[a]:Mavo.toArray(e).map(function(e) {
return t.getNode(e);
}).filter(function(e) {
return e!==void 0;
});
}, getNode:function(e) {
if (e instanceof Mavo.Node) {
return e;
} return e&&e[Mavo.toNode]?e[Mavo.toNode]:void 0;
}, getCollection:function(e) {
var a=t.getNode(e);return a instanceof Mavo.Collection?a:a?a.collection:null;
}, nope:function() {
var e=Object.keys(t.Functions).map(function(e) {
return "".concat(e, "()");
});Mavo.warn("Mavo actions (".concat(e, ") can only be used in the mv-action attribute."));
}, Functions:{add:function(e, a, n) {
if (3>arguments.length) {
if (1>=arguments.length) {
var o=[void 0, e];e=o[0], a=o[1];
}
else if (2===arguments.length) {
var r=t.getCollection(a);if (!r&&(r=t.getCollection(e), r)) {
var i=[void 0, e, a];e=i[0], a=i[1], n=i[2];
}
}
} if (a) {
if (r=r||t.getCollection(a), !r) {
return Mavo.warn("No collection or collection item provided to add().", {once:!1}), e;
} if (void 0===n) {
var s=t.getNode(a);s!==r&&(n=s.index);
} return (Array.isArray(e)?e:[e]).map(function(e) {
var t=r.add(void 0, n);return void 0!==e&&t.render(e), r.editing&&r.editItem(t), t.getLiveData();
});
}
}, move:function(a, n, o) {
if (a&&void 0!==n) {
var r=t.getNode(n);if ("number"==e.type(n)&&!(r&&r.collection)) {
var i=[n];o=i[0], n=i[1];
} var s=Mavo.toArray(a).map(t.getNode).filter(function(e) {
return e&&e.closestCollection;
}), l=(r||s[0]).closestCollection;if (!s.length) {
return l?(Mavo.warn("First parameter of move() was not a collection or collection item, using add() instead.", {once:!1}), t.Functions.add(a, l, o)):(Mavo.warn("You need to provide at least one collection or collection item for move() to have something to do.", {once:!1}), a);
} var d=t.Functions.add(a, l, o);return Mavo.Collection["delete"](s, {silent:!0}), d;
}
}, clear:function() {
for (var e=arguments.length, a=Array(e), n=0;n<e;n++) {
a[n]=arguments[n];
} if (a.length&&a[0]) {
var o=t.getNodes(Mavo.flatten(a)), r=[];return o.forEach(function(e) {
e&&(e instanceof Mavo.Collection?r.push.apply(r, _toConsumableArray(e.children)):e.collection?r.push(e):e.walk(function(a) {
a instanceof Mavo.Primitive?a.value=null:a!==e&&t.clear(a);
}));
}), Mavo.Collection["delete"](r), o.map(function(e) {
return e.getLiveData();
});
}
}, clearif:function(e) {
for (var a=arguments.length, n=Array(1<a?a-1:0), o=1, r;o<a;o++) {
n[o-1]=arguments[o];
} return n=n.map(function(a) {
return Mavo.Functions.iff(e, a);
}), (r=t.Functions).clear.apply(r, _toConsumableArray(n));
}, set:function(e, a) {
if (e) {
var n=t.getNode(e);if (n) {
n.render(a);
}
else {
var o=Array.isArray(e), r=t.getNodes(e);r.length?Mavo.Script.binaryOperation(o?r:r[0], a, {scalar:function(e, t) {
return e?e.render(t):null;
}}):Mavo.warn("The first parameter of set() needs to be one or more existing properties, ".concat(Mavo.safeToJSON(e), " is not."));
} return a;
}
}}}, a=function(e) {
var a=e+"if";a in t.Functions||(t.Functions[a]=function(a, n) {
var o;n=Mavo.Functions.iff(a, n);for (var r=arguments.length, i=Array(2<r?r-2:0), s=2;s<r;s++) {
i[s-2]=arguments[s];
} return Mavo.value(a)?(o=t.Functions)[e].apply(o, [n].concat(i)):null;
});
};for (var n in t.Functions) {
a(n);
}t.Functions.deleteif=t.Functions.clearif;
}(Bliss, Bliss.$), function(e) {
var t=Mavo.Data=e.Class(function() {
function a(e, t) {
_classCallCheck(this, a), this.node=e, void 0!==t&&(this.data=t);
} return _createClass(a, [{key:"proxify", value:function() {
return t.proxify(this.data);
}}, {key:"update", value:function() {
if (this.node instanceof Mavo.Collection||this.node instanceof Mavo.ImplicitCollection) {
this.data.length=0;for (var a=0;a<this.node.children.length;a++) {
this.data[a]=this.node.children[a].liveData.data;
} this.node instanceof Mavo.ImplicitCollection&&(Mavo.filter(this.data, function(e) {
return null!==Mavo.value(e);
}), this.updateParent());
}
else if (this.node instanceof Mavo.Primitive) {
var n=this.node.value;this.node.isDataNull({live:!0})&&(n=null), this.data=Mavo.objectify(n);var o=e.type(n);"object"===o||"array"===o?t.computeRoutes(this.data):t.computeMetadata(this.data, this.key, this.parent), this.updateParent();
}
}}, {key:"updateParent", value:function() {
if (this.parent) {
if (this.node instanceof Mavo.ImplicitCollection) {
var e=1===this.data.length?this.data[0]:this.data;this.parent.set(this.node.property, e, !0);
}
else if (this.collection instanceof Mavo.ImplicitCollection) {
this.parent.update();
}
else {
var t=this.key, a=!1;this.collection instanceof Mavo.Collection&&(a=this.collection.children[this.node.index]!==this.node), void 0===t||a||this.parent.set(t, this.data, !0);
}
}
}}, {key:"set", value:function(e, a, n) {
this.data[e]=a, t["computeRoute"+(n?"":"s")](a, e, this.data);
}}, {key:"updateKey", value:function() {
var e=this._key;this.parent[e]===this.data&&delete this.parent[e], this.updateParent();
}}, {key:"resolve", value:function(e) {
return t.resolve(e, this.data);
}}, {key:"parent", get:function() {
var e=this.node.parent;return e?e.liveData:null;
}}, {key:"collection", get:function() {
return this.node.collection;
}}, {key:"key", get:function() {
return this._key=this.collection?this.node.index:this.node.property;
}}]), a;
}(), {live:{data:function(e) {
if (e!==this._data) {
return this.isArray=Array.isArray(e), this._data=e, e[Mavo.toNode]=this.node, e[Mavo.parent]=this.parent&&this.parent.data, e[Mavo.mavo]=this.node.mavo, this.proxy=this.proxify(), this.updateParent(), this._data;
}
}}, static:{stub:self.Proxy?new Proxy(_defineProperty({}, Symbol.unscopables, {data:!0, undefined:!0}), {get:function(e, t) {
var a=Reflect.get(e, t);if (void 0!==a||"string"!=typeof t) {
return a;
} var n=t.toLowerCase();if (n in Mavo.Actions.Functions&&(Mavo.Actions.running?a=Mavo.Actions.Functions[n]:a=Mavo.Actions.nope), a=n in Mavo.Functions?Mavo.Functions[n]:Math[t]||Math[n]||a, void 0!==a) {
return "function"==typeof a&&(a.toString=function() {
return t;
}), a;
} if ("undefined"!=typeof window&&window.hasOwnProperty(t)) {
return window[t];
} if ("$"!==t[0]) {
var o="$"+t.toLowerCase();if (o in Mavo.Functions) {
return Mavo.Functions[o];
}
} return t;
}, has:function(e, t) {
return Reflect.has(e, t)||"string"==typeof t;
}}):Mavo.Functions, isItem:function(t) {
return Array.isArray(e.value(t, Mavo.parent));
}, closest:function(e, t) {
var a=[];do {
if (t(e)) {
return {value:e, path:a};
}a.push(e[Mavo.property]);
} while (e=e[Mavo.parent]);return {value:null, path:a};
}, root:function(e) {
return t.closest(e, function(e) {
return !e[Mavo.parent];
});
}, closestItem:function(e) {
return t.closest(e, t.isItem);
}, closestArray:function(e) {
return t.closest(e, Array.isArray);
}, getProperty:function(e) {
var a=t.isItem(e)?e[Mavo.parent]:e;return a[Mavo.property];
}, find:function(e, a) {
var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};if (a&&n.exclude!==a) {
if (Mavo["in"](e, a)&&n.exclude!==a[e]) {
return a[e];
} if (!a[Mavo.route]||!Mavo["in"](e, a[Mavo.route])) {
if (a[Mavo.property]===e) {
return a;
} if (t.isItem(a)&&t.getProperty(a)===e) {
return a;
} if (Array.isArray(a)) {
var o=a.map(function(n) {
return t.find(e, n);
}).filter(function(e) {
return void 0!==e;
});if (o.length) {
return Mavo.flatten(o);
}
} return;
} var r=[], i=Array.isArray(a), o;r[Mavo.route]={}, r[Mavo.mavo]=a[Mavo.mavo];var s=function(o) {
var s=t.find(e, a[o], n);if (void 0!==s) {
if (Mavo["in"](Mavo.route, s)) {
for (var l in s[Mavo.route]) {
r[Mavo.route][l]=!0;
}
}Array.isArray(s)?(r.push.apply(r, _toConsumableArray(s)), i=!0):r.push(s);
}
};if (Array.isArray(a)||!0===a[Mavo.route][e]) {
for (var l in a) {
s(l);
}
}
else {
a[Mavo.route][e].forEach(s);
} return i||1<r.length?r:r[0];
}
}, findUp:function(e, a) {
var n=a, o;do {
var r=t.find(e, n, {exclude:o});if (void 0!==r) {
return r;
} if (t.getProperty(n)===e) {
return n;
}o=n, n=n[Mavo.parent];
} while (n);
}, resolve:function(e, a) {
if (e===Mavo.isProxy) {
return !0;
} if ("symbol"===_typeof(e)) {
return a[e];
} var n=!isNaN(e), o;if (e in a) {
o=a[e];
}
else if (!n) {
if (e in t.special) {
o=t.special[e](a);
}
else if (a[Mavo.mavo]) {
var r=a[Mavo.mavo].root.liveData.data[Mavo.route];Mavo["in"](e, r)&&(o=t.findUp(e, a));
}
else {
Mavo["in"](Mavo.route, a)&&Mavo["in"](e, a[Mavo.route])&&(o=t.find(e, a));
}
} if (!n) {
var i=e.toLowerCase();
} if (void 0!==o) {
if ("function"!=typeof o) {
var s=Mavo.Functions[i]||Mavo.Actions.Functions[i]||Math[i];s&&(o=Mavo.primitivify(function() {
return s.apply(void 0, arguments);
}, o));
} var l=null!==o&&"object"===_typeof(o)&&(Mavo.route in o||Mavo.toNode in o);return l?t.proxify(o):o;
} if (!n) {
if (e in Mavo.all&&isNaN(e)&&Mavo.all[e].root) {
return Mavo.all[e].root.getLiveData();
} if ("$"!==e[0]) {
var d="$"+i;if (d in t.special) {
return t.resolve(d, a);
}
}
}
}, has:function(e, a) {
if (e===Mavo.isProxy) {
return !0;
} if ("string"!=typeof e) {
return Reflect.has(a, e);
} var n=[a, Mavo.all, t.special];if (n.some(function(t) {
return e in t;
})) {
return !0;
} if ("string"==typeof e) {
var o=e.toLowerCase();if (o!==e&&n.some(function(e) {
return o in e;
})) {
return !0;
} if ("$"!==o[0]&&"$"+o in t.special) {
return !0;
}
} return a[Mavo.mavo]?Mavo["in"](e, a[Mavo.mavo].root.liveData.data[Mavo.route]):void 0;
}, proxify:function(e) {
return e&&"object"===_typeof(e)&&self.Proxy&&!e[Mavo.isProxy]?new Proxy(e, {get:function(e, a) {
return t.resolve(a, e);
}, has:function(e, a) {
return t.has(a, e);
}, set:function(e) {
var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"", a=2<arguments.length?arguments[2]:void 0;return "symbol"===_typeof(t)?Reflect.set(e, t, a):(Mavo.warn("You cannot set data via expressions. Attempt to set ".concat(t.toString(), " to ").concat(a, " ignored.")), a);
}}):e;
}, computeMetadata:function(e, t, a) {
e&&"object"===_typeof(e)&&(void 0!==t&&(e[Mavo.property]=t), a&&!e[Mavo.parent]&&(e[Mavo.parent]=a));
}, computeRoute:function(a, n, o) {
var r=e.type(a);if (t.computeMetadata(a, n, o), "object"!=r&&"array"!=r||a[Mavo.route]||(a[Mavo.route]={}), "number"!==e.type(n)) {
for (var i=a;o;) {
o[Mavo.route]||(o[Mavo.route]={});var s=i&&i[Mavo.property];if (s&&!0!==o[Mavo.route][n]) {
if (o[Mavo.route][n]||(o[Mavo.route][n]=new Set), o[Mavo.route][n].has(s)) {
break;
}o[Mavo.route][n].add(s);
}
else {
o[Mavo.route][n]=!0;
}i=o, o=o[Mavo.parent];
}
}
}, computeRoutes:function(e, a, n) {
t.traverse(t.computeRoute, e, a, n);
}, traverseDown:function(a, n) {
if (Array.isArray(n)) {
n.forEach(function(e, o) {
return t.traverse(a, e, o, n);
});
}
else if ("object"===e.type(n)) {
for (var o in n) {
t.traverse(a, n[o], o, n);
}
}
}, traverse:function(e, a, n, o) {
e(a, n, o), t.traverseDown(e, a, n, o);
}, special:{$index:function(e) {
var a=t.closestItem(e).value;if (!a) {
return -1;
} var n=a[Mavo.property];return isNaN(n)?a[Mavo.parent].indexOf(a):n;
}, $item:function(e) {
return t.closestItem(e).value;
}, $all:function(a) {
var n=t.closestArray(a), o=n.path.reverse().slice(1), r=n.value.map(function(t) {
return e.value.apply(e, [t].concat(_toConsumableArray(o)));
});return 0<r.length&&r[0][Mavo.route]&&(r[Mavo.route]=e.each(r[0][Mavo.route], function() {
return !0;
}), r[Mavo.mavo]=r[0][Mavo.mavo]), r;
}, $next:function(a) {
var n=t.closestArray(a), o=n.path.reverse(), r=n.path[0];o=o.slice(1);var i=e.value(n.value, r+1);return i?e.value.apply(e, [i].concat(_toConsumableArray(o))):null;
}, $previous:function(a) {
var n=t.closestArray(a), o=n.path.reverse(), r=n.path[0];o=o.slice(1);var i=e.value(n.value, r-1);return i?e.value.apply(e, [i].concat(_toConsumableArray(o))):null;
}, $this:function(e) {
return e;
}}}});
}(Bliss, Bliss.$), function(e) {
var t=Mavo.Backend.register(e.Class({extends:Mavo.Backend, id:"Dropbox", constructor:function() {
this.permissions.on(["login", "read"]), this.key=this.mavo.element.getAttribute("mv-dropbox-key")||"2mx6061p054bpbp", this.login(!0);
}, update:function(e, a) {
this["super"].update.call(this, e, a), this.url=t.fixShareURL(this.url);
}, upload:function(e, t) {
var a=this;return t=this.path.replace(/[^/]+$/, "")+t, this.put(e, t).then(function() {
return a.getURL(t);
});
}, getURL:function(e) {
return this.request("sharing/create_shared_link_with_settings", {path:e}, "POST").then(function(e) {
return t.fixShareURL(e.url);
});
}, put:function(e) {
var t=1<arguments.length&&arguments[1]!==void 0?arguments[1]:this.path, a=2<arguments.length&&arguments[2]!==void 0?arguments[2]:{};return this.request("https://content.dropboxapi.com/2/files/upload", e, "POST", {headers:{"Dropbox-API-Arg":JSON.stringify({path:t, mode:"overwrite"}), "Content-Type":"application/octet-stream"}});
}, oAuthParams:function() {
return "&redirect_uri=".concat(encodeURIComponent("https://auth.mavo.io"), "&response_type=code");
}, getUser:function() {
var t=this;return this.user?Promise.resolve(this.user):this.request("users/get_current_account", "null", "POST").then(function(a) {
t.user={username:a.email, name:a.name.display_name, avatar:a.profile_photo_url, info:a}, e.fire(t.mavo.element, "mv-login", {backend:t});
});
}, login:function(e) {
var t=this;return this.oAuthenticate(e).then(function() {
return t.getUser();
}).then(function() {
t.user&&(t.permissions.logout=!0, t.request("sharing/get_shared_link_metadata", {url:t.source}, "POST").then(function(e) {
t.path=e.path_lower, t.permissions.on(["edit", "save"]);
}));
});
}, logout:function() {
return this.oAuthLogout();
}, static:{apiDomain:"https://api.dropboxapi.com/2/", oAuth:"https://www.dropbox.com/oauth2/authorize", test:function(e) {
return e=new URL(e, Mavo.base), /dropbox.com/.test(e.host);
}, fixShareURL:function(e) {
return e=new URL(e, Mavo.base), e.hostname="dl.dropboxusercontent.com", e.search=e.search.replace(/\bdl=0|^$/, "raw=1"), e;
}}}));
}(Bliss, Bliss.$), function(e) {
var t=Mavo.Backend.register(e.Class({extends:Mavo.Backend, id:"Github", constructor:function() {
this.permissions.on(["login", "read"]), this.key=this.mavo.element.getAttribute("mv-github-key")||"7e08e016048000bc594e";var a=this.format.constructor.extensions[0]||".json";this.defaults={repo:"mv-data", filename:"".concat(this.mavo.id).concat(a)}, this.info=t.parseURL(this.source, this.defaults), e.extend(this, this.info), this.login(!0);
}, update:function(a, n) {
this["super"].update.call(this, a, n), this.info=t.parseURL(this.source, this.defaults), e.extend(this, this.info);
}, get:function(a) {
if (this.isAuthenticated()||!this.path||a) {
var n=a?t.parseURL(a):this.info;return n.apiData?this.request(n.apiCall, n.apiData, "POST").then(function(e) {
return e.errors&&e.errors.length?Promise.reject(e.errors.map(function(e) {
return e.message;
}).join("\n")):e.data;
}):this.request(n.apiCall, null, "GET", {headers:{Accept:"application/vnd.github.squirrel-girl-preview"}}).then(function(e) {
return Promise.resolve(n.repo?t.atob(e.content):e);
});
} return a=new URL("https://raw.githubusercontent.com/".concat(this.username, "/").concat(this.repo, "/").concat(this.branch||"master", "/").concat(this.path)), a.searchParams.set("timestamp", Date.now()), e.fetch(a.href).then(function(e) {
return Promise.resolve(e.responseText);
}, function() {
return Promise.resolve(null);
});
}, upload:function(e) {
var t=this, a=1<arguments.length&&arguments[1]!==void 0?arguments[1]:this.path;return Mavo.readFile(e).then(function(e) {
var n=e.slice(5), o=n.match(/^\w+\/[\w+]+/)[0];return n=n.replace(RegExp("^".concat(o, "(;base64)?,")), ""), a=t.path.replace(/[^/]+$/, "")+a, t.put(n, a, {isEncoded:!0});
}).then(function(e) {
return t.getURL(a, e.commit.sha);
});
}, put:function(e) {
var a=this, n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:this.path, r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};if (n) {
var o="repos/".concat(this.username, "/").concat(this.repo), i="".concat(o, "/contents/").concat(n), s=this.mavo.element.getAttribute("mv-github-commit-prefix")||"", l=this.repoInfo?Promise.resolve(this.repoInfo):this.request("user/repos", {name:this.repo}, "POST").then(function(e) {
return a.repoInfo=e;
});return e=r.isEncoded?e:t.btoa(e), l.then(function(e) {
return a.canPush()?e:a.request("".concat(o, "/forks"), {name:a.repo}, "POST").then(function(e) {
return i="repos/".concat(e.full_name, "/contents/").concat(n), a.forkInfo=e;
}).then(function(e) {
var t=function t(o) {
clearTimeout(n), a.request("repos/".concat(e.full_name, "/commits"), {until:"1970-01-01T00:00:00Z"}, "HEAD").then(function() {
o(e);
})["catch"](function() {
n=setTimeout(t, 1e3);
});
}, n;return new Promise(t);
});
}).then(function() {
return a.request(i, {ref:a.branch}).then(function(t) {
return a.request(i, {message:s+a.mavo._("gh-updated-file", {name:t.name||"file"}), content:e, branch:a.branch, sha:t.sha}, "PUT");
}, function(t) {
return 404==t.status?a.request(i, {message:s+"Created file", content:e, branch:a.branch}, "PUT"):t;
});
}).then(function(e) {
if (a.repoInfo.fork) {
a.forkInfo=a.repoInfo.parent, a.request("repos/".concat(a.repoInfo.parent.owner.login, "/").concat(a.repoInfo.parent.name, "/pulls"), {head:"".concat(a.user.username, ":").concat(a.branch), base:a.repoInfo.parent.default_branch}).then(function(e) {
a.pullRequest(e[0]);
});
}
else if (a.forkInfo) {
var t=new URL(location).searchParams;t.append("storage", e.content.download_url), history.pushState({}, "", "".concat(location.pathname, "?").concat(t)), location.replace("".concat(location.pathname, "?").concat(t)), a.request("repos/".concat(a.username, "/").concat(a.repo, "/pulls"), {head:"".concat(a.user.username, ":").concat(a.branch), base:a.branch}).then(function(e) {
a.pullRequest(e[0]);
});
} return e;
});
}
}, pullRequest:function(e) {
var t=this, a=new URL(location);a.searchParams.set(this.mavo.id+"-storage", "https://github.com/".concat(this.forkInfo.full_name, "/").concat(this.path));var n=this.mavo._("gh-edit-suggestion-saved-in-profile", {previewURL:a}), o="";if (this.notice&&(o=this.notice.options.name, this.notice.element.style.transition="none", this.notice.close()), e) {
var r="closePR"===o?{animation:"none", transition:"none"}:{};this.notice=this.mavo.message("".concat(n, "\n\t\t\t\t").concat(this.mavo._("gh-edit-suggestion-notreviewed"), "\n\t\t\t\t<form onsubmit=\"return false\">\n\t\t\t\t\t<button class=\"mv-danger\">").concat(this.mavo._("gh-edit-suggestion-revoke"), "</button>\n\t\t\t\t</form>"), {classes:"mv-inline", dismiss:["button", "submit"], style:r, name:"closePR"}), this.notice.element.style.transitionDuration="400ms", this.notice.closed.then(function(a) {
if (a) {
var n, o;t.repoInfo.fork?(n=t.repoInfo.parent.owner.login, o=t.repoInfo.parent.name):(n=t.username, o=t.repo), t.request("repos/".concat(n, "/").concat(o, "/pulls/").concat(e.number), {state:"closed"}, "POST").then(function(e) {
new Mavo.UI.Message(t.mavo, "<a href=\"".concat(e.html_url, "\">").concat(t.mavo._("gh-edit-suggestion-cancelled"), "</a>"), {dismiss:["button", "timeout"], style:r}), t.pullRequest();
});
}
});
}
else {
var r="createPR"===o?{animation:"none", transition:"none"}:{};this.notice=this.mavo.message("".concat(n, "\n\t\t\t\t").concat(this.mavo._("gh-edit-suggestion-instructions"), "\n\t\t\t\t<form onsubmit=\"return false\">\n\t\t\t\t\t<textarea name=\"edits\" class=\"mv-autosize\" placeholder=\"").concat(this.mavo._("gh-edit-suggestion-reason-placeholder"), "\"></textarea>\n\t\t\t\t\t<button>").concat(this.mavo._("gh-edit-suggestion-send"), "</button>\n\t\t\t\t</form>"), {classes:"mv-inline", dismiss:["button", "submit"], style:r, name:"createPR"}), this.notice.element.style.transitionDuration="400ms", this.notice.closed.then(function(e) {
if (e) {
var n, o, i;t.repoInfo.fork?(n=t.repoInfo.parent.owner.login, o=t.repoInfo.parent.name, i=t.repoInfo.parent.default_branch):(n=t.username, o=t.repo, i=t.branch), t.request("repos/".concat(n, "/").concat(o, "/pulls"), {title:t.mavo._("gh-edit-suggestion-title"), body:t.mavo._("gh-edit-suggestion-body", {description:e.elements.edits.value, previewURL:a}), head:"".concat(t.user.username, ":").concat(t.branch), base:i}, "POST").then(function(e) {
new Mavo.UI.Message(t.mavo, "<a href=\"".concat(e.html_url, "\">").concat(t.mavo._("gh-edit-suggestion-sent"), "</a>"), {dismiss:["button", "timeout"], style:r}), t.pullRequest(e);
});
}
});
}
}, login:function(e) {
var t=this;return this.oAuthenticate(e).then(function() {
return t.getUser();
})["catch"](function(e) {
401==e.status&&t.logout();
}).then(function() {
if (t.user&&(t.permissions.on("logout"), t.info.path&&t.permissions.on(["edit", "save"]), t.repo)) {
return t.request("repos/".concat(t.username, "/").concat(t.repo)).then(function(e) {
void 0===t.branch&&(t.branch=e.default_branch), t.repoInfo=e;new URL(location).searchParams;if (!t.mavo.source) {
if (e.fork) {
return t.forkInfo=e.parent, t.request("repos/".concat(e.parent.owner.login, "/").concat(e.parent.name, "/pulls"), {head:"".concat(t.user.username, ":").concat(t.branch), base:e.parent.default_branch}).then(function(e) {
t.pullRequest(e[0]);
}), e;
} if (!t.canPush()) {
if (t.user.info.public_repos<e.forks) {
return t.request("https://api.github.com/graphql", {query:"query {\n\t\t\t\t\t\t\t\t\t\t\t\t\t  viewer {\n\t\t\t\t\t\t\t\t\t\t\t\t\t    name\n\t\t\t\t\t\t\t\t\t\t\t\t\t      repositories(last: 100, isFork: true) {\n\t\t\t\t\t\t\t\t\t\t\t\t\t      nodes {\n\t\t\t\t\t\t\t\t\t\t\t\t\t        url\n\t\t\t\t\t\t\t\t\t\t\t\t\t        parent {\n\t\t\t\t\t\t\t\t\t\t\t\t\t          nameWithOwner\n\t\t\t\t\t\t\t\t\t\t\t\t\t        }\n\t\t\t\t\t\t\t\t\t\t\t\t\t      }\n\t\t\t\t\t\t\t\t\t\t\t\t\t    }\n\t\t\t\t\t\t\t\t\t\t\t\t\t  }\n\t\t\t\t\t\t\t\t\t\t\t\t\t}"}, "POST").then(function(a) {
var n=a.data.viewer.repositories.nodes;for (var o in n) {
if (n[o].parent.nameWithOwner===e.full_name) {
return t.switchToMyForkDialog(n[o].url), e;
}
} return e;
});
} return t.request(e.forks_url).then(function(a) {
for (var n in a) {
if (a[n].owner.login===t.user.username) {
return t.switchToMyForkDialog(a[n].html_url), e;
}
} return e;
});
}
} return e;
});
}
});
}, canPush:function() {
return this.repoInfo?this.repoInfo.permissions.push:this.user&&this.user.username.toLowerCase()==this.username.toLowerCase();
}, oAuthParams:function() {
return "&scope=repo,gist";
}, logout:function() {
var e=this;return this.oAuthLogout().then(function() {
e.user=null;
});
}, getUser:function() {
var t=this;return this.user?Promise.resolve(this.user):this.request("user").then(function(a) {
t.user={username:a.login, name:a.name||a.login, avatar:a.avatar_url, url:"https://github.com/"+a.login, info:a}, e.fire(t.mavo.element, "mv-login", {backend:t});
});
}, getURL:function() {
var e=this, t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.path, a=1<arguments.length?arguments[1]:void 0, n=this.forkInfo||this.repoInfo, o=n.full_name;return t=t.replace(/ /g, "%20"), n.pagesInfo=n.pagesInfo||this.request("repos/".concat(o, "/pages"), {}, "GET", {headers:{Accept:"application/vnd.github.mister-fantastic-preview+json"}}), n.pagesInfo.then(function(e) {
return e.html_url+t;
})["catch"](function() {
return "https://cdn.jsdelivr.net/gh/".concat(o, "@").concat(a||e.branch||"latest", "/").concat(t);
});
}, switchToMyForkDialog:function(e) {
var t=new URL(location).searchParams;return t.append("storage", e+"/"+this.path), this.notice=this.mavo.message("\n\t\t\t".concat(this.mavo._("gh-login-fork-options"), "\n\t\t\t<form onsubmit=\"return false\">\n\t\t\t\t<a href=\"").concat(location.pathname, "?").concat(t, "\"><button>").concat(this.mavo._("gh-use-my-fork"), "</button></a>\n\t\t\t</form>"), {classes:"mv-inline", dismiss:["button", "submit"]}), void this.notice.closed.then(function(e) {
e&&(history.pushState({}, "", "".concat(location.pathname, "?").concat(t)), location.replace("".concat(location.pathname, "?").concat(t)));
});
}, static:{apiDomain:"https://api.github.com/", oAuth:"https://github.com/login/oauth/authorize", test:function(e) {
return e=new URL(e, Mavo.base), /\bgithub.com|raw.githubusercontent.com/.test(e.host);
}, parseURL:function(e) {
var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}, a={}, n=new URL(e, Mavo.base), o=n.pathname.slice(1).split("/");if (a.username=o.shift(), a.repo=o.shift()||t.repo, /raw.githubusercontent.com$/.test(n.host)) {
a.branch=o.shift();
}
else {
if (/api.github.com$/.test(n.host)) {
var r=n.pathname.slice(1)+n.search, i=Mavo.Functions.from(e, "#");return {apiCall:r, apiData:"graphql"==r?{query:i}:i};
}"blob"==o[0]&&(o.shift(), a.branch=o.shift());
} var s=o[o.length-1];return /\.\w+$/.test(s)?(a.filename=s, o.splice(o.length-1, 1)):a.filename=t.filename, a.filepath=o.join("/")||t.filepath||"", a.path=(a.filepath?a.filepath+"/":"")+a.filename, a.apiCall="repos/".concat(a.username, "/").concat(a.repo, "/contents/").concat(a.path), a;
}, btoa:function(e) {
function t() {
return e.apply(this, arguments);
} return t.toString=function() {
return e.toString();
}, t;
}(function(e) {
return btoa(unescape(encodeURIComponent(e)));
}), atob:function(e) {
return decodeURIComponent(escape(window.atob(e)));
}}}));
}(Bliss, Bliss.$);
// # sourceMappingURL=maps/mavo.es5.min.js.map
